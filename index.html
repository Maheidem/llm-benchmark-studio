<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Benchmark Studio</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Chakra Petch', 'sans-serif'],
            body: ['Outfit', 'sans-serif'],
            mono: ['Space Mono', 'monospace'],
          },
          colors: {
            zinc: { 925: '#111113', 850: '#1c1c20' },
            lime: { accent: '#BFFF00' },
            coral: { accent: '#FF3B5C' },
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --lime: #BFFF00;
      --lime-dim: rgba(191,255,0,0.12);
      --lime-mid: rgba(191,255,0,0.3);
      --coral: #FF3B5C;
      --surface: #111113;
      --surface-raised: #1c1c20;
      --border: #27272A;
      --border-subtle: #1f1f23;
    }
    * { box-sizing: border-box; }
    body {
      background: #09090B;
      font-family: 'Outfit', sans-serif;
      color: #A1A1AA;
    }
    /* Dot grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 24px 24px;
      pointer-events: none;
      z-index: 0;
    }
    body > * { position: relative; z-index: 1; }

    /* Noise grain overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      opacity: 0.015;
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      transition: border-color 0.2s;
    }
    .card:hover { border-color: var(--border); }
    .card-accent {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-left: 3px solid var(--lime);
    }

    /* Model cards */
    .model-card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      transition: all 0.15s ease;
      cursor: pointer;
    }
    .model-card:hover { border-color: var(--border); background: var(--surface-raised); }
    .model-card.selected { border-color: var(--lime); background: var(--lime-dim); }
    .model-card .check-dot { width: 8px; height: 8px; border-radius: 50%; background: #3f3f46; transition: all 0.15s; }
    .model-card.selected .check-dot { background: var(--lime); box-shadow: 0 0 8px rgba(191,255,0,0.4); }

    /* Provider groups */
    .provider-group { border-left: 2px solid var(--border-subtle); padding-left: 0; margin-bottom: 8px; }
    .provider-group-header {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 12px; margin-bottom: 6px; cursor: pointer; user-select: none;
    }
    .provider-group-header:hover .provider-group-label { opacity: 1; }
    .provider-group-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .provider-group-label { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; opacity: 0.7; transition: opacity 0.15s; }
    .provider-group-count { font-size: 9px; font-family: 'Space Mono', monospace; color: #52525B; margin-left: auto; }

    /* Run button */
    .run-btn {
      background: var(--lime);
      color: #09090B;
      font-family: 'Chakra Petch', sans-serif;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: all 0.2s;
      box-shadow: 0 0 30px rgba(191,255,0,0.15);
    }
    .run-btn:hover { box-shadow: 0 0 50px rgba(191,255,0,0.3); transform: translateY(-1px); }
    .run-btn:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; transform: none; }
    .run-btn:active { transform: translateY(0); }

    /* Progress bar */
    .progress-track { background: #1c1c20; height: 6px; }
    .progress-fill {
      height: 100%;
      background: var(--lime);
      box-shadow: 0 0 12px rgba(191,255,0,0.3);
      transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      background-image: repeating-linear-gradient(
        -45deg,
        transparent,
        transparent 6px,
        rgba(0,0,0,0.15) 6px,
        rgba(0,0,0,0.15) 12px
      );
      background-size: 17px 17px;
      animation: stripe-scroll 0.6s linear infinite;
    }
    @keyframes stripe-scroll { to { background-position: 17px 0; } }

    /* Per-provider progress row */
    .provider-progress-row {
      display: grid;
      grid-template-columns: 140px 1fr 52px;
      align-items: center;
      gap: 12px;
    }
    .provider-progress-row .ppr-name {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .provider-progress-row .ppr-mid {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .provider-progress-row .ppr-status {
      font-family: 'Outfit', sans-serif;
      font-size: 11px;
      color: #71717A;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .provider-progress-row .ppr-track {
      background: #1c1c20;
      height: 4px;
      border-radius: 2px;
      overflow: hidden;
    }
    .provider-progress-row .ppr-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      background-image: repeating-linear-gradient(
        -45deg, transparent, transparent 4px,
        rgba(0,0,0,0.15) 4px, rgba(0,0,0,0.15) 8px
      );
      background-size: 11px 11px;
      animation: stripe-scroll 0.6s linear infinite;
    }
    .provider-progress-row .ppr-fill.done {
      animation: none;
      background-image: none;
    }
    .provider-progress-row .ppr-count {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: #52525B;
      text-align: right;
      white-space: nowrap;
    }

    /* Pulse dot */
    .pulse-dot {
      width: 6px; height: 6px; border-radius: 50%; background: var(--lime);
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { opacity: 0.4; box-shadow: none; } 50% { opacity: 1; box-shadow: 0 0 8px rgba(191,255,0,0.5); } }

    /* Stagger animations */
    .stagger { opacity: 0; transform: translateY(12px); animation: stagger-in 0.4s ease forwards; }
    .stagger:nth-child(1) { animation-delay: 0.05s; }
    .stagger:nth-child(2) { animation-delay: 0.1s; }
    .stagger:nth-child(3) { animation-delay: 0.15s; }
    .stagger:nth-child(4) { animation-delay: 0.2s; }
    .stagger:nth-child(5) { animation-delay: 0.25s; }
    .stagger:nth-child(6) { animation-delay: 0.3s; }
    @keyframes stagger-in { to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: stagger-in 0.3s ease forwards; }

    /* Tabs */
    .tab { padding: 8px 0; font-family: 'Chakra Petch', sans-serif; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; font-size: 12px; border-bottom: 2px solid transparent; transition: all 0.2s; color: #52525B; }
    .tab:hover { color: #A1A1AA; }
    .tab-active { color: var(--lime) !important; border-bottom-color: var(--lime) !important; }

    /* Sliders */
    input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
    input[type=range]::-webkit-slider-track { height: 3px; border-radius: 2px; background: #27272A; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 2px; background: var(--lime); margin-top: -5.5px; cursor: pointer; box-shadow: 0 0 6px rgba(191,255,0,0.3); }

    /* Textarea */
    .prompt-input {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-subtle);
      color: #E4E4E7;
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      resize: none;
      transition: border-color 0.2s;
    }
    .prompt-input:focus { outline: none; border-color: rgba(191,255,0,0.3); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #27272A; border-radius: 2px; }

    /* Stat cards */
    .stat-card { transition: all 0.2s; }
    .stat-card:hover { border-color: var(--border); transform: translateY(-1px); }

    /* Table */
    .results-table tr { border-bottom: 1px solid var(--border-subtle); transition: background 0.15s; }
    .results-table tr:hover { background: rgba(255,255,255,0.02); }
    .results-table .rank-1 { background: var(--lime-dim); }
    .results-table .rank-1:hover { background: rgba(191,255,0,0.08); }

    /* Provider badges */
    .badge { font-family: 'Chakra Petch', sans-serif; font-size: 10px; letter-spacing: 0.06em; text-transform: uppercase; font-weight: 500; padding: 2px 8px; border-radius: 2px; }

    /* Big number style */
    .big-num { font-family: 'Chakra Petch', sans-serif; font-weight: 700; line-height: 1; }

    /* Section label */
    .section-label { font-family: 'Chakra Petch', sans-serif; font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: #52525B; }

    /* Toast notifications */
    .toast-container { position: fixed; top: 16px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
    .toast { pointer-events: auto; padding: 10px 16px; border-radius: 4px; font-family: 'Outfit', sans-serif; font-size: 13px; color: #E4E4E7; background: var(--surface-raised); border: 1px solid var(--border); box-shadow: 0 4px 24px rgba(0,0,0,0.4); animation: toast-in 0.3s ease forwards; max-width: 400px; }
    .toast-error { border-color: rgba(255,59,92,0.4); background: rgba(255,59,92,0.08); color: #FCA5A5; }
    .toast-success { border-color: rgba(191,255,0,0.3); background: rgba(191,255,0,0.06); color: var(--lime); }
    .toast-out { animation: toast-out 0.3s ease forwards; }
    @keyframes toast-in { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toast-out { from { opacity: 1; } to { opacity: 0; transform: translateX(40px); } }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; z-index: 9998; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; animation: modal-fade-in 0.2s ease; }
    .modal-overlay.modal-closing { animation: modal-fade-out 0.2s ease forwards; }
    .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 24px; min-width: 340px; max-width: 480px; width: 100%; box-shadow: 0 8px 40px rgba(0,0,0,0.5); animation: modal-scale-in 0.2s ease; }
    .modal-closing .modal-box { animation: modal-scale-out 0.2s ease forwards; }
    .modal-title { font-family: 'Chakra Petch', sans-serif; font-weight: 600; font-size: 14px; letter-spacing: 0.04em; text-transform: uppercase; color: #E4E4E7; margin-bottom: 12px; }
    .modal-message { font-family: 'Outfit', sans-serif; font-size: 13px; color: #A1A1AA; margin-bottom: 16px; line-height: 1.5; }
    .modal-input { width: 100%; padding: 8px 12px; border-radius: 4px; background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle); color: #E4E4E7; font-family: 'Space Mono', monospace; font-size: 13px; outline: none; margin-bottom: 16px; transition: border-color 0.2s; }
    .modal-input:focus { border-color: rgba(191,255,0,0.3); }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 8px; }
    .modal-btn { padding: 6px 16px; border-radius: 4px; font-family: 'Chakra Petch', sans-serif; font-size: 12px; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; cursor: pointer; transition: all 0.15s; }
    .modal-btn-cancel { background: transparent; border: 1px solid var(--border-subtle); color: #71717A; }
    .modal-btn-cancel:hover { border-color: var(--border); color: #A1A1AA; }
    .modal-btn-confirm { background: var(--lime); border: 1px solid var(--lime); color: #09090B; }
    .modal-btn-confirm:hover { box-shadow: 0 0 12px rgba(191,255,0,0.3); }
    .modal-btn-danger { background: rgba(255,59,92,0.15); border: 1px solid rgba(255,59,92,0.3); color: #FF3B5C; }
    .modal-btn-danger:hover { background: rgba(255,59,92,0.25); }
    @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modal-fade-out { from { opacity: 1; } to { opacity: 0; } }
    @keyframes modal-scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes modal-scale-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }

    /* Error banner */
    .error-banner { background: rgba(255,59,92,0.08); border: 1px solid rgba(255,59,92,0.25); border-radius: 4px; padding: 12px 16px; font-family: 'Outfit', sans-serif; font-size: 13px; color: #FCA5A5; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .error-banner button { flex-shrink: 0; padding: 4px 12px; border-radius: 4px; font-family: 'Chakra Petch', sans-serif; font-size: 11px; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; background: rgba(255,59,92,0.15); border: 1px solid rgba(255,59,92,0.3); color: #FF3B5C; cursor: pointer; }

    /* Skipped line in progress */
    .skipped-line { font-family: 'Outfit', sans-serif; font-size: 12px; color: #52525B; padding: 2px 0; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Toast container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="modal-overlay" style="display:none; z-index:10000;">
    <div class="modal-box" style="max-width:380px;">
      <div class="flex gap-4 mb-5">
        <button id="authTabLogin" onclick="switchAuthTab('login')" class="tab tab-active text-xs">Login</button>
        <button id="authTabRegister" onclick="switchAuthTab('register')" class="tab text-xs">Register</button>
      </div>
      <div id="authError" class="error-banner mb-4" style="display:none;"></div>
      <form id="authForm" onsubmit="handleAuth(event)">
        <label class="section-label block mb-1">Email</label>
        <input type="email" id="authEmail" class="modal-input mb-3" required placeholder="you@example.com" autocomplete="email">
        <label class="section-label block mb-1">Password</label>
        <input type="password" id="authPassword" class="modal-input mb-4" required minlength="8" placeholder="Min 8 characters" autocomplete="current-password">
        <button type="submit" id="authSubmitBtn" class="modal-btn modal-btn-confirm w-full text-center">Login</button>
      </form>
    </div>
  </div>

  <!-- ═══════════════════════════ HEADER ═══════════════════════════ -->
  <header class="border-b px-6 py-4" style="border-color: var(--border-subtle)">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <!-- Logo mark -->
        <div class="w-9 h-9 rounded-sm flex items-center justify-center font-display font-bold text-sm" style="background: var(--lime); color: #09090B;">
          B<span style="font-size:10px; opacity:0.6;">s</span>
        </div>
        <div>
          <h1 class="font-display font-bold text-base text-zinc-100 tracking-wide">
            BENCHMARK <span style="color: var(--lime)">STUDIO</span>
          </h1>
          <p class="text-[10px] tracking-[0.2em] uppercase text-zinc-600 mt-0.5">Measure &middot; Compare &middot; Optimize</p>
        </div>
      </div>
      <div class="flex items-center gap-6">
        <button onclick="showTab('benchmark')" id="tab-benchmark" class="tab tab-active">Benchmark</button>
        <button onclick="showTab('history')" id="tab-history" class="tab">History</button>
        <button onclick="showTab('settings')" id="tab-settings" class="tab">Settings</button>
        <div id="userMenu" class="flex items-center gap-3 ml-4 pl-4" style="border-left:1px solid var(--border-subtle); display:none;">
          <span id="userEmail" class="text-[11px] text-zinc-500 font-mono"></span>
          <button onclick="handleLogout()" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-zinc-300 px-2 py-1 rounded" style="border:1px solid var(--border-subtle)">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ═══════════════════════════ MAIN ═══════════════════════════ -->
  <main class="max-w-7xl mx-auto px-6 py-8">

    <!-- Init error banner -->
    <div id="initErrorBanner" class="hidden error-banner mb-6">
      <span>Failed to connect to server. Check that the backend is running.</span>
    </div>

    <!-- ─── BENCHMARK TAB ─── -->
    <div id="view-benchmark">

      <!-- CONFIG ROW -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <!-- Prompt -->
        <div class="lg:col-span-2 card rounded-md p-5 stagger">
          <div class="flex items-center justify-between mb-3">
            <label class="section-label">Benchmark Prompt</label>
            <select id="promptTemplateSelect" onchange="applyPromptTemplate(this.value)" class="text-xs font-mono px-3 py-1.5 rounded-sm cursor-pointer" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;max-width:220px;">
              <option value="">Custom</option>
            </select>
          </div>
          <textarea id="prompt" rows="3" class="prompt-input w-full rounded-sm px-4 py-3" placeholder="Enter your benchmark prompt..."></textarea>
        </div>

        <!-- Params -->
        <div class="card rounded-md p-5 stagger">
          <label class="section-label mb-4 block">Parameters</label>
          <div class="space-y-5">
            <div>
              <div class="flex justify-between text-xs mb-2">
                <span class="text-zinc-500 font-body">Max Tokens</span>
                <span id="maxTokensVal" class="font-mono text-zinc-300">512</span>
              </div>
              <input type="range" id="maxTokens" min="64" max="4096" step="64" value="512" oninput="document.getElementById('maxTokensVal').textContent=this.value">
            </div>
            <div>
              <div class="flex justify-between text-xs mb-2">
                <span class="text-zinc-500 font-body">Temperature</span>
                <span id="tempVal" class="font-mono text-zinc-300">0.7</span>
              </div>
              <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempVal').textContent=parseFloat(this.value).toFixed(1)">
            </div>
            <div>
              <div class="flex justify-between text-xs mb-2">
                <span class="text-zinc-500 font-body">Runs per model</span>
                <span id="runsVal" class="font-mono text-zinc-300">1</span>
              </div>
              <input type="range" id="runs" min="1" max="10" step="1" value="1" oninput="document.getElementById('runsVal').textContent=this.value">
            </div>
            <div class="flex items-center justify-between mt-4">
              <span class="text-zinc-500 font-body text-xs">Warm-up run</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="warmupToggle" checked class="sr-only peer">
                <div class="w-8 h-4 rounded-full peer bg-zinc-700 peer-checked:bg-lime-accent/40 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-4 peer-checked:after:bg-[var(--lime)]"></div>
              </label>
            </div>
          </div>
          <div class="mt-5 pt-5" style="border-top: 1px solid var(--border-subtle)">
            <div class="flex justify-between text-xs mb-3">
              <span class="text-zinc-500 font-body">Context Tiers</span>
              <span id="tierBadge" class="hidden text-[10px] font-display font-semibold tracking-wider uppercase px-2 py-0.5 rounded-sm" style="background:rgba(255,59,92,0.15);color:var(--coral);">STRESS TEST</span>
            </div>
            <div id="tierChips" class="flex flex-wrap gap-2">
              <!-- JS populates -->
            </div>
            <div id="tierWarnings" class="mt-2 space-y-1"></div>
          </div>
        </div>
      </div>

      <!-- MODEL SELECTION -->
      <div class="card rounded-md p-5 mb-6 stagger">
        <div class="flex items-center justify-between mb-4">
          <label class="section-label">Select Models</label>
          <div class="flex gap-2">
            <button id="healthCheckBtn" onclick="checkProviderHealth()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: #38BDF8; border: 1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Check Health</button>
            <button onclick="selectAll()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: var(--lime); border: 1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">All</button>
            <button onclick="selectNone()" class="text-[11px] font-display font-medium tracking-wider uppercase text-zinc-600 px-3 py-1 rounded-sm border transition-colors" style="border-color: var(--border-subtle)" onmouseover="this.style.borderColor='var(--border)'" onmouseout="this.style.borderColor='var(--border-subtle)'">Clear</button>
          </div>
        </div>
        <div id="modelGrid" class="flex flex-col gap-1">
          <!-- JS populates -->
        </div>
      </div>

      <!-- RUN BUTTON -->
      <div class="flex justify-center mb-10 stagger">
        <button id="runBtn" onclick="startBenchmark()" class="run-btn px-12 py-3 rounded-sm text-sm flex items-center gap-3">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          Run Benchmark
        </button>
      </div>

      <!-- PROGRESS -->
      <div id="progressSection" class="hidden mb-8 fade-in">
        <div class="card rounded-md p-5">
          <!-- Header: pulse dot, overall counter, cancel button -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="pulse-dot"></div>
              <span id="progressLabel" class="text-sm text-zinc-400 font-body">Initializing...</span>
            </div>
            <div class="flex items-center gap-4">
              <span id="progressCount" class="text-xs font-mono text-zinc-600">0/0</span>
              <button id="cancelBtn" onclick="cancelBenchmark()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:var(--coral);border:1px solid rgba(255,59,92,0.3);" onmouseover="this.style.borderColor='rgba(255,59,92,0.6)'" onmouseout="this.style.borderColor='rgba(255,59,92,0.3)'">Cancel</button>
            </div>
          </div>
          <!-- Per-provider progress rows -->
          <div id="providerProgressPanel" class="flex flex-col gap-3"></div>
          <div id="progressSkipped" class="mt-3"></div>
        </div>
        <!-- Error banner for SSE issues -->
        <div id="sseBanner" class="hidden error-banner mt-3">
          <span id="sseBannerMsg">Connection lost</span>
          <button onclick="retryBenchmark()">Retry</button>
        </div>
      </div>

      <!-- RESULTS -->
      <div id="resultsSection" class="hidden fade-in">
        <!-- Stat Cards -->
        <div id="statCards" class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6"></div>

        <!-- Chart -->
        <div class="card rounded-md p-5 mb-4">
          <label class="section-label mb-4 block">Throughput Comparison</label>
          <div class="relative" style="height: 300px;">
            <canvas id="toksChart"></canvas>
          </div>
        </div>

        <!-- TTFT Chart -->
        <div id="ttftChartSection" class="hidden card rounded-md p-5 mb-4">
          <label id="ttftChartLabel" class="section-label mb-4 block">Latency (TTFT)</label>
          <div class="relative" style="height: 300px;">
            <canvas id="ttftChart"></canvas>
          </div>
        </div>

        <!-- Scatter: Speed vs Latency -->
        <div id="scatterChartSection" class="hidden card rounded-md p-5 mb-4">
          <label class="section-label mb-4 block">Speed vs Latency</label>
          <div class="relative" style="height: 300px;">
            <canvas id="scatterChart"></canvas>
          </div>
        </div>

        <!-- Table + CSV Export -->
        <div class="card rounded-md overflow-hidden mb-6">
          <div class="flex items-center justify-between px-5 py-3" style="border-bottom:1px solid var(--border-subtle)">
            <span class="section-label">Results</span>
            <button onclick="exportCSV()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Export CSV</button>
          </div>
          <table class="w-full text-sm results-table">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-left section-label">Pos</th>
                <th class="px-5 py-3 text-left section-label">Provider</th>
                <th class="px-5 py-3 text-left section-label">Model</th>
                <th class="px-5 py-3 text-right section-label">Tok/s</th>
                <th class="px-5 py-3 text-right section-label" data-col="stddev" style="display:none">Std Dev</th>
                <th class="px-5 py-3 text-right section-label">TTFT</th>
                <th class="px-5 py-3 text-right section-label">Input Tok/s</th>
                <th class="px-5 py-3 text-right section-label">Duration</th>
                <th class="px-5 py-3 text-right section-label">Tokens</th>
                <th class="px-5 py-3 text-center section-label">Status</th>
                <th class="px-5 py-3 text-right section-label">Cost</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ─── HISTORY TAB ─── -->
    <div id="view-history" class="hidden">
      <div id="historyCompareBar" class="hidden mb-4 flex items-center justify-between card rounded-md px-5 py-3" style="border-color:rgba(56,189,248,0.3)">
        <span class="text-xs font-body text-zinc-400"><span id="compareCount">0</span> runs selected</span>
        <button onclick="compareSelectedRuns()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.3);">Compare Selected</button>
      </div>
      <div id="historyCompareResult" class="hidden mb-6"></div>
      <div id="historyContainer" class="space-y-4">
        <p class="text-zinc-600 text-sm font-body">Loading history...</p>
      </div>
    </div>

    <!-- ─── SETTINGS TAB ─── -->
    <div id="view-settings" class="hidden">
      <div class="mb-6">
        <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Configuration</h2>
        <p class="text-sm text-zinc-600 font-body">Manage API keys, providers, and model settings.</p>
      </div>
      <!-- API Keys Section -->
      <div id="apiKeysContainer" class="mb-6"></div>
      <!-- Providers + Models -->
      <div id="settingsContainer" class="space-y-6">
        <p class="text-zinc-600 text-sm font-body">Loading configuration...</p>
      </div>
    </div>

  </main>

  <!-- ═══════════════════════════ SCRIPT ═══════════════════════════ -->
  <script>
    // --- Auth state ---
    let authToken = localStorage.getItem('auth_token') || null;
    let currentUser = null;

    // --- Auth-aware fetch wrapper ---
    async function apiFetch(url, options = {}) {
      if (!options.headers) options.headers = {};
      if (authToken) {
        options.headers['Authorization'] = `Bearer ${authToken}`;
      }
      if (options.body && !options.headers['Content-Type']) {
        options.headers['Content-Type'] = 'application/json';
      }
      const res = await fetch(url, options);
      if (res.status === 401) {
        // Try refresh
        const refreshed = await tryRefreshToken();
        if (refreshed) {
          options.headers['Authorization'] = `Bearer ${authToken}`;
          return fetch(url, options);
        }
        // Refresh failed - show login
        showAuthModal();
        throw new Error('Authentication required');
      }
      return res;
    }

    async function tryRefreshToken() {
      try {
        const res = await fetch('/api/auth/refresh', { method: 'POST', credentials: 'include' });
        if (!res.ok) return false;
        const data = await res.json();
        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('auth_token', authToken);
        updateAuthUI();
        return true;
      } catch {
        return false;
      }
    }

    // -------------------------------------------------------------------
    // State
    // -------------------------------------------------------------------
    let config = null;
    let selectedModels = new Set();
    let currentResults = [];
    let toksChart = null;
    let ttftChart = null;
    let scatterChart = null;
    let cachedEnvKeys = [];
    let discoveredModelsCache = {}; // providerKey -> [{id, display_name}]
    let _sseTimeout = null;
    let _lastBenchmarkBody = null;
    let providerProgress = {}; // provider -> {currentModel, currentRun, totalRuns, completedSteps, totalSteps, status, errors[]}

    const POSITION_LABELS = ['P1', 'P2', 'P3'];

    // -------------------------------------------------------------------
    // Toast notifications
    // -------------------------------------------------------------------
    function showToast(message, type = '') {
      const container = document.getElementById('toastContainer');
      const el = document.createElement('div');
      el.className = `toast ${type ? 'toast-' + type : ''}`;
      el.textContent = message;
      container.appendChild(el);
      setTimeout(() => { el.classList.add('toast-out'); setTimeout(() => el.remove(), 300); }, 3000);
    }

    // -------------------------------------------------------------------
    // Modal system
    // -------------------------------------------------------------------
    function _closeModal(overlay) {
      overlay.classList.add('modal-closing');
      setTimeout(() => overlay.remove(), 200);
    }

    function showModal(title, message, onConfirm, opts = {}) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      const danger = opts.danger || false;
      overlay.innerHTML = `<div class="modal-box">
        <div class="modal-title">${title}</div>
        <div class="modal-message">${message}</div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn ${danger ? 'modal-btn-danger' : 'modal-btn-confirm'}" data-action="confirm">${opts.confirmLabel || 'Confirm'}</button>
        </div>
      </div>`;
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => { _closeModal(overlay); onConfirm(); };
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
    }

    function showInputModal(title, placeholder, onConfirm, opts = {}) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `<div class="modal-box">
        <div class="modal-title">${title}</div>
        ${opts.message ? `<div class="modal-message">${opts.message}</div>` : ''}
        <input class="modal-input" placeholder="${placeholder}" ${opts.inputType ? `type="${opts.inputType}"` : ''} value="${opts.defaultValue || ''}">
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">${opts.confirmLabel || 'OK'}</button>
        </div>
      </div>`;
      const input = overlay.querySelector('.modal-input');
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => { const v = input.value; _closeModal(overlay); onConfirm(v); };
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const v = input.value; _closeModal(overlay); onConfirm(v); } });
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => input.focus(), 50);
    }

    function showDoubleInputModal(title, fields, onConfirm) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      let fieldsHtml = fields.map((f, i) => `<div style="margin-bottom:${i < fields.length-1 ? '12px' : '16px'}"><div style="font-size:11px;color:#71717A;margin-bottom:4px;font-family:'Chakra Petch',sans-serif;text-transform:uppercase;letter-spacing:0.04em">${f.label}</div><input class="modal-input" style="margin-bottom:0" placeholder="${f.placeholder || ''}" ${f.type ? `type="${f.type}"` : ''}></div>`).join('');
      overlay.innerHTML = `<div class="modal-box">
        <div class="modal-title">${title}</div>
        ${fieldsHtml}
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">OK</button>
        </div>
      </div>`;
      const inputs = overlay.querySelectorAll('.modal-input');
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => { const vals = [...inputs].map(i => i.value); _closeModal(overlay); onConfirm(...vals); };
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => inputs[0]?.focus(), 50);
    }

    const PROVIDER_COLORS = {
      'ZAI GLM':             { bg: 'rgba(191,255,0,0.08)',  border: 'rgba(191,255,0,0.3)',  text: '#BFFF00', bar: '#BFFF00' },
      'LM Studio (Desktop)': { bg: 'rgba(56,189,248,0.08)', border: 'rgba(56,189,248,0.3)', text: '#38BDF8', bar: '#38BDF8' },
      'LM Studio (Mac)':     { bg: 'rgba(129,140,248,0.08)',border: 'rgba(129,140,248,0.3)',text: '#818CF8', bar: '#818CF8' },
      'LM Studio (Local)':   { bg: 'rgba(56,189,248,0.08)', border: 'rgba(56,189,248,0.3)', text: '#38BDF8', bar: '#38BDF8' },
      'OpenAI':              { bg: 'rgba(168,162,158,0.08)', border: 'rgba(168,162,158,0.3)', text: '#A8A29E', bar: '#A8A29E' },
      'Anthropic':           { bg: 'rgba(251,113,133,0.08)', border: 'rgba(251,113,133,0.3)', text: '#FB7185', bar: '#FB7185' },
      'Google Gemini':       { bg: 'rgba(96,165,250,0.08)',  border: 'rgba(96,165,250,0.3)',  text: '#60A5FA', bar: '#60A5FA' },
    };
    const DEFAULT_COLOR = { bg: 'rgba(251,146,60,0.08)', border: 'rgba(251,146,60,0.3)', text: '#FB923C', bar: '#FB923C' };

    function getColor(provider) { return PROVIDER_COLORS[provider] || DEFAULT_COLOR; }

    function safeId(str) { return str.replace(/[^a-zA-Z0-9_-]/g, '_'); }

    function slugify(str) {
      return str.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
    }

    function uniqueProviderKey(base) {
      if (!config || !config.providers) return base;
      const existing = new Set(Object.values(config.providers).map(p => p.provider_key));
      if (!existing.has(base)) return base;
      for (let i = 2; i < 100; i++) {
        const candidate = `${base}_${i}`;
        if (!existing.has(candidate)) return candidate;
      }
      return base + '_' + Date.now();
    }

    function detectPrefix(models) {
      if (!models || models.length === 0) return '';
      const ids = models.map(m => m.model_id || m.id || '');
      const firstSlash = ids[0].indexOf('/');
      if (firstSlash < 1) return '';
      const candidate = ids[0].substring(0, firstSlash);
      if (ids.every(id => id.startsWith(candidate + '/'))) return candidate;
      return '';
    }

    function formatCtxSize(tokens) {
      if (tokens >= 1000000) return (tokens / 1000000).toFixed(0) + 'M ctx';
      if (tokens >= 1000) return (tokens / 1000).toFixed(0) + 'K ctx';
      return tokens + ' ctx';
    }

    // -------------------------------------------------------------------
    // Context Tiers
    // -------------------------------------------------------------------
    const TIER_OPTIONS = [
      { value: 0, label: '0' },
      { value: 1000, label: '1K' },
      { value: 5000, label: '5K' },
      { value: 10000, label: '10K' },
      { value: 20000, label: '20K' },
      { value: 50000, label: '50K' },
      { value: 100000, label: '100K' },
      { value: 150000, label: '150K' },
    ];
    let selectedTiers = new Set([0]);

    function renderTierChips() {
      const container = document.getElementById('tierChips');
      container.innerHTML = TIER_OPTIONS.map(t => {
        const selected = selectedTiers.has(t.value);
        return `<button onclick="toggleTier(${t.value})" class="text-[11px] font-mono px-3 py-1.5 rounded-sm transition-all ${selected ? '' : 'text-zinc-600 hover:text-zinc-400'}" style="${selected ? 'background:var(--lime-dim);color:var(--lime);border:1px solid rgba(191,255,0,0.3)' : 'background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle)'}">${t.label}</button>`;
      }).join('');

      // Show/hide stress test badge
      const badge = document.getElementById('tierBadge');
      if (selectedTiers.size > 1 || (selectedTiers.size === 1 && !selectedTiers.has(0))) {
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      updateTierWarnings();
    }

    function toggleTier(value) {
      if (selectedTiers.has(value)) {
        selectedTiers.delete(value);
        if (selectedTiers.size === 0) selectedTiers.add(0); // Always have at least one
      } else {
        selectedTiers.add(value);
      }
      renderTierChips();
    }

    function updateTierWarnings() {
      const container = document.getElementById('tierWarnings');
      if (!config) { container.innerHTML = ''; return; }

      const warnings = [];
      const maxTier = Math.max(...selectedTiers);

      for (const [provider, provData] of Object.entries(config.providers)) {
        const models = getProviderModels(provData);
        for (const m of models) {
          if (!selectedModels.has(m.model_id)) continue;
          if (m.context_window && maxTier > m.context_window) {
            warnings.push(`<div class="text-[10px] font-body" style="color:#FBBF24;">${m.display_name}: ${formatCtxSize(maxTier).replace(' ctx','')} &gt; ${formatCtxSize(m.context_window)}</div>`);
          }
        }
      }
      container.innerHTML = warnings.join('');
    }

    // -------------------------------------------------------------------
    // Init
    // -------------------------------------------------------------------
    async function init() {
      try {
        const res = await apiFetch('/api/config');
        config = await res.json();
        renderModels();
        if (config.defaults?.prompt) {
          document.getElementById('prompt').value = config.defaults.prompt.trim();
        }
        if (config.defaults?.max_tokens) {
          document.getElementById('maxTokens').value = config.defaults.max_tokens;
          document.getElementById('maxTokensVal').textContent = config.defaults.max_tokens;
        }
        if (config.defaults?.temperature !== undefined) {
          document.getElementById('temperature').value = config.defaults.temperature;
          document.getElementById('tempVal').textContent = parseFloat(config.defaults.temperature).toFixed(1);
        }
        renderTierChips();
      } catch (e) {
        console.error('Failed to load config:', e);
        document.getElementById('initErrorBanner').classList.remove('hidden');
      }
    }

    // -------------------------------------------------------------------
    // Model selection
    // -------------------------------------------------------------------
    function getProviderModels(provData) {
      // Handle both old shape (array) and new shape ({models: [...]})
      return Array.isArray(provData) ? provData : (provData.models || []);
    }

    function renderModels() {
      const grid = document.getElementById('modelGrid');
      grid.innerHTML = '';

      for (const [provider, provData] of Object.entries(config.providers)) {
        const color = getColor(provider);
        const models = getProviderModels(provData);
        if (!models.length) continue;

        // Provider group container
        const group = document.createElement('div');
        group.className = 'provider-group';
        group.style.borderColor = color.border;

        // Provider header — click to toggle all models in group
        const header = document.createElement('div');
        header.className = 'provider-group-header';
        header.innerHTML = `
          <div class="provider-group-dot" style="background:${color.text}"></div>
          <span class="provider-group-label" style="color:${color.text}">${provider}</span>
          <span class="provider-group-count">${models.length} model${models.length > 1 ? 's' : ''}</span>
        `;
        header.onclick = () => {
          const cards = group.querySelectorAll('.model-card');
          const allSelected = [...cards].every(c => c.classList.contains('selected'));
          cards.forEach(c => {
            if (allSelected) { selectedModels.delete(c.dataset.modelId); c.classList.remove('selected'); }
            else { selectedModels.add(c.dataset.modelId); c.classList.add('selected'); }
          });
        };
        group.appendChild(header);

        // Model cards sub-grid
        const subgrid = document.createElement('div');
        subgrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 pl-3';
        for (const m of models) {
          selectedModels.add(m.model_id);
          const card = document.createElement('div');
          card.className = 'model-card selected rounded-sm px-4 py-3 flex items-center gap-3';
          card.dataset.modelId = m.model_id;
          card.onclick = (e) => { e.stopPropagation(); toggleModel(m.model_id, card); };
          card.innerHTML = `
            <div class="check-dot flex-shrink-0"></div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <div class="text-[13px] font-medium text-zinc-200 truncate font-body">${m.display_name}</div>
                ${m.context_window ? `<span class="text-[9px] font-mono px-1.5 py-0.5 rounded-sm" style="background:rgba(255,255,255,0.04);color:#71717A;">${formatCtxSize(m.context_window)}</span>` : ''}
              </div>
            </div>
          `;
          subgrid.appendChild(card);
        }
        group.appendChild(subgrid);
        grid.appendChild(group);
      }
    }

    function toggleModel(modelId, card) {
      if (selectedModels.has(modelId)) {
        selectedModels.delete(modelId);
        card.classList.remove('selected');
      } else {
        selectedModels.add(modelId);
        card.classList.add('selected');
      }
    }

    function selectAll() {
      document.querySelectorAll('.model-card').forEach(card => {
        selectedModels.add(card.dataset.modelId);
        card.classList.add('selected');
      });
    }

    function selectNone() {
      selectedModels.clear();
      document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
    }

    // -------------------------------------------------------------------
    // Benchmark execution
    // -------------------------------------------------------------------
    function _resetRunBtn() {
      const btn = document.getElementById('runBtn');
      btn.disabled = false;
      btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Run Benchmark`;
    }

    function _showSSEError(msg) {
      const banner = document.getElementById('sseBanner');
      document.getElementById('sseBannerMsg').textContent = msg;
      banner.classList.remove('hidden');
    }

    async function cancelBenchmark() {
      try {
        await apiFetch('/api/benchmark/cancel', { method: 'POST' });
        showToast('Cancellation requested...', '');
      } catch (e) {
        showToast('Failed to cancel', 'error');
      }
    }

    function retryBenchmark() {
      document.getElementById('sseBanner').classList.add('hidden');
      if (_lastBenchmarkBody) startBenchmark(_lastBenchmarkBody);
    }

    async function startBenchmark(overrideBody) {
      if (!overrideBody && selectedModels.size === 0) {
        showToast('Select at least one model', 'error');
        return;
      }

      const btn = document.getElementById('runBtn');
      btn.disabled = true;
      btn.innerHTML = `<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> RUNNING...`;

      currentResults = [];
      document.getElementById('progressSection').classList.remove('hidden');
      document.getElementById('progressSkipped').innerHTML = '';
      document.getElementById('sseBanner').classList.add('hidden');
      document.getElementById('resultsSection').classList.add('hidden');

      const body = overrideBody || {
        models: Array.from(selectedModels),
        runs: parseInt(document.getElementById('runs').value),
        max_tokens: parseInt(document.getElementById('maxTokens').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        prompt: document.getElementById('prompt').value,
        context_tiers: Array.from(selectedTiers).sort((a, b) => a - b),
        warmup: document.getElementById('warmupToggle').checked,
      };
      _lastBenchmarkBody = body;

      // Initialize per-provider progress tracking
      initProviderProgress(body);
      renderProviderProgress();

      try {
        const res = await apiFetch('/api/benchmark', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        // Handle HTTP 409 - concurrent benchmark
        if (res.status === 409) {
          showToast('A benchmark is already running', 'error');
          _resetRunBtn();
          return;
        }
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || `Server error (${res.status})`, 'error');
          _resetRunBtn();
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        // SSE no-data timeout (30s)
        const resetTimeout = () => {
          if (_sseTimeout) clearTimeout(_sseTimeout);
          _sseTimeout = setTimeout(() => {
            _showSSEError('Connection lost - no data received for 30 seconds');
            _resetRunBtn();
          }, 30000);
        };
        resetTimeout();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          resetTimeout();
          buffer += decoder.decode(value, { stream: true });

          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try { handleSSE(JSON.parse(line.slice(6))); } catch (e) {}
            }
          }
        }
        if (_sseTimeout) clearTimeout(_sseTimeout);
      } catch (e) {
        console.error('Benchmark error:', e);
        _showSSEError('Connection error: ' + (e.message || 'Network failure'));
      }

      _resetRunBtn();
    }

    // -------------------------------------------------------------------
    // Per-provider progress tracking
    // -------------------------------------------------------------------
    function initProviderProgress(body) {
      providerProgress = {};
      if (!config || !config.providers) return;

      const selectedSet = new Set(body.models || []);
      const runs = body.runs || 1;
      const tiers = body.context_tiers || [0];
      const maxTokens = body.max_tokens || 4096;

      for (const [provider, provData] of Object.entries(config.providers)) {
        const models = getProviderModels(provData);
        const selectedInProvider = models.filter(m => selectedSet.has(m.model_id));
        if (selectedInProvider.length === 0) continue;

        // Count steps: for each model, for each tier, count runs (skip tiers that exceed context window)
        let totalSteps = 0;
        for (const m of selectedInProvider) {
          for (const tier of tiers) {
            const headroom = (m.context_window || Infinity) - maxTokens - 100;
            if (tier === 0 || tier <= headroom) {
              totalSteps += runs;
            }
          }
        }

        providerProgress[provider] = {
          currentModel: null,
          currentRun: 0,
          totalRuns: runs,
          completedSteps: 0,
          totalSteps: totalSteps,
          status: 'waiting', // waiting | running | done | error
          errors: [],
        };
      }
    }

    function renderProviderProgress() {
      const panel = document.getElementById('providerProgressPanel');
      if (!panel) return;

      // Update overall counter
      let totalCompleted = 0, totalAll = 0;
      for (const p of Object.values(providerProgress)) {
        totalCompleted += p.completedSteps;
        totalAll += p.totalSteps;
      }
      document.getElementById('progressCount').textContent = `${totalCompleted}/${totalAll}`;

      // Update overall label
      const runningProviders = Object.entries(providerProgress).filter(([, p]) => p.status === 'running');
      if (runningProviders.length > 0) {
        document.getElementById('progressLabel').textContent = `Running ${runningProviders.length} provider${runningProviders.length > 1 ? 's' : ''} in parallel`;
      }

      // Build rows
      const rows = [];
      for (const [name, p] of Object.entries(providerProgress)) {
        const color = getColor(name);
        const pct = p.totalSteps > 0 ? (p.completedSteps / p.totalSteps * 100) : 0;
        const isDone = p.completedSteps >= p.totalSteps;
        const hasError = p.errors.length > 0;

        let statusText = '';
        let statusIcon = '';
        if (isDone && !hasError) {
          statusText = 'Complete';
          statusIcon = '<span style="color:#4ADE80;">&#10003;</span> ';
        } else if (isDone && hasError) {
          statusText = 'Done with errors';
          statusIcon = '<span style="color:#FBBF24;">&#9888;</span> ';
        } else if (p.status === 'running' && p.currentModel) {
          const tierLabel = p.currentContextTokens > 0 ? ` @ ${p.currentContextTokens >= 1000 ? (p.currentContextTokens / 1000) + 'K' : p.currentContextTokens} ctx` : '';
          statusText = `${p.currentModel}${tierLabel} (run ${p.currentRun}/${p.totalRuns})`;
        } else {
          statusText = 'Waiting\u2026';
        }

        const barColor = hasError ? '#FBBF24' : (isDone ? '#4ADE80' : color.bar);
        const barShadow = isDone ? 'none' : `0 0 8px ${color.bar}44`;

        rows.push(`
          <div class="provider-progress-row">
            <div class="ppr-name" style="color:${color.text};" title="${name}">${name}</div>
            <div class="ppr-mid">
              <div class="ppr-status">${statusIcon}${statusText}</div>
              <div class="ppr-track">
                <div class="ppr-fill${isDone ? ' done' : ''}" style="width:${pct.toFixed(1)}%;background-color:${barColor};box-shadow:${barShadow};"></div>
              </div>
            </div>
            <div class="ppr-count">${p.completedSteps}/${p.totalSteps}</div>
          </div>
        `);
      }

      // Error details at the bottom
      const errorLines = [];
      for (const [name, p] of Object.entries(providerProgress)) {
        for (const err of p.errors) {
          errorLines.push(`<div class="text-[11px] font-body" style="color:#FB7185;">${name} / ${err.model}: ${err.message}</div>`);
        }
      }

      panel.innerHTML = rows.join('') + (errorLines.length > 0 ? '<div class="mt-2 flex flex-col gap-1">' + errorLines.join('') + '</div>' : '');
    }

    function handleSSE(data) {
      const prov = data.provider;

      if (data.type === 'progress') {
        // Update per-provider state
        if (prov && providerProgress[prov]) {
          const pp = providerProgress[prov];
          pp.status = 'running';
          pp.currentModel = data.model;
          pp.currentRun = data.run;
          pp.totalRuns = data.runs;
          pp.currentContextTokens = data.context_tokens || 0;
        }
        renderProviderProgress();
      }
      if (data.type === 'skipped') {
        const el = document.getElementById('progressSkipped');
        el.innerHTML += `<div class="skipped-line">&#x23ED; ${data.model}: skipped (${data.reason || 'context exceeds window'})</div>`;
      }
      if (data.type === 'result') {
        // Increment completed steps for this provider
        if (prov && providerProgress[prov]) {
          const pp = providerProgress[prov];
          pp.completedSteps++;
          if (!data.success && data.error) {
            pp.errors.push({ model: data.model, message: data.error });
          }
          // Mark provider done if all steps completed
          if (pp.completedSteps >= pp.totalSteps) {
            pp.status = 'done';
            pp.currentModel = null;
          }
          renderProviderProgress();
        }
        currentResults.push(data);
        renderLiveResults();
      }
      if (data.type === 'cancelled') {
        showToast('Benchmark cancelled', 'error');
        document.getElementById('progressSection').classList.add('hidden');
        if (currentResults.length > 0) {
          document.getElementById('resultsSection').classList.remove('hidden');
          renderFinalResults();
        }
      }
      if (data.type === 'error') {
        // Per-provider error (has provider field) vs global error
        if (prov && providerProgress[prov]) {
          const pp = providerProgress[prov];
          pp.errors.push({ model: data.model || '?', message: data.message || 'Unknown error' });
          pp.completedSteps = pp.totalSteps; // mark as done
          pp.status = 'error';
          pp.currentModel = null;
          renderProviderProgress();
        } else {
          _showSSEError(data.message || 'Benchmark error');
        }
      }
      if (data.type === 'complete') {
        // Mark all remaining providers as done
        for (const pp of Object.values(providerProgress)) {
          if (pp.status !== 'done' && pp.status !== 'error') {
            pp.status = 'done';
            pp.completedSteps = pp.totalSteps;
            pp.currentModel = null;
          }
        }
        renderProviderProgress();
        document.getElementById('progressSection').classList.add('hidden');
        document.getElementById('resultsSection').classList.remove('hidden');
        if (currentResults.length === 0 || currentResults.every(r => !r.success)) {
          document.getElementById('statCards').innerHTML = `<div class="col-span-full error-banner">All benchmarks failed. Check your API keys and model configuration.</div>`;
        }
        renderFinalResults();
      }
    }

    // -------------------------------------------------------------------
    // Results rendering
    // -------------------------------------------------------------------
    function renderLiveResults() {
      document.getElementById('resultsSection').classList.remove('hidden');
      renderChart();
      renderTTFTChart();
      renderScatterChart();
      renderTable();
    }

    function renderFinalResults() {
      renderStatCards();
      renderChart();
      renderTTFTChart();
      renderScatterChart();
      renderTable();
    }

    function _stdDev(values) {
      if (values.length < 2) return 0;
      const mean = values.reduce((s, v) => s + v, 0) / values.length;
      const variance = values.reduce((s, v) => s + (v - mean) ** 2, 0) / (values.length - 1);
      return Math.sqrt(variance);
    }

    function _percentile(sorted, p) {
      if (sorted.length === 0) return 0;
      if (sorted.length === 1) return sorted[0];
      const idx = (p / 100) * (sorted.length - 1);
      const lo = Math.floor(idx), hi = Math.ceil(idx);
      return lo === hi ? sorted[lo] : sorted[lo] + (sorted[hi] - sorted[lo]) * (idx - lo);
    }

    function aggregateResults() {
      const grouped = {};
      for (const r of currentResults) {
        const key = `${r.model_id}::${r.provider}::${r.context_tokens || 0}`;
        if (!grouped[key]) grouped[key] = { ...r, _runs: [], _successes: 0 };
        grouped[key]._runs.push(r);
        if (r.success) grouped[key]._successes++;
      }
      return Object.values(grouped).map(g => {
        const successes = g._runs.filter(r => r.success);
        const n = successes.length;
        const tpsVals = successes.map(r => r.tokens_per_second).sort((a, b) => a - b);
        const ttftVals = successes.map(r => r.ttft_ms).sort((a, b) => a - b);
        const inputTpsVals = successes.map(r => r.input_tokens_per_second || 0).filter(v => v > 0);
        const costVals = successes.map(r => r.cost || 0);
        return {
          provider: g.provider, model: g.model, model_id: g.model_id,
          context_tokens: g.context_tokens || 0,
          tokens_per_second: n ? successes.reduce((s, r) => s + r.tokens_per_second, 0) / n : 0,
          ttft_ms: n ? successes.reduce((s, r) => s + r.ttft_ms, 0) / n : 0,
          total_time_s: n ? successes.reduce((s, r) => s + r.total_time_s, 0) / n : 0,
          output_tokens: n ? successes.reduce((s, r) => s + r.output_tokens, 0) / n : 0,
          input_tokens_per_second: inputTpsVals.length ? inputTpsVals.reduce((s, v) => s + v, 0) / inputTpsVals.length : 0,
          avg_cost: n ? costVals.reduce((s, v) => s + v, 0) / n : 0,
          total_cost: costVals.reduce((s, v) => s + v, 0),
          std_dev_tps: _stdDev(tpsVals),
          std_dev_ttft: _stdDev(ttftVals),
          p50_tps: _percentile(tpsVals, 50),
          p95_tps: _percentile(tpsVals, 95),
          min_tps: tpsVals.length ? tpsVals[0] : 0,
          max_tps: tpsVals.length ? tpsVals[tpsVals.length - 1] : 0,
          success: g._successes > 0,
          runs: g._runs.length,
          failures: g._runs.length - g._successes,
          error: g._runs.find(r => !r.success)?.error || '',
        };
      }).sort((a, b) => b.tokens_per_second - a.tokens_per_second);
    }

    function isStressMode() {
      const tiers = new Set(currentResults.map(r => r.context_tokens || 0));
      return tiers.size > 1;
    }

    function renderStatCards() {
      const agg = aggregateResults();
      const container = document.getElementById('statCards');
      if (!agg.length || !agg[0].success) { container.innerHTML = ''; return; }

      const stress = isStressMode();

      if (!stress) {
        // Standard stat cards (existing behavior)
        const winner = agg[0];
        const fastestTTFT = [...agg].filter(a => a.success).sort((a, b) => a.ttft_ms - b.ttft_ms)[0];
        const totalModels = agg.length;
        const totalFails = agg.reduce((s, a) => s + a.failures, 0);
        const grandTotalCost = agg.reduce((s, a) => s + a.total_cost, 0);

        container.innerHTML = `
          <div class="stat-card card-accent rounded-sm p-4">
            <div class="section-label mb-2">Fastest</div>
            <div class="big-num text-2xl text-zinc-100">${winner.tokens_per_second.toFixed(1)} <span class="text-xs font-normal" style="color:var(--lime)">tok/s</span></div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${winner.model}</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #38BDF8">
            <div class="section-label mb-2">Best TTFT</div>
            <div class="big-num text-2xl text-zinc-100">${fastestTTFT.ttft_ms.toFixed(0)}<span class="text-xs font-normal text-zinc-500">ms</span></div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${fastestTTFT.model}</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #52525B">
            <div class="section-label mb-2">Models</div>
            <div class="big-num text-2xl text-zinc-100">${totalModels}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${agg.reduce((s,a) => s + a.runs, 0)} total runs</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid ${grandTotalCost > 0 ? '#FB923C' : '#22C55E'}">
            <div class="section-label mb-2">Total Cost</div>
            <div class="big-num text-2xl text-zinc-100">${grandTotalCost > 0 ? '$' + grandTotalCost.toFixed(4) : '$0'}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${totalFails ? totalFails + ' failure(s)' : 'All nominal'}</div>
          </div>
        `;
      } else {
        // Stress test stat cards
        const atZero = agg.filter(a => a.context_tokens === 0 && a.success).sort((a, b) => b.tokens_per_second - a.tokens_per_second);
        const maxTier = Math.max(...agg.map(a => a.context_tokens));
        const atMax = agg.filter(a => a.context_tokens === maxTier && a.success).sort((a, b) => b.tokens_per_second - a.tokens_per_second);
        const totalFails = agg.reduce((s, a) => s + a.failures, 0);
        const totalRuns = agg.reduce((s, a) => s + a.runs, 0);

        const bestZero = atZero[0];
        const bestMax = atMax[0];

        container.innerHTML = `
          <div class="stat-card card-accent rounded-sm p-4">
            <div class="section-label mb-2">Best @ 0K</div>
            ${bestZero ? `
              <div class="big-num text-2xl text-zinc-100">${bestZero.tokens_per_second.toFixed(1)} <span class="text-xs font-normal" style="color:var(--lime)">tok/s</span></div>
              <div class="text-[11px] text-zinc-600 mt-1 font-body">${bestZero.model}</div>
            ` : `<div class="text-zinc-600 text-sm font-body">N/A</div>`}
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #38BDF8">
            <div class="section-label mb-2">Best @ ${formatCtxSize(maxTier).replace(' ctx','')}</div>
            ${bestMax ? `
              <div class="big-num text-2xl text-zinc-100">${bestMax.tokens_per_second.toFixed(1)} <span class="text-xs font-normal" style="color:#38BDF8">tok/s</span></div>
              <div class="text-[11px] text-zinc-600 mt-1 font-body">${bestMax.model}</div>
            ` : `<div class="text-zinc-600 text-sm font-body">N/A</div>`}
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #52525B">
            <div class="section-label mb-2">Tiers Tested</div>
            <div class="big-num text-2xl text-zinc-100">${new Set(agg.map(a => a.context_tokens)).size}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${totalRuns} total runs</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid ${totalFails ? 'var(--coral)' : '#22C55E'}">
            <div class="section-label mb-2">Failures</div>
            <div class="big-num text-2xl ${totalFails ? 'text-red-400' : 'text-green-400'}">${totalFails || 'None'}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${totalFails ? 'Check errors' : 'All nominal'}</div>
          </div>
        `;
      }
    }

    function renderChart() {
      const agg = aggregateResults();
      const ctx = document.getElementById('toksChart').getContext('2d');
      if (toksChart) toksChart.destroy();

      if (!isStressMode()) {
        // === STANDARD BAR CHART (existing behavior) ===
        const labels = agg.map(a => a.model);
        const data = agg.map(a => a.tokens_per_second);
        const bgColors = agg.map(a => getColor(a.provider).bar + 'CC');
        const borderColors = agg.map(a => getColor(a.provider).bar);

        toksChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Tokens/sec',
              data,
              backgroundColor: bgColors,
              borderColor: borderColors,
              borderWidth: 0,
              borderRadius: 2,
              barPercentage: 0.55,
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1c1c20',
                borderColor: '#27272A',
                borderWidth: 1,
                titleFont: { family: 'Outfit', size: 13, weight: '500' },
                bodyFont: { family: 'Space Mono', size: 12 },
                padding: 12,
                cornerRadius: 2,
                callbacks: {
                  label: ctx => ` ${ctx.parsed.x.toFixed(1)} tok/s`,
                  afterLabel: ctx => {
                    const r = agg[ctx.dataIndex];
                    return ` TTFT: ${r.ttft_ms.toFixed(0)}ms  |  Tokens: ${r.output_tokens.toFixed(0)}`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                ticks: { color: '#52525B', font: { family: 'Space Mono', size: 11 } },
                title: { display: true, text: 'TOKENS / SECOND', color: '#3f3f46', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } }
              },
              y: {
                grid: { display: false, drawBorder: false },
                ticks: { color: '#A1A1AA', font: { family: 'Outfit', size: 12, weight: '500' } }
              }
            }
          }
        });
      } else {
        // === STRESS TEST LINE CHART ===
        const tiers = [...new Set(agg.map(a => a.context_tokens))].sort((a, b) => a - b);
        const models = [...new Set(agg.map(a => `${a.model_id}::${a.provider}`))];
        const tierLabels = tiers.map(t => t === 0 ? '0' : (t >= 1000 ? (t/1000) + 'K' : t));

        const datasets = models.map(uid => {
          const modelResults = agg.filter(a => `${a.model_id}::${a.provider}` === uid);
          const modelName = modelResults[0]?.model || mid;
          const provider = modelResults[0]?.provider || '';
          const color = getColor(provider);

          const data = tiers.map(tier => {
            const match = modelResults.find(r => r.context_tokens === tier);
            return match && match.success ? match.tokens_per_second : null;
          });

          return {
            label: modelName,
            data,
            borderColor: color.bar,
            backgroundColor: color.bar + '33',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: color.bar,
            pointBorderColor: '#09090B',
            pointBorderWidth: 2,
            tension: 0.3,
            spanGaps: false,
          };
        });

        toksChart = new Chart(ctx, {
          type: 'line',
          data: { labels: tierLabels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#A1A1AA',
                  font: { family: 'Outfit', size: 11 },
                  boxWidth: 12,
                  boxHeight: 2,
                  padding: 16,
                }
              },
              tooltip: {
                backgroundColor: '#1c1c20',
                borderColor: '#27272A',
                borderWidth: 1,
                titleFont: { family: 'Outfit', size: 13, weight: '500' },
                bodyFont: { family: 'Space Mono', size: 12 },
                padding: 12,
                cornerRadius: 2,
                callbacks: {
                  title: ctx => `Context: ${ctx[0].label} tokens`,
                  label: ctx => ctx.parsed.y !== null ? ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)} tok/s` : ` ${ctx.dataset.label}: N/A`,
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                ticks: { color: '#52525B', font: { family: 'Space Mono', size: 11 } },
                title: { display: true, text: 'CONTEXT SIZE (TOKENS)', color: '#3f3f46', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } }
              },
              y: {
                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                ticks: { color: '#52525B', font: { family: 'Space Mono', size: 11 } },
                title: { display: true, text: 'TOKENS / SECOND', color: '#3f3f46', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { right: 12 } }
              }
            }
          }
        });
      }
    }

    function renderTable() {
      const agg = aggregateResults();
      const tbody = document.getElementById('resultsBody');
      const thead = tbody.closest('table').querySelector('thead tr');
      tbody.innerHTML = '';

      const stress = isStressMode();
      const multiRun = agg.some(r => r.runs > 1);

      // Update header
      if (stress) {
        // Add Context column if not present
        if (!thead.querySelector('[data-col="context"]')) {
          const th = document.createElement('th');
          th.className = 'px-5 py-3 text-right section-label';
          th.dataset.col = 'context';
          th.textContent = 'Context';
          // Insert after Model column (index 2)
          thead.children[3].before(th);
        }
      } else {
        const ctxTh = thead.querySelector('[data-col="context"]');
        if (ctxTh) ctxTh.remove();
      }

      // Show/hide Std Dev column based on multi-run
      const stdDevTh = thead.querySelector('[data-col="stddev"]');
      if (stdDevTh) stdDevTh.style.display = multiRun ? '' : 'none';

      agg.forEach((r, i) => {
        const color = getColor(r.provider);
        const pos = i < 3 && r.success ? `<span class="font-display font-bold" ${i===0 ? 'style="color:var(--lime)"' : ''}>${POSITION_LABELS[i]}</span>` : `<span class="text-zinc-600">${i + 1}</span>`;

        const statusHtml = r.failures === 0
          ? `<span class="text-green-500 text-xs font-mono">${r.runs}/${r.runs}</span>`
          : r.failures < r.runs
            ? `<span class="text-amber-500 text-xs font-mono">${r.runs - r.failures}/${r.runs}</span>`
            : `<span class="text-red-400 text-xs font-mono" title="${r.error}">FAIL</span>`;

        const ctxCell = stress ? `<td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.context_tokens === 0 ? '0' : formatCtxSize(r.context_tokens).replace(' ctx', '')}</td>` : '';
        const stdDevCell = multiRun ? `<td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-600">${r.success && r.std_dev_tps > 0 ? '\u00B1' + r.std_dev_tps.toFixed(1) : '-'}</td>` : '';
        const inputTpsFormatted = r.success && r.input_tokens_per_second > 0 ? Math.round(r.input_tokens_per_second).toLocaleString() : '-';
        const costFormatted = r.success && r.avg_cost > 0 ? '$' + r.avg_cost.toFixed(4) : '-';

        const row = document.createElement('tr');
        row.className = i === 0 && r.success ? 'rank-1 fade-in' : 'fade-in';
        row.innerHTML = `
          <td class="px-5 py-3.5 text-center">${pos}</td>
          <td class="px-5 py-3.5"><span class="badge" style="background:${color.bg};color:${color.text};border:1px solid ${color.border}">${r.provider}</span></td>
          <td class="px-5 py-3.5 text-zinc-200 font-medium font-body text-[13px]">${r.model}</td>
          ${ctxCell}
          <td class="px-5 py-3.5 text-right font-mono text-sm ${r.success && i === 0 ? '' : 'text-zinc-400'}" ${r.success && i === 0 ? 'style="color:var(--lime)"' : ''}>${r.success ? r.tokens_per_second.toFixed(1) : '-'}</td>
          ${stdDevCell}
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.success ? r.ttft_ms.toFixed(0) + 'ms' : '-'}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${inputTpsFormatted}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.success ? r.total_time_s.toFixed(2) + 's' : '-'}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.success ? r.output_tokens.toFixed(0) : '-'}</td>
          <td class="px-5 py-3.5 text-center">${statusHtml}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${costFormatted}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderTTFTChart() {
      const section = document.getElementById('ttftChartSection');
      section.classList.remove('hidden');

      const agg = aggregateResults();
      const chartCtx = document.getElementById('ttftChart').getContext('2d');
      if (ttftChart) ttftChart.destroy();

      const stress = isStressMode();
      document.getElementById('ttftChartLabel').textContent = stress ? 'Latency (TTFT) vs Context Size' : 'Time to First Token (TTFT)';

      if (!stress) {
        // === STANDARD: horizontal bar chart of TTFT values ===
        const sorted = [...agg].filter(a => a.success).sort((a, b) => a.ttft_ms - b.ttft_ms);
        const labels = sorted.map(a => a.model);
        const data = sorted.map(a => a.ttft_ms);
        const bgColors = sorted.map(a => getColor(a.provider).bar + 'CC');

        ttftChart = new Chart(chartCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{ label: 'TTFT (ms)', data, backgroundColor: bgColors, borderWidth: 0, borderRadius: 2, barPercentage: 0.55 }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
                titleFont: { family: 'Outfit', size: 13, weight: '500' },
                bodyFont: { family: 'Space Mono', size: 12 },
                padding: 12, cornerRadius: 2,
                callbacks: { label: c => ` ${c.parsed.x.toFixed(0)} ms` }
              }
            },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#52525B', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TIME TO FIRST TOKEN (MS)', color: '#3f3f46', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } } },
              y: { grid: { display: false, drawBorder: false }, ticks: { color: '#A1A1AA', font: { family: 'Outfit', size: 12, weight: '500' } } }
            }
          }
        });
      } else {
        // === STRESS: line chart (existing behavior) ===
        const tiers = [...new Set(agg.map(a => a.context_tokens))].sort((a, b) => a - b);
        const models = [...new Set(agg.map(a => `${a.model_id}::${a.provider}`))];
        const tierLabels = tiers.map(t => t === 0 ? '0' : (t >= 1000 ? (t/1000) + 'K' : t));

        const datasets = models.map(uid => {
          const modelResults = agg.filter(a => `${a.model_id}::${a.provider}` === uid);
          const modelName = modelResults[0]?.model || uid;
          const provider = modelResults[0]?.provider || '';
          const color = getColor(provider);
          const data = tiers.map(tier => { const m = modelResults.find(r => r.context_tokens === tier); return m && m.success ? m.ttft_ms : null; });
          return { label: modelName, data, borderColor: color.bar, backgroundColor: color.bar + '33', borderWidth: 2, pointRadius: 4, pointBackgroundColor: color.bar, pointBorderColor: '#09090B', pointBorderWidth: 2, tension: 0.3, spanGaps: false };
        });

        ttftChart = new Chart(chartCtx, {
          type: 'line',
          data: { labels: tierLabels, datasets },
          options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: true, position: 'top', labels: { color: '#A1A1AA', font: { family: 'Outfit', size: 11 }, boxWidth: 12, boxHeight: 2, padding: 16 } },
              tooltip: { backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1, titleFont: { family: 'Outfit', size: 13, weight: '500' }, bodyFont: { family: 'Space Mono', size: 12 }, padding: 12, cornerRadius: 2, callbacks: { title: c => `Context: ${c[0].label} tokens`, label: c => c.parsed.y !== null ? ` ${c.dataset.label}: ${c.parsed.y.toFixed(0)}ms` : ` ${c.dataset.label}: N/A` } }
            },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#52525B', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'CONTEXT SIZE (TOKENS)', color: '#3f3f46', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } } },
              y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#52525B', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TIME TO FIRST TOKEN (MS)', color: '#3f3f46', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { right: 12 } } }
            }
          }
        });
      }
    }

    // -------------------------------------------------------------------
    // Scatter chart: Speed vs Latency
    // -------------------------------------------------------------------
    function renderScatterChart() {
      const section = document.getElementById('scatterChartSection');
      const agg = aggregateResults().filter(a => a.success);
      if (agg.length < 2) { section.classList.add('hidden'); return; }
      section.classList.remove('hidden');

      const chartCtx = document.getElementById('scatterChart').getContext('2d');
      if (scatterChart) scatterChart.destroy();

      // Scale point size: output_tokens mapped to 5-20px
      const allTokens = agg.map(a => a.output_tokens);
      const minT = Math.min(...allTokens), maxT = Math.max(...allTokens);
      const scaleSize = (t) => maxT === minT ? 10 : 5 + (t - minT) / (maxT - minT) * 15;

      const datasets = agg.map(a => {
        const color = getColor(a.provider);
        return {
          label: a.model,
          data: [{ x: a.tokens_per_second, y: a.ttft_ms }],
          backgroundColor: color.bar,
          borderColor: color.bar,
          pointRadius: scaleSize(a.output_tokens),
          pointHoverRadius: scaleSize(a.output_tokens) + 3,
        };
      });

      scatterChart = new Chart(chartCtx, {
        type: 'scatter',
        data: { datasets },
        options: {
          responsive: true, maintainAspectRatio: false,
          animation: { duration: 800, easing: 'easeOutQuart' },
          plugins: {
            legend: { display: true, position: 'top', labels: { color: '#A1A1AA', font: { family: 'Outfit', size: 11 }, boxWidth: 8, boxHeight: 8, padding: 12, usePointStyle: true } },
            tooltip: {
              backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
              titleFont: { family: 'Outfit', size: 13, weight: '500' },
              bodyFont: { family: 'Space Mono', size: 12 },
              padding: 12, cornerRadius: 2,
              callbacks: {
                title: c => c[0].dataset.label,
                label: c => [` Tok/s: ${c.parsed.x.toFixed(1)}`, ` TTFT: ${c.parsed.y.toFixed(0)}ms`]
              }
            }
          },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#52525B', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TOKENS / SECOND', color: '#3f3f46', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } } },
            y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#52525B', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TTFT (MS)', color: '#3f3f46', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { right: 12 } } }
          }
        }
      });
    }

    // -------------------------------------------------------------------
    // CSV Export
    // -------------------------------------------------------------------
    function exportCSV() {
      const agg = aggregateResults();
      if (!agg.length) { showToast('No results to export', 'error'); return; }
      const headers = ['Provider','Model','Tok/s','TTFT (ms)','Input Tok/s','Duration (s)','Output Tokens','Status','Avg Cost','Total Cost'];
      const rows = agg.map(r => [
        r.provider, r.model,
        r.success ? r.tokens_per_second.toFixed(2) : '',
        r.success ? r.ttft_ms.toFixed(0) : '',
        r.success && r.input_tokens_per_second > 0 ? Math.round(r.input_tokens_per_second) : '',
        r.success ? r.total_time_s.toFixed(3) : '',
        r.success ? r.output_tokens.toFixed(0) : '',
        r.success ? (r.failures ? 'partial' : 'ok') : 'fail',
        r.success && r.avg_cost > 0 ? r.avg_cost.toFixed(6) : '',
        r.success && r.total_cost > 0 ? r.total_cost.toFixed(6) : '',
      ]);
      const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'benchmark_results.csv'; a.click();
      URL.revokeObjectURL(url);
      showToast('CSV downloaded', 'success');
    }

    // -------------------------------------------------------------------
    // Tabs
    // -------------------------------------------------------------------
    function showTab(tab) {
      document.getElementById('view-benchmark').classList.toggle('hidden', tab !== 'benchmark');
      document.getElementById('view-history').classList.toggle('hidden', tab !== 'history');
      document.getElementById('view-settings').classList.toggle('hidden', tab !== 'settings');
      document.getElementById('tab-benchmark').classList.toggle('tab-active', tab === 'benchmark');
      document.getElementById('tab-history').classList.toggle('tab-active', tab === 'history');
      document.getElementById('tab-settings').classList.toggle('tab-active', tab === 'settings');
      if (tab === 'history') loadHistory();
      if (tab === 'settings') renderSettings();
    }

    // -------------------------------------------------------------------
    // Settings — Full CRUD
    // -------------------------------------------------------------------
    const QUICK_CTX_SIZES = [4096, 8192, 16384, 32768, 65536, 131072, 200000];
    const QUICK_CTX_LABELS = ['4K', '8K', '16K', '32K', '64K', '128K', '200K'];
    const INPUT_STYLE = "background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;";
    const INPUT_CLASS = "w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200";

    async function refreshConfig() {
      const res = await apiFetch('/api/config');
      config = await res.json();
    }

    function showStatus(elId, ok, msg) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.classList.remove('hidden');
      el.style.color = ok ? 'var(--lime)' : 'var(--coral)';
      el.textContent = msg;
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // ── Render Settings (orchestrator) ──
    async function renderSettings() {
      if (!config) {
        try { await refreshConfig(); } catch (e) {
          document.getElementById('settingsContainer').innerHTML = '<p class="text-red-400 text-sm">Failed to load config.</p>';
          return;
        }
      }
      await renderApiKeys();
      renderProviders();
    }

    // ── API Keys (per-user) ──
    async function renderApiKeys() {
      const container = document.getElementById('apiKeysContainer');
      try {
        const res = await apiFetch('/api/keys');
        const data = await res.json();
        const keys = data.keys || [];

        container.innerHTML = `
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">My API Keys</span>
              <span class="text-[10px] text-zinc-600 font-body">Your keys are encrypted and only used for your benchmarks</span>
            </div>
            <div class="divide-y" style="border-color:var(--border-subtle)">
              ${keys.length === 0 ? '<div class="px-5 py-3 text-zinc-700 text-xs font-body">No providers configured.</div>' :
                keys.map(k => `
                  <div class="px-5 py-3 flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                      <span class="text-xs font-body text-zinc-300">${k.display_name}</span>
                      <span class="text-[10px] font-mono text-zinc-600">${k.key_env_name || k.provider_key}</span>
                      ${k.has_user_key
                        ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(191,255,0,0.08);color:var(--lime);border:1px solid rgba(191,255,0,0.2)">YOUR KEY</span>'
                        : k.has_global_key
                          ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:1px solid rgba(56,189,248,0.2)">SHARED</span>'
                          : '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(255,59,92,0.08);color:var(--coral);border:1px solid rgba(255,59,92,0.2)">NOT SET</span>'
                      }
                    </div>
                    <div class="flex gap-2">
                      <button onclick="setMyKey('${k.provider_key}','${k.display_name}')" class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm transition-colors ${k.has_user_key ? 'text-zinc-500 hover:text-zinc-300' : 'hover:text-zinc-200'}" style="${k.has_user_key ? '' : 'color:var(--lime);border:1px solid rgba(191,255,0,0.2)'}">${k.has_user_key ? 'Update' : 'Set Key'}</button>
                      ${k.has_user_key ? `<button onclick="removeMyKey('${k.provider_key}','${k.display_name}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-red-400 transition-colors">Remove</button>` : ''}
                    </div>
                  </div>
                `).join('')}
            </div>
          </div>
        `;
      } catch (e) {
        container.innerHTML = '<p class="text-red-400 text-xs">Failed to load API keys.</p>';
      }
    }

    async function setMyKey(providerKey, displayName) {
      showInputModal('Set API Key for ' + displayName, 'Paste your API key...', async (value) => {
        await apiFetch('/api/keys', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider_key: providerKey, value })
        });
        renderApiKeys();
      }, { inputType: 'password' });
    }

    async function removeMyKey(providerKey, displayName) {
      showModal('Remove Key', 'Remove your personal key for <strong>' + displayName + '</strong>? You will fall back to the shared key (if one exists).', async () => {
        await apiFetch('/api/keys', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider_key: providerKey })
        });
        renderApiKeys();
      }, { danger: true, confirmLabel: 'Remove' });
    }

    // ── Render Providers + Models ──
    function renderProviders() {
      const container = document.getElementById('settingsContainer');
      container.innerHTML = '';

      for (const [provDisplayName, provData] of Object.entries(config.providers)) {
        const pk = provData.provider_key;
        const models = provData.models || [];
        const color = getColor(provDisplayName);
        const prefix = provData.model_id_prefix || detectPrefix(models);

        const section = document.createElement('div');
        section.className = 'card rounded-md overflow-hidden';
        section.innerHTML = `
          <!-- Provider Header -->
          <div class="px-5 py-3 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
            <div class="flex items-center gap-3">
              <span class="badge" style="background:${color.bg};color:${color.text};border:1px solid ${color.border}">${provDisplayName}</span>
              <span class="text-zinc-600 text-xs font-body">${models.length} model${models.length!==1?'s':''}</span>
              <span class="text-[9px] font-mono text-zinc-700">${pk}</span>
              ${prefix ? `<span class="text-[9px] font-mono px-1.5 py-0.5 rounded-sm" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:1px solid rgba(56,189,248,0.2)">prefix: ${prefix}/</span>` : ''}
            </div>
            <div class="flex gap-2">
              <button onclick="fetchAndShowModels('${pk}', this)" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors">Fetch</button>
              <button onclick="editProvider('${pk}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors">Edit</button>
              <button onclick="deleteProvider('${pk}','${provDisplayName}',${models.length})" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-red-400 transition-colors">Del</button>
            </div>
          </div>
          <!-- Provider edit form (hidden) -->
          <div id="prov-edit-${pk}" class="hidden px-5 py-3" style="border-bottom:1px solid var(--border-subtle);background:rgba(191,255,0,0.02)">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-2">
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
                <input id="pe-dn-${pk}" value="${provDisplayName}" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID Prefix</label>
                <input id="pe-prefix-${pk}" value="${provData.model_id_prefix || detectPrefix(provData.models)}" placeholder="Optional" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Base</label>
                <input id="pe-ab-${pk}" value="${provData.api_base||''}" placeholder="https://..." class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Key Name</label>
                <input id="pe-ke-${pk}" value="${provData.api_key_env||''}" placeholder="e.g. OPENAI_API_KEY" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
            </div>
            <button onclick="saveProvider('${pk}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Save Provider</button>
            <span id="prov-status-${pk}" class="ml-3 text-[11px] font-body hidden"></span>
          </div>
          <!-- Models -->
          <div class="divide-y" style="border-color:var(--border-subtle)">
            ${models.map(m => renderModelCard(pk, m)).join('')}
          </div>
          <!-- Add Model -->
          <div class="px-5 py-3" style="border-top:1px solid var(--border-subtle)">
            <button onclick="toggleAddModel('${pk}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">+ Add Model</button>
            <div id="add-model-${pk}" class="hidden mt-3">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-2">
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID</label>
                  <div class="flex items-center gap-0">
                    ${prefix ? `<span class="text-[11px] font-mono px-2 py-2 rounded-l-sm flex-shrink-0" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:1px solid rgba(56,189,248,0.2);border-right:none;">${prefix}/</span>` : ''}
                    <input id="am-id-${pk}" placeholder="${prefix ? 'model-name' : 'provider/model-name'}" list="dl-am-${pk}" class="${INPUT_CLASS} ${prefix ? 'rounded-l-none' : ''}" style="${INPUT_STYLE}" onfocus="loadAndPopulateDatalist('${pk}', 'dl-am-${pk}')" oninput="autoDeriveName('am-id-${pk}','am-dn-${pk}'); updateModelPreview('${pk}'); autoFillDisplayName(this, '${pk}', 'am-dn-${pk}')">
                  </div>
                  <datalist id="dl-am-${pk}"></datalist>
                  <div id="am-preview-${pk}" class="text-[9px] font-mono text-zinc-600 mt-1"></div>
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
                  <input id="am-dn-${pk}" placeholder="Auto from ID" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Context Window</label>
                  <input id="am-ctx-${pk}" value="128000" type="number" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
                </div>
              </div>
              <button onclick="addModel('${pk}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Add</button>
            </div>
          </div>
        `;
        container.appendChild(section);
      }

      // Add Provider button at bottom
      const addProvBtn = document.createElement('div');
      addProvBtn.innerHTML = `
        <button onclick="toggleAddProvider()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-2 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">+ Add Provider</button>
        <div id="add-provider-form" class="hidden card rounded-md p-5 mt-3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
              <input id="ap-dn" placeholder="My Provider" class="${INPUT_CLASS}" style="${INPUT_STYLE}" oninput="document.getElementById('ap-key').value = uniqueProviderKey(slugify(this.value)); document.getElementById('ap-ke').value = slugify(this.value).toUpperCase().replace(/-/g,'_') + '_API_KEY'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Provider Key <span class="text-zinc-700 normal-case">(auto-derived, editable)</span></label>
              <input id="ap-key" placeholder="auto_generated" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID Prefix <span class="text-zinc-700 normal-case">(e.g. lm_studio)</span></label>
              <input id="ap-prefix" placeholder="Optional — prepended to model IDs" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Base</label>
              <input id="ap-ab" placeholder="https://api.example.com/v1" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Key Name <span class="text-zinc-700 normal-case">(auto-derived)</span></label>
              <input id="ap-ke" placeholder="e.g. OPENAI_API_KEY" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
          </div>
          <button onclick="addProvider()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Create Provider</button>
        </div>
      `;
      container.appendChild(addProvBtn);
    }

    // ── Single model card ──
    function renderModelCard(provKey, m) {
      const sid = safeId(provKey + '__' + m.model_id);
      const skipHtml = (m.skip_params || []).map(p =>
        `<span class="text-[10px] font-mono text-zinc-400 px-1.5 py-0.5 rounded-sm inline-flex items-center gap-1" style="background:rgba(255,255,255,0.04)">
          ${p} <button onclick="removeSkipParam('${provKey}','${m.model_id}','${p}')" class="text-zinc-600 hover:text-red-400">&times;</button>
        </span>`
      ).join(' ');

      // Custom fields (anything not standard)
      const stdKeys = new Set(['model_id','display_name','context_window','max_output_tokens','skip_params']);
      const customs = Object.entries(m).filter(([k]) => !stdKeys.has(k));
      const customHtml = customs.map(([k,v]) =>
        `<div class="flex items-center gap-2">
          <span class="text-[10px] font-mono text-zinc-500">${k}:</span>
          <input id="cf-${sid}-${safeId(k)}" value="${v}" class="px-2 py-1 rounded-sm text-[11px] font-mono text-zinc-300 flex-1" style="${INPUT_STYLE}">
          <button onclick="removeCustomField('${provKey}','${m.model_id}','${k}')" class="text-zinc-600 hover:text-red-400 text-xs">&times;</button>
        </div>`
      ).join('');

      return `
        <div class="px-5 py-4" id="settings-${sid}">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="text-[13px] font-medium text-zinc-200 font-body">${m.display_name}</div>
              <span class="text-[9px] font-mono text-zinc-700">${m.model_id}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="saveModelConfig('${provKey}','${m.model_id}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">Save</button>
              <button onclick="deleteModel('${provKey}','${m.model_id}','${m.display_name}')" class="text-[11px] font-display tracking-wider uppercase px-2 py-1.5 rounded-sm text-zinc-600 hover:text-red-400 transition-colors" style="border:1px solid var(--border-subtle)">&times;</button>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID</label>
              <input id="mid-${sid}" value="${m.model_id}" list="dl-${sid}" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'; loadAndPopulateDatalist('${provKey}', 'dl-${sid}')" onblur="this.style.borderColor='var(--border-subtle)'" oninput="autoDeriveName('mid-${sid}','mdn-${sid}'); autoFillDisplayName(this, '${provKey}', 'mdn-${sid}')">
              <datalist id="dl-${sid}"></datalist>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
              <input id="mdn-${sid}" value="${m.display_name}" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Context Window</label>
              <input type="number" id="ctx-${sid}" value="${m.context_window||128000}" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
              <div class="flex gap-1.5 mt-2 flex-wrap">
                ${QUICK_CTX_SIZES.map((size,i) => `<button onclick="document.getElementById('ctx-${sid}').value=${size}" class="text-[9px] font-mono px-2 py-0.5 rounded-sm text-zinc-600 hover:text-zinc-400 transition-colors" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle)">${QUICK_CTX_LABELS[i]}</button>`).join('')}
              </div>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Max Output Tokens</label>
              <input type="number" id="mot-${sid}" value="${m.max_output_tokens||''}" placeholder="Default" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
          </div>
          <!-- Skip Params -->
          <div class="mt-3">
            <span class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Skip Params: </span>
            <span id="sp-pills-${sid}">${skipHtml || '<span class="text-[10px] text-zinc-700 font-body">none</span>'}</span>
            <button onclick="promptAddSkipParam('${provKey}','${m.model_id}')" class="text-[10px] font-mono text-zinc-500 hover:text-zinc-300 ml-2 px-1.5 py-0.5 rounded-sm" style="border:1px solid var(--border-subtle)">+ add</button>
          </div>
          <!-- Custom Fields -->
          <div class="mt-3">
            <span class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Custom Fields</span>
            <div id="cf-${sid}" class="space-y-1">${customHtml || '<span class="text-[10px] text-zinc-700 font-body">none</span>'}</div>
            <button onclick="promptAddCustomField('${provKey}','${m.model_id}')" class="text-[10px] font-mono text-zinc-500 hover:text-zinc-300 mt-1 px-1.5 py-0.5 rounded-sm" style="border:1px solid var(--border-subtle)">+ add field</button>
          </div>
          <div id="save-status-${sid}" class="mt-2 text-[11px] font-body hidden"></div>
        </div>
      `;
    }

    async function loadProviderModels(provKey) {
      if (discoveredModelsCache[provKey]) return discoveredModelsCache[provKey];
      try {
        const res = await apiFetch(`/api/models/discover?provider_key=${encodeURIComponent(provKey)}`);
        const data = await res.json();
        if (data.models) {
          discoveredModelsCache[provKey] = data.models;
          return data.models;
        }
      } catch(e) {}
      return [];
    }

    async function loadAndPopulateDatalist(provKey, datalistId) {
      const dl = document.getElementById(datalistId);
      if (!dl || dl.children.length > 0) return;
      const models = await loadProviderModels(provKey);
      dl.innerHTML = models.map(m => `<option value="${m.id}">${m.display_name}</option>`).join('');
    }

    function autoFillDisplayName(input, provKey, dnFieldId) {
      const models = discoveredModelsCache[provKey] || [];
      const match = models.find(m => m.id === input.value);
      if (match) {
        const dnField = document.getElementById(dnFieldId);
        if (dnField) dnField.value = match.display_name;
      }
    }

    function autoDeriveName(idInputId, nameInputId) {
      const idVal = document.getElementById(idInputId)?.value || '';
      const nameInput = document.getElementById(nameInputId);
      if (nameInput && !nameInput.dataset.manual) {
        nameInput.value = idVal.includes('/') ? idVal.split('/').pop() : idVal;
      }
    }

    function updateModelPreview(provKey) {
      const previewEl = document.getElementById(`am-preview-${provKey}`);
      const inputEl = document.getElementById(`am-id-${provKey}`);
      if (!previewEl || !inputEl) return;
      const provData = Object.values(config.providers).find(p => p.provider_key === provKey);
      const prefix = provData?.model_id_prefix || '';
      const val = inputEl.value.trim();
      if (!val) { previewEl.textContent = ''; return; }
      if (prefix && !val.startsWith(prefix + '/')) {
        previewEl.textContent = `Full ID: ${prefix}/${val}`;
      } else {
        previewEl.textContent = `Full ID: ${val}`;
      }
    }

    // ── Save Model ──
    async function saveModelConfig(providerKey, modelId) {
      const sid = safeId(providerKey + '__' + modelId);
      const statusId = `save-status-${sid}`;

      // Collect skip_params from current config
      const provData = Object.values(config.providers).find(p => p.provider_key === providerKey);
      const modelData = provData?.models?.find(m => m.model_id === modelId);
      const currentSkipParams = modelData?.skip_params || [];

      // Collect custom fields
      const stdKeys = new Set(['model_id','display_name','context_window','max_output_tokens','skip_params']);
      const customs = {};
      if (modelData) {
        for (const [k] of Object.entries(modelData).filter(([k]) => !stdKeys.has(k))) {
          const el = document.getElementById(`cf-${sid}-${safeId(k)}`);
          if (el) customs[k] = el.value;
        }
      }

      const body = {
        provider_key: providerKey,
        model_id: modelId,
        new_model_id: document.getElementById(`mid-${sid}`)?.value || modelId,
        display_name: document.getElementById(`mdn-${sid}`)?.value || '',
        context_window: parseInt(document.getElementById(`ctx-${sid}`)?.value) || null,
        max_output_tokens: parseInt(document.getElementById(`mot-${sid}`)?.value) || null,
        skip_params: currentSkipParams,
        custom_fields: Object.keys(customs).length ? customs : undefined,
      };

      try {
        const res = await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const result = await res.json();
        if (res.ok) {
          showStatus(statusId, true, 'Saved');
          await refreshConfig();
          renderModels();
        } else {
          showStatus(statusId, false, result.error || 'Save failed');
        }
      } catch (e) {
        showStatus(statusId, false, 'Network error');
      }
    }

    // ── Model CRUD ──
    async function deleteModel(provKey, modelId, displayName) {
      showModal('Remove Model', `Remove model <strong>${displayName}</strong>?`, async () => {
        await apiFetch('/api/config/model', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId}) });
        await refreshConfig();
        renderModels();
        renderProviders();
      }, { danger: true, confirmLabel: 'Remove' });
    }

    function toggleAddModel(provKey) {
      document.getElementById(`add-model-${provKey}`)?.classList.toggle('hidden');
    }

    async function addModel(provKey) {
      const id = document.getElementById(`am-id-${provKey}`)?.value.trim();
      if (!id) return;
      const body = {
        provider_key: provKey,
        id: id,
        display_name: document.getElementById(`am-dn-${provKey}`)?.value.trim() || '',
        context_window: parseInt(document.getElementById(`am-ctx-${provKey}`)?.value) || 128000,
      };
      const res = await apiFetch('/api/config/model', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (res.ok) {
        await refreshConfig();
        renderModels();
        renderProviders();
      } else {
        const err = await res.json();
        showToast(err.error || 'Failed to add model', 'error');
      }
    }

    // ── Skip Params ──
    async function promptAddSkipParam(provKey, modelId) {
      showInputModal('Add Skip Param', 'Parameter name (e.g., temperature)', async (param) => {
        if (!param || !param.trim()) return;
        const provData = Object.values(config.providers).find(p => p.provider_key === provKey);
        const modelData = provData?.models?.find(m => m.model_id === modelId);
        const current = [...(modelData?.skip_params || [])];
        if (!current.includes(param.trim())) current.push(param.trim());
        await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, skip_params: current}) });
        await refreshConfig();
        renderProviders();
      });
    }

    async function removeSkipParam(provKey, modelId, param) {
      const provData = Object.values(config.providers).find(p => p.provider_key === provKey);
      const modelData = provData?.models?.find(m => m.model_id === modelId);
      const current = (modelData?.skip_params || []).filter(p => p !== param);
      await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, skip_params: current}) });
      await refreshConfig();
      renderProviders();
    }

    // ── Custom Fields ──
    async function promptAddCustomField(provKey, modelId) {
      showDoubleInputModal('Add Custom Field', [
        { label: 'Field Name', placeholder: 'e.g., pricing_tier' },
        { label: 'Value', placeholder: 'e.g., standard' }
      ], async (key, value) => {
        if (!key || !key.trim()) return;
        await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, custom_fields: {[key.trim()]: value}}) });
        await refreshConfig();
        renderProviders();
      });
    }

    async function removeCustomField(provKey, modelId, key) {
      await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, custom_fields: {[key]: null}}) });
      await refreshConfig();
      renderProviders();
    }

    // ── Fetch Models from Provider API ──
    async function fetchAndShowModels(provKey, btn) {
      const origText = btn.textContent;
      btn.textContent = 'Loading...';
      btn.disabled = true;

      try {
        const res = await apiFetch(`/api/models/discover?provider_key=${encodeURIComponent(provKey)}`);
        const data = await res.json();

        if (data.error) {
          showToast(data.error, 'error');
          return;
        }

        const models = data.models || [];
        if (models.length === 0) {
          showToast('No models found', 'error');
          return;
        }

        // Get existing model IDs for this provider
        const existingIds = new Set();
        for (const [name, p] of Object.entries(config.providers || {})) {
          if (p.provider_key === provKey) {
            (p.models || []).forEach(m => existingIds.add(m.model_id));
          }
        }

        // Build checkbox list HTML
        const listHtml = models.map((m, i) => {
          const exists = existingIds.has(m.id);
          return `<label class="flex items-center gap-2 py-1.5 px-2 rounded hover:bg-white/5 cursor-pointer ${exists ? 'opacity-40' : ''}">
            <input type="checkbox" value="${i}" ${exists ? 'checked disabled' : ''} class="accent-lime-400">
            <span class="text-xs font-mono text-zinc-300">${m.id}</span>
            ${m.display_name !== m.id ? `<span class="text-[10px] text-zinc-500">${m.display_name}</span>` : ''}
            ${exists ? '<span class="text-[9px] text-zinc-600 ml-auto">already added</span>' : ''}
          </label>`;
        }).join('');

        // Create overlay modal
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.innerHTML = `
          <div class="card rounded-md p-5 w-full max-w-lg max-h-[70vh] flex flex-col" style="border:1px solid var(--border-subtle)">
            <div class="flex items-center justify-between mb-3">
              <span class="font-display text-sm tracking-wide text-zinc-200">${models.length} models available</span>
              <button data-action="close" class="text-zinc-500 hover:text-zinc-300 text-xs cursor-pointer">Close</button>
            </div>
            <div class="overflow-y-auto flex-1 mb-3" id="model-pick-list">
              ${listHtml}
            </div>
            <button id="add-selected-models-btn" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-2 rounded-sm self-end cursor-pointer" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Add Selected</button>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.querySelector('[data-action="close"]').onclick = () => { overlay.classList.add('modal-closing'); setTimeout(() => overlay.remove(), 200); };
        overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.classList.add('modal-closing'); setTimeout(() => overlay.remove(), 200); } });

        // Handle "Add Selected"
        document.getElementById('add-selected-models-btn').onclick = async () => {
          const checks = overlay.querySelectorAll('input[type=checkbox]:checked:not(:disabled)');
          if (checks.length === 0) {
            showToast('No models selected', 'error');
            return;
          }
          const addBtn = document.getElementById('add-selected-models-btn');
          addBtn.textContent = 'Adding...';
          addBtn.disabled = true;

          for (const cb of checks) {
            const m = models[parseInt(cb.value)];
            await apiFetch('/api/config/model', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ provider_key: provKey, id: m.id, display_name: m.display_name })
            });
          }

          overlay.classList.add('modal-closing');
          setTimeout(() => overlay.remove(), 200);
          await refreshConfig();
          renderModels();
          renderProviders();
          showToast(`Added ${checks.length} model(s)`);
        };

      } catch (e) {
        showToast('Failed to fetch models: ' + e.message, 'error');
      } finally {
        btn.textContent = origText;
        btn.disabled = false;
      }
    }

    // ── Provider CRUD ──
    function editProvider(pk) {
      document.getElementById(`prov-edit-${pk}`)?.classList.toggle('hidden');
    }

    async function saveProvider(pk) {
      const body = {
        provider_key: pk,
        display_name: document.getElementById(`pe-dn-${pk}`)?.value || pk,
        api_base: document.getElementById(`pe-ab-${pk}`)?.value || '',
        api_key_env: document.getElementById(`pe-ke-${pk}`)?.value || '',
        model_id_prefix: document.getElementById(`pe-prefix-${pk}`)?.value.trim() || '',
      };
      const res = await apiFetch('/api/config/provider', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (res.ok) {
        showStatus(`prov-status-${pk}`, true, 'Saved');
        await refreshConfig();
        renderModels();
        renderProviders();
      } else {
        const err = await res.json();
        showStatus(`prov-status-${pk}`, false, err.error || 'Failed');
      }
    }

    async function deleteProvider(pk, displayName, modelCount) {
      showModal('Delete Provider', `Delete <strong>${displayName}</strong> and its ${modelCount} model(s)?`, async () => {
        await apiFetch('/api/config/provider', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: pk}) });
        await refreshConfig();
        renderModels();
        renderProviders();
      }, { danger: true, confirmLabel: 'Delete' });
    }

    function toggleAddProvider() {
      document.getElementById('add-provider-form')?.classList.toggle('hidden');
    }

    async function addProvider() {
      const body = {
        provider_key: document.getElementById('ap-key')?.value.trim(),
        display_name: document.getElementById('ap-dn')?.value.trim(),
        api_base: document.getElementById('ap-ab')?.value.trim(),
        api_key_env: document.getElementById('ap-ke')?.value.trim(),
        model_id_prefix: document.getElementById('ap-prefix')?.value.trim(),
      };
      if (!body.provider_key) { showToast('Provider key is required', 'error'); return; }
      const res = await apiFetch('/api/config/provider', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (res.ok) {
        await refreshConfig();
        renderModels();
        renderProviders();
      } else {
        const err = await res.json();
        showToast(err.error || 'Failed to add provider', 'error');
      }
    }

    async function loadHistory() {
      const container = document.getElementById('historyContainer');
      selectedHistoryRuns.clear();
      document.getElementById('historyCompareBar').classList.add('hidden');
      document.getElementById('historyCompareResult').classList.add('hidden');

      try {
        const res = await apiFetch('/api/history');
        const history = await res.json();

        if (!history.length) {
          container.innerHTML = '<div class="card rounded-sm p-10 text-center"><p class="text-zinc-600 font-body">No benchmark history yet.</p><p class="text-zinc-700 text-xs mt-1 font-body">Run your first benchmark to see results here.</p></div>';
          return;
        }

        container.innerHTML = history.map((h, idx) => {
          const ts = new Date(h.timestamp).toLocaleString();
          const isV2 = (h.schema_version || 0) >= 2;
          const sorted = [...(h.results || [])].map(r => ({
            ...r,
            avg_tokens_per_second: r.avg_tokens_per_second ?? r.tokens_per_second ?? 0,
            avg_ttft_ms: r.avg_ttft_ms ?? r.ttft_ms ?? 0,
            avg_total_time_s: r.avg_total_time_s ?? r.total_time_s ?? 0,
            std_dev_tps: r.std_dev_tps ?? 0,
            p50_tps: r.p50_tps ?? 0,
            p95_tps: r.p95_tps ?? 0,
          })).sort((a, b) => b.avg_tokens_per_second - a.avg_tokens_per_second);
          const winner = sorted[0];
          const hasMultiRun = isV2 && sorted.some(r => (r.runs || 1) > 1);
          const hasFilename = !!h.filename;

          return `
            <div class="card rounded-sm p-5 fade-in" style="animation-delay: ${idx * 40}ms">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  ${hasFilename ? `<button onclick="toggleHistoryCheckbox(this, '${h.filename}')" class="w-4 h-4 rounded-sm border flex items-center justify-center transition-all flex-shrink-0" style="border-color:var(--border-subtle)" title="Select for comparison" data-checked="false"></button>` : ''}
                  <span class="text-[11px] text-zinc-600 font-mono">${ts}</span>
                  ${isV2 ? '<span class="text-[9px] font-mono text-zinc-700 border rounded-sm px-1.5 py-0.5" style="border-color:var(--border-subtle)">v2</span>' : ''}
                  ${winner ? `<span class="badge" style="background:var(--lime-dim);color:var(--lime);border:1px solid rgba(191,255,0,0.2)">P1: ${winner.model}</span>` : ''}
                </div>
                ${winner ? `<span class="font-mono text-sm" style="color:var(--lime)">${winner.avg_tokens_per_second} tok/s</span>` : ''}
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-xs">
                  <thead><tr class="text-zinc-700">
                    <th class="px-3 py-1.5 text-left section-label">Model</th>
                    <th class="px-3 py-1.5 text-right section-label">Tok/s</th>
                    ${hasMultiRun ? '<th class="px-3 py-1.5 text-right section-label">Std Dev</th>' : ''}
                    ${isV2 ? '<th class="px-3 py-1.5 text-right section-label">P50</th><th class="px-3 py-1.5 text-right section-label">P95</th>' : ''}
                    <th class="px-3 py-1.5 text-right section-label">TTFT</th>
                    <th class="px-3 py-1.5 text-right section-label">Duration</th>
                  </tr></thead>
                  <tbody>
                    ${sorted.map((r, i) => `
                      <tr style="border-top: 1px solid var(--border-subtle)">
                        <td class="px-3 py-2 text-zinc-400 font-body">${r.provider} / ${r.model}</td>
                        <td class="px-3 py-2 text-right font-mono ${i === 0 ? '' : 'text-zinc-500'}" ${i === 0 ? 'style="color:var(--lime)"' : ''}>${r.avg_tokens_per_second}</td>
                        ${hasMultiRun ? `<td class="px-3 py-2 text-right font-mono text-zinc-600">${r.std_dev_tps > 0 ? '\u00B1' + r.std_dev_tps.toFixed(1) : '-'}</td>` : ''}
                        ${isV2 ? `<td class="px-3 py-2 text-right font-mono text-zinc-600">${r.p50_tps || '-'}</td><td class="px-3 py-2 text-right font-mono text-zinc-600">${r.p95_tps || '-'}</td>` : ''}
                        <td class="px-3 py-2 text-right font-mono text-zinc-600">${r.avg_ttft_ms}ms</td>
                        <td class="px-3 py-2 text-right font-mono text-zinc-600">${r.avg_total_time_s}s</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        container.innerHTML = '<p class="text-red-400 text-sm font-body">Failed to load history.</p>';
      }
    }

    // -------------------------------------------------------------------
    // Prompt Templates
    // -------------------------------------------------------------------
    let promptTemplates = {};

    async function loadPromptTemplates() {
      try {
        const res = await apiFetch('/api/config/prompts');
        promptTemplates = await res.json();
        const select = document.getElementById('promptTemplateSelect');
        select.innerHTML = '<option value="">Custom</option>';
        for (const [key, tpl] of Object.entries(promptTemplates)) {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = tpl.label || key;
          select.appendChild(opt);
        }
      } catch (e) {
        console.error('Failed to load prompt templates:', e);
      }
    }

    function applyPromptTemplate(key) {
      const textarea = document.getElementById('prompt');
      if (!key) {
        // Custom - leave textarea as is, make it editable
        textarea.removeAttribute('readonly');
        return;
      }
      const tpl = promptTemplates[key];
      if (tpl) {
        textarea.value = tpl.prompt;
        textarea.removeAttribute('readonly');
      }
    }

    // -------------------------------------------------------------------
    // Provider Health Check
    // -------------------------------------------------------------------
    async function checkProviderHealth() {
      const btn = document.getElementById('healthCheckBtn');
      btn.textContent = 'Checking...';
      btn.style.opacity = '0.5';
      btn.disabled = true;

      try {
        const res = await apiFetch('/api/health/providers');
        const data = await res.json();
        const healthMap = {};
        for (const p of data.providers) {
          healthMap[p.name] = p;
        }

        // Update provider group headers with health status
        const headers = document.querySelectorAll('.provider-group-header');
        headers.forEach(header => {
          const labelEl = header.querySelector('.provider-group-label');
          if (!labelEl) return;
          const provName = labelEl.textContent.trim();
          const health = healthMap[provName];

          // Remove any existing health indicator
          const existing = header.querySelector('.health-indicator');
          if (existing) existing.remove();

          if (health) {
            const indicator = document.createElement('span');
            indicator.className = 'health-indicator';
            indicator.style.cssText = 'display:inline-flex;align-items:center;gap:4px;margin-left:4px;';
            if (health.status === 'ok') {
              indicator.innerHTML = `<span style="width:6px;height:6px;border-radius:50%;background:#22C55E;display:inline-block;box-shadow:0 0 6px rgba(34,197,94,0.4)"></span><span style="font-size:9px;font-family:'Space Mono',monospace;color:#52525B">${health.latency_ms}ms</span>`;
            } else {
              indicator.innerHTML = `<span style="width:6px;height:6px;border-radius:50%;background:#FF3B5C;display:inline-block;box-shadow:0 0 6px rgba(255,59,92,0.4)"></span><span style="font-size:9px;font-family:'Space Mono',monospace;color:#FF3B5C" title="${health.error || ''}">err</span>`;
            }
            header.appendChild(indicator);
          }
        });

        showToast('Health check complete', 'success');
      } catch (e) {
        showToast('Health check failed: ' + e.message, 'error');
      } finally {
        btn.textContent = 'Check Health';
        btn.style.opacity = '1';
        btn.disabled = false;
      }
    }

    // -------------------------------------------------------------------
    // Cross-Run Comparison (History)
    // -------------------------------------------------------------------
    let selectedHistoryRuns = new Set();

    function toggleHistoryCheckbox(btn, filename) {
      const isChecked = btn.dataset.checked === 'true';
      if (isChecked) {
        btn.dataset.checked = 'false';
        btn.style.borderColor = 'var(--border-subtle)';
        btn.style.background = 'transparent';
        btn.innerHTML = '';
        selectedHistoryRuns.delete(filename);
      } else {
        btn.dataset.checked = 'true';
        btn.style.borderColor = '#38BDF8';
        btn.style.background = 'rgba(56,189,248,0.15)';
        btn.innerHTML = '<svg class="w-2.5 h-2.5" fill="none" stroke="#38BDF8" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
        selectedHistoryRuns.add(filename);
      }
      const bar = document.getElementById('historyCompareBar');
      const countEl = document.getElementById('compareCount');
      if (selectedHistoryRuns.size >= 2) {
        bar.classList.remove('hidden');
        countEl.textContent = selectedHistoryRuns.size;
      } else {
        bar.classList.add('hidden');
      }
    }

    async function compareSelectedRuns() {
      const filenames = Array.from(selectedHistoryRuns);
      if (filenames.length < 2) {
        showToast('Select at least 2 runs to compare', 'error');
        return;
      }

      const container = document.getElementById('historyCompareResult');
      container.innerHTML = '<div class="card rounded-md p-5"><span class="text-zinc-500 text-sm font-body">Loading comparison...</span></div>';
      container.classList.remove('hidden');

      try {
        const runs = await Promise.all(filenames.map(async fn => {
          const res = await apiFetch(`/api/history/${fn}`);
          return res.json();
        }));

        // Collect all unique models across runs
        const allModels = new Set();
        runs.forEach(run => {
          (run.results || []).forEach(r => {
            allModels.add(`${r.provider}||${r.model}`);
          });
        });
        const modelList = Array.from(allModels).sort();

        // Build comparison table
        const runLabels = runs.map(r => {
          const d = new Date(r.timestamp);
          return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        });

        let tableHtml = `
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">Cross-Run Comparison</span>
              <button onclick="document.getElementById('historyCompareResult').classList.add('hidden')" class="text-[11px] font-display tracking-wider uppercase text-zinc-600 hover:text-zinc-300 px-2 py-1">Close</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-xs results-table">
                <thead><tr style="border-bottom:1px solid var(--border-subtle)">
                  <th class="px-4 py-3 text-left section-label">Model</th>
                  ${runLabels.map(l => `<th class="px-4 py-3 text-right section-label">${l}</th>`).join('')}
                </tr></thead>
                <tbody>`;

        for (const modelKey of modelList) {
          const [provider, model] = modelKey.split('||');
          const color = getColor(provider);
          const values = runs.map(run => {
            const match = (run.results || []).find(r => r.provider === provider && r.model === model);
            if (!match) return null;
            return match.avg_tokens_per_second ?? match.tokens_per_second ?? 0;
          });

          // Find max value for highlighting
          const validValues = values.filter(v => v !== null && v > 0);
          const maxVal = validValues.length ? Math.max(...validValues) : 0;
          const minVal = validValues.length ? Math.min(...validValues) : 0;

          tableHtml += `<tr style="border-top:1px solid var(--border-subtle)">
            <td class="px-4 py-2.5">
              <span class="badge mr-2" style="background:${color.bg};color:${color.text};border:1px solid ${color.border};font-size:9px">${provider}</span>
              <span class="text-zinc-300 font-body text-[12px]">${model}</span>
            </td>`;

          for (const v of values) {
            if (v === null) {
              tableHtml += `<td class="px-4 py-2.5 text-right font-mono text-zinc-700">-</td>`;
            } else {
              let cellColor = 'text-zinc-400';
              if (validValues.length >= 2 && maxVal !== minVal) {
                if (v === maxVal) cellColor = 'text-green-400';
                else if (v === minVal) cellColor = 'text-red-400';
              }
              tableHtml += `<td class="px-4 py-2.5 text-right font-mono ${cellColor}">${v.toFixed ? v.toFixed(1) : v} tok/s</td>`;
            }
          }
          tableHtml += '</tr>';
        }

        tableHtml += '</tbody></table></div></div>';
        container.innerHTML = tableHtml;
      } catch (e) {
        container.innerHTML = `<div class="error-banner">${e.message || 'Failed to load comparison data'}</div>`;
      }
    }

    // --- Auth functions ---
    let authMode = 'login';

    function showAuthModal() {
      document.getElementById('authModal').style.display = 'flex';
      document.getElementById('authEmail').focus();
    }

    function hideAuthModal() {
      document.getElementById('authModal').style.display = 'none';
      document.getElementById('authError').style.display = 'none';
    }

    function switchAuthTab(mode) {
      authMode = mode;
      document.getElementById('authTabLogin').classList.toggle('tab-active', mode === 'login');
      document.getElementById('authTabRegister').classList.toggle('tab-active', mode === 'register');
      document.getElementById('authSubmitBtn').textContent = mode === 'login' ? 'Login' : 'Create Account';
      document.getElementById('authError').style.display = 'none';
    }

    async function handleAuth(e) {
      e.preventDefault();
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const endpoint = authMode === 'login' ? '/api/auth/login' : '/api/auth/register';

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (!res.ok) {
          document.getElementById('authError').textContent = data.error || 'Authentication failed';
          document.getElementById('authError').style.display = 'block';
          return;
        }
        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('auth_token', authToken);
        updateAuthUI();
        hideAuthModal();
        init();
      } catch (err) {
        document.getElementById('authError').textContent = 'Connection error';
        document.getElementById('authError').style.display = 'block';
      }
    }

    async function handleLogout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      authToken = null;
      currentUser = null;
      localStorage.removeItem('auth_token');
      updateAuthUI();
      showAuthModal();
    }

    function updateAuthUI() {
      const menu = document.getElementById('userMenu');
      if (currentUser) {
        menu.style.display = 'flex';
        document.getElementById('userEmail').textContent = currentUser.email;
      } else {
        menu.style.display = 'none';
      }
    }

    // -------------------------------------------------------------------
    // Boot: check auth state before loading app
    // -------------------------------------------------------------------
    (async () => {
      if (authToken) {
        try {
          const res = await apiFetch('/api/auth/me');
          if (res.ok) {
            const data = await res.json();
            currentUser = data.user;
            updateAuthUI();
            init();
            loadPromptTemplates();
            return;
          }
        } catch {}
      }
      const refreshed = await tryRefreshToken();
      if (refreshed) {
        init();
        loadPromptTemplates();
      } else {
        showAuthModal();
      }
    })();
  </script>
</body>
</html>
