<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Benchmark Studio - Measure LLM Speed &amp; Latency Across Providers</title>
  <meta name="description" content="Compare token throughput (tokens/sec) and latency (TTFT) across OpenAI, Anthropic, Google, and more. Real-time benchmarking with interactive dashboards.">
  <meta name="keywords" content="LLM benchmark, AI model comparison, token throughput, TTFT, latency, OpenAI, Anthropic, Claude, GPT, Gemini, LLM speed test">
  <meta name="theme-color" content="#BFFF00">
  <link rel="canonical" href="/">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="LLM Benchmark Studio - Measure LLM Speed &amp; Latency">
  <meta property="og:description" content="Compare token throughput and latency across OpenAI, Anthropic, Google, and more. Real-time benchmarking with interactive dashboards.">
  <meta property="og:url" content="/">
  <meta property="og:site_name" content="LLM Benchmark Studio">
  <meta property="og:image" content="/og-image.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="LLM Benchmark Studio - Measure LLM Speed &amp; Latency">
  <meta name="twitter:description" content="Compare token throughput and latency across OpenAI, Anthropic, Google, and more. Real-time benchmarking with interactive dashboards.">
  <meta name="twitter:image" content="/og-image.png">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "LLM Benchmark Studio",
    "applicationCategory": "DeveloperApplication",
    "operatingSystem": "Web",
    "description": "Measure token throughput (tokens/sec) and latency (TTFT) across multiple LLM providers simultaneously with real-time interactive dashboards.",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    }
  }
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Chakra Petch', 'sans-serif'],
            body: ['Outfit', 'sans-serif'],
            mono: ['Space Mono', 'monospace'],
          },
          colors: {
            zinc: { 500: '#85858F', 600: '#8B8B95', 700: '#63636B', 925: '#111113', 850: '#1c1c20' },
            lime: { accent: '#BFFF00' },
            coral: { accent: '#FF3B5C' },
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --lime: #BFFF00;
      --lime-dim: rgba(191,255,0,0.12);
      --lime-mid: rgba(191,255,0,0.3);
      --coral: #FF3B5C;
      --surface: #111113;
      --surface-raised: #1c1c20;
      --border: #27272A;
      --border-subtle: #1f1f23;
    }
    * { box-sizing: border-box; }
    body {
      background: #09090B;
      font-family: 'Outfit', sans-serif;
      color: #A1A1AA;
    }
    /* Dot grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 24px 24px;
      pointer-events: none;
      z-index: 0;
    }
    body > * { position: relative; z-index: 1; }
    body > header { z-index: 10; }

    /* Noise grain overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      opacity: 0.015;
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      transition: border-color 0.2s;
    }
    .card:hover { border-color: var(--border); }
    .card-accent {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-left: 3px solid var(--lime);
    }

    /* Model cards */
    .model-card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      transition: all 0.15s ease;
      cursor: pointer;
    }
    .model-card:hover { border-color: var(--border); background: var(--surface-raised); }
    .model-card.selected { border-color: var(--lime); background: var(--lime-dim); }
    .model-card .check-dot { width: 8px; height: 8px; border-radius: 50%; background: #63636B; transition: all 0.15s; }
    .model-card.selected .check-dot { background: var(--lime); box-shadow: 0 0 8px rgba(191,255,0,0.4); }

    /* Provider groups */
    .provider-group { border-left: 2px solid var(--border-subtle); padding-left: 0; margin-bottom: 8px; }
    .provider-group-header {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 12px; margin-bottom: 6px; cursor: pointer; user-select: none;
    }
    .provider-group-header:hover .provider-group-label { opacity: 1; }
    .provider-group-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .provider-group-label { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; opacity: 0.7; transition: opacity 0.15s; }
    .provider-group-count { font-size: 9px; font-family: 'Space Mono', monospace; color: #8B8B95; margin-left: auto; }

    /* Run button */
    .run-btn {
      background: var(--lime);
      color: #09090B;
      font-family: 'Chakra Petch', sans-serif;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: all 0.2s;
      box-shadow: 0 0 30px rgba(191,255,0,0.15);
    }
    .run-btn:hover { box-shadow: 0 0 50px rgba(191,255,0,0.3); transform: translateY(-1px); }
    .run-btn:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; transform: none; }
    .run-btn:active { transform: translateY(0); }

    /* Progress bar */
    .progress-track { background: #1c1c20; height: 6px; }
    .progress-fill {
      height: 100%;
      background: var(--lime);
      box-shadow: 0 0 12px rgba(191,255,0,0.3);
      transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      background-image: repeating-linear-gradient(
        -45deg,
        transparent,
        transparent 6px,
        rgba(0,0,0,0.15) 6px,
        rgba(0,0,0,0.15) 12px
      );
      background-size: 17px 17px;
      animation: stripe-scroll 0.6s linear infinite;
    }
    @keyframes stripe-scroll { to { background-position: 17px 0; } }

    /* Per-provider progress row */
    .provider-progress-row {
      display: grid;
      grid-template-columns: 140px 1fr 52px;
      align-items: center;
      gap: 12px;
    }
    .provider-progress-row .ppr-name {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .provider-progress-row .ppr-mid {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .provider-progress-row .ppr-status {
      font-family: 'Outfit', sans-serif;
      font-size: 11px;
      color: #85858F;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .provider-progress-row .ppr-track {
      background: #1c1c20;
      height: 4px;
      border-radius: 2px;
      overflow: hidden;
    }
    .provider-progress-row .ppr-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      background-image: repeating-linear-gradient(
        -45deg, transparent, transparent 4px,
        rgba(0,0,0,0.15) 4px, rgba(0,0,0,0.15) 8px
      );
      background-size: 11px 11px;
      animation: stripe-scroll 0.6s linear infinite;
    }
    .provider-progress-row .ppr-fill.done {
      animation: none;
      background-image: none;
    }
    .provider-progress-row .ppr-count {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: #8B8B95;
      text-align: right;
      white-space: nowrap;
    }

    /* Pulse dot */
    .pulse-dot {
      width: 6px; height: 6px; border-radius: 50%; background: var(--lime);
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { opacity: 0.4; box-shadow: none; } 50% { opacity: 1; box-shadow: 0 0 8px rgba(191,255,0,0.5); } }

    /* Stagger animations */
    .stagger { opacity: 0; transform: translateY(12px); animation: stagger-in 0.4s ease forwards; }
    .stagger:nth-child(1) { animation-delay: 0.05s; }
    .stagger:nth-child(2) { animation-delay: 0.1s; }
    .stagger:nth-child(3) { animation-delay: 0.15s; }
    .stagger:nth-child(4) { animation-delay: 0.2s; }
    .stagger:nth-child(5) { animation-delay: 0.25s; }
    .stagger:nth-child(6) { animation-delay: 0.3s; }
    @keyframes stagger-in { to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: stagger-in 0.3s ease forwards; }

    /* Tabs */
    .tab { padding: 8px 0; font-family: 'Chakra Petch', sans-serif; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; font-size: 12px; border-bottom: 2px solid transparent; transition: all 0.2s; color: #8B8B95; }
    .tab:hover { color: #A1A1AA; }
    .tab-active { color: var(--lime) !important; border-bottom-color: var(--lime) !important; }

    /* Settings sub-navigation tabs */
    .settings-tab {
      display: flex; align-items: center; gap: 6px;
      padding: 7px 14px; border-radius: 5px;
      font-family: 'Chakra Petch', sans-serif; font-weight: 500;
      font-size: 11px; letter-spacing: 0.05em; text-transform: uppercase;
      color: #63636B; background: transparent;
      transition: all 0.15s ease; cursor: pointer; border: none;
    }
    .settings-tab:hover { color: #A1A1AA; background: rgba(255,255,255,0.03); }
    .settings-tab-active {
      color: var(--lime) !important;
      background: rgba(191,255,0,0.06) !important;
    }
    .settings-panel:not(.hidden) { animation: stagger-in 0.15s ease forwards; }

    /* Sliders */
    input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
    input[type=range]::-webkit-slider-track { height: 3px; border-radius: 2px; background: #27272A; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 2px; background: var(--lime); margin-top: -5.5px; cursor: pointer; box-shadow: 0 0 6px rgba(191,255,0,0.3); }

    /* Textarea */
    .prompt-input {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-subtle);
      color: #E4E4E7;
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      resize: none;
      transition: border-color 0.2s;
    }
    .prompt-input:focus { outline: none; border-color: rgba(191,255,0,0.3); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #27272A; border-radius: 2px; }

    /* Stat cards */
    .stat-card { transition: all 0.2s; }
    .stat-card:hover { border-color: var(--border); transform: translateY(-1px); }

    /* Table */
    .results-table tr { border-bottom: 1px solid var(--border-subtle); transition: background 0.15s; }
    .results-table tr:hover { background: rgba(255,255,255,0.02); }
    .results-table .rank-1 { background: var(--lime-dim); }
    .results-table .rank-1:hover { background: rgba(191,255,0,0.08); }

    /* Provider badges */
    .badge { font-family: 'Chakra Petch', sans-serif; font-size: 10px; letter-spacing: 0.06em; text-transform: uppercase; font-weight: 500; padding: 2px 8px; border-radius: 2px; }

    /* Big number style */
    .big-num { font-family: 'Chakra Petch', sans-serif; font-weight: 700; line-height: 1; }

    /* Section label */
    .section-label { font-family: 'Chakra Petch', sans-serif; font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: #8B8B95; }

    /* Toast notifications */
    .toast-container { position: fixed; top: 16px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
    .toast { pointer-events: auto; padding: 10px 16px; border-radius: 4px; font-family: 'Outfit', sans-serif; font-size: 13px; color: #E4E4E7; background: var(--surface-raised); border: 1px solid var(--border); box-shadow: 0 4px 24px rgba(0,0,0,0.4); animation: toast-in 0.3s ease forwards; max-width: 400px; }
    .toast-error { border-color: rgba(255,59,92,0.4); background: rgba(255,59,92,0.08); color: #FCA5A5; }
    .toast-success { border-color: rgba(191,255,0,0.3); background: rgba(191,255,0,0.06); color: var(--lime); }
    .toast-out { animation: toast-out 0.3s ease forwards; }
    @keyframes toast-in { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toast-out { from { opacity: 1; } to { opacity: 0; transform: translateX(40px); } }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; z-index: 9998; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; animation: modal-fade-in 0.2s ease; }
    .modal-overlay.modal-closing { animation: modal-fade-out 0.2s ease forwards; }
    .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 24px; min-width: 340px; max-width: 480px; width: 100%; box-shadow: 0 8px 40px rgba(0,0,0,0.5); animation: modal-scale-in 0.2s ease; }
    .modal-closing .modal-box { animation: modal-scale-out 0.2s ease forwards; }
    .modal-title { font-family: 'Chakra Petch', sans-serif; font-weight: 600; font-size: 14px; letter-spacing: 0.04em; text-transform: uppercase; color: #E4E4E7; margin-bottom: 12px; }
    .modal-message { font-family: 'Outfit', sans-serif; font-size: 13px; color: #A1A1AA; margin-bottom: 16px; line-height: 1.5; }
    .modal-input { width: 100%; padding: 8px 12px; border-radius: 4px; background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle); color: #E4E4E7; font-family: 'Space Mono', monospace; font-size: 13px; outline: none; margin-bottom: 16px; transition: border-color 0.2s; }
    .modal-input:focus { border-color: rgba(191,255,0,0.3); }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 8px; }
    .modal-btn { padding: 6px 16px; border-radius: 4px; font-family: 'Chakra Petch', sans-serif; font-size: 12px; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; cursor: pointer; transition: all 0.15s; }
    .modal-btn-cancel { background: transparent; border: 1px solid var(--border-subtle); color: #85858F; }
    .modal-btn-cancel:hover { border-color: var(--border); color: #A1A1AA; }
    .modal-btn-confirm { background: var(--lime); border: 1px solid var(--lime); color: #09090B; }
    .modal-btn-confirm:hover { box-shadow: 0 0 12px rgba(191,255,0,0.3); }
    .modal-btn-danger { background: rgba(255,59,92,0.15); border: 1px solid rgba(255,59,92,0.3); color: #FF3B5C; }
    .modal-btn-danger:hover { background: rgba(255,59,92,0.25); }
    @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modal-fade-out { from { opacity: 1; } to { opacity: 0; } }
    @keyframes modal-scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes modal-scale-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }

    /* Error banner */
    .error-banner { background: rgba(255,59,92,0.08); border: 1px solid rgba(255,59,92,0.25); border-radius: 4px; padding: 12px 16px; font-family: 'Outfit', sans-serif; font-size: 13px; color: #FCA5A5; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .error-banner button { flex-shrink: 0; padding: 4px 12px; border-radius: 4px; font-family: 'Chakra Petch', sans-serif; font-size: 11px; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; background: rgba(255,59,92,0.15); border: 1px solid rgba(255,59,92,0.3); color: #FF3B5C; cursor: pointer; }

    /* Skipped line in progress */
    .skipped-line { font-family: 'Outfit', sans-serif; font-size: 12px; color: #8B8B95; padding: 2px 0; }

    /* ═══════════════════ Landing Page ═══════════════════ */
    #landingPage { display: none; }

    .landing-topbar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      padding: 16px 32px;
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(9,9,11,0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-subtle);
    }

    .landing-hero {
      padding: 160px 24px 80px;
      text-align: center;
      max-width: 720px;
      margin: 0 auto;
    }
    .landing-hero h1 {
      font-family: 'Chakra Petch', sans-serif;
      font-size: clamp(36px, 6vw, 56px);
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #E4E4E7;
      line-height: 1.1;
      margin: 0 0 12px;
    }
    .landing-hero h1 span { color: var(--lime); }
    .landing-hero .landing-tagline {
      font-family: 'Chakra Petch', sans-serif;
      font-size: clamp(14px, 2.5vw, 20px);
      font-weight: 500;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #8B8B95;
      margin-bottom: 28px;
    }
    .landing-hero .landing-description {
      font-family: 'Outfit', sans-serif;
      font-size: clamp(15px, 2vw, 18px);
      color: #85858F;
      line-height: 1.7;
      max-width: 560px;
      margin: 0 auto 40px;
    }
    .landing-cta-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .landing-btn-primary {
      background: var(--lime); color: #09090B;
      font-family: 'Chakra Petch', sans-serif; font-weight: 600;
      font-size: 14px; letter-spacing: 0.05em; text-transform: uppercase;
      padding: 12px 32px; border-radius: 4px; border: none; cursor: pointer;
      box-shadow: 0 0 30px rgba(191,255,0,0.15);
      transition: all 0.2s;
    }
    .landing-btn-primary:hover { box-shadow: 0 0 50px rgba(191,255,0,0.3); transform: translateY(-1px); }
    .landing-btn-secondary {
      background: transparent; color: #A1A1AA;
      font-family: 'Chakra Petch', sans-serif; font-weight: 500;
      font-size: 14px; letter-spacing: 0.05em; text-transform: uppercase;
      padding: 12px 32px; border-radius: 4px; cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    .landing-btn-secondary:hover { border-color: #8B8B95; color: #E4E4E7; }

    .landing-features {
      max-width: 960px; margin: 0 auto;
      padding: 0 24px 80px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .landing-feature-card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      padding: 28px 24px;
      transition: border-color 0.2s, transform 0.2s;
    }
    .landing-feature-card:hover { border-color: var(--border); transform: translateY(-2px); }
    .landing-feature-card .feature-icon {
      width: 36px; height: 36px; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 16px; font-size: 18px;
      background: var(--lime-dim);
      color: var(--lime);
    }
    .landing-feature-card h3 {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 14px; font-weight: 600;
      letter-spacing: 0.04em; text-transform: uppercase;
      color: #E4E4E7; margin: 0 0 8px;
    }
    .landing-feature-card p {
      font-family: 'Outfit', sans-serif;
      font-size: 13px; color: #85858F; line-height: 1.6; margin: 0;
    }

    .landing-how {
      max-width: 960px; margin: 0 auto;
      padding: 0 24px 80px;
      text-align: center;
    }
    .landing-how .section-title {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 11px; font-weight: 600;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: var(--lime); margin-bottom: 40px;
    }
    .landing-steps {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 32px;
    }
    .landing-step {
      text-align: center;
    }
    .landing-step .step-num {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 32px; font-weight: 700;
      color: var(--lime); opacity: 0.3;
      margin-bottom: 12px;
    }
    .landing-step h4 {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 13px; font-weight: 600;
      letter-spacing: 0.04em; text-transform: uppercase;
      color: #E4E4E7; margin: 0 0 8px;
    }
    .landing-step p {
      font-family: 'Outfit', sans-serif;
      font-size: 13px; color: #8B8B95; line-height: 1.5; margin: 0;
    }

    .landing-footer {
      text-align: center;
      padding: 40px 24px;
      border-top: 1px solid var(--border-subtle);
      max-width: 960px; margin: 0 auto;
    }
    .landing-footer p {
      font-family: 'Outfit', sans-serif;
      font-size: 13px; color: #63636B; margin: 0;
    }

    /* Landing page animations */
    @keyframes landing-fade-up {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .landing-animate {
      opacity: 0;
      animation: landing-fade-up 0.6s ease forwards;
    }
    .landing-animate-d1 { animation-delay: 0.1s; }
    .landing-animate-d2 { animation-delay: 0.2s; }
    .landing-animate-d3 { animation-delay: 0.3s; }
    .landing-animate-d4 { animation-delay: 0.4s; }
    .landing-animate-d5 { animation-delay: 0.5s; }
    .landing-animate-d6 { animation-delay: 0.6s; }
    .landing-animate-d7 { animation-delay: 0.7s; }
    .landing-animate-d8 { animation-delay: 0.8s; }
    .landing-animate-d9 { animation-delay: 0.9s; }
    .landing-animate-d10 { animation-delay: 1.0s; }

    /* Landing page transitions */
    #landingPage { transition: opacity 0.3s ease; }

    /* Responsive landing */
    @media (max-width: 768px) {
      .landing-features { grid-template-columns: 1fr; }
      .landing-steps { grid-template-columns: 1fr; gap: 24px; }
      .landing-topbar { padding: 12px 16px; }
      .landing-hero { padding: 120px 16px 60px; }
    }
    @media (min-width: 769px) and (max-width: 1024px) {
      .landing-features { grid-template-columns: repeat(2, 1fr); }
    }

    /* ═══════════════════ Notification Widget ═══════════════════ */
    .notif-bell {
      position: relative;
      background: none; border: none; cursor: pointer;
      padding: 4px;
      color: #63636B;
      transition: color 0.2s;
    }
    .notif-bell:hover { color: #E4E4E7; }
    .notif-bell svg { width: 20px; height: 20px; }
    .notif-badge {
      position: absolute; top: 0; right: 0;
      min-width: 8px; height: 8px;
      border-radius: 8px;
      background: var(--coral);
      color: #fff;
      font-family: 'Outfit', sans-serif;
      font-size: 10px; font-weight: 600;
      display: flex; align-items: center; justify-content: center;
      pointer-events: none;
      transform: translate(4px, -4px);
      border: 1.5px solid var(--bg);
      transition: background 0.2s;
    }
    /* Small dot when no active jobs */
    .notif-badge:empty { padding: 0; }
    /* Expand to numbered badge when jobs exist */
    .notif-badge:not(:empty) { min-width: 16px; height: 16px; padding: 0 4px; }
    /* WS status colors */
    .notif-badge.ws-connected { background: var(--lime); color: #111; }
    .notif-badge.ws-disconnected { background: var(--coral); color: #fff; }
    .notif-badge.ws-connecting { background: #EAB308; color: #111; animation: notif-ws-blink 1s infinite; }
    .notif-badge.pulse {
      animation: notif-pulse 0.6s ease;
    }
    @keyframes notif-pulse {
      0% { transform: translate(4px, -4px) scale(1); }
      50% { transform: translate(4px, -4px) scale(1.3); }
      100% { transform: translate(4px, -4px) scale(1); }
    }

    .notif-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      width: 380px;
      max-height: 480px;
      overflow-y: auto;
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      box-shadow: 0 8px 40px rgba(0,0,0,0.5);
      z-index: 200;
      display: none;
    }
    .notif-dropdown.open { display: block; animation: notif-dd-in 0.15s ease; }
    @keyframes notif-dd-in {
      from { opacity: 0; transform: translateY(-6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .notif-section-label {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 10px; font-weight: 600;
      letter-spacing: 0.12em; text-transform: uppercase;
      color: #63636B;
      padding: 12px 16px 6px;
    }
    .notif-empty {
      font-family: 'Outfit', sans-serif;
      font-size: 12px; color: #63636B;
      padding: 16px; text-align: center;
    }

    .notif-item {
      display: flex; align-items: flex-start; gap: 10px;
      padding: 10px 16px;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.15s;
    }
    .notif-item:hover { background: var(--surface-raised); }
    .notif-item:last-child { border-bottom: none; }

    .notif-icon {
      flex-shrink: 0;
      width: 28px; height: 28px;
      border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      font-size: 13px;
    }
    .notif-icon.benchmark { background: rgba(59,130,246,0.15); color: #3B82F6; }
    .notif-icon.tool_eval { background: rgba(168,85,247,0.15); color: #A855F7; }
    .notif-icon.judge { background: rgba(234,179,8,0.15); color: #EAB308; }
    .notif-icon.judge_compare { background: rgba(234,179,8,0.15); color: #EAB308; }
    .notif-icon.param_tune { background: rgba(34,197,94,0.15); color: #22C55E; }
    .notif-icon.prompt_tune { background: rgba(14,165,233,0.15); color: #0EA5E9; }
    .notif-icon.scheduled_benchmark { background: rgba(191,255,0,0.12); color: var(--lime); }

    .notif-body { flex: 1; min-width: 0; }
    .notif-title {
      font-family: 'Outfit', sans-serif;
      font-size: 12px; font-weight: 500;
      color: #E4E4E7;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .notif-detail {
      font-family: 'Outfit', sans-serif;
      font-size: 11px; color: #8B8B95;
      margin-top: 2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .notif-progress {
      margin-top: 4px;
      height: 3px;
      background: var(--border-subtle);
      border-radius: 2px;
      overflow: hidden;
    }
    .notif-progress-bar {
      height: 100%;
      border-radius: 2px;
      background: var(--lime);
      transition: width 0.3s ease;
    }
    .notif-meta {
      font-family: 'Outfit', sans-serif;
      font-size: 10px; color: #63636B;
      margin-top: 3px;
      display: flex; align-items: center; gap: 6px;
    }

    .notif-cancel {
      flex-shrink: 0;
      align-self: center;
      background: none; border: none; cursor: pointer;
      color: #63636B;
      padding: 4px;
      border-radius: 3px;
      transition: color 0.15s, background 0.15s;
    }
    .notif-cancel:hover { color: var(--coral); background: rgba(255,59,92,0.1); }
    .notif-cancel svg { width: 14px; height: 14px; }

    .notif-status-badge {
      display: inline-block;
      font-family: 'Outfit', sans-serif;
      font-size: 10px; font-weight: 500;
      padding: 1px 6px;
      border-radius: 3px;
      text-transform: uppercase;
      letter-spacing: 0.04em;
    }
    .notif-status-badge.done { background: rgba(191,255,0,0.12); color: var(--lime); }
    .notif-status-badge.failed { background: rgba(255,59,92,0.1); color: var(--coral); }
    .notif-status-badge.cancelled { background: rgba(139,139,149,0.15); color: #8B8B95; }
    .notif-status-badge.interrupted { background: rgba(234,179,8,0.15); color: #EAB308; }

    @keyframes notif-ws-blink {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.3; }
    }

    @media (max-width: 768px) {
      .notif-dropdown { width: calc(100vw - 32px); right: -8px; }
    }

    /* --- Sub-Tab Navigation --- */
    .te-subtab {
      display: inline-flex;
      align-items: center;
      padding: 6px 16px;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: var(--text-muted, #71717A);
      border-bottom: 2px solid transparent;
      cursor: pointer;
      transition: color 0.15s, border-color 0.15s;
      white-space: nowrap;
      background: none;
      border-top: none;
      border-left: none;
      border-right: none;
      font-family: 'Chakra Petch', sans-serif;
    }
    .te-subtab:hover {
      color: var(--text-secondary, #A1A1AA);
    }
    .te-subtab-active {
      color: var(--lime, #BFFF00);
      border-bottom-color: var(--lime, #BFFF00);
    }

    /* --- Context Bar --- */
    .te-context-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 8px 16px;
      font-size: 11px;
      color: var(--text-muted, #71717A);
      border-bottom: 1px solid var(--border-subtle, rgba(255,255,255,0.06));
      min-height: 36px;
    }
    .te-context-bar .ctx-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 3px;
      font-size: 10px;
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
    }
    .te-context-bar .ctx-pill.active {
      background: rgba(191,255,0,0.08);
      border-color: rgba(191,255,0,0.2);
      color: var(--lime, #BFFF00);
    }

    /* --- Timeline --- */
    .tl-entry {
      position: relative;
      padding: 12px 16px 12px 32px;
      border-left: 2px solid rgba(255,255,255,0.08);
      margin-left: 8px;
    }
    .tl-entry::before {
      content: '';
      position: absolute;
      left: -5px;
      top: 16px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      border: 2px solid var(--entry-color, rgba(255,255,255,0.2));
      background: var(--bg-primary, #09090B);
    }
    .tl-entry[data-type="eval"]    { --entry-color: var(--lime, #BFFF00); }
    .tl-entry[data-type="param_tune"]  { --entry-color: #38BDF8; }
    .tl-entry[data-type="prompt_tune"] { --entry-color: #A855F7; }
    .tl-entry[data-type="judge"]  { --entry-color: #F59E0B; }
    .tl-entry.baseline { border-left-color: var(--lime, #BFFF00); }
    .tl-entry.baseline::before { background: var(--lime, #BFFF00); }
  </style>
</head>
<body class="min-h-screen">

  <!-- Toast container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="modal-overlay" style="display:none; z-index:10000;">
    <div class="modal-box" style="max-width:380px;">
      <div class="flex gap-4 mb-5">
        <button id="authTabLogin" onclick="switchAuthTab('login')" class="tab tab-active text-xs">Login</button>
        <button id="authTabRegister" onclick="switchAuthTab('register')" class="tab text-xs">Register</button>
      </div>
      <div id="authError" class="error-banner mb-4" style="display:none;"></div>
      <form id="authForm" onsubmit="handleAuth(event)">
        <label class="section-label block mb-1">Email</label>
        <input type="email" id="authEmail" class="modal-input mb-3" required placeholder="you@example.com" autocomplete="email">
        <label class="section-label block mb-1">Password</label>
        <input type="password" id="authPassword" class="modal-input mb-4" required minlength="8" placeholder="Min 8 characters" autocomplete="current-password">
        <button type="submit" id="authSubmitBtn" class="modal-btn modal-btn-confirm w-full text-center">Login</button>
      </form>
    </div>
  </div>

  <!-- ═══════════════════════════ LANDING PAGE ═══════════════════════════ -->
  <div id="landingPage">
    <!-- Top bar -->
    <div class="landing-topbar">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-sm flex items-center justify-center font-display font-bold text-sm" style="background: var(--lime); color: #09090B;">
          B<span style="font-size:10px; opacity:0.6;">s</span>
        </div>
        <div class="font-display font-bold text-sm text-zinc-100 tracking-wide">
          BENCHMARK <span style="color: var(--lime)">STUDIO</span>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="switchAuthTab('login'); showAuthModal();" class="landing-btn-secondary" style="padding: 8px 20px; font-size: 12px;">Login</button>
        <button onclick="switchAuthTab('register'); showAuthModal();" class="landing-btn-primary" style="padding: 8px 20px; font-size: 12px; box-shadow: none;">Sign Up</button>
      </div>
    </div>

    <!-- Hero -->
    <div class="landing-hero">
      <h1 class="landing-animate">BENCHMARK <span>STUDIO</span></h1>
      <div class="landing-tagline landing-animate landing-animate-d1">Measure &middot; Compare &middot; Optimize</div>
      <p class="landing-description landing-animate landing-animate-d2">
        The all-in-one platform for benchmarking LLM providers.
        Compare throughput, latency, and cost across models in real-time.
      </p>
      <div class="landing-cta-group landing-animate landing-animate-d3">
        <button onclick="switchAuthTab('register'); showAuthModal();" class="landing-btn-primary">Get Started Free</button>
        <button onclick="switchAuthTab('login'); showAuthModal();" class="landing-btn-secondary">Login</button>
      </div>
    </div>

    <!-- Features grid -->
    <div class="landing-features">
      <div class="landing-feature-card landing-animate landing-animate-d4">
        <div class="feature-icon">&#9889;</div>
        <h3>Real-Time Benchmarks</h3>
        <p>Stream token-by-token metrics across multiple providers simultaneously. Measure TTFT and throughput live.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d5">
        <div class="feature-icon">&#9881;</div>
        <h3>Tool Calling Eval</h3>
        <p>Test and score function calling accuracy with custom MCP tool suites. Grade responses automatically.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d6">
        <div class="feature-icon">&#9776;</div>
        <h3>Analytics Dashboard</h3>
        <p>Leaderboards, trend analysis, and run comparisons over time. Find the best model for your workload.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d7">
        <div class="feature-icon">&#8635;</div>
        <h3>Scheduled Runs</h3>
        <p>Set up recurring benchmarks to track performance changes. Get notified when metrics shift.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d8">
        <div class="feature-icon">&#9729;</div>
        <h3>Multi-Provider</h3>
        <p>OpenAI, Anthropic, Google Gemini, and custom endpoints. Compare any provider side-by-side.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d9">
        <div class="feature-icon">&#8681;</div>
        <h3>Export Everything</h3>
        <p>CSV exports, JSON eval data, and settings backup/restore. Full data portability.</p>
      </div>
    </div>

    <!-- How it works -->
    <div class="landing-how">
      <div class="section-title landing-animate landing-animate-d7">How It Works</div>
      <div class="landing-steps">
        <div class="landing-step landing-animate landing-animate-d8">
          <div class="step-num">01</div>
          <h4>Add Your API Keys</h4>
          <p>Configure providers and models through the settings panel</p>
        </div>
        <div class="landing-step landing-animate landing-animate-d9">
          <div class="step-num">02</div>
          <h4>Run Benchmarks</h4>
          <p>Stream results in real-time with live progress tracking</p>
        </div>
        <div class="landing-step landing-animate landing-animate-d10">
          <div class="step-num">03</div>
          <h4>Analyze &amp; Compare</h4>
          <p>Leaderboard, trends, and side-by-side model comparisons</p>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="landing-footer">
      <p>Built for LLM engineers</p>
      <p id="landing-version" style="margin-top:8px; font-size:11px; color:#27272a;"></p>
    </div>
  </div>

  <!-- ═══════════════════════════ HEADER ═══════════════════════════ -->
  <header id="appHeader" class="border-b px-6 py-4" style="border-color: var(--border-subtle); display: none;">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <!-- Logo mark -->
        <div class="w-9 h-9 rounded-sm flex items-center justify-center font-display font-bold text-sm" style="background: var(--lime); color: #09090B;">
          B<span style="font-size:10px; opacity:0.6;">s</span>
        </div>
        <div>
          <h1 class="font-display font-bold text-base text-zinc-100 tracking-wide">
            BENCHMARK <span style="color: var(--lime)">STUDIO</span>
          </h1>
          <p class="text-[10px] tracking-[0.2em] uppercase text-zinc-600 mt-0.5">Measure &middot; Compare &middot; Optimize</p>
        </div>
      </div>
      <div class="flex items-center gap-6">
        <button onclick="showTab('benchmark')" id="tab-benchmark" class="tab tab-active">Benchmark</button>
        <button onclick="showTab('tool-eval')" id="tab-tool-eval" class="tab">Tool Eval</button>
        <button onclick="showTab('history')" id="tab-history" class="tab">History</button>
        <button onclick="showTab('analytics')" id="tab-analytics" class="tab">Analytics</button>
        <button onclick="showTab('schedules')" id="tab-schedules" class="tab">Schedules</button>
        <button onclick="showTab('settings')" id="tab-settings" class="tab">Settings</button>
        <button onclick="showTab('admin')" id="tab-admin" class="tab" style="display:none;">Admin</button>

        <!-- Notification Widget -->
        <div id="notifWidget" class="relative ml-2" style="display:none;">
          <button class="notif-bell" onclick="toggleNotifDropdown()" aria-label="Notifications" title="Running processes">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 0 0 5.454-1.31A8.967 8.967 0 0 1 18 9.75V9A6 6 0 0 0 6 9v.75a8.967 8.967 0 0 1-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 0 1-5.714 0m5.714 0a3 3 0 1 1-5.714 0"/></svg>
            <span id="notifBadge" class="notif-badge ws-disconnected" data-count="0"></span>
          </button>
          <div id="notifDropdown" class="notif-dropdown" role="region" aria-label="Process notifications">
            <div id="notifActiveLabel" class="notif-section-label">Running</div>
            <div id="notifActiveList"></div>
            <div style="border-top:1px solid var(--border-subtle);"></div>
            <div class="notif-section-label">Recent</div>
            <div id="notifRecentList"></div>
          </div>
        </div>

        <div id="userMenu" class="flex items-center gap-3 ml-4 pl-4" style="border-left:1px solid var(--border-subtle); display:none;">
          <span id="userEmail" class="text-[11px] text-zinc-500 font-mono"></span>
          <button onclick="handleLogout()" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-zinc-300 px-2 py-1 rounded" style="border:1px solid var(--border-subtle)">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ═══════════════════════════ MAIN ═══════════════════════════ -->
  <main id="appMain" class="max-w-7xl mx-auto px-6 py-8" style="display: none;">

    <!-- Init error banner -->
    <div id="initErrorBanner" class="hidden error-banner mb-6">
      <span>Failed to connect to server. Check that the backend is running.</span>
    </div>

    <!-- ─── BENCHMARK TAB ─── -->
    <div id="view-benchmark">

      <!-- CONFIG ROW -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <!-- Prompt -->
        <div class="lg:col-span-2 card rounded-md p-5 stagger">
          <div class="flex items-center justify-between mb-3">
            <label class="section-label">Benchmark Prompt</label>
            <select id="promptTemplateSelect" onchange="applyPromptTemplate(this.value)" class="text-xs font-mono px-3 py-1.5 rounded-sm cursor-pointer" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;max-width:220px;">
              <option value="">Custom</option>
            </select>
          </div>
          <textarea id="prompt" rows="3" class="prompt-input w-full rounded-sm px-4 py-3" placeholder="Enter your benchmark prompt..."></textarea>
        </div>

        <!-- Params -->
        <div class="card rounded-md p-5 stagger">
          <label class="section-label mb-4 block">Parameters</label>
          <div class="space-y-5">
            <div>
              <div class="flex justify-between text-xs mb-2">
                <span class="text-zinc-500 font-body">Max Tokens</span>
                <span id="maxTokensVal" class="font-mono text-zinc-300">512</span>
              </div>
              <input type="range" id="maxTokens" min="64" max="4096" step="64" value="512" oninput="document.getElementById('maxTokensVal').textContent=this.value">
            </div>
            <div>
              <div class="flex justify-between text-xs mb-2">
                <span class="text-zinc-500 font-body">Temperature</span>
                <span id="tempVal" class="font-mono text-zinc-300">0.7</span>
              </div>
              <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempVal').textContent=parseFloat(this.value).toFixed(1)">
            </div>
            <div>
              <div class="flex justify-between text-xs mb-2">
                <span class="text-zinc-500 font-body">Runs per model</span>
                <span id="runsVal" class="font-mono text-zinc-300">1</span>
              </div>
              <input type="range" id="runs" min="1" max="10" step="1" value="1" oninput="document.getElementById('runsVal').textContent=this.value">
            </div>
            <div class="flex items-center justify-between mt-4">
              <span class="text-zinc-500 font-body text-xs">Warm-up run</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="warmupToggle" checked class="sr-only peer">
                <div class="w-8 h-4 rounded-full peer bg-zinc-700 peer-checked:bg-lime-accent/40 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-4 peer-checked:after:bg-[var(--lime)]"></div>
              </label>
            </div>
          </div>
          <div class="mt-5 pt-5" style="border-top: 1px solid var(--border-subtle)">
            <div class="flex justify-between text-xs mb-3">
              <span class="text-zinc-500 font-body">Context Tiers</span>
              <span id="tierBadge" class="hidden text-[10px] font-display font-semibold tracking-wider uppercase px-2 py-0.5 rounded-sm" style="background:rgba(255,59,92,0.15);color:var(--coral);">STRESS TEST</span>
            </div>
            <div id="tierChips" class="flex flex-wrap gap-2">
              <!-- JS populates -->
            </div>
            <div id="tierWarnings" class="mt-2 space-y-1"></div>
          </div>
        </div>
      </div>

      <!-- MODEL SELECTION -->
      <div class="card rounded-md p-5 mb-6 stagger">
        <div class="flex items-center justify-between mb-4">
          <label class="section-label">Select Models</label>
          <div class="flex gap-2">
            <button id="healthCheckBtn" onclick="checkProviderHealth()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: #38BDF8; border: 1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Check Health</button>
            <button onclick="selectAll()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: var(--lime); border: 1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">All</button>
            <button onclick="selectNone()" class="text-[11px] font-display font-medium tracking-wider uppercase text-zinc-600 px-3 py-1 rounded-sm border transition-colors" style="border-color: var(--border-subtle)" onmouseover="this.style.borderColor='var(--border)'" onmouseout="this.style.borderColor='var(--border-subtle)'">Clear</button>
          </div>
        </div>
        <div id="modelGrid" class="flex flex-col gap-1">
          <!-- JS populates -->
        </div>
      </div>

      <!-- RUN BUTTON -->
      <div class="flex justify-center mb-10 stagger">
        <button id="runBtn" onclick="startBenchmark()" class="run-btn px-12 py-3 rounded-sm text-sm flex items-center gap-3">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          Run Benchmark
        </button>
      </div>

      <!-- PROGRESS -->
      <div id="progressSection" class="hidden mb-8 fade-in">
        <div class="card rounded-md p-5">
          <!-- Header: pulse dot, overall counter, cancel button -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="pulse-dot"></div>
              <span id="progressLabel" class="text-sm text-zinc-400 font-body">Initializing...</span>
            </div>
            <div class="flex items-center gap-4">
              <span id="progressCount" class="text-xs font-mono text-zinc-600">0/0</span>
              <button id="cancelBtn" onclick="cancelBenchmark()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:var(--coral);border:1px solid rgba(255,59,92,0.3);" onmouseover="this.style.borderColor='rgba(255,59,92,0.6)'" onmouseout="this.style.borderColor='rgba(255,59,92,0.3)'">Cancel</button>
            </div>
          </div>
          <!-- Per-provider progress rows -->
          <div id="providerProgressPanel" class="flex flex-col gap-3"></div>
          <div id="progressSkipped" class="mt-3"></div>
        </div>
        <!-- Error banner for SSE issues -->
        <div id="sseBanner" class="hidden error-banner mt-3" style="flex-direction:column;align-items:flex-start;gap:8px;">
          <div id="sseBannerMsg" class="font-mono text-xs" style="word-break:break-word;width:100%;cursor:pointer;" onclick="navigator.clipboard.writeText(this.textContent).then(()=>showToast('Error copied','success'))" title="Click to copy error">Connection lost</div>
          <button onclick="retryBenchmark()">Retry</button>
        </div>
      </div>

      <!-- RESULTS -->
      <div id="resultsSection" class="hidden fade-in">
        <!-- Stat Cards -->
        <div id="statCards" class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6"></div>

        <!-- Chart -->
        <div class="card rounded-md p-5 mb-4">
          <label class="section-label mb-4 block">Throughput Comparison</label>
          <div class="relative" style="height: 300px;">
            <canvas id="toksChart"></canvas>
          </div>
        </div>

        <!-- TTFT Chart -->
        <div id="ttftChartSection" class="hidden card rounded-md p-5 mb-4">
          <label id="ttftChartLabel" class="section-label mb-4 block">Latency (TTFT)</label>
          <div class="relative" style="height: 300px;">
            <canvas id="ttftChart"></canvas>
          </div>
        </div>

        <!-- Scatter: Speed vs Latency -->
        <div id="scatterChartSection" class="hidden card rounded-md p-5 mb-4">
          <label class="section-label mb-4 block">Speed vs Latency</label>
          <div class="relative" style="height: 300px;">
            <canvas id="scatterChart"></canvas>
          </div>
        </div>

        <!-- Table + CSV Export -->
        <div class="card rounded-md overflow-hidden mb-6">
          <div class="flex items-center justify-between px-5 py-3" style="border-bottom:1px solid var(--border-subtle)">
            <span class="section-label">Results</span>
            <button onclick="exportCSV()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Export CSV</button>
          </div>
          <table class="w-full text-sm results-table">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-left section-label">Pos</th>
                <th class="px-5 py-3 text-left section-label">Provider</th>
                <th class="px-5 py-3 text-left section-label">Model</th>
                <th class="px-5 py-3 text-right section-label">Tok/s</th>
                <th class="px-5 py-3 text-right section-label" data-col="stddev" style="display:none">Std Dev</th>
                <th class="px-5 py-3 text-right section-label">TTFT</th>
                <th class="px-5 py-3 text-right section-label">Input Tok/s</th>
                <th class="px-5 py-3 text-right section-label">Duration</th>
                <th class="px-5 py-3 text-right section-label">Tokens</th>
                <th class="px-5 py-3 text-center section-label">Status</th>
                <th class="px-5 py-3 text-right section-label">Cost</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ─── HISTORY TAB ─── -->
    <div id="view-history" class="hidden">
      <div class="flex items-center justify-between mb-4">
        <div></div>
        <button onclick="downloadCSV('/api/export/history?format=csv', 'benchmark-history.csv')" style="border: 1px solid #555; background: transparent; color: var(--lime); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: 'Outfit', sans-serif;">Export CSV</button>
      </div>
      <div id="historyCompareBar" class="hidden mb-4 flex items-center justify-between card rounded-md px-5 py-3" style="border-color:rgba(56,189,248,0.3)">
        <span class="text-xs font-body text-zinc-400"><span id="compareCount">0</span> runs selected</span>
        <button onclick="compareSelectedRuns()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.3);">Compare Selected</button>
      </div>
      <div id="historyCompareResult" class="hidden mb-6"></div>
      <div id="historyContainer" class="space-y-4">
        <p class="text-zinc-600 text-sm font-body">Loading history...</p>
      </div>
    </div>

    <!-- ─── SETTINGS TAB ─── -->
    <div id="view-settings" class="hidden">
      <!-- Settings Header + Sub-Navigation -->
      <div class="mb-6">
        <div class="flex items-center justify-between mb-4">
          <div>
            <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Configuration</h2>
            <p class="text-sm text-zinc-600 font-body">Manage API keys, providers, models, and feature defaults.</p>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="exportSettings()" class="text-[10px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.15);opacity:0.7" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">Export</button>
            <button onclick="importSettings()" class="text-[10px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.15);opacity:0.7" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.7'">Import</button>
          </div>
        </div>
        <!-- Sub-nav tabs -->
        <div class="flex gap-1 p-1 rounded-md" style="background:var(--surface);">
          <button onclick="showSettingsTab('keys')" id="stab-keys" class="settings-tab settings-tab-active">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 5.25a3 3 0 013 3m3 0a6 6 0 01-7.029 5.912c-.563-.097-1.159.026-1.563.43L10.5 17.25H8.25v2.25H6v2.25H2.25v-2.818c0-.597.237-1.17.659-1.591l6.499-6.499c.404-.404.527-1 .43-1.563A6 6 0 1121.75 8.25z"/></svg>
            API Keys
          </button>
          <button onclick="showSettingsTab('providers')" id="stab-providers" class="settings-tab">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5.25 14.25h13.5m-13.5 0a3 3 0 01-3-3m3 3a3 3 0 100 6h13.5a3 3 0 100-6m-16.5-3a3 3 0 013-3h13.5a3 3 0 013 3m-19.5 0a4.5 4.5 0 01.9-2.7L5.737 5.1a3.375 3.375 0 012.7-1.35h7.126c1.062 0 2.062.5 2.7 1.35l2.587 3.45a4.5 4.5 0 01.9 2.7"/></svg>
            Providers &amp; Models
          </button>
          <button onclick="showSettingsTab('judge')" id="stab-judge" class="settings-tab">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
            LLM Judge
          </button>
          <button onclick="showSettingsTab('tuning')" id="stab-tuning" class="settings-tab">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"/></svg>
            Tuning
          </button>
        </div>
      </div>

      <!-- ── Sub-view: API Keys ── -->
      <div id="settings-keys" class="settings-panel">
        <div id="apiKeysContainer" class="mb-6"></div>
      </div>

      <!-- ── Sub-view: Providers & Models ── -->
      <div id="settings-providers" class="settings-panel hidden">
        <div id="settingsContainer" class="space-y-6 mb-6">
          <p class="text-zinc-600 text-sm font-body">Loading configuration...</p>
        </div>
      </div>

      <!-- ── Sub-view: LLM Judge ── -->
      <div id="settings-judge" class="settings-panel hidden">
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center gap-3 mb-4">
            <svg class="w-5 h-5 text-amber-500" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
            <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">LLM Judge Configuration</h3>
          </div>
          <p class="text-[11px] text-zinc-600 font-body mb-5">Configure default LLM Judge behavior for Tool Eval runs. These defaults can be overridden per-run in the Tool Eval tab.</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Default Judge Model</label>
              <select id="p10JudgeModel" onchange="p10Save()" class="w-full text-xs font-mono px-3 py-2 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;"></select>
            </div>
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Default Mode</label>
              <select id="p10JudgeMode" onchange="p10Save()" class="w-full text-xs font-mono px-3 py-2 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
                <option value="post_eval">Post-Eval Report</option>
                <option value="live_inline">Live Inline</option>
              </select>
            </div>
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Judge Temperature</label>
              <input id="p10JudgeTemp" type="number" min="0" max="2" step="0.1" value="0.0" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Judge Max Tokens</label>
              <input id="p10JudgeMaxTokens" type="number" min="256" max="32768" step="256" value="4096" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Judge Concurrency</label>
              <input id="p10JudgeConcurrency" type="number" min="1" max="16" step="1" value="4" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
              <p class="text-[9px] text-zinc-700 font-body mt-1">Parallel judge calls. Auto-capped to 1 for local models.</p>
            </div>
          </div>
          <!-- Custom Instructions -->
          <div class="mt-5 pt-4" style="border-top:1px solid var(--border-subtle)">
            <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Custom Instructions</label>
            <p class="text-[10px] text-zinc-700 font-body mb-2">Additional evaluation criteria injected into the judge prompt. Use this to guide what the judge should focus on.</p>
            <textarea id="p10JudgeInstructions" onchange="p10Save()" rows="4" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;resize:vertical;" placeholder="e.g. Pay special attention to date/time parameter formatting. Penalize missing timezone info. Be strict about parameter types."></textarea>
          </div>
          <div class="flex items-center gap-3 mt-4 pt-3" style="border-top:1px solid var(--border-subtle)">
            <label class="relative inline-flex items-center cursor-pointer">
              <input id="p10JudgeEnabled" type="checkbox" class="sr-only peer" onchange="p10Save()">
              <div class="w-8 h-4 rounded-full transition-colors peer-checked:bg-amber-500" style="background:var(--border-subtle);"></div>
              <div class="absolute left-0.5 top-0.5 w-3 h-3 rounded-full transition-transform peer-checked:translate-x-4 peer-checked:bg-white" style="background:#52525B;"></div>
            </label>
            <span class="text-[10px] font-display tracking-wider uppercase text-zinc-500">Enable judge by default on new eval runs</span>
          </div>
        </div>
      </div>

      <!-- ── Sub-view: Tuning (Parameter Tuner + Prompt Tuner) ── -->
      <div id="settings-tuning" class="settings-panel hidden">
        <!-- Provider Parameter Support Configuration -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <svg class="w-5 h-5" style="color:#38BDF8" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75"/></svg>
              <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Provider Parameter Support</h3>
            </div>
            <button onclick="psResetToDefaults()" class="text-[10px] font-display font-medium tracking-wider uppercase px-2.5 py-1 rounded-sm text-zinc-500 hover:text-zinc-300 transition-colors" style="border:1px solid var(--border-subtle);">Reset to Defaults</button>
          </div>
          <p class="text-[11px] text-zinc-600 font-body mb-5">Configure which parameters each provider supports. The param tuner uses these settings to build per-model search spaces.</p>
          <div id="psNotSeeded" class="hidden text-center py-6">
            <p class="text-sm text-zinc-500 font-body mb-3">Parameter support config not initialized yet.</p>
            <button onclick="psSeedAndLoad()" class="text-xs font-display font-medium tracking-wider uppercase px-4 py-2 rounded-sm transition-colors" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);">Initialize from Provider Registry</button>
          </div>
          <div id="psConfigured" class="hidden">
            <div class="flex items-center gap-3 mb-4">
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500">Provider</label>
              <select id="psProviderSelect" onchange="psRenderProvider()" class="text-xs font-mono px-3 py-2 rounded-sm flex-1" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;max-width:280px;">
              </select>
            </div>
            <!-- Param table for selected provider -->
            <div id="psParamTable" class="mb-4"></div>
            <button onclick="psAddParam()" class="text-xs text-zinc-400 hover:text-lime-400 transition-colors font-body flex items-center gap-1 mb-5">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
              Add Parameter
            </button>
            <!-- Model Overrides (collapsible) -->
            <details class="group" style="border-top:1px solid var(--border-subtle);">
              <summary class="pt-4 pb-2 cursor-pointer text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors">Model Overrides</summary>
              <div id="psOverridesTable" class="mt-2 mb-3"></div>
              <button onclick="psAddOverride()" class="text-xs text-zinc-400 hover:text-lime-400 transition-colors font-body flex items-center gap-1 mb-2">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                Add Override
              </button>
            </details>
          </div>
        </div>

        <!-- Parameter Tuner -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center gap-3 mb-4">
            <svg class="w-5 h-5" style="color:var(--lime)" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 3v11.25A2.25 2.25 0 006 16.5h2.25M3.75 3h-1.5m1.5 0h16.5m0 0h1.5m-1.5 0v11.25A2.25 2.25 0 0118 16.5h-2.25m-7.5 0h7.5m-7.5 0l-1 3m8.5-3l1 3m0 0l.5 1.5m-.5-1.5h-9.5m0 0l-.5 1.5"/></svg>
            <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Parameter Tuner</h3>
          </div>
          <p class="text-[11px] text-zinc-600 font-body mb-5">Default search space ranges for the parameter tuner. Controls how many parameter combinations are generated.</p>
          <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-5">
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Max Combinations</label>
              <input id="p10PtMaxCombos" type="number" min="5" max="500" step="5" value="50" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
          </div>
          <div class="text-[10px] font-display tracking-wider uppercase text-zinc-500 mb-2">Temperature Search Range</div>
          <div class="grid grid-cols-3 gap-4 mb-5">
            <div>
              <label class="text-[10px] text-zinc-600 font-body block mb-1">Min</label>
              <input id="p10PtTempMin" type="number" min="0" max="2" step="0.1" value="0.0" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-body block mb-1">Max</label>
              <input id="p10PtTempMax" type="number" min="0" max="2" step="0.1" value="1.0" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-body block mb-1">Step</label>
              <input id="p10PtTempStep" type="number" min="0.05" max="1" step="0.05" value="0.5" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
          </div>
          <div class="text-[10px] font-display tracking-wider uppercase text-zinc-500 mb-2">Top-P Search Range</div>
          <div class="grid grid-cols-3 gap-4">
            <div>
              <label class="text-[10px] text-zinc-600 font-body block mb-1">Min</label>
              <input id="p10PtTopPMin" type="number" min="0" max="1" step="0.05" value="0.5" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-body block mb-1">Max</label>
              <input id="p10PtTopPMax" type="number" min="0" max="1" step="0.05" value="1.0" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-body block mb-1">Step</label>
              <input id="p10PtTopPStep" type="number" min="0.05" max="0.5" step="0.05" value="0.25" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
          </div>
        </div>

        <!-- Prompt Tuner -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center gap-3 mb-4">
            <svg class="w-5 h-5 text-violet-400" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09zM18.259 8.715L18 9.75l-.259-1.035a3.375 3.375 0 00-2.455-2.456L14.25 6l1.036-.259a3.375 3.375 0 002.455-2.456L18 2.25l.259 1.035a3.375 3.375 0 002.455 2.456L21.75 6l-1.036.259a3.375 3.375 0 00-2.455 2.456zM16.894 20.567L16.5 21.75l-.394-1.183a2.25 2.25 0 00-1.423-1.423L13.5 18.75l1.183-.394a2.25 2.25 0 001.423-1.423l.394-1.183.394 1.183a2.25 2.25 0 001.423 1.423l1.183.394-1.183.394a2.25 2.25 0 00-1.423 1.423z"/></svg>
            <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Prompt Tuner</h3>
          </div>
          <p class="text-[11px] text-zinc-600 font-body mb-5">Default settings for prompt tuning runs. Controls generation strategy and safety limits.</p>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Default Mode</label>
              <select id="p10PrtMode" onchange="p10Save()" class="w-full text-xs font-mono px-3 py-2 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
                <option value="quick">Quick (single pass)</option>
                <option value="evolutionary">Evolutionary (multi-generation)</option>
              </select>
            </div>
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Max API Calls</label>
              <input id="p10PrtMaxCalls" type="number" min="10" max="1000" step="10" value="100" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Generations</label>
              <input id="p10PrtGenerations" type="number" min="1" max="20" step="1" value="3" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
              <span class="text-[9px] text-zinc-700 font-body mt-1 block">For evolutionary mode only</span>
            </div>
            <div>
              <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Population Size</label>
              <input id="p10PrtPopulation" type="number" min="2" max="20" step="1" value="5" onchange="p10Save()" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
              <span class="text-[9px] text-zinc-700 font-body mt-1 block">For evolutionary mode only</span>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ─── ADMIN TAB ─── -->
    <div id="view-admin" class="hidden">
      <div class="mb-6">
        <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Admin Dashboard</h2>
        <p class="text-sm text-zinc-600 font-body">User management, system stats, and audit log.</p>
      </div>

      <!-- Stats Cards -->
      <div id="adminStatsCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

      <!-- System Health -->
      <div id="adminSystemHealth" class="card rounded-md p-5 mb-6"></div>

      <!-- Active Processes -->
      <div class="card rounded-md p-5 mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Active Processes</h3>
          <button onclick="loadAdminJobs()" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors">Refresh</button>
        </div>
        <div id="adminJobsTable" class="overflow-x-auto"></div>
      </div>

      <!-- User Management -->
      <div class="card rounded-md p-5 mb-6">
        <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase mb-4">User Management</h3>
        <div id="adminUsersTable" class="overflow-x-auto"></div>
      </div>

      <!-- Audit Log -->
      <div class="card rounded-md p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Audit Log</h3>
          <div class="flex items-center gap-3">
            <select id="auditFilterUser" onchange="loadAuditLog()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
              <option value="">All Users</option>
            </select>
            <select id="auditFilterAction" onchange="loadAuditLog()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
              <option value="">All Actions</option>
              <option value="user_login">Login</option>
              <option value="user_login_failed">Login Failed</option>
              <option value="user_register">Register</option>
              <option value="user_logout">Logout</option>
              <option value="benchmark_start">Benchmark Start</option>
              <option value="benchmark_complete">Benchmark Complete</option>
              <option value="benchmark_cancel">Benchmark Cancel</option>
              <option value="admin_user_update">Admin User Update</option>
              <option value="admin_rate_limit">Admin Rate Limit</option>
              <option value="token_refresh">Token Refresh</option>
            </select>
            <select id="auditFilterSince" onchange="loadAuditLog()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
              <option value="">All Time</option>
              <option value="1h">Last Hour</option>
              <option value="24h">Last 24h</option>
              <option value="7d">Last 7 Days</option>
              <option value="30d">Last 30 Days</option>
            </select>
          </div>
        </div>
        <div id="adminAuditTable" class="overflow-x-auto"></div>
        <div class="flex items-center justify-between mt-3">
          <span id="auditPageInfo" class="text-[10px] font-mono text-zinc-600"></span>
          <div class="flex gap-2">
            <button onclick="auditPrevPage()" id="auditPrevBtn" class="text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm" style="border:1px solid var(--border-subtle);color:#85858F;" disabled>Prev</button>
            <button onclick="auditNextPage()" id="auditNextBtn" class="text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm" style="border:1px solid var(--border-subtle);color:#85858F;">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ─── ANALYTICS TAB ─── -->
    <div id="view-analytics" class="hidden">

      <!-- Sub-nav -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Analytics</h2>
          <p class="text-sm text-zinc-600 font-body">Leaderboards, run comparisons, and performance trends.</p>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="analyticsShowLeaderboard()" id="an-btn-leaderboard" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm transition-colors" style="color:var(--lime);border:1px solid rgba(191,255,0,0.3);background:var(--lime-dim);">Leaderboard</button>
          <button onclick="analyticsShowCompare()" id="an-btn-compare" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm transition-colors" style="color:#85858F;border:1px solid var(--border-subtle);">Compare</button>
          <button onclick="analyticsShowTrends()" id="an-btn-trends" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm transition-colors" style="color:#85858F;border:1px solid var(--border-subtle);">Trends</button>
        </div>
      </div>

      <!-- Sub-View: Leaderboard -->
      <div id="an-leaderboard-view">
        <div class="flex items-center gap-3 mb-4">
          <div class="flex items-center gap-1">
            <button onclick="anSetLeaderboardType('benchmark')" id="an-lb-type-benchmark" class="text-[10px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:var(--lime);border:1px solid rgba(191,255,0,0.3);background:var(--lime-dim);">Benchmark</button>
            <button onclick="anSetLeaderboardType('tool_eval')" id="an-lb-type-tool_eval" class="text-[10px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#85858F;border:1px solid var(--border-subtle);">Tool Eval</button>
          </div>
          <select id="anLeaderboardPeriod" onchange="analyticsLoadLeaderboard()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
            <option value="7d">7 Days</option>
            <option value="30d">30 Days</option>
            <option value="90d">90 Days</option>
            <option value="all" selected>All Time</option>
          </select>
          <button onclick="downloadCSV('/api/export/leaderboard?type=' + anLeaderboardType + '&period=' + document.getElementById('anLeaderboardPeriod').value + '&format=csv', 'leaderboard.csv')" style="border: 1px solid #555; background: transparent; color: var(--lime); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: 'Outfit', sans-serif;">Export CSV</button>
        </div>
        <div class="card rounded-md overflow-hidden">
          <table class="w-full text-sm results-table">
            <thead id="anLeaderboardHead">
              <tr style="border-bottom: 1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('rank')">#</th>
                <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('model')">Model</th>
                <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('provider')">Provider</th>
                <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_tps')">Avg TPS</th>
                <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_ttft_ms')">Avg TTFT</th>
                <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_cost')">Avg Cost</th>
                <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('total_runs')">Runs</th>
                <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('last_run')">Last Run</th>
              </tr>
            </thead>
            <tbody id="anLeaderboardBody">
              <tr><td colspan="8" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">Loading leaderboard...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sub-View: Compare -->
      <div id="an-compare-view" class="hidden">
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <span class="section-label">Select Runs to Compare (2-4)</span>
            <button onclick="analyticsLoadCompare()" id="anCompareBtn" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm transition-colors" style="color:#85858F;border:1px solid var(--border-subtle);cursor:not-allowed;opacity:0.5;" disabled>Compare</button>
          </div>
          <div id="anCompareRunsList" class="space-y-2 max-h-64 overflow-y-auto">
            <p class="text-zinc-600 text-xs font-body">Loading recent runs...</p>
          </div>
        </div>
        <div id="anCompareCharts" class="hidden space-y-6">
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">Tokens/sec Comparison</label>
            <div style="height:320px"><canvas id="anCompareTpsChart"></canvas></div>
          </div>
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">TTFT Comparison (ms)</label>
            <div style="height:320px"><canvas id="anCompareTtftChart"></canvas></div>
          </div>
        </div>
        <div id="anCompareEmpty" class="card rounded-md p-10 text-center">
          <p class="text-zinc-600 font-body text-sm">Select 2-4 runs above, then click Compare.</p>
        </div>
      </div>

      <!-- Sub-View: Trends -->
      <div id="an-trends-view" class="hidden">
        <div class="flex items-center gap-3 mb-4">
          <div class="relative" id="anTrendsModelDropdown">
            <button onclick="anToggleModelDropdown()" class="text-xs font-mono px-3 py-1.5 rounded-sm flex items-center gap-2" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;">
              <span id="anTrendsModelLabel">Select Models</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div id="anTrendsModelList" class="hidden absolute top-full left-0 mt-1 w-64 max-h-48 overflow-y-auto rounded-sm z-50 p-2 space-y-1" style="background:var(--surface-raised);border:1px solid var(--border);">
            </div>
          </div>
          <select id="anTrendsPeriod" onchange="analyticsLoadTrends()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
            <option value="7d">7 Days</option>
            <option value="30d" selected>30 Days</option>
            <option value="90d">90 Days</option>
            <option value="all">All Time</option>
          </select>
        </div>
        <div id="anTrendsCharts" class="hidden space-y-6">
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">TPS Over Time</label>
            <div style="height:320px"><canvas id="anTrendsTpsChart"></canvas></div>
          </div>
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">TTFT Over Time (ms)</label>
            <div style="height:320px"><canvas id="anTrendsTtftChart"></canvas></div>
          </div>
        </div>
        <div id="anTrendsEmpty" class="card rounded-md p-10 text-center">
          <p class="text-zinc-600 font-body text-sm">Select models and a time period to see trends.</p>
        </div>
      </div>

    </div>

    <!-- ─── SCHEDULES TAB ─── -->
    <div id="view-schedules" class="hidden">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Scheduled Benchmarks</h2>
          <p class="text-sm text-zinc-600 font-body">Automate recurring benchmarks on a fixed interval.</p>
        </div>
        <button onclick="schedOpenNewModal()" class="run-btn px-4 py-2 rounded-sm text-xs flex items-center gap-2">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
          New Schedule
        </button>
      </div>

      <!-- Schedule list -->
      <div class="card rounded-md overflow-hidden">
        <table class="w-full text-sm results-table">
          <thead>
            <tr style="border-bottom: 1px solid var(--border-subtle)">
              <th class="px-5 py-3 text-left section-label">Name</th>
              <th class="px-5 py-3 text-center section-label">Models</th>
              <th class="px-5 py-3 text-center section-label">Interval</th>
              <th class="px-5 py-3 text-right section-label">Last Run</th>
              <th class="px-5 py-3 text-right section-label">Next Run</th>
              <th class="px-5 py-3 text-center section-label">Enabled</th>
              <th class="px-5 py-3 text-right section-label"></th>
            </tr>
          </thead>
          <tbody id="schedTableBody">
            <tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">Loading schedules...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ─── TOOL EVAL TAB ─── -->
    <div id="view-tool-eval" class="hidden">

      <!-- Sub-Tab Navigation -->
      <div id="teSubTabs" class="flex items-center overflow-x-auto" style="border-bottom:1px solid var(--border-subtle, rgba(255,255,255,0.06));">
        <button class="te-subtab te-subtab-active" data-tab="suites" onclick="teSetActiveSubTab('suites')">Suites</button>
        <button class="te-subtab" data-tab="run" onclick="teSetActiveSubTab('run')">Evaluate</button>
        <button class="te-subtab" data-tab="pt-config" onclick="teSetActiveSubTab('pt-config')">Param Tuner</button>
        <button class="te-subtab" data-tab="prt-config" onclick="teSetActiveSubTab('prt-config')">Prompt Tuner</button>
        <button class="te-subtab" data-tab="judge" onclick="teSetActiveSubTab('judge')">Judge</button>
        <button class="te-subtab" data-tab="timeline" onclick="teSetActiveSubTab('timeline')">Timeline</button>
      </div>

      <!-- Context Bar -->
      <div id="teContextBar" class="te-context-bar hidden">
        <span class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Context:</span>
        <span id="ctxSuitePill" class="ctx-pill hidden"></span>
        <span id="ctxModelsPill" class="ctx-pill hidden"></span>
        <span id="ctxExperimentPill" class="ctx-pill active hidden"></span>
        <button onclick="teToggleContextBar()" class="ml-auto text-[10px] text-zinc-700 hover:text-zinc-500" style="background:none;border:none;cursor:pointer;">
          <span id="ctxToggleText">Hide</span>
        </button>
      </div>

      <!-- Sub-View 1: Suite List (default) -->
      <div id="te-suites-view">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Tool Calling Evaluation</h2>
            <p class="text-sm text-zinc-600 font-body">Define tool suites, create test cases, and evaluate model accuracy.</p>
          </div>
          <div class="flex items-center gap-2 flex-wrap">
            <button onclick="teNewSuite()" class="run-btn px-4 py-2 rounded-sm text-xs whitespace-nowrap flex items-center gap-2">
              <svg class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
              New Suite
            </button>
            <button onclick="teImportSuiteJson()" class="px-4 py-2 rounded-sm text-xs font-display whitespace-nowrap flex items-center gap-2 border border-zinc-700 text-zinc-400 hover:text-zinc-200 hover:border-zinc-500 transition-colors">
              <svg class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
              Import Suite
            </button>
            <button onclick="teDownloadImportExample()" class="px-4 py-2 rounded-sm text-xs font-display whitespace-nowrap flex items-center gap-2 border border-zinc-700 text-zinc-500 hover:text-zinc-300 hover:border-zinc-500 transition-colors" title="Download example JSON template for import">
              <svg class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              Example JSON
            </button>
            <button onclick="mcpOpenModal()" class="px-4 py-2 rounded-sm text-xs font-display whitespace-nowrap flex items-center gap-2 border border-zinc-700 text-zinc-400 hover:text-zinc-200 hover:border-zinc-500 transition-colors">
              <svg class="w-3.5 h-3.5 shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              Import from MCP
            </button>
          </div>
        </div>

        <!-- Suite List Table -->
        <div class="card rounded-md overflow-hidden mb-6">
          <table class="w-full text-sm results-table">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-left section-label">Name</th>
                <th class="px-5 py-3 text-center section-label">Tools</th>
                <th class="px-5 py-3 text-center section-label">Cases</th>
                <th class="px-5 py-3 text-right section-label">Last Updated</th>
                <th class="px-5 py-3 text-right section-label"></th>
              </tr>
            </thead>
            <tbody id="teSuitesBody">
              <tr><td colspan="5" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">Loading suites...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Eval History Section -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Eval History</h3>
            <button onclick="downloadCSV('/api/export/tool-eval?format=csv', 'tool-eval-history.csv')" style="border: 1px solid #555; background: transparent; color: var(--lime); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: 'Outfit', sans-serif;">Export CSV</button>
          </div>
          <div class="card rounded-md overflow-hidden">
            <table class="w-full text-sm results-table">
              <thead>
                <tr style="border-bottom: 1px solid var(--border-subtle)">
                  <th class="px-5 py-3 text-left section-label">Timestamp</th>
                  <th class="px-5 py-3 text-left section-label">Suite</th>
                  <th class="px-5 py-3 text-left section-label">Models</th>
                  <th class="px-5 py-3 text-left section-label">Config</th>
                  <th class="px-5 py-3 text-center section-label">Judge</th>
                  <th class="px-5 py-3 text-right section-label">Overall</th>
                  <th class="px-5 py-3 text-right section-label"></th>
                </tr>
              </thead>
              <tbody id="teHistoryBody">
                <tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No eval runs yet.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Sub-View 2: Suite Editor -->
      <div id="te-editor-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('suites')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Suites
          </button>
          <div class="flex items-center gap-2">
            <button onclick="teExportSuite(teCurrentSuite?.id)" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1.5 rounded-sm transition-colors" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">Export Suite</button>
            <button onclick="teStartRunFromEditor()" class="run-btn px-4 py-2 rounded-sm text-xs flex items-center gap-2">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
              Run Eval
            </button>
          </div>
        </div>

        <!-- Suite Name + Description -->
        <div class="card rounded-md p-5 mb-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div>
              <label class="section-label mb-2 block">Suite Name</label>
              <input id="teSuiteName" class="w-full px-3 py-2 rounded-sm text-sm font-body text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" placeholder="e.g., Customer Support Tools" onchange="teSaveSuiteMeta()">
            </div>
            <div>
              <label class="section-label mb-2 block">Description</label>
              <input id="teSuiteDesc" class="w-full px-3 py-2 rounded-sm text-sm font-body text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" placeholder="Optional description" onchange="teSaveSuiteMeta()">
            </div>
          </div>
        </div>

        <!-- Tools Section -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <label class="section-label">Tools <span id="teToolCount" class="text-zinc-600">(0)</span></label>
            <div class="flex gap-2">
              <button onclick="teExportTools()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Export Tools</button>
              <button onclick="teImportToolsJson()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Import Tools</button>
              <button onclick="teAddTool()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: var(--lime); border: 1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">+ Add Tool</button>
            </div>
          </div>
          <div id="teToolsList" class="space-y-2">
            <p class="text-zinc-600 text-xs font-body">No tools defined yet.</p>
          </div>
          <!-- Inline tool JSON editor (hidden by default) -->
          <div id="teToolEditor" class="hidden mt-4" style="border-top:1px solid var(--border-subtle);padding-top:16px;">
            <label class="section-label mb-2 block">Tool JSON <span class="text-zinc-600 normal-case">(OpenAI function calling format)</span></label>
            <textarea id="teToolJson" rows="12" class="prompt-input w-full rounded-sm px-4 py-3 font-mono text-xs" placeholder='{"type":"function","function":{"name":"my_tool","description":"...","parameters":{...}}}'></textarea>
            <div id="teToolJsonError" class="hidden text-xs mt-1" style="color:var(--coral)"></div>
            <div class="flex justify-end gap-2 mt-3">
              <button onclick="teCancelToolEdit()" class="modal-btn modal-btn-cancel text-xs">Cancel</button>
              <button onclick="teSaveToolJson()" class="modal-btn modal-btn-confirm text-xs">Save Tool</button>
            </div>
          </div>
        </div>

        <!-- Test Cases Section -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <label class="section-label">Test Cases <span id="teCaseCount" class="text-zinc-600">(0)</span></label>
            <div class="flex gap-2">
              <button onclick="teImportCasesJson()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Import Cases</button>
              <button onclick="teAddCase()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: var(--lime); border: 1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">+ Add Case</button>
            </div>
          </div>
          <div id="teCasesList" class="space-y-2">
            <p class="text-zinc-600 text-xs font-body">No test cases defined yet.</p>
          </div>
          <!-- Inline case editor (hidden by default) -->
          <div id="teCaseEditor" class="hidden mt-4" style="border-top:1px solid var(--border-subtle);padding-top:16px;">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="section-label mb-2 block">Prompt</label>
                <textarea id="teCasePrompt" rows="3" class="prompt-input w-full rounded-sm px-3 py-2 text-sm" placeholder="Enter the user message..."></textarea>
              </div>
              <div>
                <label class="section-label mb-2 block">Expected Tool</label>
                <div class="flex items-center gap-2 mb-2">
                  <label class="flex items-center gap-1.5 cursor-pointer">
                    <input type="checkbox" id="teCaseNoTool" onchange="teToggleNoTool()" class="accent-[var(--lime)]">
                    <span class="text-xs text-zinc-500 font-body">No tool expected</span>
                  </label>
                </div>
                <input id="teCaseExpTool" class="w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" placeholder="tool_name or comma-separated names">
                <label class="section-label mt-3 mb-2 block">Expected Params <span class="text-zinc-600 normal-case">(JSON, optional)</span></label>
                <textarea id="teCaseExpParams" rows="3" class="prompt-input w-full rounded-sm px-3 py-2 font-mono text-xs" placeholder='{"param_name": "value"}'></textarea>
                <label class="section-label mt-3 mb-2 block">Param Scoring Mode</label>
                <select id="teCaseScoringMode" class="w-full px-3 py-2 rounded-sm text-sm text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" onchange="teToggleScoringEpsilon()">
                  <option value="exact">Exact (default)</option>
                  <option value="case_insensitive">Case Insensitive</option>
                  <option value="contains">Contains (substring)</option>
                  <option value="numeric_tolerance">Numeric Tolerance</option>
                  <option value="regex">Regex</option>
                </select>
                <div id="teCaseScoringEpsilon" class="hidden mt-2">
                  <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Epsilon (tolerance)</label>
                  <input id="teCaseEpsilon" type="number" step="0.001" value="0.01" class="w-full px-2 py-1 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
                </div>
              </div>
              <!-- Multi-Turn Settings -->
              <div class="lg:col-span-2 mt-2">
                <label class="flex items-center gap-2 cursor-pointer mb-2">
                  <input type="checkbox" id="teCaseMultiTurn" onchange="teToggleMultiTurn()" class="accent-[var(--lime)]">
                  <span class="text-xs font-display tracking-wider uppercase text-zinc-400">Multi-Turn</span>
                </label>
                <div id="teCaseMultiTurnSettings" class="hidden pl-4 space-y-3" style="border-left:2px solid var(--border-subtle);">
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Max Rounds</label>
                      <input id="teCaseMaxRounds" type="number" min="2" max="10" value="5" class="w-full px-2 py-1 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
                    </div>
                    <div>
                      <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Optimal Hops</label>
                      <input id="teCaseOptimalHops" type="number" min="1" max="10" value="2" class="w-full px-2 py-1 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
                    </div>
                  </div>
                  <div>
                    <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Valid Prerequisites <span class="normal-case text-zinc-600">(comma-separated tool names)</span></label>
                    <input id="teCasePrereqs" class="w-full px-2 py-1 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" placeholder="get_time, get_location">
                  </div>
                  <div>
                    <label class="text-[10px] font-display tracking-wider uppercase text-zinc-500 block mb-1">Mock Responses <span class="normal-case text-zinc-600">(JSON)</span></label>
                    <textarea id="teCaseMockResponses" rows="3" class="prompt-input w-full rounded-sm px-2 py-1 font-mono text-xs" placeholder='{"get_time": {"time": "2024-01-15T10:00:00Z"}}'></textarea>
                  </div>
                </div>
              </div>
            </div>
            <div id="teCaseError" class="hidden text-xs mb-2" style="color:var(--coral)"></div>
            <div class="flex justify-end gap-2">
              <button onclick="teCancelCaseEdit()" class="modal-btn modal-btn-cancel text-xs">Cancel</button>
              <button onclick="teSaveCaseEdit()" class="modal-btn modal-btn-confirm text-xs">Save Case</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Sub-View 3: Run / Results -->
      <div id="te-run-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="teBackFromRun()" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back
          </button>
          <h3 id="teRunTitle" class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase"></h3>
        </div>

        <!-- Model selection for eval -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <label class="section-label">Select Models</label>
            <div class="flex gap-2">
              <button onclick="teSelectAllModels()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: var(--lime); border: 1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">All</button>
              <button onclick="teClearModels()" class="text-[11px] font-display font-medium tracking-wider uppercase text-zinc-600 px-3 py-1 rounded-sm border transition-colors" style="border-color: var(--border-subtle)" onmouseover="this.style.borderColor='var(--border)'" onmouseout="this.style.borderColor='var(--border-subtle)'">Clear</button>
            </div>
          </div>
          <div id="teModelGrid" class="flex flex-col gap-1"></div>
        </div>

        <!-- Provider Parameters (Tool Eval) — renders its own card when models selected -->
        <div id="ppToolEvalPanel" class="hidden mb-6"></div>

        <!-- Eval Settings -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <label class="section-label">Eval Settings</label>
          </div>
          <div class="flex items-center gap-4">
            <div>
              <span class="text-zinc-500 font-body text-xs">Temperature</span>
              <input id="teTemperature" type="number" min="0" max="2" step="0.1" value="0.0" class="ml-2 w-16 px-2 py-1 rounded-sm text-sm font-mono text-zinc-200 text-center" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-xs font-display tracking-wider text-zinc-500 uppercase">Tool Choice</label>
              <select id="teToolChoice" class="text-xs font-mono px-3 py-1.5 rounded-sm ml-2" style="background:var(--surface);border:1px solid var(--border-subtle);color:var(--zinc-200);width:120px">
                <option value="required">Required</option>
                <option value="auto">Auto</option>
                <option value="none">None</option>
              </select>
            </div>
            <div class="ml-auto flex gap-2">
              <button id="teCancelEvalBtn" onclick="teCancelEval()" class="hidden text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:var(--coral);border:1px solid rgba(255,59,92,0.3);" onmouseover="this.style.borderColor='rgba(255,59,92,0.6)'" onmouseout="this.style.borderColor='rgba(255,59,92,0.3)'">Cancel</button>
              <button id="teStartBtn" onclick="teStartEval()" class="run-btn px-6 py-2 rounded-sm text-xs flex items-center gap-2">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                Start Eval
              </button>
            </div>
          </div>

          <!-- LLM Judge Settings -->
          <div class="mt-4 pt-4" style="border-top:1px solid var(--border-subtle)">
            <div class="flex items-center gap-3 mb-3">
              <label class="relative inline-flex items-center cursor-pointer">
                <input id="jgToggle" type="checkbox" class="sr-only peer" onchange="jgTogglePanel()">
                <div class="w-8 h-4 rounded-full transition-colors" style="background:var(--border-subtle);" id="jgToggleTrack"></div>
                <div class="absolute left-0.5 top-0.5 w-3 h-3 rounded-full transition-transform" style="background:#52525B;" id="jgToggleDot"></div>
              </label>
              <span class="text-[10px] font-display tracking-wider uppercase text-zinc-500">LLM Judge</span>
              <svg class="w-3.5 h-3.5 text-zinc-700" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
            </div>
            <div id="jgSettingsPanel" class="hidden">
              <div class="flex items-center gap-4">
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Mode</label>
                  <select id="jgMode" class="text-xs font-mono px-3 py-1.5 rounded-sm" style="background:var(--surface);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;width:140px;">
                    <option value="live_inline">Live Inline</option>
                    <option value="post_eval">Post-Eval Report</option>
                  </select>
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Judge Model</label>
                  <select id="jgJudgeModel" class="text-xs font-mono px-3 py-1.5 rounded-sm" style="background:var(--surface);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;width:200px;"></select>
                </div>
              </div>
              <p class="text-[10px] text-zinc-700 font-body mt-2">The judge model evaluates quality of tool calling results. Runs at temperature 0.0 for consistency.</p>
            </div>
          </div>
        </div>

        <!-- Progress Section -->
        <div id="teProgressSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="pulse-dot"></div>
                <span id="teProgressLabel" class="text-sm text-zinc-400 font-body">Initializing...</span>
              </div>
              <span id="teProgressCount" class="text-xs font-mono text-zinc-600">0/0</span>
            </div>
            <div class="progress-track rounded-full overflow-hidden">
              <div id="teProgressBar" class="progress-fill" style="width:0%"></div>
            </div>
          </div>
          <div id="teSSEBanner" class="hidden error-banner mt-3">
            <span id="teSSEBannerMsg">Connection lost</span>
          </div>
        </div>

        <!-- Judge Progress Section -->
        <div id="jgProgressSection" class="hidden mb-4 fade-in">
          <div class="card rounded-md p-4">
            <div class="flex items-center justify-between mb-2">
              <div class="flex items-center gap-2">
                <div class="pulse-dot" style="background:#F59E0B"></div>
                <span class="text-xs font-display tracking-wider uppercase text-zinc-500">Judge Progress</span>
              </div>
              <div class="flex items-center gap-3">
                <span id="jgProgressCount" class="text-xs font-mono text-zinc-600">0/0</span>
                <span id="jgProgressETA" class="text-[10px] font-mono text-zinc-700"></span>
              </div>
            </div>
            <div class="progress-track rounded-full overflow-hidden">
              <div id="jgProgressBar" class="progress-fill" style="width:0%;background:#F59E0B"></div>
            </div>
          </div>
        </div>

        <!-- Delta Banner (M6) -->
        <div id="teDeltaBanner" class="hidden text-center py-2 px-4 rounded-sm mb-3 text-sm font-medium"></div>

        <!-- Summary Section -->
        <div id="teSummarySection" class="hidden mb-6 fade-in">
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3 flex items-center" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">Results Summary</span>
              <span id="teSummaryInfo" class="text-xs font-body text-zinc-600 ml-2"></span>
              <div id="teActionBridges" class="hidden flex items-center gap-2 ml-2">
                <button onclick="teBridgeToParamTuner()"
                  class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1.5 rounded-sm transition-colors"
                  style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);"
                  onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'"
                  onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">
                  Tune Parameters
                </button>
                <button onclick="teBridgeToPromptTuner()"
                  class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1.5 rounded-sm transition-colors"
                  style="color:#A855F7;border:1px solid rgba(168,85,247,0.2);"
                  onmouseover="this.style.borderColor='rgba(168,85,247,0.5)'"
                  onmouseout="this.style.borderColor='rgba(168,85,247,0.2)'">
                  Tune Prompt
                </button>
                <button id="tePinBaselineBtn" onclick="tePinAsBaseline()" class="hidden text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1.5 rounded-sm transition-colors"
                  style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);"
                  onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'"
                  onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">
                  Pin as Baseline
                </button>
              </div>
              <button id="teExportBtn" onclick="teExportResults()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm hidden ml-auto" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">Export JSON</button>
            </div>
            <table class="w-full text-sm results-table">
              <thead>
                <tr style="border-bottom: 1px solid var(--border-subtle)">
                  <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="teSortSummary('model_name')">Model</th>
                  <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="teSortSummary('tool_accuracy_pct')">Tool %</th>
                  <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="teSortSummary('param_accuracy_pct')">Param %</th>
                  <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="teSortSummary('overall_pct')">Overall</th>
                  <th class="px-5 py-3 text-right section-label">Cases</th>
                </tr>
              </thead>
              <tbody id="teSummaryBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Detailed Results (drill-down) -->
        <div id="teDetailSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <div class="flex items-center justify-between mb-4">
              <span class="section-label">Detailed Results</span>
              <button onclick="document.getElementById('teDetailSection').classList.add('hidden')" class="text-zinc-600 hover:text-zinc-400 text-xs font-body">Close</button>
            </div>
            <div id="teDetailContent" class="space-y-3"></div>
          </div>
        </div>

        <!-- Live Results Table -->
        <div id="teLiveSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">Live Results</span>
            </div>
            <div id="teLiveResults" class="max-h-96 overflow-y-auto">
              <table class="w-full text-sm results-table">
                <thead>
                  <tr style="border-bottom: 1px solid var(--border-subtle)">
                    <th class="px-5 py-2 text-left section-label">Model</th>
                    <th class="px-5 py-2 text-left section-label">Test Case</th>
                    <th class="px-5 py-2 text-left section-label">Expected</th>
                    <th class="px-5 py-2 text-left section-label">Actual</th>
                    <th class="px-5 py-2 text-right section-label">Hops</th>
                    <th class="px-5 py-2 text-right section-label">Score</th>
                    <th id="jgLiveColHeader" class="px-5 py-2 text-center section-label hidden">Judge</th>
                  </tr>
                </thead>
                <tbody id="teLiveBody"></tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Judge Report Panel (Post-Eval) -->
        <div id="jgReportSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <div class="flex items-center justify-between mb-4">
              <div class="flex items-center gap-3">
                <svg class="w-5 h-5" style="color:#F59E0B" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/></svg>
                <span class="font-display font-semibold text-sm tracking-wider uppercase" style="color:#F59E0B;">Judge Report</span>
                <span id="jgGradeBadge" class="text-sm font-mono font-bold px-2 py-0.5 rounded-full" style="background:rgba(245,158,11,0.1);color:#F59E0B;"></span>
              </div>
              <div class="flex items-center gap-2">
                <span id="jgReportStatus" class="text-[9px] font-display tracking-wider uppercase text-zinc-600"></span>
                <button onclick="jgDownloadReport()" class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);">Download JSON</button>
              </div>
            </div>

            <!-- Overall Score Bar -->
            <div id="jgOverallScore" class="mb-5">
              <div class="flex items-center justify-between mb-1">
                <span class="text-xs text-zinc-500 font-body">Overall Score</span>
                <span id="jgScoreValue" class="text-sm font-mono font-bold" style="color:#F59E0B;"></span>
              </div>
              <div class="h-2 rounded-full overflow-hidden" style="background:rgba(255,255,255,0.05);">
                <div id="jgScoreBar" class="h-full rounded-full transition-all" style="background:#F59E0B;width:0%;"></div>
              </div>
            </div>

            <!-- Strengths / Weaknesses -->
            <div class="grid grid-cols-2 gap-4 mb-5">
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-2 block">Strengths</label>
                <ul id="jgStrengths" class="space-y-1"></ul>
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-2 block">Weaknesses</label>
                <ul id="jgWeaknesses" class="space-y-1"></ul>
              </div>
            </div>

            <!-- Cross-Case Analysis -->
            <div class="mb-5">
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-2 block">Cross-Case Analysis</label>
              <p id="jgAnalysis" class="text-xs font-body text-zinc-400 leading-relaxed"></p>
            </div>

            <!-- Recommendations -->
            <div class="mb-5">
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-2 block">Recommendations</label>
              <ol id="jgRecommendations" class="space-y-1 list-decimal list-inside"></ol>
            </div>

            <!-- Bridge D: Judge -> Next Steps -->
            <div id="jgActionBridges" class="hidden mt-4 pt-3" style="border-top:1px solid var(--border-subtle)">
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-2 block">Next Steps</label>
              <div class="flex items-center gap-2">
                <button onclick="jgBridgeToParamTuner()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Tune Parameters</button>
                <button onclick="jgBridgeToPromptTuner()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:#A855F7;border:1px solid rgba(168,85,247,0.2);" onmouseover="this.style.borderColor='rgba(168,85,247,0.5)'" onmouseout="this.style.borderColor='rgba(168,85,247,0.2)'">Tune Prompt</button>
                <button onclick="jgBridgeToReEval()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">Re-Run Eval</button>
              </div>
            </div>

            <!-- Per-Case Verdicts (accordion) -->
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-2 block">Per-Case Verdicts</label>
              <div id="jgVerdicts" class="space-y-2"></div>
            </div>
          </div>
        </div>
      </div>

      <!-- Sub-View 10: Judge Comparative View -->
      <div id="jg-compare-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('suites')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Suites
          </button>
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Model Comparison (Judge)</h3>
        </div>

        <!-- Compare Header -->
        <div id="jgCompareHeader" class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-3">
            <span id="jgCompModelA" class="font-display font-semibold text-sm" style="color:#22D3EE;">Model A</span>
            <span class="text-[10px] font-display tracking-wider uppercase text-zinc-600">vs</span>
            <span id="jgCompModelB" class="font-display font-semibold text-sm" style="color:#F59E0B;">Model B</span>
          </div>
          <div id="jgCompSummaryBar" class="flex items-center gap-2 text-xs font-mono text-zinc-400"></div>
        </div>

        <!-- Compare Progress -->
        <div id="jgCompProgress" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <div class="flex items-center gap-3 mb-3">
              <div class="pulse-dot"></div>
              <span id="jgCompProgressLabel" class="text-sm text-zinc-400 font-body">Comparing...</span>
              <span id="jgCompProgressCount" class="text-xs font-mono text-zinc-600 ml-auto">0/0</span>
            </div>
            <div class="progress-track rounded-full overflow-hidden">
              <div id="jgCompProgressBar" class="progress-fill" style="width:0%;"></div>
            </div>
          </div>
        </div>

        <!-- Compare Cases -->
        <div id="jgCompCases" class="space-y-3 mb-6"></div>

        <!-- Compare Overall Verdict -->
        <div id="jgCompVerdict" class="hidden fade-in">
          <div class="card rounded-md p-5" style="border:1px solid rgba(245,158,11,0.3);">
            <div class="flex items-center gap-2 mb-3">
              <svg class="w-5 h-5" style="color:#F59E0B;" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M16.5 18.75h-9m9 0a3 3 0 013 3h-15a3 3 0 013-3m9 0v-4.5A3.375 3.375 0 0012.75 10.5h-1.5A3.375 3.375 0 007.5 14.25v4.5m9-9V6a4.5 4.5 0 00-9 0v3.25"/></svg>
              <span class="font-display font-semibold text-sm tracking-wider uppercase" style="color:#F59E0B;">Overall Verdict</span>
            </div>
            <div id="jgCompWinner" class="text-sm font-body text-zinc-200 mb-2"></div>
            <p id="jgCompSummary" class="text-xs font-body text-zinc-400 leading-relaxed"></p>
          </div>
        </div>
      </div>

      <!-- Sub-View 11: Judge History -->
      <div id="jg-history-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('suites')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Suites
          </button>
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Judge Reports</h3>
        </div>
        <div class="card rounded-md overflow-hidden">
          <table class="w-full text-sm results-table">
            <thead>
              <tr style="border-bottom:1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-left section-label">Date</th>
                <th class="px-5 py-3 text-center section-label">Mode</th>
                <th class="px-5 py-3 text-left section-label">Judge Model</th>
                <th class="px-5 py-3 text-center section-label">Grade</th>
                <th class="px-5 py-3 text-right section-label">Score</th>
                <th class="px-5 py-3 text-center section-label">Status</th>
                <th class="px-5 py-3 text-right section-label"></th>
              </tr>
            </thead>
            <tbody id="jgHistoryBody">
              <tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No judge reports yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sub-View 4: Parameter Tuner Config -->
      <div id="pt-config-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('suites')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Suites
          </button>
          <div class="flex items-center gap-2">
            <button onclick="showToolEvalView('pt-history')" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">History</button>
          </div>
        </div>

        <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Parameter Tuner</h2>
        <p class="text-sm text-zinc-600 font-body mb-6">Sweep parameter combinations to find optimal tool calling configuration.</p>

        <!-- Search Space Builder -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <label class="section-label" style="margin:0">Search Space</label>
            <!-- Preset bar -->
            <div class="flex items-center gap-2">
              <select id="ptPresetSelect" class="text-xs font-mono px-2 py-1.5 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;min-width:140px;">
                <option value="">-- Presets --</option>
              </select>
              <button onclick="ptLoadSelectedPreset()" class="text-[10px] font-display font-medium tracking-wider uppercase px-2.5 py-1 rounded-sm text-zinc-500 hover:text-zinc-300 transition-colors" style="border:1px solid var(--border-subtle);">Load</button>
              <button onclick="ptSavePreset()" class="text-[10px] font-display font-medium tracking-wider uppercase px-2.5 py-1 rounded-sm transition-colors" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);">Save</button>
              <button onclick="ptDeleteSelectedPreset()" class="text-[10px] font-display font-medium tracking-wider uppercase px-2.5 py-1 rounded-sm text-zinc-600 hover:text-red-400 transition-colors" style="border:1px solid var(--border-subtle);">Delete</button>
            </div>
          </div>
          <div id="ptSearchSpace" class="space-y-4">
            <div class="text-xs text-zinc-600 font-body text-center py-4">Select models to configure parameters</div>
          </div>

          <!-- Grid Preview Bar -->
          <div id="ptGridPreview" class="mt-5 pt-4 flex items-center justify-between" style="border-top:1px solid var(--border-subtle)">
            <div>
              <span class="text-xs text-zinc-500 font-body">Total combinations: </span>
              <span id="ptGridCount" class="font-mono font-bold text-sm text-zinc-200">0</span>
              <span id="ptGridBreakdown" class="text-[10px] text-zinc-600 font-mono ml-2"></span>
            </div>
            <span id="ptGridBadge" class="text-[10px] font-display font-semibold tracking-wider uppercase px-2 py-0.5 rounded-sm"></span>
          </div>
        </div>

        <!-- Suite & Model Selection -->
        <div class="card rounded-md p-5 mb-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <div>
              <label class="section-label mb-3 block">Suite</label>
              <select id="ptSuiteSelect" class="w-full text-xs font-mono px-3 py-2 rounded-sm" style="background:var(--surface);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
                <option value="">-- Select a tool eval suite --</option>
              </select>
            </div>
            <div>
              <label class="section-label mb-3 block">Models</label>
              <div id="ptModelGrid" class="flex flex-col gap-1 max-h-48 overflow-y-auto" style="scrollbar-width:thin;"></div>
            </div>
          </div>
        </div>

        <!-- Compatibility Matrix (collapsible) -->
        <div id="ptCompatSection" class="hidden mb-6">
          <details class="card rounded-md overflow-hidden">
            <summary class="px-5 py-3 cursor-pointer section-label hover:text-zinc-300 transition-colors" style="border-bottom:1px solid var(--border-subtle);">Compatibility Matrix</summary>
            <div id="ptCompatBody" class="px-5 py-3 overflow-x-auto"></div>
          </details>
        </div>

        <!-- Start Button -->
        <div class="flex justify-center mb-10">
          <button id="ptStartBtn" onclick="ptStartTune()" class="run-btn px-12 py-3 rounded-sm text-sm flex items-center gap-3">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            Start Tuning
          </button>
        </div>
      </div>

      <!-- Sub-View 5: Parameter Tuner Run/Results -->
      <div id="pt-run-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('pt-config')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Config
          </button>
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Parameter Tuning</h3>
        </div>

        <!-- Progress -->
        <div id="ptProgressSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="pulse-dot"></div>
                <span id="ptProgressLabel" class="text-sm text-zinc-400 font-body">Initializing...</span>
              </div>
              <div class="flex items-center gap-4">
                <span id="ptProgressCount" class="text-xs font-mono text-zinc-600">0/0</span>
                <span id="ptETA" class="text-xs font-body text-zinc-500"></span>
                <button id="ptCancelBtn" onclick="ptCancelTune()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:var(--coral);border:1px solid rgba(255,59,92,0.3);" onmouseover="this.style.borderColor='rgba(255,59,92,0.6)'" onmouseout="this.style.borderColor='rgba(255,59,92,0.3)'">Cancel</button>
              </div>
            </div>
            <div class="progress-track rounded-full overflow-hidden">
              <div id="ptProgressBar" class="progress-fill" style="width:0%"></div>
            </div>
          </div>
        </div>

        <!-- Best Config Summary -->
        <div id="ptBestCard" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5" style="border:1px solid rgba(234,179,8,0.3);">
            <div class="flex items-center gap-2 mb-2">
              <svg class="w-4 h-4" style="color:#EAB308" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 011.04 0l2.125 5.111a.563.563 0 00.475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 00-.182.557l1.285 5.385a.562.562 0 01-.84.61l-4.725-2.885a.563.563 0 00-.586 0L6.982 20.54a.562.562 0 01-.84-.61l1.285-5.386a.562.562 0 00-.182-.557l-4.204-3.602a.563.563 0 01.321-.988l5.518-.442a.563.563 0 00.475-.345L11.48 3.5z"/></svg>
              <span class="font-display font-semibold text-sm tracking-wider uppercase" style="color:#EAB308;">Best Configuration</span>
            </div>
            <div id="ptBestConfigText" class="text-sm font-mono text-zinc-200 mb-1"></div>
            <div id="ptBestScoreText" class="text-xs text-zinc-500 font-body"></div>
          </div>
        </div>

        <!-- Results Table -->
        <div id="ptResultsSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md overflow-hidden">
            <div class="flex items-center justify-between px-5 py-3" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">Combination Results</span>
              <div class="flex items-center gap-2">
                <button id="ptApplyBestBtn" onclick="ptApplyBest()" class="hidden text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);">Apply Best Config</button>
                <button id="ptReEvalBtn" onclick="ptApplyAndReEval()" class="hidden text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:#22C55E;border:1px solid rgba(34,197,94,0.2);" onmouseover="this.style.borderColor='rgba(34,197,94,0.5)'" onmouseout="this.style.borderColor='rgba(34,197,94,0.2)'">Apply &amp; Re-Eval</button>
                <button onclick="ptExportCSV()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);">Export CSV</button>
              </div>
            </div>
            <!-- Adjustments summary banner (populated by JS when adjustments exist) -->
            <div id="ptAdjustmentsSummary" class="hidden px-5 py-2 text-xs font-body" style="background:rgba(234,179,8,0.05);border-bottom:1px solid rgba(234,179,8,0.15);color:#EAB308;"></div>
            <table class="w-full text-sm results-table">
              <thead id="ptResultsHead"></thead>
              <tbody id="ptResultsBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Sub-View 6: Parameter Tuner History -->
      <div id="pt-history-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('pt-config')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Tuner
          </button>
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Tuning History</h3>
        </div>
        <div class="card rounded-md overflow-hidden">
          <table class="w-full text-sm results-table">
            <thead>
              <tr style="border-bottom:1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-left section-label">Date</th>
                <th class="px-5 py-3 text-left section-label">Suite</th>
                <th class="px-5 py-3 text-left section-label">Models</th>
                <th class="px-5 py-3 text-right section-label">Combos</th>
                <th class="px-5 py-3 text-right section-label">Best Score</th>
                <th class="px-5 py-3 text-center section-label">Status</th>
                <th class="px-5 py-3 text-right section-label"></th>
              </tr>
            </thead>
            <tbody id="ptHistoryBody">
              <tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No tuning runs yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sub-View 7: Prompt Tuner Config -->
      <div id="prt-config-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('suites')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Suites
          </button>
          <button onclick="showToolEvalView('prt-history')" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#A855F7;border:1px solid rgba(168,85,247,0.2);" onmouseover="this.style.borderColor='rgba(168,85,247,0.5)'" onmouseout="this.style.borderColor='rgba(168,85,247,0.2)'">History</button>
        </div>

        <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Prompt Tuner</h2>
        <p class="text-sm text-zinc-600 font-body mb-6">Use AI to generate and evolve system prompts for optimal tool calling.</p>

        <!-- Mode Selector -->
        <div class="grid grid-cols-2 gap-4 mb-6">
          <button id="prtModeQuick" onclick="prtSetMode('quick')" class="card rounded-md p-5 text-left transition-all cursor-pointer" style="border:2px solid var(--lime);">
            <div class="font-display font-semibold text-sm text-zinc-100 mb-1">Quick Mode</div>
            <div class="text-xs text-zinc-500 font-body">Generate N prompt variations at once. Fast exploration.</div>
          </button>
          <button id="prtModeEvo" onclick="prtSetMode('evolutionary')" class="card rounded-md p-5 text-left transition-all cursor-pointer" style="border:2px solid var(--border-subtle);">
            <div class="font-display font-semibold text-sm text-zinc-100 mb-1">Evolutionary Mode</div>
            <div class="text-xs text-zinc-500 font-body">Evolve prompts over generations. Deep optimization.</div>
          </button>
        </div>

        <!-- Config Panel -->
        <div class="card rounded-md p-5 mb-6">
          <label class="section-label mb-4 block">Configuration</label>
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-5">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Suite</label>
              <select id="prtSuiteSelect" class="w-full text-xs font-mono px-3 py-2 rounded-sm" style="background:var(--surface);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;" onchange="prtUpdateEstimate()">
                <option value="">-- Select a tool eval suite --</option>
              </select>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Meta-Model (generates prompts)</label>
              <select id="prtMetaModel" class="w-full text-xs font-mono px-3 py-2 rounded-sm" style="background:var(--surface);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
              </select>
            </div>
          </div>

          <div class="mb-5">
            <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Target Models (evaluated)</label>
            <div id="prtModelGrid" class="flex flex-col gap-1 max-h-48 overflow-y-auto" style="scrollbar-width:thin;"></div>
          </div>

          <div class="mb-5">
            <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Base Prompt</label>
            <textarea id="prtBasePrompt" rows="3" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;resize:vertical;" placeholder="You are a helpful assistant that uses tools to answer questions. (Leave empty for default)"></textarea>
          </div>

          <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-5">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Temperature</label>
              <input id="prtTemperature" type="number" min="0" max="2" step="0.1" value="0.0" class="w-full px-2 py-1.5 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Tool Choice</label>
              <select id="prtToolChoice" class="w-full text-xs font-mono px-2 py-1.5 rounded-sm" style="background:var(--surface);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
                <option value="required">required</option>
                <option value="auto">auto</option>
                <option value="none">none</option>
              </select>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Population Size</label>
              <input id="prtPopSize" type="number" min="3" max="20" step="1" value="5" class="w-full px-2 py-1.5 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" onchange="prtUpdateEstimate()">
            </div>
            <div id="prtEvoFields" class="hidden">
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Generations</label>
              <input id="prtGenerations" type="number" min="2" max="10" step="1" value="3" class="w-full px-2 py-1.5 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" onchange="prtUpdateEstimate()">
            </div>
          </div>

          <div id="prtEvoExtra" class="hidden mb-5">
            <div class="w-48">
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block">Selection Ratio</label>
              <input id="prtSelRatio" type="number" min="0.2" max="0.8" step="0.1" value="0.4" class="w-full px-2 py-1.5 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
          </div>

          <!-- Estimate Badge -->
          <div id="prtEstimate" class="flex items-center gap-3 pt-4" style="border-top:1px solid var(--border-subtle)">
            <span class="text-xs text-zinc-500 font-body">Estimated:</span>
            <span id="prtEstimateText" class="text-xs font-mono text-zinc-300"></span>
            <span id="prtEstimateWarn" class="hidden text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm" style="background:rgba(255,59,92,0.1);color:var(--coral);">HIGH VOLUME</span>
          </div>
        </div>

        <!-- Start Button -->
        <div class="flex justify-center mb-10">
          <button id="prtStartBtn" onclick="prtStartTune()" class="run-btn px-12 py-3 rounded-sm text-sm flex items-center gap-3">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
            Start Prompt Tuning
          </button>
        </div>
      </div>

      <!-- Sub-View 8: Prompt Tuner Run/Results -->
      <div id="prt-run-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('prt-config')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Config
          </button>
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Prompt Tuning</h3>
        </div>

        <!-- Generation Timeline (Evo mode) -->
        <div id="prtTimeline" class="hidden mb-6">
          <div id="prtTimelineDots" class="flex items-center justify-center gap-2"></div>
        </div>

        <!-- Progress -->
        <div id="prtProgressSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="pulse-dot"></div>
                <span id="prtProgressLabel" class="text-sm text-zinc-400 font-body">Initializing...</span>
              </div>
              <div class="flex items-center gap-4">
                <span id="prtProgressCount" class="text-xs font-mono text-zinc-600">0/0</span>
                <button onclick="prtCancelTune()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:var(--coral);border:1px solid rgba(255,59,92,0.3);" onmouseover="this.style.borderColor='rgba(255,59,92,0.6)'" onmouseout="this.style.borderColor='rgba(255,59,92,0.3)'">Cancel</button>
              </div>
            </div>
            <div class="progress-track rounded-full overflow-hidden">
              <div id="prtProgressBar" class="progress-fill" style="width:0%"></div>
            </div>
          </div>
        </div>

        <!-- Best Prompt Hero Card -->
        <div id="prtBestCard" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5" style="border:1px solid rgba(168,85,247,0.3);">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-2">
                <svg class="w-4 h-4" style="color:#A855F7" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg>
                <span class="font-display font-semibold text-sm tracking-wider uppercase" style="color:#A855F7;">Best Prompt</span>
                <span id="prtBestScore" class="text-xs font-mono text-zinc-400 ml-2"></span>
              </div>
              <div class="flex items-center gap-2">
                <button onclick="prtCopyBest()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);">Copy</button>
                <button onclick="prtSaveToSuite()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:#A855F7;border:1px solid rgba(168,85,247,0.2);" onmouseover="this.style.borderColor='rgba(168,85,247,0.5)'" onmouseout="this.style.borderColor='rgba(168,85,247,0.2)'">Save to Suite</button>
                <button onclick="prtApplyAndReEval()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:#22C55E;border:1px solid rgba(34,197,94,0.2);" onmouseover="this.style.borderColor='rgba(34,197,94,0.5)'" onmouseout="this.style.borderColor='rgba(34,197,94,0.2)'">Apply &amp; Re-Eval</button>
              </div>
            </div>
            <pre id="prtBestPromptText" class="text-xs font-mono text-zinc-300 whitespace-pre-wrap max-h-48 overflow-y-auto p-3 rounded-sm" style="background:rgba(0,0,0,0.2);"></pre>
          </div>
        </div>

        <!-- Live Prompt Cards -->
        <div id="prtPromptsSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">Prompt Variations</label>
            <div id="prtPromptCards" class="space-y-3"></div>
          </div>
        </div>

        <!-- Score Trend Chart (Evo mode) -->
        <div id="prtChartSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">Score Trend</label>
            <div class="relative" style="height:200px;">
              <canvas id="prtScoreChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Sub-View 9: Prompt Tuner History -->
      <div id="prt-history-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('prt-config')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Tuner
          </button>
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Prompt Tuning History</h3>
        </div>
        <div class="card rounded-md overflow-hidden">
          <table class="w-full text-sm results-table">
            <thead>
              <tr style="border-bottom:1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-left section-label">Date</th>
                <th class="px-5 py-3 text-left section-label">Suite</th>
                <th class="px-5 py-3 text-center section-label">Mode</th>
                <th class="px-5 py-3 text-left section-label">Models</th>
                <th class="px-5 py-3 text-right section-label">Best Score</th>
                <th class="px-5 py-3 text-center section-label">Status</th>
                <th class="px-5 py-3 text-right section-label"></th>
              </tr>
            </thead>
            <tbody id="prtHistoryBody">
              <tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No prompt tuning runs yet.</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sub-View 12: Timeline View -->
      <div id="te-timeline-view" class="hidden p-4">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-sm font-display font-medium tracking-wider uppercase" style="color:var(--text-secondary, #A1A1AA)">Experiment Timeline</h3>
          <div id="tlFilterPills" class="flex gap-2">
            <button class="tl-filter text-[10px] px-2 py-1 rounded-sm" data-filter="all" onclick="tlFilterTimeline('all')" style="background:rgba(255,255,255,0.08);color:var(--text-secondary, #A1A1AA);border:none;cursor:pointer;opacity:1">All</button>
            <button class="tl-filter text-[10px] px-2 py-1 rounded-sm" data-filter="eval" onclick="tlFilterTimeline('eval')" style="background:rgba(191,255,0,0.08);color:var(--lime);border:none;cursor:pointer;opacity:0.5">Evals</button>
            <button class="tl-filter text-[10px] px-2 py-1 rounded-sm" data-filter="param_tune" onclick="tlFilterTimeline('param_tune')" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:none;cursor:pointer;opacity:0.5">Param Tunes</button>
            <button class="tl-filter text-[10px] px-2 py-1 rounded-sm" data-filter="prompt_tune" onclick="tlFilterTimeline('prompt_tune')" style="background:rgba(168,85,247,0.08);color:#A855F7;border:none;cursor:pointer;opacity:0.5">Prompt Tunes</button>
            <button class="tl-filter text-[10px] px-2 py-1 rounded-sm" data-filter="judge" onclick="tlFilterTimeline('judge')" style="background:rgba(245,158,11,0.08);color:#F59E0B;border:none;cursor:pointer;opacity:0.5">Judges</button>
          </div>
        </div>

        <div id="tlNoExperiment" class="text-center py-12 text-zinc-600 text-sm">
          No experiment selected. Create or select an experiment to see its timeline.
        </div>

        <div id="tlEntries" class="hidden"></div>
      </div>

      <!-- MCP Import Modal -->
      <div id="mcpModal" class="modal-overlay hidden" onclick="if(event.target===this)mcpCloseModal()">
        <div class="modal-box" style="max-width:600px; max-height:80vh; overflow-y:auto">
          <div class="modal-title flex items-center justify-between">
            Import Tools from MCP Server
            <button onclick="mcpCloseModal()" class="text-zinc-500 hover:text-zinc-300">&times;</button>
          </div>

          <!-- Step 1: Connect -->
          <div id="mcpStep1">
            <div class="mt-4">
              <label class="section-label block mb-1">MCP Server URL</label>
              <div class="flex gap-2">
                <input id="mcpUrl" type="url" placeholder="http://localhost:3001/sse"
                       class="flex-1 bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-zinc-200 font-mono">
                <button onclick="mcpConnect()" id="mcpConnectBtn" class="run-btn px-4 py-2 rounded-sm text-xs">
                  Connect
                </button>
              </div>
              <p class="text-xs text-zinc-600 mt-2">Enter the SSE endpoint URL of your MCP server</p>
            </div>
            <div id="mcpConnectError" class="text-red-400 text-xs mt-2 hidden"></div>
            <div id="mcpConnecting" class="text-zinc-500 text-xs mt-2 hidden">Connecting...</div>
          </div>

          <!-- Step 2: Preview & Select -->
          <div id="mcpStep2" class="hidden">
            <div class="text-sm text-zinc-400 mt-2 mb-3" id="mcpServerInfo"></div>

            <div class="flex gap-2 mb-3">
              <button onclick="mcpSelectAll(true)" class="text-xs text-zinc-500 hover:text-zinc-300">Select All</button>
              <span class="text-zinc-700">|</span>
              <button onclick="mcpSelectAll(false)" class="text-xs text-zinc-500 hover:text-zinc-300">Deselect All</button>
            </div>

            <div id="mcpToolList" class="space-y-2 mb-4" style="max-height:300px; overflow-y:auto"></div>

            <div class="space-y-3 border-t border-zinc-800 pt-3">
              <div>
                <label class="section-label block mb-1">Suite Name</label>
                <input id="mcpSuiteName" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-zinc-200">
              </div>
              <div>
                <label class="section-label block mb-1">Description</label>
                <input id="mcpSuiteDesc" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-zinc-200">
              </div>
              <label class="flex items-center gap-2 text-sm text-zinc-400">
                <input type="checkbox" id="mcpGenTests" checked> Generate sample test cases
              </label>
            </div>

            <div class="modal-buttons mt-4">
              <button onclick="mcpCloseModal()" class="modal-btn modal-btn-cancel">Cancel</button>
              <button onclick="mcpImport()" id="mcpImportBtn" class="modal-btn modal-btn-confirm">
                Import Tools
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- App version footer -->
    <div id="app-version-footer" style="text-align:center; padding:12px 0 16px; margin-top:24px;">
      <span id="app-version" style="font-family:'Space Mono',monospace; font-size:11px; color:#63636B;"></span>
    </div>

  </main>

  <!-- ═══════════════════════════ SCRIPT ═══════════════════════════ -->
  <script>
    // --- Auth state ---
    let authToken = localStorage.getItem('auth_token') || null;
    let currentUser = null;

    // --- Auth-aware fetch wrapper ---
    async function apiFetch(url, options = {}) {
      if (!options.headers) options.headers = {};
      if (authToken) {
        options.headers['Authorization'] = `Bearer ${authToken}`;
      }
      if (options.body && !options.headers['Content-Type']) {
        options.headers['Content-Type'] = 'application/json';
      }
      const res = await fetch(url, options);
      if (res.status === 401) {
        // Try refresh
        const refreshed = await tryRefreshToken();
        if (refreshed) {
          options.headers['Authorization'] = `Bearer ${authToken}`;
          return fetch(url, options);
        }
        // Refresh failed - show landing
        showLandingPage();
        throw new Error('Authentication required');
      }
      return res;
    }

    async function tryRefreshToken() {
      try {
        const res = await fetch('/api/auth/refresh', { method: 'POST', credentials: 'include' });
        if (!res.ok) return false;
        const data = await res.json();
        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('auth_token', authToken);
        updateAuthUI();
        return true;
      } catch {
        return false;
      }
    }

    // -------------------------------------------------------------------
    // State
    // -------------------------------------------------------------------
    let config = null;
    let selectedModels = new Set(); // stores "provider_key::model_id" compound keys
    let currentResults = [];
    let toksChart = null;
    let ttftChart = null;
    let scatterChart = null;
    let cachedEnvKeys = [];
    let discoveredModelsCache = {}; // providerKey -> [{id, display_name}]
    let _lastBenchmarkBody = null;
    let providerProgress = {}; // provider -> {currentModel, currentRun, totalRuns, completedSteps, totalSteps, status, errors[]}

    const POSITION_LABELS = ['P1', 'P2', 'P3'];

    // -------------------------------------------------------------------
    // Notification Widget — Job Store + WebSocket + Rendering
    // -------------------------------------------------------------------
    const NOTIF_WS_PATH = '/ws';
    const NOTIF_JOBS_API = '/api/jobs';
    const NOTIF_MAX_RECENT = 10;

    const JOB_TYPE_ICONS = {
      benchmark:            '\u{1F680}',
      tool_eval:            '\u{1F527}',
      judge:                '\u2696\uFE0F',
      judge_compare:        '\u2696\uFE0F',
      param_tune:           '\u2699\uFE0F',
      prompt_tune:          '\u{1F4DD}',
      scheduled_benchmark:  '\u23F0',
    };
    const JOB_TYPE_LABELS = {
      benchmark:            'Benchmark',
      tool_eval:            'Tool Eval',
      judge:                'Judge',
      judge_compare:        'Judge Compare',
      param_tune:           'Param Tuner',
      prompt_tune:          'Prompt Tuner',
      scheduled_benchmark:  'Scheduled',
    };
    const ACTIVE_STATUSES = new Set(['pending', 'running', 'queued']);

    // Job store — keyed by job id
    let _jobStore = {};
    let _notifDropdownOpen = false;
    let _notifWs = null;
    let _notifWsRetryMs = 1000;
    let _notifWsMaxRetryMs = 30000;
    let _notifWsTimer = null;
    let _notifWsFailCount = 0;
    let _notifWsFailWindowStart = 0;
    const _NOTIF_WS_FAIL_THRESHOLD = 5;
    const _NOTIF_WS_FAIL_WINDOW_MS = 60000;

    // ── WebSocket Manager ──
    function notifWsConnect() {
      if (!authToken) return;
      const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
      const url = `${proto}//${location.host}${NOTIF_WS_PATH}?token=${encodeURIComponent(authToken)}`;

      _notifWsSetStatus('connecting');

      try {
        _notifWs = new WebSocket(url);
      } catch (e) {
        console.warn('[NotifWS] Failed to create WebSocket:', e);
        _notifWsTrackFailure();
        _notifWsScheduleRetry();
        return;
      }

      _notifWs.onopen = () => {
        console.log('[NotifWS] Connected');
        _notifWsRetryMs = 1000;
        _notifWsFailCount = 0;
        _notifWsSetStatus('connected');
        _notifWsHideWarning();
        _notifStartPing();
      };

      _notifWs.onmessage = (evt) => {
        try {
          const msg = JSON.parse(evt.data);
          _notifHandleWsMessage(msg);
        } catch (e) {
          console.warn('[NotifWS] Bad message:', e);
        }
      };

      _notifWs.onclose = (evt) => {
        console.log('[NotifWS] Closed:', evt.code, evt.reason);
        _notifStopPing();
        _notifWsSetStatus('disconnected');
        if (evt.code !== 1000) {
          _notifWsTrackFailure();
          _notifWsScheduleRetry();
        }
      };

      _notifWs.onerror = () => {
        _notifWsSetStatus('disconnected');
      };
    }

    function notifWsDisconnect() {
      _notifStopPing();
      _notifWsFailCount = 0;
      _notifWsHideWarning();
      if (_notifWsTimer) { clearTimeout(_notifWsTimer); _notifWsTimer = null; }
      if (_notifWs) { _notifWs.close(1000); _notifWs = null; }
      _notifWsSetStatus('disconnected');
    }

    async function _notifWsScheduleRetry() {
      if (_notifWsTimer) clearTimeout(_notifWsTimer);
      // Add jitter (0-1s) to prevent thundering herd on Cloudflare reconnects
      const jitter = Math.random() * 1000;
      const delay = _notifWsRetryMs + jitter;
      _notifWsTimer = setTimeout(async () => {
        _notifWsTimer = null;
        // Refresh JWT before reconnecting (may have expired during long sessions)
        const refreshed = await tryRefreshToken();
        if (!refreshed && !authToken) {
          console.warn('[NotifWS] Token refresh failed, cannot reconnect');
          _notifWsSetStatus('disconnected');
          return;
        }
        notifWsConnect();
      }, delay);
      _notifWsRetryMs = Math.min(_notifWsRetryMs * 2, _notifWsMaxRetryMs);
    }

    // ── Consecutive failure tracking ──
    function _notifWsTrackFailure() {
      const now = Date.now();
      if (now - _notifWsFailWindowStart > _NOTIF_WS_FAIL_WINDOW_MS) {
        _notifWsFailCount = 0;
        _notifWsFailWindowStart = now;
      }
      _notifWsFailCount++;
      if (_notifWsFailCount >= _NOTIF_WS_FAIL_THRESHOLD) {
        _notifWsShowWarning();
      }
    }

    function _notifWsShowWarning() {
      let banner = document.getElementById('notifWsBanner');
      if (banner) return; // already showing
      banner = document.createElement('div');
      banner.id = 'notifWsBanner';
      banner.className = 'text-[11px] font-body px-4 py-2';
      banner.style.cssText = 'background:rgba(234,179,8,0.1);color:#EAB308;border-bottom:1px solid rgba(234,179,8,0.2);';
      banner.textContent = 'Real-time connection lost. Retrying\u2026 If this persists, check your network.';
      const header = document.getElementById('appHeader');
      if (header) header.parentNode.insertBefore(banner, header.nextSibling);
    }

    function _notifWsHideWarning() {
      const banner = document.getElementById('notifWsBanner');
      if (banner) banner.remove();
    }

    function _notifWsSetStatus(status) {
      const badge = document.getElementById('notifBadge');
      if (!badge) return;
      badge.classList.remove('ws-connected', 'ws-disconnected', 'ws-connecting');
      badge.classList.add('ws-' + status);
      badge.title = 'WebSocket ' + status;
    }

    // ── Ping keep-alive ──
    let _notifPingInterval = null;

    function _notifStartPing() {
      _notifStopPing();
      _notifPingInterval = setInterval(() => {
        if (_notifWs && _notifWs.readyState === WebSocket.OPEN) {
          _notifWs.send(JSON.stringify({ type: 'ping' }));
        }
      }, 30000);
    }

    function _notifStopPing() {
      if (_notifPingInterval) { clearInterval(_notifPingInterval); _notifPingInterval = null; }
    }

    // ── WebSocket Message Handler ──
    function _notifHandleWsMessage(msg) {
      // Handle sync message (sent on connect with full job state)
      if (msg.type === 'sync') {
        _jobStore = {};
        for (const job of (msg.active_jobs || [])) {
          _jobStore[job.id] = job;
          // Restore inline benchmark progress if there's an active benchmark job
          if (job.job_type === 'benchmark' && (job.status === 'running' || job.status === 'pending' || job.status === 'queued')) {
            _activeBenchmarkJobId = job.id;
            _restoreBenchmarkInlineProgress(job);
          }
          // Restore tool eval tracking if there's an active tool_eval job
          if (job.job_type === 'tool_eval' && (job.status === 'running' || job.status === 'pending' || job.status === 'queued')) {
            _activeToolEvalJobId = job.id;
          }
          // Restore judge tracking if there's an active judge/judge_compare job
          if ((job.job_type === 'judge' || job.job_type === 'judge_compare') && (job.status === 'running' || job.status === 'pending' || job.status === 'queued')) {
            _activeJudgeJobId = job.id;
          }
          // Restore param tuner tracking if there's an active param_tune job
          if (job.job_type === 'param_tune' && (job.status === 'running' || job.status === 'pending' || job.status === 'queued')) {
            _activeParamTuneJobId = job.id;
            _ptJobStartedAt = job.started_at || null;
            // Restore tune_id from result_ref (set early by backend) or sessionStorage
            if (job.result_ref) {
              _activeParamTuneRunId = job.result_ref;
              try { sessionStorage.setItem('_ptRunId', job.result_ref); } catch {}
            } else if (!_activeParamTuneRunId) {
              try { _activeParamTuneRunId = sessionStorage.getItem('_ptRunId'); } catch {}
            }
          }
          // Restore prompt tuner tracking if there's an active prompt_tune job
          if (job.job_type === 'prompt_tune' && (job.status === 'running' || job.status === 'pending' || job.status === 'queued')) {
            _activePromptTuneJobId = job.id;
            if (job.result_ref) {
              _activePromptTuneRunId = job.result_ref;
              try { sessionStorage.setItem('_prtRunId', job.result_ref); } catch {}
            } else if (!_activePromptTuneRunId) {
              try { _activePromptTuneRunId = sessionStorage.getItem('_prtRunId'); } catch {}
            }
          }
        }
        for (const job of (msg.recent_jobs || [])) { _jobStore[job.id] = job; }
        notifRender();
        return;
      }

      // Handle pong (keep-alive response)
      if (msg.type === 'pong') return;

      const jobId = msg.job_id;
      if (!jobId) return;

      switch (msg.type) {
        case 'job_created':
        case 'job_queued':
          _jobStore[jobId] = {
            id: jobId,
            job_type: msg.job_type || 'benchmark',
            status: msg.status || 'pending',
            progress_pct: msg.progress_pct || 0,
            progress_detail: msg.progress_detail || JOB_TYPE_LABELS[msg.job_type] + ' queued',
            result_ref: null,
            created_at: msg.timestamp || new Date().toISOString(),
            started_at: null,
            completed_at: null,
            error_msg: null,
          };
          break;

        case 'job_started':
          if (_jobStore[jobId]) {
            _jobStore[jobId].status = 'running';
            _jobStore[jobId].started_at = msg.timestamp || new Date().toISOString();
            if (msg.progress_detail) _jobStore[jobId].progress_detail = msg.progress_detail;
          }
          break;

        case 'job_progress':
          if (_jobStore[jobId]) {
            _jobStore[jobId].progress_pct = msg.progress_pct || _jobStore[jobId].progress_pct;
            if (msg.progress_detail) _jobStore[jobId].progress_detail = msg.progress_detail;
            _jobStore[jobId].status = 'running';
          }
          break;

        case 'job_completed':
          if (_jobStore[jobId]) {
            _jobStore[jobId].status = 'done';
            _jobStore[jobId].progress_pct = 100;
            _jobStore[jobId].completed_at = msg.timestamp || new Date().toISOString();
            if (msg.result_ref) _jobStore[jobId].result_ref = msg.result_ref;
            if (msg.progress_detail) _jobStore[jobId].progress_detail = msg.progress_detail;
          }
          break;

        case 'job_failed':
          if (_jobStore[jobId]) {
            _jobStore[jobId].status = 'failed';
            _jobStore[jobId].completed_at = msg.timestamp || new Date().toISOString();
            _jobStore[jobId].error_msg = msg.error || msg.error_msg || 'Unknown error';
            if (msg.progress_detail) _jobStore[jobId].progress_detail = msg.progress_detail;
          }
          break;

        case 'job_cancelled':
          if (_jobStore[jobId]) {
            _jobStore[jobId].status = 'cancelled';
            _jobStore[jobId].completed_at = msg.timestamp || new Date().toISOString();
          }
          break;

        // Benchmark-specific streaming events — pass through to inline handler
        case 'benchmark_init':
        case 'benchmark_result':
        case 'benchmark_progress':
          break;

        // Param tune-specific streaming events — pass through to inline handler
        case 'tune_start':
        case 'combo_result':
        case 'tune_complete':
          break;

        // Tool eval-specific streaming events — pass through to inline handler
        case 'tool_eval_init':
        case 'tool_eval_result':
        case 'tool_eval_progress':
        case 'tool_eval_summary':
        case 'tool_eval_complete':
        case 'judge_verdict':
        case 'judge_report':
        case 'judge_complete':
        case 'judge_start':
        case 'judge_progress':
        case 'compare_case':
        case 'compare_start':
        case 'compare_complete':
        // Param tune domain events — pass through to inline handler
        case 'tune_start':
        case 'tune_complete':
        case 'combo_result':
        // Prompt tune domain events — pass through to inline handler
        case 'generation_start':
        case 'generation_complete':
        case 'generation_error':
        case 'prompt_generated':
        case 'prompt_eval_start':
        case 'prompt_eval_result':
        case 'eval_promoted':
          break;

        default:
          console.log('[NotifWS] Unknown message type:', msg.type);
          return;
      }

      notifRender();

      // Bridge: forward job events to inline benchmark progress if applicable
      if (typeof _onBenchmarkJobEvent === 'function') {
        _onBenchmarkJobEvent(msg);
      }
      // Bridge: forward job events to inline param tuner progress
      if (typeof _onParamTuneJobEvent === 'function') {
        _onParamTuneJobEvent(msg);
      }
      // Bridge: forward job events to inline tool eval and judge progress
      if (typeof _onToolEvalJobEvent === 'function') {
        _onToolEvalJobEvent(msg);
      }
      // Bridge: forward job events to inline prompt tuner progress
      if (typeof _onPromptTuneJobEvent === 'function') {
        _onPromptTuneJobEvent(msg);
      }
    }

    // ── Hydrate from REST API ──
    async function notifHydrate() {
      try {
        const res = await apiFetch(NOTIF_JOBS_API);
        if (!res.ok) return;
        const jobs = await res.json();
        // Merge into store (API is source of truth on load)
        for (const job of (Array.isArray(jobs) ? jobs : jobs.jobs || [])) {
          _jobStore[job.id] = job;
          // Restore tool eval tracking from hydrated jobs
          if (job.job_type === 'tool_eval' && ACTIVE_STATUSES.has(job.status)) {
            _activeToolEvalJobId = job.id;
          }
          if ((job.job_type === 'judge' || job.job_type === 'judge_compare') && ACTIVE_STATUSES.has(job.status)) {
            _activeJudgeJobId = job.id;
          }
          // Restore param tuner tracking from hydrated jobs
          if (job.job_type === 'param_tune' && ACTIVE_STATUSES.has(job.status)) {
            _activeParamTuneJobId = job.id;
            _ptJobStartedAt = job.started_at || null;
            if (job.result_ref) {
              _activeParamTuneRunId = job.result_ref;
              try { sessionStorage.setItem('_ptRunId', job.result_ref); } catch {}
            } else if (!_activeParamTuneRunId) {
              try { _activeParamTuneRunId = sessionStorage.getItem('_ptRunId'); } catch {}
            }
          }
          // Restore prompt tuner tracking from hydrated jobs
          if (job.job_type === 'prompt_tune' && ACTIVE_STATUSES.has(job.status)) {
            _activePromptTuneJobId = job.id;
            if (job.result_ref) {
              _activePromptTuneRunId = job.result_ref;
              try { sessionStorage.setItem('_prtRunId', job.result_ref); } catch {}
            } else if (!_activePromptTuneRunId) {
              try { _activePromptTuneRunId = sessionStorage.getItem('_prtRunId'); } catch {}
            }
          }
        }
        notifRender();
      } catch (e) {
        console.warn('[Notif] Hydration failed:', e);
      }
    }

    // ── Cancel a Job ──
    async function notifCancelJob(jobId) {
      try {
        const res = await apiFetch(`${NOTIF_JOBS_API}/${jobId}/cancel`, { method: 'POST' });
        if (res.ok) {
          const body = await res.json().catch(() => ({}));
          const wasOrphan = body.was_orphan === true;
          if (_jobStore[jobId]) {
            _jobStore[jobId].status = wasOrphan ? 'interrupted' : 'cancelled';
            _jobStore[jobId].completed_at = _jobStore[jobId].completed_at || new Date().toISOString();
          }
          notifRender();
          showToast(wasOrphan ? 'Run already stopped' : 'Process cancelled', '');
        } else if (res.status === 400) {
          // Ghost job: backend says job already finished (interrupted/done/failed/cancelled)
          // Treat as success — update local state to reflect terminal status
          if (_jobStore[jobId]) {
            _jobStore[jobId].status = _jobStore[jobId].status === 'running' ? 'interrupted' : _jobStore[jobId].status;
            _jobStore[jobId].completed_at = _jobStore[jobId].completed_at || new Date().toISOString();
          }
          notifRender();
          showToast('Run already stopped', '');
        } else {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || 'Failed to cancel', 'error');
        }
      } catch (e) {
        showToast('Cancel failed: ' + e.message, 'error');
      }
    }

    // ── Rendering ──
    function notifRender() {
      const allJobs = Object.values(_jobStore);
      const running = allJobs
        .filter(j => j.status === 'running')
        .sort((a, b) => (a.created_at || '').localeCompare(b.created_at || ''));
      const queued = allJobs
        .filter(j => j.status === 'pending' || j.status === 'queued')
        .sort((a, b) => (a.created_at || '').localeCompare(b.created_at || ''));
      const active = [...running, ...queued];
      const recent = allJobs
        .filter(j => !ACTIVE_STATUSES.has(j.status))
        .sort((a, b) => (b.completed_at || b.created_at || '').localeCompare(a.completed_at || a.created_at || ''))
        .slice(0, NOTIF_MAX_RECENT);

      // Badge
      const badge = document.getElementById('notifBadge');
      const count = active.length;
      const prevCount = parseInt(badge.dataset.count || '0', 10);
      badge.dataset.count = count;
      badge.textContent = count > 0 ? (count > 99 ? '99+' : count) : '';
      if (count > prevCount && count > 0) {
        badge.classList.remove('pulse');
        void badge.offsetWidth; // trigger reflow for re-animation
        badge.classList.add('pulse');
      }

      // Active list — grouped by Running then Queued
      const activeLabel = document.getElementById('notifActiveLabel');
      activeLabel.textContent = running.length > 0
        ? `Running (${running.length})` + (queued.length > 0 ? ` \u00B7 Queued (${queued.length})` : '')
        : queued.length > 0 ? `Queued (${queued.length})` : 'Running';

      const activeEl = document.getElementById('notifActiveList');
      if (active.length === 0) {
        activeEl.innerHTML = '<div class="notif-empty">No active processes</div>';
      } else {
        let html = '';
        if (running.length > 0) {
          html += running.map(j => _notifRenderActiveItem(j)).join('');
        }
        if (queued.length > 0) {
          if (running.length > 0) {
            html += '<div class="notif-section-label" style="padding-top:6px;">Queued (' + queued.length + ')</div>';
          }
          html += queued.map(j => _notifRenderActiveItem(j)).join('');
        }
        activeEl.innerHTML = html;
      }

      // Recent list
      const recentEl = document.getElementById('notifRecentList');
      if (recent.length === 0) {
        recentEl.innerHTML = '<div class="notif-empty">No recent processes</div>';
      } else {
        recentEl.innerHTML = recent.map(j => _notifRenderRecentItem(j)).join('');
      }
    }

    function _notifRenderActiveItem(job) {
      const icon = JOB_TYPE_ICONS[job.job_type] || '\u{1F4CB}';
      const label = JOB_TYPE_LABELS[job.job_type] || job.job_type;
      const detail = job.progress_detail || label;
      const pct = job.progress_pct || 0;
      const isQueued = job.status === 'pending' || job.status === 'queued';
      const queuePos = job.queued_position;
      const statusText = isQueued
        ? (queuePos ? `Queue position ${queuePos}` : 'Queued')
        : `Running &middot; ${pct}%`;
      const timeAgo = _notifTimeAgo(job.created_at);

      // Make running items clickable to navigate to their view
      const clickHandler = `onclick="notifNavigateToRunning('${job.job_type}', '${job.id}')"`;
      return `<div class="notif-item" ${clickHandler} style="cursor:pointer;">
        <div class="notif-icon ${job.job_type}">${icon}</div>
        <div class="notif-body">
          <div class="notif-title">${_escHtml(detail)}</div>
          ${isQueued ? '' : `<div class="notif-progress"><div class="notif-progress-bar" style="width:${pct}%"></div></div>`}
          <div class="notif-meta">
            <span>${statusText}</span>
            <span>${timeAgo}</span>
          </div>
        </div>
        <button class="notif-cancel" onclick="event.stopPropagation(); notifCancelJob('${job.id}')" title="Cancel">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
        </button>
      </div>`;
    }

    function _notifRenderRecentItem(job) {
      const icon = JOB_TYPE_ICONS[job.job_type] || '\u{1F4CB}';
      const detail = job.progress_detail || JOB_TYPE_LABELS[job.job_type] || job.job_type;
      const timeAgo = _notifTimeAgo(job.completed_at || job.created_at);
      const statusClass = job.status;
      const statusLabel = job.status === 'done' ? 'Done' : job.status === 'failed' ? 'Failed' : job.status === 'cancelled' ? 'Cancelled' : job.status === 'interrupted' ? 'Interrupted' : job.status;
      const clickable = job.status === 'done' && job.result_ref ? ` onclick="notifNavigateToResult('${job.job_type}', '${job.result_ref}')" style="cursor:pointer;"` : '';
      const errorTip = job.error_msg ? ` title="${_escHtml(job.error_msg)}"` : '';

      return `<div class="notif-item"${clickable}${errorTip}>
        <div class="notif-icon ${job.job_type}">${icon}</div>
        <div class="notif-body">
          <div class="notif-title">${_escHtml(detail)}</div>
          <div class="notif-meta">
            <span class="notif-status-badge ${statusClass}">${statusLabel}</span>
            <span>${timeAgo}</span>
          </div>
        </div>
      </div>`;
    }

    // ── Navigate to Running Job ──
    function notifNavigateToRunning(jobType, jobId) {
      // Close dropdown first
      _notifDropdownOpen = false;
      document.getElementById('notifDropdown').classList.remove('open');

      switch (jobType) {
        case 'benchmark':
          showTab('benchmark');
          break;
        case 'param_tune':
          showTab('tool-eval');
          // Reconnect to the running tune — try multiple sources for tune_id
          {
            let tuneId = _activeParamTuneRunId;
            if (!tuneId && _activeParamTuneJobId) {
              tuneId = _jobStore[_activeParamTuneJobId]?.result_ref;
            }
            if (!tuneId) {
              // Scan _jobStore for any running param_tune with result_ref
              const ptJob = Object.values(_jobStore).find(
                j => j.job_type === 'param_tune' && ACTIVE_STATUSES.has(j.status) && j.result_ref
              );
              if (ptJob) tuneId = ptJob.result_ref;
            }
            if (!tuneId) {
              try { tuneId = sessionStorage.getItem('_ptRunId'); } catch {}
            }
            if (tuneId) {
              ptViewHistoryRun(tuneId);
            } else {
              showToolEvalView('pt-history');
            }
          }
          break;
        case 'tool_eval':
          showTab('tool-eval');
          // showTab already handles active tool eval job restoration via _teRestoreRunningEval
          break;
        case 'judge':
        case 'judge_compare':
          showTab('tool-eval');
          showToolEvalView('jg-history');
          break;
        default:
          showTab('tool-eval');
          break;
      }
    }

    // ── Navigate to Completed Result ──
    function notifNavigateToResult(jobType, resultRef) {
      // Close dropdown first
      _notifDropdownOpen = false;
      document.getElementById('notifDropdown').classList.remove('open');

      switch (jobType) {
        case 'benchmark':
          showTab('history');
          break;
        case 'tool_eval':
          showTab('tool-eval');
          if (resultRef) {
            teViewHistoryRun(resultRef);
          } else {
            showToolEvalView('history');
          }
          break;
        case 'judge':
        case 'judge_compare':
          showTab('tool-eval');
          showToolEvalView('jg-history');
          break;
        case 'param_tune':
          showTab('tool-eval');
          // Navigate to completed tune result
          if (resultRef) {
            ptViewHistoryRun(resultRef);
          } else {
            showToolEvalView('pt-history');
          }
          break;
        case 'prompt_tune':
          showTab('tool-eval');
          if (resultRef) {
            prtViewHistoryRun(resultRef);
          } else {
            showToolEvalView('prt-history');
          }
          break;
        case 'scheduled_benchmark':
          showTab('schedules');
          break;
      }
    }

    // ── Dropdown Toggle ──
    function toggleNotifDropdown() {
      _notifDropdownOpen = !_notifDropdownOpen;
      document.getElementById('notifDropdown').classList.toggle('open', _notifDropdownOpen);
    }

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
      const widget = document.getElementById('notifWidget');
      if (widget && !widget.contains(e.target) && _notifDropdownOpen) {
        _notifDropdownOpen = false;
        document.getElementById('notifDropdown').classList.remove('open');
      }
    });

    // ── Helpers ──
    function _notifTimeAgo(isoStr) {
      if (!isoStr) return '';
      const diff = Date.now() - new Date(isoStr).getTime();
      const mins = Math.floor(diff / 60000);
      if (mins < 1) return 'just now';
      if (mins < 60) return mins + 'm ago';
      const hrs = Math.floor(mins / 60);
      if (hrs < 24) return hrs + 'h ago';
      const days = Math.floor(hrs / 24);
      return days + 'd ago';
    }

    function _escHtml(str) {
      const d = document.createElement('div');
      d.textContent = str;
      return d.innerHTML;
    }

    // ── Init (called after login) ──
    function notifInit() {
      document.getElementById('notifWidget').style.display = '';
      // WebSocket connect sends a sync message with full state.
      // We also hydrate via REST as a fallback (in case WS fails).
      notifWsConnect();
      notifHydrate();
    }

    // ── Cleanup (called on logout) ──
    function notifDestroy() {
      notifWsDisconnect();
      _jobStore = {};
      _activeBenchmarkJobId = null;
      try { _activeParamTuneJobId = null; _activeParamTuneRunId = null; } catch {}
      try { sessionStorage.removeItem('_ptRunId'); } catch {}
      try { _activePromptTuneJobId = null; _activePromptTuneRunId = null; } catch {}
      try { sessionStorage.removeItem('_prtRunId'); } catch {}
      document.getElementById('notifWidget').style.display = 'none';
      const badge = document.getElementById('notifBadge');
      badge.dataset.count = '0';
      badge.textContent = '';
    }

    // -------------------------------------------------------------------
    // Toast notifications
    // -------------------------------------------------------------------
    function showToast(message, type = '') {
      const container = document.getElementById('toastContainer');
      const el = document.createElement('div');
      el.className = `toast ${type ? 'toast-' + type : ''}`;
      el.textContent = message;
      container.appendChild(el);
      setTimeout(() => { el.classList.add('toast-out'); setTimeout(() => el.remove(), 300); }, 3000);
    }

    // -------------------------------------------------------------------
    // Modal system
    // -------------------------------------------------------------------
    function _closeModal(overlay) {
      overlay.classList.add('modal-closing');
      setTimeout(() => overlay.remove(), 200);
    }

    function showModal(title, message, onConfirm, opts = {}) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      const danger = opts.danger || false;
      overlay.innerHTML = `<div class="modal-box">
        <div class="modal-title">${title}</div>
        <div class="modal-message">${message}</div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn ${danger ? 'modal-btn-danger' : 'modal-btn-confirm'}" data-action="confirm">${opts.confirmLabel || 'Confirm'}</button>
        </div>
      </div>`;
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => { _closeModal(overlay); onConfirm(); };
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
    }

    function showInputModal(title, placeholder, onConfirm, opts = {}) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `<div class="modal-box">
        <div class="modal-title">${title}</div>
        ${opts.message ? `<div class="modal-message">${opts.message}</div>` : ''}
        <input class="modal-input" placeholder="${placeholder}" ${opts.inputType ? `type="${opts.inputType}"` : ''} value="${opts.defaultValue || ''}">
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">${opts.confirmLabel || 'OK'}</button>
        </div>
      </div>`;
      const input = overlay.querySelector('.modal-input');
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => { const v = input.value; _closeModal(overlay); onConfirm(v); };
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const v = input.value; _closeModal(overlay); onConfirm(v); } });
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => input.focus(), 50);
    }

    function showDoubleInputModal(title, fields, onConfirm) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      let fieldsHtml = fields.map((f, i) => `<div style="margin-bottom:${i < fields.length-1 ? '12px' : '16px'}"><div style="font-size:11px;color:#85858F;margin-bottom:4px;font-family:'Chakra Petch',sans-serif;text-transform:uppercase;letter-spacing:0.04em">${f.label}</div><input class="modal-input" style="margin-bottom:0" placeholder="${f.placeholder || ''}" ${f.type ? `type="${f.type}"` : ''}></div>`).join('');
      overlay.innerHTML = `<div class="modal-box">
        <div class="modal-title">${title}</div>
        ${fieldsHtml}
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">OK</button>
        </div>
      </div>`;
      const inputs = overlay.querySelectorAll('.modal-input');
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => { const vals = [...inputs].map(i => i.value); _closeModal(overlay); onConfirm(...vals); };
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => inputs[0]?.focus(), 50);
    }

    const PROVIDER_COLORS = {
      'ZAI GLM':             { bg: 'rgba(191,255,0,0.08)',  border: 'rgba(191,255,0,0.3)',  text: '#BFFF00', bar: '#BFFF00' },
      'LM Studio (Desktop)': { bg: 'rgba(56,189,248,0.08)', border: 'rgba(56,189,248,0.3)', text: '#38BDF8', bar: '#38BDF8' },
      'LM Studio (Mac)':     { bg: 'rgba(129,140,248,0.08)',border: 'rgba(129,140,248,0.3)',text: '#818CF8', bar: '#818CF8' },
      'LM Studio (Local)':   { bg: 'rgba(56,189,248,0.08)', border: 'rgba(56,189,248,0.3)', text: '#38BDF8', bar: '#38BDF8' },
      'OpenAI':              { bg: 'rgba(168,162,158,0.08)', border: 'rgba(168,162,158,0.3)', text: '#A8A29E', bar: '#A8A29E' },
      'Anthropic':           { bg: 'rgba(251,113,133,0.08)', border: 'rgba(251,113,133,0.3)', text: '#FB7185', bar: '#FB7185' },
      'Google Gemini':       { bg: 'rgba(96,165,250,0.08)',  border: 'rgba(96,165,250,0.3)',  text: '#60A5FA', bar: '#60A5FA' },
    };
    const DEFAULT_COLOR = { bg: 'rgba(251,146,60,0.08)', border: 'rgba(251,146,60,0.3)', text: '#FB923C', bar: '#FB923C' };

    function getColor(provider) { return PROVIDER_COLORS[provider] || DEFAULT_COLOR; }

    function safeId(str) { return str.replace(/[^a-zA-Z0-9_-]/g, '_'); }

    function slugify(str) {
      return str.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
    }

    function uniqueProviderKey(base) {
      if (!config || !config.providers) return base;
      const existing = new Set(Object.values(config.providers).map(p => p.provider_key));
      if (!existing.has(base)) return base;
      for (let i = 2; i < 100; i++) {
        const candidate = `${base}_${i}`;
        if (!existing.has(candidate)) return candidate;
      }
      return base + '_' + Date.now();
    }

    function detectPrefix(models) {
      if (!models || models.length === 0) return '';
      const ids = models.map(m => m.model_id || m.id || '');
      const firstSlash = ids[0].indexOf('/');
      if (firstSlash < 1) return '';
      const candidate = ids[0].substring(0, firstSlash);
      if (ids.every(id => id.startsWith(candidate + '/'))) return candidate;
      return '';
    }

    function formatCtxSize(tokens) {
      if (tokens >= 1000000) return (tokens / 1000000).toFixed(0) + 'M ctx';
      if (tokens >= 1000) return (tokens / 1000).toFixed(0) + 'K ctx';
      return tokens + ' ctx';
    }

    // -------------------------------------------------------------------
    // Context Tiers
    // -------------------------------------------------------------------
    const TIER_OPTIONS = [
      { value: 0, label: '0' },
      { value: 1000, label: '1K' },
      { value: 5000, label: '5K' },
      { value: 10000, label: '10K' },
      { value: 20000, label: '20K' },
      { value: 50000, label: '50K' },
      { value: 100000, label: '100K' },
      { value: 150000, label: '150K' },
    ];
    let selectedTiers = new Set([0]);

    function renderTierChips() {
      const container = document.getElementById('tierChips');
      container.innerHTML = TIER_OPTIONS.map(t => {
        const selected = selectedTiers.has(t.value);
        return `<button onclick="toggleTier(${t.value})" class="text-[11px] font-mono px-3 py-1.5 rounded-sm transition-all ${selected ? '' : 'text-zinc-600 hover:text-zinc-400'}" style="${selected ? 'background:var(--lime-dim);color:var(--lime);border:1px solid rgba(191,255,0,0.3)' : 'background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle)'}">${t.label}</button>`;
      }).join('');

      // Show/hide stress test badge
      const badge = document.getElementById('tierBadge');
      if (selectedTiers.size > 1 || (selectedTiers.size === 1 && !selectedTiers.has(0))) {
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      updateTierWarnings();
    }

    function toggleTier(value) {
      if (selectedTiers.has(value)) {
        selectedTiers.delete(value);
        if (selectedTiers.size === 0) selectedTiers.add(0); // Always have at least one
      } else {
        selectedTiers.add(value);
      }
      renderTierChips();
    }

    function updateTierWarnings() {
      const container = document.getElementById('tierWarnings');
      if (!config) { container.innerHTML = ''; return; }

      const warnings = [];
      const maxTier = Math.max(...selectedTiers);

      for (const [provider, provData] of Object.entries(config.providers)) {
        const models = getProviderModels(provData);
        for (const m of models) {
          if (!selectedModels.has(_bmCompoundKey(provData.provider_key || provider, m.model_id))) continue;
          if (m.context_window && maxTier > m.context_window) {
            warnings.push(`<div class="text-[10px] font-body" style="color:#FBBF24;">${m.display_name}: ${formatCtxSize(maxTier).replace(' ctx','')} &gt; ${formatCtxSize(m.context_window)}</div>`);
          }
        }
      }
      container.innerHTML = warnings.join('');
    }

    // -------------------------------------------------------------------
    // Init
    // -------------------------------------------------------------------
    async function init() {
      try {
        const res = await apiFetch('/api/config');
        config = await res.json();
        renderModels();
        if (config.defaults?.prompt) {
          document.getElementById('prompt').value = config.defaults.prompt.trim();
        }
        if (config.defaults?.max_tokens) {
          document.getElementById('maxTokens').value = config.defaults.max_tokens;
          document.getElementById('maxTokensVal').textContent = config.defaults.max_tokens;
        }
        if (config.defaults?.temperature !== undefined) {
          document.getElementById('temperature').value = config.defaults.temperature;
          document.getElementById('tempVal').textContent = parseFloat(config.defaults.temperature).toFixed(1);
        }
        renderTierChips();
        ppLoadRegistry(); // async, non-blocking -- upgrades client-side fallback
        p10Load(); // async, non-blocking -- loads Phase 10 settings for tool eval defaults
      } catch (e) {
        console.error('Failed to load config:', e);
        document.getElementById('initErrorBanner').classList.remove('hidden');
      }
    }

    // -------------------------------------------------------------------
    // Model selection
    // -------------------------------------------------------------------
    function getProviderModels(provData) {
      // Handle both old shape (array) and new shape ({models: [...]})
      return Array.isArray(provData) ? provData : (provData.models || []);
    }

    // Helper: build compound key for selectedModels (benchmark)
    function _bmCompoundKey(providerKey, modelId) { return providerKey + '::' + modelId; }
    function _bmParseCompoundKey(key) {
      const i = key.indexOf('::');
      return { provider_key: key.substring(0, i), model_id: key.substring(i + 2) };
    }

    function renderModels() {
      const grid = document.getElementById('modelGrid');
      grid.innerHTML = '';

      for (const [provider, provData] of Object.entries(config.providers)) {
        const color = getColor(provider);
        const models = getProviderModels(provData);
        if (!models.length) continue;

        // Provider group container
        const group = document.createElement('div');
        group.className = 'provider-group';
        group.style.borderColor = color.border;

        // Provider header — click to toggle all models in group
        const header = document.createElement('div');
        header.className = 'provider-group-header';
        header.innerHTML = `
          <div class="provider-group-dot" style="background:${color.text}"></div>
          <span class="provider-group-label" style="color:${color.text}">${provider}</span>
          <span class="provider-group-count">${models.length} model${models.length > 1 ? 's' : ''}</span>
        `;
        header.onclick = () => {
          const cards = group.querySelectorAll('.model-card');
          const allSelected = [...cards].every(c => c.classList.contains('selected'));
          cards.forEach(c => {
            const ck = c.dataset.compoundKey;
            if (allSelected) { selectedModels.delete(ck); c.classList.remove('selected'); }
            else { selectedModels.add(ck); c.classList.add('selected'); }
          });
        };
        group.appendChild(header);

        // Model cards sub-grid
        const subgrid = document.createElement('div');
        subgrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 pl-3';
        for (const m of models) {
          const ck = _bmCompoundKey(provData.provider_key || provider, m.model_id);
          selectedModels.add(ck);
          const card = document.createElement('div');
          card.className = 'model-card selected rounded-sm px-4 py-3 flex items-center gap-3';
          card.dataset.modelId = m.model_id;
          card.dataset.compoundKey = ck;
          card.dataset.providerKey = provData.provider_key || provider;
          card.onclick = (e) => { e.stopPropagation(); toggleModel(ck, card); };
          card.innerHTML = `
            <div class="check-dot flex-shrink-0"></div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <div class="text-[13px] font-medium text-zinc-200 truncate font-body">${m.display_name}</div>
                ${m.context_window ? `<span class="text-[9px] font-mono px-1.5 py-0.5 rounded-sm" style="background:rgba(255,255,255,0.04);color:#85858F;">${formatCtxSize(m.context_window)}</span>` : ''}
              </div>
            </div>
          `;
          subgrid.appendChild(card);
        }
        group.appendChild(subgrid);
        grid.appendChild(group);
      }
    }

    function toggleModel(compoundKey, card) {
      if (selectedModels.has(compoundKey)) {
        selectedModels.delete(compoundKey);
        card.classList.remove('selected');
      } else {
        selectedModels.add(compoundKey);
        card.classList.add('selected');
      }
    }

    function selectAll() {
      document.querySelectorAll('#modelGrid .model-card').forEach(card => {
        selectedModels.add(card.dataset.compoundKey);
        card.classList.add('selected');
      });
    }

    function selectNone() {
      selectedModels.clear();
      document.querySelectorAll('#modelGrid .model-card').forEach(c => c.classList.remove('selected'));
    }

    // -------------------------------------------------------------------
    // Benchmark execution
    // -------------------------------------------------------------------
    function _resetRunBtn() {
      const btn = document.getElementById('runBtn');
      btn.disabled = false;
      btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Run Benchmark`;
    }

    function _showSSEError(msg) {
      const banner = document.getElementById('sseBanner');
      document.getElementById('sseBannerMsg').textContent = msg;
      banner.classList.remove('hidden');
    }

    // Track current benchmark job for inline progress
    let _activeBenchmarkJobId = null;

    async function cancelBenchmark() {
      if (_activeBenchmarkJobId) {
        notifCancelJob(_activeBenchmarkJobId);
      } else {
        // Legacy fallback
        try {
          await apiFetch('/api/benchmark/cancel', { method: 'POST' });
          showToast('Cancellation requested...', '');
        } catch (e) {
          showToast('Failed to cancel', 'error');
        }
      }
    }

    function retryBenchmark() {
      document.getElementById('sseBanner').classList.add('hidden');
      if (_lastBenchmarkBody) startBenchmark(_lastBenchmarkBody);
    }

    async function startBenchmark(overrideBody) {
      if (!overrideBody && selectedModels.size === 0) {
        showToast('Select at least one model', 'error');
        return;
      }

      const btn = document.getElementById('runBtn');
      btn.disabled = true;
      btn.innerHTML = `<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> RUNNING...`;

      currentResults = [];
      document.getElementById('progressSection').classList.remove('hidden');
      document.getElementById('progressSkipped').innerHTML = '';
      document.getElementById('sseBanner').classList.add('hidden');
      document.getElementById('resultsSection').classList.add('hidden');

      const body = overrideBody || {
        targets: Array.from(selectedModels).map(k => _bmParseCompoundKey(k)),
        runs: parseInt(document.getElementById('runs').value),
        max_tokens: parseInt(document.getElementById('maxTokens').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        prompt: document.getElementById('prompt').value,
        context_tiers: Array.from(selectedTiers).sort((a, b) => a - b),
        warmup: document.getElementById('warmupToggle').checked,
      };
      _lastBenchmarkBody = body;

      // Initialize progress display
      document.getElementById('progressLabel').textContent = 'Submitting benchmark...';
      document.getElementById('progressCount').textContent = '0%';
      // Initialize per-provider progress tracking
      initProviderProgress(body);
      renderProviderProgress();

      try {
        const res = await apiFetch('/api/benchmark', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          if (res.status === 429) {
            showToast(err.error || 'Rate limit exceeded', 'error');
          } else {
            showToast(err.error || `Server error (${res.status})`, 'error');
          }
          _resetRunBtn();
          document.getElementById('progressSection').classList.add('hidden');
          return;
        }

        // New job-based response: {job_id, status}
        const data = await res.json();
        _activeBenchmarkJobId = data.job_id;

        // Update UI to show job is submitted
        document.getElementById('progressLabel').textContent = data.status === 'submitted' ? 'Benchmark queued...' : 'Benchmark starting...';
        showToast('Benchmark submitted', 'success');

        // Progress updates now arrive via WebSocket (handled by _onBenchmarkJobEvent)
        // User can navigate away — the notification widget tracks progress independently

      } catch (e) {
        console.error('Benchmark error:', e);
        _showSSEError('Connection error: ' + (e.message || 'Network failure'));
        _resetRunBtn();
      }
    }

    // ── WebSocket event bridge for inline benchmark progress ──
    // Called by _notifHandleWsMessage when a job event matches _activeBenchmarkJobId
    function _onBenchmarkJobEvent(msg) {
      if (!_activeBenchmarkJobId || msg.job_id !== _activeBenchmarkJobId) return;

      switch (msg.type) {
        case 'job_started':
          document.getElementById('progressLabel').textContent = 'Benchmark running...';
          break;

        case 'job_progress':
          document.getElementById('progressLabel').textContent = msg.progress_detail || 'Running...';
          document.getElementById('progressCount').textContent = (msg.progress_pct || 0) + '%';
          break;

        // ── Live streaming events from backend ──

        case 'benchmark_init':
          // Re-initialize per-provider progress from backend-provided config
          if (msg.data) {
            initProviderProgress(msg.data);
            renderProviderProgress();
          }
          break;

        case 'benchmark_progress':
          // Per-provider progress update (which model, which run)
          // msg.data contains {type:'progress', provider, model, run, runs, context_tokens}
          if (msg.data) handleSSE(msg.data);
          break;

        case 'benchmark_result':
          // Individual model result — feed into live charts
          // msg.data contains {type:'result', provider, model, tokens_per_second, ...}
          if (msg.data) handleSSE(msg.data);
          break;

        case 'job_completed':
          // Mark all providers as done in per-provider progress
          handleSSE({ type: 'complete' });
          _activeBenchmarkJobId = null;
          _resetRunBtn();
          showToast('Benchmark complete', 'success');
          // Fetch and display final results (safety net — replaces live data with saved data)
          _loadBenchmarkJobResults(msg.result_ref);
          break;

        case 'job_failed':
          document.getElementById('progressSection').classList.add('hidden');
          _activeBenchmarkJobId = null;
          _resetRunBtn();
          _showSSEError(msg.error || msg.error_msg || 'Benchmark failed');
          break;

        case 'job_cancelled':
          document.getElementById('progressSection').classList.add('hidden');
          _activeBenchmarkJobId = null;
          _resetRunBtn();
          showToast('Benchmark cancelled', '');
          break;
      }
    }

    async function _loadBenchmarkJobResults(resultRef) {
      if (!resultRef) return;
      try {
        const res = await apiFetch(`/api/history/${resultRef}`);
        if (!res.ok) {
          showToast('Failed to load results', 'error');
          return;
        }
        const data = await res.json();
        // Populate currentResults from the saved run data
        currentResults = (data.results || []).map(r => ({
          ...r,
          type: 'result',
          success: r.success !== false,
        }));
        document.getElementById('resultsSection').classList.remove('hidden');
        if (currentResults.length === 0 || currentResults.every(r => !r.success)) {
          const failedErrors = currentResults.filter(r => !r.success && r.error).map(r => `<div class="text-[11px] font-mono mt-1" style="color:#FCA5A5;word-break:break-word;cursor:pointer;" onclick="navigator.clipboard.writeText(this.textContent).then(()=>showToast('Copied','success'))" title="Click to copy">${r.provider}/${r.model}: ${r.error}</div>`);
          document.getElementById('statCards').innerHTML = `<div class="col-span-full error-banner" style="flex-direction:column;align-items:flex-start;"><div>All benchmarks failed. Check your API keys and model configuration.</div>${failedErrors.length > 0 ? '<div class="w-full mt-2 pt-2" style="border-top:1px solid rgba(255,59,92,0.2);">' + failedErrors.join('') + '</div>' : ''}</div>`;
        }
        renderFinalResults();
      } catch (e) {
        console.error('Failed to load benchmark results:', e);
        showToast('Failed to load results', 'error');
      }
    }

    // ── Restore inline benchmark progress on page load/reconnect ──
    function _restoreBenchmarkInlineProgress(job) {
      const btn = document.getElementById('runBtn');
      btn.disabled = true;
      btn.innerHTML = `<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> RUNNING...`;
      document.getElementById('progressSection').classList.remove('hidden');
      document.getElementById('resultsSection').classList.add('hidden');
      document.getElementById('providerProgressPanel').innerHTML = '';
      document.getElementById('sseBanner').classList.add('hidden');
      const isQueued = job.status === 'pending' || job.status === 'queued';
      document.getElementById('progressLabel').textContent = isQueued
        ? 'Benchmark queued...'
        : (job.progress_detail || 'Benchmark running...');
      document.getElementById('progressCount').textContent = (job.progress_pct || 0) + '%';
    }

    // -------------------------------------------------------------------
    // Per-provider progress tracking
    // -------------------------------------------------------------------
    function initProviderProgress(body) {
      providerProgress = {};
      if (!config || !config.providers) return;

      // Build a set of compound keys from targets (new) or model_ids (legacy)
      let selectedSet;
      if (body.targets && Array.isArray(body.targets)) {
        selectedSet = new Set(body.targets.map(t => t.provider_key + '::' + t.model_id));
      } else {
        selectedSet = new Set((body.models || []).map(m => typeof m === 'string' ? m : ''));
      }
      const runs = body.runs || 1;
      const tiers = body.context_tiers || [0];
      const maxTokens = body.max_tokens || 4096;

      for (const [provider, provData] of Object.entries(config.providers)) {
        const models = getProviderModels(provData);
        const pk = provData.provider_key || provider;
        const selectedInProvider = body.targets
          ? models.filter(m => selectedSet.has(pk + '::' + m.model_id))
          : models.filter(m => selectedSet.has(m.model_id));
        if (selectedInProvider.length === 0) continue;

        // Count steps: for each model, for each tier, count runs (skip tiers that exceed context window)
        let totalSteps = 0;
        for (const m of selectedInProvider) {
          for (const tier of tiers) {
            const headroom = (m.context_window || Infinity) - maxTokens - 100;
            if (tier === 0 || tier <= headroom) {
              totalSteps += runs;
            }
          }
        }

        providerProgress[provider] = {
          currentModel: null,
          currentRun: 0,
          totalRuns: runs,
          completedSteps: 0,
          totalSteps: totalSteps,
          status: 'waiting', // waiting | running | done | error
          errors: [],
        };
      }
    }

    function renderProviderProgress() {
      const panel = document.getElementById('providerProgressPanel');
      if (!panel) return;

      // Update overall counter
      let totalCompleted = 0, totalAll = 0;
      for (const p of Object.values(providerProgress)) {
        totalCompleted += p.completedSteps;
        totalAll += p.totalSteps;
      }
      document.getElementById('progressCount').textContent = `${totalCompleted}/${totalAll}`;

      // Update overall label
      const runningProviders = Object.entries(providerProgress).filter(([, p]) => p.status === 'running');
      if (runningProviders.length > 0) {
        document.getElementById('progressLabel').textContent = `Running ${runningProviders.length} provider${runningProviders.length > 1 ? 's' : ''} in parallel`;
      }

      // Build rows
      const rows = [];
      for (const [name, p] of Object.entries(providerProgress)) {
        const color = getColor(name);
        const pct = p.totalSteps > 0 ? (p.completedSteps / p.totalSteps * 100) : 0;
        const isDone = p.completedSteps >= p.totalSteps;
        const hasError = p.errors.length > 0;

        let statusText = '';
        let statusIcon = '';
        if (isDone && !hasError) {
          statusText = 'Complete';
          statusIcon = '<span style="color:#4ADE80;">&#10003;</span> ';
        } else if (isDone && hasError) {
          statusText = 'Done with errors';
          statusIcon = '<span style="color:#FBBF24;">&#9888;</span> ';
        } else if (p.status === 'running' && p.currentModel) {
          const tierLabel = p.currentContextTokens > 0 ? ` @ ${p.currentContextTokens >= 1000 ? (p.currentContextTokens / 1000) + 'K' : p.currentContextTokens} ctx` : '';
          statusText = `${p.currentModel}${tierLabel} (run ${p.currentRun}/${p.totalRuns})`;
        } else {
          statusText = 'Waiting\u2026';
        }

        const barColor = hasError ? '#FBBF24' : (isDone ? '#4ADE80' : color.bar);
        const barShadow = isDone ? 'none' : `0 0 8px ${color.bar}44`;

        rows.push(`
          <div class="provider-progress-row">
            <div class="ppr-name" style="color:${color.text};" title="${name}">${name}</div>
            <div class="ppr-mid">
              <div class="ppr-status">${statusIcon}${statusText}</div>
              <div class="ppr-track">
                <div class="ppr-fill${isDone ? ' done' : ''}" style="width:${pct.toFixed(1)}%;background-color:${barColor};box-shadow:${barShadow};"></div>
              </div>
            </div>
            <div class="ppr-count">${p.completedSteps}/${p.totalSteps}</div>
          </div>
        `);
      }

      // Error details at the bottom
      const errorLines = [];
      for (const [name, p] of Object.entries(providerProgress)) {
        for (const err of p.errors) {
          errorLines.push(`<div class="text-[11px] font-body" style="color:#FB7185;">${name} / ${err.model}: ${err.message}</div>`);
        }
      }

      panel.innerHTML = rows.join('') + (errorLines.length > 0 ? '<div class="mt-3 p-3 rounded-sm flex flex-col gap-1.5" style="background:rgba(255,59,92,0.06);border:1px solid rgba(255,59,92,0.2);"><div class="text-[11px] font-display tracking-wider uppercase" style="color:#FB7185;margin-bottom:2px;">Errors</div>' + errorLines.join('') + '</div>' : '');
    }

    function handleSSE(data) {
      const prov = data.provider;

      if (data.type === 'progress') {
        // Update per-provider state
        if (prov && providerProgress[prov]) {
          const pp = providerProgress[prov];
          pp.status = 'running';
          pp.currentModel = data.model;
          pp.currentRun = data.run;
          pp.totalRuns = data.runs;
          pp.currentContextTokens = data.context_tokens || 0;
        }
        renderProviderProgress();
      }
      if (data.type === 'skipped') {
        const el = document.getElementById('progressSkipped');
        el.innerHTML += `<div class="skipped-line">&#x23ED; ${data.model}: skipped (${data.reason || 'context exceeds window'})</div>`;
      }
      if (data.type === 'result') {
        // Increment completed steps for this provider
        if (prov && providerProgress[prov]) {
          const pp = providerProgress[prov];
          pp.completedSteps++;
          if (!data.success && data.error) {
            pp.errors.push({ model: data.model, message: data.error });
          }
          // Mark provider done if all steps completed
          if (pp.completedSteps >= pp.totalSteps) {
            pp.status = 'done';
            pp.currentModel = null;
          }
          renderProviderProgress();
        }
        currentResults.push(data);
        renderLiveResults();
      }
      if (data.type === 'cancelled') {
        showToast('Benchmark cancelled', 'error');
        document.getElementById('progressSection').classList.add('hidden');
        if (currentResults.length > 0) {
          document.getElementById('resultsSection').classList.remove('hidden');
          renderFinalResults();
        }
      }
      if (data.type === 'error') {
        // Per-provider error (has provider field) vs global error
        if (prov && providerProgress[prov]) {
          const pp = providerProgress[prov];
          pp.errors.push({ model: data.model || '?', message: data.message || 'Unknown error' });
          pp.completedSteps = pp.totalSteps; // mark as done
          pp.status = 'error';
          pp.currentModel = null;
          renderProviderProgress();
        } else {
          _showSSEError(data.message || 'Benchmark error');
        }
      }
      if (data.type === 'complete') {
        // Mark all remaining providers as done
        for (const pp of Object.values(providerProgress)) {
          if (pp.status !== 'done' && pp.status !== 'error') {
            pp.status = 'done';
            pp.completedSteps = pp.totalSteps;
            pp.currentModel = null;
          }
        }
        renderProviderProgress();
        document.getElementById('progressSection').classList.add('hidden');
        document.getElementById('resultsSection').classList.remove('hidden');
        if (currentResults.length === 0 || currentResults.every(r => !r.success)) {
          const failedErrors = currentResults.filter(r => !r.success && r.error).map(r => `<div class="text-[11px] font-mono mt-1" style="color:#FCA5A5;word-break:break-word;cursor:pointer;" onclick="navigator.clipboard.writeText(this.textContent).then(()=>showToast('Copied','success'))" title="Click to copy">${r.provider}/${r.model}: ${r.error}</div>`);
          document.getElementById('statCards').innerHTML = `<div class="col-span-full error-banner" style="flex-direction:column;align-items:flex-start;"><div>All benchmarks failed. Check your API keys and model configuration.</div>${failedErrors.length > 0 ? '<div class="w-full mt-2 pt-2" style="border-top:1px solid rgba(255,59,92,0.2);">' + failedErrors.join('') + '</div>' : ''}</div>`;
        }
        renderFinalResults();
      }
    }

    // -------------------------------------------------------------------
    // Results rendering
    // -------------------------------------------------------------------
    function renderLiveResults() {
      document.getElementById('resultsSection').classList.remove('hidden');
      renderChart();
      renderTTFTChart();
      renderScatterChart();
      renderTable();
    }

    function renderFinalResults() {
      renderStatCards();
      renderChart();
      renderTTFTChart();
      renderScatterChart();
      renderTable();
    }

    function _stdDev(values) {
      if (values.length < 2) return 0;
      const mean = values.reduce((s, v) => s + v, 0) / values.length;
      const variance = values.reduce((s, v) => s + (v - mean) ** 2, 0) / (values.length - 1);
      return Math.sqrt(variance);
    }

    function _percentile(sorted, p) {
      if (sorted.length === 0) return 0;
      if (sorted.length === 1) return sorted[0];
      const idx = (p / 100) * (sorted.length - 1);
      const lo = Math.floor(idx), hi = Math.ceil(idx);
      return lo === hi ? sorted[lo] : sorted[lo] + (sorted[hi] - sorted[lo]) * (idx - lo);
    }

    function aggregateResults() {
      const grouped = {};
      for (const r of currentResults) {
        const key = `${r.model_id}::${r.provider}::${r.context_tokens || 0}`;
        if (!grouped[key]) grouped[key] = { ...r, _runs: [], _successes: 0 };
        grouped[key]._runs.push(r);
        if (r.success) grouped[key]._successes++;
      }
      return Object.values(grouped).map(g => {
        const successes = g._runs.filter(r => r.success);
        const n = successes.length;
        const tpsVals = successes.map(r => r.tokens_per_second).sort((a, b) => a - b);
        const ttftVals = successes.map(r => r.ttft_ms).sort((a, b) => a - b);
        const inputTpsVals = successes.map(r => r.input_tokens_per_second || 0).filter(v => v > 0);
        const costVals = successes.map(r => r.cost || 0);
        return {
          provider: g.provider, model: g.model, model_id: g.model_id,
          context_tokens: g.context_tokens || 0,
          tokens_per_second: n ? successes.reduce((s, r) => s + r.tokens_per_second, 0) / n : 0,
          ttft_ms: n ? successes.reduce((s, r) => s + r.ttft_ms, 0) / n : 0,
          total_time_s: n ? successes.reduce((s, r) => s + r.total_time_s, 0) / n : 0,
          output_tokens: n ? successes.reduce((s, r) => s + r.output_tokens, 0) / n : 0,
          input_tokens_per_second: inputTpsVals.length ? inputTpsVals.reduce((s, v) => s + v, 0) / inputTpsVals.length : 0,
          avg_cost: n ? costVals.reduce((s, v) => s + v, 0) / n : 0,
          total_cost: costVals.reduce((s, v) => s + v, 0),
          std_dev_tps: _stdDev(tpsVals),
          std_dev_ttft: _stdDev(ttftVals),
          p50_tps: _percentile(tpsVals, 50),
          p95_tps: _percentile(tpsVals, 95),
          min_tps: tpsVals.length ? tpsVals[0] : 0,
          max_tps: tpsVals.length ? tpsVals[tpsVals.length - 1] : 0,
          success: g._successes > 0,
          runs: g._runs.length,
          failures: g._runs.length - g._successes,
          error: g._runs.find(r => !r.success)?.error || '',
        };
      }).sort((a, b) => b.tokens_per_second - a.tokens_per_second);
    }

    function isStressMode() {
      const tiers = new Set(currentResults.map(r => r.context_tokens || 0));
      return tiers.size > 1;
    }

    function renderStatCards() {
      const agg = aggregateResults();
      const container = document.getElementById('statCards');
      if (!agg.length || !agg[0].success) { container.innerHTML = ''; return; }

      const stress = isStressMode();

      if (!stress) {
        // Standard stat cards (existing behavior)
        const winner = agg[0];
        const fastestTTFT = [...agg].filter(a => a.success).sort((a, b) => a.ttft_ms - b.ttft_ms)[0];
        const totalModels = agg.length;
        const totalFails = agg.reduce((s, a) => s + a.failures, 0);
        const grandTotalCost = agg.reduce((s, a) => s + a.total_cost, 0);

        container.innerHTML = `
          <div class="stat-card card-accent rounded-sm p-4">
            <div class="section-label mb-2">Fastest</div>
            <div class="big-num text-2xl text-zinc-100">${winner.tokens_per_second.toFixed(1)} <span class="text-xs font-normal" style="color:var(--lime)">tok/s</span></div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${winner.model}</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #38BDF8">
            <div class="section-label mb-2">Best TTFT</div>
            <div class="big-num text-2xl text-zinc-100">${fastestTTFT.ttft_ms.toFixed(0)}<span class="text-xs font-normal text-zinc-500">ms</span></div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${fastestTTFT.model}</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #8B8B95">
            <div class="section-label mb-2">Models</div>
            <div class="big-num text-2xl text-zinc-100">${totalModels}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${agg.reduce((s,a) => s + a.runs, 0)} total runs</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid ${grandTotalCost > 0 ? '#FB923C' : '#22C55E'}">
            <div class="section-label mb-2">Total Cost</div>
            <div class="big-num text-2xl text-zinc-100">${grandTotalCost > 0 ? '$' + grandTotalCost.toFixed(4) : '$0'}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${totalFails ? totalFails + ' failure(s)' : 'All nominal'}</div>
          </div>
        `;
      } else {
        // Stress test stat cards
        const atZero = agg.filter(a => a.context_tokens === 0 && a.success).sort((a, b) => b.tokens_per_second - a.tokens_per_second);
        const maxTier = Math.max(...agg.map(a => a.context_tokens));
        const atMax = agg.filter(a => a.context_tokens === maxTier && a.success).sort((a, b) => b.tokens_per_second - a.tokens_per_second);
        const totalFails = agg.reduce((s, a) => s + a.failures, 0);
        const totalRuns = agg.reduce((s, a) => s + a.runs, 0);

        const bestZero = atZero[0];
        const bestMax = atMax[0];

        container.innerHTML = `
          <div class="stat-card card-accent rounded-sm p-4">
            <div class="section-label mb-2">Best @ 0K</div>
            ${bestZero ? `
              <div class="big-num text-2xl text-zinc-100">${bestZero.tokens_per_second.toFixed(1)} <span class="text-xs font-normal" style="color:var(--lime)">tok/s</span></div>
              <div class="text-[11px] text-zinc-600 mt-1 font-body">${bestZero.model}</div>
            ` : `<div class="text-zinc-600 text-sm font-body">N/A</div>`}
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #38BDF8">
            <div class="section-label mb-2">Best @ ${formatCtxSize(maxTier).replace(' ctx','')}</div>
            ${bestMax ? `
              <div class="big-num text-2xl text-zinc-100">${bestMax.tokens_per_second.toFixed(1)} <span class="text-xs font-normal" style="color:#38BDF8">tok/s</span></div>
              <div class="text-[11px] text-zinc-600 mt-1 font-body">${bestMax.model}</div>
            ` : `<div class="text-zinc-600 text-sm font-body">N/A</div>`}
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #8B8B95">
            <div class="section-label mb-2">Tiers Tested</div>
            <div class="big-num text-2xl text-zinc-100">${new Set(agg.map(a => a.context_tokens)).size}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${totalRuns} total runs</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid ${totalFails ? 'var(--coral)' : '#22C55E'}">
            <div class="section-label mb-2">Failures</div>
            <div class="big-num text-2xl ${totalFails ? 'text-red-400' : 'text-green-400'}">${totalFails || 'None'}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${totalFails ? 'Check errors' : 'All nominal'}</div>
          </div>
        `;
      }
    }

    function renderChart() {
      const agg = aggregateResults();
      const ctx = document.getElementById('toksChart').getContext('2d');
      if (toksChart) toksChart.destroy();

      if (!isStressMode()) {
        // === STANDARD BAR CHART (existing behavior) ===
        const labels = agg.map(a => a.model);
        const data = agg.map(a => a.tokens_per_second);
        const bgColors = agg.map(a => getColor(a.provider).bar + 'CC');
        const borderColors = agg.map(a => getColor(a.provider).bar);

        toksChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Tokens/sec',
              data,
              backgroundColor: bgColors,
              borderColor: borderColors,
              borderWidth: 0,
              borderRadius: 2,
              barPercentage: 0.55,
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1c1c20',
                borderColor: '#27272A',
                borderWidth: 1,
                titleFont: { family: 'Outfit', size: 13, weight: '500' },
                bodyFont: { family: 'Space Mono', size: 12 },
                padding: 12,
                cornerRadius: 2,
                callbacks: {
                  label: ctx => ` ${ctx.parsed.x.toFixed(1)} tok/s`,
                  afterLabel: ctx => {
                    const r = agg[ctx.dataIndex];
                    return ` TTFT: ${r.ttft_ms.toFixed(0)}ms  |  Tokens: ${r.output_tokens.toFixed(0)}`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
                title: { display: true, text: 'TOKENS / SECOND', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } }
              },
              y: {
                grid: { display: false, drawBorder: false },
                ticks: { color: '#A1A1AA', font: { family: 'Outfit', size: 12, weight: '500' } }
              }
            }
          }
        });
      } else {
        // === STRESS TEST LINE CHART ===
        const tiers = [...new Set(agg.map(a => a.context_tokens))].sort((a, b) => a - b);
        const models = [...new Set(agg.map(a => `${a.model_id}::${a.provider}`))];
        const tierLabels = tiers.map(t => t === 0 ? '0' : (t >= 1000 ? (t/1000) + 'K' : t));

        const datasets = models.map(uid => {
          const modelResults = agg.filter(a => `${a.model_id}::${a.provider}` === uid);
          const modelName = modelResults[0]?.model || mid;
          const provider = modelResults[0]?.provider || '';
          const color = getColor(provider);

          const data = tiers.map(tier => {
            const match = modelResults.find(r => r.context_tokens === tier);
            return match && match.success ? match.tokens_per_second : null;
          });

          return {
            label: modelName,
            data,
            borderColor: color.bar,
            backgroundColor: color.bar + '33',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: color.bar,
            pointBorderColor: '#09090B',
            pointBorderWidth: 2,
            tension: 0.3,
            spanGaps: false,
          };
        });

        toksChart = new Chart(ctx, {
          type: 'line',
          data: { labels: tierLabels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#A1A1AA',
                  font: { family: 'Outfit', size: 11 },
                  boxWidth: 12,
                  boxHeight: 2,
                  padding: 16,
                }
              },
              tooltip: {
                backgroundColor: '#1c1c20',
                borderColor: '#27272A',
                borderWidth: 1,
                titleFont: { family: 'Outfit', size: 13, weight: '500' },
                bodyFont: { family: 'Space Mono', size: 12 },
                padding: 12,
                cornerRadius: 2,
                callbacks: {
                  title: ctx => `Context: ${ctx[0].label} tokens`,
                  label: ctx => ctx.parsed.y !== null ? ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)} tok/s` : ` ${ctx.dataset.label}: N/A`,
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
                title: { display: true, text: 'CONTEXT SIZE (TOKENS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } }
              },
              y: {
                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
                title: { display: true, text: 'TOKENS / SECOND', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { right: 12 } }
              }
            }
          }
        });
      }
    }

    function renderTable() {
      const agg = aggregateResults();
      const tbody = document.getElementById('resultsBody');
      const thead = tbody.closest('table').querySelector('thead tr');
      tbody.innerHTML = '';

      const stress = isStressMode();
      const multiRun = agg.some(r => r.runs > 1);

      // Update header
      if (stress) {
        // Add Context column if not present
        if (!thead.querySelector('[data-col="context"]')) {
          const th = document.createElement('th');
          th.className = 'px-5 py-3 text-right section-label';
          th.dataset.col = 'context';
          th.textContent = 'Context';
          // Insert after Model column (index 2)
          thead.children[3].before(th);
        }
      } else {
        const ctxTh = thead.querySelector('[data-col="context"]');
        if (ctxTh) ctxTh.remove();
      }

      // Show/hide Std Dev column based on multi-run
      const stdDevTh = thead.querySelector('[data-col="stddev"]');
      if (stdDevTh) stdDevTh.style.display = multiRun ? '' : 'none';

      agg.forEach((r, i) => {
        const color = getColor(r.provider);
        const pos = i < 3 && r.success ? `<span class="font-display font-bold" ${i===0 ? 'style="color:var(--lime)"' : ''}>${POSITION_LABELS[i]}</span>` : `<span class="text-zinc-600">${i + 1}</span>`;

        const statusHtml = r.failures === 0
          ? `<span class="text-green-500 text-xs font-mono">${r.runs}/${r.runs}</span>`
          : r.failures < r.runs
            ? `<span class="text-amber-500 text-xs font-mono">${r.runs - r.failures}/${r.runs}</span>`
            : `<span class="text-red-400 text-xs font-mono" title="${r.error}">FAIL</span>`;

        const ctxCell = stress ? `<td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.context_tokens === 0 ? '0' : formatCtxSize(r.context_tokens).replace(' ctx', '')}</td>` : '';
        const stdDevCell = multiRun ? `<td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-600">${r.success && r.std_dev_tps > 0 ? '\u00B1' + r.std_dev_tps.toFixed(1) : '-'}</td>` : '';
        const inputTpsFormatted = r.success && r.input_tokens_per_second > 0 ? Math.round(r.input_tokens_per_second).toLocaleString() : '-';
        const costFormatted = r.success && r.avg_cost > 0 ? '$' + r.avg_cost.toFixed(4) : '-';

        const row = document.createElement('tr');
        row.className = i === 0 && r.success ? 'rank-1 fade-in' : 'fade-in';
        row.innerHTML = `
          <td class="px-5 py-3.5 text-center">${pos}</td>
          <td class="px-5 py-3.5"><span class="badge" style="background:${color.bg};color:${color.text};border:1px solid ${color.border}">${r.provider}</span></td>
          <td class="px-5 py-3.5 text-zinc-200 font-medium font-body text-[13px]">${r.model}${!r.success && r.error ? `<div class="text-[11px] font-mono mt-0.5" style="color:#FB7185;word-break:break-word;max-width:320px;cursor:pointer;" onclick="navigator.clipboard.writeText(this.textContent).then(()=>showToast('Error copied','success'))" title="Click to copy">${r.error}</div>` : ''}</td>
          ${ctxCell}
          <td class="px-5 py-3.5 text-right font-mono text-sm ${r.success && i === 0 ? '' : 'text-zinc-400'}" ${r.success && i === 0 ? 'style="color:var(--lime)"' : ''}>${r.success ? r.tokens_per_second.toFixed(1) : '-'}</td>
          ${stdDevCell}
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.success ? r.ttft_ms.toFixed(0) + 'ms' : '-'}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${inputTpsFormatted}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.success ? r.total_time_s.toFixed(2) + 's' : '-'}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.success ? r.output_tokens.toFixed(0) : '-'}</td>
          <td class="px-5 py-3.5 text-center">${statusHtml}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${costFormatted}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderTTFTChart() {
      const section = document.getElementById('ttftChartSection');
      section.classList.remove('hidden');

      const agg = aggregateResults();
      const chartCtx = document.getElementById('ttftChart').getContext('2d');
      if (ttftChart) ttftChart.destroy();

      const stress = isStressMode();
      document.getElementById('ttftChartLabel').textContent = stress ? 'Latency (TTFT) vs Context Size' : 'Time to First Token (TTFT)';

      if (!stress) {
        // === STANDARD: horizontal bar chart of TTFT values ===
        const sorted = [...agg].filter(a => a.success).sort((a, b) => a.ttft_ms - b.ttft_ms);
        const labels = sorted.map(a => a.model);
        const data = sorted.map(a => a.ttft_ms);
        const bgColors = sorted.map(a => getColor(a.provider).bar + 'CC');

        ttftChart = new Chart(chartCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{ label: 'TTFT (ms)', data, backgroundColor: bgColors, borderWidth: 0, borderRadius: 2, barPercentage: 0.55 }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
                titleFont: { family: 'Outfit', size: 13, weight: '500' },
                bodyFont: { family: 'Space Mono', size: 12 },
                padding: 12, cornerRadius: 2,
                callbacks: { label: c => ` ${c.parsed.x.toFixed(0)} ms` }
              }
            },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TIME TO FIRST TOKEN (MS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } } },
              y: { grid: { display: false, drawBorder: false }, ticks: { color: '#A1A1AA', font: { family: 'Outfit', size: 12, weight: '500' } } }
            }
          }
        });
      } else {
        // === STRESS: line chart (existing behavior) ===
        const tiers = [...new Set(agg.map(a => a.context_tokens))].sort((a, b) => a - b);
        const models = [...new Set(agg.map(a => `${a.model_id}::${a.provider}`))];
        const tierLabels = tiers.map(t => t === 0 ? '0' : (t >= 1000 ? (t/1000) + 'K' : t));

        const datasets = models.map(uid => {
          const modelResults = agg.filter(a => `${a.model_id}::${a.provider}` === uid);
          const modelName = modelResults[0]?.model || uid;
          const provider = modelResults[0]?.provider || '';
          const color = getColor(provider);
          const data = tiers.map(tier => { const m = modelResults.find(r => r.context_tokens === tier); return m && m.success ? m.ttft_ms : null; });
          return { label: modelName, data, borderColor: color.bar, backgroundColor: color.bar + '33', borderWidth: 2, pointRadius: 4, pointBackgroundColor: color.bar, pointBorderColor: '#09090B', pointBorderWidth: 2, tension: 0.3, spanGaps: false };
        });

        ttftChart = new Chart(chartCtx, {
          type: 'line',
          data: { labels: tierLabels, datasets },
          options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: true, position: 'top', labels: { color: '#A1A1AA', font: { family: 'Outfit', size: 11 }, boxWidth: 12, boxHeight: 2, padding: 16 } },
              tooltip: { backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1, titleFont: { family: 'Outfit', size: 13, weight: '500' }, bodyFont: { family: 'Space Mono', size: 12 }, padding: 12, cornerRadius: 2, callbacks: { title: c => `Context: ${c[0].label} tokens`, label: c => c.parsed.y !== null ? ` ${c.dataset.label}: ${c.parsed.y.toFixed(0)}ms` : ` ${c.dataset.label}: N/A` } }
            },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'CONTEXT SIZE (TOKENS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } } },
              y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TIME TO FIRST TOKEN (MS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { right: 12 } } }
            }
          }
        });
      }
    }

    // -------------------------------------------------------------------
    // Scatter chart: Speed vs Latency
    // -------------------------------------------------------------------
    function renderScatterChart() {
      const section = document.getElementById('scatterChartSection');
      const agg = aggregateResults().filter(a => a.success);
      if (agg.length < 2) { section.classList.add('hidden'); return; }
      section.classList.remove('hidden');

      const chartCtx = document.getElementById('scatterChart').getContext('2d');
      if (scatterChart) scatterChart.destroy();

      // Scale point size: output_tokens mapped to 5-20px
      const allTokens = agg.map(a => a.output_tokens);
      const minT = Math.min(...allTokens), maxT = Math.max(...allTokens);
      const scaleSize = (t) => maxT === minT ? 10 : 5 + (t - minT) / (maxT - minT) * 15;

      const datasets = agg.map(a => {
        const color = getColor(a.provider);
        return {
          label: a.model,
          data: [{ x: a.tokens_per_second, y: a.ttft_ms }],
          backgroundColor: color.bar,
          borderColor: color.bar,
          pointRadius: scaleSize(a.output_tokens),
          pointHoverRadius: scaleSize(a.output_tokens) + 3,
        };
      });

      scatterChart = new Chart(chartCtx, {
        type: 'scatter',
        data: { datasets },
        options: {
          responsive: true, maintainAspectRatio: false,
          animation: { duration: 800, easing: 'easeOutQuart' },
          plugins: {
            legend: { display: true, position: 'top', labels: { color: '#A1A1AA', font: { family: 'Outfit', size: 11 }, boxWidth: 8, boxHeight: 8, padding: 12, usePointStyle: true } },
            tooltip: {
              backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
              titleFont: { family: 'Outfit', size: 13, weight: '500' },
              bodyFont: { family: 'Space Mono', size: 12 },
              padding: 12, cornerRadius: 2,
              callbacks: {
                title: c => c[0].dataset.label,
                label: c => [` Tok/s: ${c.parsed.x.toFixed(1)}`, ` TTFT: ${c.parsed.y.toFixed(0)}ms`]
              }
            }
          },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TOKENS / SECOND', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } } },
            y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TTFT (MS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { right: 12 } } }
          }
        }
      });
    }

    // -------------------------------------------------------------------
    // CSV Export
    // -------------------------------------------------------------------
    function exportCSV() {
      const agg = aggregateResults();
      if (!agg.length) { showToast('No results to export', 'error'); return; }
      const headers = ['Provider','Model','Tok/s','TTFT (ms)','Input Tok/s','Duration (s)','Output Tokens','Status','Avg Cost','Total Cost'];
      const rows = agg.map(r => [
        r.provider, r.model,
        r.success ? r.tokens_per_second.toFixed(2) : '',
        r.success ? r.ttft_ms.toFixed(0) : '',
        r.success && r.input_tokens_per_second > 0 ? Math.round(r.input_tokens_per_second) : '',
        r.success ? r.total_time_s.toFixed(3) : '',
        r.success ? r.output_tokens.toFixed(0) : '',
        r.success ? (r.failures ? 'partial' : 'ok') : 'fail',
        r.success && r.avg_cost > 0 ? r.avg_cost.toFixed(6) : '',
        r.success && r.total_cost > 0 ? r.total_cost.toFixed(6) : '',
      ]);
      const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'benchmark_results.csv'; a.click();
      URL.revokeObjectURL(url);
      showToast('CSV downloaded', 'success');
    }

    // -------------------------------------------------------------------
    // Tabs
    // -------------------------------------------------------------------
    function showTab(tab) {
      document.getElementById('view-benchmark').classList.toggle('hidden', tab !== 'benchmark');
      document.getElementById('view-history').classList.toggle('hidden', tab !== 'history');
      document.getElementById('view-settings').classList.toggle('hidden', tab !== 'settings');
      document.getElementById('view-tool-eval').classList.toggle('hidden', tab !== 'tool-eval');
      document.getElementById('view-analytics').classList.toggle('hidden', tab !== 'analytics');
      document.getElementById('view-schedules').classList.toggle('hidden', tab !== 'schedules');
      document.getElementById('view-admin').classList.toggle('hidden', tab !== 'admin');
      document.getElementById('tab-benchmark').classList.toggle('tab-active', tab === 'benchmark');
      document.getElementById('tab-history').classList.toggle('tab-active', tab === 'history');
      document.getElementById('tab-settings').classList.toggle('tab-active', tab === 'settings');
      document.getElementById('tab-tool-eval').classList.toggle('tab-active', tab === 'tool-eval');
      document.getElementById('tab-analytics').classList.toggle('tab-active', tab === 'analytics');
      document.getElementById('tab-schedules').classList.toggle('tab-active', tab === 'schedules');
      document.getElementById('tab-admin').classList.toggle('tab-active', tab === 'admin');
      if (tab === 'history') loadHistory();
      if (tab === 'settings') { renderSettings(); showSettingsTab(_currentSettingsTab); }
      if (tab === 'tool-eval') {
        teLoadSuites(); teLoadHistory();
        // If a tool eval job is running, restore the run view instead of suites
        if (_activeToolEvalJobId && _jobStore[_activeToolEvalJobId] && ACTIVE_STATUSES.has(_jobStore[_activeToolEvalJobId].status)) {
          _teRestoreRunningEval();
        } else {
          showToolEvalView('suites');
        }
      }
      if (tab === 'analytics') { analyticsShowLeaderboard(); }
      if (tab === 'schedules') loadSchedules();
      if (tab === 'admin') loadAdminDashboard();
    }

    // -------------------------------------------------------------------
    // Settings — Full CRUD
    // -------------------------------------------------------------------
    const QUICK_CTX_SIZES = [4096, 8192, 16384, 32768, 65536, 131072, 200000];
    const QUICK_CTX_LABELS = ['4K', '8K', '16K', '32K', '64K', '128K', '200K'];
    const INPUT_STYLE = "background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;";
    const INPUT_CLASS = "w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200";

    async function refreshConfig() {
      const res = await apiFetch('/api/config');
      config = await res.json();
    }

    function showStatus(elId, ok, msg) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.classList.remove('hidden');
      el.style.color = ok ? 'var(--lime)' : 'var(--coral)';
      el.textContent = msg;
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // ── Settings Sub-Navigation ──
    let _currentSettingsTab = 'keys';
    function showSettingsTab(tab) {
      const tabs = ['keys', 'providers', 'judge', 'tuning'];
      tabs.forEach(t => {
        const panel = document.getElementById('settings-' + t);
        const btn = document.getElementById('stab-' + t);
        if (panel) panel.classList.toggle('hidden', t !== tab);
        if (btn) btn.classList.toggle('settings-tab-active', t === tab);
      });
      _currentSettingsTab = tab;
    }

    // ── Render Settings (orchestrator) ──
    async function renderSettings() {
      if (!config) {
        try { await refreshConfig(); } catch (e) {
          document.getElementById('settingsContainer').innerHTML = '<p class="text-red-400 text-sm">Failed to load config.</p>';
          return;
        }
      }
      await renderApiKeys();
      renderProviders();
      p10Load(); // Load Phase 10 settings (async, non-blocking)
    }

    // ── API Keys (per-user) ──
    async function renderApiKeys() {
      const container = document.getElementById('apiKeysContainer');
      try {
        const res = await apiFetch('/api/keys');
        const data = await res.json();
        const keys = data.keys || [];

        container.innerHTML = `
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">My API Keys</span>
              <span class="text-[10px] text-zinc-600 font-body">Your keys are encrypted and only used for your benchmarks</span>
            </div>
            <div class="divide-y" style="border-color:var(--border-subtle)">
              ${keys.length === 0 ? '<div class="px-5 py-3 text-zinc-700 text-xs font-body">No providers configured.</div>' :
                keys.map(k => `
                  <div class="px-5 py-3 flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                      <span class="text-xs font-body text-zinc-300">${k.display_name}</span>
                      <span class="text-[10px] font-mono text-zinc-600">${k.key_env_name || k.provider_key}</span>
                      ${k.has_user_key
                        ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(191,255,0,0.08);color:var(--lime);border:1px solid rgba(191,255,0,0.2)">YOUR KEY</span>'
                        : k.has_global_key
                          ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:1px solid rgba(56,189,248,0.2)">SHARED</span>'
                          : '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(255,59,92,0.08);color:var(--coral);border:1px solid rgba(255,59,92,0.2)">NOT SET</span>'
                      }
                    </div>
                    <div class="flex gap-2">
                      <button onclick="setMyKey('${k.provider_key}','${k.display_name}')" class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm transition-colors ${k.has_user_key ? 'text-zinc-500 hover:text-zinc-300' : 'hover:text-zinc-200'}" style="${k.has_user_key ? '' : 'color:var(--lime);border:1px solid rgba(191,255,0,0.2)'}">${k.has_user_key ? 'Update' : 'Set Key'}</button>
                      ${k.has_user_key ? `<button onclick="removeMyKey('${k.provider_key}','${k.display_name}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-red-400 transition-colors">Remove</button>` : ''}
                    </div>
                  </div>
                `).join('')}
            </div>
          </div>
        `;
      } catch (e) {
        container.innerHTML = '<p class="text-red-400 text-xs">Failed to load API keys.</p>';
      }
    }

    async function setMyKey(providerKey, displayName) {
      showInputModal('Set API Key for ' + displayName, 'Paste your API key...', async (value) => {
        await apiFetch('/api/keys', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider_key: providerKey, value })
        });
        renderApiKeys();
      }, { inputType: 'password' });
    }

    async function removeMyKey(providerKey, displayName) {
      showModal('Remove Key', 'Remove your personal key for <strong>' + displayName + '</strong>? You will fall back to the shared key (if one exists).', async () => {
        await apiFetch('/api/keys', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider_key: providerKey })
        });
        renderApiKeys();
      }, { danger: true, confirmLabel: 'Remove' });
    }

    // ── Render Providers + Models ──
    function renderProviders() {
      const container = document.getElementById('settingsContainer');
      container.innerHTML = '';

      for (const [provDisplayName, provData] of Object.entries(config.providers)) {
        const pk = provData.provider_key;
        const models = provData.models || [];
        const color = getColor(provDisplayName);
        const prefix = provData.model_id_prefix || detectPrefix(models);

        const section = document.createElement('div');
        section.className = 'card rounded-md overflow-hidden';
        section.innerHTML = `
          <!-- Provider Header -->
          <div class="px-5 py-3 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
            <div class="flex items-center gap-3">
              <span class="badge" style="background:${color.bg};color:${color.text};border:1px solid ${color.border}">${provDisplayName}</span>
              <span class="text-zinc-600 text-xs font-body">${models.length} model${models.length!==1?'s':''}</span>
              <span class="text-[9px] font-mono text-zinc-700">${pk}</span>
              ${prefix ? `<span class="text-[9px] font-mono px-1.5 py-0.5 rounded-sm" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:1px solid rgba(56,189,248,0.2)">prefix: ${prefix}/</span>` : ''}
            </div>
            <div class="flex gap-2">
              <button onclick="fetchAndShowModels('${pk}', this)" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors">Fetch</button>
              <button onclick="editProvider('${pk}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors">Edit</button>
              <button onclick="deleteProvider('${pk}','${provDisplayName}',${models.length})" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-red-400 transition-colors">Del</button>
            </div>
          </div>
          <!-- Provider edit form (hidden) -->
          <div id="prov-edit-${pk}" class="hidden px-5 py-3" style="border-bottom:1px solid var(--border-subtle);background:rgba(191,255,0,0.02)">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-2">
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
                <input id="pe-dn-${pk}" value="${provDisplayName}" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID Prefix</label>
                <input id="pe-prefix-${pk}" value="${provData.model_id_prefix || detectPrefix(provData.models)}" placeholder="Optional" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Base</label>
                <input id="pe-ab-${pk}" value="${provData.api_base||''}" placeholder="https://..." class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Key Name</label>
                <input id="pe-ke-${pk}" value="${provData.api_key_env||''}" placeholder="e.g. OPENAI_API_KEY" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
            </div>
            <button onclick="saveProvider('${pk}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Save Provider</button>
            <span id="prov-status-${pk}" class="ml-3 text-[11px] font-body hidden"></span>
          </div>
          <!-- Models -->
          <div class="divide-y" style="border-color:var(--border-subtle)">
            ${models.map(m => renderModelCard(pk, m)).join('')}
          </div>
          <!-- Add Model -->
          <div class="px-5 py-3" style="border-top:1px solid var(--border-subtle)">
            <button onclick="toggleAddModel('${pk}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">+ Add Model</button>
            <div id="add-model-${pk}" class="hidden mt-3">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-2">
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID</label>
                  <div class="flex items-center gap-0">
                    ${prefix ? `<span class="text-[11px] font-mono px-2 py-2 rounded-l-sm flex-shrink-0" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:1px solid rgba(56,189,248,0.2);border-right:none;">${prefix}/</span>` : ''}
                    <input id="am-id-${pk}" placeholder="${prefix ? 'model-name' : 'provider/model-name'}" list="dl-am-${pk}" class="${INPUT_CLASS} ${prefix ? 'rounded-l-none' : ''}" style="${INPUT_STYLE}" onfocus="loadAndPopulateDatalist('${pk}', 'dl-am-${pk}')" oninput="autoDeriveName('am-id-${pk}','am-dn-${pk}'); updateModelPreview('${pk}'); autoFillDisplayName(this, '${pk}', 'am-dn-${pk}')">
                  </div>
                  <datalist id="dl-am-${pk}"></datalist>
                  <div id="am-preview-${pk}" class="text-[9px] font-mono text-zinc-600 mt-1"></div>
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
                  <input id="am-dn-${pk}" placeholder="Auto from ID" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Context Window</label>
                  <input id="am-ctx-${pk}" value="128000" type="number" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
                </div>
              </div>
              <button onclick="addModel('${pk}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Add</button>
            </div>
          </div>
        `;
        container.appendChild(section);
      }

      // Add Provider button at bottom
      const addProvBtn = document.createElement('div');
      addProvBtn.innerHTML = `
        <button onclick="toggleAddProvider()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-2 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">+ Add Provider</button>
        <div id="add-provider-form" class="hidden card rounded-md p-5 mt-3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
              <input id="ap-dn" placeholder="My Provider" class="${INPUT_CLASS}" style="${INPUT_STYLE}" oninput="document.getElementById('ap-key').value = uniqueProviderKey(slugify(this.value)); document.getElementById('ap-ke').value = slugify(this.value).toUpperCase().replace(/-/g,'_') + '_API_KEY'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Provider Key <span class="text-zinc-700 normal-case">(auto-derived, editable)</span></label>
              <input id="ap-key" placeholder="auto_generated" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID Prefix <span class="text-zinc-700 normal-case">(e.g. lm_studio)</span></label>
              <input id="ap-prefix" placeholder="Optional — prepended to model IDs" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Base</label>
              <input id="ap-ab" placeholder="https://api.example.com/v1" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Key Name <span class="text-zinc-700 normal-case">(auto-derived)</span></label>
              <input id="ap-ke" placeholder="e.g. OPENAI_API_KEY" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
          </div>
          <button onclick="addProvider()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Create Provider</button>
        </div>
      `;
      container.appendChild(addProvBtn);
    }

    // ── Single model card ──
    function renderModelCard(provKey, m) {
      const sid = safeId(provKey + '__' + m.model_id);
      const skipHtml = (m.skip_params || []).map(p =>
        `<span class="text-[10px] font-mono text-zinc-400 px-1.5 py-0.5 rounded-sm inline-flex items-center gap-1" style="background:rgba(255,255,255,0.04)">
          ${p} <button onclick="removeSkipParam('${provKey}','${m.model_id}','${p}')" class="text-zinc-600 hover:text-red-400">&times;</button>
        </span>`
      ).join(' ');

      // Custom fields (anything not standard)
      const stdKeys = new Set(['model_id','display_name','context_window','max_output_tokens','skip_params','input_cost_per_mtok','output_cost_per_mtok','system_prompt']);
      const customs = Object.entries(m).filter(([k]) => !stdKeys.has(k));
      const customHtml = customs.map(([k,v]) =>
        `<div class="flex items-center gap-2">
          <span class="text-[10px] font-mono text-zinc-500">${k}:</span>
          <input id="cf-${sid}-${safeId(k)}" value="${v}" class="px-2 py-1 rounded-sm text-[11px] font-mono text-zinc-300 flex-1" style="${INPUT_STYLE}">
          <button onclick="removeCustomField('${provKey}','${m.model_id}','${k}')" class="text-zinc-600 hover:text-red-400 text-xs">&times;</button>
        </div>`
      ).join('');

      return `
        <div class="px-5 py-4" id="settings-${sid}">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="text-[13px] font-medium text-zinc-200 font-body">${m.display_name}</div>
              <span class="text-[9px] font-mono text-zinc-700">${m.model_id}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="saveModelConfig('${provKey}','${m.model_id}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">Save</button>
              <button onclick="deleteModel('${provKey}','${m.model_id}','${m.display_name}')" class="text-[11px] font-display tracking-wider uppercase px-2 py-1.5 rounded-sm text-zinc-600 hover:text-red-400 transition-colors" style="border:1px solid var(--border-subtle)">&times;</button>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID</label>
              <input id="mid-${sid}" value="${m.model_id}" list="dl-${sid}" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'; loadAndPopulateDatalist('${provKey}', 'dl-${sid}')" onblur="this.style.borderColor='var(--border-subtle)'" oninput="autoDeriveName('mid-${sid}','mdn-${sid}'); autoFillDisplayName(this, '${provKey}', 'mdn-${sid}')">
              <datalist id="dl-${sid}"></datalist>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
              <input id="mdn-${sid}" value="${m.display_name}" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Context Window</label>
              <input type="number" id="ctx-${sid}" value="${m.context_window||128000}" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
              <div class="flex gap-1.5 mt-2 flex-wrap">
                ${QUICK_CTX_SIZES.map((size,i) => `<button onclick="document.getElementById('ctx-${sid}').value=${size}" class="text-[9px] font-mono px-2 py-0.5 rounded-sm text-zinc-600 hover:text-zinc-400 transition-colors" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle)">${QUICK_CTX_LABELS[i]}</button>`).join('')}
              </div>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Max Output Tokens</label>
              <input type="number" id="mot-${sid}" value="${m.max_output_tokens||''}" placeholder="Default" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Input $/1M tokens</label>
              <input type="number" step="0.001" id="icp-${sid}" value="${m.input_cost_per_mtok!=null?m.input_cost_per_mtok:''}" placeholder="e.g. 2.00" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Output $/1M tokens</label>
              <input type="number" step="0.001" id="ocp-${sid}" value="${m.output_cost_per_mtok!=null?m.output_cost_per_mtok:''}" placeholder="e.g. 8.00" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
          </div>
          <!-- Skip Params -->
          <div class="mt-3">
            <span class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Skip Params: </span>
            <span id="sp-pills-${sid}">${skipHtml || '<span class="text-[10px] text-zinc-700 font-body">none</span>'}</span>
            <button onclick="promptAddSkipParam('${provKey}','${m.model_id}')" class="text-[10px] font-mono text-zinc-500 hover:text-zinc-300 ml-2 px-1.5 py-0.5 rounded-sm" style="border:1px solid var(--border-subtle)">+ add</button>
          </div>
          <!-- Custom Fields -->
          <div class="mt-3">
            <span class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Custom Fields</span>
            <div id="cf-${sid}" class="space-y-1">${customHtml || '<span class="text-[10px] text-zinc-700 font-body">none</span>'}</div>
            <button onclick="promptAddCustomField('${provKey}','${m.model_id}')" class="text-[10px] font-mono text-zinc-500 hover:text-zinc-300 mt-1 px-1.5 py-0.5 rounded-sm" style="border:1px solid var(--border-subtle)">+ add field</button>
          </div>
          <!-- System Prompt -->
          <div class="mt-4 pt-3" style="border-top:1px solid var(--border-subtle)">
            <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">System Prompt</label>
            <p class="text-[10px] text-zinc-700 font-body mb-2">Custom system prompt prepended to all benchmarks and evals for this model. Leave empty for default behavior.</p>
            <textarea id="sp-${sid}" rows="3" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;resize:vertical;" placeholder="e.g. You are a helpful assistant. Always respond in JSON format.">${m.system_prompt ? m.system_prompt.replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''}</textarea>
          </div>
          <div id="save-status-${sid}" class="mt-2 text-[11px] font-body hidden"></div>
        </div>
      `;
    }

    async function loadProviderModels(provKey) {
      if (discoveredModelsCache[provKey]) return discoveredModelsCache[provKey];
      try {
        const res = await apiFetch(`/api/models/discover?provider_key=${encodeURIComponent(provKey)}`);
        const data = await res.json();
        if (data.models) {
          discoveredModelsCache[provKey] = data.models;
          return data.models;
        }
      } catch(e) {}
      return [];
    }

    async function loadAndPopulateDatalist(provKey, datalistId) {
      const dl = document.getElementById(datalistId);
      if (!dl || dl.children.length > 0) return;
      const models = await loadProviderModels(provKey);
      dl.innerHTML = models.map(m => `<option value="${m.id}">${m.display_name}</option>`).join('');
    }

    function autoFillDisplayName(input, provKey, dnFieldId) {
      const models = discoveredModelsCache[provKey] || [];
      const match = models.find(m => m.id === input.value);
      if (match) {
        const dnField = document.getElementById(dnFieldId);
        if (dnField) dnField.value = match.display_name;
      }
    }

    function autoDeriveName(idInputId, nameInputId) {
      const idVal = document.getElementById(idInputId)?.value || '';
      const nameInput = document.getElementById(nameInputId);
      if (nameInput && !nameInput.dataset.manual) {
        nameInput.value = idVal.includes('/') ? idVal.split('/').pop() : idVal;
      }
    }

    function updateModelPreview(provKey) {
      const previewEl = document.getElementById(`am-preview-${provKey}`);
      const inputEl = document.getElementById(`am-id-${provKey}`);
      if (!previewEl || !inputEl) return;
      const provData = Object.values(config.providers).find(p => p.provider_key === provKey);
      const prefix = provData?.model_id_prefix || '';
      const val = inputEl.value.trim();
      if (!val) { previewEl.textContent = ''; return; }
      if (prefix && !val.startsWith(prefix + '/')) {
        previewEl.textContent = `Full ID: ${prefix}/${val}`;
      } else {
        previewEl.textContent = `Full ID: ${val}`;
      }
    }

    // ── Save Model ──
    async function saveModelConfig(providerKey, modelId) {
      const sid = safeId(providerKey + '__' + modelId);
      const statusId = `save-status-${sid}`;

      // Collect skip_params from current config
      const provData = Object.values(config.providers).find(p => p.provider_key === providerKey);
      const modelData = provData?.models?.find(m => m.model_id === modelId);
      const currentSkipParams = modelData?.skip_params || [];

      // Collect custom fields
      const stdKeys = new Set(['model_id','display_name','context_window','max_output_tokens','skip_params','input_cost_per_mtok','output_cost_per_mtok']);
      const customs = {};
      if (modelData) {
        for (const [k] of Object.entries(modelData).filter(([k]) => !stdKeys.has(k))) {
          const el = document.getElementById(`cf-${sid}-${safeId(k)}`);
          if (el) customs[k] = el.value;
        }
      }

      // Collect pricing fields
      const icpVal = document.getElementById(`icp-${sid}`)?.value;
      const ocpVal = document.getElementById(`ocp-${sid}`)?.value;
      const pricingFields = {};
      if (icpVal !== '' && icpVal != null) pricingFields.input_cost_per_mtok = parseFloat(icpVal);
      if (ocpVal !== '' && ocpVal != null) pricingFields.output_cost_per_mtok = parseFloat(ocpVal);

      // Collect system prompt
      const systemPromptVal = document.getElementById(`sp-${sid}`)?.value || '';

      const body = {
        provider_key: providerKey,
        model_id: modelId,
        new_model_id: document.getElementById(`mid-${sid}`)?.value || modelId,
        display_name: document.getElementById(`mdn-${sid}`)?.value || '',
        context_window: parseInt(document.getElementById(`ctx-${sid}`)?.value) || null,
        max_output_tokens: parseInt(document.getElementById(`mot-${sid}`)?.value) || null,
        skip_params: currentSkipParams,
        system_prompt: systemPromptVal || null,
        custom_fields: {
          ...(Object.keys(customs).length ? customs : {}),
          ...(Object.keys(pricingFields).length ? pricingFields : {}),
        },
      };
      if (!Object.keys(body.custom_fields).length) delete body.custom_fields;

      try {
        const res = await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const result = await res.json();
        if (res.ok) {
          showStatus(statusId, true, 'Saved');
          await refreshConfig();
          renderModels();
        } else {
          showStatus(statusId, false, result.error || 'Save failed');
        }
      } catch (e) {
        showStatus(statusId, false, 'Network error');
      }
    }

    // ── Model CRUD ──
    async function deleteModel(provKey, modelId, displayName) {
      showModal('Remove Model', `Remove model <strong>${displayName}</strong>?`, async () => {
        await apiFetch('/api/config/model', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId}) });
        await refreshConfig();
        renderModels();
        renderProviders();
      }, { danger: true, confirmLabel: 'Remove' });
    }

    function toggleAddModel(provKey) {
      document.getElementById(`add-model-${provKey}`)?.classList.toggle('hidden');
    }

    async function addModel(provKey) {
      const id = document.getElementById(`am-id-${provKey}`)?.value.trim();
      if (!id) return;
      const body = {
        provider_key: provKey,
        id: id,
        display_name: document.getElementById(`am-dn-${provKey}`)?.value.trim() || '',
        context_window: parseInt(document.getElementById(`am-ctx-${provKey}`)?.value) || 128000,
      };
      const res = await apiFetch('/api/config/model', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (res.ok) {
        await refreshConfig();
        renderModels();
        renderProviders();
      } else {
        const err = await res.json();
        showToast(err.error || 'Failed to add model', 'error');
      }
    }

    // ── Skip Params ──
    async function promptAddSkipParam(provKey, modelId) {
      showInputModal('Add Skip Param', 'Parameter name (e.g., temperature)', async (param) => {
        if (!param || !param.trim()) return;
        const provData = Object.values(config.providers).find(p => p.provider_key === provKey);
        const modelData = provData?.models?.find(m => m.model_id === modelId);
        const current = [...(modelData?.skip_params || [])];
        if (!current.includes(param.trim())) current.push(param.trim());
        await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, skip_params: current}) });
        await refreshConfig();
        renderProviders();
      });
    }

    async function removeSkipParam(provKey, modelId, param) {
      const provData = Object.values(config.providers).find(p => p.provider_key === provKey);
      const modelData = provData?.models?.find(m => m.model_id === modelId);
      const current = (modelData?.skip_params || []).filter(p => p !== param);
      await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, skip_params: current}) });
      await refreshConfig();
      renderProviders();
    }

    // ── Custom Fields ──
    async function promptAddCustomField(provKey, modelId) {
      showDoubleInputModal('Add Custom Field', [
        { label: 'Field Name', placeholder: 'e.g., pricing_tier' },
        { label: 'Value', placeholder: 'e.g., standard' }
      ], async (key, value) => {
        if (!key || !key.trim()) return;
        await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, custom_fields: {[key.trim()]: value}}) });
        await refreshConfig();
        renderProviders();
      });
    }

    async function removeCustomField(provKey, modelId, key) {
      await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, custom_fields: {[key]: null}}) });
      await refreshConfig();
      renderProviders();
    }

    // ── Fetch Models from Provider API ──
    async function fetchAndShowModels(provKey, btn) {
      const origText = btn.textContent;
      btn.textContent = 'Loading...';
      btn.disabled = true;

      try {
        const res = await apiFetch(`/api/models/discover?provider_key=${encodeURIComponent(provKey)}`);
        const data = await res.json();

        if (data.error) {
          showToast(data.error, 'error');
          return;
        }

        const models = data.models || [];
        if (models.length === 0) {
          showToast('No models found', 'error');
          return;
        }

        // Get existing model IDs for this provider
        const existingIds = new Set();
        for (const [name, p] of Object.entries(config.providers || {})) {
          if (p.provider_key === provKey) {
            (p.models || []).forEach(m => existingIds.add(m.model_id));
          }
        }

        // Build checkbox list HTML
        const listHtml = models.map((m, i) => {
          const exists = existingIds.has(m.id);
          return `<label class="flex items-center gap-2 py-1.5 px-2 rounded hover:bg-white/5 cursor-pointer ${exists ? 'opacity-40' : ''}">
            <input type="checkbox" value="${i}" ${exists ? 'checked disabled' : ''} class="accent-lime-400">
            <span class="text-xs font-mono text-zinc-300">${m.id}</span>
            ${m.display_name !== m.id ? `<span class="text-[10px] text-zinc-500">${m.display_name}</span>` : ''}
            ${exists ? '<span class="text-[9px] text-zinc-600 ml-auto">already added</span>' : ''}
          </label>`;
        }).join('');

        // Create overlay modal
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.innerHTML = `
          <div class="card rounded-md p-5 w-full max-w-lg max-h-[70vh] flex flex-col" style="border:1px solid var(--border-subtle)">
            <div class="flex items-center justify-between mb-3">
              <span class="font-display text-sm tracking-wide text-zinc-200">${models.length} models available</span>
              <button data-action="close" class="text-zinc-500 hover:text-zinc-300 text-xs cursor-pointer">Close</button>
            </div>
            <div class="overflow-y-auto flex-1 mb-3" id="model-pick-list">
              ${listHtml}
            </div>
            <button id="add-selected-models-btn" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-2 rounded-sm self-end cursor-pointer" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Add Selected</button>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.querySelector('[data-action="close"]').onclick = () => { overlay.classList.add('modal-closing'); setTimeout(() => overlay.remove(), 200); };
        overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.classList.add('modal-closing'); setTimeout(() => overlay.remove(), 200); } });

        // Handle "Add Selected"
        document.getElementById('add-selected-models-btn').onclick = async () => {
          const checks = overlay.querySelectorAll('input[type=checkbox]:checked:not(:disabled)');
          if (checks.length === 0) {
            showToast('No models selected', 'error');
            return;
          }
          const addBtn = document.getElementById('add-selected-models-btn');
          addBtn.textContent = 'Adding...';
          addBtn.disabled = true;

          for (const cb of checks) {
            const m = models[parseInt(cb.value)];
            await apiFetch('/api/config/model', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ provider_key: provKey, id: m.id, display_name: m.display_name })
            });
          }

          overlay.classList.add('modal-closing');
          setTimeout(() => overlay.remove(), 200);
          await refreshConfig();
          renderModels();
          renderProviders();
          showToast(`Added ${checks.length} model(s)`);
        };

      } catch (e) {
        showToast('Failed to fetch models: ' + e.message, 'error');
      } finally {
        btn.textContent = origText;
        btn.disabled = false;
      }
    }

    // ── Provider CRUD ──
    function editProvider(pk) {
      document.getElementById(`prov-edit-${pk}`)?.classList.toggle('hidden');
    }

    async function saveProvider(pk) {
      const body = {
        provider_key: pk,
        display_name: document.getElementById(`pe-dn-${pk}`)?.value || pk,
        api_base: document.getElementById(`pe-ab-${pk}`)?.value || '',
        api_key_env: document.getElementById(`pe-ke-${pk}`)?.value || '',
        model_id_prefix: document.getElementById(`pe-prefix-${pk}`)?.value.trim() || '',
      };
      const res = await apiFetch('/api/config/provider', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (res.ok) {
        showStatus(`prov-status-${pk}`, true, 'Saved');
        await refreshConfig();
        renderModels();
        renderProviders();
      } else {
        const err = await res.json();
        showStatus(`prov-status-${pk}`, false, err.error || 'Failed');
      }
    }

    async function deleteProvider(pk, displayName, modelCount) {
      showModal('Delete Provider', `Delete <strong>${displayName}</strong> and its ${modelCount} model(s)?`, async () => {
        await apiFetch('/api/config/provider', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: pk}) });
        await refreshConfig();
        renderModels();
        renderProviders();
      }, { danger: true, confirmLabel: 'Delete' });
    }

    function toggleAddProvider() {
      document.getElementById('add-provider-form')?.classList.toggle('hidden');
    }

    async function addProvider() {
      const body = {
        provider_key: document.getElementById('ap-key')?.value.trim(),
        display_name: document.getElementById('ap-dn')?.value.trim(),
        api_base: document.getElementById('ap-ab')?.value.trim(),
        api_key_env: document.getElementById('ap-ke')?.value.trim(),
        model_id_prefix: document.getElementById('ap-prefix')?.value.trim(),
      };
      if (!body.provider_key) { showToast('Provider key is required', 'error'); return; }
      const res = await apiFetch('/api/config/provider', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (res.ok) {
        await refreshConfig();
        renderModels();
        renderProviders();
      } else {
        const err = await res.json();
        showToast(err.error || 'Failed to add provider', 'error');
      }
    }

    async function loadHistory() {
      const container = document.getElementById('historyContainer');
      selectedHistoryRuns.clear();
      document.getElementById('historyCompareBar').classList.add('hidden');
      document.getElementById('historyCompareResult').classList.add('hidden');

      try {
        const res = await apiFetch('/api/history');
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const history = data.runs || [];

        if (!history.length) {
          container.innerHTML = '<div class="card rounded-sm p-10 text-center"><p class="text-zinc-600 font-body">No benchmark history yet.</p><p class="text-zinc-700 text-xs mt-1 font-body">Run your first benchmark to see results here.</p></div>';
          return;
        }

        container.innerHTML = history.map((h, idx) => {
          const ts = new Date(h.timestamp).toLocaleString();
          const sorted = [...(h.results || [])].map(r => ({
            ...r,
            avg_tokens_per_second: r.avg_tokens_per_second ?? r.tokens_per_second ?? 0,
            avg_ttft_ms: r.avg_ttft_ms ?? r.ttft_ms ?? 0,
            avg_total_time_s: r.avg_total_time_s ?? r.total_time_s ?? 0,
            std_dev_tps: r.std_dev_tps ?? 0,
            p50_tps: r.p50_tps ?? 0,
            p95_tps: r.p95_tps ?? 0,
          })).sort((a, b) => b.avg_tokens_per_second - a.avg_tokens_per_second);
          const winner = sorted[0];
          const hasMultiRun = sorted.some(r => (r.runs || 1) > 1);
          const hasMultiCtx = new Set(sorted.map(r => r.context_tokens ?? 0)).size > 1;
          const runId = h.id;

          return `
            <div class="card rounded-sm p-5 fade-in" style="animation-delay: ${idx * 40}ms">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  ${runId ? `<button onclick="toggleHistoryCheckbox(this, '${runId}')" class="w-4 h-4 rounded-sm border flex items-center justify-center transition-all flex-shrink-0" style="border-color:var(--border-subtle)" title="Select for comparison" data-checked="false"></button>` : ''}
                  <span class="text-[11px] text-zinc-600 font-mono">${ts}</span>
                  ${winner ? `<span class="badge" style="background:var(--lime-dim);color:var(--lime);border:1px solid rgba(191,255,0,0.2)">P1: ${winner.model}</span>` : ''}
                  ${(h.context_tiers && h.context_tiers.length) ? `<span class="badge" style="background:rgba(161,161,170,0.1);color:rgb(161,161,170);border:1px solid rgba(161,161,170,0.2)" title="Context tiers tested">CTX ${h.context_tiers.map(t => t === 0 ? '0' : t >= 1000 ? (t/1000) + 'K' : String(t)).join(' / ')}</span>` : ''}
                </div>
                <div class="flex items-center gap-3">
                  ${winner ? `<span class="font-mono text-sm" style="color:var(--lime)">${winner.avg_tokens_per_second} tok/s</span>` : ''}
                  ${runId ? `<button onclick="deleteHistoryRun('${runId}')" class="text-zinc-700 hover:text-red-400 transition-colors" title="Delete run"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>` : ''}
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-xs">
                  <thead><tr class="text-zinc-700">
                    <th class="px-3 py-1.5 text-left section-label">Model</th>
                    ${hasMultiCtx ? '<th class="px-3 py-1.5 text-right section-label">Context</th>' : ''}
                    <th class="px-3 py-1.5 text-right section-label">Tok/s</th>
                    ${hasMultiRun ? '<th class="px-3 py-1.5 text-right section-label">Std Dev</th>' : ''}
                    <th class="px-3 py-1.5 text-right section-label">TTFT</th>
                    <th class="px-3 py-1.5 text-right section-label">Duration</th>
                  </tr></thead>
                  <tbody>
                    ${sorted.map((r, i) => `
                      <tr style="border-top: 1px solid var(--border-subtle)">
                        <td class="px-3 py-2 text-zinc-400 font-body">${r.provider} / ${r.model}</td>
                        ${hasMultiCtx ? `<td class="px-3 py-2 text-right font-mono text-zinc-600">${((r.context_tokens ?? 0) === 0) ? 'Base' : (r.context_tokens >= 1000 ? (r.context_tokens/1000) + 'K' : r.context_tokens)}</td>` : ''}
                        <td class="px-3 py-2 text-right font-mono ${i === 0 ? '' : 'text-zinc-500'}" ${i === 0 ? 'style="color:var(--lime)"' : ''}>${r.avg_tokens_per_second}</td>
                        ${hasMultiRun ? `<td class="px-3 py-2 text-right font-mono text-zinc-600">${r.std_dev_tps > 0 ? '\u00B1' + r.std_dev_tps.toFixed(1) : '-'}</td>` : ''}
                        <td class="px-3 py-2 text-right font-mono text-zinc-600">${r.avg_ttft_ms}ms</td>
                        <td class="px-3 py-2 text-right font-mono text-zinc-600">${r.avg_total_time_s}s</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        console.error('[loadHistory]', e);
        container.innerHTML = '<p class="text-red-400 text-sm font-body">Failed to load history.</p>';
      }
    }

    async function deleteHistoryRun(runId) {
      if (!confirm('Delete this benchmark run?')) return;
      try {
        const res = await apiFetch(`/api/history/${runId}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('Run deleted', 'success');
          loadHistory();
        } else {
          const err = await res.json();
          showToast(err.error || 'Failed to delete run', 'error');
        }
      } catch (e) {
        showToast('Failed to delete run', 'error');
      }
    }

    // -------------------------------------------------------------------
    // Prompt Templates
    // -------------------------------------------------------------------
    let promptTemplates = {};

    async function loadPromptTemplates() {
      try {
        const res = await apiFetch('/api/config/prompts');
        promptTemplates = await res.json();
        const select = document.getElementById('promptTemplateSelect');
        select.innerHTML = '<option value="">Custom</option>';
        for (const [key, tpl] of Object.entries(promptTemplates)) {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = tpl.label || key;
          select.appendChild(opt);
        }
      } catch (e) {
        console.error('Failed to load prompt templates:', e);
      }
    }

    function applyPromptTemplate(key) {
      const textarea = document.getElementById('prompt');
      if (!key) {
        // Custom - leave textarea as is, make it editable
        textarea.removeAttribute('readonly');
        return;
      }
      const tpl = promptTemplates[key];
      if (tpl) {
        textarea.value = tpl.prompt;
        textarea.removeAttribute('readonly');
      }
    }

    // -------------------------------------------------------------------
    // Provider Health Check
    // -------------------------------------------------------------------
    async function checkProviderHealth() {
      const btn = document.getElementById('healthCheckBtn');
      btn.textContent = 'Checking...';
      btn.style.opacity = '0.5';
      btn.disabled = true;

      try {
        const res = await apiFetch('/api/health/providers');
        const data = await res.json();
        const healthMap = {};
        for (const p of data.providers) {
          healthMap[p.name] = p;
        }

        // Update provider group headers with health status
        const headers = document.querySelectorAll('.provider-group-header');
        headers.forEach(header => {
          const labelEl = header.querySelector('.provider-group-label');
          if (!labelEl) return;
          const provName = labelEl.textContent.trim();
          const health = healthMap[provName];

          // Remove any existing health indicator
          const existing = header.querySelector('.health-indicator');
          if (existing) existing.remove();

          if (health) {
            const indicator = document.createElement('span');
            indicator.className = 'health-indicator';
            indicator.style.cssText = 'display:inline-flex;align-items:center;gap:4px;margin-left:4px;';
            if (health.status === 'ok') {
              indicator.innerHTML = `<span style="width:6px;height:6px;border-radius:50%;background:#22C55E;display:inline-block;box-shadow:0 0 6px rgba(34,197,94,0.4)"></span><span style="font-size:9px;font-family:'Space Mono',monospace;color:#8B8B95">${health.latency_ms}ms</span>`;
            } else {
              indicator.innerHTML = `<span style="width:6px;height:6px;border-radius:50%;background:#FF3B5C;display:inline-block;box-shadow:0 0 6px rgba(255,59,92,0.4)"></span><span style="font-size:9px;font-family:'Space Mono',monospace;color:#FF3B5C" title="${health.error || ''}">err</span>`;
            }
            header.appendChild(indicator);
          }
        });

        showToast('Health check complete', 'success');
      } catch (e) {
        showToast('Health check failed: ' + e.message, 'error');
      } finally {
        btn.textContent = 'Check Health';
        btn.style.opacity = '1';
        btn.disabled = false;
      }
    }

    // -------------------------------------------------------------------
    // Cross-Run Comparison (History)
    // -------------------------------------------------------------------
    let selectedHistoryRuns = new Set();

    function toggleHistoryCheckbox(btn, runId) {
      const isChecked = btn.dataset.checked === 'true';
      if (isChecked) {
        btn.dataset.checked = 'false';
        btn.style.borderColor = 'var(--border-subtle)';
        btn.style.background = 'transparent';
        btn.innerHTML = '';
        selectedHistoryRuns.delete(runId);
      } else {
        btn.dataset.checked = 'true';
        btn.style.borderColor = '#38BDF8';
        btn.style.background = 'rgba(56,189,248,0.15)';
        btn.innerHTML = '<svg class="w-2.5 h-2.5" fill="none" stroke="#38BDF8" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
        selectedHistoryRuns.add(runId);
      }
      const bar = document.getElementById('historyCompareBar');
      const countEl = document.getElementById('compareCount');
      if (selectedHistoryRuns.size >= 2) {
        bar.classList.remove('hidden');
        countEl.textContent = selectedHistoryRuns.size;
      } else {
        bar.classList.add('hidden');
      }
    }

    async function compareSelectedRuns() {
      const runIds = Array.from(selectedHistoryRuns);
      if (runIds.length < 2) {
        showToast('Select at least 2 runs to compare', 'error');
        return;
      }

      const container = document.getElementById('historyCompareResult');
      container.innerHTML = '<div class="card rounded-md p-5"><span class="text-zinc-500 text-sm font-body">Loading comparison...</span></div>';
      container.classList.remove('hidden');

      try {
        const runs = await Promise.all(runIds.map(async id => {
          const res = await apiFetch(`/api/history/${id}`);
          return res.json();
        }));

        // Collect all unique models across runs
        const allModels = new Set();
        runs.forEach(run => {
          (run.results || []).forEach(r => {
            allModels.add(`${r.provider}||${r.model}`);
          });
        });
        const modelList = Array.from(allModels).sort();

        // Build comparison table
        const runLabels = runs.map(r => {
          const d = new Date(r.timestamp);
          return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        });

        let tableHtml = `
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">Cross-Run Comparison</span>
              <button onclick="document.getElementById('historyCompareResult').classList.add('hidden')" class="text-[11px] font-display tracking-wider uppercase text-zinc-600 hover:text-zinc-300 px-2 py-1">Close</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-xs results-table">
                <thead><tr style="border-bottom:1px solid var(--border-subtle)">
                  <th class="px-4 py-3 text-left section-label">Model</th>
                  ${runLabels.map(l => `<th class="px-4 py-3 text-right section-label">${l}</th>`).join('')}
                </tr></thead>
                <tbody>`;

        for (const modelKey of modelList) {
          const [provider, model] = modelKey.split('||');
          const color = getColor(provider);
          const values = runs.map(run => {
            const match = (run.results || []).find(r => r.provider === provider && r.model === model);
            if (!match) return null;
            return match.avg_tokens_per_second ?? match.tokens_per_second ?? 0;
          });

          // Find max value for highlighting
          const validValues = values.filter(v => v !== null && v > 0);
          const maxVal = validValues.length ? Math.max(...validValues) : 0;
          const minVal = validValues.length ? Math.min(...validValues) : 0;

          tableHtml += `<tr style="border-top:1px solid var(--border-subtle)">
            <td class="px-4 py-2.5">
              <span class="badge mr-2" style="background:${color.bg};color:${color.text};border:1px solid ${color.border};font-size:9px">${provider}</span>
              <span class="text-zinc-300 font-body text-[12px]">${model}</span>
            </td>`;

          for (const v of values) {
            if (v === null) {
              tableHtml += `<td class="px-4 py-2.5 text-right font-mono text-zinc-700">-</td>`;
            } else {
              let cellColor = 'text-zinc-400';
              if (validValues.length >= 2 && maxVal !== minVal) {
                if (v === maxVal) cellColor = 'text-green-400';
                else if (v === minVal) cellColor = 'text-red-400';
              }
              tableHtml += `<td class="px-4 py-2.5 text-right font-mono ${cellColor}">${v.toFixed ? v.toFixed(1) : v} tok/s</td>`;
            }
          }
          tableHtml += '</tr>';
        }

        tableHtml += '</tbody></table></div></div>';
        container.innerHTML = tableHtml;
      } catch (e) {
        container.innerHTML = `<div class="error-banner">${e.message || 'Failed to load comparison data'}</div>`;
      }
    }

    // -------------------------------------------------------------------
    // -------------------------------------------------------------------
    // Scheduled Benchmarks
    // -------------------------------------------------------------------
    const SCHED_INTERVALS = [
      { value: 1, label: 'Every hour' },
      { value: 6, label: 'Every 6 hours' },
      { value: 12, label: 'Every 12 hours' },
      { value: 24, label: 'Every day' },
      { value: 168, label: 'Every week' },
    ];

    function formatInterval(hours) {
      const m = SCHED_INTERVALS.find(i => i.value === hours);
      if (m) return m.label;
      if (hours < 24) return `Every ${hours}h`;
      if (hours % 168 === 0) return `Every ${hours/168}w`;
      if (hours % 24 === 0) return `Every ${hours/24}d`;
      return `Every ${hours}h`;
    }

    function formatSchedTime(iso) {
      if (!iso) return '--';
      const d = new Date(iso);
      const now = new Date();
      const diffMs = d - now;
      const diffMin = Math.round(diffMs / 60000);
      if (Math.abs(diffMin) < 60) {
        if (diffMin <= 0) return `${Math.abs(diffMin)}m ago`;
        return `in ${diffMin}m`;
      }
      const diffH = Math.round(diffMin / 60);
      if (Math.abs(diffH) < 24) {
        if (diffH <= 0) return `${Math.abs(diffH)}h ago`;
        return `in ${diffH}h`;
      }
      return d.toLocaleDateString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    async function loadSchedules() {
      const tbody = document.getElementById('schedTableBody');
      try {
        const res = await apiFetch('/api/schedules');
        const schedules = await res.json();
        if (!schedules.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No schedules yet. Create one to automate recurring benchmarks.</td></tr>';
          return;
        }
        tbody.innerHTML = schedules.map(s => {
          const models = JSON.parse(s.models_json || '[]');
          return `<tr>
            <td class="px-5 py-3 text-zinc-200 font-body text-sm">${s.name}</td>
            <td class="px-5 py-3 text-center font-mono text-xs text-zinc-400">${models.length}</td>
            <td class="px-5 py-3 text-center text-xs text-zinc-400 font-body">${formatInterval(s.interval_hours)}</td>
            <td class="px-5 py-3 text-right text-xs font-mono text-zinc-500">${formatSchedTime(s.last_run)}</td>
            <td class="px-5 py-3 text-right text-xs font-mono text-zinc-500">${formatSchedTime(s.next_run)}</td>
            <td class="px-5 py-3 text-center">
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="schedToggleEnabled(${s.id}, this.checked)" class="sr-only peer">
                <div class="w-8 h-4 rounded-full peer bg-zinc-700 peer-checked:bg-lime-accent/40 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-4 peer-checked:after:bg-[var(--lime)]"></div>
              </label>
            </td>
            <td class="px-5 py-3 text-right">
              <div class="flex items-center justify-end gap-2">
                <button onclick="schedTrigger(${s.id})" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors px-2 py-1 rounded-sm" style="border:1px solid var(--border-subtle)">Run Now</button>
                <button onclick="schedDelete(${s.id},'${s.name.replace(/'/g,"\\'")}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-red-400 transition-colors px-2 py-1 rounded-sm" style="border:1px solid var(--border-subtle)">Del</button>
              </div>
            </td>
          </tr>`;
        }).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-red-400 text-sm font-body">Failed to load schedules.</td></tr>';
      }
    }

    async function schedToggleEnabled(id, enabled) {
      try {
        await apiFetch(`/api/schedules/${id}`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ enabled: enabled ? 1 : 0 }),
        });
        showToast(enabled ? 'Schedule enabled' : 'Schedule paused', 'success');
      } catch (e) {
        showToast('Failed to update schedule', 'error');
        loadSchedules();
      }
    }

    async function schedTrigger(id) {
      try {
        await apiFetch(`/api/schedules/${id}/trigger`, { method: 'POST' });
        showToast('Schedule triggered - benchmark starting', 'success');
        loadSchedules();
      } catch (e) {
        showToast('Failed to trigger schedule', 'error');
      }
    }

    function schedDelete(id, name) {
      showModal('Delete Schedule', `Delete schedule <strong>${name}</strong>? This cannot be undone.`, async () => {
        try {
          await apiFetch(`/api/schedules/${id}`, { method: 'DELETE' });
          showToast('Schedule deleted', 'success');
          loadSchedules();
        } catch (e) {
          showToast('Failed to delete schedule', 'error');
        }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    // ── New Schedule Modal ──
    let schedSelectedModels = new Set();

    function schedOpenNewModal() {
      if (!config) {
        showToast('Config not loaded yet', 'error');
        return;
      }
      schedSelectedModels = new Set();

      // Build model selection grid (reuse benchmark model card pattern)
      let modelGridHtml = '';
      for (const [provider, provData] of Object.entries(config.providers)) {
        const color = getColor(provider);
        const models = getProviderModels(provData);
        if (!models.length) continue;
        modelGridHtml += `<div class="provider-group" style="border-color:${color.border}">
          <div class="provider-group-header" onclick="schedToggleProviderModels(this, '${provider}')">
            <div class="provider-group-dot" style="background:${color.text}"></div>
            <span class="provider-group-label" style="color:${color.text}">${provider}</span>
            <span class="provider-group-count">${models.length}</span>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 pl-3">
            ${models.map(m => `<div class="model-card rounded-sm px-3 py-2 flex items-center gap-2" data-model-id="${m.model_id}" onclick="schedToggleModel('${m.model_id}', this)">
              <div class="check-dot flex-shrink-0"></div>
              <div class="text-[12px] font-medium text-zinc-200 truncate font-body">${m.display_name}</div>
            </div>`).join('')}
          </div>
        </div>`;
      }

      // Build interval options
      const intervalOpts = SCHED_INTERVALS.map(i =>
        `<option value="${i.value}"${i.value === 24 ? ' selected' : ''}>${i.label}</option>`
      ).join('');

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.id = 'schedModal';
      overlay.innerHTML = `
        <div class="modal-box" style="max-width:600px;max-height:85vh;overflow-y:auto;">
          <div class="modal-title">New Schedule</div>
          <div class="space-y-4">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Schedule Name</label>
              <input id="sched-name" class="modal-input" style="margin-bottom:0" placeholder="e.g. Daily throughput check">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Prompt</label>
              <textarea id="sched-prompt" rows="3" class="prompt-input w-full rounded-sm px-4 py-3" placeholder="Enter benchmark prompt...">Write a short story about a robot learning to paint.</textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Interval</label>
                <select id="sched-interval" class="w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
                  ${intervalOpts}
                </select>
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Max Tokens</label>
                <input type="number" id="sched-max-tokens" value="512" class="w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
              </div>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Temperature</label>
              <input type="number" id="sched-temperature" value="0.7" step="0.1" min="0" max="2" class="w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;max-width:120px;">
            </div>
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Select Models</label>
                <div class="flex gap-2">
                  <button onclick="schedSelectAllModels()" class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">All</button>
                  <button onclick="schedClearAllModels()" class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm text-zinc-600" style="border:1px solid var(--border-subtle)">Clear</button>
                </div>
              </div>
              <div id="schedModelGrid" class="flex flex-col gap-1 max-h-48 overflow-y-auto pr-1" style="scrollbar-width:thin;">
                ${modelGridHtml}
              </div>
              <div class="mt-1 text-[10px] font-mono text-zinc-600"><span id="schedModelCount">0</span> models selected</div>
            </div>
          </div>
          <div class="modal-buttons mt-4">
            <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
            <button class="modal-btn modal-btn-confirm" data-action="confirm">Create Schedule</button>
          </div>
        </div>
      `;
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => schedCreate(overlay);
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => document.getElementById('sched-name')?.focus(), 50);
    }

    function schedToggleModel(modelId, card) {
      if (schedSelectedModels.has(modelId)) {
        schedSelectedModels.delete(modelId);
        card.classList.remove('selected');
      } else {
        schedSelectedModels.add(modelId);
        card.classList.add('selected');
      }
      const cnt = document.getElementById('schedModelCount');
      if (cnt) cnt.textContent = schedSelectedModels.size;
    }

    function schedToggleProviderModels(header, provider) {
      const group = header.parentElement;
      const cards = group.querySelectorAll('.model-card');
      const allSelected = [...cards].every(c => c.classList.contains('selected'));
      cards.forEach(c => {
        const mid = c.dataset.modelId;
        if (allSelected) { schedSelectedModels.delete(mid); c.classList.remove('selected'); }
        else { schedSelectedModels.add(mid); c.classList.add('selected'); }
      });
      const cnt = document.getElementById('schedModelCount');
      if (cnt) cnt.textContent = schedSelectedModels.size;
    }

    function schedSelectAllModels() {
      document.querySelectorAll('#schedModelGrid .model-card').forEach(c => {
        schedSelectedModels.add(c.dataset.modelId);
        c.classList.add('selected');
      });
      const cnt = document.getElementById('schedModelCount');
      if (cnt) cnt.textContent = schedSelectedModels.size;
    }

    function schedClearAllModels() {
      schedSelectedModels.clear();
      document.querySelectorAll('#schedModelGrid .model-card').forEach(c => c.classList.remove('selected'));
      const cnt = document.getElementById('schedModelCount');
      if (cnt) cnt.textContent = 0;
    }

    async function schedCreate(overlay) {
      const name = document.getElementById('sched-name')?.value.trim();
      const prompt = document.getElementById('sched-prompt')?.value.trim();
      const interval_hours = parseInt(document.getElementById('sched-interval')?.value);
      const max_tokens = parseInt(document.getElementById('sched-max-tokens')?.value) || 512;
      const temperature = parseFloat(document.getElementById('sched-temperature')?.value) || 0.7;
      const models = [...schedSelectedModels];

      if (!name) { showToast('Please enter a schedule name', 'error'); return; }
      if (!prompt) { showToast('Please enter a prompt', 'error'); return; }
      if (!models.length) { showToast('Please select at least one model', 'error'); return; }

      try {
        const res = await apiFetch('/api/schedules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, prompt, models, interval_hours, max_tokens, temperature }),
        });
        if (res.ok) {
          _closeModal(overlay);
          showToast('Schedule created', 'success');
          loadSchedules();
        } else {
          const err = await res.json();
          showToast(err.error || 'Failed to create schedule', 'error');
        }
      } catch (e) {
        showToast('Network error creating schedule', 'error');
      }
    }

    // -------------------------------------------------------------------
    // Admin Dashboard
    // -------------------------------------------------------------------
    let auditPage = 0;
    const AUDIT_PAGE_SIZE = 50;

    async function loadAdminDashboard() {
      await Promise.all([loadAdminStats(), loadAdminSystem(), loadAdminJobs(), loadAdminUsers(), loadAuditLog()]);
      // Auto-refresh active processes every 15s while admin tab is visible
      if (_adminJobsInterval) clearInterval(_adminJobsInterval);
      _adminJobsInterval = setInterval(() => {
        if (!document.getElementById('view-admin')?.classList.contains('hidden')) loadAdminJobs();
      }, 15000);
    }

    async function loadAdminStats() {
      try {
        const res = await apiFetch('/api/admin/stats');
        if (!res.ok) return;
        const stats = await res.json();
        const container = document.getElementById('adminStatsCards');
        container.innerHTML = `
          <div class="card rounded-md p-4">
            <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Benchmarks (24h)</div>
            <div class="text-2xl font-display font-bold text-zinc-100">${stats.benchmarks_24h || 0}</div>
          </div>
          <div class="card rounded-md p-4">
            <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Benchmarks (7d)</div>
            <div class="text-2xl font-display font-bold text-zinc-100">${stats.benchmarks_7d || 0}</div>
          </div>
          <div class="card rounded-md p-4">
            <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Benchmarks (30d)</div>
            <div class="text-2xl font-display font-bold text-zinc-100">${stats.benchmarks_30d || 0}</div>
          </div>
          <div class="card rounded-md p-4">
            <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Total Users</div>
            <div class="text-2xl font-display font-bold text-zinc-100">${stats.total_users || 0}</div>
          </div>
        `;

        // Populate audit user filter from top_users + keys_by_provider info
        const userFilter = document.getElementById('auditFilterUser');
        const existingOptions = userFilter.querySelectorAll('option:not(:first-child)');
        existingOptions.forEach(o => o.remove());
        if (stats.top_users) {
          stats.top_users.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.username;
            opt.textContent = u.username;
            userFilter.appendChild(opt);
          });
        }
      } catch {}
    }

    async function loadAdminSystem() {
      try {
        const res = await apiFetch('/api/admin/system');
        if (!res.ok) return;
        const sys = await res.json();
        const container = document.getElementById('adminSystemHealth');
        const upHours = Math.floor((sys.process_uptime_s || 0) / 3600);
        const upMins = Math.floor(((sys.process_uptime_s || 0) % 3600) / 60);
        container.innerHTML = `
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase mb-4">System Health</h3>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div>
              <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">DB Size</div>
              <div class="text-sm font-mono text-zinc-300">${sys.db_size_mb} MB</div>
            </div>
            <div>
              <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Results Files</div>
              <div class="text-sm font-mono text-zinc-300">${sys.results_count} (${sys.results_size_mb} MB)</div>
            </div>
            <div>
              <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Uptime</div>
              <div class="text-sm font-mono text-zinc-300">${upHours}h ${upMins}m</div>
            </div>
            <div>
              <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Benchmark Active</div>
              <div class="text-sm font-mono ${sys.benchmark_active ? 'text-yellow-400' : 'text-zinc-500'}">${sys.benchmark_active ? 'Running' : 'Idle'}</div>
            </div>
          </div>
        `;
      } catch {}
    }

    let _adminJobsInterval = null;

    async function loadAdminJobs() {
      const container = document.getElementById('adminJobsTable');
      if (!container) return;
      try {
        const res = await apiFetch('/api/admin/jobs');
        if (!res.ok) { container.innerHTML = '<p class="text-xs text-zinc-600 font-body">Failed to load.</p>'; return; }
        const data = await res.json();
        const jobs = data.jobs || [];
        if (jobs.length === 0) {
          container.innerHTML = '<p class="text-xs text-zinc-600 font-body py-3">No active processes.</p>';
          return;
        }
        const typeLabels = { benchmark: 'Benchmark', tool_eval: 'Tool Eval', judge: 'Judge', judge_compare: 'Judge Compare', param_tune: 'Param Tuner', prompt_tune: 'Prompt Tuner', scheduled_benchmark: 'Scheduled' };
        const statusColors = { running: '#38BDF8', pending: '#85858F', queued: '#85858F' };
        let html = `<table class="w-full text-xs"><thead><tr style="border-bottom:1px solid var(--border-subtle)">
          <th class="text-left px-3 py-2 text-[10px] font-display tracking-wider uppercase text-zinc-600">Type</th>
          <th class="text-left px-3 py-2 text-[10px] font-display tracking-wider uppercase text-zinc-600">User</th>
          <th class="text-center px-3 py-2 text-[10px] font-display tracking-wider uppercase text-zinc-600">Status</th>
          <th class="text-right px-3 py-2 text-[10px] font-display tracking-wider uppercase text-zinc-600">Progress</th>
          <th class="text-left px-3 py-2 text-[10px] font-display tracking-wider uppercase text-zinc-600">Detail</th>
          <th class="text-left px-3 py-2 text-[10px] font-display tracking-wider uppercase text-zinc-600">Started</th>
          <th class="text-right px-3 py-2 text-[10px] font-display tracking-wider uppercase text-zinc-600">Actions</th>
        </tr></thead><tbody>`;
        for (const j of jobs) {
          const typeLabel = typeLabels[j.job_type] || j.job_type;
          const sColor = statusColors[j.status] || '#85858F';
          const started = j.started_at ? _notifTimeAgo(j.started_at) : (j.created_at ? _notifTimeAgo(j.created_at) : '-');
          const detail = j.progress_detail || '-';
          html += `<tr style="border-bottom:1px solid var(--border-subtle)">
            <td class="px-3 py-2.5 font-body text-zinc-300">${typeLabel}</td>
            <td class="px-3 py-2.5 font-mono text-zinc-500">${j.user_email || '-'}</td>
            <td class="px-3 py-2.5 text-center text-[10px] font-display tracking-wider uppercase" style="color:${sColor}">${j.status}</td>
            <td class="px-3 py-2.5 text-right font-mono text-zinc-400">${j.progress_pct || 0}%</td>
            <td class="px-3 py-2.5 font-body text-zinc-500 max-w-[200px] truncate" title="${(detail || '').replace(/"/g, '&quot;')}">${detail}</td>
            <td class="px-3 py-2.5 font-body text-zinc-500">${started}</td>
            <td class="px-3 py-2.5 text-right">
              <button onclick="adminCancelJob('${j.id}')" class="text-[10px] font-display tracking-wider uppercase" style="color:var(--coral);">Cancel</button>
            </td>
          </tr>`;
        }
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch {
        container.innerHTML = '<p class="text-xs text-zinc-600 font-body">Failed to load processes.</p>';
      }
    }

    async function adminCancelJob(jobId) {
      showModal('Cancel Process', 'Cancel this process? This cannot be undone.', async () => {
        try {
          const res = await apiFetch(`/api/admin/jobs/${jobId}/cancel`, { method: 'POST' });
          if (!res.ok) { showToast('Failed to cancel', 'error'); return; }
          showToast('Process cancelled', 'success');
          await loadAdminJobs();
        } catch { showToast('Failed to cancel', 'error'); }
      }, { danger: true, confirmLabel: 'Cancel Process' });
    }

    async function loadAdminUsers() {
      try {
        const res = await apiFetch('/api/admin/users');
        if (!res.ok) return;
        const data = await res.json();
        const container = document.getElementById('adminUsersTable');
        if (!data.users || data.users.length === 0) {
          container.innerHTML = '<p class="text-zinc-600 text-sm">No users found.</p>';
          return;
        }
        let html = `<table class="w-full text-xs results-table">
          <thead><tr class="text-[10px] font-display tracking-wider uppercase text-zinc-500">
            <th class="text-left px-3 py-2">Email</th>
            <th class="text-left px-3 py-2">Role</th>
            <th class="text-right px-3 py-2">Benchmarks</th>
            <th class="text-right px-3 py-2">Keys</th>
            <th class="text-left px-3 py-2">Last Login</th>
            <th class="text-left px-3 py-2">Created</th>
            <th class="text-right px-3 py-2">Actions</th>
          </tr></thead><tbody>`;

        for (const u of data.users) {
          const isCurrentUser = currentUser && u.id === currentUser.id;
          const lastLogin = u.last_login ? new Date(u.last_login + 'Z').toLocaleDateString() : 'Never';
          const created = u.created_at ? new Date(u.created_at + 'Z').toLocaleDateString() : '-';
          html += `<tr>
            <td class="px-3 py-2 font-mono text-zinc-300">${escapeHtml(u.email)}</td>
            <td class="px-3 py-2">
              <select onchange="changeUserRole('${u.id}', this.value)" class="text-xs font-mono px-1 py-0.5 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:${u.role === 'admin' ? '#BFFF00' : '#A1A1AA'};outline:none;" ${isCurrentUser ? 'disabled title="Cannot change own role"' : ''}>
                <option value="user" ${u.role === 'user' ? 'selected' : ''}>user</option>
                <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>admin</option>
              </select>
            </td>
            <td class="px-3 py-2 text-right font-mono text-zinc-400">${u.benchmark_count || 0}</td>
            <td class="px-3 py-2 text-right font-mono text-zinc-400">${u.key_count || 0}</td>
            <td class="px-3 py-2 text-zinc-500">${lastLogin}</td>
            <td class="px-3 py-2 text-zinc-500">${created}</td>
            <td class="px-3 py-2 text-right" style="white-space:nowrap;">
              <button onclick="showRateLimitModal('${u.id}', '${escapeHtml(u.email)}')" class="text-[10px] font-display tracking-wider uppercase px-2 py-1 rounded-sm" style="border:1px solid var(--border-subtle);color:#85858F;">Limits</button>
              ${isCurrentUser ? '' : `<button onclick="deleteUser('${u.id}', '${escapeHtml(u.email)}')" class="text-[10px] font-display tracking-wider uppercase px-2 py-1 rounded-sm ml-1" style="border:1px solid var(--coral);color:var(--coral);">Delete</button>`}
            </td>
          </tr>`;
        }
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch {}
    }

    async function changeUserRole(userId, newRole) {
      try {
        const res = await apiFetch(`/api/admin/users/${userId}/role`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: newRole }),
        });
        if (res.ok) {
          showToast('Role updated', 'success');
        } else {
          const data = await res.json();
          showToast(data.error || 'Failed to update role', 'error');
          loadAdminUsers(); // Revert UI
        }
      } catch {
        showToast('Failed to update role', 'error');
        loadAdminUsers();
      }
    }

    async function deleteUser(userId, email) {
      if (!confirm(`Delete user "${email}"?\n\nThis will permanently remove the user and ALL their data (keys, benchmarks, evals, schedules). This cannot be undone.`)) return;
      try {
        const res = await apiFetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('User deleted', 'success');
          loadAdminUsers();
          loadAdminStats();
        } else {
          const data = await res.json();
          showToast(data.error || 'Failed to delete user', 'error');
        }
      } catch {
        showToast('Failed to delete user', 'error');
      }
    }

    async function showRateLimitModal(userId, email) {
      try {
        const res = await apiFetch(`/api/admin/users/${userId}/rate-limit`);
        const limits = res.ok ? await res.json() : { benchmarks_per_hour: 20, max_concurrent: 1, max_runs_per_benchmark: 10 };

        const html = `
          <div class="modal-overlay" id="rateLimitModal" style="z-index:10000;" onclick="if(event.target===this)this.remove()">
            <div class="modal-box" style="max-width:380px;">
              <h3 class="font-display font-semibold text-sm text-zinc-100 mb-1">Rate Limits</h3>
              <p class="text-xs text-zinc-500 mb-4">${escapeHtml(email)}</p>
              <div class="space-y-3">
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Benchmarks Per Hour</label>
                  <input type="number" id="rl_bph" value="${limits.benchmarks_per_hour}" min="1" max="1000" class="modal-input w-full">
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Max Concurrent</label>
                  <input type="number" id="rl_mc" value="${limits.max_concurrent}" min="1" max="10" class="modal-input w-full">
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Max Runs Per Benchmark</label>
                  <input type="number" id="rl_mrpb" value="${limits.max_runs_per_benchmark}" min="1" max="50" class="modal-input w-full">
                </div>
              </div>
              <div class="flex gap-2 mt-5">
                <button onclick="document.getElementById('rateLimitModal').remove()" class="modal-btn flex-1">Cancel</button>
                <button onclick="saveRateLimit('${userId}')" class="modal-btn modal-btn-confirm flex-1">Save</button>
              </div>
            </div>
          </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
      } catch {}
    }

    async function saveRateLimit(userId) {
      const bph = parseInt(document.getElementById('rl_bph').value) || 20;
      const mc = parseInt(document.getElementById('rl_mc').value) || 1;
      const mrpb = parseInt(document.getElementById('rl_mrpb').value) || 10;

      try {
        const res = await apiFetch(`/api/admin/users/${userId}/rate-limit`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ benchmarks_per_hour: bph, max_concurrent: mc, max_runs_per_benchmark: mrpb }),
        });
        if (res.ok) {
          showToast('Rate limits updated', 'success');
          document.getElementById('rateLimitModal').remove();
        } else {
          const data = await res.json();
          showToast(data.error || 'Failed to save', 'error');
        }
      } catch {
        showToast('Failed to save rate limits', 'error');
      }
    }

    async function loadAuditLog() {
      try {
        const userFilter = document.getElementById('auditFilterUser').value;
        const actionFilter = document.getElementById('auditFilterAction').value;
        const sinceFilter = document.getElementById('auditFilterSince').value;

        let sinceParam = '';
        if (sinceFilter) {
          const now = new Date();
          const map = { '1h': 3600000, '24h': 86400000, '7d': 604800000, '30d': 2592000000 };
          const ms = map[sinceFilter] || 0;
          if (ms) sinceParam = new Date(now.getTime() - ms).toISOString().replace('T', ' ').slice(0, 19);
        }

        const params = new URLSearchParams();
        if (userFilter) params.set('user', userFilter);
        if (actionFilter) params.set('action', actionFilter);
        if (sinceParam) params.set('since', sinceParam);
        params.set('limit', AUDIT_PAGE_SIZE);
        params.set('offset', auditPage * AUDIT_PAGE_SIZE);

        const res = await apiFetch(`/api/admin/audit?${params.toString()}`);
        if (!res.ok) return;
        const data = await res.json();
        const container = document.getElementById('adminAuditTable');

        if (!data.entries || data.entries.length === 0) {
          container.innerHTML = '<p class="text-zinc-600 text-sm">No audit entries found.</p>';
          document.getElementById('auditPageInfo').textContent = '';
          document.getElementById('auditPrevBtn').disabled = true;
          document.getElementById('auditNextBtn').disabled = true;
          return;
        }

        const actionColors = {
          user_login: 'text-green-400', user_login_failed: 'text-red-400',
          user_register: 'text-blue-400', user_logout: 'text-zinc-500',
          benchmark_start: 'text-yellow-400', benchmark_complete: 'text-green-400',
          benchmark_cancel: 'text-orange-400', admin_user_update: 'text-purple-400',
          admin_rate_limit: 'text-purple-400', token_refresh: 'text-zinc-500',
        };

        let html = `<table class="w-full text-xs results-table">
          <thead><tr class="text-[10px] font-display tracking-wider uppercase text-zinc-500">
            <th class="text-left px-3 py-2">Time</th>
            <th class="text-left px-3 py-2">User</th>
            <th class="text-left px-3 py-2">Action</th>
            <th class="text-left px-3 py-2">Resource</th>
            <th class="text-left px-3 py-2">Detail</th>
            <th class="text-left px-3 py-2">IP</th>
          </tr></thead><tbody>`;

        for (const e of data.entries) {
          const ts = e.timestamp ? new Date(e.timestamp + 'Z').toLocaleString() : '-';
          const color = actionColors[e.action] || 'text-zinc-400';
          let detail = '';
          if (e.detail) {
            try { detail = typeof e.detail === 'string' ? e.detail : JSON.stringify(e.detail); } catch { detail = ''; }
            if (detail.length > 60) detail = detail.slice(0, 57) + '...';
          }
          html += `<tr>
            <td class="px-3 py-2 text-zinc-500 whitespace-nowrap">${ts}</td>
            <td class="px-3 py-2 font-mono text-zinc-400">${escapeHtml(e.username || '')}</td>
            <td class="px-3 py-2 font-mono ${color}">${escapeHtml(e.action || '')}</td>
            <td class="px-3 py-2 text-zinc-500">${escapeHtml(e.resource_type || '')}${e.resource_id ? ':' + escapeHtml(e.resource_id) : ''}</td>
            <td class="px-3 py-2 text-zinc-600 font-mono" title="${escapeHtml(detail)}">${escapeHtml(detail)}</td>
            <td class="px-3 py-2 text-zinc-600 font-mono">${escapeHtml(e.ip_address || '')}</td>
          </tr>`;
        }
        html += '</tbody></table>';
        container.innerHTML = html;

        const from = auditPage * AUDIT_PAGE_SIZE + 1;
        const to = from + data.entries.length - 1;
        document.getElementById('auditPageInfo').textContent = `${from}-${to}`;
        document.getElementById('auditPrevBtn').disabled = auditPage === 0;
        document.getElementById('auditNextBtn').disabled = data.entries.length < AUDIT_PAGE_SIZE;
      } catch {}
    }

    function auditPrevPage() {
      if (auditPage > 0) { auditPage--; loadAuditLog(); }
    }
    function auditNextPage() {
      auditPage++; loadAuditLog();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // -------------------------------------------------------------------
    // Analytics — Leaderboard, Compare, Trends
    // -------------------------------------------------------------------
    const AN_CHART_COLORS = [
      '#BFFF00', '#00d4ff', '#ff6b6b', '#ffd93d',
      '#6bcb77', '#4d96ff', '#ff9f43', '#a855f7',
    ];

    let anLeaderboardData = [];
    let anLeaderboardType = 'benchmark';
    let anLeaderboardSortKey = 'avg_tps';
    let anLeaderboardSortAsc = false;
    let anCompareSelectedRuns = new Set();
    let anCompareTpsChart = null;
    let anCompareTtftChart = null;
    let anTrendsTpsChart = null;
    let anTrendsTtftChart = null;
    let anTrendsSelectedModels = new Set();
    let anTrendsModelDropdownOpen = false;
    let anCompareRunsCache = [];

    // --- Sub-view toggling ---
    function anSetSubBtn(active) {
      ['leaderboard', 'compare', 'trends'].forEach(v => {
        const btn = document.getElementById('an-btn-' + v);
        if (v === active) {
          btn.style.color = 'var(--lime)';
          btn.style.border = '1px solid rgba(191,255,0,0.3)';
          btn.style.background = 'var(--lime-dim)';
        } else {
          btn.style.color = '#85858F';
          btn.style.border = '1px solid var(--border-subtle)';
          btn.style.background = 'transparent';
        }
      });
    }

    function analyticsShowLeaderboard() {
      document.getElementById('an-leaderboard-view').classList.remove('hidden');
      document.getElementById('an-compare-view').classList.add('hidden');
      document.getElementById('an-trends-view').classList.add('hidden');
      anSetSubBtn('leaderboard');
      analyticsLoadLeaderboard();
    }

    function analyticsShowCompare() {
      document.getElementById('an-leaderboard-view').classList.add('hidden');
      document.getElementById('an-compare-view').classList.remove('hidden');
      document.getElementById('an-trends-view').classList.add('hidden');
      anSetSubBtn('compare');
      anLoadCompareRuns();
    }

    function analyticsShowTrends() {
      document.getElementById('an-leaderboard-view').classList.add('hidden');
      document.getElementById('an-compare-view').classList.add('hidden');
      document.getElementById('an-trends-view').classList.remove('hidden');
      anSetSubBtn('trends');
      anLoadTrendsModels();
    }

    // --- Leaderboard ---
    function anSetLeaderboardType(type) {
      anLeaderboardType = type;
      const btnB = document.getElementById('an-lb-type-benchmark');
      const btnT = document.getElementById('an-lb-type-tool_eval');
      if (type === 'benchmark') {
        btnB.style.color = 'var(--lime)'; btnB.style.border = '1px solid rgba(191,255,0,0.3)'; btnB.style.background = 'var(--lime-dim)';
        btnT.style.color = '#85858F'; btnT.style.border = '1px solid var(--border-subtle)'; btnT.style.background = 'transparent';
        anLeaderboardSortKey = 'avg_tps';
      } else {
        btnT.style.color = 'var(--lime)'; btnT.style.border = '1px solid rgba(191,255,0,0.3)'; btnT.style.background = 'var(--lime-dim)';
        btnB.style.color = '#85858F'; btnB.style.border = '1px solid var(--border-subtle)'; btnB.style.background = 'transparent';
        anLeaderboardSortKey = 'avg_overall_pct';
      }
      anLeaderboardSortAsc = false;
      anUpdateLeaderboardHeaders();
      analyticsLoadLeaderboard();
    }

    function anUpdateLeaderboardHeaders() {
      const head = document.getElementById('anLeaderboardHead');
      if (anLeaderboardType === 'benchmark') {
        head.innerHTML = `<tr style="border-bottom: 1px solid var(--border-subtle)">
          <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('rank')">#</th>
          <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('model')">Model</th>
          <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('provider')">Provider</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_tps')">Avg TPS</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_ttft_ms')">Avg TTFT</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_cost')">Avg Cost</th>
          <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('total_runs')">Runs</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('last_run')">Last Run</th>
        </tr>`;
      } else {
        head.innerHTML = `<tr style="border-bottom: 1px solid var(--border-subtle)">
          <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('rank')">#</th>
          <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('model')">Model</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_tool_pct')">Avg Tool %</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_param_pct')">Avg Param %</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_overall_pct')">Avg Overall %</th>
          <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('total_evals')">Evals</th>
        </tr>`;
      }
    }

    async function analyticsLoadLeaderboard() {
      const body = document.getElementById('anLeaderboardBody');
      const period = document.getElementById('anLeaderboardPeriod').value;
      const colCount = anLeaderboardType === 'benchmark' ? 8 : 6;
      body.innerHTML = `<tr><td colspan="${colCount}" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">Loading...</td></tr>`;

      try {
        const res = await apiFetch(`/api/analytics/leaderboard?type=${anLeaderboardType}&period=${period}`);
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        anLeaderboardData = data.models || [];
        anRenderLeaderboard();
      } catch (e) {
        body.innerHTML = `<tr><td colspan="${colCount}" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No benchmark data yet. Run some benchmarks first!</td></tr>`;
      }
    }

    function anSortLeaderboard(key) {
      if (key === 'rank') { anLeaderboardSortKey = anLeaderboardType === 'benchmark' ? 'avg_tps' : 'avg_overall_pct'; anLeaderboardSortAsc = false; }
      else if (anLeaderboardSortKey === key) { anLeaderboardSortAsc = !anLeaderboardSortAsc; }
      else { anLeaderboardSortKey = key; anLeaderboardSortAsc = false; }
      anRenderLeaderboard();
    }

    function anRenderLeaderboard() {
      const body = document.getElementById('anLeaderboardBody');
      if (!anLeaderboardData.length) {
        const colCount = anLeaderboardType === 'benchmark' ? 8 : 6;
        body.innerHTML = `<tr><td colspan="${colCount}" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No benchmark data yet. Run some benchmarks first!</td></tr>`;
        return;
      }

      const sorted = [...anLeaderboardData].sort((a, b) => {
        let va = a[anLeaderboardSortKey], vb = b[anLeaderboardSortKey];
        if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
        if (va < vb) return anLeaderboardSortAsc ? -1 : 1;
        if (va > vb) return anLeaderboardSortAsc ? 1 : -1;
        return 0;
      });

      if (anLeaderboardType === 'benchmark') {
        body.innerHTML = sorted.map((m, i) => {
          const rank = i + 1;
          const rowClass = rank === 1 ? 'rank-1' : '';
          const lastRun = m.last_run ? new Date(m.last_run).toLocaleDateString() : '-';
          const cost = m.avg_cost != null && m.avg_cost > 0 ? '$' + m.avg_cost.toFixed(4) : 'N/A';
          return `<tr class="${rowClass}" style="border-top:1px solid var(--border-subtle)">
            <td class="px-5 py-3 text-center font-mono text-zinc-500 text-xs">${rank}</td>
            <td class="px-5 py-3 text-left font-body text-zinc-200 text-sm">${escapeHtml(m.model)}</td>
            <td class="px-5 py-3 text-left font-body text-zinc-500 text-xs">${escapeHtml(m.provider || '')}</td>
            <td class="px-5 py-3 text-right font-mono text-sm" ${rank === 1 ? 'style="color:var(--lime)"' : 'style="color:#A1A1AA"'}>${m.avg_tps.toFixed(1)}</td>
            <td class="px-5 py-3 text-right font-mono text-sm text-zinc-400">${m.avg_ttft_ms.toFixed(0)}ms</td>
            <td class="px-5 py-3 text-right font-mono text-xs text-zinc-500">${cost}</td>
            <td class="px-5 py-3 text-center font-mono text-xs text-zinc-500">${m.total_runs}</td>
            <td class="px-5 py-3 text-right font-mono text-xs text-zinc-600">${lastRun}</td>
          </tr>`;
        }).join('');
      } else {
        body.innerHTML = sorted.map((m, i) => {
          const rank = i + 1;
          const rowClass = rank === 1 ? 'rank-1' : '';
          return `<tr class="${rowClass}" style="border-top:1px solid var(--border-subtle)">
            <td class="px-5 py-3 text-center font-mono text-zinc-500 text-xs">${rank}</td>
            <td class="px-5 py-3 text-left font-body text-zinc-200 text-sm">${escapeHtml(m.model)}</td>
            <td class="px-5 py-3 text-right font-mono text-sm text-zinc-400">${(m.avg_tool_pct || 0).toFixed(1)}%</td>
            <td class="px-5 py-3 text-right font-mono text-sm text-zinc-400">${(m.avg_param_pct || 0).toFixed(1)}%</td>
            <td class="px-5 py-3 text-right font-mono text-sm" ${rank === 1 ? 'style="color:var(--lime)"' : 'style="color:#A1A1AA"'}>${(m.avg_overall_pct || 0).toFixed(1)}%</td>
            <td class="px-5 py-3 text-center font-mono text-xs text-zinc-500">${m.total_evals || 0}</td>
          </tr>`;
        }).join('');
      }
    }

    // --- Compare ---
    async function anLoadCompareRuns() {
      const listEl = document.getElementById('anCompareRunsList');
      listEl.innerHTML = '<p class="text-zinc-600 text-xs font-body">Loading recent runs...</p>';
      anCompareSelectedRuns.clear();
      anUpdateCompareBtn();

      try {
        const res = await apiFetch('/api/history');
        const data = await res.json();
        anCompareRunsCache = (data.runs || []).filter(r => r.id);

        if (!anCompareRunsCache.length) {
          listEl.innerHTML = '<p class="text-zinc-600 text-xs font-body">No benchmark runs found.</p>';
          return;
        }

        listEl.innerHTML = anCompareRunsCache.slice(0, 20).map(run => {
          const ts = new Date(run.timestamp).toLocaleString();
          const modelCount = (run.results || []).length;
          const prompt = (run.prompt || '').substring(0, 50);
          return `<label class="flex items-center gap-3 px-3 py-2 rounded-sm cursor-pointer transition-colors hover:bg-white/[0.02]" style="border:1px solid var(--border-subtle)">
            <input type="checkbox" value="${run.id}" onchange="anToggleCompareRun(this)" class="accent-lime-400 w-3.5 h-3.5" />
            <span class="text-xs font-mono text-zinc-500">${ts}</span>
            <span class="text-xs font-body text-zinc-400 truncate flex-1">${escapeHtml(prompt || 'Benchmark run')}</span>
            <span class="text-[10px] font-mono text-zinc-600">${modelCount} models</span>
          </label>`;
        }).join('');
      } catch (e) {
        listEl.innerHTML = '<p class="text-zinc-600 text-xs font-body">Failed to load runs.</p>';
      }
    }

    function anToggleCompareRun(checkbox) {
      if (checkbox.checked) {
        if (anCompareSelectedRuns.size >= 4) { checkbox.checked = false; showToast('Max 4 runs', 'error'); return; }
        anCompareSelectedRuns.add(checkbox.value);
      } else {
        anCompareSelectedRuns.delete(checkbox.value);
      }
      anUpdateCompareBtn();
    }

    function anUpdateCompareBtn() {
      const btn = document.getElementById('anCompareBtn');
      const n = anCompareSelectedRuns.size;
      if (n >= 2) {
        btn.disabled = false;
        btn.style.color = 'var(--lime)';
        btn.style.border = '1px solid rgba(191,255,0,0.3)';
        btn.style.cursor = 'pointer';
        btn.style.opacity = '1';
      } else {
        btn.disabled = true;
        btn.style.color = '#85858F';
        btn.style.border = '1px solid var(--border-subtle)';
        btn.style.cursor = 'not-allowed';
        btn.style.opacity = '0.5';
      }
    }

    async function analyticsLoadCompare() {
      if (anCompareSelectedRuns.size < 2) return;
      const ids = Array.from(anCompareSelectedRuns).join(',');

      try {
        const res = await apiFetch(`/api/analytics/compare?runs=${ids}`);
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        anRenderCompareCharts(data.runs || []);
      } catch (e) {
        // Fallback: fetch runs individually from history
        try {
          const runs = await Promise.all(Array.from(anCompareSelectedRuns).map(async id => {
            const r = await apiFetch(`/api/history/${id}`);
            return r.json();
          }));
          anRenderCompareCharts(runs);
        } catch (e2) {
          showToast('Failed to load comparison data', 'error');
        }
      }
    }

    function anRenderCompareCharts(runs) {
      if (!runs.length) return;

      document.getElementById('anCompareCharts').classList.remove('hidden');
      document.getElementById('anCompareEmpty').classList.add('hidden');

      // Collect all models across runs
      const allModels = new Set();
      runs.forEach(run => {
        (run.results || run.models || []).forEach(r => {
          allModels.add(r.model || r.display_name);
        });
      });
      const modelList = Array.from(allModels).sort();

      // Build run labels
      const runLabels = runs.map(r => {
        const d = new Date(r.timestamp);
        const prompt = (r.prompt || '').substring(0, 20);
        return d.toLocaleDateString() + (prompt ? ' - ' + prompt : '');
      });

      // TPS data
      const tpsDatasets = runs.map((run, ri) => {
        const results = run.results || run.models || [];
        return {
          label: runLabels[ri],
          data: modelList.map(m => {
            const match = results.find(r => (r.model || r.display_name) === m);
            return match ? (match.avg_tokens_per_second ?? match.avg_tps ?? 0) : 0;
          }),
          backgroundColor: AN_CHART_COLORS[ri % AN_CHART_COLORS.length] + 'CC',
          borderColor: AN_CHART_COLORS[ri % AN_CHART_COLORS.length],
          borderWidth: 0,
          borderRadius: 2,
        };
      });

      // TTFT data
      const ttftDatasets = runs.map((run, ri) => {
        const results = run.results || run.models || [];
        return {
          label: runLabels[ri],
          data: modelList.map(m => {
            const match = results.find(r => (r.model || r.display_name) === m);
            return match ? (match.avg_ttft_ms ?? 0) : 0;
          }),
          backgroundColor: AN_CHART_COLORS[ri % AN_CHART_COLORS.length] + 'CC',
          borderColor: AN_CHART_COLORS[ri % AN_CHART_COLORS.length],
          borderWidth: 0,
          borderRadius: 2,
        };
      });

      const chartOpts = (title, unit) => ({
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 800, easing: 'easeOutQuart' },
        plugins: {
          legend: {
            display: true,
            labels: { color: '#85858F', font: { family: 'Outfit', size: 11 }, boxWidth: 12, padding: 16 }
          },
          tooltip: {
            backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
            titleFont: { family: 'Outfit', size: 13, weight: '500' },
            bodyFont: { family: 'Space Mono', size: 12 },
            padding: 12, cornerRadius: 2,
            callbacks: { label: ctx => ` ${ctx.parsed.y.toFixed(1)} ${unit}` }
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
            ticks: { color: '#85858F', font: { family: 'Outfit', size: 11 }, maxRotation: 45 }
          },
          y: {
            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
            ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
            title: { display: true, text: title, color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' } }
          }
        }
      });

      // Destroy old charts
      if (anCompareTpsChart) { anCompareTpsChart.destroy(); anCompareTpsChart = null; }
      if (anCompareTtftChart) { anCompareTtftChart.destroy(); anCompareTtftChart = null; }

      anCompareTpsChart = new Chart(document.getElementById('anCompareTpsChart'), {
        type: 'bar',
        data: { labels: modelList, datasets: tpsDatasets },
        options: chartOpts('TOKENS / SECOND', 'tok/s')
      });

      anCompareTtftChart = new Chart(document.getElementById('anCompareTtftChart'), {
        type: 'bar',
        data: { labels: modelList, datasets: ttftDatasets },
        options: chartOpts('TIME TO FIRST TOKEN (MS)', 'ms')
      });
    }

    // --- Trends ---
    async function anLoadTrendsModels() {
      // Populate model list from leaderboard data
      try {
        const res = await apiFetch('/api/analytics/leaderboard?type=benchmark&period=all');
        if (!res.ok) return;
        const data = await res.json();
        const models = data.models || [];
        const listEl = document.getElementById('anTrendsModelList');

        if (!models.length) {
          listEl.innerHTML = '<p class="text-zinc-600 text-xs font-body px-2 py-1">No models found.</p>';
          return;
        }

        listEl.innerHTML = models.map(m => {
          const checked = anTrendsSelectedModels.has(m.model) ? 'checked' : '';
          return `<label class="flex items-center gap-2 px-2 py-1 rounded-sm cursor-pointer hover:bg-white/[0.03] text-xs text-zinc-400 font-body">
            <input type="checkbox" value="${escapeHtml(m.model)}" ${checked} onchange="anToggleTrendModel(this)" class="accent-lime-400 w-3 h-3" />
            ${escapeHtml(m.model)}
          </label>`;
        }).join('');
      } catch (e) { /* ignore */ }
    }

    function anToggleModelDropdown() {
      anTrendsModelDropdownOpen = !anTrendsModelDropdownOpen;
      document.getElementById('anTrendsModelList').classList.toggle('hidden', !anTrendsModelDropdownOpen);
    }

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
      const dd = document.getElementById('anTrendsModelDropdown');
      if (dd && !dd.contains(e.target) && anTrendsModelDropdownOpen) {
        anTrendsModelDropdownOpen = false;
        document.getElementById('anTrendsModelList').classList.add('hidden');
      }
    });

    function anToggleTrendModel(checkbox) {
      if (checkbox.checked) {
        anTrendsSelectedModels.add(checkbox.value);
      } else {
        anTrendsSelectedModels.delete(checkbox.value);
      }
      const label = document.getElementById('anTrendsModelLabel');
      const n = anTrendsSelectedModels.size;
      label.textContent = n === 0 ? 'Select Models' : n + ' model' + (n > 1 ? 's' : '') + ' selected';
      if (n > 0) analyticsLoadTrends();
    }

    async function analyticsLoadTrends() {
      if (anTrendsSelectedModels.size === 0) {
        document.getElementById('anTrendsCharts').classList.add('hidden');
        document.getElementById('anTrendsEmpty').classList.remove('hidden');
        return;
      }

      const models = Array.from(anTrendsSelectedModels).join(',');
      const period = document.getElementById('anTrendsPeriod').value;

      try {
        // Fetch TPS trends
        const resTps = await apiFetch(`/api/analytics/trends?models=${encodeURIComponent(models)}&metric=tps&period=${period}`);
        const dataTps = await resTps.json();

        // Fetch TTFT trends
        const resTtft = await apiFetch(`/api/analytics/trends?models=${encodeURIComponent(models)}&metric=ttft&period=${period}`);
        const dataTtft = await resTtft.json();

        anRenderTrendsCharts(dataTps, dataTtft);
      } catch (e) {
        showToast('Failed to load trends', 'error');
      }
    }

    function anRenderTrendsCharts(tpsData, ttftData) {
      document.getElementById('anTrendsCharts').classList.remove('hidden');
      document.getElementById('anTrendsEmpty').classList.add('hidden');

      const buildDatasets = (data) => {
        return (data.series || []).map((s, i) => ({
          label: s.model,
          data: (s.points || []).map(p => ({ x: new Date(p.timestamp), y: p.value })),
          borderColor: AN_CHART_COLORS[i % AN_CHART_COLORS.length],
          backgroundColor: AN_CHART_COLORS[i % AN_CHART_COLORS.length] + '33',
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: AN_CHART_COLORS[i % AN_CHART_COLORS.length],
          pointBorderColor: '#09090B',
          pointBorderWidth: 2,
          tension: 0.3,
          fill: false,
        }));
      };

      const lineOpts = (yTitle) => ({
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 800, easing: 'easeOutQuart' },
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            display: true,
            labels: { color: '#85858F', font: { family: 'Outfit', size: 11 }, boxWidth: 12, padding: 16 }
          },
          tooltip: {
            backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
            titleFont: { family: 'Outfit', size: 13, weight: '500' },
            bodyFont: { family: 'Space Mono', size: 12 },
            padding: 12, cornerRadius: 2,
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day', tooltipFormat: 'MMM d, yyyy HH:mm' },
            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
            ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 10 } }
          },
          y: {
            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
            ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
            title: { display: true, text: yTitle, color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' } }
          }
        }
      });

      // Destroy old charts
      if (anTrendsTpsChart) { anTrendsTpsChart.destroy(); anTrendsTpsChart = null; }
      if (anTrendsTtftChart) { anTrendsTtftChart.destroy(); anTrendsTtftChart = null; }

      const tpsDatasets = buildDatasets(tpsData);
      const ttftDatasets = buildDatasets(ttftData);

      if (tpsDatasets.length) {
        anTrendsTpsChart = new Chart(document.getElementById('anTrendsTpsChart'), {
          type: 'line',
          data: { datasets: tpsDatasets },
          options: lineOpts('TOKENS / SECOND')
        });
      }

      if (ttftDatasets.length) {
        anTrendsTtftChart = new Chart(document.getElementById('anTrendsTtftChart'), {
          type: 'line',
          data: { datasets: ttftDatasets },
          options: lineOpts('TTFT (MS)')
        });
      }
    }

    // -------------------------------------------------------------------
    // Provider Parameters — Per-provider param config (pp prefix)
    // -------------------------------------------------------------------

    // Client-side registry (matches architect spec). Replaced by API when available.
    const PP_REGISTRY = {
      openai: {
        display_name: 'OpenAI',
        tier1: {
          temperature: { min: 0, max: 2, default: 1, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 128000, default: 4096, type: 'int', required: false },
          stop: { type: 'string_array', max_items: 4 }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: 1, step: 0.05, type: 'float', supported: true },
          top_k: { supported: false, reason: 'OpenAI does not support top_k' },
          frequency_penalty: { min: -2, max: 2, default: 0, step: 0.1, type: 'float', supported: true },
          presence_penalty: { min: -2, max: 2, default: 0, step: 0.1, type: 'float', supported: true },
          seed: { type: 'int', supported: true, deprecated: true, note: 'Seed is deprecated for OpenAI' },
          reasoning_effort: { type: 'enum', values: ['none','low','medium','high'], supported: true, note: 'Only for reasoning models (o-series, GPT-5)' }
        },
        tier3_examples: {
          service_tier: { type: 'string', values: ['auto','default','flex','priority'] },
          prediction: { type: 'object' },
          web_search_options: { type: 'object' }
        },
        conflicts: [
          { params: ['temperature'], condition: "model contains 'gpt-5'", resolution: 'Lock to 1.0', message: 'GPT-5 locks temperature to 1.0' }
        ],
        model_overrides: {
          'gpt-5*': { temperature: { locked: true, value: 1.0 } },
          'o1*|o3*|o4*': { temperature: { locked: true, value: 1.0 }, stop: { supported: false } }
        }
      },
      anthropic: {
        display_name: 'Anthropic',
        tier1: {
          temperature: { min: 0, max: 1, default: 1, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 128000, default: 4096, type: 'int', required: true, note: 'Anthropic REQUIRES max_tokens' }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: null, step: 0.05, type: 'float', supported: true, note: 'Cannot use with temperature on newer models' },
          top_k: { min: 1, max: 500, default: null, type: 'int', supported: true },
          frequency_penalty: { supported: false, reason: 'Anthropic does not support penalty parameters' },
          presence_penalty: { supported: false, reason: 'Anthropic does not support penalty parameters' },
          seed: { supported: false, reason: 'Anthropic does not support seed' },
          reasoning_effort: { type: 'enum', values: ['none','low','medium','high'], supported: true, note: 'Maps to thinking.budget_tokens' }
        },
        tier3_examples: {
          cache_control: { type: 'object' },
          inference_geo: { type: 'string' }
        },
        conflicts: [
          { params: ['temperature','top_p'], condition: 'both set on newer models', resolution: 'Drop top_p, keep temperature', message: 'Anthropic newer models cannot use both temperature and top_p' }
        ]
      },
      gemini: {
        display_name: 'Google Gemini',
        tier1: {
          temperature: { min: 0, max: 2, default: 1, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 65536, default: 4096, type: 'int', required: false }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: null, step: 0.05, type: 'float', supported: true },
          top_k: { min: 1, max: 100, default: null, type: 'int', supported: true },
          frequency_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          presence_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          seed: { type: 'int', supported: true },
          reasoning_effort: { type: 'enum', values: ['none','low','medium','high'], supported: true, note: 'Maps to thinkingConfig.thinkingLevel' }
        },
        tier3_examples: {
          safety_settings: { type: 'array' }
        },
        conflicts: []
      },
      ollama: {
        display_name: 'Ollama / Local',
        tier1: {
          temperature: { min: 0, max: 2, default: 0.8, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 32768, default: 4096, type: 'int', required: false }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: 0.9, step: 0.05, type: 'float', supported: true },
          top_k: { min: 1, max: 500, default: 40, type: 'int', supported: true },
          frequency_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          presence_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          seed: { type: 'int', supported: true },
          reasoning_effort: { supported: false }
        },
        tier3_examples: {
          mirostat: { type: 'int', values: [0,1,2], note: 'Mirostat sampling mode' },
          mirostat_eta: { type: 'float', note: 'Mirostat learning rate' },
          mirostat_tau: { type: 'float', note: 'Mirostat target entropy' },
          repetition_penalty: { type: 'float', min: 0, max: 3, note: 'Multiplicative penalty' },
          num_ctx: { type: 'int', note: 'Context window size override' },
          min_p: { type: 'float', min: 0, max: 1, note: 'Minimum probability threshold' },
          keep_alive: { type: 'string', note: 'Model memory duration' }
        },
        conflicts: [],
        info_banner: 'Ollama defaults to 2048 token context. Set num_ctx in Custom Parameters to increase (e.g. {"num_ctx": 8192}).'
      },
      lm_studio: {
        display_name: 'LM Studio',
        tier1: {
          temperature: { min: 0, max: 2, default: 0.8, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 32768, default: 4096, type: 'int', required: false }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: 0.9, step: 0.05, type: 'float', supported: true },
          top_k: { min: 1, max: 500, default: 40, type: 'int', supported: true },
          frequency_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          presence_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          seed: { type: 'int', supported: true },
          reasoning_effort: { supported: false }
        },
        tier3_examples: {
          repetition_penalty: { type: 'float', min: 0, max: 3 },
          min_p: { type: 'float', min: 0, max: 1 }
        },
        conflicts: []
      },
      mistral: {
        display_name: 'Mistral',
        tier1: {
          temperature: { min: 0, max: 1.5, default: 0.7, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 32768, default: 4096, type: 'int', required: false }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: 1, step: 0.05, type: 'float', supported: true },
          top_k: { supported: 'partial', reason: 'Limited support in Mistral API' },
          frequency_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          presence_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          seed: { type: 'int', supported: true },
          reasoning_effort: { supported: false }
        },
        tier3_examples: {
          safe_prompt: { type: 'boolean' }
        },
        conflicts: []
      },
      deepseek: {
        display_name: 'DeepSeek',
        tier1: {
          temperature: { min: 0, max: 2, default: 1, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 65536, default: 4096, type: 'int', required: false }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: 1, step: 0.05, type: 'float', supported: true },
          top_k: { supported: false },
          frequency_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          presence_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          seed: { supported: false },
          reasoning_effort: { type: 'enum', values: ['none','enabled'], supported: true, note: 'Any value enables thinking mode' }
        },
        conflicts: []
      },
      cohere: {
        display_name: 'Cohere',
        tier1: {
          temperature: { min: 0, max: 1, default: 0.3, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 4096, default: 4096, type: 'int', required: false }
        },
        tier2: {
          top_p: { min: 0, max: 0.99, default: null, step: 0.05, type: 'float', supported: true },
          top_k: { min: 0, max: 500, default: null, type: 'int', supported: true },
          frequency_penalty: { min: 0, max: 1, default: 0, type: 'float', supported: true, note: 'Range 0-1 only' },
          presence_penalty: { min: 0, max: 1, default: 0, type: 'float', supported: true, note: 'Range 0-1 only' },
          seed: { type: 'int', supported: true },
          reasoning_effort: { supported: false }
        },
        conflicts: []
      },
      xai: {
        display_name: 'xAI (Grok)',
        tier1: {
          temperature: { min: 0, max: 2, default: 1, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 131072, default: 4096, type: 'int', required: false }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: 1, step: 0.05, type: 'float', supported: true },
          top_k: { supported: false },
          frequency_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          presence_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          seed: { type: 'int', default: 0, supported: true },
          reasoning_effort: { type: 'enum', values: ['none','low','medium','high'], supported: 'partial', note: 'Reasoning models reject penalties when active' }
        },
        conflicts: []
      },
      vllm: {
        display_name: 'vLLM (Self-Hosted)',
        tier1: {
          temperature: { min: 0, max: 2, default: 1, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 65536, default: 4096, type: 'int', required: false }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: 1, step: 0.05, type: 'float', supported: true },
          top_k: { min: 1, max: 500, default: null, type: 'int', supported: true },
          frequency_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          presence_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: true },
          seed: { type: 'int', supported: true },
          reasoning_effort: { supported: false }
        },
        conflicts: []
      },
      _unknown: {
        display_name: 'Unknown (OpenAI-compatible)',
        tier1: {
          temperature: { min: 0, max: 2, default: 1, step: 0.1, type: 'float' },
          max_tokens: { min: 1, max: 128000, default: 4096, type: 'int', required: false }
        },
        tier2: {
          top_p: { min: 0, max: 1, default: 1, type: 'float', supported: 'unknown' },
          top_k: { supported: 'unknown' },
          frequency_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: 'unknown' },
          presence_penalty: { min: -2, max: 2, default: 0, type: 'float', supported: 'unknown' },
          seed: { type: 'int', supported: 'unknown' },
          reasoning_effort: { supported: 'unknown' }
        },
        conflicts: []
      }
    };

    let ppRegistry = PP_REGISTRY; // replaced by API response when available
    let ppActiveTab = {};         // context -> active provider key
    let ppValues = {};            // context -> provider -> param -> value
    let ppCollapsed = { advanced: true, custom: true }; // shared collapse state

    // Provider key aliases for matching config providers to registry
    const PP_KEY_ALIASES = {
      google: 'gemini', google_gemini: 'gemini', zai: '_unknown', zai_glm: '_unknown'
    };

    function ppResolveProvider(configKey) {
      const k = configKey.toLowerCase().replace(/[\s-]/g, '_');
      if (ppRegistry[k]) return k;
      if (PP_KEY_ALIASES[k]) return PP_KEY_ALIASES[k];
      // Try prefix match
      for (const rk of Object.keys(ppRegistry)) {
        if (rk !== '_unknown' && k.startsWith(rk)) return rk;
      }
      return '_unknown';
    }

    function ppGetSelectedProviders(context) {
      const sel = context === 'benchmark' ? selectedModels : teSelectedModels;
      if (!config || !config.providers || sel.size === 0) return [];
      const provs = new Map(); // registryKey -> {configKey, displayName, models[]}
      for (const [ck, pd] of Object.entries(config.providers)) {
        const models = getProviderModels(pd);
        const pk = pd.provider_key || ck;
        const selected = models.filter(m => sel.has(pk + '::' + m.model_id));
        if (!selected.length) continue;
        const rk = ppResolveProvider(pk);
        const displayName = pd.display_name || ppRegistry[rk]?.display_name || ck;
        if (provs.has(rk)) {
          provs.get(rk).models.push(...selected);
        } else {
          provs.set(rk, { configKey: pk, displayName, models: selected });
        }
      }
      return [...provs.entries()].map(([rk, info]) => ({ registryKey: rk, ...info }));
    }

    async function ppLoadRegistry() {
      try {
        const res = await apiFetch('/api/provider-params/registry');
        if (res.ok) {
          const data = await res.json();
          if (data.providers) ppRegistry = data.providers;
        }
      } catch { /* use client-side fallback */ }
    }

    function ppRenderPanel(context) {
      const panelId = context === 'benchmark' ? 'ppBenchmarkPanel' : 'ppToolEvalPanel';
      const panel = document.getElementById(panelId);
      if (!panel) return;

      const providers = ppGetSelectedProviders(context);
      if (providers.length === 0) {
        panel.classList.add('hidden');
        panel.innerHTML = '';
        return;
      }

      panel.classList.remove('hidden');
      if (!ppActiveTab[context] || !providers.find(p => p.registryKey === ppActiveTab[context])) {
        ppActiveTab[context] = providers[0].registryKey;
      }

      // Init ppValues for each provider
      for (const prov of providers) {
        if (!ppValues[context]) ppValues[context] = {};
        if (!ppValues[context][prov.registryKey]) {
          ppValues[context][prov.registryKey] = {};
        }
      }

      const activeKey = ppActiveTab[context];
      const activeProv = providers.find(p => p.registryKey === activeKey);
      const reg = ppRegistry[activeKey] || ppRegistry._unknown;
      const isUnknown = activeKey === '_unknown';

      let html = '<div class="card rounded-md p-5">';

      // Unknown model warning
      if (isUnknown) {
        html += `<div class="mb-4 px-4 py-3 rounded-sm text-xs font-body" style="background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2);color:#EAB308;">
          This provider is not recognized. Using OpenAI-compatible defaults. Some parameters may not be supported.
        </div>`;
      }

      // Provider info banner (e.g. Ollama context warning)
      if (reg.info_banner) {
        html += `<div class="mb-4 px-4 py-3 rounded-sm text-xs font-body" style="background:rgba(56,189,248,0.06);border:1px solid rgba(56,189,248,0.15);color:#38BDF8;">
          ${reg.info_banner}
        </div>`;
      }

      // Section header with tabs
      html += '<div class="flex items-center justify-between mb-4">';
      html += '<label class="section-label">Provider Parameters</label>';
      html += '</div>';

      // Tabs (only if multiple providers)
      if (providers.length > 1) {
        html += '<div class="flex gap-1 mb-4 overflow-x-auto pb-1" style="scrollbar-width:thin;">';
        for (const p of providers) {
          const isActive = p.registryKey === activeKey;
          const color = getColor(p.configKey);
          html += `<button onclick="ppSwitchTab('${context}','${p.registryKey}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1.5 rounded-sm whitespace-nowrap transition-all" style="border:1px solid ${isActive ? color.text + '60' : 'var(--border-subtle)'};${isActive ? 'background:' + color.text + '10;color:' + color.text : 'color:#85858F'}">${p.displayName}</button>`;
        }
        html += '</div>';
      }

      // Conflict banners
      const conflicts = ppDetectConflicts(context, activeKey);
      for (const c of conflicts) {
        html += `<div class="mb-3 px-4 py-2 rounded-sm text-xs font-body flex items-center gap-2" style="background:rgba(249,115,22,0.06);border:1px solid rgba(249,115,22,0.2);color:#F97316;">
          <svg class="w-3.5 h-3.5 flex-shrink-0" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
          ${c.message}
        </div>`;
      }
      const conflictParams = new Set(conflicts.flatMap(c => c.droppedParams || []));

      // --- TIER 1: Universal Parameters ---
      html += ppRenderTier1(context, activeKey, reg, conflictParams);

      // --- TIER 2: Advanced (collapsible) ---
      html += ppRenderTier2(context, activeKey, reg, conflictParams);

      // --- TIER 3: Custom JSON (collapsible) ---
      html += ppRenderTier3(context, activeKey);

      html += '</div>';
      panel.innerHTML = html;
    }

    function ppRenderTier1(context, provKey, reg, conflictParams) {
      if (!reg.tier1) return '';
      const vals = ppValues[context]?.[provKey] || {};
      let html = '<div class="space-y-4 mb-4">';

      // Temperature
      if (reg.tier1.temperature) {
        const t = reg.tier1.temperature;
        const locked = ppIsLocked(provKey, 'temperature');
        const val = locked ? locked.value : (vals.temperature ?? t.default ?? t.min);
        const inConflict = conflictParams.has('temperature');
        const borderStyle = inConflict ? 'border:1px solid rgba(249,115,22,0.4);' : '';
        html += `<div class="rounded-sm p-3" style="${borderStyle}">
          <div class="flex justify-between text-xs mb-2">
            <span class="text-zinc-500 font-body">Temperature</span>
            <div class="flex items-center gap-2">
              ${locked ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(234,179,8,0.1);color:#EAB308;">LOCKED</span>' : ''}
              <input type="number" min="${t.min}" max="${t.max}" step="${t.step || 0.1}" value="${val}" class="w-16 px-2 py-0.5 rounded-sm text-xs font-mono text-zinc-200 text-center" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" ${locked ? 'disabled' : ''} onchange="ppSetValue('${context}','${provKey}','temperature',parseFloat(this.value));ppRenderPanel('${context}')">
            </div>
          </div>
          <input type="range" min="${t.min}" max="${t.max}" step="${t.step || 0.1}" value="${val}" ${locked ? 'disabled' : ''} oninput="ppSetValue('${context}','${provKey}','temperature',parseFloat(this.value));this.previousElementSibling.querySelector('input[type=number]').value=this.value" class="${locked ? 'opacity-40' : ''}">
        </div>`;
      }

      // Max Tokens
      if (reg.tier1.max_tokens) {
        const mt = reg.tier1.max_tokens;
        const val = vals.max_tokens ?? mt.default;
        html += `<div>
          <div class="flex justify-between text-xs mb-2">
            <span class="text-zinc-500 font-body">Max Tokens ${mt.required ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm ml-1" style="background:rgba(249,115,22,0.1);color:#F97316;">REQUIRED</span>' : ''}</span>
            <input type="number" min="${mt.min}" max="${mt.max}" step="1" value="${val}" class="w-24 px-2 py-0.5 rounded-sm text-xs font-mono text-zinc-200 text-center" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" onchange="ppSetValue('${context}','${provKey}','max_tokens',parseInt(this.value))">
          </div>
        </div>`;
      }

      // Stop Sequences
      if (reg.tier1.stop) {
        const stopDef = reg.tier1.stop;
        const stopLocked = ppIsLocked(provKey, 'stop');
        if (!stopLocked || stopLocked.supported !== false) {
          const stops = vals.stop || [];
          const maxItems = stopDef.max_items || 4;
          html += `<div>
            <div class="flex justify-between text-xs mb-2">
              <span class="text-zinc-500 font-body">Stop Sequences</span>
              <span class="text-zinc-700 text-[10px] font-mono">${stops.length}/${maxItems}</span>
            </div>
            <div class="flex flex-wrap gap-1 mb-2" id="ppStopTags-${context}-${provKey}">
              ${stops.map((s, i) => `<span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-sm text-xs font-mono text-zinc-300" style="background:rgba(255,255,255,0.04);border:1px solid var(--border-subtle);">${_ppEsc(s)}<button onclick="ppRemoveStop('${context}','${provKey}',${i})" class="text-zinc-600 hover:text-red-400 ml-1">&times;</button></span>`).join('')}
            </div>
            ${stops.length < maxItems ? `<input type="text" placeholder="Type and press Enter (max ${maxItems})" class="${INPUT_CLASS} text-xs" style="${INPUT_STYLE}" onkeydown="if(event.key==='Enter'){event.preventDefault();ppAddStop('${context}','${provKey}',this.value);this.value='';}">` : ''}
          </div>`;
        }
      }

      html += '</div>';
      return html;
    }

    function ppRenderTier2(context, provKey, reg, conflictParams) {
      if (!reg.tier2) return '';
      const vals = ppValues[context]?.[provKey] || {};
      const isCollapsed = ppCollapsed.advanced;

      let html = `<div class="mt-4 pt-4" style="border-top:1px solid var(--border-subtle)">
        <button onclick="ppCollapsed.advanced=!ppCollapsed.advanced;ppRenderPanel('${context}')" class="flex items-center gap-2 w-full text-left mb-3">
          <svg class="w-3 h-3 text-zinc-600 transition-transform ${isCollapsed ? '' : 'rotate-90'}" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
          <span class="text-[11px] font-display font-medium tracking-wider uppercase text-zinc-500">Advanced Parameters</span>
        </button>`;

      if (!isCollapsed) {
        html += '<div class="space-y-4 pl-1">';
        const paramOrder = ['top_p','top_k','frequency_penalty','presence_penalty','seed','reasoning_effort'];

        for (const pName of paramOrder) {
          const pDef = reg.tier2[pName];
          if (!pDef) continue;

          const supported = pDef.supported;
          const isUnsupported = supported === false;
          const isPartial = supported === 'partial';
          const isUnknownSupport = supported === 'unknown';
          const isDeprecated = pDef.deprecated === true;
          const inConflict = conflictParams.has(pName);

          // Reasoning effort is a dropdown
          if (pDef.type === 'enum') {
            if (isUnsupported) {
              html += ppRenderUnsupportedParam(pName, pDef);
              continue;
            }
            const val = vals[pName] || '';
            html += `<div ${inConflict ? 'style="border:1px solid rgba(249,115,22,0.4);border-radius:4px;padding:8px;"' : ''}>
              <div class="flex justify-between items-center text-xs mb-1">
                <span class="text-zinc-500 font-body">${ppParamLabel(pName)}</span>
                <div class="flex items-center gap-2">
                  ${isDeprecated ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(234,179,8,0.1);color:#EAB308;">DEPRECATED</span>' : ''}
                  ${isPartial ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(234,179,8,0.1);color:#EAB308;">PARTIAL</span>' : ''}
                  ${inConflict ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(249,115,22,0.1);color:#F97316;">CONFLICT</span>' : ''}
                </div>
              </div>
              <select onchange="ppSetValue('${context}','${provKey}','${pName}',this.value)" class="text-xs font-mono px-3 py-1.5 rounded-sm w-full" style="background:var(--surface);border:1px solid var(--border-subtle);color:var(--zinc-200);outline:none;" ${inConflict ? 'disabled' : ''}>
                <option value="">-- None --</option>
                ${(pDef.values || []).map(v => `<option value="${v}" ${val === v ? 'selected' : ''}>${v}</option>`).join('')}
              </select>
              ${pDef.note ? `<div class="text-[10px] text-zinc-700 mt-1 font-body">${pDef.note}</div>` : ''}
            </div>`;
            continue;
          }

          // Unsupported param
          if (isUnsupported) {
            html += ppRenderUnsupportedParam(pName, pDef);
            continue;
          }

          // Numeric slider params (top_p, top_k, frequency_penalty, presence_penalty)
          if (pDef.type === 'float' || pDef.type === 'int') {
            const min = pDef.min ?? 0;
            const max = pDef.max ?? 1;
            const step = pDef.step || (pDef.type === 'int' ? 1 : 0.05);
            const def = pDef.default ?? min;
            const val = vals[pName] ?? def;
            const disabled = inConflict;
            html += `<div ${inConflict ? 'style="border:1px solid rgba(249,115,22,0.4);border-radius:4px;padding:8px;"' : ''}>
              <div class="flex justify-between items-center text-xs mb-1">
                <span class="text-zinc-500 font-body ${disabled ? 'line-through' : ''}">${ppParamLabel(pName)}</span>
                <div class="flex items-center gap-2">
                  ${isDeprecated ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(234,179,8,0.1);color:#EAB308;">DEPRECATED</span>' : ''}
                  ${isPartial ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(234,179,8,0.1);color:#EAB308;">PARTIAL</span>' : ''}
                  ${isUnknownSupport ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(255,255,255,0.04);color:#85858F;">UNKNOWN</span>' : ''}
                  ${inConflict ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(249,115,22,0.1);color:#F97316;">CONFLICT</span>' : ''}
                  <input type="number" min="${min}" max="${max}" step="${step}" value="${val}" class="w-16 px-2 py-0.5 rounded-sm text-xs font-mono text-zinc-200 text-center" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" ${disabled ? 'disabled' : ''} onchange="ppSetValue('${context}','${provKey}','${pName}',${pDef.type === 'int' ? 'parseInt' : 'parseFloat'}(this.value));ppRenderPanel('${context}')">
                </div>
              </div>
              <input type="range" min="${min}" max="${max}" step="${step}" value="${val}" ${disabled ? 'disabled' : ''} class="${disabled ? 'opacity-30' : ''}" oninput="ppSetValue('${context}','${provKey}','${pName}',${pDef.type === 'int' ? 'parseInt' : 'parseFloat'}(this.value));this.closest('div').querySelector('input[type=number]').value=this.value">
              ${pDef.note ? `<div class="text-[10px] text-zinc-700 mt-1 font-body">${pDef.note}</div>` : ''}
            </div>`;
            continue;
          }

          // Seed (integer, no slider)
          if (pName === 'seed') {
            const val = vals.seed ?? '';
            html += `<div>
              <div class="flex justify-between items-center text-xs mb-1">
                <span class="text-zinc-500 font-body">${ppParamLabel(pName)}</span>
                <div class="flex items-center gap-1">
                  ${isDeprecated ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(234,179,8,0.1);color:#EAB308;">DEPRECATED</span>' : ''}
                  ${isUnknownSupport ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(255,255,255,0.04);color:#85858F;">UNKNOWN</span>' : ''}
                </div>
              </div>
              <input type="number" min="0" step="1" value="${val}" placeholder="Optional" class="${INPUT_CLASS} text-xs" style="${INPUT_STYLE}" onchange="ppSetValue('${context}','${provKey}','seed',this.value?parseInt(this.value):null)">
            </div>`;
          }
        }
        html += '</div>';
      }

      html += '</div>';
      return html;
    }

    function ppRenderUnsupportedParam(pName, pDef) {
      const reason = pDef.reason || 'Not supported by this provider';
      return `<div class="opacity-40" title="${_ppEsc(reason)}">
        <div class="flex justify-between items-center text-xs mb-1">
          <span class="text-zinc-600 font-body">${ppParamLabel(pName)}</span>
          <span class="text-[9px] font-display tracking-wider uppercase text-red-400/70">NOT SUPPORTED</span>
        </div>
        <input type="range" disabled class="w-full opacity-30">
        <div class="text-[10px] text-zinc-700 font-body">${reason}</div>
      </div>`;
    }

    function ppRenderTier3(context, provKey) {
      const vals = ppValues[context]?.[provKey] || {};
      const isCollapsed = ppCollapsed.custom;
      const jsonVal = vals._passthrough || '';

      let html = `<div class="mt-4 pt-4" style="border-top:1px solid var(--border-subtle)">
        <button onclick="ppCollapsed.custom=!ppCollapsed.custom;ppRenderPanel('${context}')" class="flex items-center gap-2 w-full text-left mb-3">
          <svg class="w-3 h-3 text-zinc-600 transition-transform ${isCollapsed ? '' : 'rotate-90'}" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7"/></svg>
          <span class="text-[11px] font-display font-medium tracking-wider uppercase text-zinc-500">Custom Parameters (JSON)</span>
        </button>`;

      if (!isCollapsed) {
        html += `<div>
          <textarea id="ppJsonEditor-${context}-${provKey}" rows="4" class="w-full px-3 py-2 rounded-sm text-xs font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;resize:vertical;" placeholder='{"key": "value"}' onblur="ppSaveJson('${context}','${provKey}',this.value)">${_ppEsc(jsonVal)}</textarea>
          <div class="flex items-center justify-between mt-2">
            <span class="text-[10px] text-zinc-700 font-body">Passed directly to the LLM API. See LiteLLM docs for available parameters.</span>
            <div class="flex items-center gap-2">
              <span id="ppJsonStatus-${context}-${provKey}" class="text-[10px] font-mono"></span>
              <button onclick="ppValidateJson('${context}','${provKey}')" class="text-[10px] font-display font-medium tracking-wider uppercase px-2 py-1 rounded-sm" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);">Validate</button>
            </div>
          </div>
        </div>`;
      }

      html += '</div>';
      return html;
    }

    function ppDetectConflicts(context, provKey) {
      const reg = ppRegistry[provKey] || ppRegistry._unknown;
      if (!reg.conflicts || !reg.conflicts.length) return [];
      const vals = ppValues[context]?.[provKey] || {};
      const results = [];

      for (const c of reg.conflicts) {
        // Check Anthropic temp + top_p conflict
        if (c.params.includes('temperature') && c.params.includes('top_p')) {
          if (vals.temperature != null && vals.top_p != null) {
            results.push({ ...c, droppedParams: ['top_p'] });
          }
        }
        // Check model-specific conflicts (e.g. GPT-5 temp lock)
        if (c.condition && c.condition.includes('gpt-5')) {
          // This is handled by model_overrides / ppIsLocked, not here
        }
      }
      return results;
    }

    function ppIsLocked(provKey, paramName) {
      const reg = ppRegistry[provKey];
      if (!reg || !reg.model_overrides) return null;
      // Check model overrides (would need actual model ID for full check)
      // For now, return null - the full lock check requires knowing which models are selected
      return null;
    }

    function ppSwitchTab(context, provKey) {
      ppActiveTab[context] = provKey;
      ppRenderPanel(context);
    }

    function ppSetValue(context, provKey, param, value) {
      if (!ppValues[context]) ppValues[context] = {};
      if (!ppValues[context][provKey]) ppValues[context][provKey] = {};
      if (value === null || value === '' || value === undefined || (typeof value === 'number' && isNaN(value))) {
        delete ppValues[context][provKey][param];
      } else {
        ppValues[context][provKey][param] = value;
      }
    }

    function ppAddStop(context, provKey, value) {
      if (!value.trim()) return;
      if (!ppValues[context]) ppValues[context] = {};
      if (!ppValues[context][provKey]) ppValues[context][provKey] = {};
      if (!ppValues[context][provKey].stop) ppValues[context][provKey].stop = [];
      const reg = ppRegistry[provKey] || ppRegistry._unknown;
      const maxItems = reg.tier1?.stop?.max_items || 4;
      if (ppValues[context][provKey].stop.length >= maxItems) return;
      ppValues[context][provKey].stop.push(value.trim());
      ppRenderPanel(context);
    }

    function ppRemoveStop(context, provKey, index) {
      if (!ppValues[context]?.[provKey]?.stop) return;
      ppValues[context][provKey].stop.splice(index, 1);
      ppRenderPanel(context);
    }

    function ppSaveJson(context, provKey, value) {
      ppSetValue(context, provKey, '_passthrough', value.trim());
    }

    function ppValidateJson(context, provKey) {
      const el = document.getElementById(`ppJsonEditor-${context}-${provKey}`);
      const statusEl = document.getElementById(`ppJsonStatus-${context}-${provKey}`);
      if (!el || !statusEl) return;
      const raw = el.value.trim();
      if (!raw) {
        statusEl.innerHTML = '<span style="color:#85858F;">Empty (OK)</span>';
        return;
      }
      try {
        JSON.parse(raw);
        statusEl.innerHTML = '<span style="color:var(--lime);">Valid JSON</span>';
      } catch (e) {
        statusEl.innerHTML = `<span style="color:var(--coral);">Invalid: ${_ppEsc(e.message)}</span>`;
      }
    }

    function ppCollectParams(context) {
      // Collect provider params into a flat object for the API request.
      // The backend resolves per-provider constraints from each model's config key.
      // When multiple providers are selected, we merge params from the active tab
      // (the one the user most recently configured). Tier 1 params like temperature
      // and max_tokens are already in the main request body, so we skip them here
      // and only send tier 2 + passthrough.
      const providers = ppGetSelectedProviders(context);
      if (!providers.length) return null;

      const result = {};
      let passthrough = {};
      let hasAny = false;

      for (const prov of providers) {
        const vals = ppValues[context]?.[prov.registryKey] || {};

        // Collect tier2 values (skip internal keys starting with _ and tier1 keys)
        const tier1Keys = new Set(['temperature', 'max_tokens', 'stop']);
        for (const [k, v] of Object.entries(vals)) {
          if (k.startsWith('_')) continue;
          if (tier1Keys.has(k)) continue; // tier1 handled by main request body
          if (v !== null && v !== undefined && v !== '') {
            result[k] = v;
            hasAny = true;
          }
        }

        // Collect passthrough JSON
        const rawJson = vals._passthrough || '';
        if (rawJson) {
          try {
            const parsed = JSON.parse(rawJson);
            Object.assign(passthrough, parsed);
            hasAny = true;
          } catch { /* skip invalid JSON */ }
        }
      }

      if (Object.keys(passthrough).length) {
        result.passthrough = passthrough;
      }

      return hasAny ? result : null;
    }

    function ppParamLabel(name) {
      const labels = {
        top_p: 'Top P', top_k: 'Top K',
        frequency_penalty: 'Frequency Penalty', presence_penalty: 'Presence Penalty',
        seed: 'Seed', reasoning_effort: 'Reasoning Effort'
      };
      return labels[name] || name;
    }

    function _ppEsc(s) {
      if (!s) return '';
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    // Refresh provider params panel when model selection changes
    function ppOnModelSelectionChange(context) {
      ppRenderPanel(context);
    }

    // -------------------------------------------------------------------
    // Tool Eval — Suite CRUD, Test Cases, Eval Execution, History
    // -------------------------------------------------------------------
    let teSuites = [];
    let teCurrentSuite = null;       // full suite object when editing
    let teEditingToolIndex = -1;     // -1 = adding new, >=0 = editing existing
    let teEditingCaseId = null;      // null = adding new, string = editing existing
    let teSelectedModels = new Set(); // stores "provider_key::model_id" compound keys
    let teEvalResults = [];          // live results from WebSocket
    let teEvalSummaries = [];        // model summaries from WebSocket
    let teSummarySortKey = 'overall_pct';
    let teSummarySortAsc = false;
    let teEvalHistory = [];
    let teRunSuiteId = null;         // suite_id for current run view
    let _activeToolEvalJobId = null; // job_id for active tool eval (WS tracking)
    let _activeJudgeJobId = null;    // job_id for active judge run (WS tracking)
    let _ptConfigApplied = false;    // flag: param tuner config applied, skip _teApplyDefaults
    let _teEvalStartTime = null;     // timestamp for ETA calculation
    let _teEvalTotalCases = 0;       // total test cases for progress tracking

    // --- Shared Context (cross-feature state, M2) ---
    let _sharedContext = {
      experiment_id: null,
      suite_id: null,
      suite_name: null,
      selected_models: [],
      temperature: 0.0,
      tool_choice: 'required',
      provider_params: {},
      system_prompt: null,
      prompt_tuner_hint: null,
      last_updated_by: null,
    };
    const SC_STORAGE_KEY = '_sharedContext';

    function _scLoad() {
      try {
        const raw = sessionStorage.getItem(SC_STORAGE_KEY);
        if (raw) Object.assign(_sharedContext, JSON.parse(raw));
      } catch {}
    }
    function _scSave() {
      try { sessionStorage.setItem(SC_STORAGE_KEY, JSON.stringify(_sharedContext)); } catch {}
      if (typeof _teUpdateContextBar === 'function') _teUpdateContextBar();
    }
    function _scSetSuite(suiteId, suiteName) {
      _sharedContext.suite_id = suiteId;
      _sharedContext.suite_name = suiteName;
      _sharedContext.last_updated_by = null;
      _scSave();
    }
    function _scSetModels(modelSet) {
      _sharedContext.selected_models = Array.from(modelSet);
      _scSave();
    }
    function _scGetModels() { return new Set(_sharedContext.selected_models || []); }
    function _scSetExperiment(experimentId) {
      _sharedContext.experiment_id = experimentId;
      _scSave();
    }
    function _scSetConfig(overrides) {
      Object.assign(_sharedContext, overrides);
      _scSave();
    }
    function _scClear() {
      _sharedContext = { experiment_id: null, suite_id: null, suite_name: null,
        selected_models: [], temperature: 0.0, tool_choice: 'required',
        provider_params: {}, system_prompt: null, prompt_tuner_hint: null,
        last_updated_by: null };
      _scSave();
    }
    // Expose for inline handlers
    window._sharedContext = _sharedContext;

    function showToolEvalView(view) {
      _scLoad();
      const views = ['te-suites-view','te-editor-view','te-run-view',
        'pt-config-view','pt-run-view','pt-history-view',
        'prt-config-view','prt-run-view','prt-history-view',
        'jg-compare-view','jg-history-view','te-timeline-view'];
      const viewMap = { suites: 'te-suites-view', editor: 'te-editor-view', run: 'te-run-view',
        'pt-config': 'pt-config-view', 'pt-run': 'pt-run-view', 'pt-history': 'pt-history-view',
        'prt-config': 'prt-config-view', 'prt-run': 'prt-run-view', 'prt-history': 'prt-history-view',
        'jg-compare': 'jg-compare-view', 'jg-history': 'jg-history-view', timeline: 'te-timeline-view' };
      const activeId = viewMap[view] || viewMap.suites;
      views.forEach(v => document.getElementById(v)?.classList.toggle('hidden', v !== activeId));

      // Sync sub-tab highlight — map child views to their parent sub-tab key
      const _viewToSubTab = {
        suites: 'suites', editor: 'suites',
        run: 'run',
        'pt-config': 'pt-config', 'pt-run': 'pt-config', 'pt-history': 'pt-config',
        'prt-config': 'prt-config', 'prt-run': 'prt-config', 'prt-history': 'prt-config',
        'jg-compare': 'judge', 'jg-history': 'judge',
        timeline: 'timeline'
      };
      const activeTab = _viewToSubTab[view] || 'suites';
      document.querySelectorAll('#teSubTabs .te-subtab').forEach(btn => {
        btn.classList.toggle('te-subtab-active', btn.dataset.tab === activeTab);
      });
      _teUpdateContextBar();

      if (view === 'run') { jgLoadDefaults(); }
      if (view === 'pt-config') { ptLoadSuiteSelector(); ptRenderModelGrid(); _ptApplyDefaults(); ptPopulatePresetDropdown(); ptUpdatePreview(); _ptCheckRunningBanner(); }
      if (view === 'pt-history') { ptLoadHistory(); }
      if (view === 'prt-config') {
        prtLoadSuiteSelector(); prtRenderModelGrid(); prtPopulateMetaModel(); _prtApplyDefaults(); prtUpdateEstimate();
        // Bridge D: consume judge hint if available
        if (_sharedContext.prompt_tuner_hint) {
          const basePrompt = document.getElementById('prtBasePrompt');
          if (basePrompt && !basePrompt.value.trim()) {
            basePrompt.value = 'Focus on these areas identified by the judge:\n' + _sharedContext.prompt_tuner_hint;
            _sharedContext.prompt_tuner_hint = null;
            _scSave();
          }
        }
      }
      if (view === 'prt-history') { prtLoadHistory(); }
      if (view === 'jg-history') { jgLoadHistory(); }
      if (view === 'timeline') { tlLoadTimeline(); }
    }

    // -------------------------------------------------------------------
    // Sub-Tab Navigation + Context Bar + Timeline (M7)
    // -------------------------------------------------------------------

    function teSetActiveSubTab(tabKey) {
      // Map sub-tab keys to showToolEvalView keys
      const tabToView = {
        suites: 'suites',
        run: 'run',
        'pt-config': 'pt-config',
        'prt-config': 'prt-config',
        judge: 'jg-history',
        timeline: 'timeline'
      };
      const viewKey = tabToView[tabKey] || 'suites';
      showToolEvalView(viewKey);
    }

    function _teUpdateContextBar() {
      const bar = document.getElementById('teContextBar');
      if (!bar) return;

      const hasSuite = _sharedContext.suite_id;
      const hasModels = _sharedContext.selected_models?.length > 0;
      const hasExp = _sharedContext.experiment_id;

      if (!hasSuite && !hasModels && !hasExp) {
        bar.classList.add('hidden');
        return;
      }
      if (!_ctxBarHidden) bar.classList.remove('hidden');

      const suitePill = document.getElementById('ctxSuitePill');
      if (suitePill) {
        if (hasSuite) {
          suitePill.textContent = _sharedContext.suite_name || 'Suite';
          suitePill.classList.remove('hidden');
        } else {
          suitePill.classList.add('hidden');
        }
      }

      const modelsPill = document.getElementById('ctxModelsPill');
      if (modelsPill) {
        if (hasModels) {
          const count = _sharedContext.selected_models.length;
          modelsPill.textContent = count + ' model' + (count > 1 ? 's' : '');
          modelsPill.classList.remove('hidden');
        } else {
          modelsPill.classList.add('hidden');
        }
      }

      const expPill = document.getElementById('ctxExperimentPill');
      if (expPill) {
        if (hasExp) {
          expPill.textContent = 'Experiment';
          expPill.classList.remove('hidden');
        } else {
          expPill.classList.add('hidden');
        }
      }
    }

    let _ctxBarHidden = false;
    function teToggleContextBar() {
      _ctxBarHidden = !_ctxBarHidden;
      const bar = document.getElementById('teContextBar');
      const text = document.getElementById('ctxToggleText');
      if (_ctxBarHidden) {
        bar.style.display = 'none';
        if (text) text.textContent = 'Show Context';
      } else {
        bar.style.display = '';
        if (text) text.textContent = 'Hide';
      }
    }

    // --- Timeline ---
    let _tlFilter = 'all';
    let _tlData = [];

    async function tlLoadTimeline() {
      const expId = _sharedContext.experiment_id;
      const noExp = document.getElementById('tlNoExperiment');
      const entries = document.getElementById('tlEntries');

      if (!expId) {
        if (noExp) noExp.classList.remove('hidden');
        if (entries) entries.classList.add('hidden');
        return;
      }

      try {
        const res = await apiFetch('/api/experiments/' + expId + '/timeline');
        if (!res.ok) { showToast('Failed to load timeline', 'error'); return; }
        const data = await res.json();
        _tlData = data.entries || [];

        if (noExp) noExp.classList.add('hidden');
        if (entries) entries.classList.remove('hidden');

        tlRenderTimeline();
      } catch (e) {
        showToast('Error loading timeline: ' + e.message, 'error');
      }
    }

    function tlRenderTimeline() {
      const container = document.getElementById('tlEntries');
      if (!container) return;

      const filtered = _tlFilter === 'all' ? _tlData : _tlData.filter(function(e) { return e.type === _tlFilter; });

      if (filtered.length === 0) {
        container.innerHTML = '<div class="text-center py-8 text-zinc-600 text-sm">No entries' + (_tlFilter !== 'all' ? ' matching filter' : '') + '</div>';
        return;
      }

      container.innerHTML = filtered.map(function(entry) {
        var isBaseline = entry.is_baseline;
        var typeLabels = { eval: 'Eval', param_tune: 'Param Tune', prompt_tune: 'Prompt Tune', judge: 'Judge' };
        var typeColors = { eval: 'var(--lime,#BFFF00)', param_tune: '#38BDF8', prompt_tune: '#A855F7', judge: '#F59E0B' };

        var details = '';
        if (entry.type === 'eval') {
          var score = entry.score !== undefined ? (entry.score * 100).toFixed(1) + '%' : '--';
          var delta = '';
          var deltaColor = '#22C55E';
          if (entry.delta !== null && entry.delta !== undefined) {
            deltaColor = entry.delta >= 0 ? '#22C55E' : '#EF4444';
            delta = ' (' + (entry.delta >= 0 ? '+' : '') + (entry.delta * 100).toFixed(1) + '%)';
          }
          details = '<span>Score: ' + score + '</span>';
          if (entry.delta !== null && entry.delta !== undefined) details += '<span style="color:' + deltaColor + '">' + delta + '</span>';
          if (entry.config_summary) details += '<span class="text-zinc-600 ml-2">' + _teEsc(entry.config_summary) + '</span>';
          if (entry.promoted_from) details += '<span class="text-[10px] ml-2 px-1.5 py-0.5 rounded" style="background:rgba(168,85,247,0.15);color:#A855F7">promoted</span>';
        } else if (entry.type === 'param_tune' || entry.type === 'prompt_tune') {
          var ptScore = entry.score !== undefined ? (entry.score * 100).toFixed(1) + '%' : '--';
          var ptStatus = entry.status || '';
          details = '<span>Best: ' + ptScore + '</span><span class="text-zinc-600 ml-2">' + _teEsc(ptStatus) + '</span>';
          if (entry.type === 'prompt_tune' && entry.prompt_preview) {
            details += '<span class="text-zinc-700 ml-2 text-[10px]">"' + _teEsc(entry.prompt_preview) + '"</span>';
          }
        } else if (entry.type === 'judge') {
          details = '<span>Grade: ' + _teEsc(entry.grade || '--') + '</span>';
          if (entry.overall_score !== null && entry.overall_score !== undefined) details += '<span class="ml-2">Score: ' + entry.overall_score + '</span>';
          if (entry.mode) details += '<span class="text-zinc-600 ml-2">' + _teEsc(entry.mode) + '</span>';
        }

        var ts = new Date(entry.timestamp).toLocaleString();

        return '<div class="tl-entry ' + (isBaseline ? 'baseline' : '') + '" data-type="' + entry.type + '">' +
          '<div class="flex items-center gap-2 mb-1">' +
            '<span class="text-[10px] font-display font-medium tracking-wider uppercase" style="color:' + typeColors[entry.type] + '">' + typeLabels[entry.type] + '</span>' +
            (isBaseline ? '<span class="text-[9px] px-1.5 py-0.5 rounded" style="background:rgba(191,255,0,0.15);color:var(--lime)">BASELINE</span>' : '') +
            '<span class="text-[10px] text-zinc-700 ml-auto">' + ts + '</span>' +
          '</div>' +
          '<div class="text-[11px] flex items-center gap-1 flex-wrap">' + details + '</div>' +
        '</div>';
      }).join('');
    }

    function tlFilterTimeline(filter) {
      _tlFilter = filter;
      document.querySelectorAll('#tlFilterPills .tl-filter').forEach(function(btn) {
        var isActive = btn.dataset.filter === filter;
        btn.style.opacity = isActive ? '1' : '0.5';
      });
      tlRenderTimeline();
    }

    // -------------------------------------------------------------------
    // Parameter Tuner (pt prefix)
    // -------------------------------------------------------------------
    let ptSelectedModels = new Set(); // stores "provider_key::model_id" compound keys
    let ptResults = [];        // live results from WebSocket
    let ptBestConfig = null;
    let ptBestScore = 0;
    let ptSortKey = 'overall_score';
    let ptSortAsc = false;
    let ptHistory = [];
    let ptTotalCombos = 0;
    let _ptSearchSpaceKeys = [];  // keys from the active search space, set on tune start
    let _ptDefaults = {};      // stored defaults from Phase 10 settings, applied on render
    let _ptTuneStartTime = null;  // Date.now() when tune starts, for ETA calculation
    let _ptEtaBaseCount = 0;      // combo count at start/reconnection, for accurate rate calc
    let _ptJobStartedAt = null;   // ISO string from job.started_at, for accurate ETA on reconnect

    // --- Preset management (Phase 3) ---
    function _ptGetPresets() {
      return (_p10Settings?.param_tuner?.presets) || [];
    }

    function ptPopulatePresetDropdown() {
      const sel = document.getElementById('ptPresetSelect');
      if (!sel) return;
      const presets = _ptGetPresets();
      sel.innerHTML = '<option value="">-- Presets --</option>';
      for (let i = 0; i < presets.length; i++) {
        sel.innerHTML += `<option value="${i}">${_teEsc(presets[i].name || 'Unnamed')}</option>`;
      }
    }

    function ptSavePreset() {
      const searchSpace = ptBuildSearchSpace();
      if (Object.keys(searchSpace).length === 0) {
        showToast('Enable at least one parameter before saving', 'error');
        return;
      }
      showInputModal('Save Preset', 'Preset name', async (name) => {
        if (!name || !name.trim()) { showToast('Name is required', 'error'); return; }
        name = name.trim();

        const presets = [..._ptGetPresets()];
        // Check for duplicate name
        const existingIdx = presets.findIndex(p => p.name === name);
        const preset = { name, search_space: searchSpace };

        if (existingIdx >= 0) {
          presets[existingIdx] = preset;
        } else {
          if (presets.length >= 20) {
            showToast('Maximum 20 presets allowed', 'error');
            return;
          }
          presets.push(preset);
        }

        await _ptSavePresets(presets);
        showToast(`Preset "${name}" saved`, 'success');
      }, { confirmLabel: 'Save' });
    }

    function ptLoadSelectedPreset() {
      const sel = document.getElementById('ptPresetSelect');
      if (!sel || sel.value === '') { showToast('Select a preset first', 'error'); return; }
      const idx = parseInt(sel.value);
      const presets = _ptGetPresets();
      if (idx < 0 || idx >= presets.length) return;
      _ptApplyPresetToUI(presets[idx]);
    }

    function ptDeleteSelectedPreset() {
      const sel = document.getElementById('ptPresetSelect');
      if (!sel || sel.value === '') { showToast('Select a preset first', 'error'); return; }
      const idx = parseInt(sel.value);
      const presets = _ptGetPresets();
      if (idx < 0 || idx >= presets.length) return;
      const name = presets[idx].name || 'Unnamed';
      showModal('Delete Preset', `Delete preset "${_teEsc(name)}"? This cannot be undone.`, async () => {
        const updated = [...presets];
        updated.splice(idx, 1);
        await _ptSavePresets(updated);
        showToast(`Preset "${name}" deleted`, 'success');
      }, { danger: true, confirmLabel: 'Delete' });
    }

    function _ptApplyPresetToUI(preset) {
      if (!preset || !preset.search_space) return;
      const space = preset.search_space;

      // For each rendered param row, apply preset values or disable
      const rows = document.querySelectorAll('#ptSearchSpace [data-param-name]');
      for (const row of rows) {
        const name = row.dataset.paramName;
        const type = row.dataset.paramType;
        const toggle = document.getElementById('ptToggle_' + name);
        if (!toggle) continue;

        if (name in space) {
          toggle.checked = true;
          const val = space[name];
          if ((type === 'float' || type === 'int') && typeof val === 'object' && !Array.isArray(val)) {
            const minEl = document.getElementById('pt_' + name + '_min');
            const maxEl = document.getElementById('pt_' + name + '_max');
            const stepEl = document.getElementById('pt_' + name + '_step');
            if (minEl && val.min !== undefined) minEl.value = val.min;
            if (maxEl && val.max !== undefined) maxEl.value = val.max;
            if (stepEl && val.step !== undefined) stepEl.value = val.step;
          } else if (type === 'enum' && Array.isArray(val)) {
            // Uncheck all, then check preset values
            const allCbs = document.querySelectorAll('.pt-enum-' + name);
            allCbs.forEach(cb => { cb.checked = false; });
            for (const v of val) {
              const cb = document.getElementById('pt_' + name + '_val_' + v);
              if (cb) cb.checked = true;
            }
          }
          // bool: just toggle on, values are always [true, false]
        } else {
          toggle.checked = false;
        }
      }

      ptUpdatePreview();
      showToast(`Preset "${preset.name}" loaded`, 'success');
    }

    async function _ptSavePresets(presets) {
      // Update in-memory settings
      if (!_p10Settings) _p10Settings = {};
      if (!_p10Settings.param_tuner) _p10Settings.param_tuner = {};
      _p10Settings.param_tuner.presets = presets;

      // Save to backend
      try {
        const data = p10CollectUI();
        data.param_tuner.presets = presets;
        await apiFetch('/api/settings/phase10', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });
      } catch {
        showToast('Failed to save presets', 'error');
      }

      ptPopulatePresetDropdown();
    }

    // --- Task #2: Registry access (uses existing ppRegistry from ppLoadRegistry) ---
    function _ptGetRegistry() { return ppRegistry || PP_REGISTRY; }

    // --- Task #3: Client-side provider identification ---
    const PT_PREFIX_MAP = {
      'anthropic/': 'anthropic',
      'gemini/': 'gemini',
      'vertex_ai/': 'gemini',
      'ollama/': 'ollama',
      'ollama_chat/': 'ollama',
      'lm_studio/': 'lm_studio',
      'mistral/': 'mistral',
      'deepseek/': 'deepseek',
      'cohere/': 'cohere',
      'cohere_chat/': 'cohere',
      'xai/': 'xai',
      'vllm/': 'vllm',
      'openai/': 'openai',
    };

    function ptIdentifyProvider(modelId, providerKey) {
      const reg = _ptGetRegistry();
      if (providerKey && reg[providerKey]) return providerKey;
      const lower = (modelId || '').toLowerCase();
      for (const [prefix, prov] of Object.entries(PT_PREFIX_MAP)) {
        if (lower.startsWith(prefix)) return prov;
      }
      // No prefix match — default to openai (bare model IDs like "gpt-4")
      return '_unknown';
    }

    function ptGetRegistryKey(configProvKey, configProvData) {
      const reg = _ptGetRegistry();
      const prefix = configProvData?.model_id_prefix;
      if (prefix && reg[prefix]) return prefix;
      // Try resolve via ppResolveProvider (reuse existing alias logic)
      const resolved = ppResolveProvider(configProvKey);
      if (resolved !== '_unknown') return resolved;
      // Fallback: check first model's prefix
      const models = getProviderModels(configProvData) || [];
      if (models.length) return ptIdentifyProvider(models[0].model_id, null);
      return '_unknown';
    }

    function _ptMatchesGlob(modelId, pattern) {
      return pattern.split('|').some(p => {
        const regex = new RegExp('^' + p.replace(/[.*+?^${}()|[\]\\]/g, m => m === '*' ? '.*' : '\\' + m) + '$', 'i');
        return regex.test(modelId);
      });
    }

    // --- Task #4: Compute available params for selected models ---
    function ptComputeAvailableParams() {
      const reg = _ptGetRegistry();
      if (!reg || ptSelectedModels.size === 0 || !config?.providers) return [];

      // Check if param_support config is available (from Settings > Tuning)
      const ps = _p10Settings?.param_support;
      const useParamSupport = ps && ps.provider_defaults && Object.keys(ps.provider_defaults).length > 0;

      // Build model→registryKey mapping using compound keys
      const modelProvMap = new Map(); // compoundKey → registryKey
      for (const [ck, pd] of Object.entries(config.providers)) {
        const rk = ptGetRegistryKey(ck, pd);
        const models = getProviderModels(pd);
        for (const m of models) {
          const compound = _ptCompoundKey(pd.provider_key || ck, m.model_id);
          if (ptSelectedModels.has(compound)) {
            modelProvMap.set(compound, rk);
          }
        }
      }

      const totalModels = modelProvMap.size;
      if (totalModels === 0) return [];

      // Collect all params across selected providers
      const paramMap = new Map(); // paramName → merged def

      for (const [compoundKey, rk] of modelProvMap) {
        const { model_id: modelId } = _ptParseCompoundKey(compoundKey);
        // Source params: prefer param_support config, fallback to registry
        let allParams, modelOverrides;
        if (useParamSupport && ps.provider_defaults[rk]) {
          // Read from user's saved param_support config
          const provPS = ps.provider_defaults[rk];
          allParams = {};
          for (const [pname, spec] of Object.entries(provPS.params || {})) {
            if (spec.enabled === false) continue; // Skip disabled params
            allParams[pname] = spec;
          }
          modelOverrides = ps.model_overrides?.[rk] || {};
        } else {
          // Fallback: read from PROVIDER_REGISTRY
          const provReg = reg[rk] || reg._unknown;
          if (!provReg) continue;
          allParams = { ...(provReg.tier1 || {}), ...(provReg.tier2 || {}) };
          modelOverrides = provReg.model_overrides || {};
        }

        for (const [pname, pdef] of Object.entries(allParams)) {
          // Check model overrides
          let override = null;
          for (const [pattern, overrides] of Object.entries(modelOverrides)) {
            if (_ptMatchesGlob(modelId.split('/').pop(), pattern)) {
              if (overrides[pname]) override = overrides[pname];
            }
          }

          const isSupported = override?.supported !== false && pdef.supported !== false;
          const isLocked = override?.locked === true;

          // Determine tier: if from param_support, use a heuristic (temperature/top_p/max_tokens = tier1)
          const tier1Names = new Set(['temperature', 'max_tokens', 'top_p']);
          const provReg = reg[rk] || reg._unknown;
          const tier = provReg?.tier1?.[pname] ? 1 : (tier1Names.has(pname) ? 1 : 2);

          if (!paramMap.has(pname)) {
            // First time seeing this param
            paramMap.set(pname, {
              name: pname,
              type: pdef.type || 'float',
              tier: tier,
              min: pdef.min ?? null,
              max: pdef.max ?? null,
              step: pdef.step ?? null,
              default: pdef.default ?? null,
              values: pdef.values ? [...pdef.values] : null,
              supportedBy: isSupported ? 1 : 0,
              totalModels: totalModels,
              locked: isLocked,
              lockedValue: isLocked ? override.value : null,
              lockedCount: isLocked ? 1 : 0,
              notes: pdef.note ? [pdef.note] : [],
              deprecated: pdef.deprecated || false,
            });
          } else {
            // Merge with existing
            const existing = paramMap.get(pname);
            if (isSupported) existing.supportedBy++;
            if (isLocked) existing.lockedCount++;

            // Widen range (union)
            if (pdef.min !== undefined && pdef.min !== null) {
              existing.min = existing.min === null ? pdef.min : Math.min(existing.min, pdef.min);
            }
            if (pdef.max !== undefined && pdef.max !== null) {
              existing.max = existing.max === null ? pdef.max : Math.max(existing.max, pdef.max);
            }
            // Smallest step (most granular)
            if (pdef.step !== undefined && pdef.step !== null) {
              existing.step = existing.step === null ? pdef.step : Math.min(existing.step, pdef.step);
            }
            // Default: keep first
            if (existing.default === null && pdef.default !== undefined) {
              existing.default = pdef.default;
            }
            // Enum values: union
            if (pdef.values && Array.isArray(pdef.values)) {
              if (!existing.values) existing.values = [];
              for (const v of pdef.values) {
                if (!existing.values.includes(v)) existing.values.push(v);
              }
            }
            // Notes: accumulate unique
            if (pdef.note && !existing.notes.includes(pdef.note)) {
              existing.notes.push(pdef.note);
            }
          }
        }
      }

      // Finalize locked state: locked only if ALL models lock it
      for (const p of paramMap.values()) {
        p.locked = p.lockedCount > 0 && p.lockedCount >= totalModels;
        if (!p.locked) p.lockedValue = null;
        delete p.lockedCount;
      }

      // Skip params with 0 support (not available on any selected model)
      const result = [...paramMap.values()].filter(p => p.supportedBy > 0);

      // Sort: tier 1 first, then tier 2, then alphabetical
      result.sort((a, b) => {
        if (a.tier !== b.tier) return a.tier - b.tier;
        return a.name.localeCompare(b.name);
      });

      return result;
    }

    // --- Task #5: Render dynamic param controls ---
    function _ptDisplayName(name) {
      const nameMap = {
        temperature: 'Temperature', max_tokens: 'Max Tokens', top_p: 'Top P',
        top_k: 'Top K', frequency_penalty: 'Frequency Penalty',
        presence_penalty: 'Presence Penalty', seed: 'Seed',
        reasoning_effort: 'Reasoning Effort', tool_choice: 'Tool Choice',
        stop: 'Stop Sequences',
      };
      return nameMap[name] || name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function _ptSupportBadge(supportedBy, totalModels) {
      const full = supportedBy >= totalModels;
      const bg = full ? 'rgba(191,255,0,0.1)' : 'rgba(234,179,8,0.1)';
      const color = full ? 'var(--lime)' : '#EAB308';
      return `<span class="text-[10px] font-mono px-1.5 py-0.5 rounded-sm" style="background:${bg};color:${color}">${supportedBy}/${totalModels}</span>`;
    }

    function _ptToggleStyle() {
      return 'w-8 h-4 rounded-full peer bg-zinc-700 peer-checked:bg-lime-accent/40 after:content-[\'\'] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-4 peer-checked:after:bg-[var(--lime)]';
    }

    function _ptInputStyle() {
      return 'w-full px-2 py-1.5 rounded-sm text-xs font-mono text-zinc-200';
    }

    function _ptInputInline() {
      return 'background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;';
    }

    function ptRenderDynamicParams(paramDefs) {
      const container = document.getElementById('ptSearchSpace');
      if (!container) return;

      if (!paramDefs || paramDefs.length === 0) {
        container.innerHTML = '<div class="text-xs text-zinc-600 font-body text-center py-4">Select models to configure parameters</div>';
        _ptCustomParamCounter = 0;
        return;
      }

      container.innerHTML = '';
      _ptCustomParamCounter = 0;

      // Determine which params should be auto-enabled (defaults from settings or standard defaults)
      const autoEnable = new Set(['temperature', 'tool_choice']);

      for (const p of paramDefs) {
        const row = document.createElement('div');
        row.className = 'flex items-start gap-3';
        row.dataset.paramName = p.name;
        row.dataset.paramType = p.type;

        const isLocked = p.locked;
        const shouldEnable = !isLocked && (autoEnable.has(p.name) || _ptDefaults[p.name + '_min'] !== undefined);

        if (p.type === 'float' || p.type === 'int') {
          const parseFunc = p.type === 'float' ? 'parseFloat' : 'parseInt';
          // Apply defaults from settings if available
          let dMin = p.min ?? 0;
          let dMax = p.max ?? 1;
          let dStep = p.step ?? (p.type === 'float' ? 0.1 : 1);
          if (_ptDefaults[p.name + '_min'] !== undefined) dMin = _ptDefaults[p.name + '_min'];
          if (_ptDefaults[p.name + '_max'] !== undefined) dMax = _ptDefaults[p.name + '_max'];
          if (_ptDefaults[p.name + '_step'] !== undefined) dStep = _ptDefaults[p.name + '_step'];

          row.innerHTML = `
            <label class="relative inline-flex items-center cursor-pointer mt-1.5">
              <input type="checkbox" id="ptToggle_${p.name}" ${shouldEnable ? 'checked' : ''} ${isLocked ? 'disabled' : ''} class="sr-only peer" onchange="ptUpdatePreview()">
              <div class="${_ptToggleStyle()}"></div>
            </label>
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xs text-zinc-400 font-body">${_ptDisplayName(p.name)}</span>
                ${_ptSupportBadge(p.supportedBy, p.totalModels)}
                ${isLocked ? `<span class="text-[10px] text-zinc-600 font-mono">locked: ${p.lockedValue}</span>` : ''}
                ${p.notes.length ? `<span class="text-[10px] text-zinc-600 font-body" title="${_teEsc(p.notes.join('; '))}">${_teEsc(p.notes[0].length > 40 ? p.notes[0].slice(0,37)+'...' : p.notes[0])}</span>` : ''}
              </div>
              ${isLocked ? `<div class="text-xs font-mono text-zinc-500">${p.lockedValue}</div>` : `
              <div class="grid grid-cols-3 gap-2 mb-2">
                <div><label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Min</label><input id="pt_${p.name}_min" type="number" min="${p.min ?? ''}" max="${p.max ?? ''}" step="${dStep}" value="${dMin}" class="${_ptInputStyle()}" style="${_ptInputInline()}" onchange="ptUpdatePreview()"></div>
                <div><label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Max</label><input id="pt_${p.name}_max" type="number" min="${p.min ?? ''}" max="${p.max ?? ''}" step="${dStep}" value="${dMax}" class="${_ptInputStyle()}" style="${_ptInputInline()}" onchange="ptUpdatePreview()"></div>
                <div><label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Step</label><input id="pt_${p.name}_step" type="number" min="${p.type === 'float' ? '0.01' : '1'}" step="${p.type === 'float' ? '0.01' : '1'}" value="${dStep}" class="${_ptInputStyle()}" style="${_ptInputInline()}" onchange="ptUpdatePreview()"></div>
              </div>
              <div id="pt_${p.name}_pills" class="flex flex-wrap gap-1"></div>`}
            </div>`;
        } else if (p.type === 'enum') {
          const vals = p.values || [];
          // For tool_choice, auto-check 'auto' and 'required' by default
          const autoCheck = p.name === 'tool_choice' ? new Set(['auto', 'required']) : new Set(vals);
          const checkboxes = vals.map(v =>
            `<label class="flex items-center gap-2 text-xs text-zinc-400 font-body cursor-pointer"><input type="checkbox" id="pt_${p.name}_val_${v}" class="pt-enum-${p.name} accent-lime-accent" ${autoCheck.has(v) ? 'checked' : ''} onchange="ptUpdatePreview()"> ${v}</label>`
          ).join('\n                  ');

          row.innerHTML = `
            <label class="relative inline-flex items-center cursor-pointer mt-1.5">
              <input type="checkbox" id="ptToggle_${p.name}" ${shouldEnable ? 'checked' : ''} ${isLocked ? 'disabled' : ''} class="sr-only peer" onchange="ptUpdatePreview()">
              <div class="${_ptToggleStyle()}"></div>
            </label>
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-2">
                <span class="text-xs text-zinc-400 font-body">${_ptDisplayName(p.name)}</span>
                ${_ptSupportBadge(p.supportedBy, p.totalModels)}
                ${isLocked ? `<span class="text-[10px] text-zinc-600 font-mono">locked: ${p.lockedValue}</span>` : ''}
              </div>
              ${isLocked ? `<div class="text-xs font-mono text-zinc-500">${p.lockedValue}</div>` : `
              <div class="flex flex-wrap gap-4">
                  ${checkboxes}
              </div>`}
            </div>`;
        } else if (p.type === 'bool') {
          row.innerHTML = `
            <label class="relative inline-flex items-center cursor-pointer mt-1.5">
              <input type="checkbox" id="ptToggle_${p.name}" ${isLocked ? 'disabled' : ''} class="sr-only peer" onchange="ptUpdatePreview()">
              <div class="${_ptToggleStyle()}"></div>
            </label>
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="text-xs text-zinc-400 font-body">${_ptDisplayName(p.name)}</span>
                ${_ptSupportBadge(p.supportedBy, p.totalModels)}
              </div>
            </div>`;
        } else {
          // string_array or other non-sweepable types — show as info-only
          row.innerHTML = `
            <label class="relative inline-flex items-center cursor-pointer mt-1.5 opacity-40">
              <input type="checkbox" disabled class="sr-only peer">
              <div class="${_ptToggleStyle()}"></div>
            </label>
            <div class="flex-1">
              <div class="flex items-center gap-2">
                <span class="text-xs text-zinc-500 font-body">${_ptDisplayName(p.name)}</span>
                ${_ptSupportBadge(p.supportedBy, p.totalModels)}
                <span class="text-[10px] text-zinc-600 font-body">(not sweepable)</span>
              </div>
            </div>`;
        }

        container.appendChild(row);
      }

      // Render custom parameters section
      _ptRenderCustomParamsSection(container);

      // After rendering, update the preview
      ptUpdatePreview();
    }

    // --- Custom Parameters Section ---
    function _ptGetTier3Suggestions() {
      const reg = _ptGetRegistry();
      if (!reg || ptSelectedModels.size === 0 || !config?.providers) return [];

      const seen = new Set();
      const suggestions = [];
      for (const [ck, pd] of Object.entries(config.providers)) {
        const rk = ptGetRegistryKey(ck, pd);
        const provReg = reg[rk] || reg._unknown;
        if (!provReg?.tier3_examples) continue;
        const models = getProviderModels(pd);
        const hasSelected = models.some(m => ptSelectedModels.has(_ptCompoundKey(pd.provider_key || ck, m.model_id)));
        if (!hasSelected) continue;
        for (const [pname, pdef] of Object.entries(provReg.tier3_examples)) {
          if (!seen.has(pname)) {
            seen.add(pname);
            suggestions.push({ name: pname, ...pdef, provider: provReg.display_name || rk });
          }
        }
      }
      return suggestions;
    }

    function _ptRenderCustomParamsSection(container) {
      const section = document.createElement('div');
      section.id = 'ptCustomParamsSection';
      section.className = 'border-t border-zinc-800 mt-4 pt-4';

      const suggestions = _ptGetTier3Suggestions();
      const hintText = suggestions.length
        ? suggestions.slice(0, 4).map(s => s.name).join(', ')
        : 'repetition_penalty, min_p, ...';

      section.innerHTML = `
        <div class="flex items-center justify-between mb-3">
          <span class="section-label" style="margin:0">Custom Parameters</span>
          <span class="text-[10px] text-zinc-600 font-body">Tier 3 passthrough</span>
        </div>
        ${suggestions.length ? `<div class="text-[10px] text-zinc-600 font-body mb-3">Suggested for selected providers: <span class="text-zinc-500">${suggestions.map(s => s.name).join(', ')}</span></div>` : ''}
        <div id="ptCustomParamsList" class="space-y-3"></div>
        <button onclick="ptAddCustomParam()" class="mt-3 text-xs text-zinc-400 hover:text-lime-400 transition-colors font-body flex items-center gap-1">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
          Add Custom Parameter
        </button>`;

      container.appendChild(section);
    }

    let _ptCustomParamCounter = 0;

    function ptAddCustomParam() {
      const list = document.getElementById('ptCustomParamsList');
      if (!list) return;

      const id = _ptCustomParamCounter++;
      const suggestions = _ptGetTier3Suggestions();
      const placeholder = suggestions.length
        ? suggestions[Math.min(id, suggestions.length - 1)].name
        : 'param_name';

      const row = document.createElement('div');
      row.className = 'flex items-start gap-2';
      row.dataset.customParam = 'true';
      row.dataset.customId = id;

      row.innerHTML = `
        <div class="flex-1 rounded-sm p-3" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);">
          <div class="flex items-center gap-2 mb-2">
            <input type="text" id="ptCustomName_${id}" placeholder="${placeholder}" class="${_ptInputStyle()}" style="${_ptInputInline()}width:140px;" onchange="ptUpdatePreview()">
            <select id="ptCustomType_${id}" class="text-xs font-mono px-2 py-1.5 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;" onchange="ptCustomTypeChanged(${id})">
              <option value="range">Range (min/max/step)</option>
              <option value="values">Values (comma-separated)</option>
            </select>
            <button onclick="ptRemoveCustomParam(${id})" class="text-zinc-600 hover:text-red-400 transition-colors ml-auto" title="Remove">
              <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div id="ptCustomInputs_${id}">
            <div class="grid grid-cols-3 gap-2" id="ptCustomRange_${id}">
              <div><label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Min</label><input id="ptCustomMin_${id}" type="number" step="0.01" value="0" class="${_ptInputStyle()}" style="${_ptInputInline()}" onchange="ptUpdatePreview()"></div>
              <div><label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Max</label><input id="ptCustomMax_${id}" type="number" step="0.01" value="1" class="${_ptInputStyle()}" style="${_ptInputInline()}" onchange="ptUpdatePreview()"></div>
              <div><label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Step</label><input id="ptCustomStep_${id}" type="number" step="0.01" min="0.001" value="0.1" class="${_ptInputStyle()}" style="${_ptInputInline()}" onchange="ptUpdatePreview()"></div>
            </div>
            <div class="hidden" id="ptCustomValues_${id}">
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Values</label>
              <input id="ptCustomValuesInput_${id}" type="text" placeholder="1.0, 1.05, 1.1" class="${_ptInputStyle()}" style="${_ptInputInline()}" onchange="ptUpdatePreview()">
            </div>
          </div>
          <div id="ptCustomPills_${id}" class="flex flex-wrap gap-1 mt-2"></div>
        </div>`;

      list.appendChild(row);
      ptUpdatePreview();
    }

    function ptRemoveCustomParam(id) {
      const row = document.querySelector(`[data-custom-id="${id}"]`);
      if (row) row.remove();
      ptUpdatePreview();
    }

    function ptCustomTypeChanged(id) {
      const type = document.getElementById('ptCustomType_' + id)?.value;
      const rangeEl = document.getElementById('ptCustomRange_' + id);
      const valuesEl = document.getElementById('ptCustomValues_' + id);
      if (type === 'range') {
        rangeEl?.classList.remove('hidden');
        valuesEl?.classList.add('hidden');
      } else {
        rangeEl?.classList.add('hidden');
        valuesEl?.classList.remove('hidden');
      }
      ptUpdatePreview();
    }

    function _ptParseCustomValues(str) {
      if (!str || !str.trim()) return [];
      return str.split(',').map(v => v.trim()).filter(v => v !== '').map(v => {
        const num = Number(v);
        return isNaN(num) ? v : num;
      });
    }

    // --- Task #7: Wire model selection changes ---
    function ptOnModelsChanged() {
      _scSetModels(ptSelectedModels);
      const paramDefs = ptComputeAvailableParams();
      ptRenderDynamicParams(paramDefs);
    }

    function ptGenerateValues(min, max, step) {
      const vals = [];
      if (step <= 0 || min > max) return vals;
      // Use epsilon to handle floating point
      for (let v = min; v <= max + step * 0.001; v += step) {
        vals.push(Math.round(v * 1000) / 1000);
      }
      return vals;
    }

    function ptUpdatePreview() {
      const dims = [];
      const breakdown = [];
      const rows = document.querySelectorAll('#ptSearchSpace [data-param-name]');

      for (const row of rows) {
        const name = row.dataset.paramName;
        const type = row.dataset.paramType;
        const toggle = document.getElementById('ptToggle_' + name);
        if (!toggle || !toggle.checked) {
          // Clear pills for disabled params
          const pills = document.getElementById('pt_' + name + '_pills');
          if (pills) pills.innerHTML = '';
          continue;
        }

        if (type === 'float' || type === 'int') {
          const pf = type === 'float' ? parseFloat : parseInt;
          const minVal = pf(document.getElementById('pt_' + name + '_min')?.value) || 0;
          const maxVal = pf(document.getElementById('pt_' + name + '_max')?.value) || 1;
          const stepVal = pf(document.getElementById('pt_' + name + '_step')?.value) || (type === 'float' ? 0.1 : 1);
          const vals = ptGenerateValues(minVal, maxVal, stepVal);
          const displayVals = type === 'int' ? vals.map(v => Math.round(v)) : vals;
          ptRenderPills('pt_' + name + '_pills', displayVals);
          if (vals.length) { dims.push(vals.length); breakdown.push(vals.length + ' ' + name); }
        } else if (type === 'enum') {
          const checks = document.querySelectorAll('.pt-enum-' + name + ':checked');
          const count = checks.length;
          if (count) { dims.push(count); breakdown.push(count + ' ' + name); }
        } else if (type === 'bool') {
          dims.push(2);
          breakdown.push('2 ' + name);
        }
      }

      // Count custom params
      const customRows = document.querySelectorAll('#ptCustomParamsList [data-custom-param]');
      for (const crow of customRows) {
        const cid = crow.dataset.customId;
        const cname = document.getElementById('ptCustomName_' + cid)?.value?.trim();
        if (!cname) { ptRenderPills('ptCustomPills_' + cid, []); continue; }
        const ctype = document.getElementById('ptCustomType_' + cid)?.value;
        if (ctype === 'range') {
          const cmin = parseFloat(document.getElementById('ptCustomMin_' + cid)?.value) || 0;
          const cmax = parseFloat(document.getElementById('ptCustomMax_' + cid)?.value) || 1;
          const cstep = parseFloat(document.getElementById('ptCustomStep_' + cid)?.value) || 0.1;
          const vals = ptGenerateValues(cmin, cmax, cstep);
          ptRenderPills('ptCustomPills_' + cid, vals);
          if (vals.length) { dims.push(vals.length); breakdown.push(vals.length + ' ' + cname); }
        } else {
          const vals = _ptParseCustomValues(document.getElementById('ptCustomValuesInput_' + cid)?.value);
          ptRenderPills('ptCustomPills_' + cid, vals);
          if (vals.length) { dims.push(vals.length); breakdown.push(vals.length + ' ' + cname); }
        }
      }

      const total = dims.length ? dims.reduce((a, b) => a * b, 1) : 0;
      ptTotalCombos = total;

      const countEl = document.getElementById('ptGridCount');
      const breakEl = document.getElementById('ptGridBreakdown');
      if (countEl) countEl.textContent = total;
      if (breakEl) breakEl.textContent = dims.length > 1 ? '= ' + dims.join(' x ') : '';

      const badge = document.getElementById('ptGridBadge');
      if (badge) {
        if (total === 0) { badge.textContent = ''; badge.style.background = 'transparent'; badge.style.color = 'transparent'; }
        else if (total < 20) { badge.textContent = 'QUICK'; badge.style.background = 'rgba(191,255,0,0.1)'; badge.style.color = 'var(--lime)'; }
        else if (total < 50) { badge.textContent = 'MODERATE'; badge.style.background = 'rgba(234,179,8,0.1)'; badge.style.color = '#EAB308'; }
        else if (total <= 100) { badge.textContent = 'LARGE'; badge.style.background = 'rgba(249,115,22,0.1)'; badge.style.color = '#F97316'; }
        else { badge.textContent = 'WARNING'; badge.style.background = 'rgba(255,59,92,0.1)'; badge.style.color = 'var(--coral)'; }
      }

      // Update compatibility matrix
      ptRenderCompatMatrix();
    }

    function ptRenderPills(containerId, values) {
      const el = document.getElementById(containerId);
      if (!el) return;
      el.innerHTML = values.map(v => `<span class="inline-block px-2 py-0.5 rounded-sm text-[10px] font-mono text-zinc-300" style="background:rgba(255,255,255,0.04);border:1px solid var(--border-subtle);">${v}</span>`).join('');
    }

    // --- Task #9: Compatibility Matrix ---
    function ptRenderCompatMatrix() {
      const section = document.getElementById('ptCompatSection');
      const body = document.getElementById('ptCompatBody');
      if (!section || !body) return;

      // Need at least 1 model selected and param_support configured
      const ps = _p10Settings?.param_support;
      const hasPS = ps && ps.provider_defaults && Object.keys(ps.provider_defaults).length > 0;
      if (ptSelectedModels.size === 0 || !config?.providers) {
        section.classList.add('hidden');
        body.innerHTML = '';
        return;
      }

      // Build per-model param info
      const reg = _ptGetRegistry();
      const models = []; // [{id, shortName, rk, providerKey}]
      for (const [ck, pd] of Object.entries(config.providers)) {
        const rk = ptGetRegistryKey(ck, pd);
        for (const m of getProviderModels(pd)) {
          if (ptSelectedModels.has(_ptCompoundKey(pd.provider_key || ck, m.model_id))) {
            const shortName = m.display_name || m.model_id.split('/').pop();
            models.push({ id: m.model_id, shortName, rk, providerKey: pd.provider_key || ck });
          }
        }
      }
      if (models.length === 0) { section.classList.add('hidden'); body.innerHTML = ''; return; }

      // Get global search space from current UI state
      const globalSpace = ptBuildSearchSpace();
      const enabledParams = Object.keys(globalSpace);
      if (enabledParams.length === 0) {
        section.classList.add('hidden');
        body.innerHTML = '';
        return;
      }

      // For each model + param, determine support status
      // Returns: { status: 'supported'|'locked'|'passthrough', range?, lockedValue? }
      // Per user decision: NEVER block params — at worst warn (passthrough).
      function getParamStatus(model, pname, globalVal) {
        if (hasPS) {
          const provPS = ps.provider_defaults[model.rk];
          if (!provPS) return { status: 'passthrough', range: globalVal }; // No config = pass-through
          const pspec = provPS.params?.[pname];

          // Check model overrides
          const modelOverrides = ps.model_overrides?.[model.rk] || {};
          let override = null;
          for (const [pattern, overrides] of Object.entries(modelOverrides)) {
            if (_ptMatchesGlob(model.id.split('/').pop(), pattern)) {
              if (overrides[pname]) override = overrides[pname];
            }
          }
          if (override?.locked === true) return { status: 'locked', lockedValue: override.value };

          // If not in param_support config at all, treat as passthrough (warn, not drop)
          if (!pspec || pspec.enabled === false) {
            return { status: 'passthrough', range: globalVal };
          }

          // Supported - compute clamped range
          if (typeof globalVal === 'object' && !Array.isArray(globalVal) && globalVal.min !== undefined) {
            const provMin = pspec.min ?? globalVal.min;
            const provMax = pspec.max ?? globalVal.max;
            const clampedMin = Math.max(globalVal.min, provMin);
            const clampedMax = Math.min(globalVal.max, provMax);
            const isClamped = clampedMin !== globalVal.min || clampedMax !== globalVal.max;
            return { status: 'supported', range: { min: clampedMin, max: clampedMax, step: globalVal.step }, clamped: isClamped };
          }
          return { status: 'supported', range: globalVal };
        } else {
          // No param_support - check registry
          const provReg = reg?.[model.rk] || reg?._unknown;
          if (!provReg) return { status: 'passthrough', range: globalVal };
          const allParams = { ...(provReg.tier1 || {}), ...(provReg.tier2 || {}) };
          const pdef = allParams[pname];
          // Check model overrides for locked
          const modelOverrides = provReg.model_overrides || {};
          for (const [pattern, overrides] of Object.entries(modelOverrides)) {
            if (_ptMatchesGlob(model.id.split('/').pop(), pattern)) {
              const ov = overrides[pname];
              if (ov?.locked === true) return { status: 'locked', lockedValue: ov.value };
            }
          }
          // If not in tier1/tier2, check tier3_examples or treat as passthrough
          if (!pdef || pdef.supported === false) {
            const inTier3 = provReg.tier3_examples?.[pname];
            return { status: 'passthrough', range: globalVal, tier3: !!inTier3 };
          }
          return { status: 'supported', range: globalVal };
        }
      }

      // Build the matrix data
      const matrix = []; // [{param, cells: [{status, range?, lockedValue?, clamped?}]}]
      const perModelCombos = models.map(() => []); // per-model list of value counts

      for (const pname of enabledParams) {
        const globalVal = globalSpace[pname];
        const row = { param: pname, cells: [] };
        for (let mi = 0; mi < models.length; mi++) {
          const status = getParamStatus(models[mi], pname, globalVal);
          row.cells.push(status);
          // Count values for combo calculation
          if (status.status === 'supported' || status.status === 'passthrough') {
            const r = status.range;
            if (typeof r === 'object' && !Array.isArray(r) && r.min !== undefined) {
              perModelCombos[mi].push(ptGenerateValues(r.min, r.max, r.step).length || 1);
            } else if (Array.isArray(r)) {
              perModelCombos[mi].push(r.length || 1);
            } else {
              perModelCombos[mi].push(1);
            }
          } else if (status.status === 'locked') {
            perModelCombos[mi].push(1);
          }
        }
        matrix.push(row);
      }

      // Compute combo counts per model
      const comboCounts = perModelCombos.map(arr => arr.length ? arr.reduce((a, b) => a * b, 1) : 0);

      // Count adjustments summary
      let totalPassthrough = 0, totalClamped = 0, totalLocked = 0;
      for (const row of matrix) {
        for (const cell of row.cells) {
          if (cell.status === 'passthrough') totalPassthrough++;
          if (cell.status === 'locked') totalLocked++;
          if (cell.clamped) totalClamped++;
        }
      }

      // Render HTML
      const esc = s => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

      // Helper to render cell content
      function renderCell(cell) {
        if (cell.status === 'passthrough') {
          const tip = cell.tier3 ? 'Known passthrough param — will be sent as-is' : 'Unknown param — will attempt to send (may error)';
          const label = cell.tier3 ? 'pass' : '?send';
          return `<span class="text-yellow-500" title="${tip}" style="font-size:10px;">${label}</span>`;
        }
        if (cell.status === 'locked') {
          return `<span class="text-amber-500" title="Locked to fixed value" style="font-size:10px;">locked=${esc(cell.lockedValue)}</span>`;
        }
        // Supported
        const r = cell.range;
        if (typeof r === 'object' && !Array.isArray(r) && r.min !== undefined) {
          const clampClass = cell.clamped ? 'text-sky-400' : 'text-zinc-400';
          const clampTitle = cell.clamped ? 'Range clamped to model limits' : 'Full range';
          return `<span class="${clampClass}" title="${clampTitle}" style="font-size:10px;">${r.min}-${r.max} /${r.step}</span>`;
        }
        if (Array.isArray(r)) {
          return `<span class="text-zinc-400" style="font-size:10px;">${r.length} vals</span>`;
        }
        return `<span class="text-lime-accent" style="font-size:10px;">ok</span>`;
      }

      // Truncate model names for column headers
      const maxNameLen = models.length > 4 ? 12 : 18;
      const truncName = s => s.length > maxNameLen ? s.slice(0, maxNameLen - 1) + '\u2026' : s;

      let html = `<table class="w-full text-xs font-mono" style="border-collapse:collapse;">`;
      // Header
      html += `<thead><tr><th class="text-left text-zinc-500 font-display text-[10px] uppercase tracking-wider px-2 py-1.5" style="border-bottom:1px solid var(--border-subtle);">Param</th>`;
      for (const m of models) {
        html += `<th class="text-center text-zinc-500 font-display text-[10px] uppercase tracking-wider px-2 py-1.5" style="border-bottom:1px solid var(--border-subtle);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(m.id)}">${esc(truncName(m.shortName))}</th>`;
      }
      html += `</tr></thead><tbody>`;

      // Param rows
      for (const row of matrix) {
        html += `<tr>`;
        html += `<td class="text-zinc-300 px-2 py-1" style="border-bottom:1px solid rgba(255,255,255,0.03);">${esc(_ptDisplayName(row.param))}</td>`;
        for (const cell of row.cells) {
          html += `<td class="text-center px-2 py-1" style="border-bottom:1px solid rgba(255,255,255,0.03);">${renderCell(cell)}</td>`;
        }
        html += `</tr>`;
      }

      // Combo count row
      html += `<tr style="border-top:1px solid var(--border-subtle);">`;
      html += `<td class="text-zinc-400 font-display text-[10px] uppercase tracking-wider px-2 py-1.5 font-semibold">Combos</td>`;
      for (const count of comboCounts) {
        const color = count === 0 ? 'text-zinc-600' : count < 20 ? 'text-lime-accent' : count < 50 ? 'text-amber-400' : 'text-orange-400';
        html += `<td class="text-center px-2 py-1.5 font-semibold ${color}">${count}</td>`;
      }
      html += `</tr>`;
      html += `</tbody></table>`;

      // Adjustments summary below table
      const hasAdj = totalPassthrough > 0 || totalClamped > 0 || totalLocked > 0;
      if (hasAdj) {
        const parts = [];
        if (totalPassthrough) parts.push(`<span class="text-yellow-500">${totalPassthrough} passthrough</span>`);
        if (totalClamped) parts.push(`<span class="text-sky-400">${totalClamped} clamped</span>`);
        if (totalLocked) parts.push(`<span class="text-amber-500">${totalLocked} locked</span>`);
        html += `<div class="mt-2 text-[10px] font-body text-zinc-500">Runtime adjustments: ${parts.join(' &middot; ')}</div>`;
      }

      body.innerHTML = html;
      section.classList.remove('hidden');
    }

    function ptBuildSearchSpace() {
      const space = {};
      const rows = document.querySelectorAll('#ptSearchSpace [data-param-name]');

      for (const row of rows) {
        const name = row.dataset.paramName;
        const type = row.dataset.paramType;
        const toggle = document.getElementById('ptToggle_' + name);
        if (!toggle || !toggle.checked) continue;

        if (type === 'float' || type === 'int') {
          const pf = type === 'float' ? parseFloat : parseInt;
          space[name] = {
            min: pf(document.getElementById('pt_' + name + '_min')?.value) || 0,
            max: pf(document.getElementById('pt_' + name + '_max')?.value) || 1,
            step: pf(document.getElementById('pt_' + name + '_step')?.value) || (type === 'float' ? 0.1 : 1)
          };
        } else if (type === 'enum') {
          const checked = [...document.querySelectorAll('.pt-enum-' + name + ':checked')].map(cb => cb.id.replace('pt_' + name + '_val_', ''));
          if (checked.length) space[name] = checked;
        } else if (type === 'bool') {
          space[name] = [true, false];
        }
      }

      // Include custom params
      const customRows = document.querySelectorAll('#ptCustomParamsList [data-custom-param]');
      for (const crow of customRows) {
        const cid = crow.dataset.customId;
        const cname = document.getElementById('ptCustomName_' + cid)?.value?.trim();
        if (!cname) continue;
        const ctype = document.getElementById('ptCustomType_' + cid)?.value;
        if (ctype === 'range') {
          const cmin = parseFloat(document.getElementById('ptCustomMin_' + cid)?.value) || 0;
          const cmax = parseFloat(document.getElementById('ptCustomMax_' + cid)?.value) || 1;
          const cstep = parseFloat(document.getElementById('ptCustomStep_' + cid)?.value) || 0.1;
          space[cname] = { min: cmin, max: cmax, step: cstep };
        } else {
          const vals = _ptParseCustomValues(document.getElementById('ptCustomValuesInput_' + cid)?.value);
          if (vals.length) space[cname] = vals;
        }
      }

      return space;
    }

    // Build per-model search spaces, clamped to each model's param_support domain
    function ptBuildPerModelSearchSpaces() {
      const globalSpace = ptBuildSearchSpace();
      const ps = _p10Settings?.param_support;
      if (!ps?.provider_defaults || Object.keys(ps.provider_defaults).length === 0) {
        return null; // No param_support — backend will use global search_space
      }

      const perModel = {};
      for (const compoundKey of ptSelectedModels) {
        const { provider_key: pk, model_id: modelId } = _ptParseCompoundKey(compoundKey);
        // Resolve registry key from provider config (pk is config key, providers keyed by display_name)
        const pd = config.providers[pk] || Object.values(config.providers).find(p => p.provider_key === pk);
        const rk = pd ? ptGetRegistryKey(pk, pd) : '_unknown';

        const provPS = ps.provider_defaults[rk];
        if (!provPS) {
          perModel[modelId] = globalSpace; // No config for this provider, use global
          continue;
        }

        const provParams = provPS.params || {};
        const modelOverrides = ps.model_overrides?.[rk] || {};
        const tailored = {};

        for (const [pname, pval] of Object.entries(globalSpace)) {
          // Check if param is enabled for this provider
          const pspec = provParams[pname];
          if (!pspec || pspec.enabled === false) continue; // Skip unsupported

          // Check model overrides
          let override = null;
          for (const [pattern, overrides] of Object.entries(modelOverrides)) {
            if (_ptMatchesGlob(modelId.split('/').pop(), pattern)) {
              if (overrides[pname]) override = overrides[pname];
            }
          }

          if (override?.supported === false) continue; // Model override says unsupported
          if (override?.locked === true) {
            // Locked to a specific value
            tailored[pname] = [override.value];
            continue;
          }

          // For numeric ranges, clamp to provider's supported range
          if (typeof pval === 'object' && !Array.isArray(pval) && pval.min !== undefined) {
            const provMin = pspec.min ?? pval.min;
            const provMax = pspec.max ?? pval.max;
            tailored[pname] = {
              min: Math.max(pval.min, provMin),
              max: Math.min(pval.max, provMax),
              step: pval.step,
            };
            // Ensure min <= max after clamping
            if (tailored[pname].min > tailored[pname].max) {
              tailored[pname].min = tailored[pname].max;
            }
          } else {
            // Enum or array values — pass through
            tailored[pname] = pval;
          }
        }

        perModel[modelId] = tailored;
      }

      return perModel;
    }

    function ptLoadSuiteSelector() {
      const sel = document.getElementById('ptSuiteSelect');
      const existing = sel.value;
      sel.innerHTML = '<option value="">-- Select a tool eval suite --</option>';
      if (teSuites && teSuites.length) {
        for (const s of teSuites) {
          sel.innerHTML += `<option value="${s.id}" ${s.id === existing ? 'selected' : ''}>${_teEsc(s.name)} (${s.test_case_count || 0} cases)</option>`;
        }
      }
      // Pre-select from shared context if no existing value
      if (!existing && _sharedContext.suite_id) {
        sel.value = _sharedContext.suite_id;
      }
    }

    // Helper: build compound key for ptSelectedModels
    function _ptCompoundKey(providerKey, modelId) { return providerKey + '::' + modelId; }
    // Helper: parse compound key back into {provider_key, model_id}
    function _ptParseCompoundKey(key) {
      const i = key.indexOf('::');
      return { provider_key: key.substring(0, i), model_id: key.substring(i + 2) };
    }
    // Helper: check if a model_id is selected (any provider)
    function _ptIsModelSelected(modelId) {
      for (const k of ptSelectedModels) { if (k.endsWith('::' + modelId)) return true; }
      return false;
    }

    function ptRenderModelGrid() {
      const grid = document.getElementById('ptModelGrid');
      grid.innerHTML = '';
      ptSelectedModels.clear();
      if (!config || !config.providers) return;

      // Pre-select from shared context if available
      const scModels = _scGetModels();

      for (const [provider, provData] of Object.entries(config.providers)) {
        const color = getColor(provider);
        const models = getProviderModels(provData);
        if (!models.length) continue;

        const group = document.createElement('div');
        group.className = 'provider-group';
        group.style.borderColor = color.border;

        const header = document.createElement('div');
        header.className = 'provider-group-header';
        header.innerHTML = `
          <div class="provider-group-dot" style="background:${color.text}"></div>
          <span class="provider-group-label" style="color:${color.text}">${provider}</span>
          <span class="provider-group-count">${models.length}</span>
        `;
        header.onclick = () => {
          const cards = group.querySelectorAll('.model-card');
          const allSel = [...cards].every(c => c.classList.contains('selected'));
          cards.forEach(c => {
            const ck = c.dataset.compoundKey;
            if (allSel) { ptSelectedModels.delete(ck); c.classList.remove('selected'); }
            else { ptSelectedModels.add(ck); c.classList.add('selected'); }
          });
          ptOnModelsChanged();
        };
        group.appendChild(header);

        const subgrid = document.createElement('div');
        subgrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 pl-3';
        for (const m of models) {
          const ck = _ptCompoundKey(provData.provider_key || provider, m.model_id);
          const card = document.createElement('div');
          card.className = 'model-card rounded-sm px-4 py-3 flex items-center gap-3';
          card.dataset.modelId = m.model_id;
          card.dataset.compoundKey = ck;
          card.dataset.providerKey = provData.provider_key || provider;
          // Pre-select from shared context
          if (scModels.size > 0 && scModels.has(ck)) {
            ptSelectedModels.add(ck);
            card.classList.add('selected');
          }
          card.onclick = (e) => {
            e.stopPropagation();
            if (ptSelectedModels.has(ck)) { ptSelectedModels.delete(ck); card.classList.remove('selected'); }
            else { ptSelectedModels.add(ck); card.classList.add('selected'); }
            ptOnModelsChanged();
          };
          card.innerHTML = `<div class="check-dot flex-shrink-0"></div><div class="flex-1 min-w-0"><div class="text-[13px] font-medium text-zinc-200 truncate font-body">${m.display_name}</div></div>`;
          subgrid.appendChild(card);
        }
        group.appendChild(subgrid);
        grid.appendChild(group);
      }
      // If pre-selection happened, trigger param update
      if (ptSelectedModels.size > 0 && scModels.size > 0) {
        ptOnModelsChanged();
      }
    }

    let _activeParamTuneJobId = null;
    let _activeParamTuneRunId = null;  // tune run ID for reconnection/backfill
    let _ptSeenCombos = new Set();     // dedup: "model_id:combo_index" keys

    // Show a banner on pt-config if a tune is currently running
    function _ptCheckRunningBanner() {
      const existingBanner = document.getElementById('ptRunningBanner');
      if (existingBanner) existingBanner.remove();

      // Check if there's an active param tune job
      if (!_activeParamTuneJobId) return;
      const job = _jobStore[_activeParamTuneJobId];
      if (!job || !['running','pending','queued'].includes(job.status)) return;

      const configView = document.getElementById('pt-config-view');
      if (!configView) return;

      const banner = document.createElement('div');
      banner.id = 'ptRunningBanner';
      banner.className = 'mb-4 px-4 py-3 rounded-md text-sm font-body cursor-pointer';
      banner.style.cssText = 'background:rgba(56,189,248,0.08);border:1px solid rgba(56,189,248,0.25);color:#38BDF8;';
      const pct = job.progress_pct || 0;
      const detail = job.progress_detail || 'Running...';
      banner.innerHTML = `<div class="flex items-center justify-between"><span>Tuning in progress (${pct}%) — ${detail}</span><span class="text-[10px] font-display tracking-wider uppercase">Click to view</span></div>`;
      banner.onclick = () => {
        let tuneId = _activeParamTuneRunId || job.result_ref;
        if (!tuneId) { try { tuneId = sessionStorage.getItem('_ptRunId'); } catch {} }
        if (tuneId) {
          ptViewHistoryRun(tuneId);
        } else {
          showToolEvalView('pt-history');
        }
      };
      configView.prepend(banner);
    }

    async function ptStartTune() {
      const suiteId = document.getElementById('ptSuiteSelect').value;
      if (!suiteId) { showToast('Select a tool eval suite', 'error'); return; }
      if (ptSelectedModels.size === 0) { showToast('Select at least one model', 'error'); return; }
      const searchSpace = ptBuildSearchSpace();
      if (Object.keys(searchSpace).length === 0) { showToast('Enable at least one parameter to sweep', 'error'); return; }

      const btn = document.getElementById('ptStartBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Running...';

      ptResults = [];
      ptBestConfig = null;
      ptBestScore = 0;
      _ptSearchSpaceKeys = Object.keys(searchSpace);  // capture for column rendering

      showToolEvalView('pt-run');
      document.getElementById('ptProgressSection').classList.remove('hidden');
      document.getElementById('ptBestCard').classList.add('hidden');
      document.getElementById('ptResultsSection').classList.remove('hidden');
      document.getElementById('ptApplyBestBtn').classList.add('hidden');
      document.getElementById('ptReEvalBtn').classList.add('hidden');
      document.getElementById('ptResultsHead').innerHTML = '';
      document.getElementById('ptResultsBody').innerHTML = '';
      const _adjBanner = document.getElementById('ptAdjustmentsSummary');
      if (_adjBanner) { _adjBanner.classList.add('hidden'); _adjBanner.innerHTML = ''; }
      document.getElementById('ptProgressBar').style.width = '0%';
      document.getElementById('ptProgressLabel').textContent = 'Submitting...';
      document.getElementById('ptProgressCount').textContent = '0/0';
      _ptClearETA();
      _activeParamTuneRunId = null;
      try { sessionStorage.removeItem('_ptRunId'); } catch {}
      _ptSeenCombos = new Set();

      // Build per-model search spaces if param_support config is available
      const perModelSpaces = ptBuildPerModelSearchSpaces();
      // Send targets as [{provider_key, model_id}] for precise provider matching
      const targets = Array.from(ptSelectedModels).map(k => _ptParseCompoundKey(k));
      // Write suite to shared context
      _scSetSuite(suiteId, document.getElementById('ptSuiteSelect').options[document.getElementById('ptSuiteSelect').selectedIndex]?.text || '');
      const body = {
        suite_id: suiteId,
        targets: targets,
        search_space: searchSpace,
      };
      // Include experiment_id from shared context
      if (_sharedContext.experiment_id) body.experiment_id = _sharedContext.experiment_id;
      if (perModelSpaces) {
        body.per_model_search_spaces = perModelSpaces;
      }

      try {
        const res = await apiFetch('/api/tool-eval/param-tune', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (res.status === 409) { showToast('A benchmark or eval is already running', 'error'); _ptResetStartBtn(); return; }
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || `Server error (${res.status})`, 'error');
          _ptResetStartBtn(); return;
        }

        // Job-based response: {job_id, status}
        const data = await res.json();
        _activeParamTuneJobId = data.job_id;
        document.getElementById('ptProgressLabel').textContent = data.status === 'submitted' ? 'Tune queued...' : 'Tune starting...';
        showToast('Parameter tuning submitted', 'success');

        // Progress updates arrive via WebSocket (handled by _onParamTuneJobEvent)
      } catch (e) {
        showToast('Connection error: ' + (e.message || 'unknown'), 'error');
        _ptResetStartBtn();
      }
    }

    // Format ETA seconds into human-readable string
    function _ptFormatETA(seconds) {
      if (!isFinite(seconds) || seconds < 0) return 'Estimating...';
      if (seconds < 10) return 'Almost done...';
      if (seconds < 60) return `~${Math.round(seconds)}s remaining`;
      const m = Math.floor(seconds / 60);
      const s = Math.round(seconds % 60);
      return s > 0 ? `~${m}m ${s}s remaining` : `~${m}m remaining`;
    }

    // Format elapsed seconds into human-readable string
    function _ptFormatElapsed(seconds) {
      if (!isFinite(seconds) || seconds < 0) return '0s';
      if (seconds < 60) return `${Math.round(seconds)}s`;
      const m = Math.floor(seconds / 60);
      const s = Math.round(seconds % 60);
      return s > 0 ? `${m}m ${s}s` : `${m}m`;
    }

    // Update ETA display based on current progress
    function _ptUpdateETA() {
      const etaEl = document.getElementById('ptETA');
      if (!etaEl) return;
      const completed = ptResults.length - _ptEtaBaseCount;
      if (!_ptTuneStartTime || completed === 0) {
        etaEl.textContent = '';
        return;
      }
      const elapsed = (Date.now() - _ptTuneStartTime) / 1000;
      if (completed < 3) {
        etaEl.textContent = 'Elapsed: ' + _ptFormatElapsed(elapsed);
        return;
      }
      const rate = completed / elapsed;
      if (rate <= 0) { etaEl.textContent = 'Estimating...'; return; }
      const remaining = (ptTotalCombos - ptResults.length) / rate;
      etaEl.textContent = _ptFormatETA(remaining);
    }

    // Clear ETA display and reset tracking state
    function _ptClearETA() {
      _ptTuneStartTime = null;
      _ptEtaBaseCount = 0;
      _ptJobStartedAt = null;
      const etaEl = document.getElementById('ptETA');
      if (etaEl) etaEl.textContent = '';
    }

    // WebSocket event bridge for inline param tuner progress
    function _onParamTuneJobEvent(msg) {
      // Accept events from the known active job, or from any param_tune job when
      // we're in reconnection mode (tuneId set but jobId not yet known from WS sync)
      if (_activeParamTuneJobId && msg.job_id !== _activeParamTuneJobId) return;
      if (!_activeParamTuneJobId) {
        if (!_activeParamTuneRunId) return; // Not in reconnection mode
        // Auto-associate this job as the active one
        _activeParamTuneJobId = msg.job_id;
      }

      switch (msg.type) {
        case 'job_started':
          document.getElementById('ptProgressLabel').textContent = 'Tune running...';
          break;

        case 'job_progress': {
          const pct = msg.progress_pct || 0;
          document.getElementById('ptProgressBar').style.width = pct + '%';
          document.getElementById('ptProgressLabel').textContent = msg.progress_detail || 'Running...';
          break;
        }

        case 'tune_start':
          ptTotalCombos = msg.total_combos || 0;
          _activeParamTuneRunId = msg.tune_id || null;
          if (_activeParamTuneRunId) {
            try { sessionStorage.setItem('_ptRunId', _activeParamTuneRunId); } catch {}
          }
          _ptSeenCombos = new Set();
          _ptTuneStartTime = Date.now();
          _ptEtaBaseCount = 0;
          _ptJobStartedAt = new Date().toISOString();
          document.getElementById('ptProgressLabel').textContent = `Tuning ${msg.models?.length || 0} model(s), ${ptTotalCombos} combinations`;
          document.getElementById('ptProgressCount').textContent = `0/${ptTotalCombos}`;
          break;

        case 'combo_result': {
          const evt = msg.data || msg;
          // Dedup: skip if already backfilled from DB
          const dedupKey = `${evt.model_id || ''}:${evt.combo_index ?? ''}`;
          if (_ptSeenCombos.has(dedupKey)) break;
          _ptSeenCombos.add(dedupKey);
          ptResults.push(evt);
          if (evt.overall_score > ptBestScore) {
            ptBestScore = evt.overall_score;
            ptBestConfig = { ...evt.config, model_id: evt.model_id, model_name: evt.model_name };
          }
          // Update progress count and ETA
          document.getElementById('ptProgressCount').textContent = `${ptResults.length}/${ptTotalCombos}`;
          _ptUpdateETA();
          ptRenderResultsTable();
          ptUpdateBestCard();
          break;
        }

        case 'tune_complete':
          document.getElementById('ptProgressSection').classList.add('hidden');
          document.getElementById('ptApplyBestBtn').classList.remove('hidden');
          document.getElementById('ptReEvalBtn').classList.remove('hidden');
          if (msg.best_config) { ptBestConfig = msg.best_config; ptBestScore = msg.best_score || ptBestScore; }
          ptUpdateBestCard();
          ptRenderResultsTable();
          _activeParamTuneJobId = null;
          _activeParamTuneRunId = null;
          try { sessionStorage.removeItem('_ptRunId'); } catch {}
          _ptSeenCombos = new Set();
          _ptClearETA();
          _ptResetStartBtn();
          showToast('Tuning complete!', 'success');
          break;

        case 'job_completed':
          // Fallback: if tune_complete didn't fire, handle via generic job completion
          if (_activeParamTuneJobId) {
            document.getElementById('ptProgressSection').classList.add('hidden');
            document.getElementById('ptApplyBestBtn').classList.remove('hidden');
            document.getElementById('ptReEvalBtn').classList.remove('hidden');
            ptRenderResultsTable();
            _activeParamTuneJobId = null;
            _activeParamTuneRunId = null;
            try { sessionStorage.removeItem('_ptRunId'); } catch {}
            _ptSeenCombos = new Set();
            _ptClearETA();
            _ptResetStartBtn();
            showToast('Tuning complete!', 'success');
          }
          break;

        case 'job_failed':
          document.getElementById('ptProgressSection').classList.add('hidden');
          _activeParamTuneJobId = null;
          _activeParamTuneRunId = null;
          try { sessionStorage.removeItem('_ptRunId'); } catch {}
          _ptSeenCombos = new Set();
          _ptClearETA();
          _ptResetStartBtn();
          showToast(msg.error || msg.error_msg || 'Tuning failed', 'error');
          break;

        case 'job_cancelled':
          document.getElementById('ptProgressSection').classList.add('hidden');
          _activeParamTuneJobId = null;
          _activeParamTuneRunId = null;
          try { sessionStorage.removeItem('_ptRunId'); } catch {}
          _ptSeenCombos = new Set();
          _ptClearETA();
          _ptResetStartBtn();
          showToast('Tuning cancelled. Partial results saved.', '');
          break;

        case 'eval_promoted':
          showToast('Best result promoted to eval history', 'success');
          teLoadHistory();
          break;
      }
    }

    // Collect unique config param keys from results for dynamic columns
    function _ptConfigKeys() {
      const keys = new Set();
      // Include keys from search space definition (ensures columns appear even if param was dropped)
      for (const k of _ptSearchSpaceKeys) keys.add(k);
      // Also include keys from actual results
      for (const r of ptResults) {
        for (const k of Object.keys(r.config || {})) keys.add(k);
      }
      // Stable order: common params first, then alphabetical remainder
      const priority = ['temperature','top_p','top_k','tool_choice','max_tokens','frequency_penalty','presence_penalty','reasoning_effort','seed'];
      const ordered = priority.filter(k => keys.has(k));
      for (const k of [...keys].sort()) {
        if (!ordered.includes(k)) ordered.push(k);
      }
      return ordered;
    }

    function _ptParamHeader(key) {
      const map = { temperature: 'Temp', top_p: 'Top P', top_k: 'Top K', tool_choice: 'Tool Choice',
        max_tokens: 'Max Tok', frequency_penalty: 'Freq Pen', presence_penalty: 'Pres Pen',
        reasoning_effort: 'Reasoning', seed: 'Seed' };
      return map[key] || key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function ptRenderResultsTable() {
      const head = document.getElementById('ptResultsHead');
      const body = document.getElementById('ptResultsBody');
      const cfgKeys = _ptConfigKeys();

      // Check if any results have adjustments data
      const hasAnyAdj = ptResults.some(r => Array.isArray(r.adjustments) && r.adjustments.length > 0);

      // Update adjustments summary banner
      _ptRenderAdjustmentsSummary(hasAnyAdj);

      // Build dynamic header
      const thStyle = 'px-4 py-2 section-label cursor-pointer';
      let headHtml = `<tr style="border-bottom:1px solid var(--border-subtle)">`;
      headHtml += `<th class="${thStyle} text-left" onclick="ptSortResults('rank')">#</th>`;
      headHtml += `<th class="${thStyle} text-left" onclick="ptSortResults('model_name')">Model</th>`;
      for (const k of cfgKeys) {
        const align = (k === 'tool_choice' || k === 'reasoning_effort') ? 'text-center' : 'text-right';
        headHtml += `<th class="${thStyle} ${align}" onclick="ptSortResults('cfg:${k}')">${_ptParamHeader(k)}</th>`;
      }
      headHtml += `<th class="${thStyle} text-right" onclick="ptSortResults('overall_score')">Score</th>`;
      headHtml += `<th class="${thStyle} text-right" onclick="ptSortResults('tool_accuracy')">Tool %</th>`;
      headHtml += `<th class="${thStyle} text-right" onclick="ptSortResults('param_accuracy')">Param %</th>`;
      headHtml += `<th class="${thStyle} text-right" onclick="ptSortResults('latency_avg_ms')">Latency</th>`;
      if (hasAnyAdj) {
        headHtml += `<th class="${thStyle} text-center" onclick="ptSortResults('_adj_count')">Adj</th>`;
      }
      headHtml += `</tr>`;
      head.innerHTML = headHtml;

      // Sort results — handle cfg: prefix for config param sorting
      const sorted = [...ptResults].sort((a, b) => {
        let va, vb;
        if (ptSortKey === '_adj_count') {
          va = (a.adjustments || []).length; vb = (b.adjustments || []).length;
        } else if (ptSortKey.startsWith('cfg:')) {
          const ck = ptSortKey.slice(4);
          va = (a.config || {})[ck]; vb = (b.config || {})[ck];
        } else {
          va = a[ptSortKey]; vb = b[ptSortKey];
        }
        if (va == null && vb == null) return 0;
        if (va == null) return 1;
        if (vb == null) return -1;
        if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
        if (va < vb) return ptSortAsc ? -1 : 1;
        if (va > vb) return ptSortAsc ? 1 : -1;
        return 0;
      });

      body.innerHTML = sorted.map((r, i) => {
        const cfg = r.config || {};
        const isBest = ptBestConfig && r.overall_score === ptBestScore &&
          r.model_id === ptBestConfig.model_id && JSON.stringify(cfg) === JSON.stringify(_ptBestCfgOnly());
        const rowStyle = isBest ? 'border:1px solid rgba(234,179,8,0.3);background:rgba(234,179,8,0.03);' : '';
        const boldCls = isBest ? 'font-bold' : '';
        const scoreColor = _ptScoreColor((r.overall_score || 0) * 100);
        const hasCases = Array.isArray(r.case_results) && r.case_results.length > 0;
        const clickAttr = hasCases ? `onclick="ptShowDrilldown(${r.combo_index})" style="${rowStyle}cursor:pointer;" title="Click to view test case details"` : `style="${rowStyle}"`;

        let rowHtml = `<tr class="${hasCases ? 'hover:bg-white/[0.02] transition-colors' : ''}" ${clickAttr}>`;
        rowHtml += `<td class="px-4 py-2 text-xs font-mono text-zinc-600">${i + 1}</td>`;
        rowHtml += `<td class="px-4 py-2 text-xs font-body text-zinc-300 ${boldCls}">${_teEsc(r.model_name || r.model_id || '')}</td>`;
        for (const k of cfgKeys) {
          const align = (k === 'tool_choice' || k === 'reasoning_effort') ? 'text-center' : 'text-right';
          rowHtml += `<td class="px-4 py-2 ${align} text-xs font-mono text-zinc-400">${cfg[k] ?? '-'}</td>`;
        }
        rowHtml += `<td class="px-4 py-2 text-right text-xs font-mono ${boldCls}" style="color:${scoreColor}">${((r.overall_score || 0) * 100).toFixed(1)}%</td>`;
        rowHtml += `<td class="px-4 py-2 text-right text-xs font-mono text-zinc-400">${(r.tool_accuracy || 0).toFixed(1)}%</td>`;
        rowHtml += `<td class="px-4 py-2 text-right text-xs font-mono text-zinc-400">${(r.param_accuracy || 0).toFixed(1)}%</td>`;
        rowHtml += `<td class="px-4 py-2 text-right text-xs font-mono text-zinc-500">${r.latency_avg_ms ? r.latency_avg_ms + 'ms' : '-'}</td>`;
        if (hasAnyAdj) {
          rowHtml += _ptRenderAdjCell(r.adjustments);
        }
        rowHtml += `</tr>`;
        return rowHtml;
      }).join('');
    }

    // Render a single adjustments cell for a result row
    function _ptRenderAdjCell(adjustments) {
      if (!Array.isArray(adjustments) || adjustments.length === 0) {
        return `<td class="px-4 py-2 text-center text-xs font-mono text-zinc-700">-</td>`;
      }
      const count = adjustments.length;
      // Build tooltip text: one line per adjustment
      const lines = adjustments.map(a => {
        const param = a.param || '?';
        if (a.adjusted === null || a.adjusted === undefined) {
          return `${param}: dropped -- ${a.reason || 'unsupported'}`;
        }
        return `${param}: ${a.original} -> ${a.adjusted} -- ${a.reason || 'clamped'}`;
      });
      const tip = _teEsc(lines.join('\n'));
      // Dropped = adjusted is null; clamped = adjusted is a value
      const dropped = adjustments.filter(a => a.adjusted === null || a.adjusted === undefined).length;
      const clamped = count - dropped;
      // Badge color: red-ish for drops, yellow for clamps, mixed shows count
      let badgeBg, badgeColor;
      if (dropped > 0 && clamped === 0) {
        badgeBg = 'rgba(255,59,92,0.1)'; badgeColor = '#FB7185';
      } else if (clamped > 0 && dropped === 0) {
        badgeBg = 'rgba(234,179,8,0.1)'; badgeColor = '#EAB308';
      } else {
        badgeBg = 'rgba(251,146,60,0.1)'; badgeColor = '#FB923C';
      }
      return `<td class="px-4 py-2 text-center">
        <span class="inline-flex items-center gap-1 px-2 py-0.5 rounded-sm text-[10px] font-display tracking-wider uppercase cursor-help"
          style="background:${badgeBg};color:${badgeColor}" title="${tip}">
          ${count}${dropped > 0 ? (dropped === count ? ' dropped' : ' adj') : ' clamped'}
        </span>
      </td>`;
    }

    // Render the adjustments summary banner above the results table
    function _ptRenderAdjustmentsSummary(hasAnyAdj) {
      const banner = document.getElementById('ptAdjustmentsSummary');
      if (!banner) return;
      if (!hasAnyAdj) {
        banner.classList.add('hidden');
        banner.innerHTML = '';
        return;
      }
      // Count totals across all results
      let totalAdj = 0, totalDropped = 0, totalClamped = 0;
      const runsWithAdj = new Set();
      for (const r of ptResults) {
        if (!Array.isArray(r.adjustments) || r.adjustments.length === 0) continue;
        runsWithAdj.add(r.combo_index + ':' + r.model_id);
        for (const a of r.adjustments) {
          totalAdj++;
          if (a.adjusted === null || a.adjusted === undefined) totalDropped++;
          else totalClamped++;
        }
      }
      const parts = [];
      parts.push(`${totalAdj} param${totalAdj !== 1 ? 's' : ''} adjusted across ${runsWithAdj.size} run${runsWithAdj.size !== 1 ? 's' : ''}`);
      if (totalDropped > 0) parts.push(`${totalDropped} dropped`);
      if (totalClamped > 0) parts.push(`${totalClamped} clamped`);
      banner.innerHTML = parts.join(' &middot; ');
      banner.classList.remove('hidden');
    }

    // Extract config-only keys from ptBestConfig (excluding model_name, model_id)
    function _ptBestCfgOnly() {
      if (!ptBestConfig) return {};
      const { model_name, model_id, ...cfg } = ptBestConfig;
      return cfg;
    }

    function ptUpdateBestCard() {
      if (!ptBestConfig) return;
      const card = document.getElementById('ptBestCard');
      card.classList.remove('hidden');
      const skip = new Set(['model_name', 'model_id']);
      const parts = [];
      for (const [k, v] of Object.entries(ptBestConfig)) {
        if (skip.has(k) || v === undefined || v === null) continue;
        parts.push(k + '=' + v);
      }
      document.getElementById('ptBestConfigText').textContent = parts.join(', ');
      document.getElementById('ptBestScoreText').textContent =
        (ptBestConfig.model_name ? ptBestConfig.model_name + ' -- ' : '') +
        ((ptBestScore * 100).toFixed(1)) + '% overall score';
    }

    function ptSortResults(key) {
      if (ptSortKey === key) ptSortAsc = !ptSortAsc;
      else { ptSortKey = key; ptSortAsc = key === 'model_name' || key === 'cfg:tool_choice'; }
      ptRenderResultsTable();
    }

    async function ptCancelTune() {
      if (_activeParamTuneJobId) {
        await notifCancelJob(_activeParamTuneJobId);
        // If cancel resolved a ghost job, refresh the view to show actual state
        const job = _jobStore[_activeParamTuneJobId];
        if (job && !ACTIVE_STATUSES.has(job.status)) {
          // Job is now terminal — clear active state so UI reflects completion
          _activeParamTuneJobId = null;
        }
      } else {
        // Legacy fallback
        try {
          await apiFetch('/api/tool-eval/param-tune/cancel', { method: 'POST' });
          showToast('Cancellation requested', '');
        } catch {
          showToast('Run already stopped', '');
        }
      }
    }

    function ptApplyBest() {
      if (!ptBestConfig) return;
      const appliedParts = [];
      // Apply best config values to the main tool eval temperature
      if (ptBestConfig.temperature !== undefined) {
        const teTemp = document.getElementById('teTemperature');
        if (teTemp) { teTemp.value = ptBestConfig.temperature; appliedParts.push('temp=' + ptBestConfig.temperature); }
      }
      if (ptBestConfig.tool_choice) {
        const teTc = document.getElementById('teToolChoice');
        if (teTc) { teTc.value = ptBestConfig.tool_choice; appliedParts.push('tool_choice=' + ptBestConfig.tool_choice); }
      }
      // Apply provider_params (tier2 + passthrough) from best config
      const skipKeys = new Set(['temperature', 'tool_choice', 'model_name', 'model_id']);
      const providers = ppGetSelectedProviders('tooleval');
      if (providers.length) {
        for (const [k, v] of Object.entries(ptBestConfig)) {
          if (skipKeys.has(k) || v === undefined || v === null) continue;
          // Apply to all selected providers (tuner ran on these)
          for (const prov of providers) {
            ppSetValue('tooleval', prov.registryKey, k, v);
          }
          appliedParts.push(k + '=' + v);
        }
        ppRenderPanel('tooleval');
      }
      _ptConfigApplied = true; // Prevent _teApplyDefaults from overwriting
      showToast('Applied: ' + (appliedParts.length ? appliedParts.join(', ') : 'best config'), 'success');
    }

    // --- Bridge B: Apply best param tune config and re-run eval ---
    async function ptApplyAndReEval() {
      if (!ptBestConfig) return;
      const configDesc = Object.entries(ptBestConfig)
        .filter(([k]) => !['model_name','model_id'].includes(k))
        .map(([k,v]) => `${k}=${v}`).join(', ');
      showModal('Apply & Re-Eval',
        `Re-run eval with best config?\n${configDesc}`,
        async () => {
          const skipKeys = new Set(['model_name', 'model_id']);
          const provParams = {};
          for (const [k, v] of Object.entries(ptBestConfig)) {
            if (skipKeys.has(k) || v === undefined || v === null) continue;
            if (k === 'temperature') { _sharedContext.temperature = v; continue; }
            if (k === 'tool_choice') { _sharedContext.tool_choice = v; continue; }
            provParams[k] = v;
          }
          _sharedContext.provider_params = provParams;
          _sharedContext.last_updated_by = 'param_tuner';
          _scSave();
          showToolEvalView('run');
          ptApplyBest();
          await new Promise(r => setTimeout(r, 300));
          teStartEval();
        },
        { confirmLabel: 'Start Eval' }
      );
    }

    function ptExportCSV() {
      if (!ptResults.length) { showToast('No results to export', 'error'); return; }
      const cfgKeys = _ptConfigKeys();
      const hasAdj = ptResults.some(r => Array.isArray(r.adjustments) && r.adjustments.length > 0);
      const headers = ['model_id', 'model_name', ...cfgKeys, 'overall_score', 'tool_accuracy', 'param_accuracy', 'latency_avg_ms'];
      if (hasAdj) headers.push('adjustments');
      const esc = v => { const s = String(v ?? ''); return s.includes(',') || s.includes('"') ? '"' + s.replace(/"/g, '""') + '"' : s; };
      const rows = ptResults.map(r => {
        const c = r.config || {};
        const vals = [r.model_id, r.model_name, ...cfgKeys.map(k => c[k] ?? ''),
          ((r.overall_score || 0) * 100).toFixed(1), (r.tool_accuracy || 0).toFixed(1),
          (r.param_accuracy || 0).toFixed(1), r.latency_avg_ms || ''];
        if (hasAdj) {
          const adj = r.adjustments || [];
          const adjStr = adj.map(a => {
            if (a.adjusted === null || a.adjusted === undefined) return `${a.param} dropped`;
            return `${a.param}: ${a.original}->${a.adjusted}`;
          }).join('; ');
          vals.push(adjStr);
        }
        return vals.map(esc).join(',');
      });
      const csv = [headers.map(esc).join(','), ...rows].join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'param-tune-results.csv'; a.click();
      URL.revokeObjectURL(url);
    }

    // --- PT History ---
    async function ptLoadHistory() {
      try {
        const res = await apiFetch('/api/tool-eval/param-tune/history');
        if (!res.ok) return;
        const data = await res.json();
        ptHistory = data.runs || [];
        ptRenderHistory();
      } catch {}
    }

    function ptRenderHistory() {
      const body = document.getElementById('ptHistoryBody');
      if (!ptHistory.length) {
        body.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No tuning runs yet.</td></tr>';
        return;
      }
      body.innerHTML = ptHistory.map(r => {
        const models = r.models_json ? (typeof r.models_json === 'string' ? JSON.parse(r.models_json) : r.models_json) : [];
        const modelStr = models.length <= 2 ? models.join(', ') : models.length + ' models';
        const scoreColor = r.best_score ? _ptScoreColor(r.best_score * 100) : '#85858F';
        const statusColor = r.status === 'completed' ? 'var(--lime)' : r.status === 'cancelled' ? '#EAB308' : r.status === 'interrupted' ? '#FB923C' : r.status === 'error' ? 'var(--coral)' : r.status === 'running' ? '#38BDF8' : '#85858F';
        const isRunning = r.status === 'running';
        const isFinished = ['completed','cancelled','interrupted','error'].includes(r.status);
        // Build action buttons based on status
        let actions = `<button onclick="ptViewHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 mr-2">View</button>`;
        if (isRunning) {
          actions += `<button onclick="ptStopHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase mr-2" style="color:#EAB308;">Stop</button>`;
        }
        if (isFinished) {
          actions += `<button onclick="ptRerunHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase mr-2" style="color:#22D3EE;">Re-run</button>`;
        }
        if (!isRunning) {
          actions += `<button onclick="ptDeleteHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-700 hover:text-red-400">Delete</button>`;
        }
        return `<tr>
          <td class="px-5 py-3 text-xs text-zinc-500 font-body">${_teTimeAgo(r.timestamp)}</td>
          <td class="px-5 py-3 text-sm font-body text-zinc-300">${_teEsc(r.suite_name || '')}</td>
          <td class="px-5 py-3 text-xs font-mono text-zinc-500">${_teEsc(modelStr)}</td>
          <td class="px-5 py-3 text-right text-xs font-mono text-zinc-400">${r.completed_combos || 0}/${r.total_combos || 0}</td>
          <td class="px-5 py-3 text-right text-sm font-mono font-bold" style="color:${scoreColor}">${r.best_score ? ((r.best_score * 100).toFixed(1) + '%') : '-'}</td>
          <td class="px-5 py-3 text-center text-[10px] font-display tracking-wider uppercase" style="color:${statusColor}">${r.status || ''}</td>
          <td class="px-5 py-3 text-right">${actions}</td>
        </tr>`;
      }).join('');
    }

    async function ptViewHistoryRun(tuneId) {
      try {
        const res = await apiFetch(`/api/tool-eval/param-tune/history/${tuneId}`);
        if (!res.ok) { showToast('Failed to load run', 'error'); return; }
        const run = await res.json();
        ptResults = run.results_json ? (typeof run.results_json === 'string' ? JSON.parse(run.results_json) : run.results_json) : [];
        ptBestConfig = typeof run.best_config_json === 'string' ? JSON.parse(run.best_config_json) : run.best_config_json;
        ptBestScore = run.best_score || 0;
        ptTotalCombos = run.total_combos || 0;
        // Restore search space keys for column rendering
        try {
          const ss = run.search_space_json ? (typeof run.search_space_json === 'string' ? JSON.parse(run.search_space_json) : run.search_space_json) : {};
          // search_space_json might be per_model_search_spaces (keyed by model id) or a flat space
          const firstVal = Object.values(ss)[0];
          if (firstVal && typeof firstVal === 'object' && !Array.isArray(firstVal) && firstVal.min !== undefined) {
            _ptSearchSpaceKeys = Object.keys(ss); // flat search space
          } else if (firstVal && typeof firstVal === 'object') {
            // per_model_search_spaces — union all keys
            const allKeys = new Set();
            for (const modelSS of Object.values(ss)) {
              if (typeof modelSS === 'object') for (const k of Object.keys(modelSS)) allKeys.add(k);
            }
            _ptSearchSpaceKeys = [...allKeys];
          } else {
            _ptSearchSpaceKeys = Object.keys(ss);
          }
        } catch { _ptSearchSpaceKeys = []; }

        // Check if this tune is still running — reconnect to live progress
        const isRunning = run.status === 'running';
        if (isRunning) {
          // Find the matching job in _jobStore (or use _activeParamTuneJobId)
          let reconnectedJobId = _activeParamTuneJobId;
          if (!reconnectedJobId) {
            // Scan _jobStore for a running param_tune job
            const ptJobs = Object.values(_jobStore).filter(
              j => j.job_type === 'param_tune' && (j.status === 'running' || j.status === 'pending' || j.status === 'queued')
            );
            if (ptJobs.length === 1) reconnectedJobId = ptJobs[0].id;
          }
          if (reconnectedJobId) _activeParamTuneJobId = reconnectedJobId;
        }

        showToolEvalView('pt-run');

        if (isRunning) {
          // --- RECONNECTION MODE ---
          // Always enter reconnection mode when DB says running,
          // even if we don't have the jobId yet (WS sync will arrive shortly)
          _ptSeenCombos = new Set();
          for (const r of ptResults) {
            _ptSeenCombos.add(`${r.model_id || ''}:${r.combo_index ?? ''}`);
          }
          // Set the tune ID for WS event bridge
          _activeParamTuneRunId = tuneId;
          try { sessionStorage.setItem('_ptRunId', tuneId); } catch {}

          // Show progress section with backfilled state
          document.getElementById('ptProgressSection').classList.remove('hidden');
          document.getElementById('ptResultsSection').classList.remove('hidden');
          document.getElementById('ptApplyBestBtn').classList.add('hidden');
          document.getElementById('ptReEvalBtn').classList.add('hidden');
          const pct = ptTotalCombos > 0 ? Math.round((ptResults.length / ptTotalCombos) * 100) : 0;
          document.getElementById('ptProgressBar').style.width = pct + '%';
          document.getElementById('ptProgressLabel').textContent = `Reconnected — tuning in progress`;
          document.getElementById('ptProgressCount').textContent = `${ptResults.length}/${ptTotalCombos}`;

          // Start ETA using the real job start time (from DB) for accurate rate calc
          _ptTuneStartTime = _ptJobStartedAt ? new Date(_ptJobStartedAt).getTime() : Date.now();
          _ptEtaBaseCount = 0;  // measure from actual start, not reconnection point
          const etaEl = document.getElementById('ptETA');
          if (etaEl) etaEl.textContent = ptResults.length > 0 ? 'Estimating...' : '';

          // Remove any stale banners
          const ptInterruptedBanner = document.getElementById('ptInterruptedBanner');
          if (ptInterruptedBanner) ptInterruptedBanner.remove();

          showToast('Reconnected to running tune', 'success');
        } else {
          // --- NORMAL HISTORY VIEW ---
          document.getElementById('ptProgressSection').classList.add('hidden');
          document.getElementById('ptResultsSection').classList.remove('hidden');
          document.getElementById('ptApplyBestBtn').classList.remove('hidden');
          document.getElementById('ptReEvalBtn').classList.remove('hidden');
          _activeParamTuneRunId = null;
          _ptSeenCombos = new Set();

          // Show interrupted banner if applicable
          const ptInterruptedBanner = document.getElementById('ptInterruptedBanner');
          if (ptInterruptedBanner) ptInterruptedBanner.remove();
          if (run.status === 'interrupted') {
            const banner = document.createElement('div');
            banner.id = 'ptInterruptedBanner';
            banner.className = 'mb-4 px-4 py-3 rounded-md text-sm font-body';
            banner.style.cssText = 'background:rgba(251,146,60,0.08);border:1px solid rgba(251,146,60,0.25);color:#FB923C;';
            if (ptResults.length > 0) {
              const total = run.total_combos || '?';
              banner.textContent = `This run was interrupted. Showing ${ptResults.length} of ${total} partial results.`;
            } else {
              banner.textContent = 'This run was interrupted before any results were saved.';
            }
            document.getElementById('ptResultsSection').insertAdjacentElement('beforebegin', banner);
          }
        }

        ptUpdateBestCard();
        ptRenderResultsTable();
      } catch (e) {
        showToast('Failed to load run', 'error');
      }
    }

    function ptDeleteHistoryRun(tuneId) {
      showModal('Delete Tuning Run', 'Delete this tuning run? This cannot be undone.', async () => {
        try {
          const res = await apiFetch(`/api/tool-eval/param-tune/history/${tuneId}`, { method: 'DELETE' });
          if (!res.ok) { showToast('Failed to delete', 'error'); return; }
          showToast('Tuning run deleted', 'success');
          await ptLoadHistory();
        } catch { showToast('Failed to delete', 'error'); }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    async function ptStopHistoryRun(tuneId) {
      // Find the job_id for this running tune — check _activeParamTuneJobId first,
      // then scan _jobStore for a running param_tune job
      let jobId = _activeParamTuneJobId;
      if (!jobId) {
        const paramTuneJobs = Object.values(_jobStore).filter(
          j => j.job_type === 'param_tune' && (j.status === 'running' || j.status === 'pending' || j.status === 'queued')
        );
        if (paramTuneJobs.length === 1) jobId = paramTuneJobs[0].id;
      }
      if (jobId) {
        await notifCancelJob(jobId);
        // Always refresh history to show actual status (handles ghost jobs too)
        setTimeout(() => ptLoadHistory(), 1500);
      } else {
        // No job in _jobStore — ghost job scenario. Try legacy cancel, then always refresh.
        try {
          await apiFetch('/api/tool-eval/param-tune/cancel', { method: 'POST' });
          showToast('Stop requested', '');
        } catch {
          // Legacy cancel failed too — the run is likely already terminal
          showToast('Run already stopped', '');
        }
        setTimeout(() => ptLoadHistory(), 1500);
      }
    }

    async function ptRerunHistoryRun(tuneId) {
      try {
        const res = await apiFetch(`/api/tool-eval/param-tune/history/${tuneId}`);
        if (!res.ok) { showToast('Failed to load run for re-run', 'error'); return; }
        const run = await res.json();
        const models = run.models_json ? (typeof run.models_json === 'string' ? JSON.parse(run.models_json) : run.models_json) : [];
        const searchSpace = run.search_space_json ? (typeof run.search_space_json === 'string' ? JSON.parse(run.search_space_json) : run.search_space_json) : null;
        const suiteId = run.suite_id;

        if (!suiteId || models.length === 0) {
          showToast('Incomplete run data — cannot re-run', 'error');
          return;
        }

        // Re-submit directly to the API with the same parameters
        const body = { suite_id: suiteId, models: models, search_space: searchSpace };

        // Reset UI for new run
        ptResults = [];
        ptBestConfig = null;
        ptBestScore = 0;
        _ptSearchSpaceKeys = searchSpace ? Object.keys(searchSpace) : [];
        showToolEvalView('pt-run');
        document.getElementById('ptProgressSection').classList.remove('hidden');
        document.getElementById('ptBestCard').classList.add('hidden');
        document.getElementById('ptResultsSection').classList.remove('hidden');
        document.getElementById('ptApplyBestBtn').classList.add('hidden');
        document.getElementById('ptReEvalBtn').classList.add('hidden');
        document.getElementById('ptResultsHead').innerHTML = '';
        document.getElementById('ptResultsBody').innerHTML = '';
        const _adjBanner = document.getElementById('ptAdjustmentsSummary');
        if (_adjBanner) { _adjBanner.classList.add('hidden'); _adjBanner.innerHTML = ''; }
        document.getElementById('ptProgressBar').style.width = '0%';
        document.getElementById('ptProgressLabel').textContent = 'Re-running...';
        document.getElementById('ptProgressCount').textContent = '0/0';
        _ptClearETA();

        const submitRes = await apiFetch('/api/tool-eval/param-tune', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (submitRes.status === 409) { showToast('A benchmark or eval is already running', 'error'); return; }
        if (!submitRes.ok) {
          const err = await submitRes.json().catch(() => ({}));
          showToast(err.error || `Re-run failed (${submitRes.status})`, 'error');
          return;
        }

        const data = await submitRes.json();
        _activeParamTuneJobId = data.job_id;
        document.getElementById('ptProgressLabel').textContent = 'Re-run queued...';
        showToast('Re-run submitted', 'success');
      } catch (e) {
        showToast('Re-run failed: ' + (e.message || 'unknown'), 'error');
      }
    }

    function _ptResetStartBtn() {
      const btn = document.getElementById('ptStartBtn');
      if (btn) {
        btn.disabled = false;
        btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Start Tuning';
      }
    }

    function _ptScoreColor(pct) {
      if (pct >= 90) return 'var(--lime)';
      if (pct >= 70) return '#22D3EE';
      if (pct >= 50) return '#EAB308';
      return 'var(--coral)';
    }

    // --- Task #21: Drill-down modal for per-combo test results ---
    function ptShowDrilldown(comboIndex) {
      const result = ptResults.find(r => r.combo_index === comboIndex);
      if (!result || !Array.isArray(result.case_results) || result.case_results.length === 0) {
        showToast('No case details available for this combo', 'error');
        return;
      }
      const cases = result.case_results;
      const cfg = result.config || {};
      const esc = s => String(s ?? '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');

      // Config summary line
      const cfgParts = Object.entries(cfg).map(([k, v]) => `<span class="text-zinc-500">${esc(k)}=</span><span class="text-zinc-300">${esc(v)}</span>`);
      const cfgLine = cfgParts.join(' &middot; ');

      // Build case results table
      let tableHtml = `<table class="w-full text-xs font-mono" style="border-collapse:collapse;">`;
      tableHtml += `<thead><tr style="border-bottom:1px solid var(--border-subtle);">`;
      tableHtml += `<th class="text-left px-3 py-2 text-zinc-500 font-display text-[10px] uppercase tracking-wider">Case</th>`;
      tableHtml += `<th class="text-left px-3 py-2 text-zinc-500 font-display text-[10px] uppercase tracking-wider">Expected Tool</th>`;
      tableHtml += `<th class="text-left px-3 py-2 text-zinc-500 font-display text-[10px] uppercase tracking-wider">Actual Tool</th>`;
      tableHtml += `<th class="text-right px-3 py-2 text-zinc-500 font-display text-[10px] uppercase tracking-wider">Tool</th>`;
      tableHtml += `<th class="text-right px-3 py-2 text-zinc-500 font-display text-[10px] uppercase tracking-wider">Params</th>`;
      tableHtml += `<th class="text-right px-3 py-2 text-zinc-500 font-display text-[10px] uppercase tracking-wider">Overall</th>`;
      tableHtml += `<th class="text-right px-3 py-2 text-zinc-500 font-display text-[10px] uppercase tracking-wider">Latency</th>`;
      tableHtml += `</tr></thead><tbody>`;

      for (const c of cases) {
        const toolMatch = c.tool_selection_score === 1.0;
        const toolColor = toolMatch ? 'var(--lime)' : 'var(--coral)';
        const overallPct = (c.overall_score || 0) * 100;
        const overallColor = _ptScoreColor(overallPct);
        const paramPct = c.param_accuracy != null ? (c.param_accuracy * 100).toFixed(0) + '%' : '-';
        const paramColor = c.param_accuracy != null ? _ptScoreColor(c.param_accuracy * 100) : '#71717A';

        // Error row styling
        const rowBg = !c.success ? 'background:rgba(255,59,92,0.04);' : '';

        tableHtml += `<tr style="border-bottom:1px solid rgba(255,255,255,0.03);${rowBg}">`;
        tableHtml += `<td class="px-3 py-1.5 text-zinc-300 font-body" style="max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;" title="${esc(c.prompt || c.test_case_id || '')}">${esc(c.test_case_id || '?')}</td>`;
        tableHtml += `<td class="px-3 py-1.5 text-zinc-400">${esc(c.expected_tool || '-')}</td>`;
        tableHtml += `<td class="px-3 py-1.5" style="color:${toolColor}">${esc(c.actual_tool || '-')}</td>`;
        tableHtml += `<td class="px-3 py-1.5 text-right" style="color:${toolColor}">${toolMatch ? '1.0' : '0.0'}</td>`;
        tableHtml += `<td class="px-3 py-1.5 text-right" style="color:${paramColor}">${paramPct}</td>`;
        tableHtml += `<td class="px-3 py-1.5 text-right font-semibold" style="color:${overallColor}">${overallPct.toFixed(0)}%</td>`;
        tableHtml += `<td class="px-3 py-1.5 text-right text-zinc-500">${c.latency_ms ? c.latency_ms + 'ms' : '-'}</td>`;
        tableHtml += `</tr>`;

        // Expandable param comparison row (show if params differ)
        if (c.expected_params && c.actual_params && c.param_accuracy !== null && c.param_accuracy < 1.0) {
          tableHtml += `<tr style="border-bottom:1px solid rgba(255,255,255,0.02);">`;
          tableHtml += `<td colspan="7" class="px-3 py-1 text-[10px]">`;
          tableHtml += `<div class="flex gap-6 ml-4">`;
          tableHtml += `<div><span class="text-zinc-600">Expected:</span> <span class="text-zinc-500">${esc(JSON.stringify(c.expected_params))}</span></div>`;
          tableHtml += `<div><span class="text-zinc-600">Actual:</span> <span class="text-amber-500/70">${esc(JSON.stringify(c.actual_params))}</span></div>`;
          tableHtml += `</div></td></tr>`;
        }

        // Error message row
        if (!c.success && c.error) {
          tableHtml += `<tr style="border-bottom:1px solid rgba(255,255,255,0.02);">`;
          tableHtml += `<td colspan="7" class="px-3 py-1 text-[10px] text-red-400/70 ml-4" style="padding-left:28px;">${esc(c.error)}</td>`;
          tableHtml += `</tr>`;
        }
      }
      tableHtml += `</tbody></table>`;

      // Summary line
      const passed = cases.filter(c => c.success && c.overall_score === 1.0).length;
      const failed = cases.filter(c => !c.success).length;
      const summaryColor = passed === cases.length ? 'var(--lime)' : passed > 0 ? '#EAB308' : 'var(--coral)';

      // Build modal
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `<div class="modal-box" style="max-width:800px;min-width:600px;">
        <div class="flex items-center justify-between mb-3">
          <div class="modal-title" style="margin:0;">Case Results</div>
          <button class="text-zinc-500 hover:text-zinc-300 transition-colors" data-action="close" style="font-size:18px;line-height:1;padding:4px;">&times;</button>
        </div>
        <div class="text-xs font-body text-zinc-400 mb-2">${esc(result.model_name || result.model_id)} &mdash; Combo #${comboIndex + 1}</div>
        <div class="text-[10px] font-mono mb-4" style="color:#71717A;">${cfgLine}</div>
        <div class="flex items-center gap-4 mb-4 text-xs font-body">
          <span style="color:${summaryColor}">${passed}/${cases.length} passed</span>
          ${failed ? `<span class="text-red-400">${failed} errors</span>` : ''}
          <span class="text-zinc-500">Score: <span style="color:${_ptScoreColor((result.overall_score || 0) * 100)}">${((result.overall_score || 0) * 100).toFixed(1)}%</span></span>
        </div>
        <div style="max-height:400px;overflow-y:auto;scrollbar-width:thin;">
          ${tableHtml}
        </div>
        <div class="flex justify-end mt-4">
          <button class="modal-btn modal-btn-cancel" data-action="close">Close</button>
        </div>
      </div>`;

      overlay.querySelectorAll('[data-action="close"]').forEach(btn => { btn.onclick = () => _closeModal(overlay); });
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
    }

    // -------------------------------------------------------------------
    // Prompt Tuner (prt prefix)
    // -------------------------------------------------------------------
    let prtSelectedModels = new Set();
    let prtMode = 'quick';
    let prtPrompts = [];           // all prompts from WS
    let prtBestPrompt = '';
    let prtBestScoreVal = 0;
    let prtHistory = [];
    let prtRunning = false;
    let _activePromptTuneJobId = null;
    let _activePromptTuneRunId = null;
    let prtScoreChart = null;
    let prtGenScores = [];         // best score per generation for chart
    let prtTotalPrompts = 0;
    let prtCompletedPrompts = 0;
    let prtCurrentGeneration = 0;
    let prtTotalGenerations = 1;

    function prtSetMode(mode) {
      prtMode = mode;
      const quickBtn = document.getElementById('prtModeQuick');
      const evoBtn = document.getElementById('prtModeEvo');
      const evoFields = document.getElementById('prtEvoFields');
      const evoExtra = document.getElementById('prtEvoExtra');
      if (mode === 'quick') {
        quickBtn.style.borderColor = 'var(--lime)';
        evoBtn.style.borderColor = 'var(--border-subtle)';
        evoFields.classList.add('hidden');
        evoExtra.classList.add('hidden');
      } else {
        quickBtn.style.borderColor = 'var(--border-subtle)';
        evoBtn.style.borderColor = 'var(--lime)';
        evoFields.classList.remove('hidden');
        evoExtra.classList.remove('hidden');
      }
      prtUpdateEstimate();
    }

    async function prtLoadSuiteSelector() {
      const sel = document.getElementById('prtSuiteSelect');
      const current = sel.value;
      try {
        const res = await apiFetch('/api/tool-suites');
        if (!res.ok) return;
        const data = await res.json();
        const suites = data.suites || [];
        sel.innerHTML = '<option value="">-- Select a tool eval suite --</option>' +
          suites.map(s => `<option value="${s.id}" ${s.id === current ? 'selected' : ''}>${_teEsc(s.name)} (${s.test_case_count || 0} cases)</option>`).join('');
      } catch (e) {}
      // Pre-select from shared context if no current value
      if (!current && _sharedContext.suite_id) {
        sel.value = _sharedContext.suite_id;
      }
      prtUpdateEstimate();
    }

    function prtRenderModelGrid() {
      const grid = document.getElementById('prtModelGrid');
      if (!config || !config.providers) { grid.innerHTML = '<div class="text-xs text-zinc-600 font-body">No models loaded</div>'; return; }
      prtSelectedModels.clear();
      // Pre-select from shared context if available
      const scModels = _scGetModels();
      let html = '';
      for (const [provName, provData] of Object.entries(config.providers)) {
        const pk = provData.provider_key || provName;
        const models = getProviderModels(provData);
        for (const m of models) {
          const ck = pk + '::' + m.model_id;
          const preSelect = scModels.size > 0 && scModels.has(ck);
          if (preSelect) prtSelectedModels.add(ck);
          const checked = prtSelectedModels.has(ck);
          const color = getColor(provName);
          // Escape compound key for inline handler (replace single quotes)
          const ckEsc = ck.replace(/'/g, "\\'");
          html += `<label class="flex items-center gap-2 py-1 px-2 rounded cursor-pointer hover:bg-white/5 transition-colors">
            <input type="checkbox" ${checked ? 'checked' : ''} onchange="prtToggleModel('${ckEsc}', this.checked)" style="accent-color:${color.text}">
            <span class="text-xs font-mono text-zinc-400">${m.display_name || m.model_id}</span>
            <span class="text-[9px] font-mono text-zinc-700">${provName}</span>
          </label>`;
        }
      }
      grid.innerHTML = html || '<div class="text-xs text-zinc-600 font-body">No models available</div>';
    }

    function prtToggleModel(compoundKey, checked) {
      if (checked) prtSelectedModels.add(compoundKey);
      else prtSelectedModels.delete(compoundKey);
      _scSetModels(prtSelectedModels);
      prtUpdateEstimate();
    }

    function prtPopulateMetaModel() {
      const sel = document.getElementById('prtMetaModel');
      const current = sel.value;
      if (!config || !config.providers) return;
      let html = '';
      for (const [provName, provData] of Object.entries(config.providers)) {
        const pk = provData.provider_key || provName;
        const models = getProviderModels(provData);
        for (const m of models) {
          const ck = pk + '::' + m.model_id;
          html += `<option value="${ck}" ${ck === current ? 'selected' : ''}>${m.display_name || m.model_id} (${provName})</option>`;
        }
      }
      sel.innerHTML = html;
    }

    function prtUpdateEstimate() {
      const popSize = parseInt(document.getElementById('prtPopSize').value) || 5;
      const gens = prtMode === 'evolutionary' ? (parseInt(document.getElementById('prtGenerations').value) || 3) : 1;
      const numModels = prtSelectedModels.size || 1;
      const suiteSelect = document.getElementById('prtSuiteSelect');
      // estimate test cases from suite name text
      let numCases = 5; // default guess
      const opt = suiteSelect.options[suiteSelect.selectedIndex];
      if (opt && opt.text) {
        const m = opt.text.match(/\((\d+) cases?\)/);
        if (m) numCases = parseInt(m[1]);
      }

      const totalPrompts = gens * popSize;
      const totalEvalCalls = totalPrompts * numCases * numModels;
      const totalCalls = totalPrompts + totalEvalCalls;

      const textEl = document.getElementById('prtEstimateText');
      const warnEl = document.getElementById('prtEstimateWarn');
      textEl.textContent = `${totalPrompts} prompts + ${totalEvalCalls} eval calls = ~${totalCalls} API calls`;
      if (totalCalls > 100) {
        warnEl.classList.remove('hidden');
      } else {
        warnEl.classList.add('hidden');
      }
    }

    async function prtStartTune() {
      const suiteId = document.getElementById('prtSuiteSelect').value;
      if (!suiteId) { showToast('Please select a tool eval suite', 'error'); return; }
      if (prtSelectedModels.size === 0) { showToast('Please select at least one target model', 'error'); return; }
      const metaModelRaw = document.getElementById('prtMetaModel').value;
      if (!metaModelRaw) { showToast('Please select a meta-model', 'error'); return; }
      const metaParsed = metaModelRaw.includes('::') ? _bmParseCompoundKey(metaModelRaw) : { provider_key: '', model_id: metaModelRaw };

      const popSize = parseInt(document.getElementById('prtPopSize').value) || 5;
      const temperature = parseFloat(document.getElementById('prtTemperature').value) || 0.0;
      const toolChoice = document.getElementById('prtToolChoice').value;
      const basePrompt = document.getElementById('prtBasePrompt').value.trim() || undefined;

      const cfg = { population_size: popSize, temperature, tool_choice: toolChoice };
      if (prtMode === 'evolutionary') {
        cfg.generations = parseInt(document.getElementById('prtGenerations').value) || 3;
        cfg.selection_ratio = parseFloat(document.getElementById('prtSelRatio').value) || 0.4;
      }

      // Parse compound keys into target_targets for precise provider matching
      const prtTargets = Array.from(prtSelectedModels).map(k => {
        const i = k.indexOf('::');
        if (i >= 0) return { provider_key: k.substring(0, i), model_id: k.substring(i + 2) };
        return { provider_key: '', model_id: k };
      });
      const body = {
        suite_id: suiteId,
        target_models: prtTargets.map(t => t.model_id),
        target_targets: prtTargets,
        meta_model: metaParsed.model_id,
        meta_provider_key: metaParsed.provider_key || undefined,
        mode: prtMode,
        config: cfg
      };
      if (basePrompt) body.base_prompt = basePrompt;
      // Write suite to shared context
      _scSetSuite(suiteId, document.getElementById('prtSuiteSelect').options[document.getElementById('prtSuiteSelect').selectedIndex]?.text || '');
      // Include experiment_id from shared context
      if (_sharedContext.experiment_id) body.experiment_id = _sharedContext.experiment_id;

      // Reset state
      prtPrompts = [];
      prtBestPrompt = '';
      prtBestScoreVal = 0;
      prtGenScores = [];
      prtTotalPrompts = 0;
      prtCompletedPrompts = 0;
      prtCurrentGeneration = 0;
      prtTotalGenerations = prtMode === 'evolutionary' ? (cfg.generations || 3) : 1;
      prtRunning = true;

      // Switch to run view
      showToolEvalView('prt-run');
      document.getElementById('prtProgressSection').classList.remove('hidden');
      document.getElementById('prtBestCard').classList.add('hidden');
      document.getElementById('prtPromptsSection').classList.remove('hidden');
      document.getElementById('prtPromptCards').innerHTML = '';
      document.getElementById('prtProgressBar').style.width = '0%';
      document.getElementById('prtProgressLabel').textContent = 'Initializing...';
      document.getElementById('prtProgressCount').textContent = '0/0';

      // Timeline (evo mode)
      if (prtMode === 'evolutionary') {
        document.getElementById('prtTimeline').classList.remove('hidden');
        prtRenderTimeline(0);
        document.getElementById('prtChartSection').classList.remove('hidden');
      } else {
        document.getElementById('prtTimeline').classList.add('hidden');
        document.getElementById('prtChartSection').classList.add('hidden');
      }

      // Disable start button
      const btn = document.getElementById('prtStartBtn');
      btn.disabled = true;
      btn.classList.add('opacity-50');
      btn.innerHTML = '<div class="pulse-dot"></div> Running...';

      _activePromptTuneJobId = null;
      _activePromptTuneRunId = null;
      try { sessionStorage.removeItem('_prtRunId'); } catch {}

      try {
        const res = await apiFetch('/api/tool-eval/prompt-tune', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (res.status === 409) { showToast('A benchmark or eval is already running', 'error'); _prtResetStartBtn(); return; }
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || `Server error (${res.status})`, 'error');
          _prtResetStartBtn(); return;
        }

        // Job-based response: {job_id, status}
        const data = await res.json();
        _activePromptTuneJobId = data.job_id;
        document.getElementById('prtProgressLabel').textContent = data.status === 'submitted' ? 'Tune queued...' : 'Tune starting...';
        showToast('Prompt tuning submitted', 'success');

        // Progress updates arrive via WebSocket (handled by _onPromptTuneJobEvent)
      } catch (e) {
        showToast('Connection error: ' + (e.message || 'unknown'), 'error');
        _prtResetStartBtn();
      }
    }

    function prtHandleSSE(evt) {
      switch (evt.type) {
        case 'tune_start':
          prtTotalPrompts = evt.total_prompts || 0;
          // Capture tune_id for reconnection
          if (evt.tune_id) {
            _activePromptTuneRunId = evt.tune_id;
            try { sessionStorage.setItem('_prtRunId', evt.tune_id); } catch {}
          }
          document.getElementById('prtProgressLabel').textContent =
            `${evt.mode === 'evolutionary' ? 'Evolving' : 'Generating'} prompts for ${evt.suite_name || 'suite'}`;
          document.getElementById('prtProgressCount').textContent = `0/${prtTotalPrompts}`;
          break;

        case 'generation_start':
          prtCurrentGeneration = evt.generation || 1;
          prtTotalGenerations = evt.total_generations || 1;
          document.getElementById('prtProgressLabel').textContent =
            `Generation ${prtCurrentGeneration}/${prtTotalGenerations} — generating ${evt.population_size || '?'} prompts`;
          if (prtMode === 'evolutionary') prtRenderTimeline(prtCurrentGeneration);
          break;

        case 'prompt_generated': {
          const p = {
            generation: evt.generation || 1,
            index: evt.prompt_index,
            text: evt.prompt_text || '',
            style: evt.style || evt.mutation_type || 'variation',
            parent: evt.parent_prompt || null,
            scores: {},
            avgScore: null,
            status: 'pending'
          };
          prtPrompts.push(p);
          prtRenderPromptCard(p, prtPrompts.length - 1);
          break;
        }

        case 'prompt_eval_start': {
          const idx = prtPrompts.findIndex(p => p.generation === (evt.generation || 1) && p.index === evt.prompt_index);
          if (idx >= 0) {
            prtPrompts[idx].status = 'evaluating';
            _prtUpdateCardStatus(idx, 'evaluating');
          }
          break;
        }

        case 'prompt_eval_result': {
          prtCompletedPrompts++;
          const idx = prtPrompts.findIndex(p => p.generation === (evt.generation || 1) && p.index === evt.prompt_index);
          if (idx >= 0) {
            prtPrompts[idx].scores[evt.model_id] = {
              overall: evt.overall_score || 0,
              tool_acc: evt.tool_accuracy || 0,
              param_acc: evt.param_accuracy || 0
            };
            // Compute avg score across all models
            const scoreVals = Object.values(prtPrompts[idx].scores).map(s => s.overall);
            prtPrompts[idx].avgScore = scoreVals.reduce((a, b) => a + b, 0) / scoreVals.length;
            prtPrompts[idx].status = 'scored';
            _prtUpdateCardScore(idx);
          }

          // Update progress
          const pct = prtTotalPrompts > 0 ? Math.round((prtCompletedPrompts / prtTotalPrompts) * 100) : 0;
          document.getElementById('prtProgressBar').style.width = pct + '%';
          document.getElementById('prtProgressCount').textContent = `${prtCompletedPrompts}/${prtTotalPrompts}`;

          // Update best
          if (idx >= 0 && prtPrompts[idx].avgScore > prtBestScoreVal) {
            prtBestScoreVal = prtPrompts[idx].avgScore;
            prtBestPrompt = prtPrompts[idx].text;
            prtUpdateBestCard();
          }
          break;
        }

        case 'generation_complete':
          if (evt.best_score != null) {
            prtGenScores.push({ gen: evt.generation, score: evt.best_score });
            if (prtMode === 'evolutionary') prtRenderScoreChart();
          }
          // Mark survivors
          if (evt.survivors && Array.isArray(evt.survivors)) {
            for (const p of prtPrompts) {
              if (p.generation === evt.generation) {
                p.survived = evt.survivors.includes(p.index);
              }
            }
            _prtRefreshCards();
          }
          break;

        case 'tune_complete':
          prtRunning = false;
          document.getElementById('prtProgressLabel').textContent = 'Complete!';
          document.getElementById('prtProgressBar').style.width = '100%';
          if (evt.best_prompt) {
            prtBestPrompt = evt.best_prompt;
            prtBestScoreVal = evt.best_score || 0;
            prtUpdateBestCard();
          }
          showToast('Prompt tuning complete!', 'success');
          break;

        case 'cancelled':
          prtRunning = false;
          document.getElementById('prtProgressLabel').textContent = 'Cancelled — partial results saved';
          showToast('Prompt tuning cancelled', 'error');
          break;

        case 'error':
          prtRunning = false;
          document.getElementById('prtProgressLabel').textContent = 'Error: ' + (evt.message || 'unknown');
          showToast(evt.message || 'Tuning error', 'error');
          break;

        case 'heartbeat':
          break;
      }
    }

    function prtUpdateBestCard() {
      const card = document.getElementById('prtBestCard');
      card.classList.remove('hidden');
      document.getElementById('prtBestScore').textContent = `Score: ${Math.round(prtBestScoreVal * 100)}%`;
      document.getElementById('prtBestPromptText').textContent = prtBestPrompt;
    }

    function prtCopyBest() {
      if (!prtBestPrompt) return;
      navigator.clipboard.writeText(prtBestPrompt).then(() => {
        showToast('Best prompt copied to clipboard', 'success');
      }).catch(() => {
        showToast('Failed to copy', 'error');
      });
    }

    function prtRenderTimeline(activeGen) {
      const el = document.getElementById('prtTimelineDots');
      let html = '';
      for (let g = 1; g <= prtTotalGenerations; g++) {
        const isActive = g === activeGen;
        const isDone = g < activeGen;
        const color = isDone ? 'var(--lime)' : (isActive ? '#A855F7' : 'var(--border-subtle)');
        const size = isActive ? 'w-8 h-8' : 'w-6 h-6';
        html += `<div class="flex items-center gap-1">
          <div class="${size} rounded-full flex items-center justify-center text-[10px] font-mono font-bold transition-all" style="border:2px solid ${color};color:${color};${isDone ? 'background:rgba(191,255,0,0.1)' : (isActive ? 'background:rgba(168,85,247,0.1)' : '')}">${g}</div>
          ${g < prtTotalGenerations ? '<div class="w-6 h-px" style="background:var(--border-subtle)"></div>' : ''}
        </div>`;
      }
      el.innerHTML = html;
    }

    function prtRenderPromptCard(p, idx) {
      const container = document.getElementById('prtPromptCards');
      const div = document.createElement('div');
      div.id = `prt-card-${idx}`;
      div.className = 'rounded-sm p-3 transition-all';
      div.style.cssText = 'background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);';
      const preview = (p.text || '').length > 120 ? p.text.slice(0, 120) + '...' : p.text;
      const styleColor = _prtStyleColor(p.style);
      div.innerHTML = `
        <div class="flex items-center justify-between mb-2">
          <div class="flex items-center gap-2">
            ${prtMode === 'evolutionary' ? `<span class="text-[9px] font-mono text-zinc-700">Gen ${p.generation}</span>` : ''}
            <span class="text-[9px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm" style="background:${styleColor}15;color:${styleColor};border:1px solid ${styleColor}30;">${p.style}</span>
          </div>
          <span id="prt-score-${idx}" class="text-xs font-mono text-zinc-600">${p.status === 'pending' ? 'pending' : ''}</span>
        </div>
        <div class="text-xs font-mono text-zinc-500 leading-relaxed">${_prtEsc(preview)}</div>
        ${p.avgScore != null ? `<div class="mt-2 h-1 rounded-full overflow-hidden" style="background:rgba(255,255,255,0.05);"><div style="width:${Math.round(p.avgScore * 100)}%;background:${_prtScoreColor(Math.round(p.avgScore * 100))};height:100%;border-radius:9999px;"></div></div>` : ''}
      `;
      container.appendChild(div);
    }

    function _prtUpdateCardStatus(idx, status) {
      const scoreEl = document.getElementById(`prt-score-${idx}`);
      if (scoreEl) {
        scoreEl.textContent = status === 'evaluating' ? 'evaluating...' : status;
        if (status === 'evaluating') scoreEl.style.color = '#A855F7';
      }
    }

    function _prtUpdateCardScore(idx) {
      const p = prtPrompts[idx];
      if (!p) return;
      const scoreEl = document.getElementById(`prt-score-${idx}`);
      if (scoreEl) {
        const pct = Math.round((p.avgScore || 0) * 100);
        scoreEl.textContent = `${pct}%`;
        scoreEl.style.color = _prtScoreColor(pct);
      }
      // Add score bar
      const card = document.getElementById(`prt-card-${idx}`);
      if (card && p.avgScore != null) {
        const existing = card.querySelector('.prt-score-bar');
        if (existing) existing.remove();
        const bar = document.createElement('div');
        bar.className = 'prt-score-bar mt-2 h-1 rounded-full overflow-hidden';
        bar.style.cssText = 'background:rgba(255,255,255,0.05);';
        const pct = Math.round(p.avgScore * 100);
        bar.innerHTML = `<div style="width:${pct}%;background:${_prtScoreColor(pct)};height:100%;border-radius:9999px;transition:width 0.3s;"></div>`;
        card.appendChild(bar);
      }
    }

    function _prtRefreshCards() {
      for (let i = 0; i < prtPrompts.length; i++) {
        const p = prtPrompts[i];
        const card = document.getElementById(`prt-card-${i}`);
        if (card && p.survived === true) {
          card.style.borderColor = 'rgba(191,255,0,0.3)';
          card.style.background = 'rgba(191,255,0,0.03)';
        } else if (card && p.survived === false) {
          card.style.opacity = '0.4';
        }
      }
    }

    function prtRenderScoreChart() {
      const canvas = document.getElementById('prtScoreChart');
      if (!canvas) return;
      const ctx = canvas.getContext('2d');
      if (prtScoreChart) prtScoreChart.destroy();

      prtScoreChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: prtGenScores.map(g => `Gen ${g.gen}`),
          datasets: [{
            label: 'Best Score',
            data: prtGenScores.map(g => Math.round(g.score * 100)),
            borderColor: '#A855F7',
            backgroundColor: 'rgba(168,85,247,0.1)',
            fill: true,
            tension: 0.3,
            pointRadius: 5,
            pointBackgroundColor: '#A855F7',
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { display: false } },
          scales: {
            y: {
              min: 0, max: 100,
              ticks: { color: '#52525B', font: { size: 10, family: "'JetBrains Mono', monospace" }, callback: v => v + '%' },
              grid: { color: 'rgba(255,255,255,0.03)' }
            },
            x: {
              ticks: { color: '#52525B', font: { size: 10, family: "'JetBrains Mono', monospace" } },
              grid: { display: false }
            }
          }
        }
      });
    }

    async function prtCancelTune() {
      if (!_activePromptTuneJobId) {
        showToast('No active prompt tuning job', 'error');
        return;
      }
      try {
        await notifCancelJob(_activePromptTuneJobId);
        showToast('Cancelling prompt tuning...', 'success');
      } catch (e) {
        showToast('Failed to cancel', 'error');
      }
    }

    async function prtLoadHistory() {
      try {
        const res = await apiFetch('/api/tool-eval/prompt-tune/history');
        if (!res.ok) { showToast('Failed to load prompt tuning history', 'error'); return; }
        const data = await res.json();
        prtHistory = data.runs || [];
        prtRenderHistory();
      } catch (e) {
        showToast('Failed to load history', 'error');
      }
    }

    function prtRenderHistory() {
      const tbody = document.getElementById('prtHistoryBody');
      if (!prtHistory.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No prompt tuning runs yet.</td></tr>';
        return;
      }
      tbody.innerHTML = prtHistory.map(r => {
        const models = (() => { try { return JSON.parse(r.target_models_json || '[]'); } catch { return []; } })();
        const modelNames = models.map(m => m.split('/').pop()).join(', ');
        const statusColor = r.status === 'completed' ? 'var(--lime)' : r.status === 'cancelled' ? '#EAB308' : r.status === 'interrupted' ? '#FB923C' : r.status === 'error' ? 'var(--coral)' : '#A855F7';
        const scorePct = Math.round((r.best_score || 0) * 100);
        return `<tr style="border-bottom:1px solid var(--border-subtle)" class="hover:bg-white/[0.02] transition-colors">
          <td class="px-5 py-3 text-xs font-mono text-zinc-500">${(r.timestamp || '').slice(0, 16)}</td>
          <td class="px-5 py-3 text-xs font-mono text-zinc-300">${_prtEsc(r.suite_name || 'Unknown')}</td>
          <td class="px-5 py-3 text-center"><span class="text-[9px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm" style="background:${r.mode === 'evolutionary' ? 'rgba(168,85,247,0.1)' : 'rgba(191,255,0,0.1)'};color:${r.mode === 'evolutionary' ? '#A855F7' : 'var(--lime)'}">${r.mode || 'quick'}</span></td>
          <td class="px-5 py-3 text-xs font-mono text-zinc-400">${modelNames || '-'}</td>
          <td class="px-5 py-3 text-right text-xs font-mono" style="color:${_prtScoreColor(scorePct)}">${scorePct}%</td>
          <td class="px-5 py-3 text-center"><span class="text-[9px] font-display tracking-wider uppercase" style="color:${statusColor}">${r.status || 'unknown'}</span></td>
          <td class="px-5 py-3 text-right">
            <button onclick="prtViewHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-200 mr-3">View</button>
            <button onclick="prtDeleteHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-700 hover:text-red-400">Delete</button>
          </td>
        </tr>`;
      }).join('');
    }

    async function prtViewHistoryRun(tuneId) {
      try {
        const res = await apiFetch(`/api/tool-eval/prompt-tune/history/${tuneId}`);
        if (!res.ok) { showToast('Failed to load run details', 'error'); return; }
        const run = await res.json();

        // Reset state and populate from history
        prtPrompts = [];
        prtBestPrompt = run.best_prompt || '';
        prtBestScoreVal = run.best_score || 0;
        prtGenScores = [];
        prtMode = run.mode || 'quick';
        prtTotalGenerations = 1;

        // Parse generations safely (may be NULL for interrupted runs)
        const generations = (() => { try { return JSON.parse(run.generations_json || '[]'); } catch { return []; } })();
        prtTotalGenerations = generations.length || 1;

        for (const gen of generations) {
          if (gen.best_score != null) {
            prtGenScores.push({ gen: gen.generation, score: gen.best_score });
          }
          for (const p of (gen.prompts || [])) {
            prtPrompts.push({
              generation: gen.generation,
              index: p.index,
              text: p.text || '',
              style: p.style || p.mutation_type || 'variation',
              parent: null,
              scores: p.scores || {},
              avgScore: p.avg_score != null ? p.avg_score : null,
              status: 'scored',
              survived: p.survived || false
            });
          }
        }

        // Switch to run view and render
        showToolEvalView('prt-run');
        document.getElementById('prtProgressSection').classList.add('hidden');

        // Show interrupted banner if applicable
        const prtInterruptedBanner = document.getElementById('prtInterruptedBanner');
        if (prtInterruptedBanner) prtInterruptedBanner.remove();
        if (run.status === 'interrupted') {
          const banner = document.createElement('div');
          banner.id = 'prtInterruptedBanner';
          banner.className = 'mb-4 px-4 py-3 rounded-md text-sm font-body';
          banner.style.cssText = 'background:rgba(251,146,60,0.08);border:1px solid rgba(251,146,60,0.25);color:#FB923C;';
          if (prtPrompts.length > 0) {
            banner.textContent = `This run was interrupted. Showing ${prtPrompts.length} partial prompt${prtPrompts.length === 1 ? '' : 's'} from ${generations.length} generation${generations.length === 1 ? '' : 's'}.`;
          } else {
            banner.textContent = 'This run was interrupted before any results were saved.';
          }
          // Insert after the (hidden) progress section
          document.getElementById('prtProgressSection').insertAdjacentElement('afterend', banner);
        }

        // Timeline
        if (prtMode === 'evolutionary' && prtTotalGenerations > 1) {
          document.getElementById('prtTimeline').classList.remove('hidden');
          prtRenderTimeline(prtTotalGenerations);
          document.getElementById('prtChartSection').classList.remove('hidden');
          prtRenderScoreChart();
        } else {
          document.getElementById('prtTimeline').classList.add('hidden');
          document.getElementById('prtChartSection').classList.add('hidden');
        }

        // Best card
        if (prtBestPrompt) prtUpdateBestCard();
        else document.getElementById('prtBestCard').classList.add('hidden');

        // Prompt cards
        document.getElementById('prtPromptsSection').classList.remove('hidden');
        document.getElementById('prtPromptCards').innerHTML = '';
        for (let i = 0; i < prtPrompts.length; i++) {
          prtRenderPromptCard(prtPrompts[i], i);
          if (prtPrompts[i].avgScore != null) _prtUpdateCardScore(i);
        }
        _prtRefreshCards();

      } catch (e) {
        showToast('Failed to load run: ' + (e.message || 'unknown'), 'error');
      }
    }

    async function prtDeleteHistoryRun(tuneId) {
      if (!confirm('Delete this prompt tuning run?')) return;
      try {
        const res = await apiFetch(`/api/tool-eval/prompt-tune/history/${tuneId}`, { method: 'DELETE' });
        if (!res.ok) { showToast('Failed to delete', 'error'); return; }
        showToast('Run deleted', 'success');
        prtLoadHistory();
      } catch (e) {
        showToast('Failed to delete', 'error');
      }
    }

    function _prtResetStartBtn() {
      const btn = document.getElementById('prtStartBtn');
      if (!btn) return;
      btn.disabled = false;
      btn.classList.remove('opacity-50');
      btn.innerHTML = '<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M9.813 15.904L9 18.75l-.813-2.846a4.5 4.5 0 00-3.09-3.09L2.25 12l2.846-.813a4.5 4.5 0 003.09-3.09L9 5.25l.813 2.846a4.5 4.5 0 003.09 3.09L15.75 12l-2.846.813a4.5 4.5 0 00-3.09 3.09z"/></svg> Start Prompt Tuning';
    }

    // WebSocket event bridge for inline prompt tuner progress
    function _onPromptTuneJobEvent(msg) {
      // Accept events from the known active job, or auto-associate in reconnection mode
      if (_activePromptTuneJobId && msg.job_id !== _activePromptTuneJobId) return;
      if (!_activePromptTuneJobId) {
        if (!_activePromptTuneRunId) return; // Not in reconnection mode
        _activePromptTuneJobId = msg.job_id;
      }

      switch (msg.type) {
        case 'job_started':
          document.getElementById('prtProgressLabel').textContent = 'Tune running...';
          break;

        case 'job_progress': {
          const pct = msg.progress_pct || 0;
          document.getElementById('prtProgressBar').style.width = pct + '%';
          document.getElementById('prtProgressLabel').textContent = msg.progress_detail || 'Running...';
          break;
        }

        // Domain events — route to existing prtHandleSSE handler
        case 'tune_start':
        case 'generation_start':
        case 'prompt_generated':
        case 'prompt_eval_start':
        case 'prompt_eval_result':
        case 'generation_complete':
        case 'generation_error':
          prtHandleSSE(msg);
          break;

        case 'tune_complete':
          prtHandleSSE(msg);
          _activePromptTuneJobId = null;
          _activePromptTuneRunId = null;
          try { sessionStorage.removeItem('_prtRunId'); } catch {}
          _prtResetStartBtn();
          break;

        case 'job_completed':
          // Fallback: if tune_complete didn't fire, handle via generic job completion
          if (_activePromptTuneJobId) {
            prtRunning = false;
            document.getElementById('prtProgressLabel').textContent = 'Complete!';
            document.getElementById('prtProgressBar').style.width = '100%';
            _activePromptTuneJobId = null;
            _activePromptTuneRunId = null;
            try { sessionStorage.removeItem('_prtRunId'); } catch {}
            _prtResetStartBtn();
            showToast('Prompt tuning complete!', 'success');
          }
          break;

        case 'job_failed':
          prtRunning = false;
          document.getElementById('prtProgressLabel').textContent = 'Error: ' + (msg.error || msg.error_msg || 'unknown');
          showToast(msg.error || msg.error_msg || 'Tuning failed', 'error');
          _activePromptTuneJobId = null;
          _activePromptTuneRunId = null;
          try { sessionStorage.removeItem('_prtRunId'); } catch {}
          _prtResetStartBtn();
          break;

        case 'job_cancelled':
          prtRunning = false;
          document.getElementById('prtProgressLabel').textContent = 'Cancelled — partial results saved';
          showToast('Prompt tuning cancelled', '');
          _activePromptTuneJobId = null;
          _activePromptTuneRunId = null;
          try { sessionStorage.removeItem('_prtRunId'); } catch {}
          _prtResetStartBtn();
          break;
      }
    }

    function _prtScoreColor(pct) {
      if (pct >= 90) return 'var(--lime)';
      if (pct >= 70) return '#22D3EE';
      if (pct >= 50) return '#EAB308';
      return 'var(--coral)';
    }

    function _prtStyleColor(style) {
      const map = {
        concise: '#22D3EE', detailed: '#A855F7', structured: 'var(--lime)',
        conversational: '#EAB308', technical: '#F97316',
        bold: '#FF3B5C', conservative: '#22D3EE', crossover: '#A855F7',
        variation: '#71717A'
      };
      return map[(style || '').toLowerCase()] || '#71717A';
    }

    function _prtEsc(str) {
      const d = document.createElement('div');
      d.textContent = str || '';
      return d.innerHTML;
    }

    // -------------------------------------------------------------------
    // LLM Judge (jg prefix)
    // -------------------------------------------------------------------
    let jgEnabled = false;
    let jgVerdicts = [];         // per-case verdicts from SSE
    let jgReport = null;         // full judge report object
    let jgHistory = [];
    let jgCompCases = [];        // comparative cases
    let jgCompTotal = 0;
    let jgCompCompleted = 0;

    function jgTogglePanel() {
      const checkbox = document.getElementById('jgToggle');
      jgEnabled = checkbox.checked;
      const panel = document.getElementById('jgSettingsPanel');
      const track = document.getElementById('jgToggleTrack');
      const dot = document.getElementById('jgToggleDot');
      if (jgEnabled) {
        panel.classList.remove('hidden');
        track.style.background = '#F59E0B';
        dot.style.background = '#fff';
        dot.style.transform = 'translateX(16px)';
        jgPopulateJudgeModel();
      } else {
        panel.classList.add('hidden');
        track.style.background = 'var(--border-subtle)';
        dot.style.background = '#52525B';
        dot.style.transform = 'translateX(0)';
      }
    }

    function jgPopulateJudgeModel() {
      const sel = document.getElementById('jgJudgeModel');
      const savedPk = _p10Settings?.judge?.provider_key || '';
      const savedMid = _p10Settings?.judge?.model_id || '';
      const savedCompound = savedPk && savedMid ? (savedPk + '::' + savedMid) : savedMid;
      const current = sel.value || savedCompound;
      if (!config || !config.providers) return;
      let html = '';
      for (const [provName, provData] of Object.entries(config.providers)) {
        const pk = provData.provider_key || provName;
        const models = getProviderModels(provData);
        for (const m of models) {
          const ck = pk + '::' + m.model_id;
          html += `<option value="${ck}" ${ck === current ? 'selected' : ''}>${m.display_name || m.model_id} (${provName})</option>`;
        }
      }
      sel.innerHTML = html;
    }

    /** Load judge defaults from Phase 10 settings into inline Tool Eval controls */
    function jgLoadDefaults() {
      if (!_p10Settings || !_p10Settings.judge) return;
      const j = _p10Settings.judge;
      // If judge is enabled in settings, auto-enable the inline toggle
      if (j.enabled && j.model_id) {
        const checkbox = document.getElementById('jgToggle');
        if (checkbox && !checkbox.checked) {
          checkbox.checked = true;
          jgTogglePanel(); // triggers panel show + model populate
        }
        // Set the model and mode from settings defaults
        const modeSel = document.getElementById('jgMode');
        if (modeSel && j.mode) modeSel.value = j.mode;
        const modelSel = document.getElementById('jgJudgeModel');
        if (modelSel && j.model_id) {
          const ck = j.provider_key ? (j.provider_key + '::' + j.model_id) : j.model_id;
          modelSel.value = ck;
        }
      }
    }

    function jgGetConfig() {
      if (!jgEnabled) return null;
      const raw = document.getElementById('jgJudgeModel').value;
      const parsed = _bmParseCompoundKey(raw);
      return {
        enabled: true,
        mode: document.getElementById('jgMode').value,
        judge_model: parsed.model_id,
        judge_provider_key: parsed.provider_key,
        custom_instructions: _p10Settings?.judge?.custom_instructions || '',
      };
    }

    // --- Judge SSE handling (integrated into _teHandleSSE) ---
    function jgHandleSSE(data) {
      switch (data.type) {
        case 'judge_start':
          document.getElementById('jgReportSection').classList.remove('hidden');
          document.getElementById('jgReportStatus').textContent = `Judging ${data.cases_to_review || '?'} cases with ${data.judge_model || 'AI'}...`;
          document.getElementById('jgGradeBadge').textContent = '...';
          break;

        case 'judge_verdict': {
          jgVerdicts.push(data);
          // Show live inline badge if in live mode
          if (document.getElementById('jgMode')?.value === 'live_inline') {
            jgAddInlineBadge(data);
          }
          // Add to per-case verdicts in report panel
          jgRenderVerdict(data);
          break;
        }

        case 'judge_report':
          jgReport = data.report || data;
          jgRenderReport(jgReport);
          break;

        case 'judge_complete':
          document.getElementById('jgReportStatus').textContent = 'Complete';
          if (data.judge_report_id) window.jgLastReportId = data.judge_report_id;
          // Bridge D: show next-steps action bridges
          document.getElementById('jgActionBridges')?.classList.remove('hidden');
          showToast('Judge report complete!', 'success');
          break;

        // Comparative events
        case 'compare_start':
          document.getElementById('jgCompModelA').textContent = data.model_a || 'Model A';
          document.getElementById('jgCompModelB').textContent = data.model_b || 'Model B';
          jgCompTotal = data.cases || 0;
          jgCompCompleted = 0;
          jgCompCases = [];
          document.getElementById('jgCompProgress').classList.remove('hidden');
          document.getElementById('jgCompProgressLabel').textContent = `Comparing ${jgCompTotal} cases...`;
          document.getElementById('jgCompProgressCount').textContent = `0/${jgCompTotal}`;
          document.getElementById('jgCompProgressBar').style.width = '0%';
          break;

        case 'compare_case': {
          jgCompCompleted++;
          jgCompCases.push(data);
          const pct = jgCompTotal > 0 ? Math.round((jgCompCompleted / jgCompTotal) * 100) : 0;
          document.getElementById('jgCompProgressBar').style.width = pct + '%';
          document.getElementById('jgCompProgressCount').textContent = `${jgCompCompleted}/${jgCompTotal}`;
          jgRenderCompareCase(data);
          break;
        }

        case 'compare_complete':
          document.getElementById('jgCompProgress').classList.add('hidden');
          jgRenderCompareVerdict(data);
          break;
      }
    }

    function jgAddInlineBadge(verdict) {
      // Find the live row matching this test case + model via data attributes
      const mid = (verdict.model_id || '').replace(/"/g, '\\"');
      const cid = (verdict.test_case_id || '').replace(/"/g, '\\"');
      const row = document.querySelector(`#teLiveBody tr[data-model-id="${mid}"][data-case-id="${cid}"]`);
      if (!row) return;

      // Check if badge column exists
      let badgeCell = row.querySelector('.jg-badge-cell');
      if (!badgeCell) {
        badgeCell = document.createElement('td');
        badgeCell.className = 'jg-badge-cell px-5 py-2 text-center';
        row.appendChild(badgeCell);
      }
      const stars = _jgStars(verdict.quality_score || 0);
      const verdictColor = _jgVerdictColor(verdict.verdict);
      badgeCell.innerHTML = `
        <div class="inline-flex items-center gap-1 cursor-pointer" onclick="jgExpandBadge(this)" title="Click to see reasoning">
          <span class="text-[10px]">${stars}</span>
          <span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:${verdictColor}15;color:${verdictColor};border:1px solid ${verdictColor}30;">${verdict.verdict || '?'}</span>
        </div>
        <div class="hidden mt-1 text-left">
          <p class="text-[10px] font-body text-zinc-400 mb-1">${_jgEsc(verdict.summary || '')}</p>
          <p class="text-[10px] font-body text-zinc-600 leading-relaxed">${_jgEsc(verdict.reasoning || '')}</p>
        </div>`;
    }

    function jgExpandBadge(el) {
      const detail = el.nextElementSibling;
      if (detail) detail.classList.toggle('hidden');
    }

    function jgRenderVerdict(v) {
      const container = document.getElementById('jgVerdicts');
      const verdictColor = _jgVerdictColor(v.verdict);
      const stars = _jgStars(v.quality_score || 0);
      const div = document.createElement('div');
      div.className = 'rounded-sm p-3 cursor-pointer transition-all';
      div.style.cssText = `background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);`;
      div.onclick = function() { this.querySelector('.jg-verdict-detail')?.classList.toggle('hidden'); };
      div.innerHTML = `
        <div class="flex items-center justify-between">
          <div class="flex items-center gap-2">
            <span class="text-[9px] font-mono text-zinc-600">${_jgEsc(v.test_case_id || '')}</span>
            <span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:${verdictColor}15;color:${verdictColor};border:1px solid ${verdictColor}30;">${v.verdict || '?'}</span>
          </div>
          <div class="flex items-center gap-2">
            <span class="text-[10px]">${stars}</span>
            <span class="text-xs font-mono text-zinc-500">${v.quality_score || 0}/5</span>
          </div>
        </div>
        <div class="jg-verdict-detail hidden mt-2 pt-2" style="border-top:1px solid var(--border-subtle);">
          <p class="text-xs font-body text-zinc-300 mb-1">${_jgEsc(v.summary || '')}</p>
          <p class="text-xs font-body text-zinc-500 leading-relaxed">${_jgEsc(v.reasoning || '')}</p>
          <div class="flex gap-4 mt-2">
            <span class="text-[9px] text-zinc-600 font-mono">Tool: ${_jgEsc(v.tool_selection_assessment || '-')}</span>
            <span class="text-[9px] text-zinc-600 font-mono">Params: ${_jgEsc(v.param_assessment || '-')}</span>
          </div>
        </div>`;
      container.appendChild(div);
    }

    function jgRenderReport(report) {
      // Grade badge
      document.getElementById('jgGradeBadge').textContent = report.overall_grade || '?';
      const gradeColor = _jgGradeColor(report.overall_grade || '');
      document.getElementById('jgGradeBadge').style.background = gradeColor + '15';
      document.getElementById('jgGradeBadge').style.color = gradeColor;

      // Score
      const score = report.overall_score || 0;
      document.getElementById('jgScoreValue').textContent = `${score}/100`;
      document.getElementById('jgScoreBar').style.width = score + '%';
      document.getElementById('jgScoreBar').style.background = _jgScoreColor(score);

      // Strengths
      const strengthsEl = document.getElementById('jgStrengths');
      strengthsEl.innerHTML = (report.strengths || []).map(s =>
        `<li class="text-xs font-body flex items-start gap-2" style="color:var(--lime);"><span class="mt-0.5">+</span><span class="text-zinc-300">${_jgEsc(s)}</span></li>`
      ).join('');

      // Weaknesses
      const weaknessesEl = document.getElementById('jgWeaknesses');
      weaknessesEl.innerHTML = (report.weaknesses || []).map(w =>
        `<li class="text-xs font-body flex items-start gap-2" style="color:var(--coral);"><span class="mt-0.5">-</span><span class="text-zinc-300">${_jgEsc(w)}</span></li>`
      ).join('');

      // Analysis
      document.getElementById('jgAnalysis').textContent = report.cross_case_analysis || '';

      // Recommendations
      const recsEl = document.getElementById('jgRecommendations');
      recsEl.innerHTML = (report.recommendations || []).map(r =>
        `<li class="text-xs font-body text-zinc-300">${_jgEsc(r)}</li>`
      ).join('');
    }

    // --- Post-eval judge on existing run ---
    async function jgCancelJudge() {
      if (_activeJudgeJobId) {
        await notifCancelJob(_activeJudgeJobId);
        const job = _jobStore[_activeJudgeJobId];
        if (job && !ACTIVE_STATUSES.has(job.status)) {
          _activeJudgeJobId = null;
        }
      } else {
        // Legacy fallback
        try {
          await apiFetch('/api/tool-eval/judge/cancel', { method: 'POST' });
          showToast('Cancelling judge...', 'success');
        } catch (e) {
          showToast('Failed to cancel judge', 'error');
        }
      }
    }

    async function jgRunPostEval(evalRunId) {
      if (!evalRunId) { showToast('No eval run selected', 'error'); return; }

      // Get judge model from inline panel, or fall back to saved settings (compound key)
      let judgeRaw = document.getElementById('jgJudgeModel')?.value;
      if (!judgeRaw && _p10Settings?.judge?.provider_key && _p10Settings?.judge?.model_id) {
        judgeRaw = _p10Settings.judge.provider_key + '::' + _p10Settings.judge.model_id;
      } else if (!judgeRaw && _p10Settings?.judge?.model_id) {
        judgeRaw = _p10Settings.judge.model_id;  // Legacy fallback
      }
      if (!judgeRaw) {
        showToast('No judge model configured. Set one in Settings > LLM Judge.', 'error');
        return;
      }
      const judgeParsed = judgeRaw.includes('::') ? _bmParseCompoundKey(judgeRaw) : { provider_key: '', model_id: judgeRaw };

      // Reset
      jgVerdicts = [];
      jgReport = null;
      document.getElementById('jgVerdicts').innerHTML = '';
      document.getElementById('jgActionBridges')?.classList.add('hidden');
      document.getElementById('jgReportSection').classList.remove('hidden');
      document.getElementById('jgReportStatus').textContent = 'Starting judge...';
      document.getElementById('jgGradeBadge').textContent = '...';
      document.getElementById('jgProgressSection')?.classList.remove('hidden');

      try {
        const res = await apiFetch('/api/tool-eval/judge', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eval_run_id: evalRunId, judge_model: judgeParsed.model_id, judge_provider_key: judgeParsed.provider_key || undefined, custom_instructions: _p10Settings?.judge?.custom_instructions || '', concurrency: _p10Settings?.judge?.concurrency || 4 })
        });

        if (res.status === 409) { showToast('Another operation is running', 'error'); return; }
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || `Server error (${res.status})`, 'error');
          return;
        }

        // New job-based response: {job_id}
        const data = await res.json();
        _activeJudgeJobId = data.job_id;
        showToast('Judge submitted', 'success');
        // Progress updates arrive via WebSocket (handled by _onToolEvalJobEvent)

      } catch (e) {
        showToast('Judge error: ' + (e.message || 'unknown'), 'error');
      }
    }

    /** Judge from history: load the run view first, then trigger judge */
    async function jgJudgeFromHistory(runId) {
      await teViewHistoryRun(runId);
      await new Promise(r => setTimeout(r, 100));
      // Ensure judge model is populated (Bridge E)
      jgPopulateJudgeModel();
      const sel = document.getElementById('jgJudgeModel');
      if (!sel?.value) {
        const j = _p10Settings?.judge;
        if (j?.model_id) {
          const ck = j.provider_key ? (j.provider_key + '::' + j.model_id) : j.model_id;
          sel.value = ck;
        }
      }
      if (!sel?.value) {
        showToast('No judge model configured. Set one in Settings > LLM Judge.', 'error');
        return;
      }
      const toggle = document.getElementById('jgToggle');
      if (toggle && !toggle.checked) {
        toggle.checked = true;
        jgTogglePanel();
      }
      jgRunPostEval(runId);
    }

    // --- Comparative Judge ---
    async function jgStartCompare(evalRunIdA, evalRunIdB) {
      if (!evalRunIdA || !evalRunIdB) { showToast('Select two eval runs to compare', 'error'); return; }

      let judgeRaw = document.getElementById('jgJudgeModel')?.value;
      if (!judgeRaw) {
        // Use first available model
        jgPopulateJudgeModel();
        const sel = document.getElementById('jgJudgeModel');
        if (!sel?.value) { showToast('No judge model available', 'error'); return; }
        judgeRaw = sel.value;
      }
      const judgeParsed = judgeRaw.includes('::') ? _bmParseCompoundKey(judgeRaw) : { provider_key: '', model_id: judgeRaw };

      jgCompCases = [];
      jgCompTotal = 0;
      jgCompCompleted = 0;
      document.getElementById('jgCompCases').innerHTML = '';
      document.getElementById('jgCompVerdict').classList.add('hidden');

      showToolEvalView('jg-compare');

      try {
        const res = await apiFetch('/api/tool-eval/judge/compare', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            eval_run_id_a: evalRunIdA,
            eval_run_id_b: evalRunIdB,
            judge_model: judgeParsed.model_id,
            judge_provider_key: judgeParsed.provider_key || undefined,
            concurrency: _p10Settings?.judge?.concurrency || 4
          })
        });

        if (res.status === 409) { showToast('Another operation is running', 'error'); return; }
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || `Server error (${res.status})`, 'error');
          return;
        }

        // New job-based response: {job_id}
        const data = await res.json();
        _activeJudgeJobId = data.job_id;
        showToast('Comparison submitted', 'success');
        // Progress updates arrive via WebSocket (handled by _onToolEvalJobEvent)

      } catch (e) {
        showToast('Compare error: ' + (e.message || 'unknown'), 'error');
      }
    }

    function jgRenderCompareCase(c) {
      const container = document.getElementById('jgCompCases');
      const winColor = c.winner === 'model_a' ? '#22D3EE' : c.winner === 'model_b' ? '#F59E0B' : '#71717A';
      const arrow = c.winner === 'model_a' ? '&larr;' : c.winner === 'model_b' ? '&rarr;' : '=';
      const conf = Math.round((c.confidence || 0) * 100);
      const div = document.createElement('div');
      div.className = 'card rounded-sm p-3';
      div.innerHTML = `
        <div class="flex items-center justify-between mb-1">
          <span class="text-[9px] font-mono text-zinc-600">${_jgEsc(c.test_case_id || `Case ${jgCompCompleted}`)}</span>
          <div class="flex items-center gap-2">
            <span class="text-sm font-bold" style="color:${winColor};">${arrow}</span>
            <span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:${winColor}15;color:${winColor};border:1px solid ${winColor}30;">${c.winner === 'tie' ? 'Tie' : c.winner === 'model_a' ? 'A wins' : 'B wins'} (${conf}%)</span>
          </div>
        </div>
        <p class="text-[10px] font-body text-zinc-500">${_jgEsc(c.reasoning || '')}</p>`;
      container.appendChild(div);
    }

    function jgRenderCompareVerdict(data) {
      const verdict = document.getElementById('jgCompVerdict');
      verdict.classList.remove('hidden');

      const winnerText = data.overall_winner === 'model_a'
        ? document.getElementById('jgCompModelA').textContent + ' wins'
        : data.overall_winner === 'model_b'
        ? document.getElementById('jgCompModelB').textContent + ' wins'
        : 'Tie';

      document.getElementById('jgCompWinner').innerHTML = `<span class="font-display font-bold">${winnerText}</span> &mdash; Score: ${data.score_a || 0} vs ${data.score_b || 0}`;
      document.getElementById('jgCompSummary').textContent = data.summary || '';

      // Update summary bar
      const aWins = jgCompCases.filter(c => c.winner === 'model_a').length;
      const bWins = jgCompCases.filter(c => c.winner === 'model_b').length;
      const ties = jgCompCases.filter(c => c.winner === 'tie').length;
      document.getElementById('jgCompSummaryBar').innerHTML = `
        <span style="color:#22D3EE;">A: ${aWins}</span>
        <span class="text-zinc-700">|</span>
        <span class="text-zinc-500">Tie: ${ties}</span>
        <span class="text-zinc-700">|</span>
        <span style="color:#F59E0B;">B: ${bWins}</span>`;
    }

    // --- Judge History ---
    async function jgLoadHistory() {
      try {
        const res = await apiFetch('/api/tool-eval/judge/reports');
        if (!res.ok) return;
        const data = await res.json();
        jgHistory = data.reports || [];
        jgRenderHistory();
      } catch (e) {}
    }

    function jgRenderHistory() {
      const tbody = document.getElementById('jgHistoryBody');
      if (!jgHistory.length) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No judge reports yet.</td></tr>';
        return;
      }
      tbody.innerHTML = jgHistory.map(r => {
        const modeLabel = r.mode === 'post_eval' ? 'Post-Eval' : r.mode === 'live_inline' ? 'Live Inline' : r.mode === 'comparative' ? 'Compare' : r.mode;
        const modeColor = r.mode === 'comparative' ? '#22D3EE' : '#F59E0B';
        const gradeColor = _jgGradeColor(r.overall_grade || '');
        const statusColor = r.status === 'completed' ? 'var(--lime)' : r.status === 'error' ? 'var(--coral)' : '#F59E0B';
        return `<tr style="border-bottom:1px solid var(--border-subtle)" class="hover:bg-white/[0.02] transition-colors">
          <td class="px-5 py-3 text-xs font-mono text-zinc-500">${(r.timestamp || '').slice(0, 16)}</td>
          <td class="px-5 py-3 text-center"><span class="text-[9px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm" style="background:${modeColor}15;color:${modeColor}">${modeLabel}</span></td>
          <td class="px-5 py-3 text-xs font-mono text-zinc-400">${_jgEsc((r.judge_model || '').split('/').pop())}</td>
          <td class="px-5 py-3 text-center"><span class="text-sm font-mono font-bold" style="color:${gradeColor};">${r.overall_grade || '-'}</span></td>
          <td class="px-5 py-3 text-right text-xs font-mono" style="color:${_jgScoreColor(r.overall_score || 0)}">${r.overall_score != null ? r.overall_score : '-'}</td>
          <td class="px-5 py-3 text-center"><span class="text-[9px] font-display tracking-wider uppercase" style="color:${statusColor}">${r.status || 'unknown'}</span></td>
          <td class="px-5 py-3 text-right">
            ${r.status === 'running' ? `<button onclick="jgCancelJudge()" class="text-[10px] font-display tracking-wider uppercase text-red-400 hover:text-red-300 mr-3">Cancel</button>` : ''}
            <button onclick="jgViewReport('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-200 mr-3">View</button>
            <button onclick="jgDeleteReport('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-700 hover:text-red-400">Delete</button>
          </td>
        </tr>`;
      }).join('');
    }

    async function jgViewReport(reportId) {
      try {
        const res = await apiFetch(`/api/tool-eval/judge/reports/${reportId}`);
        if (!res.ok) { showToast('Failed to load report', 'error'); return; }
        const data = await res.json();

        // Parse stored data
        const verdicts = (() => { try { return JSON.parse(data.verdicts_json || '[]'); } catch { return []; } })();
        const report = (() => { try { return JSON.parse(data.report_json || '{}'); } catch { return {}; } })();

        if (data.mode === 'comparative') {
          // Show comparative view
          showToolEvalView('jg-compare');
          jgCompCases = [];
          document.getElementById('jgCompCases').innerHTML = '';
          document.getElementById('jgCompProgress').classList.add('hidden');
          document.getElementById('jgCompModelA').textContent = 'Model A';
          document.getElementById('jgCompModelB').textContent = 'Model B';
          for (const v of verdicts) {
            jgCompCases.push(v);
            jgRenderCompareCase(v);
          }
          if (report.overall_winner) {
            jgRenderCompareVerdict(report);
          }
        } else {
          // Show post-eval / live inline report
          showToolEvalView('run');
          jgVerdicts = verdicts;
          jgReport = report;
          document.getElementById('jgVerdicts').innerHTML = '';
          document.getElementById('jgReportSection').classList.remove('hidden');
          document.getElementById('jgReportStatus').textContent = 'Historical Report';
          for (const v of verdicts) {
            jgRenderVerdict(v);
          }
          if (Object.keys(report).length > 0) {
            jgRenderReport(report);
          }
        }
      } catch (e) {
        showToast('Failed to load report', 'error');
      }
    }

    async function jgDeleteReport(reportId) {
      if (!confirm('Delete this judge report?')) return;
      try {
        const res = await apiFetch(`/api/tool-eval/judge/reports/${reportId}`, { method: 'DELETE' });
        if (!res.ok) { showToast('Failed to delete', 'error'); return; }
        showToast('Report deleted', 'success');
        jgLoadHistory();
      } catch (e) {
        showToast('Failed to delete', 'error');
      }
    }

    function jgDownloadReport() {
      if (!jgReport) { showToast('No report to download', 'error'); return; }
      const data = { report: jgReport, verdicts: jgVerdicts };
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `judge-report-${new Date().toISOString().slice(0, 10)}.json`;
      a.click();
      URL.revokeObjectURL(url);
    }

    // --- Judge helpers ---
    function _jgStars(score) {
      const full = Math.min(Math.max(Math.round(score), 0), 5);
      let s = '';
      for (let i = 0; i < 5; i++) {
        s += i < full ? '<span style="color:#F59E0B;">&#9733;</span>' : '<span style="color:#3f3f46;">&#9733;</span>';
      }
      return s;
    }

    function _jgVerdictColor(verdict) {
      if (verdict === 'pass') return 'var(--lime)';
      if (verdict === 'marginal') return '#EAB308';
      return 'var(--coral)';
    }

    function _jgGradeColor(grade) {
      if (!grade) return '#71717A';
      const letter = grade.charAt(0).toUpperCase();
      if (letter === 'A') return 'var(--lime)';
      if (letter === 'B') return '#22D3EE';
      if (letter === 'C') return '#EAB308';
      if (letter === 'D') return '#F97316';
      return 'var(--coral)';
    }

    function _jgScoreColor(score) {
      if (score >= 80) return 'var(--lime)';
      if (score >= 60) return '#22D3EE';
      if (score >= 40) return '#EAB308';
      return 'var(--coral)';
    }

    function _jgEsc(str) {
      const d = document.createElement('div');
      d.textContent = str || '';
      return d.innerHTML;
    }

    // --- Suite List ---
    async function teLoadSuites() {
      try {
        const res = await apiFetch('/api/tool-suites');
        if (!res.ok) { showToast('Failed to load suites', 'error'); return; }
        const data = await res.json();
        teSuites = data.suites || [];
        teRenderSuites();
      } catch (e) {
        showToast('Failed to load suites', 'error');
      }
    }

    function teRenderSuites() {
      const body = document.getElementById('teSuitesBody');
      if (!teSuites.length) {
        body.innerHTML = '<tr><td colspan="5" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No tool suites yet. Click "New Suite" to create one.</td></tr>';
        return;
      }
      body.innerHTML = teSuites.map(s => {
        const updated = s.updated_at ? _teTimeAgo(s.updated_at) : '';
        return `<tr>
          <td class="px-5 py-3"><button onclick="teOpenSuite('${s.id}')" class="text-zinc-200 hover:text-white font-body text-sm underline decoration-zinc-700 hover:decoration-zinc-400 transition-colors">${_teEsc(s.name || 'Untitled')}</button></td>
          <td class="px-5 py-3 text-center font-mono text-xs text-zinc-500">${s.tool_count || 0}</td>
          <td class="px-5 py-3 text-center font-mono text-xs text-zinc-500">${s.test_case_count || 0}</td>
          <td class="px-5 py-3 text-right text-xs text-zinc-600 font-body">${updated}</td>
          <td class="px-5 py-3 text-right flex items-center justify-end gap-3">
            <button onclick="teExportSuite('${s.id}')" class="text-zinc-700 hover:text-emerald-400 transition-colors text-xs font-display tracking-wider uppercase">Export</button>
            <button onclick="teDeleteSuite('${s.id}','${_teEsc(s.name)}')" class="text-zinc-700 hover:text-red-400 transition-colors text-xs font-display tracking-wider uppercase">Delete</button>
          </td>
        </tr>`;
      }).join('');
    }

    function _teTimeAgo(dateStr) {
      try {
        const d = new Date(dateStr + (dateStr.includes('Z') || dateStr.includes('+') ? '' : 'Z'));
        const diff = (Date.now() - d.getTime()) / 1000;
        if (diff < 60) return 'just now';
        if (diff < 3600) return Math.floor(diff/60) + 'm ago';
        if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
        return Math.floor(diff/86400) + 'd ago';
      } catch { return dateStr; }
    }

    function _teEsc(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    async function teNewSuite() {
      try {
        const res = await apiFetch('/api/tool-suites', {
          method: 'POST',
          body: JSON.stringify({ name: 'New Suite', description: '', tools: [] }),
        });
        if (!res.ok) { showToast('Failed to create suite', 'error'); return; }
        const data = await res.json();
        showToast('Suite created', 'success');
        await teOpenSuite(data.suite_id);
      } catch (e) {
        showToast('Failed to create suite', 'error');
      }
    }

    function teImportSuiteJson() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!data.name || typeof data.name !== 'string') {
            showToast('Invalid JSON: missing "name" field', 'error');
            return;
          }
          const res = await apiFetch('/api/tool-eval/import', {
            method: 'POST',
            body: JSON.stringify(data),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            showToast(err.error || 'Import failed', 'error');
            return;
          }
          const result = await res.json();
          showToast(`Imported "${data.name}" with ${result.test_cases_created} test cases`, 'success');
          await teLoadSuites();
          await teOpenSuite(result.suite_id);
        } catch (err) {
          showToast('Failed to import: ' + (err.message || 'invalid JSON'), 'error');
        }
      };
      input.click();
    }

    async function teExportSuite(suiteId) {
      try {
        const res = await apiFetch(`/api/tool-suites/${suiteId}/export`);
        if (!res.ok) { showToast('Failed to export suite', 'error'); return; }
        const blob = await res.blob();
        const cd = res.headers.get('content-disposition') || '';
        const match = cd.match(/filename=([^\s;]+)/);
        const filename = match ? match[1] : `suite-${suiteId.slice(0,8)}.json`;
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = filename;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('Suite exported', 'success');
      } catch (e) {
        showToast('Failed to export suite', 'error');
      }
    }

    async function teDownloadImportExample() {
      try {
        const res = await apiFetch('/api/tool-eval/import/example');
        if (!res.ok) { showToast('Failed to download example', 'error'); return; }
        const blob = await res.blob();
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = 'suite-example.json';
        document.body.appendChild(a); a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      } catch (e) {
        showToast('Failed to download example', 'error');
      }
    }

    function teDeleteSuite(id, name) {
      showModal('Delete Suite', `Delete "${name}" and all its test cases? This cannot be undone.`, async () => {
        try {
          const res = await apiFetch(`/api/tool-suites/${id}`, { method: 'DELETE' });
          if (!res.ok) { showToast('Failed to delete', 'error'); return; }
          showToast('Suite deleted', 'success');
          await teLoadSuites();
        } catch { showToast('Failed to delete', 'error'); }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    // --- MCP Import ---
    let _mcpDiscoveredTools = [];

    function mcpOpenModal() {
      document.getElementById('mcpModal').classList.remove('hidden');
      document.getElementById('mcpStep1').classList.remove('hidden');
      document.getElementById('mcpStep2').classList.add('hidden');
      document.getElementById('mcpConnectError').classList.add('hidden');
      document.getElementById('mcpConnecting').classList.add('hidden');
      document.getElementById('mcpUrl').value = '';
      _mcpDiscoveredTools = [];
    }

    function mcpCloseModal() {
      document.getElementById('mcpModal').classList.add('hidden');
    }

    async function mcpConnect() {
      const url = document.getElementById('mcpUrl').value.trim();
      if (!url) { showToast('Enter a server URL', 'error'); return; }

      const errDiv = document.getElementById('mcpConnectError');
      const loadDiv = document.getElementById('mcpConnecting');
      const btn = document.getElementById('mcpConnectBtn');

      errDiv.classList.add('hidden');
      loadDiv.classList.remove('hidden');
      btn.disabled = true;
      btn.textContent = 'Connecting...';

      try {
        const res = await apiFetch('/api/mcp/discover', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url }),
        });
        const data = await res.json();

        if (data.error) {
          errDiv.textContent = data.error;
          errDiv.classList.remove('hidden');
          return;
        }

        _mcpDiscoveredTools = data.tools;
        mcpRenderStep2(data);
      } catch (e) {
        errDiv.textContent = 'Connection failed: ' + e.message;
        errDiv.classList.remove('hidden');
      } finally {
        loadDiv.classList.add('hidden');
        btn.disabled = false;
        btn.textContent = 'Connect';
      }
    }

    function mcpRenderStep2(data) {
      document.getElementById('mcpStep1').classList.add('hidden');
      document.getElementById('mcpStep2').classList.remove('hidden');
      document.getElementById('mcpServerInfo').textContent =
        `Connected to: ${data.server_name} (${data.tool_count} tool${data.tool_count !== 1 ? 's' : ''} found)`;

      // Default suite name
      const names = data.tools.slice(0, 3).map(t => t.name);
      const suffix = data.tools.length > 3 ? '...' : '';
      document.getElementById('mcpSuiteName').value = `MCP: ${names.join(', ')}${suffix}`;
      document.getElementById('mcpSuiteDesc').value = `Imported from MCP server: ${document.getElementById('mcpUrl').value}`;

      // Render tool list with checkboxes
      const list = document.getElementById('mcpToolList');
      list.innerHTML = data.tools.map((t, i) => {
        const params = Object.entries((t.inputSchema || {}).properties || {});
        const required = (t.inputSchema || {}).required || [];
        const paramHtml = params.map(([name, schema]) => {
          const req = required.includes(name) ? ', required' : ', optional';
          return `<span class="text-zinc-500">${_teEsc(name)}</span> <span class="text-zinc-700">(${schema.type || '?'}${req})</span>`;
        }).join(', ');

        return `<label class="flex gap-3 p-3 rounded border border-zinc-800 hover:border-zinc-700 cursor-pointer">
          <input type="checkbox" checked data-mcp-idx="${i}" class="mt-1 mcp-tool-check">
          <div class="flex-1 min-w-0">
            <div class="text-sm text-zinc-200 font-mono">${_teEsc(t.name)}</div>
            <div class="text-xs text-zinc-500 mt-0.5">${_teEsc(t.description)}</div>
            ${params.length ? `<div class="text-xs text-zinc-600 mt-1">Params: ${paramHtml}</div>` : ''}
          </div>
        </label>`;
      }).join('');

      mcpUpdateImportBtn();
    }

    function mcpSelectAll(checked) {
      document.querySelectorAll('.mcp-tool-check').forEach(cb => cb.checked = checked);
      mcpUpdateImportBtn();
    }

    function mcpUpdateImportBtn() {
      const count = document.querySelectorAll('.mcp-tool-check:checked').length;
      const btn = document.getElementById('mcpImportBtn');
      btn.textContent = `Import ${count} Tool${count !== 1 ? 's' : ''}`;
      btn.disabled = count === 0;
    }

    // Attach change listener via delegation for MCP checkboxes
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('mcp-tool-check')) mcpUpdateImportBtn();
    });

    async function mcpImport() {
      const checked = document.querySelectorAll('.mcp-tool-check:checked');
      const selectedTools = Array.from(checked).map(cb => _mcpDiscoveredTools[parseInt(cb.dataset.mcpIdx)]);

      if (!selectedTools.length) { showToast('Select at least one tool', 'error'); return; }

      const btn = document.getElementById('mcpImportBtn');
      btn.disabled = true;
      btn.textContent = 'Importing...';

      try {
        const res = await apiFetch('/api/mcp/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            suite_name: document.getElementById('mcpSuiteName').value.trim(),
            suite_description: document.getElementById('mcpSuiteDesc').value.trim(),
            tools: selectedTools,
            generate_test_cases: document.getElementById('mcpGenTests').checked,
          }),
        });
        const data = await res.json();

        if (data.error) { showToast(data.error, 'error'); return; }

        showToast(`Imported ${data.tools_imported} tool(s)${data.test_cases_generated ? ` with ${data.test_cases_generated} test case(s)` : ''}`, 'success');
        mcpCloseModal();

        // Navigate to the new suite editor
        await teOpenSuite(data.suite_id);
      } catch (e) {
        showToast('Import failed: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Import Tools';
      }
    }

    // --- Suite Editor ---
    async function teOpenSuite(suiteId) {
      try {
        const res = await apiFetch(`/api/tool-suites/${suiteId}`);
        if (!res.ok) { showToast('Suite not found', 'error'); return; }
        teCurrentSuite = await res.json();
        teRenderEditor();
        showToolEvalView('editor');
      } catch (e) {
        showToast('Failed to load suite', 'error');
      }
    }

    function teRenderEditor() {
      if (!teCurrentSuite) return;
      document.getElementById('teSuiteName').value = teCurrentSuite.name || '';
      document.getElementById('teSuiteDesc').value = teCurrentSuite.description || '';
      teRenderToolsList();
      teRenderCasesList();
      // Hide editors
      document.getElementById('teToolEditor').classList.add('hidden');
      document.getElementById('teCaseEditor').classList.add('hidden');
    }

    async function teSaveSuiteMeta() {
      if (!teCurrentSuite) return;
      const name = document.getElementById('teSuiteName').value.trim();
      const description = document.getElementById('teSuiteDesc').value.trim();
      if (!name) { showToast('Name is required', 'error'); return; }
      try {
        const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}`, {
          method: 'PUT',
          body: JSON.stringify({ name, description }),
        });
        if (!res.ok) { showToast('Failed to save', 'error'); return; }
        teCurrentSuite.name = name;
        teCurrentSuite.description = description;
      } catch { showToast('Failed to save', 'error'); }
    }

    // --- Tools ---
    function teRenderToolsList() {
      const tools = teCurrentSuite?.tools || [];
      const container = document.getElementById('teToolsList');
      document.getElementById('teToolCount').textContent = `(${tools.length})`;
      if (!tools.length) {
        container.innerHTML = '<p class="text-zinc-600 text-xs font-body">No tools defined yet.</p>';
        return;
      }
      container.innerHTML = tools.map((t, i) => {
        const fn = t.function || {};
        return `<div class="flex items-center justify-between px-3 py-2 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);">
          <div class="flex-1 min-w-0">
            <span class="text-sm font-mono text-zinc-200">${_teEsc(fn.name || 'unnamed')}</span>
            <span class="text-xs text-zinc-600 ml-2 font-body">${_teEsc(fn.description || '')}</span>
          </div>
          <div class="flex gap-2 ml-3 flex-shrink-0">
            <button onclick="teEditTool(${i})" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300">Edit</button>
            <button onclick="teDeleteTool(${i})" class="text-[10px] font-display tracking-wider uppercase text-zinc-700 hover:text-red-400">Delete</button>
          </div>
        </div>`;
      }).join('');
    }

    function teAddTool() {
      teEditingToolIndex = -1;
      document.getElementById('teToolJson').value = JSON.stringify({
        type: "function",
        function: {
          name: "my_tool",
          description: "Description of what this tool does",
          parameters: {
            type: "object",
            properties: {},
            required: []
          }
        }
      }, null, 2);
      document.getElementById('teToolJsonError').classList.add('hidden');
      document.getElementById('teToolEditor').classList.remove('hidden');
    }

    function teEditTool(index) {
      teEditingToolIndex = index;
      const tools = teCurrentSuite?.tools || [];
      document.getElementById('teToolJson').value = JSON.stringify(tools[index], null, 2);
      document.getElementById('teToolJsonError').classList.add('hidden');
      document.getElementById('teToolEditor').classList.remove('hidden');
    }

    function teCancelToolEdit() {
      document.getElementById('teToolEditor').classList.add('hidden');
      teEditingToolIndex = -1;
    }

    async function teSaveToolJson() {
      const jsonStr = document.getElementById('teToolJson').value.trim();
      const errEl = document.getElementById('teToolJsonError');
      let tool;
      try {
        tool = JSON.parse(jsonStr);
      } catch (e) {
        errEl.textContent = 'Invalid JSON: ' + e.message;
        errEl.classList.remove('hidden');
        return;
      }
      // Structural validation
      if (!tool || typeof tool !== 'object') { errEl.textContent = 'Tool must be a JSON object'; errEl.classList.remove('hidden'); return; }
      if (tool.type !== 'function') { errEl.textContent = 'tool.type must be "function"'; errEl.classList.remove('hidden'); return; }
      if (!tool.function?.name) { errEl.textContent = 'tool.function.name is required'; errEl.classList.remove('hidden'); return; }
      errEl.classList.add('hidden');

      const tools = [...(teCurrentSuite?.tools || [])];
      if (teEditingToolIndex >= 0) {
        tools[teEditingToolIndex] = tool;
      } else {
        tools.push(tool);
      }

      try {
        const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}`, {
          method: 'PUT',
          body: JSON.stringify({ tools }),
        });
        if (!res.ok) { showToast('Failed to save tools', 'error'); return; }
        teCurrentSuite.tools = tools;
        teRenderToolsList();
        teCancelToolEdit();
        showToast('Tool saved', 'success');
      } catch { showToast('Failed to save tools', 'error'); }
    }

    function teDeleteTool(index) {
      const fn = teCurrentSuite?.tools?.[index]?.function || {};
      showModal('Delete Tool', `Delete "${fn.name || 'unnamed'}"?`, async () => {
        const tools = [...(teCurrentSuite?.tools || [])];
        tools.splice(index, 1);
        try {
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}`, {
            method: 'PUT',
            body: JSON.stringify({ tools }),
          });
          if (!res.ok) { showToast('Failed to delete tool', 'error'); return; }
          teCurrentSuite.tools = tools;
          teRenderToolsList();
          showToast('Tool deleted', 'success');
        } catch { showToast('Failed to delete tool', 'error'); }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    function teExportTools() {
      const tools = teCurrentSuite?.tools || [];
      if (!tools.length) { showToast('No tools to export', 'error'); return; }
      const blob = new Blob([JSON.stringify(tools, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${(teCurrentSuite.name || 'tools').replace(/[^a-z0-9]+/gi, '_').toLowerCase()}_tools.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function teImportToolsJson() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `<div class="modal-box" style="max-width:600px;">
        <div class="modal-title">Import Tools (JSON)</div>
        <div class="modal-message">Paste a JSON array of tools in OpenAI function calling format, or upload a file.</div>
        <div class="flex gap-2 mb-3">
          <button class="modal-btn modal-btn-cancel text-xs" data-action="file">Choose File</button>
        </div>
        <textarea class="modal-input font-mono text-xs" style="height:200px;resize:vertical;margin-bottom:16px;" placeholder='[{"type":"function","function":{"name":"my_tool","description":"...","parameters":{...}}}]'></textarea>
        <div class="text-xs mb-3" style="color:var(--coral);display:none;" id="teImportToolsErr"></div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">Import</button>
        </div>
      </div>`;
      const textarea = overlay.querySelector('textarea');
      overlay.querySelector('[data-action="file"]').onclick = () => {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = '.json';
        input.onchange = async (e) => { if (e.target.files[0]) textarea.value = await e.target.files[0].text(); };
        input.click();
      };
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = async () => {
        const errEl = overlay.querySelector('#teImportToolsErr');
        let tools;
        try { tools = JSON.parse(textarea.value.trim()); } catch (e) {
          errEl.textContent = 'Invalid JSON: ' + e.message; errEl.style.display = 'block'; return;
        }
        if (!Array.isArray(tools) || !tools.length) {
          errEl.textContent = 'Must be a non-empty JSON array of tools'; errEl.style.display = 'block'; return;
        }
        for (let i = 0; i < tools.length; i++) {
          if (tools[i].type !== 'function' || !tools[i].function?.name) {
            errEl.textContent = `Tool ${i+1}: must have type "function" and function.name`; errEl.style.display = 'block'; return;
          }
        }
        try {
          const merged = [...(teCurrentSuite?.tools || []), ...tools];
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}`, {
            method: 'PUT',
            body: JSON.stringify({ tools: merged }),
          });
          if (!res.ok) { const d = await res.json().catch(()=>({})); showToast(d.error || 'Import failed', 'error'); return; }
          teCurrentSuite.tools = merged;
          teRenderToolsList();
          _closeModal(overlay);
          showToast(`Imported ${tools.length} tool${tools.length > 1 ? 's' : ''}`, 'success');
        } catch { showToast('Failed to import tools', 'error'); }
      };
      document.body.appendChild(overlay);
    }

    // --- Test Cases ---
    function teRenderCasesList() {
      const cases = teCurrentSuite?.test_cases || [];
      const container = document.getElementById('teCasesList');
      document.getElementById('teCaseCount').textContent = `(${cases.length})`;
      if (!cases.length) {
        container.innerHTML = '<p class="text-zinc-600 text-xs font-body">No test cases defined yet.</p>';
        return;
      }
      container.innerHTML = cases.map((c, i) => {
        const expTool = c.expected_tool;
        let expStr;
        if (expTool === null || expTool === undefined) {
          expStr = '<span class="text-zinc-600">(no tool call)</span>';
        } else if (Array.isArray(expTool)) {
          expStr = expTool.join(' | ');
        } else {
          expStr = expTool;
        }
        const paramsStr = c.expected_params ? '(' + Object.entries(c.expected_params).map(([k,v]) => `${k}=${JSON.stringify(v)}`).join(', ') + ')' : '';
        const mtBadge = c.multi_turn ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm ml-2" style="color:var(--lime);background:rgba(191,255,0,0.08);border:1px solid rgba(191,255,0,0.15)">MULTI-TURN</span>' : '';
        const scMode = c.scoring_config?.mode;
        const scBadge = scMode && scMode !== 'exact' ? `<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm ml-2" style="color:#60A5FA;background:rgba(96,165,250,0.08);border:1px solid rgba(96,165,250,0.15)" title="Scoring: ${scMode}">${scMode.replace('_', ' ').toUpperCase()}</span>` : '';
        return `<div class="flex items-start justify-between px-3 py-2 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);">
          <div class="flex-1 min-w-0">
            <div class="text-sm text-zinc-300 font-body mb-0.5">#${i+1} "${_teEsc(_teTruncate(c.prompt, 80))}"${mtBadge}${scBadge}</div>
            <div class="text-xs font-mono text-zinc-500">Expected: ${expStr}${paramsStr ? ' ' + _teEsc(paramsStr) : ''}</div>
          </div>
          <div class="flex gap-2 ml-3 flex-shrink-0 mt-1">
            <button onclick="teEditCase('${c.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300">Edit</button>
            <button onclick="teDeleteCase('${c.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-700 hover:text-red-400">Delete</button>
          </div>
        </div>`;
      }).join('');
    }

    function _teTruncate(s, max) {
      s = s || '';
      return s.length > max ? s.slice(0, max) + '...' : s;
    }

    function teAddCase() {
      teEditingCaseId = null;
      document.getElementById('teCasePrompt').value = '';
      document.getElementById('teCaseExpTool').value = '';
      document.getElementById('teCaseExpParams').value = '';
      document.getElementById('teCaseNoTool').checked = false;
      document.getElementById('teCaseExpTool').disabled = false;
      document.getElementById('teCaseScoringMode').value = 'exact';
      document.getElementById('teCaseEpsilon').value = '0.01';
      document.getElementById('teCaseScoringEpsilon').classList.add('hidden');
      document.getElementById('teCaseMultiTurn').checked = false;
      document.getElementById('teCaseMultiTurnSettings').classList.add('hidden');
      document.getElementById('teCaseMaxRounds').value = '5';
      document.getElementById('teCaseOptimalHops').value = '2';
      document.getElementById('teCasePrereqs').value = '';
      document.getElementById('teCaseMockResponses').value = '';
      document.getElementById('teCaseError').classList.add('hidden');
      document.getElementById('teCaseEditor').classList.remove('hidden');
    }

    function teEditCase(caseId) {
      const c = (teCurrentSuite?.test_cases || []).find(x => x.id === caseId);
      if (!c) return;
      teEditingCaseId = caseId;
      document.getElementById('teCasePrompt').value = c.prompt || '';
      const isNoTool = c.expected_tool === null || c.expected_tool === undefined;
      document.getElementById('teCaseNoTool').checked = isNoTool;
      document.getElementById('teCaseExpTool').disabled = isNoTool;
      if (isNoTool) {
        document.getElementById('teCaseExpTool').value = '';
      } else if (Array.isArray(c.expected_tool)) {
        document.getElementById('teCaseExpTool').value = c.expected_tool.join(', ');
      } else {
        document.getElementById('teCaseExpTool').value = c.expected_tool || '';
      }
      document.getElementById('teCaseExpParams').value = c.expected_params ? JSON.stringify(c.expected_params, null, 2) : '';
      // Scoring mode (S3)
      const sc = c.scoring_config || {};
      document.getElementById('teCaseScoringMode').value = sc.mode || 'exact';
      document.getElementById('teCaseEpsilon').value = sc.epsilon ?? 0.01;
      document.getElementById('teCaseScoringEpsilon').classList.toggle('hidden', (sc.mode || 'exact') !== 'numeric_tolerance');
      const isMultiTurn = !!c.multi_turn;
      document.getElementById('teCaseMultiTurn').checked = isMultiTurn;
      document.getElementById('teCaseMultiTurnSettings').classList.toggle('hidden', !isMultiTurn);
      document.getElementById('teCaseMaxRounds').value = c.max_rounds || 5;
      document.getElementById('teCaseOptimalHops').value = c.optimal_hops || 2;
      document.getElementById('teCasePrereqs').value = (c.valid_prerequisites || []).join(', ');
      document.getElementById('teCaseMockResponses').value = c.mock_responses ? JSON.stringify(c.mock_responses, null, 2) : '';
      document.getElementById('teCaseError').classList.add('hidden');
      document.getElementById('teCaseEditor').classList.remove('hidden');
    }

    function teCancelCaseEdit() {
      document.getElementById('teCaseEditor').classList.add('hidden');
      teEditingCaseId = null;
    }

    function teToggleNoTool() {
      const checked = document.getElementById('teCaseNoTool').checked;
      document.getElementById('teCaseExpTool').disabled = checked;
      if (checked) document.getElementById('teCaseExpTool').value = '';
    }

    function teToggleScoringEpsilon() {
      const mode = document.getElementById('teCaseScoringMode').value;
      document.getElementById('teCaseScoringEpsilon').classList.toggle('hidden', mode !== 'numeric_tolerance');
    }

    function teToggleMultiTurn() {
      const checked = document.getElementById('teCaseMultiTurn').checked;
      document.getElementById('teCaseMultiTurnSettings').classList.toggle('hidden', !checked);
    }

    async function teSaveCaseEdit() {
      const errEl = document.getElementById('teCaseError');
      const prompt = document.getElementById('teCasePrompt').value.trim();
      if (!prompt) { errEl.textContent = 'Prompt is required'; errEl.classList.remove('hidden'); return; }

      const isNoTool = document.getElementById('teCaseNoTool').checked;
      let expected_tool = null;
      if (!isNoTool) {
        const toolVal = document.getElementById('teCaseExpTool').value.trim();
        if (!toolVal) { errEl.textContent = 'Expected tool is required (or check "No tool expected")'; errEl.classList.remove('hidden'); return; }
        if (toolVal.includes(',')) {
          expected_tool = toolVal.split(',').map(s => s.trim()).filter(Boolean);
          if (!expected_tool.length) { errEl.textContent = 'Enter at least one tool name'; errEl.classList.remove('hidden'); return; }
        } else {
          expected_tool = toolVal;
        }
      }

      let expected_params = null;
      const paramsStr = document.getElementById('teCaseExpParams').value.trim();
      if (paramsStr) {
        try {
          expected_params = JSON.parse(paramsStr);
          if (typeof expected_params !== 'object' || Array.isArray(expected_params)) {
            errEl.textContent = 'Expected params must be a JSON object';
            errEl.classList.remove('hidden');
            return;
          }
        } catch (e) {
          errEl.textContent = 'Invalid JSON in expected params: ' + e.message;
          errEl.classList.remove('hidden');
          return;
        }
      }
      errEl.classList.add('hidden');

      const caseData = { prompt, expected_tool, expected_params };

      // Scoring config (S3 fuzzy scoring)
      const scoringMode = document.getElementById('teCaseScoringMode').value;
      if (scoringMode && scoringMode !== 'exact') {
        const sc = { mode: scoringMode };
        if (scoringMode === 'numeric_tolerance') {
          sc.epsilon = parseFloat(document.getElementById('teCaseEpsilon').value) || 0.01;
        }
        caseData.scoring_config = sc;
      } else {
        caseData.scoring_config = null;
      }

      // Multi-turn fields
      if (document.getElementById('teCaseMultiTurn').checked) {
        caseData.multi_turn = true;
        caseData.max_rounds = parseInt(document.getElementById('teCaseMaxRounds').value) || 5;
        caseData.optimal_hops = parseInt(document.getElementById('teCaseOptimalHops').value) || 2;
        const prereqs = document.getElementById('teCasePrereqs').value.trim();
        caseData.valid_prerequisites = prereqs ? prereqs.split(',').map(s => s.trim()).filter(Boolean) : [];
        const mockStr = document.getElementById('teCaseMockResponses').value.trim();
        if (mockStr) {
          try {
            caseData.mock_responses = JSON.parse(mockStr);
          } catch (e) {
            errEl.textContent = 'Invalid JSON in mock responses: ' + e.message;
            errEl.classList.remove('hidden');
            return;
          }
        }
      } else {
        caseData.multi_turn = false;
      }

      try {
        if (teEditingCaseId) {
          // Update existing
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}/cases/${teEditingCaseId}`, {
            method: 'PUT',
            body: JSON.stringify(caseData),
          });
          if (!res.ok) { showToast('Failed to save', 'error'); return; }
        } else {
          // Create new
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}/cases`, {
            method: 'POST',
            body: JSON.stringify(caseData),
          });
          if (!res.ok) { showToast('Failed to save', 'error'); return; }
        }
        // Reload suite to get updated case list
        await teOpenSuite(teCurrentSuite.id);
        teCancelCaseEdit();
        showToast('Test case saved', 'success');
      } catch { showToast('Failed to save test case', 'error'); }
    }

    function teDeleteCase(caseId) {
      showModal('Delete Test Case', 'Delete this test case?', async () => {
        try {
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}/cases/${caseId}`, { method: 'DELETE' });
          if (!res.ok) { showToast('Failed to delete', 'error'); return; }
          await teOpenSuite(teCurrentSuite.id);
          showToast('Test case deleted', 'success');
        } catch { showToast('Failed to delete', 'error'); }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    function teImportCasesJson() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `<div class="modal-box" style="max-width:600px;">
        <div class="modal-title">Import Test Cases (JSON)</div>
        <div class="modal-message">Paste a JSON array of test cases. Each must have "prompt" and "expected_tool" fields.</div>
        <textarea class="modal-input font-mono text-xs" style="height:200px;resize:vertical;margin-bottom:16px;" placeholder='[{"prompt":"...","expected_tool":"...","expected_params":{...}}]'></textarea>
        <div class="text-xs mb-3" style="color:var(--coral);display:none;" id="teImportErr"></div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">Import</button>
        </div>
      </div>`;
      const textarea = overlay.querySelector('textarea');
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = async () => {
        const errEl = overlay.querySelector('#teImportErr');
        let cases;
        try {
          cases = JSON.parse(textarea.value.trim());
        } catch (e) {
          errEl.textContent = 'Invalid JSON: ' + e.message;
          errEl.style.display = 'block';
          return;
        }
        if (!Array.isArray(cases) || !cases.length) {
          errEl.textContent = 'Must be a non-empty JSON array';
          errEl.style.display = 'block';
          return;
        }
        for (let i = 0; i < cases.length; i++) {
          if (!cases[i].prompt) {
            errEl.textContent = `Case ${i+1}: "prompt" is required`;
            errEl.style.display = 'block';
            return;
          }
        }
        try {
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}/cases`, {
            method: 'POST',
            body: JSON.stringify({ cases }),
          });
          if (!res.ok) { showToast('Import failed', 'error'); return; }
          _closeModal(overlay);
          await teOpenSuite(teCurrentSuite.id);
          showToast(`Imported ${cases.length} test cases`, 'success');
        } catch { showToast('Import failed', 'error'); }
      };
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => textarea.focus(), 50);
    }

    // --- Run Eval ---
    function teStartRunFromEditor() {
      if (!teCurrentSuite) return;
      const cases = teCurrentSuite.test_cases || [];
      if (!cases.length) { showToast('Add at least one test case first', 'error'); return; }
      const tools = teCurrentSuite.tools || [];
      if (!tools.length) { showToast('Add at least one tool first', 'error'); return; }
      teRunSuiteId = teCurrentSuite.id;
      _scSetSuite(teCurrentSuite.id, teCurrentSuite.name);
      document.getElementById('teRunTitle').textContent = 'Run Eval: ' + (teCurrentSuite.name || 'Untitled');
      teRenderEvalModelGrid();
      _teResetRunView();
      _teApplyDefaults();
      showToolEvalView('run');
    }

    function _teApplyDefaults() {
      // Skip if param tuner best config was applied (don't overwrite tuner results)
      if (_ptConfigApplied) return;
      // Apply saved Phase 10 settings as defaults for this run
      if (!_p10Settings) return;
      const j = _p10Settings.judge || {};
      // Judge defaults
      const jToggle = document.getElementById('jgToggle');
      if (jToggle && j.enabled) {
        jToggle.checked = true;
        jgTogglePanel(); // triggers panel show + model populate
        const jModel = document.getElementById('jgJudgeModel');
        if (jModel && j.model_id) {
          const ck = j.provider_key ? (j.provider_key + '::' + j.model_id) : j.model_id;
          jModel.value = ck;
        }
        const jMode = document.getElementById('jgMode');
        if (jMode && j.mode) jMode.value = j.mode;
      }
    }

    function _ptApplyDefaults() {
      if (!_p10Settings) return;
      const pt = _p10Settings.param_tuner || {};
      // Store defaults for dynamic rendering — ptRenderDynamicParams reads _ptDefaults
      _ptDefaults = {};
      if (pt.temp_min !== undefined) _ptDefaults.temperature_min = pt.temp_min;
      if (pt.temp_max !== undefined) _ptDefaults.temperature_max = pt.temp_max;
      if (pt.temp_step !== undefined) _ptDefaults.temperature_step = pt.temp_step;
      if (pt.top_p_min !== undefined) _ptDefaults.top_p_min = pt.top_p_min;
      if (pt.top_p_max !== undefined) _ptDefaults.top_p_max = pt.top_p_max;
      if (pt.top_p_step !== undefined) _ptDefaults.top_p_step = pt.top_p_step;
      // If params are already rendered, re-apply to existing DOM elements
      for (const [key, val] of Object.entries(_ptDefaults)) {
        const el = document.getElementById('pt_' + key);
        if (el && val !== undefined) el.value = val;
      }
    }

    function _prtApplyDefaults() {
      if (!_p10Settings) return;
      const prt = _p10Settings.prompt_tuner || {};
      if (prt.mode) prtSetMode(prt.mode);
      const fields = {
        prtGenerations: prt.generations,
        prtPopSize: prt.population_size,
      };
      for (const [id, val] of Object.entries(fields)) {
        const el = document.getElementById(id);
        if (el && val !== undefined) el.value = val;
      }
    }

    function teBackFromRun() {
      if (teRunSuiteId && teCurrentSuite?.id === teRunSuiteId) {
        showToolEvalView('editor');
      } else {
        showToolEvalView('suites');
      }
    }

    function teRenderEvalModelGrid() {
      const grid = document.getElementById('teModelGrid');
      grid.innerHTML = '';
      teSelectedModels.clear();
      if (!config || !config.providers) return;

      // Pre-select from shared context if available
      const scModels = _scGetModels();

      for (const [provider, provData] of Object.entries(config.providers)) {
        const color = getColor(provider);
        const models = getProviderModels(provData);
        if (!models.length) continue;

        const group = document.createElement('div');
        group.className = 'provider-group';
        group.style.borderColor = color.border;

        const header = document.createElement('div');
        header.className = 'provider-group-header';
        header.innerHTML = `
          <div class="provider-group-dot" style="background:${color.text}"></div>
          <span class="provider-group-label" style="color:${color.text}">${provider}</span>
          <span class="provider-group-count">${models.length}</span>
        `;
        header.onclick = () => {
          const cards = group.querySelectorAll('.model-card');
          const allSel = [...cards].every(c => c.classList.contains('selected'));
          cards.forEach(c => {
            const ck = c.dataset.compoundKey;
            if (allSel) { teSelectedModels.delete(ck); c.classList.remove('selected'); }
            else { teSelectedModels.add(ck); c.classList.add('selected'); }
          });
          _scSetModels(teSelectedModels);
          ppOnModelSelectionChange('tooleval');
        };
        group.appendChild(header);

        const subgrid = document.createElement('div');
        subgrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 pl-3';
        for (const m of models) {
          const ck = (provData.provider_key || provider) + '::' + m.model_id;
          const card = document.createElement('div');
          card.className = 'model-card rounded-sm px-4 py-3 flex items-center gap-3';
          card.dataset.modelId = m.model_id;
          card.dataset.compoundKey = ck;
          card.dataset.providerKey = provData.provider_key || provider;
          // Pre-select from shared context
          if (scModels.size > 0 && scModels.has(ck)) {
            teSelectedModels.add(ck);
            card.classList.add('selected');
          }
          card.onclick = (e) => {
            e.stopPropagation();
            if (teSelectedModels.has(ck)) {
              teSelectedModels.delete(ck);
              card.classList.remove('selected');
            } else {
              teSelectedModels.add(ck);
              card.classList.add('selected');
            }
            _scSetModels(teSelectedModels);
            ppOnModelSelectionChange('tooleval');
          };
          card.innerHTML = `
            <div class="check-dot flex-shrink-0"></div>
            <div class="flex-1 min-w-0">
              <div class="text-[13px] font-medium text-zinc-200 truncate font-body">${m.display_name}</div>
            </div>
          `;
          subgrid.appendChild(card);
        }
        group.appendChild(subgrid);
        grid.appendChild(group);
      }
      // If pre-selection happened, trigger param panel update
      if (teSelectedModels.size > 0 && scModels.size > 0) {
        ppOnModelSelectionChange('tooleval');
      }
    }

    function teSelectAllModels() {
      document.querySelectorAll('#teModelGrid .model-card').forEach(c => {
        teSelectedModels.add(c.dataset.compoundKey);
        c.classList.add('selected');
      });
      ppOnModelSelectionChange('tooleval');
    }

    function teClearModels() {
      teSelectedModels.clear();
      document.querySelectorAll('#teModelGrid .model-card').forEach(c => c.classList.remove('selected'));
      ppOnModelSelectionChange('tooleval');
    }

    function _teResetRunView() {
      teEvalResults = [];
      teEvalSummaries = [];
      _activeToolEvalJobId = null;
      document.getElementById('teProgressSection').classList.add('hidden');
      document.getElementById('teSummarySection').classList.add('hidden');
      document.getElementById('teDetailSection').classList.add('hidden');
      document.getElementById('teLiveSection').classList.add('hidden');
      document.getElementById('teSSEBanner').classList.add('hidden');
      document.getElementById('jgProgressSection')?.classList.add('hidden');
      document.getElementById('teLiveBody').innerHTML = '';
      document.getElementById('teSummaryBody').innerHTML = '';
      document.getElementById('teStartBtn').disabled = false;
      document.getElementById('teStartBtn').innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Start Eval';
      document.getElementById('teCancelEvalBtn').classList.add('hidden');
      document.getElementById('teExportBtn').classList.add('hidden');
      document.getElementById('teActionBridges')?.classList.add('hidden');
      document.getElementById('teDeltaBanner')?.classList.add('hidden');
      document.getElementById('tePinBaselineBtn')?.classList.add('hidden');
      window.teLastEvalId = null;
    }

    async function teStartEval() {
      if (teSelectedModels.size === 0) { showToast('Select at least one model', 'error'); return; }
      if (!teRunSuiteId) { showToast('No suite selected', 'error'); return; }

      const btn = document.getElementById('teStartBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Submitting...';
      document.getElementById('teCancelEvalBtn').classList.remove('hidden');

      teEvalResults = [];
      teEvalSummaries = [];
      _teEvalStartTime = Date.now();
      document.getElementById('teLiveBody').innerHTML = '';
      document.getElementById('teSummaryBody').innerHTML = '';
      document.getElementById('teProgressSection').classList.remove('hidden');
      document.getElementById('teLiveSection').classList.remove('hidden');
      document.getElementById('teSummarySection').classList.add('hidden');
      document.getElementById('teDetailSection').classList.add('hidden');
      document.getElementById('teSSEBanner').classList.add('hidden');
      document.getElementById('jgProgressSection')?.classList.add('hidden');
      document.getElementById('teProgressBar').style.width = '0%';
      document.getElementById('teProgressLabel').textContent = 'Initializing...';
      document.getElementById('teProgressCount').textContent = '0/0';

      const tePpParams = ppCollectParams('tooleval');
      const teJudgeConfig = jgGetConfig();
      const judgeConcurrency = _p10Settings?.judge?.concurrency || 4;
      const teTemp = parseFloat(document.getElementById('teTemperature').value) || 0.0;
      const teTC = document.getElementById('teToolChoice').value;
      // Write current config to shared context
      _scSetConfig({ temperature: teTemp, tool_choice: teTC });
      const body = {
        suite_id: teRunSuiteId,
        targets: Array.from(teSelectedModels).map(k => { const i = k.indexOf('::'); return { provider_key: k.substring(0, i), model_id: k.substring(i + 2) }; }),
        temperature: teTemp,
        tool_choice: teTC,
        judge_concurrency: judgeConcurrency,
        ...(tePpParams ? { provider_params: tePpParams } : {}),
        ...(teJudgeConfig ? { judge: teJudgeConfig } : {}),
      };
      // Include experiment_id from shared context
      if (_sharedContext.experiment_id) body.experiment_id = _sharedContext.experiment_id;
      // Include system_prompt if available (shared context, Phase 2)
      if (_sharedContext.system_prompt) {
        body.system_prompt = _sharedContext.system_prompt;
      }

      // Reset judge state
      jgVerdicts = [];
      jgReport = null;
      document.getElementById('jgReportSection')?.classList.add('hidden');
      document.getElementById('jgActionBridges')?.classList.add('hidden');
      document.getElementById('jgVerdicts') && (document.getElementById('jgVerdicts').innerHTML = '');
      // Show/hide judge column in live results table
      const jgColHeader = document.getElementById('jgLiveColHeader');
      if (jgColHeader) jgColHeader.classList.toggle('hidden', !teJudgeConfig);

      try {
        const res = await apiFetch('/api/tool-eval', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (res.status === 409) {
          showToast('A benchmark or eval is already running', 'error');
          _teResetStartBtn();
          return;
        }
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || `Server error (${res.status})`, 'error');
          _teResetStartBtn();
          return;
        }

        // New job-based response: {job_id, status}
        const data = await res.json();
        _activeToolEvalJobId = data.job_id;

        // Store in sessionStorage for reconnection
        try { sessionStorage.setItem('_teJobId', data.job_id); } catch {}

        // Update UI to show job is submitted
        btn.innerHTML = '<svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Running...';
        document.getElementById('teProgressLabel').textContent = data.status === 'submitted' ? 'Eval queued...' : 'Eval starting...';
        showToast('Eval submitted', 'success');

        // Progress updates now arrive via WebSocket (handled by _onToolEvalJobEvent)
        // User can navigate away - the notification widget tracks progress independently

      } catch (e) {
        console.error('Eval error:', e);
        _teShowSSEError('Connection error: ' + (e.message || 'Network failure'));
        _teResetStartBtn();
      }
    }

    function _teResetStartBtn() {
      const btn = document.getElementById('teStartBtn');
      btn.disabled = false;
      btn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Start Eval';
      document.getElementById('teCancelEvalBtn').classList.add('hidden');
    }

    function _teShowSSEError(msg) {
      const banner = document.getElementById('teSSEBanner');
      document.getElementById('teSSEBannerMsg').textContent = msg;
      banner.classList.remove('hidden');
    }

    async function teCancelEval() {
      if (_activeToolEvalJobId) {
        await notifCancelJob(_activeToolEvalJobId);
        const job = _jobStore[_activeToolEvalJobId];
        if (job && !ACTIVE_STATUSES.has(job.status)) {
          _activeToolEvalJobId = null;
          try { sessionStorage.removeItem('_teJobId'); } catch {}
        }
      } else {
        // Legacy fallback
        try {
          await apiFetch('/api/tool-eval/cancel', { method: 'POST' });
          showToast('Cancellation requested...', '');
        } catch { showToast('Failed to cancel', 'error'); }
      }
    }

    function _teHandleSSE(data) {
      if (data.type === 'progress') {
        const pct = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
        document.getElementById('teProgressBar').style.width = pct + '%';
        document.getElementById('teProgressCount').textContent = `${data.current}/${data.total}`;
        document.getElementById('teProgressLabel').textContent = `Testing ${data.model || ''}...`;
      }

      if (data.type === 'result') {
        teEvalResults.push(data);
        _teAddLiveRow(data);
      }

      if (data.type === 'model_summary') {
        teEvalSummaries.push(data);
        teRenderSummaryTable();
        document.getElementById('teSummarySection').classList.remove('hidden');
      }

      if (data.type === 'complete') {
        document.getElementById('teProgressLabel').textContent = 'Complete!';
        document.getElementById('teProgressBar').style.width = '100%';
        const total = teEvalResults.length;
        const models = teEvalSummaries.length;
        document.getElementById('teSummaryInfo').textContent = `${total} evaluations across ${models} model${models > 1 ? 's' : ''}`;
        if (data.eval_id) {
          window.teLastEvalId = data.eval_id;
          document.getElementById('teExportBtn').classList.remove('hidden');
        }
        showToast('Eval complete!', 'success');
        // Refresh history
        teLoadHistory();
      }

      if (data.type === 'cancelled') {
        document.getElementById('teProgressLabel').textContent = 'Cancelled';
        showToast('Eval cancelled', '');
      }

      if (data.type === 'error') {
        _teShowSSEError(data.message || 'Unknown error');
      }

      // Judge SSE events (integrated into eval stream)
      if (data.type === 'judge_start' || data.type === 'judge_verdict' ||
          data.type === 'judge_report' || data.type === 'judge_complete') {
        jgHandleSSE(data);
      }

      // heartbeat: just resets timeout (handled in resetTimeout)
    }

    // ── WebSocket event bridge for inline tool eval + judge progress ──
    // Called by _notifHandleWsMessage for any tool_eval, judge, or judge_compare job events
    function _onToolEvalJobEvent(msg) {
      const isToolEval = _activeToolEvalJobId && msg.job_id === _activeToolEvalJobId;
      const isJudge = _activeJudgeJobId && msg.job_id === _activeJudgeJobId;
      if (!isToolEval && !isJudge) return;

      switch (msg.type) {
        case 'job_started':
          if (isToolEval) {
            document.getElementById('teProgressLabel').textContent = 'Eval running...';
            _teEvalStartTime = Date.now();
          }
          if (isJudge) {
            document.getElementById('jgReportStatus').textContent = 'Judge running...';
          }
          break;

        case 'tool_eval_init': {
          const data = msg.data || msg;
          _teEvalTotalCases = (data.targets ? data.targets.length : 0) * (data.total_cases || 0);
          document.getElementById('teProgressCount').textContent = `0/${_teEvalTotalCases}`;
          document.getElementById('teProgressLabel').textContent = `Evaluating ${data.suite_name || ''}...`;
          break;
        }

        case 'job_progress': {
          if (isToolEval) {
            const pct = msg.progress_pct || 0;
            document.getElementById('teProgressBar').style.width = pct + '%';
            document.getElementById('teProgressLabel').textContent = msg.progress_detail || 'Running...';
          }
          if (isJudge) {
            const pct = msg.progress_pct || 0;
            const jgBar = document.getElementById('jgProgressBar');
            const jgCount = document.getElementById('jgProgressCount');
            if (jgBar) jgBar.style.width = pct + '%';
            if (jgCount) jgCount.textContent = msg.progress_detail || (pct + '%');
            // ETA calculation for judge
            const etaEl = document.getElementById('jgProgressETA');
            if (etaEl && pct > 0 && pct < 100) {
              const elapsed = (Date.now() - (_jgStartTime || Date.now())) / 1000;
              const remaining = (elapsed / pct) * (100 - pct);
              etaEl.textContent = remaining > 60 ? Math.ceil(remaining / 60) + 'm left' : Math.ceil(remaining) + 's left';
            }
          }
          break;
        }

        // Tool eval streaming events
        case 'tool_eval_result': {
          const data = msg.data || msg;
          teEvalResults.push(data);
          _teAddLiveRow(data);
          // Update progress count
          if (_teEvalTotalCases > 0) {
            const pct = Math.round((teEvalResults.length / _teEvalTotalCases) * 100);
            document.getElementById('teProgressBar').style.width = pct + '%';
            document.getElementById('teProgressCount').textContent = `${teEvalResults.length}/${_teEvalTotalCases}`;
          }
          break;
        }

        case 'tool_eval_progress': {
          const data = msg.data || msg;
          _teEvalTotalCases = data.total || _teEvalTotalCases;
          const pct = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
          document.getElementById('teProgressBar').style.width = pct + '%';
          document.getElementById('teProgressCount').textContent = `${data.current}/${data.total}`;
          document.getElementById('teProgressLabel').textContent = `Testing ${data.model || ''}...`;
          // ETA for eval
          if (_teEvalStartTime && pct > 0 && pct < 100) {
            const elapsed = (Date.now() - _teEvalStartTime) / 1000;
            const remaining = (elapsed / pct) * (100 - pct);
            const etaText = remaining > 60 ? Math.ceil(remaining / 60) + 'm left' : Math.ceil(remaining) + 's left';
            document.getElementById('teProgressLabel').textContent += ' \u2014 ' + etaText;
          }
          break;
        }

        case 'tool_eval_summary': {
          const data = msg.data || msg;
          teEvalSummaries.push(data);
          teRenderSummaryTable();
          document.getElementById('teSummarySection').classList.remove('hidden');
          break;
        }

        case 'tool_eval_complete': {
          const data = msg.data || msg;
          document.getElementById('teProgressLabel').textContent = 'Complete!';
          document.getElementById('teProgressBar').style.width = '100%';
          const total = teEvalResults.length;
          const models = teEvalSummaries.length;
          document.getElementById('teSummaryInfo').textContent = `${total} evaluations across ${models} model${models > 1 ? 's' : ''}`;
          if (data.eval_id) {
            window.teLastEvalId = data.eval_id;
            document.getElementById('teExportBtn').classList.remove('hidden');
          }
          // Bridge A: show action bridges on eval complete
          document.getElementById('teActionBridges')?.classList.remove('hidden');
          // M6: Show "Pin as Baseline" button if experiment is active
          const pinBtn = document.getElementById('tePinBaselineBtn');
          if (pinBtn) {
            if (_sharedContext.experiment_id) pinBtn.classList.remove('hidden');
            else pinBtn.classList.add('hidden');
          }
          // M6: Delta banner
          if (data.delta !== undefined && data.delta !== null) {
            const banner = document.getElementById('teDeltaBanner');
            if (banner) {
              const pct = (data.delta * 100).toFixed(1);
              const sign = data.delta >= 0 ? '+' : '';
              const color = data.delta >= 0 ? '#22C55E' : '#EF4444';
              banner.innerHTML = `vs. baseline: <span style="color:${color};font-weight:700">${sign}${pct}%</span>`;
              banner.style.border = `1px solid ${data.delta >= 0 ? 'rgba(34,197,94,0.3)' : 'rgba(239,68,68,0.3)'}`;
              banner.classList.remove('hidden');
            }
            if (data.baseline_score !== undefined) {
              _sharedContext._baseline_score = data.baseline_score;
              _scSave();
            }
          }
          showToast('Eval complete!', 'success');
          teLoadHistory();
          _teResetStartBtn();
          _activeToolEvalJobId = null;
          _teEvalStartTime = null;
          try { sessionStorage.removeItem('_teJobId'); } catch {}
          break;
        }

        // Judge streaming events (both inline and standalone)
        case 'judge_start': {
          const data = msg.data || msg;
          _jgStartTime = Date.now();
          document.getElementById('jgProgressSection')?.classList.remove('hidden');
          jgHandleSSE({ type: 'judge_start', ...(data || {}) });
          break;
        }

        case 'judge_verdict': {
          const data = msg.data || msg;
          jgHandleSSE({ type: 'judge_verdict', ...(data || {}) });
          // Update judge progress bar
          const jgBar = document.getElementById('jgProgressBar');
          const jgCount = document.getElementById('jgProgressCount');
          if (jgBar && data.current && data.total) {
            const pct = Math.round((data.current / data.total) * 100);
            jgBar.style.width = pct + '%';
            if (jgCount) jgCount.textContent = `${data.current}/${data.total}`;
          }
          break;
        }

        case 'judge_progress': {
          const data = msg.data || msg;
          const jgBar = document.getElementById('jgProgressBar');
          const jgCount = document.getElementById('jgProgressCount');
          if (jgBar && data.current !== undefined && data.total) {
            const pct = Math.round((data.current / data.total) * 100);
            jgBar.style.width = pct + '%';
            if (jgCount) jgCount.textContent = `${data.current}/${data.total}`;
          }
          break;
        }

        case 'judge_report': {
          const data = msg.data || msg;
          jgHandleSSE({ type: 'judge_report', report: data.report || data });
          break;
        }

        case 'judge_complete': {
          const data = msg.data || msg;
          jgHandleSSE({ type: 'judge_complete', ...(data || {}) });
          document.getElementById('jgProgressSection')?.classList.add('hidden');
          if (isJudge) {
            _activeJudgeJobId = null;
          }
          break;
        }

        // Comparative judge events
        case 'compare_start': {
          const data = msg.data || msg;
          jgHandleSSE({ type: 'compare_start', ...(data || {}) });
          break;
        }

        case 'compare_case': {
          const data = msg.data || msg;
          jgHandleSSE({ type: 'compare_case', ...(data || {}) });
          break;
        }

        case 'compare_complete': {
          const data = msg.data || msg;
          jgHandleSSE({ type: 'compare_complete', ...(data || {}) });
          if (isJudge) _activeJudgeJobId = null;
          break;
        }

        case 'eval_promoted': {
          showToast('Best result promoted to eval history', 'success');
          // Refresh history if suites view is visible
          teLoadHistory();
          break;
        }

        case 'job_completed':
          if (isToolEval) {
            // Handled by tool_eval_complete; this is the generic job completion
            _teResetStartBtn();
            _activeToolEvalJobId = null;
            _teEvalStartTime = null;
            try { sessionStorage.removeItem('_teJobId'); } catch {}
            teLoadHistory();
          }
          if (isJudge) {
            _activeJudgeJobId = null;
            document.getElementById('jgProgressSection')?.classList.add('hidden');
          }
          break;

        case 'job_failed':
          if (isToolEval) {
            _teShowSSEError(msg.error || msg.error_msg || 'Eval failed');
            _teResetStartBtn();
            _activeToolEvalJobId = null;
            _teEvalStartTime = null;
            try { sessionStorage.removeItem('_teJobId'); } catch {}
          }
          if (isJudge) {
            showToast('Judge failed: ' + (msg.error || msg.error_msg || 'Unknown error'), 'error');
            document.getElementById('jgReportStatus').textContent = 'Failed';
            document.getElementById('jgProgressSection')?.classList.add('hidden');
            _activeJudgeJobId = null;
          }
          break;

        case 'job_cancelled':
          if (isToolEval) {
            document.getElementById('teProgressLabel').textContent = 'Cancelled';
            showToast('Eval cancelled', '');
            _teResetStartBtn();
            _activeToolEvalJobId = null;
            _teEvalStartTime = null;
            try { sessionStorage.removeItem('_teJobId'); } catch {}
          }
          if (isJudge) {
            showToast('Judge cancelled', '');
            document.getElementById('jgReportStatus').textContent = 'Cancelled';
            document.getElementById('jgProgressSection')?.classList.add('hidden');
            _activeJudgeJobId = null;
          }
          break;
      }
    }

    // Judge ETA tracking
    let _jgStartTime = null;

    // Restore running eval view after page navigation or reconnect
    function _teRestoreRunningEval() {
      showToolEvalView('run');
      const job = _jobStore[_activeToolEvalJobId];
      if (!job) return;

      // Show progress section with current state from job store
      document.getElementById('teProgressSection').classList.remove('hidden');
      document.getElementById('teLiveSection').classList.remove('hidden');
      const pct = job.progress_pct || 0;
      document.getElementById('teProgressBar').style.width = pct + '%';
      document.getElementById('teProgressLabel').textContent = job.progress_detail || 'Eval running...';

      // Set button to running state
      const btn = document.getElementById('teStartBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Running...';
      document.getElementById('teCancelEvalBtn').classList.remove('hidden');
    }

    function _teScoreColor(pct) {
      if (pct >= 80) return 'var(--lime)';
      if (pct >= 50) return '#FBBF24';
      return 'var(--coral)';
    }

    function _teAddLiveRow(r) {
      const body = document.getElementById('teLiveBody');
      const overallPct = (r.overall_score * 100).toFixed(0);
      const color = _teScoreColor(r.overall_score * 100);
      const actualTool = r.actual_tool || '(none)';
      const expectedTool = r.expected_tool || '(none)';
      const prompt = _teTruncate(r.prompt || r.test_case_id || '', 40);
      const hops = r.multi_turn ? (r.tool_chain?.length || 1) : '';
      const hopsTitle = r.tool_chain ? r.tool_chain.map(c => c.tool_name).join(' \u2192 ') : '';
      body.insertAdjacentHTML('beforeend', `<tr data-model-id="${_teEsc(r.model_id || '')}" data-case-id="${_teEsc(r.test_case_id || '')}">
        <td class="px-5 py-2 text-xs font-mono text-zinc-300">${_teEsc(r.model_name || r.model_id || '')}</td>
        <td class="px-5 py-2 text-xs font-body text-zinc-400">${_teEsc(prompt)}</td>
        <td class="px-5 py-2 text-xs font-mono text-zinc-500">${_teEsc(typeof expectedTool === 'object' ? JSON.stringify(expectedTool) : expectedTool)}</td>
        <td class="px-5 py-2 text-xs font-mono" style="color:${r.tool_selection_score > 0 ? 'var(--lime)' : 'var(--coral)'}">${_teEsc(actualTool)}</td>
        <td class="px-5 py-2 text-right text-xs font-mono text-zinc-500" title="${_teEsc(hopsTitle)}">${hops}</td>
        <td class="px-5 py-2 text-right text-xs font-mono font-bold" style="color:${color}">${overallPct}%</td>
      </tr>`);
      // Auto-scroll
      const liveDiv = document.getElementById('teLiveResults');
      liveDiv.scrollTop = liveDiv.scrollHeight;
    }

    function teRenderSummaryTable() {
      const sorted = [...teEvalSummaries].sort((a, b) => {
        const aVal = a[teSummarySortKey] ?? 0;
        const bVal = b[teSummarySortKey] ?? 0;
        if (typeof aVal === 'string') return teSummarySortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        return teSummarySortAsc ? aVal - bVal : bVal - aVal;
      });

      const body = document.getElementById('teSummaryBody');
      body.innerHTML = sorted.map(s => {
        const toolColor = _teScoreColor(s.tool_accuracy_pct);
        const paramColor = _teScoreColor(s.param_accuracy_pct ?? 0);
        const overallColor = _teScoreColor(s.overall_pct);
        return `<tr class="cursor-pointer" onclick="teShowModelDetail('${_teEsc(s.model_id)}')">
          <td class="px-5 py-3 text-sm font-body text-zinc-200">${_teEsc(s.model_name || s.model_id)}</td>
          <td class="px-5 py-3 text-right text-sm font-mono font-bold" style="color:${toolColor}">${(s.tool_accuracy_pct ?? 0).toFixed(1)}%</td>
          <td class="px-5 py-3 text-right text-sm font-mono font-bold" style="color:${paramColor}">${s.param_accuracy_pct != null ? s.param_accuracy_pct.toFixed(1) + '%' : '-'}</td>
          <td class="px-5 py-3 text-right text-sm font-mono font-bold" style="color:${overallColor}">${(s.overall_pct ?? 0).toFixed(1)}%</td>
          <td class="px-5 py-3 text-right text-xs font-mono text-zinc-500">${s.cases_run || 0}</td>
        </tr>`;
      }).join('');
    }

    function teSortSummary(key) {
      if (teSummarySortKey === key) {
        teSummarySortAsc = !teSummarySortAsc;
      } else {
        teSummarySortKey = key;
        teSummarySortAsc = key === 'model_name';
      }
      teRenderSummaryTable();
    }

    function teShowModelDetail(modelId) {
      const results = teEvalResults.filter(r => r.model_id === modelId);
      if (!results.length) return;
      const content = document.getElementById('teDetailContent');
      const modelName = results[0].model_name || modelId;
      content.innerHTML = `<div class="text-sm font-display font-semibold text-zinc-200 tracking-wider uppercase mb-3">${_teEsc(modelName)}</div>` +
        results.map((r, i) => {
          const expTool = r.expected_tool;
          let expStr;
          if (expTool === null || expTool === undefined) expStr = '(no tool call)';
          else if (Array.isArray(expTool)) expStr = expTool.join(' | ');
          else expStr = expTool;

          const actTool = r.actual_tool || '(no tool call)';
          const expParams = r.expected_params ? JSON.stringify(r.expected_params) : '';
          const actParams = r.actual_params ? JSON.stringify(r.actual_params) : '';
          const match = r.tool_selection_score === 1.0;
          const icon = match ? '<span style="color:var(--lime)">OK</span>' : '<span style="color:var(--coral)">X</span>';

          // Multi-turn chain visualization
          const chainSection = r.multi_turn && r.tool_chain?.length ? `
            <div class="mt-1 font-mono text-[10px]">
              <span class="text-zinc-600">Chain:</span>
              <span style="color:var(--lime)">${r.tool_chain.map(c => c.tool_name).join(' \u2192 ')}</span>
              <span class="text-zinc-600 ml-1">(${r.rounds_used || r.tool_chain.length} round${(r.rounds_used || r.tool_chain.length) > 1 ? 's' : ''})</span>
            </div>
            <div class="mt-1 grid grid-cols-4 gap-2 text-[10px] font-mono">
              <span class="text-zinc-500">Completion: <span style="color:var(--lime)">${((r.completion_score || 0) * 100).toFixed(0)}%</span></span>
              <span class="text-zinc-500">Efficiency: <span style="color:var(--lime)">${((r.efficiency_score || 0) * 100).toFixed(0)}%</span></span>
              <span class="text-zinc-500">Redundancy: <span style="color:var(--coral)">-${((r.redundancy_penalty || 0) * 100).toFixed(0)}%</span></span>
              <span class="text-zinc-500">Detour: <span style="color:var(--coral)">-${((r.detour_penalty || 0) * 100).toFixed(0)}%</span></span>
            </div>` : '';

          // For multi-turn, show all exchanges instead of single request/response
          const hasRaw = r.raw_request || r.raw_response;
          const rawData = r.multi_turn && r.raw_exchanges?.length
            ? r.raw_exchanges
            : (hasRaw ? [{request: r.raw_request, response: r.raw_response}] : []);

          const rawSection = rawData.length ? `
            <div class="mt-2">
              <button onclick="this.nextElementSibling.classList.toggle('hidden')"
                class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm"
                style="color:var(--lime);border:1px solid rgba(191,255,0,0.15)">VIEW RAW${r.multi_turn ? ' (' + rawData.length + ' round' + (rawData.length > 1 ? 's' : '') + ')' : ''}</button>
              <div class="hidden mt-2 space-y-2" style="max-height:400px;overflow-y:auto">
                ${rawData.map((ex, idx) => `
                  ${r.multi_turn ? '<div class="text-[10px] font-display tracking-wider text-zinc-400 uppercase">Round ' + (idx + 1) + '</div>' : ''}
                  ${ex.request ? `<div class="mb-1">
                    <div class="text-[10px] font-display tracking-wider text-zinc-500 uppercase mb-1">Request</div>
                    <pre class="text-[10px] font-mono text-zinc-400 p-2 rounded-sm overflow-x-auto" style="background:rgba(0,0,0,0.3);border:1px solid var(--border-subtle);white-space:pre-wrap;word-break:break-all">${_teEsc(JSON.stringify(ex.request, null, 2))}</pre>
                  </div>` : ''}
                  ${ex.response ? `<div>
                    <div class="text-[10px] font-display tracking-wider text-zinc-500 uppercase mb-1">Response</div>
                    <pre class="text-[10px] font-mono text-zinc-400 p-2 rounded-sm overflow-x-auto" style="background:rgba(0,0,0,0.3);border:1px solid var(--border-subtle);white-space:pre-wrap;word-break:break-all">${_teEsc(JSON.stringify(ex.response, null, 2))}</pre>
                  </div>` : ''}
                `).join('')}
              </div>
            </div>` : '';

          return `<div class="px-3 py-2 rounded-sm text-xs" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);">
            <div class="text-zinc-300 font-body mb-1">#${i+1} "${_teEsc(_teTruncate(r.prompt || '', 80))}"</div>
            <div class="font-mono text-zinc-500">Expected: ${_teEsc(expStr)}${expParams ? '(' + _teEsc(expParams) + ')' : ''}</div>
            <div class="font-mono" style="color:${match ? 'var(--lime)' : 'var(--coral)'}">Actual: &nbsp; ${_teEsc(actTool)}${actParams ? '(' + _teEsc(actParams) + ')' : ''} ${icon}</div>
            ${chainSection}
            ${r.error ? '<div style="color:var(--coral)">Error: ' + _teEsc(r.error) + '</div>' : ''}
            ${rawSection}
          </div>`;
        }).join('');
      document.getElementById('teDetailSection').classList.remove('hidden');
    }

    // --- Eval History ---
    async function teLoadHistory() {
      try {
        const res = await apiFetch('/api/tool-eval/history');
        if (!res.ok) return;
        const data = await res.json();
        teEvalHistory = data.runs || [];
        teRenderHistory();
      } catch {}
    }

    function _teBuildConfigSummary(config) {
      if (!config) return '';
      const parts = [];
      if (config.temperature !== undefined) parts.push('temp=' + config.temperature);
      if (config.tool_choice) parts.push('tool_choice=' + config.tool_choice);
      if (config.provider_params) {
        Object.entries(config.provider_params).sort().forEach(([k, v]) => parts.push(k + '=' + v));
      }
      if (config.system_prompt) parts.push("prompt='" + config.system_prompt.slice(0, 30) + "...'");
      return parts.join(', ') || 'defaults';
    }

    // --- Bridge A: Eval Results -> Tune Parameters / Tune Prompt ---
    function teBridgeToParamTuner() {
      _scSetSuite(teRunSuiteId, document.getElementById('teRunTitle')?.textContent?.replace(/^(Run Eval|History): /, '') || '');
      _scSetModels(teSelectedModels);
      _scSetConfig({
        temperature: parseFloat(document.getElementById('teTemperature')?.value) || 0.0,
        tool_choice: document.getElementById('teToolChoice')?.value || 'required',
      });
      _sharedContext.last_updated_by = 'tool_eval';
      _scSave();
      showToolEvalView('pt-config');
    }

    function teBridgeToPromptTuner() {
      _scSetSuite(teRunSuiteId, document.getElementById('teRunTitle')?.textContent?.replace(/^(Run Eval|History): /, '') || '');
      _scSetModels(teSelectedModels);
      _scSetConfig({
        temperature: parseFloat(document.getElementById('teTemperature')?.value) || 0.0,
        tool_choice: document.getElementById('teToolChoice')?.value || 'required',
      });
      _sharedContext.last_updated_by = 'tool_eval';
      _scSave();
      showToolEvalView('prt-config');
    }

    // --- M6: Pin as Baseline ---
    async function tePinAsBaseline() {
      const expId = _sharedContext.experiment_id;
      if (!expId || !window.teLastEvalId) { showToast('No experiment or eval run', 'error'); return; }
      try {
        const res = await apiFetch(`/api/experiments/${expId}/baseline`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eval_run_id: window.teLastEvalId }),
        });
        if (res.ok) {
          const data = await res.json();
          showToast(`Baseline set (score: ${(data.baseline_score * 100).toFixed(1)}%)`, 'success');
          _sharedContext._baseline_score = data.baseline_score;
          _scSave();
        } else {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || 'Failed to pin baseline', 'error');
        }
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // --- M6: Pin from history row ---
    async function tePinHistoryAsBaseline(runId) {
      const expId = _sharedContext.experiment_id;
      if (!expId) { showToast('No experiment active', 'error'); return; }
      try {
        const res = await apiFetch(`/api/experiments/${expId}/baseline`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ eval_run_id: runId }),
        });
        if (res.ok) {
          const data = await res.json();
          showToast(`Baseline set (score: ${(data.baseline_score * 100).toFixed(1)}%)`, 'success');
          _sharedContext._baseline_score = data.baseline_score;
          _scSave();
          teLoadHistory();
        } else {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || 'Failed to pin baseline', 'error');
        }
      } catch (e) { showToast('Error: ' + e.message, 'error'); }
    }

    // --- Bridge C: Prompt Tuner Best -> Save to Suite / Apply & Re-Eval ---
    async function prtSaveToSuite() {
      if (!prtBestPrompt) { showToast('No best prompt available', 'error'); return; }
      const suiteId = _sharedContext.suite_id || document.getElementById('prtSuiteSelect')?.value;
      if (!suiteId) { showToast('No suite selected', 'error'); return; }
      showModal('Save Prompt to Suite',
        `Save the best prompt as the default system prompt for "${_sharedContext.suite_name || 'this suite'}"?`,
        async () => {
          try {
            const res = await apiFetch(`/api/tool-suites/${suiteId}`, {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ system_prompt: prtBestPrompt }),
            });
            if (res.ok) { showToast('Prompt saved to suite', 'success'); }
            else { const err = await res.json().catch(() => ({})); showToast(err.error || 'Failed', 'error'); }
          } catch (e) { showToast('Error: ' + e.message, 'error'); }
        },
        { confirmLabel: 'Save' }
      );
    }

    async function prtApplyAndReEval() {
      if (!prtBestPrompt) { showToast('No best prompt available', 'error'); return; }
      showModal('Apply & Re-Eval', 'Re-run eval with the best prompt as system prompt?',
        async () => {
          _sharedContext.system_prompt = prtBestPrompt;
          _sharedContext.last_updated_by = 'prompt_tuner';
          _scSave();
          showToolEvalView('run');
          await new Promise(r => setTimeout(r, 300));
          teStartEval();
        },
        { confirmLabel: 'Start Eval' }
      );
    }

    // --- Bridge D: Judge Report -> Next Steps ---
    function jgBridgeToParamTuner() {
      _sharedContext.last_updated_by = 'judge';
      _scSave();
      showToolEvalView('pt-config');
    }
    function jgBridgeToPromptTuner() {
      const recs = Array.from(document.querySelectorAll('#jgRecommendations li'))
        .map(li => li.textContent.trim()).filter(Boolean).join('\n');
      if (recs) _sharedContext.prompt_tuner_hint = recs;
      _sharedContext.last_updated_by = 'judge';
      _scSave();
      showToolEvalView('prt-config');
    }
    function jgBridgeToReEval() {
      _sharedContext.last_updated_by = 'judge';
      _scSave();
      showToolEvalView('run');
    }

    function _teJudgeGradeColor(grade) {
      if (!grade) return '#85858F';
      const g = grade.charAt(0).toUpperCase();
      if (g === 'A') return '#22C55E';
      if (g === 'B') return '#38BDF8';
      if (g === 'C') return '#EAB308';
      if (g === 'D') return '#F97316';
      if (g === 'F') return '#EF4444';
      return '#85858F';
    }

    function _tePromotedBadge(config) {
      if (!config || !config.promoted_from) return '';
      const src = config.promoted_from;
      let label = 'promoted';
      if (src.startsWith('param_tune:')) label = 'from param tune';
      else if (src.startsWith('prompt_tune:')) label = 'from prompt tune';
      return ` <span class="text-[9px] px-1.5 py-0.5 rounded" style="background:rgba(168,85,247,0.15);color:#A855F7;">${label}</span>`;
    }

    function teRenderHistory() {
      const body = document.getElementById('teHistoryBody');
      const hasExperiment = !!_sharedContext.experiment_id;
      const baselineScore = _sharedContext._baseline_score;
      if (!teEvalHistory.length) {
        body.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No eval runs yet.</td></tr>';
        return;
      }
      body.innerHTML = teEvalHistory.map(r => {
        const models = r.models || (r.models_json ? (typeof r.models_json === 'string' ? JSON.parse(r.models_json) : r.models_json) : []);
        const summaries = r.summary || (r.summary_json ? (typeof r.summary_json === 'string' ? JSON.parse(r.summary_json) : r.summary_json) : []);
        const avgOverall = summaries.length > 0 ? (summaries.reduce((s, x) => s + (x.overall_pct || 0), 0) / summaries.length).toFixed(1) : '-';
        const overallColor = avgOverall !== '-' ? _teScoreColor(parseFloat(avgOverall)) : '#85858F';
        const ts = _teTimeAgo(r.timestamp);
        const modelStr = models.length <= 2 ? models.join(', ') : models.length + ' models';
        const configSummary = r.config ? _teBuildConfigSummary(r.config) : '';
        const promotedBadge = _tePromotedBadge(r.config);
        const configCell = configSummary
          ? `<span class="text-[10px] font-mono text-zinc-600" title="${_teEsc(configSummary)}">${_teEsc(configSummary.length > 40 ? configSummary.slice(0, 40) + '...' : configSummary)}</span>${promotedBadge}`
          : (promotedBadge || '<span class="text-zinc-700 text-[10px]">-</span>');
        // Judge grade badge (M5)
        const judgeGrade = r.judge_grade;
        const judgeColor = _teJudgeGradeColor(judgeGrade);
        const judgeCell = judgeGrade
          ? `<span class="text-[10px] font-mono font-bold px-1.5 py-0.5 rounded" style="background:${judgeColor}20;color:${judgeColor}">${_teEsc(judgeGrade)}</span>`
          : '<span class="text-zinc-700 text-[10px]">--</span>';
        // M6: Delta column when experiment is active
        let deltaCell = '';
        if (hasExperiment && baselineScore != null && avgOverall !== '-') {
          const runScore = parseFloat(avgOverall) / 100;
          const delta = runScore - baselineScore;
          const deltaPct = (delta * 100).toFixed(1);
          const sign = delta >= 0 ? '+' : '';
          const dColor = delta >= 0 ? '#22C55E' : '#EF4444';
          deltaCell = `<td class="px-3 py-3 text-right text-xs font-mono font-bold" style="color:${dColor}">${sign}${deltaPct}%</td>`;
        } else if (hasExperiment) {
          deltaCell = '<td class="px-3 py-3 text-right text-xs text-zinc-700">--</td>';
        }
        // M6: Pin as baseline button in actions
        const pinBtn = hasExperiment
          ? `<button onclick="tePinHistoryAsBaseline('${r.id}')" class="text-[10px] font-display tracking-wider uppercase mr-2" style="color:var(--lime);opacity:0.5" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.5'" title="Pin as baseline">Pin</button>`
          : '';
        return `<tr>
          <td class="px-5 py-3 text-xs text-zinc-500 font-body">${ts}</td>
          <td class="px-5 py-3 text-sm font-body text-zinc-300">${_teEsc(r.suite_name || '')}</td>
          <td class="px-5 py-3 text-xs font-mono text-zinc-500">${_teEsc(modelStr)}</td>
          <td class="px-5 py-3 text-xs">${configCell}</td>
          <td class="px-5 py-3 text-center">${judgeCell}</td>
          ${deltaCell}
          <td class="px-5 py-3 text-right text-sm font-mono font-bold" style="color:${overallColor}">${avgOverall}${avgOverall !== '-' ? '%' : ''}</td>
          <td class="px-5 py-3 text-right">
            ${pinBtn}<button onclick="teViewHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 mr-2">View</button>
            <button onclick="jgJudgeFromHistory('${r.id}')" class="text-[10px] font-display tracking-wider uppercase mr-2" style="color:#F59E0B;opacity:0.6" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">Judge</button>
            <button onclick="teExportResults('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 mr-2" style="color:var(--lime);opacity:0.6" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">Export</button>
            <button onclick="teDeleteHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-700 hover:text-red-400">Delete</button>
          </td>
        </tr>`;
      }).join('');
    }

    async function teViewHistoryRun(runId) {
      try {
        const res = await apiFetch(`/api/tool-eval/history/${runId}`);
        if (!res.ok) { showToast('Failed to load run details', 'error'); return; }
        const run = await res.json();

        // Parse stored JSON fields
        const results = run.results || (typeof run.results_json === 'string' ? JSON.parse(run.results_json) : []);
        const summaries = run.summary || (typeof run.summary_json === 'string' ? JSON.parse(run.summary_json) : []);

        // Populate run view with historical data
        teRunSuiteId = run.suite_id;
        document.getElementById('teRunTitle').textContent = 'History: ' + (run.suite_name || 'Untitled');
        teRenderEvalModelGrid();
        _teResetRunView();
        _teApplyDefaults();

        // Populate results
        teEvalResults = results;
        teEvalSummaries = summaries;

        // Show summary
        teRenderSummaryTable();
        document.getElementById('teSummarySection').classList.remove('hidden');
        const total = results.length;
        const models = summaries.length;
        document.getElementById('teSummaryInfo').textContent = `${total} evaluations across ${models} model${models > 1 ? 's' : ''}`;

        // Enable export for this history run
        window.teLastEvalId = runId;
        document.getElementById('teExportBtn').classList.remove('hidden');

        // Show live results
        document.getElementById('teLiveSection').classList.remove('hidden');
        const liveBody = document.getElementById('teLiveBody');
        liveBody.innerHTML = '';
        results.forEach(r => _teAddLiveRow(r));

        showToolEvalView('run');
      } catch (e) {
        showToast('Failed to load run', 'error');
      }
    }

    function teDeleteHistoryRun(runId) {
      showModal('Delete Eval Run', 'Delete this eval run? This cannot be undone.', async () => {
        try {
          const res = await apiFetch(`/api/tool-eval/history/${runId}`, { method: 'DELETE' });
          if (!res.ok) { showToast('Failed to delete', 'error'); return; }
          showToast('Eval run deleted', 'success');
          await teLoadHistory();
        } catch { showToast('Failed to delete', 'error'); }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    async function teExportResults(evalId) {
      const id = evalId || window.teLastEvalId;
      if (!id) return;
      try {
        const res = await apiFetch('/api/export/eval/' + id);
        if (!res.ok) { showToast('Export failed', 'error'); return; }
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'eval-' + id.slice(0, 8) + '.json';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Eval results exported');
      } catch (e) { showToast('Export failed', 'error'); }
    }

    // --- Settings Export / Import ---
    async function exportSettings() {
      try {
        const res = await apiFetch('/api/export/settings');
        if (!res.ok) { showToast('Export failed: ' + (await res.text()), 'error'); return; }
        const disposition = res.headers.get('Content-Disposition');
        let filename = 'benchmark-settings.json';
        if (disposition) {
          const match = disposition.match(/filename="?([^";\s]+)"?/);
          if (match) filename = match[1];
        }
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('Settings exported', 'success');
      } catch (e) {
        showToast('Export failed', 'error');
      }
    }

    function importSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.style.display = 'none';
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!data.export_version) {
            showToast('Invalid settings file: missing export_version', 'error');
            return;
          }
          const providerCount = data.providers ? Object.keys(data.providers).length : 0;
          showModal('Import Settings',
            `Import ${providerCount} provider${providerCount !== 1 ? 's' : ''}? This will merge with your existing settings.`,
            async () => {
              try {
                const res = await apiFetch('/api/import/settings', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
                });
                if (!res.ok) {
                  const err = await res.json().catch(() => ({}));
                  showToast(err.detail || 'Import failed', 'error');
                  return;
                }
                showToast('Settings imported successfully', 'success');
                await refreshConfig();
                renderSettings();
              } catch (e) {
                showToast('Import failed: ' + e.message, 'error');
              }
            },
            { confirmLabel: 'Import' }
          );
        } catch (e) {
          showToast('Invalid JSON file', 'error');
        }
        input.remove();
      };
      document.body.appendChild(input);
      input.click();
    }

    // -------------------------------------------------------------------
    // Phase 10 Settings — Load, Save, Toggle
    // -------------------------------------------------------------------
    let _p10Settings = null; // cached settings from API
    let _p10SaveTimer = null;

    function p10ToggleSection(sectionId) {
      const el = document.getElementById(sectionId);
      const chevron = document.getElementById(sectionId + '-chevron');
      if (!el) return;
      const isHidden = el.classList.contains('hidden');
      el.classList.toggle('hidden');
      if (chevron) chevron.style.transform = isHidden ? 'rotate(180deg)' : '';
    }

    async function p10Load() {
      try {
        const res = await apiFetch('/api/settings/phase10');
        if (!res.ok) return;
        _p10Settings = await res.json();
        p10PopulateUI();
      } catch { /* silent */ }
    }

    function p10PopulateJudgeModelDropdown() {
      const sel = document.getElementById('p10JudgeModel');
      if (!sel || !config || !config.providers) return;
      const savedPk = _p10Settings?.judge?.provider_key || '';
      const savedMid = _p10Settings?.judge?.model_id || '';
      const savedCompound = savedPk && savedMid ? (savedPk + '::' + savedMid) : savedMid;
      const current = sel.value || savedCompound;
      let html = '<option value="">-- Select a model --</option>';
      for (const [provName, provData] of Object.entries(config.providers)) {
        const pk = provData.provider_key || provName;
        const models = getProviderModels(provData);
        for (const m of models) {
          const ck = pk + '::' + m.model_id;
          html += `<option value="${ck}" ${ck === current ? 'selected' : ''}>${m.display_name || m.model_id} (${provName})</option>`;
        }
      }
      sel.innerHTML = html;
    }

    function p10PopulateUI() {
      if (!_p10Settings) return;
      const j = _p10Settings.judge || {};
      const pt = _p10Settings.param_tuner || {};
      const prt = _p10Settings.prompt_tuner || {};

      // Judge
      p10PopulateJudgeModelDropdown();
      const jmSel = document.getElementById('p10JudgeModel');
      if (jmSel && j.model_id) {
        const ck = j.provider_key ? (j.provider_key + '::' + j.model_id) : j.model_id;
        jmSel.value = ck;
      }
      const jmMode = document.getElementById('p10JudgeMode');
      if (jmMode && j.mode) jmMode.value = j.mode;
      const jTemp = document.getElementById('p10JudgeTemp');
      if (jTemp && j.temperature !== undefined) jTemp.value = j.temperature;
      const jMax = document.getElementById('p10JudgeMaxTokens');
      if (jMax && j.max_tokens) jMax.value = j.max_tokens;
      const jEnabled = document.getElementById('p10JudgeEnabled');
      if (jEnabled) jEnabled.checked = !!j.enabled;
      const jInstr = document.getElementById('p10JudgeInstructions');
      if (jInstr && j.custom_instructions) jInstr.value = j.custom_instructions;
      const jConc = document.getElementById('p10JudgeConcurrency');
      if (jConc && j.concurrency) jConc.value = j.concurrency;

      // Parameter Tuner
      const ptFields = {
        p10PtMaxCombos: pt.max_combinations,
        p10PtTempMin: pt.temp_min, p10PtTempMax: pt.temp_max, p10PtTempStep: pt.temp_step,
        p10PtTopPMin: pt.top_p_min, p10PtTopPMax: pt.top_p_max, p10PtTopPStep: pt.top_p_step,
      };
      for (const [id, val] of Object.entries(ptFields)) {
        const el = document.getElementById(id);
        if (el && val !== undefined) el.value = val;
      }

      // Prompt Tuner
      const prtMode = document.getElementById('p10PrtMode');
      if (prtMode && prt.mode) prtMode.value = prt.mode;
      const prtFields = {
        p10PrtMaxCalls: prt.max_api_calls,
        p10PrtGenerations: prt.generations,
        p10PrtPopulation: prt.population_size,
      };
      for (const [id, val] of Object.entries(prtFields)) {
        const el = document.getElementById(id);
        if (el && val !== undefined) el.value = val;
      }

      // Param Support config
      psInit();
    }

    // -------------------------------------------------------------------
    // Param Support Configuration (ps prefix)
    // -------------------------------------------------------------------
    let _psCurrentProvider = null;

    function psInit() {
      // Called after p10Load — check if param_support exists
      const ps = _p10Settings?.param_support;
      if (ps && ps.provider_defaults && Object.keys(ps.provider_defaults).length > 0) {
        document.getElementById('psNotSeeded')?.classList.add('hidden');
        document.getElementById('psConfigured')?.classList.remove('hidden');
        psPopulateProviderDropdown();
        psRenderProvider();
      } else {
        // Auto-seed on first visit
        document.getElementById('psNotSeeded')?.classList.remove('hidden');
        document.getElementById('psConfigured')?.classList.add('hidden');
        psSeedAndLoad(); // auto-trigger seed
      }
    }

    async function psSeedAndLoad() {
      try {
        const res = await apiFetch('/api/param-support/seed', { method: 'POST' });
        if (!res.ok) { showToast('Failed to seed param support', 'error'); return; }
        const data = await res.json();
        // Save to settings
        if (!_p10Settings) _p10Settings = {};
        _p10Settings.param_support = data;
        await _psSaveParamSupport(data);
        psInit();
        showToast('Parameter support initialized', 'success');
      } catch {
        showToast('Failed to seed param support', 'error');
      }
    }

    async function psResetToDefaults() {
      showModal('Reset Parameter Support', 'Reset all provider parameter configs to defaults from the registry? User presets will be preserved.', async () => {
        await psSeedAndLoad();
      }, { confirmLabel: 'Reset' });
    }

    function psPopulateProviderDropdown() {
      const sel = document.getElementById('psProviderSelect');
      if (!sel) return;
      const ps = _p10Settings?.param_support;
      if (!ps?.provider_defaults) return;
      const current = sel.value || _psCurrentProvider;
      sel.innerHTML = '';
      const providers = Object.keys(ps.provider_defaults).sort();
      for (const pk of providers) {
        const displayName = ps.provider_defaults[pk]?.display_name || pk;
        sel.innerHTML += `<option value="${pk}" ${pk === current ? 'selected' : ''}>${_teEsc(displayName)}</option>`;
      }
      if (!current && providers.length > 0) {
        _psCurrentProvider = providers[0];
      } else {
        _psCurrentProvider = current;
      }
    }

    function psRenderProvider() {
      const sel = document.getElementById('psProviderSelect');
      if (!sel) return;
      _psCurrentProvider = sel.value;
      const ps = _p10Settings?.param_support;
      if (!ps?.provider_defaults || !_psCurrentProvider) return;

      const provData = ps.provider_defaults[_psCurrentProvider];
      if (!provData) return;
      const params = provData.params || {};
      const container = document.getElementById('psParamTable');
      if (!container) return;

      if (Object.keys(params).length === 0) {
        container.innerHTML = '<div class="text-xs text-zinc-600 font-body text-center py-3">No parameters configured for this provider.</div>';
        psRenderOverrides();
        return;
      }

      // Build table
      let html = `<div class="overflow-x-auto"><table class="w-full text-xs">
        <thead><tr style="border-bottom:1px solid var(--border-subtle)">
          <th class="px-2 py-1.5 text-left text-[10px] font-display tracking-wider uppercase text-zinc-500">Param</th>
          <th class="px-2 py-1.5 text-center text-[10px] font-display tracking-wider uppercase text-zinc-500">Enabled</th>
          <th class="px-2 py-1.5 text-center text-[10px] font-display tracking-wider uppercase text-zinc-500">Type</th>
          <th class="px-2 py-1.5 text-right text-[10px] font-display tracking-wider uppercase text-zinc-500">Min</th>
          <th class="px-2 py-1.5 text-right text-[10px] font-display tracking-wider uppercase text-zinc-500">Max</th>
          <th class="px-2 py-1.5 text-right text-[10px] font-display tracking-wider uppercase text-zinc-500">Step</th>
          <th class="px-2 py-1.5 text-right text-[10px] font-display tracking-wider uppercase text-zinc-500">Default</th>
          <th class="px-2 py-1.5 text-center text-[10px] font-display tracking-wider uppercase text-zinc-500"></th>
        </tr></thead><tbody>`;

      const _inp = 'px-2 py-1 rounded-sm text-xs font-mono text-zinc-200';
      const _inpS = 'background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;width:70px;';

      for (const [pname, spec] of Object.entries(params)) {
        const isNum = spec.type === 'float' || spec.type === 'int';
        const isEnum = spec.type === 'enum';
        html += `<tr data-ps-param="${_teEsc(pname)}" style="border-bottom:1px solid rgba(255,255,255,0.03)">
          <td class="px-2 py-2 font-mono text-zinc-300">${_teEsc(pname)}</td>
          <td class="px-2 py-2 text-center">
            <input type="checkbox" ${spec.enabled !== false ? 'checked' : ''} onchange="psOnParamChange('${_teEsc(pname)}','enabled',this.checked)" class="accent-lime-accent">
          </td>
          <td class="px-2 py-2 text-center text-zinc-500">${spec.type || '-'}</td>
          <td class="px-2 py-2 text-right">${isNum ? `<input type="number" value="${spec.min ?? ''}" class="${_inp}" style="${_inpS}" onchange="psOnParamChange('${_teEsc(pname)}','min',parseFloat(this.value))">` : '-'}</td>
          <td class="px-2 py-2 text-right">${isNum ? `<input type="number" value="${spec.max ?? ''}" class="${_inp}" style="${_inpS}" onchange="psOnParamChange('${_teEsc(pname)}','max',parseFloat(this.value))">` : '-'}</td>
          <td class="px-2 py-2 text-right">${isNum ? `<input type="number" value="${spec.step ?? ''}" class="${_inp}" style="${_inpS}" onchange="psOnParamChange('${_teEsc(pname)}','step',parseFloat(this.value))">` : '-'}</td>
          <td class="px-2 py-2 text-right">${spec.default !== undefined ? `<input type="${isNum ? 'number' : 'text'}" value="${spec.default ?? ''}" class="${_inp}" style="${_inpS}" onchange="psOnParamChange('${_teEsc(pname)}','default',${isNum ? 'parseFloat(this.value)' : 'this.value'})">` : '-'}</td>
          <td class="px-2 py-2 text-center">
            <button onclick="psRemoveParam('${_teEsc(pname)}')" class="text-zinc-700 hover:text-red-400 transition-colors" title="Remove">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </td>
        </tr>`;
      }

      html += '</tbody></table></div>';
      container.innerHTML = html;

      psRenderOverrides();
    }

    function psRenderOverrides() {
      const container = document.getElementById('psOverridesTable');
      if (!container) return;
      const ps = _p10Settings?.param_support;
      if (!ps?.model_overrides || !_psCurrentProvider) { container.innerHTML = ''; return; }
      const overrides = ps.model_overrides[_psCurrentProvider] || {};

      if (Object.keys(overrides).length === 0) {
        container.innerHTML = '<div class="text-xs text-zinc-600 font-body text-center py-2">No model-specific overrides.</div>';
        return;
      }

      let html = '<div class="space-y-2">';
      for (const [modelPattern, modelOverride] of Object.entries(overrides)) {
        html += `<div class="rounded-sm p-2" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);">
          <div class="flex items-center justify-between mb-1">
            <span class="text-xs font-mono text-zinc-400">${_teEsc(modelPattern)}</span>
            <button onclick="psRemoveOverride('${_teEsc(modelPattern)}')" class="text-zinc-700 hover:text-red-400 transition-colors" title="Remove override">
              <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>
          </div>
          <div class="text-[10px] font-mono text-zinc-600">${_teEsc(JSON.stringify(modelOverride))}</div>
        </div>`;
      }
      html += '</div>';
      container.innerHTML = html;
    }

    function psOnParamChange(paramName, field, value) {
      const ps = _p10Settings?.param_support;
      if (!ps?.provider_defaults?.[_psCurrentProvider]?.params?.[paramName]) return;
      ps.provider_defaults[_psCurrentProvider].params[paramName][field] = value;
      _psSaveDebounced();
    }

    function psRemoveParam(paramName) {
      const ps = _p10Settings?.param_support;
      if (!ps?.provider_defaults?.[_psCurrentProvider]?.params) return;
      delete ps.provider_defaults[_psCurrentProvider].params[paramName];
      psRenderProvider();
      _psSaveDebounced();
    }

    function psAddParam() {
      showInputModal('Add Parameter', 'Parameter name (e.g. top_k)', (name) => {
        if (!name || !name.trim()) return;
        name = name.trim();
        const ps = _p10Settings?.param_support;
        if (!ps?.provider_defaults?.[_psCurrentProvider]) return;
        if (!ps.provider_defaults[_psCurrentProvider].params) ps.provider_defaults[_psCurrentProvider].params = {};
        if (ps.provider_defaults[_psCurrentProvider].params[name]) {
          showToast('Parameter already exists', 'error');
          return;
        }
        ps.provider_defaults[_psCurrentProvider].params[name] = {
          enabled: true, type: 'float', min: 0, max: 1, step: 0.1, default: 0,
        };
        psRenderProvider();
        _psSaveDebounced();
        showToast(`Parameter "${name}" added`, 'success');
      });
    }

    function psAddOverride() {
      showInputModal('Add Model Override', 'Model ID pattern (e.g. gpt-4o, *-mini)', (pattern) => {
        if (!pattern || !pattern.trim()) return;
        pattern = pattern.trim();
        const ps = _p10Settings?.param_support;
        if (!ps) return;
        if (!ps.model_overrides) ps.model_overrides = {};
        if (!ps.model_overrides[_psCurrentProvider]) ps.model_overrides[_psCurrentProvider] = {};
        if (ps.model_overrides[_psCurrentProvider][pattern]) {
          showToast('Override already exists for this model', 'error');
          return;
        }
        ps.model_overrides[_psCurrentProvider][pattern] = {};
        psRenderOverrides();
        _psSaveDebounced();
        showToast(`Override for "${pattern}" added`, 'success');
      });
    }

    function psRemoveOverride(pattern) {
      const ps = _p10Settings?.param_support;
      if (!ps?.model_overrides?.[_psCurrentProvider]) return;
      delete ps.model_overrides[_psCurrentProvider][pattern];
      if (Object.keys(ps.model_overrides[_psCurrentProvider]).length === 0) {
        delete ps.model_overrides[_psCurrentProvider];
      }
      psRenderOverrides();
      _psSaveDebounced();
    }

    let _psSaveTimer = null;
    function _psSaveDebounced() {
      if (_psSaveTimer) clearTimeout(_psSaveTimer);
      _psSaveTimer = setTimeout(() => {
        _psSaveParamSupport(_p10Settings.param_support);
      }, 600);
    }

    async function _psSaveParamSupport(data) {
      try {
        await apiFetch('/api/settings/phase10', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ param_support: data }),
        });
      } catch {
        showToast('Failed to save param support config', 'error');
      }
    }

    function p10CollectUI() {
      const _p10JudgeRaw = document.getElementById('p10JudgeModel')?.value || '';
      const _p10JudgeParsed = _p10JudgeRaw.includes('::') ? _bmParseCompoundKey(_p10JudgeRaw) : { provider_key: '', model_id: _p10JudgeRaw };
      return {
        judge: {
          enabled: document.getElementById('p10JudgeEnabled')?.checked || false,
          model_id: _p10JudgeParsed.model_id,
          provider_key: _p10JudgeParsed.provider_key,
          mode: document.getElementById('p10JudgeMode')?.value || 'post_eval',
          temperature: parseFloat(document.getElementById('p10JudgeTemp')?.value) || 0.0,
          max_tokens: parseInt(document.getElementById('p10JudgeMaxTokens')?.value) || 4096,
          custom_instructions: document.getElementById('p10JudgeInstructions')?.value || '',
          concurrency: parseInt(document.getElementById('p10JudgeConcurrency')?.value) || 4,
        },
        param_tuner: {
          max_combinations: parseInt(document.getElementById('p10PtMaxCombos')?.value) || 50,
          temp_min: parseFloat(document.getElementById('p10PtTempMin')?.value) || 0,
          temp_max: parseFloat(document.getElementById('p10PtTempMax')?.value) || 1,
          temp_step: parseFloat(document.getElementById('p10PtTempStep')?.value) || 0.5,
          top_p_min: parseFloat(document.getElementById('p10PtTopPMin')?.value) || 0.5,
          top_p_max: parseFloat(document.getElementById('p10PtTopPMax')?.value) || 1,
          top_p_step: parseFloat(document.getElementById('p10PtTopPStep')?.value) || 0.25,
        },
        prompt_tuner: {
          mode: document.getElementById('p10PrtMode')?.value || 'quick',
          max_api_calls: parseInt(document.getElementById('p10PrtMaxCalls')?.value) || 100,
          generations: parseInt(document.getElementById('p10PrtGenerations')?.value) || 3,
          population_size: parseInt(document.getElementById('p10PrtPopulation')?.value) || 5,
        },
      };
    }

    function p10Save() {
      // Debounce saves — 500ms after last change
      if (_p10SaveTimer) clearTimeout(_p10SaveTimer);
      _p10SaveTimer = setTimeout(async () => {
        const data = p10CollectUI();
        try {
          await apiFetch('/api/settings/phase10', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data),
          });
          _p10Settings = data;
          showToast('Settings saved', 'success');
        } catch {
          showToast('Failed to save settings', 'error');
        }
      }, 500);
    }

    // --- Export CSV ---
    async function downloadCSV(url, filename) {
      const token = localStorage.getItem('auth_token');
      try {
        const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
        if (!resp.ok) { showToast('Export failed', 'error'); return; }
        const blob = await resp.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('CSV exported', 'success');
      } catch (e) {
        showToast('Export failed', 'error');
      }
    }

    // --- Onboarding Wizard ---
    let onbSelectedProvider = null;

    function showOnboardingWizard() {
      const overlay = document.getElementById('onboarding-overlay');
      overlay.style.display = 'flex';
      onbSelectedProvider = null;
      document.getElementById('onb-key-input-area').style.display = 'none';
      document.getElementById('onb-custom-area').style.display = 'none';
      document.querySelectorAll('.onb-provider-card').forEach(c => {
        c.style.borderColor = 'var(--border-subtle)';
        c.style.background = 'var(--surface)';
      });
    }

    function onbSelectProvider(provider, keyEnv, providerKey, cardEl) {
      onbSelectedProvider = provider;
      // Reset all cards
      document.querySelectorAll('.onb-provider-card').forEach(c => {
        c.style.borderColor = 'var(--border-subtle)';
        c.style.background = 'var(--surface)';
      });
      // Highlight selected
      cardEl.style.borderColor = 'var(--lime)';
      cardEl.style.background = 'var(--lime-dim)';

      if (provider === 'custom') {
        document.getElementById('onb-key-input-area').style.display = 'none';
        document.getElementById('onb-custom-area').style.display = 'block';
      } else {
        document.getElementById('onb-custom-area').style.display = 'none';
        const area = document.getElementById('onb-key-input-area');
        area.style.display = 'block';
        document.getElementById('onb-key-label').textContent = keyEnv;
        document.getElementById('onb-key-input').value = '';
        document.getElementById('onb-key-input').placeholder = 'Paste your ' + provider + ' API key';
        document.getElementById('onb-key-input').dataset.keyEnv = keyEnv;
        document.getElementById('onb-key-input').dataset.providerKey = providerKey;
        document.getElementById('onb-key-save-status').textContent = '';
      }
    }

    async function onbSaveKey() {
      const input = document.getElementById('onb-key-input');
      const providerKey = input.dataset.providerKey;
      const keyVal = input.value.trim();
      const status = document.getElementById('onb-key-save-status');
      if (!keyVal) { status.textContent = 'Please enter a key'; status.style.color = 'var(--coral)'; return; }
      try {
        const res = await apiFetch('/api/keys', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider_key: providerKey, value: keyVal })
        });
        if (res.ok) {
          status.textContent = 'Saved!';
          status.style.color = 'var(--lime)';
        } else {
          const data = await res.json().catch(() => ({}));
          status.textContent = data.detail || 'Failed to save';
          status.style.color = 'var(--coral)';
        }
      } catch {
        status.textContent = 'Connection error';
        status.style.color = 'var(--coral)';
      }
    }

    function onbNext(step) {
      document.getElementById('onb-step-1').style.display = 'none';
      document.getElementById('onb-step-2').style.display = 'none';
      document.getElementById('onb-step-3').style.display = 'none';
      document.getElementById('onb-step-' + step).style.display = 'block';
    }

    function onbSkip() { onbComplete(); }

    async function onbComplete() {
      const token = localStorage.getItem('auth_token');
      try {
        await fetch('/api/onboarding/complete', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
      } catch {}
      document.getElementById('onboarding-overlay').style.display = 'none';
    }

    async function checkOnboarding() {
      try {
        const token = localStorage.getItem('auth_token');
        const res = await fetch('/api/onboarding/status', { headers: { 'Authorization': 'Bearer ' + token } });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.completed) showOnboardingWizard();
      } catch {}
    }

    // --- Landing page functions ---
    function showLandingPage() {
      document.getElementById('landingPage').style.display = 'block';
      document.getElementById('appHeader').style.display = 'none';
      document.getElementById('appMain').style.display = 'none';
    }

    function hideLandingPage() {
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('appHeader').style.display = '';
      document.getElementById('appMain').style.display = '';
    }

    // --- Auth functions ---
    let authMode = 'login';

    function showAuthModal() {
      document.getElementById('authModal').style.display = 'flex';
      document.getElementById('authEmail').focus();
    }

    function hideAuthModal() {
      document.getElementById('authModal').style.display = 'none';
      document.getElementById('authError').style.display = 'none';
    }

    function switchAuthTab(mode) {
      authMode = mode;
      document.getElementById('authTabLogin').classList.toggle('tab-active', mode === 'login');
      document.getElementById('authTabRegister').classList.toggle('tab-active', mode === 'register');
      document.getElementById('authSubmitBtn').textContent = mode === 'login' ? 'Login' : 'Create Account';
      document.getElementById('authError').style.display = 'none';
    }

    async function handleAuth(e) {
      e.preventDefault();
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const endpoint = authMode === 'login' ? '/api/auth/login' : '/api/auth/register';

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (!res.ok) {
          document.getElementById('authError').textContent = data.error || 'Authentication failed';
          document.getElementById('authError').style.display = 'block';
          return;
        }
        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('auth_token', authToken);
        updateAuthUI();
        hideAuthModal();
        hideLandingPage();
        init();
        notifInit();
        checkOnboarding();
      } catch (err) {
        document.getElementById('authError').textContent = 'Connection error';
        document.getElementById('authError').style.display = 'block';
      }
    }

    async function handleLogout() {
      notifDestroy();
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      authToken = null;
      currentUser = null;
      localStorage.removeItem('auth_token');
      updateAuthUI();
      showLandingPage();
    }

    function updateAuthUI() {
      const menu = document.getElementById('userMenu');
      const adminTab = document.getElementById('tab-admin');
      if (currentUser) {
        menu.style.display = 'flex';
        document.getElementById('userEmail').textContent = currentUser.email;
        adminTab.style.display = currentUser.role === 'admin' ? '' : 'none';
      } else {
        menu.style.display = 'none';
        adminTab.style.display = 'none';
      }
    }

    // -------------------------------------------------------------------
    // Boot: check auth state before loading app
    // -------------------------------------------------------------------
    (async () => {
      if (authToken) {
        try {
          const res = await apiFetch('/api/auth/me');
          if (res.ok) {
            const data = await res.json();
            currentUser = data.user;
            updateAuthUI();
            hideLandingPage();
            init();
            notifInit();
            loadPromptTemplates();
            return;
          }
        } catch {}
      }
      const refreshed = await tryRefreshToken();
      if (refreshed) {
        hideLandingPage();
        init();
        notifInit();
        loadPromptTemplates();
      } else {
        showLandingPage();
      }
    })();

    // Fetch and display app version (unauthenticated)
    fetch('/healthz').then(r => r.json()).then(d => {
      const v = d.version || '';
      if (v) {
        const label = 'v' + v;
        const el = document.getElementById('app-version');
        if (el) el.textContent = 'LLM Benchmark Studio ' + label;
        const lel = document.getElementById('landing-version');
        if (lel) lel.textContent = label;
      }
    }).catch(() => {});
  </script>

  <!-- Onboarding Wizard Modal -->
  <div id="onboarding-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:40px; max-width:600px; width:90%; color:#e0e0e0;">
      <div id="onb-step-1">
        <h2 style="color:var(--lime); margin-top:0; font-family:'Chakra Petch',sans-serif; font-size:22px; font-weight:700;">Welcome to Benchmark Studio!</h2>
        <p style="font-family:'Outfit',sans-serif; color:#A1A1AA; margin-bottom:20px;">Let's get you set up in 3 quick steps.</p>
        <h3 style="font-family:'Chakra Petch',sans-serif; font-size:14px; font-weight:600; color:#e0e0e0; text-transform:uppercase; letter-spacing:0.05em;">Step 1 of 3: Choose Your Provider</h3>
        <p style="color:#85858F; font-size:13px; font-family:'Outfit',sans-serif;">Pick a provider to get started. You can add more later in Settings.</p>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:16px 0;">
          <div class="onb-provider-card" onclick="onbSelectProvider('OpenAI','OPENAI_API_KEY','openai',this)" style="border:1px solid var(--border-subtle); background:var(--surface); border-radius:8px; padding:14px; cursor:pointer; transition:all 0.15s;">
            <div style="font-weight:600; color:#e0e0e0; font-size:14px; font-family:'Outfit',sans-serif;">OpenAI</div>
            <div style="color:#85858F; font-size:12px; font-family:'Outfit',sans-serif; margin-top:4px;">GPT models (gpt-5, gpt-5-nano)</div>
          </div>
          <div class="onb-provider-card" onclick="onbSelectProvider('Anthropic','ANTHROPIC_API_KEY','anthropic',this)" style="border:1px solid var(--border-subtle); background:var(--surface); border-radius:8px; padding:14px; cursor:pointer; transition:all 0.15s;">
            <div style="font-weight:600; color:#e0e0e0; font-size:14px; font-family:'Outfit',sans-serif;">Anthropic</div>
            <div style="color:#85858F; font-size:12px; font-family:'Outfit',sans-serif; margin-top:4px;">Claude models (Sonnet, Haiku)</div>
          </div>
          <div class="onb-provider-card" onclick="onbSelectProvider('Google Gemini','GEMINI_API_KEY','google_gemini',this)" style="border:1px solid var(--border-subtle); background:var(--surface); border-radius:8px; padding:14px; cursor:pointer; transition:all 0.15s;">
            <div style="font-weight:600; color:#e0e0e0; font-size:14px; font-family:'Outfit',sans-serif;">Google Gemini</div>
            <div style="color:#85858F; font-size:12px; font-family:'Outfit',sans-serif; margin-top:4px;">Gemini models</div>
          </div>
          <div class="onb-provider-card" onclick="onbSelectProvider('custom','','',this)" style="border:1px solid var(--border-subtle); background:var(--surface); border-radius:8px; padding:14px; cursor:pointer; transition:all 0.15s;">
            <div style="font-weight:600; color:#e0e0e0; font-size:14px; font-family:'Outfit',sans-serif;">Custom</div>
            <div style="color:#85858F; font-size:12px; font-family:'Outfit',sans-serif; margin-top:4px;">Other provider or self-hosted</div>
          </div>
        </div>

        <!-- API key input (shown when OpenAI/Anthropic/Gemini selected) -->
        <div id="onb-key-input-area" style="display:none; margin:12px 0;">
          <label id="onb-key-label" style="font-size:12px; color:#85858F; font-family:'Outfit',sans-serif; display:block; margin-bottom:6px;"></label>
          <div style="display:flex; gap:8px;">
            <input id="onb-key-input" type="password" placeholder="" style="flex:1; padding:8px 12px; border-radius:6px; border:1px solid var(--border-subtle); background:rgba(255,255,255,0.03); color:#e0e0e0; font-family:'Space Mono',monospace; font-size:13px; outline:none;" />
            <button onclick="onbSaveKey()" style="background:var(--lime); color:#000; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold; font-family:'Outfit',sans-serif; font-size:13px; white-space:nowrap;">Save Key</button>
          </div>
          <span id="onb-key-save-status" style="font-size:12px; font-family:'Outfit',sans-serif; margin-top:6px; display:inline-block;"></span>
        </div>

        <!-- Custom provider message -->
        <div id="onb-custom-area" style="display:none; margin:12px 0; padding:12px; border-radius:6px; border:1px solid var(--border-subtle); background:rgba(255,255,255,0.02);">
          <p style="color:#A1A1AA; font-size:13px; font-family:'Outfit',sans-serif; margin:0;">Custom providers can be configured in <strong style="color:#e0e0e0;">Settings</strong> after onboarding. You'll be able to set a provider name, API base URL, API key, and model ID prefix.</p>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:24px;">
          <button onclick="onbSkip()" style="background:transparent; border:1px solid var(--border); color:#85858F; padding:8px 20px; border-radius:6px; cursor:pointer; font-family:'Outfit',sans-serif;">Skip All</button>
          <button onclick="onbNext(2)" style="background:var(--lime); color:#000; border:none; padding:8px 20px; border-radius:6px; cursor:pointer; font-weight:bold; font-family:'Outfit',sans-serif;">Next Step</button>
        </div>
      </div>
      <div id="onb-step-2" style="display:none;">
        <h2 style="color:var(--lime); margin-top:0; font-family:'Chakra Petch',sans-serif; font-size:22px; font-weight:700;">Step 2 of 3: Quick Test</h2>
        <p style="font-family:'Outfit',sans-serif; color:#A1A1AA;">Want to run a quick benchmark with one model to verify your setup?</p>
        <p style="color:#85858F; font-size:13px; font-family:'Outfit',sans-serif;">This will run a single benchmark with the first available model. Takes about 10 seconds.</p>
        <div style="display:flex; justify-content:space-between; margin-top:24px;">
          <button onclick="onbNext(3)" style="background:transparent; border:1px solid var(--border); color:#85858F; padding:8px 20px; border-radius:6px; cursor:pointer; font-family:'Outfit',sans-serif;">Skip</button>
          <button onclick="onbNext(3)" style="background:var(--lime); color:#000; border:none; padding:8px 20px; border-radius:6px; cursor:pointer; font-weight:bold; font-family:'Outfit',sans-serif;">Next Step</button>
        </div>
      </div>
      <div id="onb-step-3" style="display:none;">
        <h2 style="color:var(--lime); margin-top:0; font-family:'Chakra Petch',sans-serif; font-size:22px; font-weight:700;">You're All Set!</h2>
        <p style="font-family:'Outfit',sans-serif; color:#A1A1AA;">Start exploring:</p>
        <ul style="list-style:none; padding:0; font-family:'Outfit',sans-serif;">
          <li style="margin:8px 0; color:#e0e0e0;"><span style="color:var(--lime);">&#8594;</span> <strong>Benchmark</strong> &mdash; Run speed tests across models</li>
          <li style="margin:8px 0; color:#e0e0e0;"><span style="color:var(--lime);">&#8594;</span> <strong>Analytics</strong> &mdash; Compare models on leaderboard</li>
          <li style="margin:8px 0; color:#e0e0e0;"><span style="color:var(--lime);">&#8594;</span> <strong>Tool Eval</strong> &mdash; Test tool calling accuracy</li>
        </ul>
        <div style="text-align:center; margin-top:24px;">
          <button onclick="onbComplete()" style="background:var(--lime); color:#000; border:none; padding:10px 32px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:16px; font-family:'Outfit',sans-serif;">Let's Go!</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
