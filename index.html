<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>LLM Benchmark Studio - Measure LLM Speed &amp; Latency Across Providers</title>
  <meta name="description" content="Compare token throughput (tokens/sec) and latency (TTFT) across OpenAI, Anthropic, Google, and more. Real-time benchmarking with interactive dashboards.">
  <meta name="keywords" content="LLM benchmark, AI model comparison, token throughput, TTFT, latency, OpenAI, Anthropic, Claude, GPT, Gemini, LLM speed test">
  <meta name="theme-color" content="#BFFF00">
  <link rel="canonical" href="/">

  <!-- Open Graph -->
  <meta property="og:type" content="website">
  <meta property="og:title" content="LLM Benchmark Studio - Measure LLM Speed &amp; Latency">
  <meta property="og:description" content="Compare token throughput and latency across OpenAI, Anthropic, Google, and more. Real-time benchmarking with interactive dashboards.">
  <meta property="og:url" content="/">
  <meta property="og:site_name" content="LLM Benchmark Studio">
  <meta property="og:image" content="/og-image.png">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title" content="LLM Benchmark Studio - Measure LLM Speed &amp; Latency">
  <meta name="twitter:description" content="Compare token throughput and latency across OpenAI, Anthropic, Google, and more. Real-time benchmarking with interactive dashboards.">
  <meta name="twitter:image" content="/og-image.png">

  <!-- Structured Data -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "SoftwareApplication",
    "name": "LLM Benchmark Studio",
    "applicationCategory": "DeveloperApplication",
    "operatingSystem": "Web",
    "description": "Measure token throughput (tokens/sec) and latency (TTFT) across multiple LLM providers simultaneously with real-time interactive dashboards.",
    "offers": {
      "@type": "Offer",
      "price": "0",
      "priceCurrency": "USD"
    }
  }
  </script>

  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3"></script>
  <link href="https://fonts.googleapis.com/css2?family=Chakra+Petch:wght@400;500;600;700&family=Outfit:wght@300;400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: {
            display: ['Chakra Petch', 'sans-serif'],
            body: ['Outfit', 'sans-serif'],
            mono: ['Space Mono', 'monospace'],
          },
          colors: {
            zinc: { 500: '#85858F', 600: '#8B8B95', 700: '#63636B', 925: '#111113', 850: '#1c1c20' },
            lime: { accent: '#BFFF00' },
            coral: { accent: '#FF3B5C' },
          }
        }
      }
    }
  </script>
  <style>
    :root {
      --lime: #BFFF00;
      --lime-dim: rgba(191,255,0,0.12);
      --lime-mid: rgba(191,255,0,0.3);
      --coral: #FF3B5C;
      --surface: #111113;
      --surface-raised: #1c1c20;
      --border: #27272A;
      --border-subtle: #1f1f23;
    }
    /* WCAG AA contrast overrides for Tailwind zinc text utilities */
    .text-zinc-600 { color: #8B8B95 !important; }
    .text-zinc-500 { color: #85858F !important; }
    .text-zinc-700 { color: #63636B !important; }
    * { box-sizing: border-box; }
    body {
      background: #09090B;
      font-family: 'Outfit', sans-serif;
      color: #A1A1AA;
    }
    /* Dot grid background */
    body::before {
      content: '';
      position: fixed;
      inset: 0;
      background-image: radial-gradient(rgba(255,255,255,0.03) 1px, transparent 1px);
      background-size: 24px 24px;
      pointer-events: none;
      z-index: 0;
    }
    body > * { position: relative; z-index: 1; }

    /* Noise grain overlay */
    body::after {
      content: '';
      position: fixed;
      inset: 0;
      opacity: 0.015;
      background: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      pointer-events: none;
      z-index: 0;
    }

    /* Cards */
    .card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      transition: border-color 0.2s;
    }
    .card:hover { border-color: var(--border); }
    .card-accent {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-left: 3px solid var(--lime);
    }

    /* Model cards */
    .model-card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      transition: all 0.15s ease;
      cursor: pointer;
    }
    .model-card:hover { border-color: var(--border); background: var(--surface-raised); }
    .model-card.selected { border-color: var(--lime); background: var(--lime-dim); }
    .model-card .check-dot { width: 8px; height: 8px; border-radius: 50%; background: #63636B; transition: all 0.15s; }
    .model-card.selected .check-dot { background: var(--lime); box-shadow: 0 0 8px rgba(191,255,0,0.4); }

    /* Provider groups */
    .provider-group { border-left: 2px solid var(--border-subtle); padding-left: 0; margin-bottom: 8px; }
    .provider-group-header {
      display: flex; align-items: center; gap: 8px;
      padding: 6px 12px; margin-bottom: 6px; cursor: pointer; user-select: none;
    }
    .provider-group-header:hover .provider-group-label { opacity: 1; }
    .provider-group-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
    .provider-group-label { font-size: 10px; font-weight: 600; letter-spacing: 0.08em; text-transform: uppercase; opacity: 0.7; transition: opacity 0.15s; }
    .provider-group-count { font-size: 9px; font-family: 'Space Mono', monospace; color: #8B8B95; margin-left: auto; }

    /* Run button */
    .run-btn {
      background: var(--lime);
      color: #09090B;
      font-family: 'Chakra Petch', sans-serif;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      transition: all 0.2s;
      box-shadow: 0 0 30px rgba(191,255,0,0.15);
    }
    .run-btn:hover { box-shadow: 0 0 50px rgba(191,255,0,0.3); transform: translateY(-1px); }
    .run-btn:disabled { opacity: 0.3; cursor: not-allowed; box-shadow: none; transform: none; }
    .run-btn:active { transform: translateY(0); }

    /* Progress bar */
    .progress-track { background: #1c1c20; height: 6px; }
    .progress-fill {
      height: 100%;
      background: var(--lime);
      box-shadow: 0 0 12px rgba(191,255,0,0.3);
      transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      background-image: repeating-linear-gradient(
        -45deg,
        transparent,
        transparent 6px,
        rgba(0,0,0,0.15) 6px,
        rgba(0,0,0,0.15) 12px
      );
      background-size: 17px 17px;
      animation: stripe-scroll 0.6s linear infinite;
    }
    @keyframes stripe-scroll { to { background-position: 17px 0; } }

    /* Per-provider progress row */
    .provider-progress-row {
      display: grid;
      grid-template-columns: 140px 1fr 52px;
      align-items: center;
      gap: 12px;
    }
    .provider-progress-row .ppr-name {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .provider-progress-row .ppr-mid {
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 0;
    }
    .provider-progress-row .ppr-status {
      font-family: 'Outfit', sans-serif;
      font-size: 11px;
      color: #85858F;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .provider-progress-row .ppr-track {
      background: #1c1c20;
      height: 4px;
      border-radius: 2px;
      overflow: hidden;
    }
    .provider-progress-row .ppr-fill {
      height: 100%;
      border-radius: 2px;
      transition: width 0.4s cubic-bezier(0.16, 1, 0.3, 1);
      background-image: repeating-linear-gradient(
        -45deg, transparent, transparent 4px,
        rgba(0,0,0,0.15) 4px, rgba(0,0,0,0.15) 8px
      );
      background-size: 11px 11px;
      animation: stripe-scroll 0.6s linear infinite;
    }
    .provider-progress-row .ppr-fill.done {
      animation: none;
      background-image: none;
    }
    .provider-progress-row .ppr-count {
      font-family: 'Space Mono', monospace;
      font-size: 10px;
      color: #8B8B95;
      text-align: right;
      white-space: nowrap;
    }

    /* Pulse dot */
    .pulse-dot {
      width: 6px; height: 6px; border-radius: 50%; background: var(--lime);
      animation: pulse 1.5s ease-in-out infinite;
    }
    @keyframes pulse { 0%,100% { opacity: 0.4; box-shadow: none; } 50% { opacity: 1; box-shadow: 0 0 8px rgba(191,255,0,0.5); } }

    /* Stagger animations */
    .stagger { opacity: 0; transform: translateY(12px); animation: stagger-in 0.4s ease forwards; }
    .stagger:nth-child(1) { animation-delay: 0.05s; }
    .stagger:nth-child(2) { animation-delay: 0.1s; }
    .stagger:nth-child(3) { animation-delay: 0.15s; }
    .stagger:nth-child(4) { animation-delay: 0.2s; }
    .stagger:nth-child(5) { animation-delay: 0.25s; }
    .stagger:nth-child(6) { animation-delay: 0.3s; }
    @keyframes stagger-in { to { opacity: 1; transform: translateY(0); } }
    .fade-in { animation: stagger-in 0.3s ease forwards; }

    /* Tabs */
    .tab { padding: 8px 0; font-family: 'Chakra Petch', sans-serif; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; font-size: 12px; border-bottom: 2px solid transparent; transition: all 0.2s; color: #8B8B95; }
    .tab:hover { color: #A1A1AA; }
    .tab-active { color: var(--lime) !important; border-bottom-color: var(--lime) !important; }

    /* Sliders */
    input[type=range] { -webkit-appearance: none; background: transparent; width: 100%; }
    input[type=range]::-webkit-slider-track { height: 3px; border-radius: 2px; background: #27272A; }
    input[type=range]::-webkit-slider-thumb { -webkit-appearance: none; width: 14px; height: 14px; border-radius: 2px; background: var(--lime); margin-top: -5.5px; cursor: pointer; box-shadow: 0 0 6px rgba(191,255,0,0.3); }

    /* Textarea */
    .prompt-input {
      background: rgba(255,255,255,0.02);
      border: 1px solid var(--border-subtle);
      color: #E4E4E7;
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      resize: none;
      transition: border-color 0.2s;
    }
    .prompt-input:focus { outline: none; border-color: rgba(191,255,0,0.3); }

    /* Scrollbar */
    ::-webkit-scrollbar { width: 4px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: #27272A; border-radius: 2px; }

    /* Stat cards */
    .stat-card { transition: all 0.2s; }
    .stat-card:hover { border-color: var(--border); transform: translateY(-1px); }

    /* Table */
    .results-table tr { border-bottom: 1px solid var(--border-subtle); transition: background 0.15s; }
    .results-table tr:hover { background: rgba(255,255,255,0.02); }
    .results-table .rank-1 { background: var(--lime-dim); }
    .results-table .rank-1:hover { background: rgba(191,255,0,0.08); }

    /* Provider badges */
    .badge { font-family: 'Chakra Petch', sans-serif; font-size: 10px; letter-spacing: 0.06em; text-transform: uppercase; font-weight: 500; padding: 2px 8px; border-radius: 2px; }

    /* Big number style */
    .big-num { font-family: 'Chakra Petch', sans-serif; font-weight: 700; line-height: 1; }

    /* Section label */
    .section-label { font-family: 'Chakra Petch', sans-serif; font-size: 11px; font-weight: 600; letter-spacing: 0.1em; text-transform: uppercase; color: #8B8B95; }

    /* Toast notifications */
    .toast-container { position: fixed; top: 16px; right: 16px; z-index: 9999; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
    .toast { pointer-events: auto; padding: 10px 16px; border-radius: 4px; font-family: 'Outfit', sans-serif; font-size: 13px; color: #E4E4E7; background: var(--surface-raised); border: 1px solid var(--border); box-shadow: 0 4px 24px rgba(0,0,0,0.4); animation: toast-in 0.3s ease forwards; max-width: 400px; }
    .toast-error { border-color: rgba(255,59,92,0.4); background: rgba(255,59,92,0.08); color: #FCA5A5; }
    .toast-success { border-color: rgba(191,255,0,0.3); background: rgba(191,255,0,0.06); color: var(--lime); }
    .toast-out { animation: toast-out 0.3s ease forwards; }
    @keyframes toast-in { from { opacity: 0; transform: translateX(40px); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toast-out { from { opacity: 1; } to { opacity: 0; transform: translateX(40px); } }

    /* Modal */
    .modal-overlay { position: fixed; inset: 0; z-index: 9998; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; animation: modal-fade-in 0.2s ease; }
    .modal-overlay.modal-closing { animation: modal-fade-out 0.2s ease forwards; }
    .modal-box { background: var(--surface); border: 1px solid var(--border); border-radius: 6px; padding: 24px; min-width: 340px; max-width: 480px; width: 100%; box-shadow: 0 8px 40px rgba(0,0,0,0.5); animation: modal-scale-in 0.2s ease; }
    .modal-closing .modal-box { animation: modal-scale-out 0.2s ease forwards; }
    .modal-title { font-family: 'Chakra Petch', sans-serif; font-weight: 600; font-size: 14px; letter-spacing: 0.04em; text-transform: uppercase; color: #E4E4E7; margin-bottom: 12px; }
    .modal-message { font-family: 'Outfit', sans-serif; font-size: 13px; color: #A1A1AA; margin-bottom: 16px; line-height: 1.5; }
    .modal-input { width: 100%; padding: 8px 12px; border-radius: 4px; background: rgba(255,255,255,0.02); border: 1px solid var(--border-subtle); color: #E4E4E7; font-family: 'Space Mono', monospace; font-size: 13px; outline: none; margin-bottom: 16px; transition: border-color 0.2s; }
    .modal-input:focus { border-color: rgba(191,255,0,0.3); }
    .modal-buttons { display: flex; justify-content: flex-end; gap: 8px; }
    .modal-btn { padding: 6px 16px; border-radius: 4px; font-family: 'Chakra Petch', sans-serif; font-size: 12px; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; cursor: pointer; transition: all 0.15s; }
    .modal-btn-cancel { background: transparent; border: 1px solid var(--border-subtle); color: #85858F; }
    .modal-btn-cancel:hover { border-color: var(--border); color: #A1A1AA; }
    .modal-btn-confirm { background: var(--lime); border: 1px solid var(--lime); color: #09090B; }
    .modal-btn-confirm:hover { box-shadow: 0 0 12px rgba(191,255,0,0.3); }
    .modal-btn-danger { background: rgba(255,59,92,0.15); border: 1px solid rgba(255,59,92,0.3); color: #FF3B5C; }
    .modal-btn-danger:hover { background: rgba(255,59,92,0.25); }
    @keyframes modal-fade-in { from { opacity: 0; } to { opacity: 1; } }
    @keyframes modal-fade-out { from { opacity: 1; } to { opacity: 0; } }
    @keyframes modal-scale-in { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    @keyframes modal-scale-out { from { opacity: 1; transform: scale(1); } to { opacity: 0; transform: scale(0.95); } }

    /* Error banner */
    .error-banner { background: rgba(255,59,92,0.08); border: 1px solid rgba(255,59,92,0.25); border-radius: 4px; padding: 12px 16px; font-family: 'Outfit', sans-serif; font-size: 13px; color: #FCA5A5; display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .error-banner button { flex-shrink: 0; padding: 4px 12px; border-radius: 4px; font-family: 'Chakra Petch', sans-serif; font-size: 11px; font-weight: 500; letter-spacing: 0.04em; text-transform: uppercase; background: rgba(255,59,92,0.15); border: 1px solid rgba(255,59,92,0.3); color: #FF3B5C; cursor: pointer; }

    /* Skipped line in progress */
    .skipped-line { font-family: 'Outfit', sans-serif; font-size: 12px; color: #8B8B95; padding: 2px 0; }

    /* ═══════════════════ Landing Page ═══════════════════ */
    #landingPage { display: none; }

    .landing-topbar {
      position: fixed; top: 0; left: 0; right: 0; z-index: 100;
      padding: 16px 32px;
      display: flex; align-items: center; justify-content: space-between;
      background: rgba(9,9,11,0.8);
      backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--border-subtle);
    }

    .landing-hero {
      padding: 160px 24px 80px;
      text-align: center;
      max-width: 720px;
      margin: 0 auto;
    }
    .landing-hero h1 {
      font-family: 'Chakra Petch', sans-serif;
      font-size: clamp(36px, 6vw, 56px);
      font-weight: 700;
      letter-spacing: 0.04em;
      color: #E4E4E7;
      line-height: 1.1;
      margin: 0 0 12px;
    }
    .landing-hero h1 span { color: var(--lime); }
    .landing-hero .landing-tagline {
      font-family: 'Chakra Petch', sans-serif;
      font-size: clamp(14px, 2.5vw, 20px);
      font-weight: 500;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: #8B8B95;
      margin-bottom: 28px;
    }
    .landing-hero .landing-description {
      font-family: 'Outfit', sans-serif;
      font-size: clamp(15px, 2vw, 18px);
      color: #85858F;
      line-height: 1.7;
      max-width: 560px;
      margin: 0 auto 40px;
    }
    .landing-cta-group { display: flex; gap: 12px; justify-content: center; flex-wrap: wrap; }
    .landing-btn-primary {
      background: var(--lime); color: #09090B;
      font-family: 'Chakra Petch', sans-serif; font-weight: 600;
      font-size: 14px; letter-spacing: 0.05em; text-transform: uppercase;
      padding: 12px 32px; border-radius: 4px; border: none; cursor: pointer;
      box-shadow: 0 0 30px rgba(191,255,0,0.15);
      transition: all 0.2s;
    }
    .landing-btn-primary:hover { box-shadow: 0 0 50px rgba(191,255,0,0.3); transform: translateY(-1px); }
    .landing-btn-secondary {
      background: transparent; color: #A1A1AA;
      font-family: 'Chakra Petch', sans-serif; font-weight: 500;
      font-size: 14px; letter-spacing: 0.05em; text-transform: uppercase;
      padding: 12px 32px; border-radius: 4px; cursor: pointer;
      border: 1px solid var(--border);
      transition: all 0.2s;
    }
    .landing-btn-secondary:hover { border-color: #8B8B95; color: #E4E4E7; }

    .landing-features {
      max-width: 960px; margin: 0 auto;
      padding: 0 24px 80px;
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 16px;
    }
    .landing-feature-card {
      background: var(--surface);
      border: 1px solid var(--border-subtle);
      border-radius: 6px;
      padding: 28px 24px;
      transition: border-color 0.2s, transform 0.2s;
    }
    .landing-feature-card:hover { border-color: var(--border); transform: translateY(-2px); }
    .landing-feature-card .feature-icon {
      width: 36px; height: 36px; border-radius: 4px;
      display: flex; align-items: center; justify-content: center;
      margin-bottom: 16px; font-size: 18px;
      background: var(--lime-dim);
      color: var(--lime);
    }
    .landing-feature-card h3 {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 14px; font-weight: 600;
      letter-spacing: 0.04em; text-transform: uppercase;
      color: #E4E4E7; margin: 0 0 8px;
    }
    .landing-feature-card p {
      font-family: 'Outfit', sans-serif;
      font-size: 13px; color: #85858F; line-height: 1.6; margin: 0;
    }

    .landing-how {
      max-width: 960px; margin: 0 auto;
      padding: 0 24px 80px;
      text-align: center;
    }
    .landing-how .section-title {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 11px; font-weight: 600;
      letter-spacing: 0.1em; text-transform: uppercase;
      color: var(--lime); margin-bottom: 40px;
    }
    .landing-steps {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 32px;
    }
    .landing-step {
      text-align: center;
    }
    .landing-step .step-num {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 32px; font-weight: 700;
      color: var(--lime); opacity: 0.3;
      margin-bottom: 12px;
    }
    .landing-step h4 {
      font-family: 'Chakra Petch', sans-serif;
      font-size: 13px; font-weight: 600;
      letter-spacing: 0.04em; text-transform: uppercase;
      color: #E4E4E7; margin: 0 0 8px;
    }
    .landing-step p {
      font-family: 'Outfit', sans-serif;
      font-size: 13px; color: #8B8B95; line-height: 1.5; margin: 0;
    }

    .landing-footer {
      text-align: center;
      padding: 40px 24px;
      border-top: 1px solid var(--border-subtle);
      max-width: 960px; margin: 0 auto;
    }
    .landing-footer p {
      font-family: 'Outfit', sans-serif;
      font-size: 13px; color: #63636B; margin: 0;
    }

    /* Landing page animations */
    @keyframes landing-fade-up {
      from { opacity: 0; transform: translateY(24px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .landing-animate {
      opacity: 0;
      animation: landing-fade-up 0.6s ease forwards;
    }
    .landing-animate-d1 { animation-delay: 0.1s; }
    .landing-animate-d2 { animation-delay: 0.2s; }
    .landing-animate-d3 { animation-delay: 0.3s; }
    .landing-animate-d4 { animation-delay: 0.4s; }
    .landing-animate-d5 { animation-delay: 0.5s; }
    .landing-animate-d6 { animation-delay: 0.6s; }
    .landing-animate-d7 { animation-delay: 0.7s; }
    .landing-animate-d8 { animation-delay: 0.8s; }
    .landing-animate-d9 { animation-delay: 0.9s; }
    .landing-animate-d10 { animation-delay: 1.0s; }

    /* Landing page transitions */
    #landingPage { transition: opacity 0.3s ease; }

    /* Responsive landing */
    @media (max-width: 768px) {
      .landing-features { grid-template-columns: 1fr; }
      .landing-steps { grid-template-columns: 1fr; gap: 24px; }
      .landing-topbar { padding: 12px 16px; }
      .landing-hero { padding: 120px 16px 60px; }
    }
    @media (min-width: 769px) and (max-width: 1024px) {
      .landing-features { grid-template-columns: repeat(2, 1fr); }
    }
  </style>
</head>
<body class="min-h-screen">

  <!-- Toast container -->
  <div id="toastContainer" class="toast-container"></div>

  <!-- AUTH MODAL -->
  <div id="authModal" class="modal-overlay" style="display:none; z-index:10000;">
    <div class="modal-box" style="max-width:380px;">
      <div class="flex gap-4 mb-5">
        <button id="authTabLogin" onclick="switchAuthTab('login')" class="tab tab-active text-xs">Login</button>
        <button id="authTabRegister" onclick="switchAuthTab('register')" class="tab text-xs">Register</button>
      </div>
      <div id="authError" class="error-banner mb-4" style="display:none;"></div>
      <form id="authForm" onsubmit="handleAuth(event)">
        <label class="section-label block mb-1">Email</label>
        <input type="email" id="authEmail" class="modal-input mb-3" required placeholder="you@example.com" autocomplete="email">
        <label class="section-label block mb-1">Password</label>
        <input type="password" id="authPassword" class="modal-input mb-4" required minlength="8" placeholder="Min 8 characters" autocomplete="current-password">
        <button type="submit" id="authSubmitBtn" class="modal-btn modal-btn-confirm w-full text-center">Login</button>
      </form>
    </div>
  </div>

  <!-- ═══════════════════════════ LANDING PAGE ═══════════════════════════ -->
  <div id="landingPage">
    <!-- Top bar -->
    <div class="landing-topbar">
      <div class="flex items-center gap-3">
        <div class="w-9 h-9 rounded-sm flex items-center justify-center font-display font-bold text-sm" style="background: var(--lime); color: #09090B;">
          B<span style="font-size:10px; opacity:0.6;">s</span>
        </div>
        <div class="font-display font-bold text-sm text-zinc-100 tracking-wide">
          BENCHMARK <span style="color: var(--lime)">STUDIO</span>
        </div>
      </div>
      <div class="flex items-center gap-3">
        <button onclick="switchAuthTab('login'); showAuthModal();" class="landing-btn-secondary" style="padding: 8px 20px; font-size: 12px;">Login</button>
        <button onclick="switchAuthTab('register'); showAuthModal();" class="landing-btn-primary" style="padding: 8px 20px; font-size: 12px; box-shadow: none;">Sign Up</button>
      </div>
    </div>

    <!-- Hero -->
    <div class="landing-hero">
      <h1 class="landing-animate">BENCHMARK <span>STUDIO</span></h1>
      <div class="landing-tagline landing-animate landing-animate-d1">Measure &middot; Compare &middot; Optimize</div>
      <p class="landing-description landing-animate landing-animate-d2">
        The all-in-one platform for benchmarking LLM providers.
        Compare throughput, latency, and cost across models in real-time.
      </p>
      <div class="landing-cta-group landing-animate landing-animate-d3">
        <button onclick="switchAuthTab('register'); showAuthModal();" class="landing-btn-primary">Get Started Free</button>
        <button onclick="switchAuthTab('login'); showAuthModal();" class="landing-btn-secondary">Login</button>
      </div>
    </div>

    <!-- Features grid -->
    <div class="landing-features">
      <div class="landing-feature-card landing-animate landing-animate-d4">
        <div class="feature-icon">&#9889;</div>
        <h3>Real-Time Benchmarks</h3>
        <p>Stream token-by-token metrics across multiple providers simultaneously. Measure TTFT and throughput live.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d5">
        <div class="feature-icon">&#9881;</div>
        <h3>Tool Calling Eval</h3>
        <p>Test and score function calling accuracy with custom MCP tool suites. Grade responses automatically.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d6">
        <div class="feature-icon">&#9776;</div>
        <h3>Analytics Dashboard</h3>
        <p>Leaderboards, trend analysis, and run comparisons over time. Find the best model for your workload.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d7">
        <div class="feature-icon">&#8635;</div>
        <h3>Scheduled Runs</h3>
        <p>Set up recurring benchmarks to track performance changes. Get notified when metrics shift.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d8">
        <div class="feature-icon">&#9729;</div>
        <h3>Multi-Provider</h3>
        <p>OpenAI, Anthropic, Google Gemini, and custom endpoints. Compare any provider side-by-side.</p>
      </div>
      <div class="landing-feature-card landing-animate landing-animate-d9">
        <div class="feature-icon">&#8681;</div>
        <h3>Export Everything</h3>
        <p>CSV exports, JSON eval data, and settings backup/restore. Full data portability.</p>
      </div>
    </div>

    <!-- How it works -->
    <div class="landing-how">
      <div class="section-title landing-animate landing-animate-d7">How It Works</div>
      <div class="landing-steps">
        <div class="landing-step landing-animate landing-animate-d8">
          <div class="step-num">01</div>
          <h4>Add Your API Keys</h4>
          <p>Configure providers and models through the settings panel</p>
        </div>
        <div class="landing-step landing-animate landing-animate-d9">
          <div class="step-num">02</div>
          <h4>Run Benchmarks</h4>
          <p>Stream results in real-time with live progress tracking</p>
        </div>
        <div class="landing-step landing-animate landing-animate-d10">
          <div class="step-num">03</div>
          <h4>Analyze &amp; Compare</h4>
          <p>Leaderboard, trends, and side-by-side model comparisons</p>
        </div>
      </div>
    </div>

    <!-- Footer -->
    <div class="landing-footer">
      <p>Built for LLM engineers</p>
      <p id="landing-version" style="margin-top:8px; font-size:11px; color:#27272a;"></p>
    </div>
  </div>

  <!-- ═══════════════════════════ HEADER ═══════════════════════════ -->
  <header id="appHeader" class="border-b px-6 py-4" style="border-color: var(--border-subtle); display: none;">
    <div class="max-w-7xl mx-auto flex items-center justify-between">
      <div class="flex items-center gap-4">
        <!-- Logo mark -->
        <div class="w-9 h-9 rounded-sm flex items-center justify-center font-display font-bold text-sm" style="background: var(--lime); color: #09090B;">
          B<span style="font-size:10px; opacity:0.6;">s</span>
        </div>
        <div>
          <h1 class="font-display font-bold text-base text-zinc-100 tracking-wide">
            BENCHMARK <span style="color: var(--lime)">STUDIO</span>
          </h1>
          <p class="text-[10px] tracking-[0.2em] uppercase text-zinc-600 mt-0.5">Measure &middot; Compare &middot; Optimize</p>
        </div>
      </div>
      <div class="flex items-center gap-6">
        <button onclick="showTab('benchmark')" id="tab-benchmark" class="tab tab-active">Benchmark</button>
        <button onclick="showTab('history')" id="tab-history" class="tab">History</button>
        <button onclick="showTab('settings')" id="tab-settings" class="tab">Settings</button>
        <button onclick="showTab('tool-eval')" id="tab-tool-eval" class="tab">Tool Eval</button>
        <button onclick="showTab('analytics')" id="tab-analytics" class="tab">Analytics</button>
        <button onclick="showTab('schedules')" id="tab-schedules" class="tab">Schedules</button>
        <button onclick="showTab('admin')" id="tab-admin" class="tab" style="display:none;">Admin</button>
        <div id="userMenu" class="flex items-center gap-3 ml-4 pl-4" style="border-left:1px solid var(--border-subtle); display:none;">
          <span id="userEmail" class="text-[11px] text-zinc-500 font-mono"></span>
          <button onclick="handleLogout()" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-zinc-300 px-2 py-1 rounded" style="border:1px solid var(--border-subtle)">Logout</button>
        </div>
      </div>
    </div>
  </header>

  <!-- ═══════════════════════════ MAIN ═══════════════════════════ -->
  <main id="appMain" class="max-w-7xl mx-auto px-6 py-8" style="display: none;">

    <!-- Init error banner -->
    <div id="initErrorBanner" class="hidden error-banner mb-6">
      <span>Failed to connect to server. Check that the backend is running.</span>
    </div>

    <!-- ─── BENCHMARK TAB ─── -->
    <div id="view-benchmark">

      <!-- CONFIG ROW -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 mb-6">
        <!-- Prompt -->
        <div class="lg:col-span-2 card rounded-md p-5 stagger">
          <div class="flex items-center justify-between mb-3">
            <label class="section-label">Benchmark Prompt</label>
            <select id="promptTemplateSelect" onchange="applyPromptTemplate(this.value)" class="text-xs font-mono px-3 py-1.5 rounded-sm cursor-pointer" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;max-width:220px;">
              <option value="">Custom</option>
            </select>
          </div>
          <textarea id="prompt" rows="3" class="prompt-input w-full rounded-sm px-4 py-3" placeholder="Enter your benchmark prompt..."></textarea>
        </div>

        <!-- Params -->
        <div class="card rounded-md p-5 stagger">
          <label class="section-label mb-4 block">Parameters</label>
          <div class="space-y-5">
            <div>
              <div class="flex justify-between text-xs mb-2">
                <span class="text-zinc-500 font-body">Max Tokens</span>
                <span id="maxTokensVal" class="font-mono text-zinc-300">512</span>
              </div>
              <input type="range" id="maxTokens" min="64" max="4096" step="64" value="512" oninput="document.getElementById('maxTokensVal').textContent=this.value">
            </div>
            <div>
              <div class="flex justify-between text-xs mb-2">
                <span class="text-zinc-500 font-body">Temperature</span>
                <span id="tempVal" class="font-mono text-zinc-300">0.7</span>
              </div>
              <input type="range" id="temperature" min="0" max="2" step="0.1" value="0.7" oninput="document.getElementById('tempVal').textContent=parseFloat(this.value).toFixed(1)">
            </div>
            <div>
              <div class="flex justify-between text-xs mb-2">
                <span class="text-zinc-500 font-body">Runs per model</span>
                <span id="runsVal" class="font-mono text-zinc-300">1</span>
              </div>
              <input type="range" id="runs" min="1" max="10" step="1" value="1" oninput="document.getElementById('runsVal').textContent=this.value">
            </div>
            <div class="flex items-center justify-between mt-4">
              <span class="text-zinc-500 font-body text-xs">Warm-up run</span>
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" id="warmupToggle" checked class="sr-only peer">
                <div class="w-8 h-4 rounded-full peer bg-zinc-700 peer-checked:bg-lime-accent/40 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-4 peer-checked:after:bg-[var(--lime)]"></div>
              </label>
            </div>
          </div>
          <div class="mt-5 pt-5" style="border-top: 1px solid var(--border-subtle)">
            <div class="flex justify-between text-xs mb-3">
              <span class="text-zinc-500 font-body">Context Tiers</span>
              <span id="tierBadge" class="hidden text-[10px] font-display font-semibold tracking-wider uppercase px-2 py-0.5 rounded-sm" style="background:rgba(255,59,92,0.15);color:var(--coral);">STRESS TEST</span>
            </div>
            <div id="tierChips" class="flex flex-wrap gap-2">
              <!-- JS populates -->
            </div>
            <div id="tierWarnings" class="mt-2 space-y-1"></div>
          </div>
        </div>
      </div>

      <!-- MODEL SELECTION -->
      <div class="card rounded-md p-5 mb-6 stagger">
        <div class="flex items-center justify-between mb-4">
          <label class="section-label">Select Models</label>
          <div class="flex gap-2">
            <button id="healthCheckBtn" onclick="checkProviderHealth()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: #38BDF8; border: 1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Check Health</button>
            <button onclick="selectAll()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: var(--lime); border: 1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">All</button>
            <button onclick="selectNone()" class="text-[11px] font-display font-medium tracking-wider uppercase text-zinc-600 px-3 py-1 rounded-sm border transition-colors" style="border-color: var(--border-subtle)" onmouseover="this.style.borderColor='var(--border)'" onmouseout="this.style.borderColor='var(--border-subtle)'">Clear</button>
          </div>
        </div>
        <div id="modelGrid" class="flex flex-col gap-1">
          <!-- JS populates -->
        </div>
      </div>

      <!-- RUN BUTTON -->
      <div class="flex justify-center mb-10 stagger">
        <button id="runBtn" onclick="startBenchmark()" class="run-btn px-12 py-3 rounded-sm text-sm flex items-center gap-3">
          <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
          Run Benchmark
        </button>
      </div>

      <!-- PROGRESS -->
      <div id="progressSection" class="hidden mb-8 fade-in">
        <div class="card rounded-md p-5">
          <!-- Header: pulse dot, overall counter, cancel button -->
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="pulse-dot"></div>
              <span id="progressLabel" class="text-sm text-zinc-400 font-body">Initializing...</span>
            </div>
            <div class="flex items-center gap-4">
              <span id="progressCount" class="text-xs font-mono text-zinc-600">0/0</span>
              <button id="cancelBtn" onclick="cancelBenchmark()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:var(--coral);border:1px solid rgba(255,59,92,0.3);" onmouseover="this.style.borderColor='rgba(255,59,92,0.6)'" onmouseout="this.style.borderColor='rgba(255,59,92,0.3)'">Cancel</button>
            </div>
          </div>
          <!-- Per-provider progress rows -->
          <div id="providerProgressPanel" class="flex flex-col gap-3"></div>
          <div id="progressSkipped" class="mt-3"></div>
        </div>
        <!-- Error banner for SSE issues -->
        <div id="sseBanner" class="hidden error-banner mt-3">
          <span id="sseBannerMsg">Connection lost</span>
          <button onclick="retryBenchmark()">Retry</button>
        </div>
      </div>

      <!-- RESULTS -->
      <div id="resultsSection" class="hidden fade-in">
        <!-- Stat Cards -->
        <div id="statCards" class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-6"></div>

        <!-- Chart -->
        <div class="card rounded-md p-5 mb-4">
          <label class="section-label mb-4 block">Throughput Comparison</label>
          <div class="relative" style="height: 300px;">
            <canvas id="toksChart"></canvas>
          </div>
        </div>

        <!-- TTFT Chart -->
        <div id="ttftChartSection" class="hidden card rounded-md p-5 mb-4">
          <label id="ttftChartLabel" class="section-label mb-4 block">Latency (TTFT)</label>
          <div class="relative" style="height: 300px;">
            <canvas id="ttftChart"></canvas>
          </div>
        </div>

        <!-- Scatter: Speed vs Latency -->
        <div id="scatterChartSection" class="hidden card rounded-md p-5 mb-4">
          <label class="section-label mb-4 block">Speed vs Latency</label>
          <div class="relative" style="height: 300px;">
            <canvas id="scatterChart"></canvas>
          </div>
        </div>

        <!-- Table + CSV Export -->
        <div class="card rounded-md overflow-hidden mb-6">
          <div class="flex items-center justify-between px-5 py-3" style="border-bottom:1px solid var(--border-subtle)">
            <span class="section-label">Results</span>
            <button onclick="exportCSV()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Export CSV</button>
          </div>
          <table class="w-full text-sm results-table">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-left section-label">Pos</th>
                <th class="px-5 py-3 text-left section-label">Provider</th>
                <th class="px-5 py-3 text-left section-label">Model</th>
                <th class="px-5 py-3 text-right section-label">Tok/s</th>
                <th class="px-5 py-3 text-right section-label" data-col="stddev" style="display:none">Std Dev</th>
                <th class="px-5 py-3 text-right section-label">TTFT</th>
                <th class="px-5 py-3 text-right section-label">Input Tok/s</th>
                <th class="px-5 py-3 text-right section-label">Duration</th>
                <th class="px-5 py-3 text-right section-label">Tokens</th>
                <th class="px-5 py-3 text-center section-label">Status</th>
                <th class="px-5 py-3 text-right section-label">Cost</th>
              </tr>
            </thead>
            <tbody id="resultsBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ─── HISTORY TAB ─── -->
    <div id="view-history" class="hidden">
      <div class="flex items-center justify-between mb-4">
        <div></div>
        <button onclick="downloadCSV('/api/export/history?format=csv', 'benchmark-history.csv')" style="border: 1px solid #555; background: transparent; color: var(--lime); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: 'Outfit', sans-serif;">Export CSV</button>
      </div>
      <div id="historyCompareBar" class="hidden mb-4 flex items-center justify-between card rounded-md px-5 py-3" style="border-color:rgba(56,189,248,0.3)">
        <span class="text-xs font-body text-zinc-400"><span id="compareCount">0</span> runs selected</span>
        <button onclick="compareSelectedRuns()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.3);">Compare Selected</button>
      </div>
      <div id="historyCompareResult" class="hidden mb-6"></div>
      <div id="historyContainer" class="space-y-4">
        <p class="text-zinc-600 text-sm font-body">Loading history...</p>
      </div>
    </div>

    <!-- ─── SETTINGS TAB ─── -->
    <div id="view-settings" class="hidden">
      <div class="mb-6">
        <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Configuration</h2>
        <p class="text-sm text-zinc-600 font-body">Manage API keys, providers, and model settings.</p>
      </div>
      <!-- Backup & Restore Section -->
      <div class="mb-6 pb-5" style="border-bottom:1px solid var(--border-subtle)">
        <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Backup &amp; Restore</h2>
        <p class="text-sm text-zinc-600 font-body mb-4">Export your providers, models, and configuration. API keys are not included for security.</p>
        <div class="flex items-center gap-3">
          <button onclick="exportSettings()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Export Settings</button>
          <button onclick="importSettings()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Import Settings</button>
        </div>
      </div>
      <!-- API Keys Section -->
      <div id="apiKeysContainer" class="mb-6"></div>
      <!-- Providers + Models -->
      <div id="settingsContainer" class="space-y-6">
        <p class="text-zinc-600 text-sm font-body">Loading configuration...</p>
      </div>
    </div>

    <!-- ─── ADMIN TAB ─── -->
    <div id="view-admin" class="hidden">
      <div class="mb-6">
        <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Admin Dashboard</h2>
        <p class="text-sm text-zinc-600 font-body">User management, system stats, and audit log.</p>
      </div>

      <!-- Stats Cards -->
      <div id="adminStatsCards" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6"></div>

      <!-- System Health -->
      <div id="adminSystemHealth" class="card rounded-md p-5 mb-6"></div>

      <!-- User Management -->
      <div class="card rounded-md p-5 mb-6">
        <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase mb-4">User Management</h3>
        <div id="adminUsersTable" class="overflow-x-auto"></div>
      </div>

      <!-- Audit Log -->
      <div class="card rounded-md p-5">
        <div class="flex items-center justify-between mb-4">
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Audit Log</h3>
          <div class="flex items-center gap-3">
            <select id="auditFilterUser" onchange="loadAuditLog()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
              <option value="">All Users</option>
            </select>
            <select id="auditFilterAction" onchange="loadAuditLog()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
              <option value="">All Actions</option>
              <option value="user_login">Login</option>
              <option value="user_login_failed">Login Failed</option>
              <option value="user_register">Register</option>
              <option value="user_logout">Logout</option>
              <option value="benchmark_start">Benchmark Start</option>
              <option value="benchmark_complete">Benchmark Complete</option>
              <option value="benchmark_cancel">Benchmark Cancel</option>
              <option value="admin_user_update">Admin User Update</option>
              <option value="admin_rate_limit">Admin Rate Limit</option>
              <option value="token_refresh">Token Refresh</option>
            </select>
            <select id="auditFilterSince" onchange="loadAuditLog()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
              <option value="">All Time</option>
              <option value="1h">Last Hour</option>
              <option value="24h">Last 24h</option>
              <option value="7d">Last 7 Days</option>
              <option value="30d">Last 30 Days</option>
            </select>
          </div>
        </div>
        <div id="adminAuditTable" class="overflow-x-auto"></div>
        <div class="flex items-center justify-between mt-3">
          <span id="auditPageInfo" class="text-[10px] font-mono text-zinc-600"></span>
          <div class="flex gap-2">
            <button onclick="auditPrevPage()" id="auditPrevBtn" class="text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm" style="border:1px solid var(--border-subtle);color:#85858F;" disabled>Prev</button>
            <button onclick="auditNextPage()" id="auditNextBtn" class="text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm" style="border:1px solid var(--border-subtle);color:#85858F;">Next</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ─── ANALYTICS TAB ─── -->
    <div id="view-analytics" class="hidden">

      <!-- Sub-nav -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Analytics</h2>
          <p class="text-sm text-zinc-600 font-body">Leaderboards, run comparisons, and performance trends.</p>
        </div>
        <div class="flex items-center gap-2">
          <button onclick="analyticsShowLeaderboard()" id="an-btn-leaderboard" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm transition-colors" style="color:var(--lime);border:1px solid rgba(191,255,0,0.3);background:var(--lime-dim);">Leaderboard</button>
          <button onclick="analyticsShowCompare()" id="an-btn-compare" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm transition-colors" style="color:#85858F;border:1px solid var(--border-subtle);">Compare</button>
          <button onclick="analyticsShowTrends()" id="an-btn-trends" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm transition-colors" style="color:#85858F;border:1px solid var(--border-subtle);">Trends</button>
        </div>
      </div>

      <!-- Sub-View: Leaderboard -->
      <div id="an-leaderboard-view">
        <div class="flex items-center gap-3 mb-4">
          <div class="flex items-center gap-1">
            <button onclick="anSetLeaderboardType('benchmark')" id="an-lb-type-benchmark" class="text-[10px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:var(--lime);border:1px solid rgba(191,255,0,0.3);background:var(--lime-dim);">Benchmark</button>
            <button onclick="anSetLeaderboardType('tool_eval')" id="an-lb-type-tool_eval" class="text-[10px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#85858F;border:1px solid var(--border-subtle);">Tool Eval</button>
          </div>
          <select id="anLeaderboardPeriod" onchange="analyticsLoadLeaderboard()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
            <option value="7d">7 Days</option>
            <option value="30d">30 Days</option>
            <option value="90d">90 Days</option>
            <option value="all" selected>All Time</option>
          </select>
          <button onclick="downloadCSV('/api/export/leaderboard?type=' + anLeaderboardType + '&period=' + document.getElementById('anLeaderboardPeriod').value + '&format=csv', 'leaderboard.csv')" style="border: 1px solid #555; background: transparent; color: var(--lime); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: 'Outfit', sans-serif;">Export CSV</button>
        </div>
        <div class="card rounded-md overflow-hidden">
          <table class="w-full text-sm results-table">
            <thead id="anLeaderboardHead">
              <tr style="border-bottom: 1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('rank')">#</th>
                <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('model')">Model</th>
                <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('provider')">Provider</th>
                <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_tps')">Avg TPS</th>
                <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_ttft_ms')">Avg TTFT</th>
                <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_cost')">Avg Cost</th>
                <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('total_runs')">Runs</th>
                <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('last_run')">Last Run</th>
              </tr>
            </thead>
            <tbody id="anLeaderboardBody">
              <tr><td colspan="8" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">Loading leaderboard...</td></tr>
            </tbody>
          </table>
        </div>
      </div>

      <!-- Sub-View: Compare -->
      <div id="an-compare-view" class="hidden">
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <span class="section-label">Select Runs to Compare (2-4)</span>
            <button onclick="analyticsLoadCompare()" id="anCompareBtn" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm transition-colors" style="color:#85858F;border:1px solid var(--border-subtle);cursor:not-allowed;opacity:0.5;" disabled>Compare</button>
          </div>
          <div id="anCompareRunsList" class="space-y-2 max-h-64 overflow-y-auto">
            <p class="text-zinc-600 text-xs font-body">Loading recent runs...</p>
          </div>
        </div>
        <div id="anCompareCharts" class="hidden space-y-6">
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">Tokens/sec Comparison</label>
            <div style="height:320px"><canvas id="anCompareTpsChart"></canvas></div>
          </div>
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">TTFT Comparison (ms)</label>
            <div style="height:320px"><canvas id="anCompareTtftChart"></canvas></div>
          </div>
        </div>
        <div id="anCompareEmpty" class="card rounded-md p-10 text-center">
          <p class="text-zinc-600 font-body text-sm">Select 2-4 runs above, then click Compare.</p>
        </div>
      </div>

      <!-- Sub-View: Trends -->
      <div id="an-trends-view" class="hidden">
        <div class="flex items-center gap-3 mb-4">
          <div class="relative" id="anTrendsModelDropdown">
            <button onclick="anToggleModelDropdown()" class="text-xs font-mono px-3 py-1.5 rounded-sm flex items-center gap-2" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;">
              <span id="anTrendsModelLabel">Select Models</span>
              <svg class="w-3 h-3" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 9l-7 7-7-7"/></svg>
            </button>
            <div id="anTrendsModelList" class="hidden absolute top-full left-0 mt-1 w-64 max-h-48 overflow-y-auto rounded-sm z-50 p-2 space-y-1" style="background:var(--surface-raised);border:1px solid var(--border);">
            </div>
          </div>
          <select id="anTrendsPeriod" onchange="analyticsLoadTrends()" class="text-xs font-mono px-2 py-1 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:#A1A1AA;outline:none;">
            <option value="7d">7 Days</option>
            <option value="30d" selected>30 Days</option>
            <option value="90d">90 Days</option>
            <option value="all">All Time</option>
          </select>
        </div>
        <div id="anTrendsCharts" class="hidden space-y-6">
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">TPS Over Time</label>
            <div style="height:320px"><canvas id="anTrendsTpsChart"></canvas></div>
          </div>
          <div class="card rounded-md p-5">
            <label class="section-label mb-4 block">TTFT Over Time (ms)</label>
            <div style="height:320px"><canvas id="anTrendsTtftChart"></canvas></div>
          </div>
        </div>
        <div id="anTrendsEmpty" class="card rounded-md p-10 text-center">
          <p class="text-zinc-600 font-body text-sm">Select models and a time period to see trends.</p>
        </div>
      </div>

    </div>

    <!-- ─── SCHEDULES TAB ─── -->
    <div id="view-schedules" class="hidden">
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Scheduled Benchmarks</h2>
          <p class="text-sm text-zinc-600 font-body">Automate recurring benchmarks on a fixed interval.</p>
        </div>
        <button onclick="schedOpenNewModal()" class="run-btn px-4 py-2 rounded-sm text-xs flex items-center gap-2">
          <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
          New Schedule
        </button>
      </div>

      <!-- Schedule list -->
      <div class="card rounded-md overflow-hidden">
        <table class="w-full text-sm results-table">
          <thead>
            <tr style="border-bottom: 1px solid var(--border-subtle)">
              <th class="px-5 py-3 text-left section-label">Name</th>
              <th class="px-5 py-3 text-center section-label">Models</th>
              <th class="px-5 py-3 text-center section-label">Interval</th>
              <th class="px-5 py-3 text-right section-label">Last Run</th>
              <th class="px-5 py-3 text-right section-label">Next Run</th>
              <th class="px-5 py-3 text-center section-label">Enabled</th>
              <th class="px-5 py-3 text-right section-label"></th>
            </tr>
          </thead>
          <tbody id="schedTableBody">
            <tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">Loading schedules...</td></tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- ─── TOOL EVAL TAB ─── -->
    <div id="view-tool-eval" class="hidden">

      <!-- Sub-View 1: Suite List (default) -->
      <div id="te-suites-view">
        <div class="flex items-center justify-between mb-6">
          <div>
            <h2 class="font-display font-bold text-lg text-zinc-100 mb-1">Tool Calling Evaluation</h2>
            <p class="text-sm text-zinc-600 font-body">Define tool suites, create test cases, and evaluate model accuracy.</p>
          </div>
          <div class="flex items-center gap-2">
            <button onclick="teNewSuite()" class="run-btn px-4 py-2 rounded-sm text-xs flex items-center gap-2">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"/></svg>
              New Suite
            </button>
            <button onclick="teImportSuiteJson()" class="px-4 py-2 rounded-sm text-xs flex items-center gap-2 border border-zinc-700 text-zinc-400 hover:text-zinc-200 hover:border-zinc-500 transition-colors">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"/></svg>
              Import Suite
            </button>
            <button onclick="mcpOpenModal()" class="px-4 py-2 rounded-sm text-xs flex items-center gap-2 border border-zinc-700 text-zinc-400 hover:text-zinc-200 hover:border-zinc-500 transition-colors">
              <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
              Import from MCP
            </button>
          </div>
        </div>

        <!-- Suite List Table -->
        <div class="card rounded-md overflow-hidden mb-6">
          <table class="w-full text-sm results-table">
            <thead>
              <tr style="border-bottom: 1px solid var(--border-subtle)">
                <th class="px-5 py-3 text-left section-label">Name</th>
                <th class="px-5 py-3 text-center section-label">Tools</th>
                <th class="px-5 py-3 text-center section-label">Cases</th>
                <th class="px-5 py-3 text-right section-label">Last Updated</th>
                <th class="px-5 py-3 text-right section-label"></th>
              </tr>
            </thead>
            <tbody id="teSuitesBody">
              <tr><td colspan="5" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">Loading suites...</td></tr>
            </tbody>
          </table>
        </div>

        <!-- Eval History Section -->
        <div class="mb-6">
          <div class="flex items-center justify-between mb-4">
            <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase">Eval History</h3>
            <button onclick="downloadCSV('/api/export/tool-eval?format=csv', 'tool-eval-history.csv')" style="border: 1px solid #555; background: transparent; color: var(--lime); padding: 4px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; font-family: 'Outfit', sans-serif;">Export CSV</button>
          </div>
          <div class="card rounded-md overflow-hidden">
            <table class="w-full text-sm results-table">
              <thead>
                <tr style="border-bottom: 1px solid var(--border-subtle)">
                  <th class="px-5 py-3 text-left section-label">Timestamp</th>
                  <th class="px-5 py-3 text-left section-label">Suite</th>
                  <th class="px-5 py-3 text-left section-label">Models</th>
                  <th class="px-5 py-3 text-right section-label">Overall</th>
                  <th class="px-5 py-3 text-right section-label"></th>
                </tr>
              </thead>
              <tbody id="teHistoryBody">
                <tr><td colspan="5" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No eval runs yet.</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Sub-View 2: Suite Editor -->
      <div id="te-editor-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="showToolEvalView('suites')" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back to Suites
          </button>
          <button onclick="teStartRunFromEditor()" class="run-btn px-4 py-2 rounded-sm text-xs flex items-center gap-2">
            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
            Run Eval
          </button>
        </div>

        <!-- Suite Name + Description -->
        <div class="card rounded-md p-5 mb-6">
          <div class="grid grid-cols-1 lg:grid-cols-2 gap-4">
            <div>
              <label class="section-label mb-2 block">Suite Name</label>
              <input id="teSuiteName" class="w-full px-3 py-2 rounded-sm text-sm font-body text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" placeholder="e.g., Customer Support Tools" onchange="teSaveSuiteMeta()">
            </div>
            <div>
              <label class="section-label mb-2 block">Description</label>
              <input id="teSuiteDesc" class="w-full px-3 py-2 rounded-sm text-sm font-body text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" placeholder="Optional description" onchange="teSaveSuiteMeta()">
            </div>
          </div>
        </div>

        <!-- Tools Section -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <label class="section-label">Tools <span id="teToolCount" class="text-zinc-600">(0)</span></label>
            <div class="flex gap-2">
              <button onclick="teExportTools()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Export Tools</button>
              <button onclick="teImportToolsJson()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Import Tools</button>
              <button onclick="teAddTool()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: var(--lime); border: 1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">+ Add Tool</button>
            </div>
          </div>
          <div id="teToolsList" class="space-y-2">
            <p class="text-zinc-600 text-xs font-body">No tools defined yet.</p>
          </div>
          <!-- Inline tool JSON editor (hidden by default) -->
          <div id="teToolEditor" class="hidden mt-4" style="border-top:1px solid var(--border-subtle);padding-top:16px;">
            <label class="section-label mb-2 block">Tool JSON <span class="text-zinc-600 normal-case">(OpenAI function calling format)</span></label>
            <textarea id="teToolJson" rows="12" class="prompt-input w-full rounded-sm px-4 py-3 font-mono text-xs" placeholder='{"type":"function","function":{"name":"my_tool","description":"...","parameters":{...}}}'></textarea>
            <div id="teToolJsonError" class="hidden text-xs mt-1" style="color:var(--coral)"></div>
            <div class="flex justify-end gap-2 mt-3">
              <button onclick="teCancelToolEdit()" class="modal-btn modal-btn-cancel text-xs">Cancel</button>
              <button onclick="teSaveToolJson()" class="modal-btn modal-btn-confirm text-xs">Save Tool</button>
            </div>
          </div>
        </div>

        <!-- Test Cases Section -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <label class="section-label">Test Cases <span id="teCaseCount" class="text-zinc-600">(0)</span></label>
            <div class="flex gap-2">
              <button onclick="teImportCasesJson()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:#38BDF8;border:1px solid rgba(56,189,248,0.2);" onmouseover="this.style.borderColor='rgba(56,189,248,0.5)'" onmouseout="this.style.borderColor='rgba(56,189,248,0.2)'">Import Cases</button>
              <button onclick="teAddCase()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: var(--lime); border: 1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">+ Add Case</button>
            </div>
          </div>
          <div id="teCasesList" class="space-y-2">
            <p class="text-zinc-600 text-xs font-body">No test cases defined yet.</p>
          </div>
          <!-- Inline case editor (hidden by default) -->
          <div id="teCaseEditor" class="hidden mt-4" style="border-top:1px solid var(--border-subtle);padding-top:16px;">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="section-label mb-2 block">Prompt</label>
                <textarea id="teCasePrompt" rows="3" class="prompt-input w-full rounded-sm px-3 py-2 text-sm" placeholder="Enter the user message..."></textarea>
              </div>
              <div>
                <label class="section-label mb-2 block">Expected Tool</label>
                <div class="flex items-center gap-2 mb-2">
                  <label class="flex items-center gap-1.5 cursor-pointer">
                    <input type="checkbox" id="teCaseNoTool" onchange="teToggleNoTool()" class="accent-[var(--lime)]">
                    <span class="text-xs text-zinc-500 font-body">No tool expected</span>
                  </label>
                </div>
                <input id="teCaseExpTool" class="w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;" placeholder="tool_name or comma-separated names">
                <label class="section-label mt-3 mb-2 block">Expected Params <span class="text-zinc-600 normal-case">(JSON, optional)</span></label>
                <textarea id="teCaseExpParams" rows="3" class="prompt-input w-full rounded-sm px-3 py-2 font-mono text-xs" placeholder='{"param_name": "value"}'></textarea>
              </div>
            </div>
            <div id="teCaseError" class="hidden text-xs mb-2" style="color:var(--coral)"></div>
            <div class="flex justify-end gap-2">
              <button onclick="teCancelCaseEdit()" class="modal-btn modal-btn-cancel text-xs">Cancel</button>
              <button onclick="teSaveCaseEdit()" class="modal-btn modal-btn-confirm text-xs">Save Case</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Sub-View 3: Run / Results -->
      <div id="te-run-view" class="hidden">
        <div class="flex items-center justify-between mb-6">
          <button onclick="teBackFromRun()" class="flex items-center gap-2 text-zinc-500 hover:text-zinc-300 transition-colors text-sm font-body">
            <svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7"/></svg>
            Back
          </button>
          <h3 id="teRunTitle" class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase"></h3>
        </div>

        <!-- Model selection for eval -->
        <div class="card rounded-md p-5 mb-6">
          <div class="flex items-center justify-between mb-4">
            <label class="section-label">Select Models</label>
            <div class="flex gap-2">
              <button onclick="teSelectAllModels()" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color: var(--lime); border: 1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">All</button>
              <button onclick="teClearModels()" class="text-[11px] font-display font-medium tracking-wider uppercase text-zinc-600 px-3 py-1 rounded-sm border transition-colors" style="border-color: var(--border-subtle)" onmouseover="this.style.borderColor='var(--border)'" onmouseout="this.style.borderColor='var(--border-subtle)'">Clear</button>
            </div>
          </div>
          <div id="teModelGrid" class="flex flex-col gap-1"></div>
          <div class="flex items-center gap-4 mt-4 pt-4" style="border-top:1px solid var(--border-subtle)">
            <div>
              <span class="text-zinc-500 font-body text-xs">Temperature</span>
              <input id="teTemperature" type="number" min="0" max="2" step="0.1" value="0.0" class="ml-2 w-16 px-2 py-1 rounded-sm text-sm font-mono text-zinc-200 text-center" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
            </div>
            <div>
              <label class="text-xs font-display tracking-wider text-zinc-500 uppercase">Tool Choice</label>
              <select id="teToolChoice" class="text-xs font-mono px-3 py-1.5 rounded-sm ml-2" style="background:var(--surface);border:1px solid var(--border-subtle);color:var(--zinc-200);width:120px">
                <option value="required">Required</option>
                <option value="auto">Auto</option>
                <option value="none">None</option>
              </select>
            </div>
            <div class="ml-auto flex gap-2">
              <button id="teCancelEvalBtn" onclick="teCancelEval()" class="hidden text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors" style="color:var(--coral);border:1px solid rgba(255,59,92,0.3);" onmouseover="this.style.borderColor='rgba(255,59,92,0.6)'" onmouseout="this.style.borderColor='rgba(255,59,92,0.3)'">Cancel</button>
              <button id="teStartBtn" onclick="teStartEval()" class="run-btn px-6 py-2 rounded-sm text-xs flex items-center gap-2">
                <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                Start Eval
              </button>
            </div>
          </div>
        </div>

        <!-- Progress Section -->
        <div id="teProgressSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <div class="flex items-center justify-between mb-3">
              <div class="flex items-center gap-3">
                <div class="pulse-dot"></div>
                <span id="teProgressLabel" class="text-sm text-zinc-400 font-body">Initializing...</span>
              </div>
              <span id="teProgressCount" class="text-xs font-mono text-zinc-600">0/0</span>
            </div>
            <div class="progress-track rounded-full overflow-hidden">
              <div id="teProgressBar" class="progress-fill" style="width:0%"></div>
            </div>
          </div>
          <div id="teSSEBanner" class="hidden error-banner mt-3">
            <span id="teSSEBannerMsg">Connection lost</span>
          </div>
        </div>

        <!-- Summary Section -->
        <div id="teSummarySection" class="hidden mb-6 fade-in">
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3 flex items-center" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">Results Summary</span>
              <span id="teSummaryInfo" class="text-xs font-body text-zinc-600 ml-2"></span>
              <button id="teExportBtn" onclick="teExportResults()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm hidden ml-auto" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">Export JSON</button>
            </div>
            <table class="w-full text-sm results-table">
              <thead>
                <tr style="border-bottom: 1px solid var(--border-subtle)">
                  <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="teSortSummary('model_name')">Model</th>
                  <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="teSortSummary('tool_accuracy_pct')">Tool %</th>
                  <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="teSortSummary('param_accuracy_pct')">Param %</th>
                  <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="teSortSummary('overall_pct')">Overall</th>
                  <th class="px-5 py-3 text-right section-label">Cases</th>
                </tr>
              </thead>
              <tbody id="teSummaryBody"></tbody>
            </table>
          </div>
        </div>

        <!-- Detailed Results (drill-down) -->
        <div id="teDetailSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md p-5">
            <div class="flex items-center justify-between mb-4">
              <span class="section-label">Detailed Results</span>
              <button onclick="document.getElementById('teDetailSection').classList.add('hidden')" class="text-zinc-600 hover:text-zinc-400 text-xs font-body">Close</button>
            </div>
            <div id="teDetailContent" class="space-y-3"></div>
          </div>
        </div>

        <!-- Live Results Table -->
        <div id="teLiveSection" class="hidden mb-6 fade-in">
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">Live Results</span>
            </div>
            <div id="teLiveResults" class="max-h-96 overflow-y-auto">
              <table class="w-full text-sm results-table">
                <thead>
                  <tr style="border-bottom: 1px solid var(--border-subtle)">
                    <th class="px-5 py-2 text-left section-label">Model</th>
                    <th class="px-5 py-2 text-left section-label">Test Case</th>
                    <th class="px-5 py-2 text-left section-label">Expected</th>
                    <th class="px-5 py-2 text-left section-label">Actual</th>
                    <th class="px-5 py-2 text-right section-label">Score</th>
                  </tr>
                </thead>
                <tbody id="teLiveBody"></tbody>
              </table>
            </div>
          </div>
        </div>
      </div>

      <!-- MCP Import Modal -->
      <div id="mcpModal" class="modal-overlay hidden" onclick="if(event.target===this)mcpCloseModal()">
        <div class="modal-box" style="max-width:600px; max-height:80vh; overflow-y:auto">
          <div class="modal-title flex items-center justify-between">
            Import Tools from MCP Server
            <button onclick="mcpCloseModal()" class="text-zinc-500 hover:text-zinc-300">&times;</button>
          </div>

          <!-- Step 1: Connect -->
          <div id="mcpStep1">
            <div class="mt-4">
              <label class="section-label block mb-1">MCP Server URL</label>
              <div class="flex gap-2">
                <input id="mcpUrl" type="url" placeholder="http://localhost:3001/sse"
                       class="flex-1 bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-zinc-200 font-mono">
                <button onclick="mcpConnect()" id="mcpConnectBtn" class="run-btn px-4 py-2 rounded-sm text-xs">
                  Connect
                </button>
              </div>
              <p class="text-xs text-zinc-600 mt-2">Enter the SSE endpoint URL of your MCP server</p>
            </div>
            <div id="mcpConnectError" class="text-red-400 text-xs mt-2 hidden"></div>
            <div id="mcpConnecting" class="text-zinc-500 text-xs mt-2 hidden">Connecting...</div>
          </div>

          <!-- Step 2: Preview & Select -->
          <div id="mcpStep2" class="hidden">
            <div class="text-sm text-zinc-400 mt-2 mb-3" id="mcpServerInfo"></div>

            <div class="flex gap-2 mb-3">
              <button onclick="mcpSelectAll(true)" class="text-xs text-zinc-500 hover:text-zinc-300">Select All</button>
              <span class="text-zinc-700">|</span>
              <button onclick="mcpSelectAll(false)" class="text-xs text-zinc-500 hover:text-zinc-300">Deselect All</button>
            </div>

            <div id="mcpToolList" class="space-y-2 mb-4" style="max-height:300px; overflow-y:auto"></div>

            <div class="space-y-3 border-t border-zinc-800 pt-3">
              <div>
                <label class="section-label block mb-1">Suite Name</label>
                <input id="mcpSuiteName" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-zinc-200">
              </div>
              <div>
                <label class="section-label block mb-1">Description</label>
                <input id="mcpSuiteDesc" class="w-full bg-zinc-900 border border-zinc-700 rounded px-3 py-2 text-sm text-zinc-200">
              </div>
              <label class="flex items-center gap-2 text-sm text-zinc-400">
                <input type="checkbox" id="mcpGenTests" checked> Generate sample test cases
              </label>
            </div>

            <div class="modal-buttons mt-4">
              <button onclick="mcpCloseModal()" class="modal-btn modal-btn-cancel">Cancel</button>
              <button onclick="mcpImport()" id="mcpImportBtn" class="modal-btn modal-btn-confirm">
                Import Tools
              </button>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- App version footer -->
    <div id="app-version-footer" style="text-align:center; padding:12px 0 16px; margin-top:24px;">
      <span id="app-version" style="font-family:'Space Mono',monospace; font-size:11px; color:#63636B;"></span>
    </div>

  </main>

  <!-- ═══════════════════════════ SCRIPT ═══════════════════════════ -->
  <script>
    // --- Auth state ---
    let authToken = localStorage.getItem('auth_token') || null;
    let currentUser = null;

    // --- Auth-aware fetch wrapper ---
    async function apiFetch(url, options = {}) {
      if (!options.headers) options.headers = {};
      if (authToken) {
        options.headers['Authorization'] = `Bearer ${authToken}`;
      }
      if (options.body && !options.headers['Content-Type']) {
        options.headers['Content-Type'] = 'application/json';
      }
      const res = await fetch(url, options);
      if (res.status === 401) {
        // Try refresh
        const refreshed = await tryRefreshToken();
        if (refreshed) {
          options.headers['Authorization'] = `Bearer ${authToken}`;
          return fetch(url, options);
        }
        // Refresh failed - show landing
        showLandingPage();
        throw new Error('Authentication required');
      }
      return res;
    }

    async function tryRefreshToken() {
      try {
        const res = await fetch('/api/auth/refresh', { method: 'POST', credentials: 'include' });
        if (!res.ok) return false;
        const data = await res.json();
        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('auth_token', authToken);
        updateAuthUI();
        return true;
      } catch {
        return false;
      }
    }

    // -------------------------------------------------------------------
    // State
    // -------------------------------------------------------------------
    let config = null;
    let selectedModels = new Set();
    let currentResults = [];
    let toksChart = null;
    let ttftChart = null;
    let scatterChart = null;
    let cachedEnvKeys = [];
    let discoveredModelsCache = {}; // providerKey -> [{id, display_name}]
    let _sseTimeout = null;
    let _lastBenchmarkBody = null;
    let providerProgress = {}; // provider -> {currentModel, currentRun, totalRuns, completedSteps, totalSteps, status, errors[]}

    const POSITION_LABELS = ['P1', 'P2', 'P3'];

    // -------------------------------------------------------------------
    // Toast notifications
    // -------------------------------------------------------------------
    function showToast(message, type = '') {
      const container = document.getElementById('toastContainer');
      const el = document.createElement('div');
      el.className = `toast ${type ? 'toast-' + type : ''}`;
      el.textContent = message;
      container.appendChild(el);
      setTimeout(() => { el.classList.add('toast-out'); setTimeout(() => el.remove(), 300); }, 3000);
    }

    // -------------------------------------------------------------------
    // Modal system
    // -------------------------------------------------------------------
    function _closeModal(overlay) {
      overlay.classList.add('modal-closing');
      setTimeout(() => overlay.remove(), 200);
    }

    function showModal(title, message, onConfirm, opts = {}) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      const danger = opts.danger || false;
      overlay.innerHTML = `<div class="modal-box">
        <div class="modal-title">${title}</div>
        <div class="modal-message">${message}</div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn ${danger ? 'modal-btn-danger' : 'modal-btn-confirm'}" data-action="confirm">${opts.confirmLabel || 'Confirm'}</button>
        </div>
      </div>`;
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => { _closeModal(overlay); onConfirm(); };
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
    }

    function showInputModal(title, placeholder, onConfirm, opts = {}) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `<div class="modal-box">
        <div class="modal-title">${title}</div>
        ${opts.message ? `<div class="modal-message">${opts.message}</div>` : ''}
        <input class="modal-input" placeholder="${placeholder}" ${opts.inputType ? `type="${opts.inputType}"` : ''} value="${opts.defaultValue || ''}">
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">${opts.confirmLabel || 'OK'}</button>
        </div>
      </div>`;
      const input = overlay.querySelector('.modal-input');
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => { const v = input.value; _closeModal(overlay); onConfirm(v); };
      input.addEventListener('keydown', (e) => { if (e.key === 'Enter') { const v = input.value; _closeModal(overlay); onConfirm(v); } });
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => input.focus(), 50);
    }

    function showDoubleInputModal(title, fields, onConfirm) {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      let fieldsHtml = fields.map((f, i) => `<div style="margin-bottom:${i < fields.length-1 ? '12px' : '16px'}"><div style="font-size:11px;color:#85858F;margin-bottom:4px;font-family:'Chakra Petch',sans-serif;text-transform:uppercase;letter-spacing:0.04em">${f.label}</div><input class="modal-input" style="margin-bottom:0" placeholder="${f.placeholder || ''}" ${f.type ? `type="${f.type}"` : ''}></div>`).join('');
      overlay.innerHTML = `<div class="modal-box">
        <div class="modal-title">${title}</div>
        ${fieldsHtml}
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">OK</button>
        </div>
      </div>`;
      const inputs = overlay.querySelectorAll('.modal-input');
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => { const vals = [...inputs].map(i => i.value); _closeModal(overlay); onConfirm(...vals); };
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => inputs[0]?.focus(), 50);
    }

    const PROVIDER_COLORS = {
      'ZAI GLM':             { bg: 'rgba(191,255,0,0.08)',  border: 'rgba(191,255,0,0.3)',  text: '#BFFF00', bar: '#BFFF00' },
      'LM Studio (Desktop)': { bg: 'rgba(56,189,248,0.08)', border: 'rgba(56,189,248,0.3)', text: '#38BDF8', bar: '#38BDF8' },
      'LM Studio (Mac)':     { bg: 'rgba(129,140,248,0.08)',border: 'rgba(129,140,248,0.3)',text: '#818CF8', bar: '#818CF8' },
      'LM Studio (Local)':   { bg: 'rgba(56,189,248,0.08)', border: 'rgba(56,189,248,0.3)', text: '#38BDF8', bar: '#38BDF8' },
      'OpenAI':              { bg: 'rgba(168,162,158,0.08)', border: 'rgba(168,162,158,0.3)', text: '#A8A29E', bar: '#A8A29E' },
      'Anthropic':           { bg: 'rgba(251,113,133,0.08)', border: 'rgba(251,113,133,0.3)', text: '#FB7185', bar: '#FB7185' },
      'Google Gemini':       { bg: 'rgba(96,165,250,0.08)',  border: 'rgba(96,165,250,0.3)',  text: '#60A5FA', bar: '#60A5FA' },
    };
    const DEFAULT_COLOR = { bg: 'rgba(251,146,60,0.08)', border: 'rgba(251,146,60,0.3)', text: '#FB923C', bar: '#FB923C' };

    function getColor(provider) { return PROVIDER_COLORS[provider] || DEFAULT_COLOR; }

    function safeId(str) { return str.replace(/[^a-zA-Z0-9_-]/g, '_'); }

    function slugify(str) {
      return str.toLowerCase().replace(/[^a-z0-9]+/g, '_').replace(/^_|_$/g, '');
    }

    function uniqueProviderKey(base) {
      if (!config || !config.providers) return base;
      const existing = new Set(Object.values(config.providers).map(p => p.provider_key));
      if (!existing.has(base)) return base;
      for (let i = 2; i < 100; i++) {
        const candidate = `${base}_${i}`;
        if (!existing.has(candidate)) return candidate;
      }
      return base + '_' + Date.now();
    }

    function detectPrefix(models) {
      if (!models || models.length === 0) return '';
      const ids = models.map(m => m.model_id || m.id || '');
      const firstSlash = ids[0].indexOf('/');
      if (firstSlash < 1) return '';
      const candidate = ids[0].substring(0, firstSlash);
      if (ids.every(id => id.startsWith(candidate + '/'))) return candidate;
      return '';
    }

    function formatCtxSize(tokens) {
      if (tokens >= 1000000) return (tokens / 1000000).toFixed(0) + 'M ctx';
      if (tokens >= 1000) return (tokens / 1000).toFixed(0) + 'K ctx';
      return tokens + ' ctx';
    }

    // -------------------------------------------------------------------
    // Context Tiers
    // -------------------------------------------------------------------
    const TIER_OPTIONS = [
      { value: 0, label: '0' },
      { value: 1000, label: '1K' },
      { value: 5000, label: '5K' },
      { value: 10000, label: '10K' },
      { value: 20000, label: '20K' },
      { value: 50000, label: '50K' },
      { value: 100000, label: '100K' },
      { value: 150000, label: '150K' },
    ];
    let selectedTiers = new Set([0]);

    function renderTierChips() {
      const container = document.getElementById('tierChips');
      container.innerHTML = TIER_OPTIONS.map(t => {
        const selected = selectedTiers.has(t.value);
        return `<button onclick="toggleTier(${t.value})" class="text-[11px] font-mono px-3 py-1.5 rounded-sm transition-all ${selected ? '' : 'text-zinc-600 hover:text-zinc-400'}" style="${selected ? 'background:var(--lime-dim);color:var(--lime);border:1px solid rgba(191,255,0,0.3)' : 'background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle)'}">${t.label}</button>`;
      }).join('');

      // Show/hide stress test badge
      const badge = document.getElementById('tierBadge');
      if (selectedTiers.size > 1 || (selectedTiers.size === 1 && !selectedTiers.has(0))) {
        badge.classList.remove('hidden');
      } else {
        badge.classList.add('hidden');
      }

      updateTierWarnings();
    }

    function toggleTier(value) {
      if (selectedTiers.has(value)) {
        selectedTiers.delete(value);
        if (selectedTiers.size === 0) selectedTiers.add(0); // Always have at least one
      } else {
        selectedTiers.add(value);
      }
      renderTierChips();
    }

    function updateTierWarnings() {
      const container = document.getElementById('tierWarnings');
      if (!config) { container.innerHTML = ''; return; }

      const warnings = [];
      const maxTier = Math.max(...selectedTiers);

      for (const [provider, provData] of Object.entries(config.providers)) {
        const models = getProviderModels(provData);
        for (const m of models) {
          if (!selectedModels.has(m.model_id)) continue;
          if (m.context_window && maxTier > m.context_window) {
            warnings.push(`<div class="text-[10px] font-body" style="color:#FBBF24;">${m.display_name}: ${formatCtxSize(maxTier).replace(' ctx','')} &gt; ${formatCtxSize(m.context_window)}</div>`);
          }
        }
      }
      container.innerHTML = warnings.join('');
    }

    // -------------------------------------------------------------------
    // Init
    // -------------------------------------------------------------------
    async function init() {
      try {
        const res = await apiFetch('/api/config');
        config = await res.json();
        renderModels();
        if (config.defaults?.prompt) {
          document.getElementById('prompt').value = config.defaults.prompt.trim();
        }
        if (config.defaults?.max_tokens) {
          document.getElementById('maxTokens').value = config.defaults.max_tokens;
          document.getElementById('maxTokensVal').textContent = config.defaults.max_tokens;
        }
        if (config.defaults?.temperature !== undefined) {
          document.getElementById('temperature').value = config.defaults.temperature;
          document.getElementById('tempVal').textContent = parseFloat(config.defaults.temperature).toFixed(1);
        }
        renderTierChips();
      } catch (e) {
        console.error('Failed to load config:', e);
        document.getElementById('initErrorBanner').classList.remove('hidden');
      }
    }

    // -------------------------------------------------------------------
    // Model selection
    // -------------------------------------------------------------------
    function getProviderModels(provData) {
      // Handle both old shape (array) and new shape ({models: [...]})
      return Array.isArray(provData) ? provData : (provData.models || []);
    }

    function renderModels() {
      const grid = document.getElementById('modelGrid');
      grid.innerHTML = '';

      for (const [provider, provData] of Object.entries(config.providers)) {
        const color = getColor(provider);
        const models = getProviderModels(provData);
        if (!models.length) continue;

        // Provider group container
        const group = document.createElement('div');
        group.className = 'provider-group';
        group.style.borderColor = color.border;

        // Provider header — click to toggle all models in group
        const header = document.createElement('div');
        header.className = 'provider-group-header';
        header.innerHTML = `
          <div class="provider-group-dot" style="background:${color.text}"></div>
          <span class="provider-group-label" style="color:${color.text}">${provider}</span>
          <span class="provider-group-count">${models.length} model${models.length > 1 ? 's' : ''}</span>
        `;
        header.onclick = () => {
          const cards = group.querySelectorAll('.model-card');
          const allSelected = [...cards].every(c => c.classList.contains('selected'));
          cards.forEach(c => {
            if (allSelected) { selectedModels.delete(c.dataset.modelId); c.classList.remove('selected'); }
            else { selectedModels.add(c.dataset.modelId); c.classList.add('selected'); }
          });
        };
        group.appendChild(header);

        // Model cards sub-grid
        const subgrid = document.createElement('div');
        subgrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 pl-3';
        for (const m of models) {
          selectedModels.add(m.model_id);
          const card = document.createElement('div');
          card.className = 'model-card selected rounded-sm px-4 py-3 flex items-center gap-3';
          card.dataset.modelId = m.model_id;
          card.onclick = (e) => { e.stopPropagation(); toggleModel(m.model_id, card); };
          card.innerHTML = `
            <div class="check-dot flex-shrink-0"></div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <div class="text-[13px] font-medium text-zinc-200 truncate font-body">${m.display_name}</div>
                ${m.context_window ? `<span class="text-[9px] font-mono px-1.5 py-0.5 rounded-sm" style="background:rgba(255,255,255,0.04);color:#85858F;">${formatCtxSize(m.context_window)}</span>` : ''}
              </div>
            </div>
          `;
          subgrid.appendChild(card);
        }
        group.appendChild(subgrid);
        grid.appendChild(group);
      }
    }

    function toggleModel(modelId, card) {
      if (selectedModels.has(modelId)) {
        selectedModels.delete(modelId);
        card.classList.remove('selected');
      } else {
        selectedModels.add(modelId);
        card.classList.add('selected');
      }
    }

    function selectAll() {
      document.querySelectorAll('.model-card').forEach(card => {
        selectedModels.add(card.dataset.modelId);
        card.classList.add('selected');
      });
    }

    function selectNone() {
      selectedModels.clear();
      document.querySelectorAll('.model-card').forEach(c => c.classList.remove('selected'));
    }

    // -------------------------------------------------------------------
    // Benchmark execution
    // -------------------------------------------------------------------
    function _resetRunBtn() {
      const btn = document.getElementById('runBtn');
      btn.disabled = false;
      btn.innerHTML = `<svg class="w-4 h-4" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Run Benchmark`;
    }

    function _showSSEError(msg) {
      const banner = document.getElementById('sseBanner');
      document.getElementById('sseBannerMsg').textContent = msg;
      banner.classList.remove('hidden');
    }

    async function cancelBenchmark() {
      try {
        await apiFetch('/api/benchmark/cancel', { method: 'POST' });
        showToast('Cancellation requested...', '');
      } catch (e) {
        showToast('Failed to cancel', 'error');
      }
    }

    function retryBenchmark() {
      document.getElementById('sseBanner').classList.add('hidden');
      if (_lastBenchmarkBody) startBenchmark(_lastBenchmarkBody);
    }

    async function startBenchmark(overrideBody) {
      if (!overrideBody && selectedModels.size === 0) {
        showToast('Select at least one model', 'error');
        return;
      }

      const btn = document.getElementById('runBtn');
      btn.disabled = true;
      btn.innerHTML = `<svg class="w-4 h-4 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> RUNNING...`;

      currentResults = [];
      document.getElementById('progressSection').classList.remove('hidden');
      document.getElementById('progressSkipped').innerHTML = '';
      document.getElementById('sseBanner').classList.add('hidden');
      document.getElementById('resultsSection').classList.add('hidden');

      const body = overrideBody || {
        models: Array.from(selectedModels),
        runs: parseInt(document.getElementById('runs').value),
        max_tokens: parseInt(document.getElementById('maxTokens').value),
        temperature: parseFloat(document.getElementById('temperature').value),
        prompt: document.getElementById('prompt').value,
        context_tiers: Array.from(selectedTiers).sort((a, b) => a - b),
        warmup: document.getElementById('warmupToggle').checked,
      };
      _lastBenchmarkBody = body;

      // Initialize per-provider progress tracking
      initProviderProgress(body);
      renderProviderProgress();

      try {
        const res = await apiFetch('/api/benchmark', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        // Handle HTTP 409 - concurrent benchmark
        if (res.status === 409) {
          showToast('A benchmark is already running', 'error');
          _resetRunBtn();
          return;
        }
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || `Server error (${res.status})`, 'error');
          _resetRunBtn();
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        // SSE no-data timeout (30s)
        const resetTimeout = () => {
          if (_sseTimeout) clearTimeout(_sseTimeout);
          _sseTimeout = setTimeout(() => {
            _showSSEError('Connection lost - no data received for 30 seconds');
            _resetRunBtn();
          }, 30000);
        };
        resetTimeout();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          resetTimeout();
          buffer += decoder.decode(value, { stream: true });

          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try { handleSSE(JSON.parse(line.slice(6))); } catch (e) {}
            }
          }
        }
        if (_sseTimeout) clearTimeout(_sseTimeout);
      } catch (e) {
        console.error('Benchmark error:', e);
        _showSSEError('Connection error: ' + (e.message || 'Network failure'));
      }

      _resetRunBtn();
    }

    // -------------------------------------------------------------------
    // Per-provider progress tracking
    // -------------------------------------------------------------------
    function initProviderProgress(body) {
      providerProgress = {};
      if (!config || !config.providers) return;

      const selectedSet = new Set(body.models || []);
      const runs = body.runs || 1;
      const tiers = body.context_tiers || [0];
      const maxTokens = body.max_tokens || 4096;

      for (const [provider, provData] of Object.entries(config.providers)) {
        const models = getProviderModels(provData);
        const selectedInProvider = models.filter(m => selectedSet.has(m.model_id));
        if (selectedInProvider.length === 0) continue;

        // Count steps: for each model, for each tier, count runs (skip tiers that exceed context window)
        let totalSteps = 0;
        for (const m of selectedInProvider) {
          for (const tier of tiers) {
            const headroom = (m.context_window || Infinity) - maxTokens - 100;
            if (tier === 0 || tier <= headroom) {
              totalSteps += runs;
            }
          }
        }

        providerProgress[provider] = {
          currentModel: null,
          currentRun: 0,
          totalRuns: runs,
          completedSteps: 0,
          totalSteps: totalSteps,
          status: 'waiting', // waiting | running | done | error
          errors: [],
        };
      }
    }

    function renderProviderProgress() {
      const panel = document.getElementById('providerProgressPanel');
      if (!panel) return;

      // Update overall counter
      let totalCompleted = 0, totalAll = 0;
      for (const p of Object.values(providerProgress)) {
        totalCompleted += p.completedSteps;
        totalAll += p.totalSteps;
      }
      document.getElementById('progressCount').textContent = `${totalCompleted}/${totalAll}`;

      // Update overall label
      const runningProviders = Object.entries(providerProgress).filter(([, p]) => p.status === 'running');
      if (runningProviders.length > 0) {
        document.getElementById('progressLabel').textContent = `Running ${runningProviders.length} provider${runningProviders.length > 1 ? 's' : ''} in parallel`;
      }

      // Build rows
      const rows = [];
      for (const [name, p] of Object.entries(providerProgress)) {
        const color = getColor(name);
        const pct = p.totalSteps > 0 ? (p.completedSteps / p.totalSteps * 100) : 0;
        const isDone = p.completedSteps >= p.totalSteps;
        const hasError = p.errors.length > 0;

        let statusText = '';
        let statusIcon = '';
        if (isDone && !hasError) {
          statusText = 'Complete';
          statusIcon = '<span style="color:#4ADE80;">&#10003;</span> ';
        } else if (isDone && hasError) {
          statusText = 'Done with errors';
          statusIcon = '<span style="color:#FBBF24;">&#9888;</span> ';
        } else if (p.status === 'running' && p.currentModel) {
          const tierLabel = p.currentContextTokens > 0 ? ` @ ${p.currentContextTokens >= 1000 ? (p.currentContextTokens / 1000) + 'K' : p.currentContextTokens} ctx` : '';
          statusText = `${p.currentModel}${tierLabel} (run ${p.currentRun}/${p.totalRuns})`;
        } else {
          statusText = 'Waiting\u2026';
        }

        const barColor = hasError ? '#FBBF24' : (isDone ? '#4ADE80' : color.bar);
        const barShadow = isDone ? 'none' : `0 0 8px ${color.bar}44`;

        rows.push(`
          <div class="provider-progress-row">
            <div class="ppr-name" style="color:${color.text};" title="${name}">${name}</div>
            <div class="ppr-mid">
              <div class="ppr-status">${statusIcon}${statusText}</div>
              <div class="ppr-track">
                <div class="ppr-fill${isDone ? ' done' : ''}" style="width:${pct.toFixed(1)}%;background-color:${barColor};box-shadow:${barShadow};"></div>
              </div>
            </div>
            <div class="ppr-count">${p.completedSteps}/${p.totalSteps}</div>
          </div>
        `);
      }

      // Error details at the bottom
      const errorLines = [];
      for (const [name, p] of Object.entries(providerProgress)) {
        for (const err of p.errors) {
          errorLines.push(`<div class="text-[11px] font-body" style="color:#FB7185;">${name} / ${err.model}: ${err.message}</div>`);
        }
      }

      panel.innerHTML = rows.join('') + (errorLines.length > 0 ? '<div class="mt-2 flex flex-col gap-1">' + errorLines.join('') + '</div>' : '');
    }

    function handleSSE(data) {
      const prov = data.provider;

      if (data.type === 'progress') {
        // Update per-provider state
        if (prov && providerProgress[prov]) {
          const pp = providerProgress[prov];
          pp.status = 'running';
          pp.currentModel = data.model;
          pp.currentRun = data.run;
          pp.totalRuns = data.runs;
          pp.currentContextTokens = data.context_tokens || 0;
        }
        renderProviderProgress();
      }
      if (data.type === 'skipped') {
        const el = document.getElementById('progressSkipped');
        el.innerHTML += `<div class="skipped-line">&#x23ED; ${data.model}: skipped (${data.reason || 'context exceeds window'})</div>`;
      }
      if (data.type === 'result') {
        // Increment completed steps for this provider
        if (prov && providerProgress[prov]) {
          const pp = providerProgress[prov];
          pp.completedSteps++;
          if (!data.success && data.error) {
            pp.errors.push({ model: data.model, message: data.error });
          }
          // Mark provider done if all steps completed
          if (pp.completedSteps >= pp.totalSteps) {
            pp.status = 'done';
            pp.currentModel = null;
          }
          renderProviderProgress();
        }
        currentResults.push(data);
        renderLiveResults();
      }
      if (data.type === 'cancelled') {
        showToast('Benchmark cancelled', 'error');
        document.getElementById('progressSection').classList.add('hidden');
        if (currentResults.length > 0) {
          document.getElementById('resultsSection').classList.remove('hidden');
          renderFinalResults();
        }
      }
      if (data.type === 'error') {
        // Per-provider error (has provider field) vs global error
        if (prov && providerProgress[prov]) {
          const pp = providerProgress[prov];
          pp.errors.push({ model: data.model || '?', message: data.message || 'Unknown error' });
          pp.completedSteps = pp.totalSteps; // mark as done
          pp.status = 'error';
          pp.currentModel = null;
          renderProviderProgress();
        } else {
          _showSSEError(data.message || 'Benchmark error');
        }
      }
      if (data.type === 'complete') {
        // Mark all remaining providers as done
        for (const pp of Object.values(providerProgress)) {
          if (pp.status !== 'done' && pp.status !== 'error') {
            pp.status = 'done';
            pp.completedSteps = pp.totalSteps;
            pp.currentModel = null;
          }
        }
        renderProviderProgress();
        document.getElementById('progressSection').classList.add('hidden');
        document.getElementById('resultsSection').classList.remove('hidden');
        if (currentResults.length === 0 || currentResults.every(r => !r.success)) {
          document.getElementById('statCards').innerHTML = `<div class="col-span-full error-banner">All benchmarks failed. Check your API keys and model configuration.</div>`;
        }
        renderFinalResults();
      }
    }

    // -------------------------------------------------------------------
    // Results rendering
    // -------------------------------------------------------------------
    function renderLiveResults() {
      document.getElementById('resultsSection').classList.remove('hidden');
      renderChart();
      renderTTFTChart();
      renderScatterChart();
      renderTable();
    }

    function renderFinalResults() {
      renderStatCards();
      renderChart();
      renderTTFTChart();
      renderScatterChart();
      renderTable();
    }

    function _stdDev(values) {
      if (values.length < 2) return 0;
      const mean = values.reduce((s, v) => s + v, 0) / values.length;
      const variance = values.reduce((s, v) => s + (v - mean) ** 2, 0) / (values.length - 1);
      return Math.sqrt(variance);
    }

    function _percentile(sorted, p) {
      if (sorted.length === 0) return 0;
      if (sorted.length === 1) return sorted[0];
      const idx = (p / 100) * (sorted.length - 1);
      const lo = Math.floor(idx), hi = Math.ceil(idx);
      return lo === hi ? sorted[lo] : sorted[lo] + (sorted[hi] - sorted[lo]) * (idx - lo);
    }

    function aggregateResults() {
      const grouped = {};
      for (const r of currentResults) {
        const key = `${r.model_id}::${r.provider}::${r.context_tokens || 0}`;
        if (!grouped[key]) grouped[key] = { ...r, _runs: [], _successes: 0 };
        grouped[key]._runs.push(r);
        if (r.success) grouped[key]._successes++;
      }
      return Object.values(grouped).map(g => {
        const successes = g._runs.filter(r => r.success);
        const n = successes.length;
        const tpsVals = successes.map(r => r.tokens_per_second).sort((a, b) => a - b);
        const ttftVals = successes.map(r => r.ttft_ms).sort((a, b) => a - b);
        const inputTpsVals = successes.map(r => r.input_tokens_per_second || 0).filter(v => v > 0);
        const costVals = successes.map(r => r.cost || 0);
        return {
          provider: g.provider, model: g.model, model_id: g.model_id,
          context_tokens: g.context_tokens || 0,
          tokens_per_second: n ? successes.reduce((s, r) => s + r.tokens_per_second, 0) / n : 0,
          ttft_ms: n ? successes.reduce((s, r) => s + r.ttft_ms, 0) / n : 0,
          total_time_s: n ? successes.reduce((s, r) => s + r.total_time_s, 0) / n : 0,
          output_tokens: n ? successes.reduce((s, r) => s + r.output_tokens, 0) / n : 0,
          input_tokens_per_second: inputTpsVals.length ? inputTpsVals.reduce((s, v) => s + v, 0) / inputTpsVals.length : 0,
          avg_cost: n ? costVals.reduce((s, v) => s + v, 0) / n : 0,
          total_cost: costVals.reduce((s, v) => s + v, 0),
          std_dev_tps: _stdDev(tpsVals),
          std_dev_ttft: _stdDev(ttftVals),
          p50_tps: _percentile(tpsVals, 50),
          p95_tps: _percentile(tpsVals, 95),
          min_tps: tpsVals.length ? tpsVals[0] : 0,
          max_tps: tpsVals.length ? tpsVals[tpsVals.length - 1] : 0,
          success: g._successes > 0,
          runs: g._runs.length,
          failures: g._runs.length - g._successes,
          error: g._runs.find(r => !r.success)?.error || '',
        };
      }).sort((a, b) => b.tokens_per_second - a.tokens_per_second);
    }

    function isStressMode() {
      const tiers = new Set(currentResults.map(r => r.context_tokens || 0));
      return tiers.size > 1;
    }

    function renderStatCards() {
      const agg = aggregateResults();
      const container = document.getElementById('statCards');
      if (!agg.length || !agg[0].success) { container.innerHTML = ''; return; }

      const stress = isStressMode();

      if (!stress) {
        // Standard stat cards (existing behavior)
        const winner = agg[0];
        const fastestTTFT = [...agg].filter(a => a.success).sort((a, b) => a.ttft_ms - b.ttft_ms)[0];
        const totalModels = agg.length;
        const totalFails = agg.reduce((s, a) => s + a.failures, 0);
        const grandTotalCost = agg.reduce((s, a) => s + a.total_cost, 0);

        container.innerHTML = `
          <div class="stat-card card-accent rounded-sm p-4">
            <div class="section-label mb-2">Fastest</div>
            <div class="big-num text-2xl text-zinc-100">${winner.tokens_per_second.toFixed(1)} <span class="text-xs font-normal" style="color:var(--lime)">tok/s</span></div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${winner.model}</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #38BDF8">
            <div class="section-label mb-2">Best TTFT</div>
            <div class="big-num text-2xl text-zinc-100">${fastestTTFT.ttft_ms.toFixed(0)}<span class="text-xs font-normal text-zinc-500">ms</span></div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${fastestTTFT.model}</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #8B8B95">
            <div class="section-label mb-2">Models</div>
            <div class="big-num text-2xl text-zinc-100">${totalModels}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${agg.reduce((s,a) => s + a.runs, 0)} total runs</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid ${grandTotalCost > 0 ? '#FB923C' : '#22C55E'}">
            <div class="section-label mb-2">Total Cost</div>
            <div class="big-num text-2xl text-zinc-100">${grandTotalCost > 0 ? '$' + grandTotalCost.toFixed(4) : '$0'}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${totalFails ? totalFails + ' failure(s)' : 'All nominal'}</div>
          </div>
        `;
      } else {
        // Stress test stat cards
        const atZero = agg.filter(a => a.context_tokens === 0 && a.success).sort((a, b) => b.tokens_per_second - a.tokens_per_second);
        const maxTier = Math.max(...agg.map(a => a.context_tokens));
        const atMax = agg.filter(a => a.context_tokens === maxTier && a.success).sort((a, b) => b.tokens_per_second - a.tokens_per_second);
        const totalFails = agg.reduce((s, a) => s + a.failures, 0);
        const totalRuns = agg.reduce((s, a) => s + a.runs, 0);

        const bestZero = atZero[0];
        const bestMax = atMax[0];

        container.innerHTML = `
          <div class="stat-card card-accent rounded-sm p-4">
            <div class="section-label mb-2">Best @ 0K</div>
            ${bestZero ? `
              <div class="big-num text-2xl text-zinc-100">${bestZero.tokens_per_second.toFixed(1)} <span class="text-xs font-normal" style="color:var(--lime)">tok/s</span></div>
              <div class="text-[11px] text-zinc-600 mt-1 font-body">${bestZero.model}</div>
            ` : `<div class="text-zinc-600 text-sm font-body">N/A</div>`}
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #38BDF8">
            <div class="section-label mb-2">Best @ ${formatCtxSize(maxTier).replace(' ctx','')}</div>
            ${bestMax ? `
              <div class="big-num text-2xl text-zinc-100">${bestMax.tokens_per_second.toFixed(1)} <span class="text-xs font-normal" style="color:#38BDF8">tok/s</span></div>
              <div class="text-[11px] text-zinc-600 mt-1 font-body">${bestMax.model}</div>
            ` : `<div class="text-zinc-600 text-sm font-body">N/A</div>`}
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid #8B8B95">
            <div class="section-label mb-2">Tiers Tested</div>
            <div class="big-num text-2xl text-zinc-100">${new Set(agg.map(a => a.context_tokens)).size}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${totalRuns} total runs</div>
          </div>
          <div class="stat-card card rounded-sm p-4" style="border-left: 3px solid ${totalFails ? 'var(--coral)' : '#22C55E'}">
            <div class="section-label mb-2">Failures</div>
            <div class="big-num text-2xl ${totalFails ? 'text-red-400' : 'text-green-400'}">${totalFails || 'None'}</div>
            <div class="text-[11px] text-zinc-600 mt-1 font-body">${totalFails ? 'Check errors' : 'All nominal'}</div>
          </div>
        `;
      }
    }

    function renderChart() {
      const agg = aggregateResults();
      const ctx = document.getElementById('toksChart').getContext('2d');
      if (toksChart) toksChart.destroy();

      if (!isStressMode()) {
        // === STANDARD BAR CHART (existing behavior) ===
        const labels = agg.map(a => a.model);
        const data = agg.map(a => a.tokens_per_second);
        const bgColors = agg.map(a => getColor(a.provider).bar + 'CC');
        const borderColors = agg.map(a => getColor(a.provider).bar);

        toksChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{
              label: 'Tokens/sec',
              data,
              backgroundColor: bgColors,
              borderColor: borderColors,
              borderWidth: 0,
              borderRadius: 2,
              barPercentage: 0.55,
            }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1c1c20',
                borderColor: '#27272A',
                borderWidth: 1,
                titleFont: { family: 'Outfit', size: 13, weight: '500' },
                bodyFont: { family: 'Space Mono', size: 12 },
                padding: 12,
                cornerRadius: 2,
                callbacks: {
                  label: ctx => ` ${ctx.parsed.x.toFixed(1)} tok/s`,
                  afterLabel: ctx => {
                    const r = agg[ctx.dataIndex];
                    return ` TTFT: ${r.ttft_ms.toFixed(0)}ms  |  Tokens: ${r.output_tokens.toFixed(0)}`;
                  }
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
                title: { display: true, text: 'TOKENS / SECOND', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } }
              },
              y: {
                grid: { display: false, drawBorder: false },
                ticks: { color: '#A1A1AA', font: { family: 'Outfit', size: 12, weight: '500' } }
              }
            }
          }
        });
      } else {
        // === STRESS TEST LINE CHART ===
        const tiers = [...new Set(agg.map(a => a.context_tokens))].sort((a, b) => a - b);
        const models = [...new Set(agg.map(a => `${a.model_id}::${a.provider}`))];
        const tierLabels = tiers.map(t => t === 0 ? '0' : (t >= 1000 ? (t/1000) + 'K' : t));

        const datasets = models.map(uid => {
          const modelResults = agg.filter(a => `${a.model_id}::${a.provider}` === uid);
          const modelName = modelResults[0]?.model || mid;
          const provider = modelResults[0]?.provider || '';
          const color = getColor(provider);

          const data = tiers.map(tier => {
            const match = modelResults.find(r => r.context_tokens === tier);
            return match && match.success ? match.tokens_per_second : null;
          });

          return {
            label: modelName,
            data,
            borderColor: color.bar,
            backgroundColor: color.bar + '33',
            borderWidth: 2,
            pointRadius: 4,
            pointBackgroundColor: color.bar,
            pointBorderColor: '#09090B',
            pointBorderWidth: 2,
            tension: 0.3,
            spanGaps: false,
          };
        });

        toksChart = new Chart(ctx, {
          type: 'line',
          data: { labels: tierLabels, datasets },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: {
                display: true,
                position: 'top',
                labels: {
                  color: '#A1A1AA',
                  font: { family: 'Outfit', size: 11 },
                  boxWidth: 12,
                  boxHeight: 2,
                  padding: 16,
                }
              },
              tooltip: {
                backgroundColor: '#1c1c20',
                borderColor: '#27272A',
                borderWidth: 1,
                titleFont: { family: 'Outfit', size: 13, weight: '500' },
                bodyFont: { family: 'Space Mono', size: 12 },
                padding: 12,
                cornerRadius: 2,
                callbacks: {
                  title: ctx => `Context: ${ctx[0].label} tokens`,
                  label: ctx => ctx.parsed.y !== null ? ` ${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)} tok/s` : ` ${ctx.dataset.label}: N/A`,
                }
              }
            },
            scales: {
              x: {
                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
                title: { display: true, text: 'CONTEXT SIZE (TOKENS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } }
              },
              y: {
                grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
                ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
                title: { display: true, text: 'TOKENS / SECOND', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { right: 12 } }
              }
            }
          }
        });
      }
    }

    function renderTable() {
      const agg = aggregateResults();
      const tbody = document.getElementById('resultsBody');
      const thead = tbody.closest('table').querySelector('thead tr');
      tbody.innerHTML = '';

      const stress = isStressMode();
      const multiRun = agg.some(r => r.runs > 1);

      // Update header
      if (stress) {
        // Add Context column if not present
        if (!thead.querySelector('[data-col="context"]')) {
          const th = document.createElement('th');
          th.className = 'px-5 py-3 text-right section-label';
          th.dataset.col = 'context';
          th.textContent = 'Context';
          // Insert after Model column (index 2)
          thead.children[3].before(th);
        }
      } else {
        const ctxTh = thead.querySelector('[data-col="context"]');
        if (ctxTh) ctxTh.remove();
      }

      // Show/hide Std Dev column based on multi-run
      const stdDevTh = thead.querySelector('[data-col="stddev"]');
      if (stdDevTh) stdDevTh.style.display = multiRun ? '' : 'none';

      agg.forEach((r, i) => {
        const color = getColor(r.provider);
        const pos = i < 3 && r.success ? `<span class="font-display font-bold" ${i===0 ? 'style="color:var(--lime)"' : ''}>${POSITION_LABELS[i]}</span>` : `<span class="text-zinc-600">${i + 1}</span>`;

        const statusHtml = r.failures === 0
          ? `<span class="text-green-500 text-xs font-mono">${r.runs}/${r.runs}</span>`
          : r.failures < r.runs
            ? `<span class="text-amber-500 text-xs font-mono">${r.runs - r.failures}/${r.runs}</span>`
            : `<span class="text-red-400 text-xs font-mono" title="${r.error}">FAIL</span>`;

        const ctxCell = stress ? `<td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.context_tokens === 0 ? '0' : formatCtxSize(r.context_tokens).replace(' ctx', '')}</td>` : '';
        const stdDevCell = multiRun ? `<td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-600">${r.success && r.std_dev_tps > 0 ? '\u00B1' + r.std_dev_tps.toFixed(1) : '-'}</td>` : '';
        const inputTpsFormatted = r.success && r.input_tokens_per_second > 0 ? Math.round(r.input_tokens_per_second).toLocaleString() : '-';
        const costFormatted = r.success && r.avg_cost > 0 ? '$' + r.avg_cost.toFixed(4) : '-';

        const row = document.createElement('tr');
        row.className = i === 0 && r.success ? 'rank-1 fade-in' : 'fade-in';
        row.innerHTML = `
          <td class="px-5 py-3.5 text-center">${pos}</td>
          <td class="px-5 py-3.5"><span class="badge" style="background:${color.bg};color:${color.text};border:1px solid ${color.border}">${r.provider}</span></td>
          <td class="px-5 py-3.5 text-zinc-200 font-medium font-body text-[13px]">${r.model}</td>
          ${ctxCell}
          <td class="px-5 py-3.5 text-right font-mono text-sm ${r.success && i === 0 ? '' : 'text-zinc-400'}" ${r.success && i === 0 ? 'style="color:var(--lime)"' : ''}>${r.success ? r.tokens_per_second.toFixed(1) : '-'}</td>
          ${stdDevCell}
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.success ? r.ttft_ms.toFixed(0) + 'ms' : '-'}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${inputTpsFormatted}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.success ? r.total_time_s.toFixed(2) + 's' : '-'}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${r.success ? r.output_tokens.toFixed(0) : '-'}</td>
          <td class="px-5 py-3.5 text-center">${statusHtml}</td>
          <td class="px-5 py-3.5 text-right font-mono text-sm text-zinc-500">${costFormatted}</td>
        `;
        tbody.appendChild(row);
      });
    }

    function renderTTFTChart() {
      const section = document.getElementById('ttftChartSection');
      section.classList.remove('hidden');

      const agg = aggregateResults();
      const chartCtx = document.getElementById('ttftChart').getContext('2d');
      if (ttftChart) ttftChart.destroy();

      const stress = isStressMode();
      document.getElementById('ttftChartLabel').textContent = stress ? 'Latency (TTFT) vs Context Size' : 'Time to First Token (TTFT)';

      if (!stress) {
        // === STANDARD: horizontal bar chart of TTFT values ===
        const sorted = [...agg].filter(a => a.success).sort((a, b) => a.ttft_ms - b.ttft_ms);
        const labels = sorted.map(a => a.model);
        const data = sorted.map(a => a.ttft_ms);
        const bgColors = sorted.map(a => getColor(a.provider).bar + 'CC');

        ttftChart = new Chart(chartCtx, {
          type: 'bar',
          data: {
            labels,
            datasets: [{ label: 'TTFT (ms)', data, backgroundColor: bgColors, borderWidth: 0, borderRadius: 2, barPercentage: 0.55 }]
          },
          options: {
            indexAxis: 'y',
            responsive: true,
            maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            plugins: {
              legend: { display: false },
              tooltip: {
                backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
                titleFont: { family: 'Outfit', size: 13, weight: '500' },
                bodyFont: { family: 'Space Mono', size: 12 },
                padding: 12, cornerRadius: 2,
                callbacks: { label: c => ` ${c.parsed.x.toFixed(0)} ms` }
              }
            },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TIME TO FIRST TOKEN (MS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } } },
              y: { grid: { display: false, drawBorder: false }, ticks: { color: '#A1A1AA', font: { family: 'Outfit', size: 12, weight: '500' } } }
            }
          }
        });
      } else {
        // === STRESS: line chart (existing behavior) ===
        const tiers = [...new Set(agg.map(a => a.context_tokens))].sort((a, b) => a - b);
        const models = [...new Set(agg.map(a => `${a.model_id}::${a.provider}`))];
        const tierLabels = tiers.map(t => t === 0 ? '0' : (t >= 1000 ? (t/1000) + 'K' : t));

        const datasets = models.map(uid => {
          const modelResults = agg.filter(a => `${a.model_id}::${a.provider}` === uid);
          const modelName = modelResults[0]?.model || uid;
          const provider = modelResults[0]?.provider || '';
          const color = getColor(provider);
          const data = tiers.map(tier => { const m = modelResults.find(r => r.context_tokens === tier); return m && m.success ? m.ttft_ms : null; });
          return { label: modelName, data, borderColor: color.bar, backgroundColor: color.bar + '33', borderWidth: 2, pointRadius: 4, pointBackgroundColor: color.bar, pointBorderColor: '#09090B', pointBorderWidth: 2, tension: 0.3, spanGaps: false };
        });

        ttftChart = new Chart(chartCtx, {
          type: 'line',
          data: { labels: tierLabels, datasets },
          options: {
            responsive: true, maintainAspectRatio: false,
            animation: { duration: 800, easing: 'easeOutQuart' },
            interaction: { mode: 'index', intersect: false },
            plugins: {
              legend: { display: true, position: 'top', labels: { color: '#A1A1AA', font: { family: 'Outfit', size: 11 }, boxWidth: 12, boxHeight: 2, padding: 16 } },
              tooltip: { backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1, titleFont: { family: 'Outfit', size: 13, weight: '500' }, bodyFont: { family: 'Space Mono', size: 12 }, padding: 12, cornerRadius: 2, callbacks: { title: c => `Context: ${c[0].label} tokens`, label: c => c.parsed.y !== null ? ` ${c.dataset.label}: ${c.parsed.y.toFixed(0)}ms` : ` ${c.dataset.label}: N/A` } }
            },
            scales: {
              x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'CONTEXT SIZE (TOKENS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } } },
              y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TIME TO FIRST TOKEN (MS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { right: 12 } } }
            }
          }
        });
      }
    }

    // -------------------------------------------------------------------
    // Scatter chart: Speed vs Latency
    // -------------------------------------------------------------------
    function renderScatterChart() {
      const section = document.getElementById('scatterChartSection');
      const agg = aggregateResults().filter(a => a.success);
      if (agg.length < 2) { section.classList.add('hidden'); return; }
      section.classList.remove('hidden');

      const chartCtx = document.getElementById('scatterChart').getContext('2d');
      if (scatterChart) scatterChart.destroy();

      // Scale point size: output_tokens mapped to 5-20px
      const allTokens = agg.map(a => a.output_tokens);
      const minT = Math.min(...allTokens), maxT = Math.max(...allTokens);
      const scaleSize = (t) => maxT === minT ? 10 : 5 + (t - minT) / (maxT - minT) * 15;

      const datasets = agg.map(a => {
        const color = getColor(a.provider);
        return {
          label: a.model,
          data: [{ x: a.tokens_per_second, y: a.ttft_ms }],
          backgroundColor: color.bar,
          borderColor: color.bar,
          pointRadius: scaleSize(a.output_tokens),
          pointHoverRadius: scaleSize(a.output_tokens) + 3,
        };
      });

      scatterChart = new Chart(chartCtx, {
        type: 'scatter',
        data: { datasets },
        options: {
          responsive: true, maintainAspectRatio: false,
          animation: { duration: 800, easing: 'easeOutQuart' },
          plugins: {
            legend: { display: true, position: 'top', labels: { color: '#A1A1AA', font: { family: 'Outfit', size: 11 }, boxWidth: 8, boxHeight: 8, padding: 12, usePointStyle: true } },
            tooltip: {
              backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
              titleFont: { family: 'Outfit', size: 13, weight: '500' },
              bodyFont: { family: 'Space Mono', size: 12 },
              padding: 12, cornerRadius: 2,
              callbacks: {
                title: c => c[0].dataset.label,
                label: c => [` Tok/s: ${c.parsed.x.toFixed(1)}`, ` TTFT: ${c.parsed.y.toFixed(0)}ms`]
              }
            }
          },
          scales: {
            x: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TOKENS / SECOND', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { top: 12 } } },
            y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } }, title: { display: true, text: 'TTFT (MS)', color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' }, padding: { right: 12 } } }
          }
        }
      });
    }

    // -------------------------------------------------------------------
    // CSV Export
    // -------------------------------------------------------------------
    function exportCSV() {
      const agg = aggregateResults();
      if (!agg.length) { showToast('No results to export', 'error'); return; }
      const headers = ['Provider','Model','Tok/s','TTFT (ms)','Input Tok/s','Duration (s)','Output Tokens','Status','Avg Cost','Total Cost'];
      const rows = agg.map(r => [
        r.provider, r.model,
        r.success ? r.tokens_per_second.toFixed(2) : '',
        r.success ? r.ttft_ms.toFixed(0) : '',
        r.success && r.input_tokens_per_second > 0 ? Math.round(r.input_tokens_per_second) : '',
        r.success ? r.total_time_s.toFixed(3) : '',
        r.success ? r.output_tokens.toFixed(0) : '',
        r.success ? (r.failures ? 'partial' : 'ok') : 'fail',
        r.success && r.avg_cost > 0 ? r.avg_cost.toFixed(6) : '',
        r.success && r.total_cost > 0 ? r.total_cost.toFixed(6) : '',
      ]);
      const csv = [headers, ...rows].map(r => r.map(c => `"${String(c).replace(/"/g, '""')}"`).join(',')).join('\n');
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = 'benchmark_results.csv'; a.click();
      URL.revokeObjectURL(url);
      showToast('CSV downloaded', 'success');
    }

    // -------------------------------------------------------------------
    // Tabs
    // -------------------------------------------------------------------
    function showTab(tab) {
      document.getElementById('view-benchmark').classList.toggle('hidden', tab !== 'benchmark');
      document.getElementById('view-history').classList.toggle('hidden', tab !== 'history');
      document.getElementById('view-settings').classList.toggle('hidden', tab !== 'settings');
      document.getElementById('view-tool-eval').classList.toggle('hidden', tab !== 'tool-eval');
      document.getElementById('view-analytics').classList.toggle('hidden', tab !== 'analytics');
      document.getElementById('view-schedules').classList.toggle('hidden', tab !== 'schedules');
      document.getElementById('view-admin').classList.toggle('hidden', tab !== 'admin');
      document.getElementById('tab-benchmark').classList.toggle('tab-active', tab === 'benchmark');
      document.getElementById('tab-history').classList.toggle('tab-active', tab === 'history');
      document.getElementById('tab-settings').classList.toggle('tab-active', tab === 'settings');
      document.getElementById('tab-tool-eval').classList.toggle('tab-active', tab === 'tool-eval');
      document.getElementById('tab-analytics').classList.toggle('tab-active', tab === 'analytics');
      document.getElementById('tab-schedules').classList.toggle('tab-active', tab === 'schedules');
      document.getElementById('tab-admin').classList.toggle('tab-active', tab === 'admin');
      if (tab === 'history') loadHistory();
      if (tab === 'settings') renderSettings();
      if (tab === 'tool-eval') { showToolEvalView('suites'); teLoadSuites(); teLoadHistory(); }
      if (tab === 'analytics') { analyticsShowLeaderboard(); }
      if (tab === 'schedules') loadSchedules();
      if (tab === 'admin') loadAdminDashboard();
    }

    // -------------------------------------------------------------------
    // Settings — Full CRUD
    // -------------------------------------------------------------------
    const QUICK_CTX_SIZES = [4096, 8192, 16384, 32768, 65536, 131072, 200000];
    const QUICK_CTX_LABELS = ['4K', '8K', '16K', '32K', '64K', '128K', '200K'];
    const INPUT_STYLE = "background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;";
    const INPUT_CLASS = "w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200";

    async function refreshConfig() {
      const res = await apiFetch('/api/config');
      config = await res.json();
    }

    function showStatus(elId, ok, msg) {
      const el = document.getElementById(elId);
      if (!el) return;
      el.classList.remove('hidden');
      el.style.color = ok ? 'var(--lime)' : 'var(--coral)';
      el.textContent = msg;
      setTimeout(() => el.classList.add('hidden'), 3000);
    }

    // ── Render Settings (orchestrator) ──
    async function renderSettings() {
      if (!config) {
        try { await refreshConfig(); } catch (e) {
          document.getElementById('settingsContainer').innerHTML = '<p class="text-red-400 text-sm">Failed to load config.</p>';
          return;
        }
      }
      await renderApiKeys();
      renderProviders();
    }

    // ── API Keys (per-user) ──
    async function renderApiKeys() {
      const container = document.getElementById('apiKeysContainer');
      try {
        const res = await apiFetch('/api/keys');
        const data = await res.json();
        const keys = data.keys || [];

        container.innerHTML = `
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">My API Keys</span>
              <span class="text-[10px] text-zinc-600 font-body">Your keys are encrypted and only used for your benchmarks</span>
            </div>
            <div class="divide-y" style="border-color:var(--border-subtle)">
              ${keys.length === 0 ? '<div class="px-5 py-3 text-zinc-700 text-xs font-body">No providers configured.</div>' :
                keys.map(k => `
                  <div class="px-5 py-3 flex items-center justify-between group">
                    <div class="flex items-center gap-3">
                      <span class="text-xs font-body text-zinc-300">${k.display_name}</span>
                      <span class="text-[10px] font-mono text-zinc-600">${k.key_env_name || k.provider_key}</span>
                      ${k.has_user_key
                        ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(191,255,0,0.08);color:var(--lime);border:1px solid rgba(191,255,0,0.2)">YOUR KEY</span>'
                        : k.has_global_key
                          ? '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:1px solid rgba(56,189,248,0.2)">SHARED</span>'
                          : '<span class="text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm" style="background:rgba(255,59,92,0.08);color:var(--coral);border:1px solid rgba(255,59,92,0.2)">NOT SET</span>'
                      }
                    </div>
                    <div class="flex gap-2">
                      <button onclick="setMyKey('${k.provider_key}','${k.display_name}')" class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm transition-colors ${k.has_user_key ? 'text-zinc-500 hover:text-zinc-300' : 'hover:text-zinc-200'}" style="${k.has_user_key ? '' : 'color:var(--lime);border:1px solid rgba(191,255,0,0.2)'}">${k.has_user_key ? 'Update' : 'Set Key'}</button>
                      ${k.has_user_key ? `<button onclick="removeMyKey('${k.provider_key}','${k.display_name}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-red-400 transition-colors">Remove</button>` : ''}
                    </div>
                  </div>
                `).join('')}
            </div>
          </div>
        `;
      } catch (e) {
        container.innerHTML = '<p class="text-red-400 text-xs">Failed to load API keys.</p>';
      }
    }

    async function setMyKey(providerKey, displayName) {
      showInputModal('Set API Key for ' + displayName, 'Paste your API key...', async (value) => {
        await apiFetch('/api/keys', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider_key: providerKey, value })
        });
        renderApiKeys();
      }, { inputType: 'password' });
    }

    async function removeMyKey(providerKey, displayName) {
      showModal('Remove Key', 'Remove your personal key for <strong>' + displayName + '</strong>? You will fall back to the shared key (if one exists).', async () => {
        await apiFetch('/api/keys', {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider_key: providerKey })
        });
        renderApiKeys();
      }, { danger: true, confirmLabel: 'Remove' });
    }

    // ── Render Providers + Models ──
    function renderProviders() {
      const container = document.getElementById('settingsContainer');
      container.innerHTML = '';

      for (const [provDisplayName, provData] of Object.entries(config.providers)) {
        const pk = provData.provider_key;
        const models = provData.models || [];
        const color = getColor(provDisplayName);
        const prefix = provData.model_id_prefix || detectPrefix(models);

        const section = document.createElement('div');
        section.className = 'card rounded-md overflow-hidden';
        section.innerHTML = `
          <!-- Provider Header -->
          <div class="px-5 py-3 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
            <div class="flex items-center gap-3">
              <span class="badge" style="background:${color.bg};color:${color.text};border:1px solid ${color.border}">${provDisplayName}</span>
              <span class="text-zinc-600 text-xs font-body">${models.length} model${models.length!==1?'s':''}</span>
              <span class="text-[9px] font-mono text-zinc-700">${pk}</span>
              ${prefix ? `<span class="text-[9px] font-mono px-1.5 py-0.5 rounded-sm" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:1px solid rgba(56,189,248,0.2)">prefix: ${prefix}/</span>` : ''}
            </div>
            <div class="flex gap-2">
              <button onclick="fetchAndShowModels('${pk}', this)" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors">Fetch</button>
              <button onclick="editProvider('${pk}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors">Edit</button>
              <button onclick="deleteProvider('${pk}','${provDisplayName}',${models.length})" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-red-400 transition-colors">Del</button>
            </div>
          </div>
          <!-- Provider edit form (hidden) -->
          <div id="prov-edit-${pk}" class="hidden px-5 py-3" style="border-bottom:1px solid var(--border-subtle);background:rgba(191,255,0,0.02)">
            <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-2">
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
                <input id="pe-dn-${pk}" value="${provDisplayName}" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID Prefix</label>
                <input id="pe-prefix-${pk}" value="${provData.model_id_prefix || detectPrefix(provData.models)}" placeholder="Optional" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Base</label>
                <input id="pe-ab-${pk}" value="${provData.api_base||''}" placeholder="https://..." class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Key Name</label>
                <input id="pe-ke-${pk}" value="${provData.api_key_env||''}" placeholder="e.g. OPENAI_API_KEY" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
              </div>
            </div>
            <button onclick="saveProvider('${pk}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Save Provider</button>
            <span id="prov-status-${pk}" class="ml-3 text-[11px] font-body hidden"></span>
          </div>
          <!-- Models -->
          <div class="divide-y" style="border-color:var(--border-subtle)">
            ${models.map(m => renderModelCard(pk, m)).join('')}
          </div>
          <!-- Add Model -->
          <div class="px-5 py-3" style="border-top:1px solid var(--border-subtle)">
            <button onclick="toggleAddModel('${pk}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">+ Add Model</button>
            <div id="add-model-${pk}" class="hidden mt-3">
              <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 mb-2">
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID</label>
                  <div class="flex items-center gap-0">
                    ${prefix ? `<span class="text-[11px] font-mono px-2 py-2 rounded-l-sm flex-shrink-0" style="background:rgba(56,189,248,0.08);color:#38BDF8;border:1px solid rgba(56,189,248,0.2);border-right:none;">${prefix}/</span>` : ''}
                    <input id="am-id-${pk}" placeholder="${prefix ? 'model-name' : 'provider/model-name'}" list="dl-am-${pk}" class="${INPUT_CLASS} ${prefix ? 'rounded-l-none' : ''}" style="${INPUT_STYLE}" onfocus="loadAndPopulateDatalist('${pk}', 'dl-am-${pk}')" oninput="autoDeriveName('am-id-${pk}','am-dn-${pk}'); updateModelPreview('${pk}'); autoFillDisplayName(this, '${pk}', 'am-dn-${pk}')">
                  </div>
                  <datalist id="dl-am-${pk}"></datalist>
                  <div id="am-preview-${pk}" class="text-[9px] font-mono text-zinc-600 mt-1"></div>
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
                  <input id="am-dn-${pk}" placeholder="Auto from ID" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Context Window</label>
                  <input id="am-ctx-${pk}" value="128000" type="number" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
                </div>
              </div>
              <button onclick="addModel('${pk}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Add</button>
            </div>
          </div>
        `;
        container.appendChild(section);
      }

      // Add Provider button at bottom
      const addProvBtn = document.createElement('div');
      addProvBtn.innerHTML = `
        <button onclick="toggleAddProvider()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-2 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">+ Add Provider</button>
        <div id="add-provider-form" class="hidden card rounded-md p-5 mt-3">
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
              <input id="ap-dn" placeholder="My Provider" class="${INPUT_CLASS}" style="${INPUT_STYLE}" oninput="document.getElementById('ap-key').value = uniqueProviderKey(slugify(this.value)); document.getElementById('ap-ke').value = slugify(this.value).toUpperCase().replace(/-/g,'_') + '_API_KEY'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Provider Key <span class="text-zinc-700 normal-case">(auto-derived, editable)</span></label>
              <input id="ap-key" placeholder="auto_generated" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID Prefix <span class="text-zinc-700 normal-case">(e.g. lm_studio)</span></label>
              <input id="ap-prefix" placeholder="Optional — prepended to model IDs" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Base</label>
              <input id="ap-ab" placeholder="https://api.example.com/v1" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">API Key Name <span class="text-zinc-700 normal-case">(auto-derived)</span></label>
              <input id="ap-ke" placeholder="e.g. OPENAI_API_KEY" class="${INPUT_CLASS}" style="${INPUT_STYLE}">
            </div>
          </div>
          <button onclick="addProvider()" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Create Provider</button>
        </div>
      `;
      container.appendChild(addProvBtn);
    }

    // ── Single model card ──
    function renderModelCard(provKey, m) {
      const sid = safeId(provKey + '__' + m.model_id);
      const skipHtml = (m.skip_params || []).map(p =>
        `<span class="text-[10px] font-mono text-zinc-400 px-1.5 py-0.5 rounded-sm inline-flex items-center gap-1" style="background:rgba(255,255,255,0.04)">
          ${p} <button onclick="removeSkipParam('${provKey}','${m.model_id}','${p}')" class="text-zinc-600 hover:text-red-400">&times;</button>
        </span>`
      ).join(' ');

      // Custom fields (anything not standard)
      const stdKeys = new Set(['model_id','display_name','context_window','max_output_tokens','skip_params','input_cost_per_mtok','output_cost_per_mtok']);
      const customs = Object.entries(m).filter(([k]) => !stdKeys.has(k));
      const customHtml = customs.map(([k,v]) =>
        `<div class="flex items-center gap-2">
          <span class="text-[10px] font-mono text-zinc-500">${k}:</span>
          <input id="cf-${sid}-${safeId(k)}" value="${v}" class="px-2 py-1 rounded-sm text-[11px] font-mono text-zinc-300 flex-1" style="${INPUT_STYLE}">
          <button onclick="removeCustomField('${provKey}','${m.model_id}','${k}')" class="text-zinc-600 hover:text-red-400 text-xs">&times;</button>
        </div>`
      ).join('');

      return `
        <div class="px-5 py-4" id="settings-${sid}">
          <div class="flex items-center justify-between mb-4">
            <div class="flex items-center gap-3">
              <div class="text-[13px] font-medium text-zinc-200 font-body">${m.display_name}</div>
              <span class="text-[9px] font-mono text-zinc-700">${m.model_id}</span>
            </div>
            <div class="flex gap-2">
              <button onclick="saveModelConfig('${provKey}','${m.model_id}')" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-1.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2);" onmouseover="this.style.borderColor='rgba(191,255,0,0.5)'" onmouseout="this.style.borderColor='rgba(191,255,0,0.2)'">Save</button>
              <button onclick="deleteModel('${provKey}','${m.model_id}','${m.display_name}')" class="text-[11px] font-display tracking-wider uppercase px-2 py-1.5 rounded-sm text-zinc-600 hover:text-red-400 transition-colors" style="border:1px solid var(--border-subtle)">&times;</button>
            </div>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Model ID</label>
              <input id="mid-${sid}" value="${m.model_id}" list="dl-${sid}" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'; loadAndPopulateDatalist('${provKey}', 'dl-${sid}')" onblur="this.style.borderColor='var(--border-subtle)'" oninput="autoDeriveName('mid-${sid}','mdn-${sid}'); autoFillDisplayName(this, '${provKey}', 'mdn-${sid}')">
              <datalist id="dl-${sid}"></datalist>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Display Name</label>
              <input id="mdn-${sid}" value="${m.display_name}" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Context Window</label>
              <input type="number" id="ctx-${sid}" value="${m.context_window||128000}" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
              <div class="flex gap-1.5 mt-2 flex-wrap">
                ${QUICK_CTX_SIZES.map((size,i) => `<button onclick="document.getElementById('ctx-${sid}').value=${size}" class="text-[9px] font-mono px-2 py-0.5 rounded-sm text-zinc-600 hover:text-zinc-400 transition-colors" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle)">${QUICK_CTX_LABELS[i]}</button>`).join('')}
              </div>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Max Output Tokens</label>
              <input type="number" id="mot-${sid}" value="${m.max_output_tokens||''}" placeholder="Default" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Input $/1M tokens</label>
              <input type="number" step="0.001" id="icp-${sid}" value="${m.input_cost_per_mtok!=null?m.input_cost_per_mtok:''}" placeholder="e.g. 2.00" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Output $/1M tokens</label>
              <input type="number" step="0.001" id="ocp-${sid}" value="${m.output_cost_per_mtok!=null?m.output_cost_per_mtok:''}" placeholder="e.g. 8.00" class="${INPUT_CLASS}" style="${INPUT_STYLE}" onfocus="this.style.borderColor='rgba(191,255,0,0.3)'" onblur="this.style.borderColor='var(--border-subtle)'">
            </div>
          </div>
          <!-- Skip Params -->
          <div class="mt-3">
            <span class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Skip Params: </span>
            <span id="sp-pills-${sid}">${skipHtml || '<span class="text-[10px] text-zinc-700 font-body">none</span>'}</span>
            <button onclick="promptAddSkipParam('${provKey}','${m.model_id}')" class="text-[10px] font-mono text-zinc-500 hover:text-zinc-300 ml-2 px-1.5 py-0.5 rounded-sm" style="border:1px solid var(--border-subtle)">+ add</button>
          </div>
          <!-- Custom Fields -->
          <div class="mt-3">
            <span class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Custom Fields</span>
            <div id="cf-${sid}" class="space-y-1">${customHtml || '<span class="text-[10px] text-zinc-700 font-body">none</span>'}</div>
            <button onclick="promptAddCustomField('${provKey}','${m.model_id}')" class="text-[10px] font-mono text-zinc-500 hover:text-zinc-300 mt-1 px-1.5 py-0.5 rounded-sm" style="border:1px solid var(--border-subtle)">+ add field</button>
          </div>
          <div id="save-status-${sid}" class="mt-2 text-[11px] font-body hidden"></div>
        </div>
      `;
    }

    async function loadProviderModels(provKey) {
      if (discoveredModelsCache[provKey]) return discoveredModelsCache[provKey];
      try {
        const res = await apiFetch(`/api/models/discover?provider_key=${encodeURIComponent(provKey)}`);
        const data = await res.json();
        if (data.models) {
          discoveredModelsCache[provKey] = data.models;
          return data.models;
        }
      } catch(e) {}
      return [];
    }

    async function loadAndPopulateDatalist(provKey, datalistId) {
      const dl = document.getElementById(datalistId);
      if (!dl || dl.children.length > 0) return;
      const models = await loadProviderModels(provKey);
      dl.innerHTML = models.map(m => `<option value="${m.id}">${m.display_name}</option>`).join('');
    }

    function autoFillDisplayName(input, provKey, dnFieldId) {
      const models = discoveredModelsCache[provKey] || [];
      const match = models.find(m => m.id === input.value);
      if (match) {
        const dnField = document.getElementById(dnFieldId);
        if (dnField) dnField.value = match.display_name;
      }
    }

    function autoDeriveName(idInputId, nameInputId) {
      const idVal = document.getElementById(idInputId)?.value || '';
      const nameInput = document.getElementById(nameInputId);
      if (nameInput && !nameInput.dataset.manual) {
        nameInput.value = idVal.includes('/') ? idVal.split('/').pop() : idVal;
      }
    }

    function updateModelPreview(provKey) {
      const previewEl = document.getElementById(`am-preview-${provKey}`);
      const inputEl = document.getElementById(`am-id-${provKey}`);
      if (!previewEl || !inputEl) return;
      const provData = Object.values(config.providers).find(p => p.provider_key === provKey);
      const prefix = provData?.model_id_prefix || '';
      const val = inputEl.value.trim();
      if (!val) { previewEl.textContent = ''; return; }
      if (prefix && !val.startsWith(prefix + '/')) {
        previewEl.textContent = `Full ID: ${prefix}/${val}`;
      } else {
        previewEl.textContent = `Full ID: ${val}`;
      }
    }

    // ── Save Model ──
    async function saveModelConfig(providerKey, modelId) {
      const sid = safeId(providerKey + '__' + modelId);
      const statusId = `save-status-${sid}`;

      // Collect skip_params from current config
      const provData = Object.values(config.providers).find(p => p.provider_key === providerKey);
      const modelData = provData?.models?.find(m => m.model_id === modelId);
      const currentSkipParams = modelData?.skip_params || [];

      // Collect custom fields
      const stdKeys = new Set(['model_id','display_name','context_window','max_output_tokens','skip_params','input_cost_per_mtok','output_cost_per_mtok']);
      const customs = {};
      if (modelData) {
        for (const [k] of Object.entries(modelData).filter(([k]) => !stdKeys.has(k))) {
          const el = document.getElementById(`cf-${sid}-${safeId(k)}`);
          if (el) customs[k] = el.value;
        }
      }

      // Collect pricing fields
      const icpVal = document.getElementById(`icp-${sid}`)?.value;
      const ocpVal = document.getElementById(`ocp-${sid}`)?.value;
      const pricingFields = {};
      if (icpVal !== '' && icpVal != null) pricingFields.input_cost_per_mtok = parseFloat(icpVal);
      if (ocpVal !== '' && ocpVal != null) pricingFields.output_cost_per_mtok = parseFloat(ocpVal);

      const body = {
        provider_key: providerKey,
        model_id: modelId,
        new_model_id: document.getElementById(`mid-${sid}`)?.value || modelId,
        display_name: document.getElementById(`mdn-${sid}`)?.value || '',
        context_window: parseInt(document.getElementById(`ctx-${sid}`)?.value) || null,
        max_output_tokens: parseInt(document.getElementById(`mot-${sid}`)?.value) || null,
        skip_params: currentSkipParams,
        custom_fields: {
          ...(Object.keys(customs).length ? customs : {}),
          ...(Object.keys(pricingFields).length ? pricingFields : {}),
        },
      };
      if (!Object.keys(body.custom_fields).length) delete body.custom_fields;

      try {
        const res = await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
        const result = await res.json();
        if (res.ok) {
          showStatus(statusId, true, 'Saved');
          await refreshConfig();
          renderModels();
        } else {
          showStatus(statusId, false, result.error || 'Save failed');
        }
      } catch (e) {
        showStatus(statusId, false, 'Network error');
      }
    }

    // ── Model CRUD ──
    async function deleteModel(provKey, modelId, displayName) {
      showModal('Remove Model', `Remove model <strong>${displayName}</strong>?`, async () => {
        await apiFetch('/api/config/model', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId}) });
        await refreshConfig();
        renderModels();
        renderProviders();
      }, { danger: true, confirmLabel: 'Remove' });
    }

    function toggleAddModel(provKey) {
      document.getElementById(`add-model-${provKey}`)?.classList.toggle('hidden');
    }

    async function addModel(provKey) {
      const id = document.getElementById(`am-id-${provKey}`)?.value.trim();
      if (!id) return;
      const body = {
        provider_key: provKey,
        id: id,
        display_name: document.getElementById(`am-dn-${provKey}`)?.value.trim() || '',
        context_window: parseInt(document.getElementById(`am-ctx-${provKey}`)?.value) || 128000,
      };
      const res = await apiFetch('/api/config/model', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (res.ok) {
        await refreshConfig();
        renderModels();
        renderProviders();
      } else {
        const err = await res.json();
        showToast(err.error || 'Failed to add model', 'error');
      }
    }

    // ── Skip Params ──
    async function promptAddSkipParam(provKey, modelId) {
      showInputModal('Add Skip Param', 'Parameter name (e.g., temperature)', async (param) => {
        if (!param || !param.trim()) return;
        const provData = Object.values(config.providers).find(p => p.provider_key === provKey);
        const modelData = provData?.models?.find(m => m.model_id === modelId);
        const current = [...(modelData?.skip_params || [])];
        if (!current.includes(param.trim())) current.push(param.trim());
        await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, skip_params: current}) });
        await refreshConfig();
        renderProviders();
      });
    }

    async function removeSkipParam(provKey, modelId, param) {
      const provData = Object.values(config.providers).find(p => p.provider_key === provKey);
      const modelData = provData?.models?.find(m => m.model_id === modelId);
      const current = (modelData?.skip_params || []).filter(p => p !== param);
      await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, skip_params: current}) });
      await refreshConfig();
      renderProviders();
    }

    // ── Custom Fields ──
    async function promptAddCustomField(provKey, modelId) {
      showDoubleInputModal('Add Custom Field', [
        { label: 'Field Name', placeholder: 'e.g., pricing_tier' },
        { label: 'Value', placeholder: 'e.g., standard' }
      ], async (key, value) => {
        if (!key || !key.trim()) return;
        await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, custom_fields: {[key.trim()]: value}}) });
        await refreshConfig();
        renderProviders();
      });
    }

    async function removeCustomField(provKey, modelId, key) {
      await apiFetch('/api/config/model', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: provKey, model_id: modelId, custom_fields: {[key]: null}}) });
      await refreshConfig();
      renderProviders();
    }

    // ── Fetch Models from Provider API ──
    async function fetchAndShowModels(provKey, btn) {
      const origText = btn.textContent;
      btn.textContent = 'Loading...';
      btn.disabled = true;

      try {
        const res = await apiFetch(`/api/models/discover?provider_key=${encodeURIComponent(provKey)}`);
        const data = await res.json();

        if (data.error) {
          showToast(data.error, 'error');
          return;
        }

        const models = data.models || [];
        if (models.length === 0) {
          showToast('No models found', 'error');
          return;
        }

        // Get existing model IDs for this provider
        const existingIds = new Set();
        for (const [name, p] of Object.entries(config.providers || {})) {
          if (p.provider_key === provKey) {
            (p.models || []).forEach(m => existingIds.add(m.model_id));
          }
        }

        // Build checkbox list HTML
        const listHtml = models.map((m, i) => {
          const exists = existingIds.has(m.id);
          return `<label class="flex items-center gap-2 py-1.5 px-2 rounded hover:bg-white/5 cursor-pointer ${exists ? 'opacity-40' : ''}">
            <input type="checkbox" value="${i}" ${exists ? 'checked disabled' : ''} class="accent-lime-400">
            <span class="text-xs font-mono text-zinc-300">${m.id}</span>
            ${m.display_name !== m.id ? `<span class="text-[10px] text-zinc-500">${m.display_name}</span>` : ''}
            ${exists ? '<span class="text-[9px] text-zinc-600 ml-auto">already added</span>' : ''}
          </label>`;
        }).join('');

        // Create overlay modal
        const overlay = document.createElement('div');
        overlay.className = 'modal-overlay';
        overlay.innerHTML = `
          <div class="card rounded-md p-5 w-full max-w-lg max-h-[70vh] flex flex-col" style="border:1px solid var(--border-subtle)">
            <div class="flex items-center justify-between mb-3">
              <span class="font-display text-sm tracking-wide text-zinc-200">${models.length} models available</span>
              <button data-action="close" class="text-zinc-500 hover:text-zinc-300 text-xs cursor-pointer">Close</button>
            </div>
            <div class="overflow-y-auto flex-1 mb-3" id="model-pick-list">
              ${listHtml}
            </div>
            <button id="add-selected-models-btn" class="text-[11px] font-display font-medium tracking-wider uppercase px-4 py-2 rounded-sm self-end cursor-pointer" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">Add Selected</button>
          </div>
        `;
        document.body.appendChild(overlay);
        overlay.querySelector('[data-action="close"]').onclick = () => { overlay.classList.add('modal-closing'); setTimeout(() => overlay.remove(), 200); };
        overlay.addEventListener('click', (e) => { if (e.target === overlay) { overlay.classList.add('modal-closing'); setTimeout(() => overlay.remove(), 200); } });

        // Handle "Add Selected"
        document.getElementById('add-selected-models-btn').onclick = async () => {
          const checks = overlay.querySelectorAll('input[type=checkbox]:checked:not(:disabled)');
          if (checks.length === 0) {
            showToast('No models selected', 'error');
            return;
          }
          const addBtn = document.getElementById('add-selected-models-btn');
          addBtn.textContent = 'Adding...';
          addBtn.disabled = true;

          for (const cb of checks) {
            const m = models[parseInt(cb.value)];
            await apiFetch('/api/config/model', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({ provider_key: provKey, id: m.id, display_name: m.display_name })
            });
          }

          overlay.classList.add('modal-closing');
          setTimeout(() => overlay.remove(), 200);
          await refreshConfig();
          renderModels();
          renderProviders();
          showToast(`Added ${checks.length} model(s)`);
        };

      } catch (e) {
        showToast('Failed to fetch models: ' + e.message, 'error');
      } finally {
        btn.textContent = origText;
        btn.disabled = false;
      }
    }

    // ── Provider CRUD ──
    function editProvider(pk) {
      document.getElementById(`prov-edit-${pk}`)?.classList.toggle('hidden');
    }

    async function saveProvider(pk) {
      const body = {
        provider_key: pk,
        display_name: document.getElementById(`pe-dn-${pk}`)?.value || pk,
        api_base: document.getElementById(`pe-ab-${pk}`)?.value || '',
        api_key_env: document.getElementById(`pe-ke-${pk}`)?.value || '',
        model_id_prefix: document.getElementById(`pe-prefix-${pk}`)?.value.trim() || '',
      };
      const res = await apiFetch('/api/config/provider', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (res.ok) {
        showStatus(`prov-status-${pk}`, true, 'Saved');
        await refreshConfig();
        renderModels();
        renderProviders();
      } else {
        const err = await res.json();
        showStatus(`prov-status-${pk}`, false, err.error || 'Failed');
      }
    }

    async function deleteProvider(pk, displayName, modelCount) {
      showModal('Delete Provider', `Delete <strong>${displayName}</strong> and its ${modelCount} model(s)?`, async () => {
        await apiFetch('/api/config/provider', { method: 'DELETE', headers: {'Content-Type':'application/json'}, body: JSON.stringify({provider_key: pk}) });
        await refreshConfig();
        renderModels();
        renderProviders();
      }, { danger: true, confirmLabel: 'Delete' });
    }

    function toggleAddProvider() {
      document.getElementById('add-provider-form')?.classList.toggle('hidden');
    }

    async function addProvider() {
      const body = {
        provider_key: document.getElementById('ap-key')?.value.trim(),
        display_name: document.getElementById('ap-dn')?.value.trim(),
        api_base: document.getElementById('ap-ab')?.value.trim(),
        api_key_env: document.getElementById('ap-ke')?.value.trim(),
        model_id_prefix: document.getElementById('ap-prefix')?.value.trim(),
      };
      if (!body.provider_key) { showToast('Provider key is required', 'error'); return; }
      const res = await apiFetch('/api/config/provider', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(body) });
      if (res.ok) {
        await refreshConfig();
        renderModels();
        renderProviders();
      } else {
        const err = await res.json();
        showToast(err.error || 'Failed to add provider', 'error');
      }
    }

    async function loadHistory() {
      const container = document.getElementById('historyContainer');
      selectedHistoryRuns.clear();
      document.getElementById('historyCompareBar').classList.add('hidden');
      document.getElementById('historyCompareResult').classList.add('hidden');

      try {
        const res = await apiFetch('/api/history');
        const data = await res.json();
        const history = data.runs || [];

        if (!history.length) {
          container.innerHTML = '<div class="card rounded-sm p-10 text-center"><p class="text-zinc-600 font-body">No benchmark history yet.</p><p class="text-zinc-700 text-xs mt-1 font-body">Run your first benchmark to see results here.</p></div>';
          return;
        }

        container.innerHTML = history.map((h, idx) => {
          const ts = new Date(h.timestamp).toLocaleString();
          const sorted = [...(h.results || [])].map(r => ({
            ...r,
            avg_tokens_per_second: r.avg_tokens_per_second ?? r.tokens_per_second ?? 0,
            avg_ttft_ms: r.avg_ttft_ms ?? r.ttft_ms ?? 0,
            avg_total_time_s: r.avg_total_time_s ?? r.total_time_s ?? 0,
            std_dev_tps: r.std_dev_tps ?? 0,
            p50_tps: r.p50_tps ?? 0,
            p95_tps: r.p95_tps ?? 0,
          })).sort((a, b) => b.avg_tokens_per_second - a.avg_tokens_per_second);
          const winner = sorted[0];
          const hasMultiRun = sorted.some(r => (r.runs || 1) > 1);
          const runId = h.id;

          return `
            <div class="card rounded-sm p-5 fade-in" style="animation-delay: ${idx * 40}ms">
              <div class="flex items-center justify-between mb-3">
                <div class="flex items-center gap-3">
                  ${runId ? `<button onclick="toggleHistoryCheckbox(this, '${runId}')" class="w-4 h-4 rounded-sm border flex items-center justify-center transition-all flex-shrink-0" style="border-color:var(--border-subtle)" title="Select for comparison" data-checked="false"></button>` : ''}
                  <span class="text-[11px] text-zinc-600 font-mono">${ts}</span>
                  ${winner ? `<span class="badge" style="background:var(--lime-dim);color:var(--lime);border:1px solid rgba(191,255,0,0.2)">P1: ${winner.model}</span>` : ''}
                </div>
                <div class="flex items-center gap-3">
                  ${winner ? `<span class="font-mono text-sm" style="color:var(--lime)">${winner.avg_tokens_per_second} tok/s</span>` : ''}
                  ${runId ? `<button onclick="deleteHistoryRun('${runId}')" class="text-zinc-700 hover:text-red-400 transition-colors" title="Delete run"><svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg></button>` : ''}
                </div>
              </div>
              <div class="overflow-x-auto">
                <table class="w-full text-xs">
                  <thead><tr class="text-zinc-700">
                    <th class="px-3 py-1.5 text-left section-label">Model</th>
                    <th class="px-3 py-1.5 text-right section-label">Tok/s</th>
                    ${hasMultiRun ? '<th class="px-3 py-1.5 text-right section-label">Std Dev</th>' : ''}
                    <th class="px-3 py-1.5 text-right section-label">TTFT</th>
                    <th class="px-3 py-1.5 text-right section-label">Duration</th>
                  </tr></thead>
                  <tbody>
                    ${sorted.map((r, i) => `
                      <tr style="border-top: 1px solid var(--border-subtle)">
                        <td class="px-3 py-2 text-zinc-400 font-body">${r.provider} / ${r.model}</td>
                        <td class="px-3 py-2 text-right font-mono ${i === 0 ? '' : 'text-zinc-500'}" ${i === 0 ? 'style="color:var(--lime)"' : ''}>${r.avg_tokens_per_second}</td>
                        ${hasMultiRun ? `<td class="px-3 py-2 text-right font-mono text-zinc-600">${r.std_dev_tps > 0 ? '\u00B1' + r.std_dev_tps.toFixed(1) : '-'}</td>` : ''}
                        <td class="px-3 py-2 text-right font-mono text-zinc-600">${r.avg_ttft_ms}ms</td>
                        <td class="px-3 py-2 text-right font-mono text-zinc-600">${r.avg_total_time_s}s</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </div>
            </div>
          `;
        }).join('');
      } catch (e) {
        container.innerHTML = '<p class="text-red-400 text-sm font-body">Failed to load history.</p>';
      }
    }

    async function deleteHistoryRun(runId) {
      if (!confirm('Delete this benchmark run?')) return;
      try {
        const res = await apiFetch(`/api/history/${runId}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('Run deleted', 'success');
          loadHistory();
        } else {
          const err = await res.json();
          showToast(err.error || 'Failed to delete run', 'error');
        }
      } catch (e) {
        showToast('Failed to delete run', 'error');
      }
    }

    // -------------------------------------------------------------------
    // Prompt Templates
    // -------------------------------------------------------------------
    let promptTemplates = {};

    async function loadPromptTemplates() {
      try {
        const res = await apiFetch('/api/config/prompts');
        promptTemplates = await res.json();
        const select = document.getElementById('promptTemplateSelect');
        select.innerHTML = '<option value="">Custom</option>';
        for (const [key, tpl] of Object.entries(promptTemplates)) {
          const opt = document.createElement('option');
          opt.value = key;
          opt.textContent = tpl.label || key;
          select.appendChild(opt);
        }
      } catch (e) {
        console.error('Failed to load prompt templates:', e);
      }
    }

    function applyPromptTemplate(key) {
      const textarea = document.getElementById('prompt');
      if (!key) {
        // Custom - leave textarea as is, make it editable
        textarea.removeAttribute('readonly');
        return;
      }
      const tpl = promptTemplates[key];
      if (tpl) {
        textarea.value = tpl.prompt;
        textarea.removeAttribute('readonly');
      }
    }

    // -------------------------------------------------------------------
    // Provider Health Check
    // -------------------------------------------------------------------
    async function checkProviderHealth() {
      const btn = document.getElementById('healthCheckBtn');
      btn.textContent = 'Checking...';
      btn.style.opacity = '0.5';
      btn.disabled = true;

      try {
        const res = await apiFetch('/api/health/providers');
        const data = await res.json();
        const healthMap = {};
        for (const p of data.providers) {
          healthMap[p.name] = p;
        }

        // Update provider group headers with health status
        const headers = document.querySelectorAll('.provider-group-header');
        headers.forEach(header => {
          const labelEl = header.querySelector('.provider-group-label');
          if (!labelEl) return;
          const provName = labelEl.textContent.trim();
          const health = healthMap[provName];

          // Remove any existing health indicator
          const existing = header.querySelector('.health-indicator');
          if (existing) existing.remove();

          if (health) {
            const indicator = document.createElement('span');
            indicator.className = 'health-indicator';
            indicator.style.cssText = 'display:inline-flex;align-items:center;gap:4px;margin-left:4px;';
            if (health.status === 'ok') {
              indicator.innerHTML = `<span style="width:6px;height:6px;border-radius:50%;background:#22C55E;display:inline-block;box-shadow:0 0 6px rgba(34,197,94,0.4)"></span><span style="font-size:9px;font-family:'Space Mono',monospace;color:#8B8B95">${health.latency_ms}ms</span>`;
            } else {
              indicator.innerHTML = `<span style="width:6px;height:6px;border-radius:50%;background:#FF3B5C;display:inline-block;box-shadow:0 0 6px rgba(255,59,92,0.4)"></span><span style="font-size:9px;font-family:'Space Mono',monospace;color:#FF3B5C" title="${health.error || ''}">err</span>`;
            }
            header.appendChild(indicator);
          }
        });

        showToast('Health check complete', 'success');
      } catch (e) {
        showToast('Health check failed: ' + e.message, 'error');
      } finally {
        btn.textContent = 'Check Health';
        btn.style.opacity = '1';
        btn.disabled = false;
      }
    }

    // -------------------------------------------------------------------
    // Cross-Run Comparison (History)
    // -------------------------------------------------------------------
    let selectedHistoryRuns = new Set();

    function toggleHistoryCheckbox(btn, runId) {
      const isChecked = btn.dataset.checked === 'true';
      if (isChecked) {
        btn.dataset.checked = 'false';
        btn.style.borderColor = 'var(--border-subtle)';
        btn.style.background = 'transparent';
        btn.innerHTML = '';
        selectedHistoryRuns.delete(runId);
      } else {
        btn.dataset.checked = 'true';
        btn.style.borderColor = '#38BDF8';
        btn.style.background = 'rgba(56,189,248,0.15)';
        btn.innerHTML = '<svg class="w-2.5 h-2.5" fill="none" stroke="#38BDF8" stroke-width="3" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>';
        selectedHistoryRuns.add(runId);
      }
      const bar = document.getElementById('historyCompareBar');
      const countEl = document.getElementById('compareCount');
      if (selectedHistoryRuns.size >= 2) {
        bar.classList.remove('hidden');
        countEl.textContent = selectedHistoryRuns.size;
      } else {
        bar.classList.add('hidden');
      }
    }

    async function compareSelectedRuns() {
      const runIds = Array.from(selectedHistoryRuns);
      if (runIds.length < 2) {
        showToast('Select at least 2 runs to compare', 'error');
        return;
      }

      const container = document.getElementById('historyCompareResult');
      container.innerHTML = '<div class="card rounded-md p-5"><span class="text-zinc-500 text-sm font-body">Loading comparison...</span></div>';
      container.classList.remove('hidden');

      try {
        const runs = await Promise.all(runIds.map(async id => {
          const res = await apiFetch(`/api/history/${id}`);
          return res.json();
        }));

        // Collect all unique models across runs
        const allModels = new Set();
        runs.forEach(run => {
          (run.results || []).forEach(r => {
            allModels.add(`${r.provider}||${r.model}`);
          });
        });
        const modelList = Array.from(allModels).sort();

        // Build comparison table
        const runLabels = runs.map(r => {
          const d = new Date(r.timestamp);
          return d.toLocaleDateString() + ' ' + d.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
        });

        let tableHtml = `
          <div class="card rounded-md overflow-hidden">
            <div class="px-5 py-3 flex items-center justify-between" style="border-bottom:1px solid var(--border-subtle)">
              <span class="section-label">Cross-Run Comparison</span>
              <button onclick="document.getElementById('historyCompareResult').classList.add('hidden')" class="text-[11px] font-display tracking-wider uppercase text-zinc-600 hover:text-zinc-300 px-2 py-1">Close</button>
            </div>
            <div class="overflow-x-auto">
              <table class="w-full text-xs results-table">
                <thead><tr style="border-bottom:1px solid var(--border-subtle)">
                  <th class="px-4 py-3 text-left section-label">Model</th>
                  ${runLabels.map(l => `<th class="px-4 py-3 text-right section-label">${l}</th>`).join('')}
                </tr></thead>
                <tbody>`;

        for (const modelKey of modelList) {
          const [provider, model] = modelKey.split('||');
          const color = getColor(provider);
          const values = runs.map(run => {
            const match = (run.results || []).find(r => r.provider === provider && r.model === model);
            if (!match) return null;
            return match.avg_tokens_per_second ?? match.tokens_per_second ?? 0;
          });

          // Find max value for highlighting
          const validValues = values.filter(v => v !== null && v > 0);
          const maxVal = validValues.length ? Math.max(...validValues) : 0;
          const minVal = validValues.length ? Math.min(...validValues) : 0;

          tableHtml += `<tr style="border-top:1px solid var(--border-subtle)">
            <td class="px-4 py-2.5">
              <span class="badge mr-2" style="background:${color.bg};color:${color.text};border:1px solid ${color.border};font-size:9px">${provider}</span>
              <span class="text-zinc-300 font-body text-[12px]">${model}</span>
            </td>`;

          for (const v of values) {
            if (v === null) {
              tableHtml += `<td class="px-4 py-2.5 text-right font-mono text-zinc-700">-</td>`;
            } else {
              let cellColor = 'text-zinc-400';
              if (validValues.length >= 2 && maxVal !== minVal) {
                if (v === maxVal) cellColor = 'text-green-400';
                else if (v === minVal) cellColor = 'text-red-400';
              }
              tableHtml += `<td class="px-4 py-2.5 text-right font-mono ${cellColor}">${v.toFixed ? v.toFixed(1) : v} tok/s</td>`;
            }
          }
          tableHtml += '</tr>';
        }

        tableHtml += '</tbody></table></div></div>';
        container.innerHTML = tableHtml;
      } catch (e) {
        container.innerHTML = `<div class="error-banner">${e.message || 'Failed to load comparison data'}</div>`;
      }
    }

    // -------------------------------------------------------------------
    // -------------------------------------------------------------------
    // Scheduled Benchmarks
    // -------------------------------------------------------------------
    const SCHED_INTERVALS = [
      { value: 1, label: 'Every hour' },
      { value: 6, label: 'Every 6 hours' },
      { value: 12, label: 'Every 12 hours' },
      { value: 24, label: 'Every day' },
      { value: 168, label: 'Every week' },
    ];

    function formatInterval(hours) {
      const m = SCHED_INTERVALS.find(i => i.value === hours);
      if (m) return m.label;
      if (hours < 24) return `Every ${hours}h`;
      if (hours % 168 === 0) return `Every ${hours/168}w`;
      if (hours % 24 === 0) return `Every ${hours/24}d`;
      return `Every ${hours}h`;
    }

    function formatSchedTime(iso) {
      if (!iso) return '--';
      const d = new Date(iso);
      const now = new Date();
      const diffMs = d - now;
      const diffMin = Math.round(diffMs / 60000);
      if (Math.abs(diffMin) < 60) {
        if (diffMin <= 0) return `${Math.abs(diffMin)}m ago`;
        return `in ${diffMin}m`;
      }
      const diffH = Math.round(diffMin / 60);
      if (Math.abs(diffH) < 24) {
        if (diffH <= 0) return `${Math.abs(diffH)}h ago`;
        return `in ${diffH}h`;
      }
      return d.toLocaleDateString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
    }

    async function loadSchedules() {
      const tbody = document.getElementById('schedTableBody');
      try {
        const res = await apiFetch('/api/schedules');
        const schedules = await res.json();
        if (!schedules.length) {
          tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No schedules yet. Create one to automate recurring benchmarks.</td></tr>';
          return;
        }
        tbody.innerHTML = schedules.map(s => {
          const models = JSON.parse(s.models_json || '[]');
          return `<tr>
            <td class="px-5 py-3 text-zinc-200 font-body text-sm">${s.name}</td>
            <td class="px-5 py-3 text-center font-mono text-xs text-zinc-400">${models.length}</td>
            <td class="px-5 py-3 text-center text-xs text-zinc-400 font-body">${formatInterval(s.interval_hours)}</td>
            <td class="px-5 py-3 text-right text-xs font-mono text-zinc-500">${formatSchedTime(s.last_run)}</td>
            <td class="px-5 py-3 text-right text-xs font-mono text-zinc-500">${formatSchedTime(s.next_run)}</td>
            <td class="px-5 py-3 text-center">
              <label class="relative inline-flex items-center cursor-pointer">
                <input type="checkbox" ${s.enabled ? 'checked' : ''} onchange="schedToggleEnabled(${s.id}, this.checked)" class="sr-only peer">
                <div class="w-8 h-4 rounded-full peer bg-zinc-700 peer-checked:bg-lime-accent/40 after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-zinc-400 after:rounded-full after:h-3 after:w-3 after:transition-all peer-checked:after:translate-x-4 peer-checked:after:bg-[var(--lime)]"></div>
              </label>
            </td>
            <td class="px-5 py-3 text-right">
              <div class="flex items-center justify-end gap-2">
                <button onclick="schedTrigger(${s.id})" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 transition-colors px-2 py-1 rounded-sm" style="border:1px solid var(--border-subtle)">Run Now</button>
                <button onclick="schedDelete(${s.id},'${s.name.replace(/'/g,"\\'")}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-600 hover:text-red-400 transition-colors px-2 py-1 rounded-sm" style="border:1px solid var(--border-subtle)">Del</button>
              </div>
            </td>
          </tr>`;
        }).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="7" class="px-5 py-8 text-center text-red-400 text-sm font-body">Failed to load schedules.</td></tr>';
      }
    }

    async function schedToggleEnabled(id, enabled) {
      try {
        await apiFetch(`/api/schedules/${id}`, {
          method: 'PUT',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ enabled: enabled ? 1 : 0 }),
        });
        showToast(enabled ? 'Schedule enabled' : 'Schedule paused', 'success');
      } catch (e) {
        showToast('Failed to update schedule', 'error');
        loadSchedules();
      }
    }

    async function schedTrigger(id) {
      try {
        await apiFetch(`/api/schedules/${id}/trigger`, { method: 'POST' });
        showToast('Schedule triggered - benchmark starting', 'success');
        loadSchedules();
      } catch (e) {
        showToast('Failed to trigger schedule', 'error');
      }
    }

    function schedDelete(id, name) {
      showModal('Delete Schedule', `Delete schedule <strong>${name}</strong>? This cannot be undone.`, async () => {
        try {
          await apiFetch(`/api/schedules/${id}`, { method: 'DELETE' });
          showToast('Schedule deleted', 'success');
          loadSchedules();
        } catch (e) {
          showToast('Failed to delete schedule', 'error');
        }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    // ── New Schedule Modal ──
    let schedSelectedModels = new Set();

    function schedOpenNewModal() {
      if (!config) {
        showToast('Config not loaded yet', 'error');
        return;
      }
      schedSelectedModels = new Set();

      // Build model selection grid (reuse benchmark model card pattern)
      let modelGridHtml = '';
      for (const [provider, provData] of Object.entries(config.providers)) {
        const color = getColor(provider);
        const models = getProviderModels(provData);
        if (!models.length) continue;
        modelGridHtml += `<div class="provider-group" style="border-color:${color.border}">
          <div class="provider-group-header" onclick="schedToggleProviderModels(this, '${provider}')">
            <div class="provider-group-dot" style="background:${color.text}"></div>
            <span class="provider-group-label" style="color:${color.text}">${provider}</span>
            <span class="provider-group-count">${models.length}</span>
          </div>
          <div class="grid grid-cols-1 sm:grid-cols-2 gap-2 pl-3">
            ${models.map(m => `<div class="model-card rounded-sm px-3 py-2 flex items-center gap-2" data-model-id="${m.model_id}" onclick="schedToggleModel('${m.model_id}', this)">
              <div class="check-dot flex-shrink-0"></div>
              <div class="text-[12px] font-medium text-zinc-200 truncate font-body">${m.display_name}</div>
            </div>`).join('')}
          </div>
        </div>`;
      }

      // Build interval options
      const intervalOpts = SCHED_INTERVALS.map(i =>
        `<option value="${i.value}"${i.value === 24 ? ' selected' : ''}>${i.label}</option>`
      ).join('');

      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.id = 'schedModal';
      overlay.innerHTML = `
        <div class="modal-box" style="max-width:600px;max-height:85vh;overflow-y:auto;">
          <div class="modal-title">New Schedule</div>
          <div class="space-y-4">
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Schedule Name</label>
              <input id="sched-name" class="modal-input" style="margin-bottom:0" placeholder="e.g. Daily throughput check">
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Prompt</label>
              <textarea id="sched-prompt" rows="3" class="prompt-input w-full rounded-sm px-4 py-3" placeholder="Enter benchmark prompt...">Write a short story about a robot learning to paint.</textarea>
            </div>
            <div class="grid grid-cols-2 gap-4">
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Interval</label>
                <select id="sched-interval" class="w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
                  ${intervalOpts}
                </select>
              </div>
              <div>
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Max Tokens</label>
                <input type="number" id="sched-max-tokens" value="512" class="w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;">
              </div>
            </div>
            <div>
              <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Temperature</label>
              <input type="number" id="sched-temperature" value="0.7" step="0.1" min="0" max="2" class="w-full px-3 py-2 rounded-sm text-sm font-mono text-zinc-200" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);outline:none;max-width:120px;">
            </div>
            <div>
              <div class="flex items-center justify-between mb-2">
                <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase">Select Models</label>
                <div class="flex gap-2">
                  <button onclick="schedSelectAllModels()" class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm" style="color:var(--lime);border:1px solid rgba(191,255,0,0.2)">All</button>
                  <button onclick="schedClearAllModels()" class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm text-zinc-600" style="border:1px solid var(--border-subtle)">Clear</button>
                </div>
              </div>
              <div id="schedModelGrid" class="flex flex-col gap-1 max-h-48 overflow-y-auto pr-1" style="scrollbar-width:thin;">
                ${modelGridHtml}
              </div>
              <div class="mt-1 text-[10px] font-mono text-zinc-600"><span id="schedModelCount">0</span> models selected</div>
            </div>
          </div>
          <div class="modal-buttons mt-4">
            <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
            <button class="modal-btn modal-btn-confirm" data-action="confirm">Create Schedule</button>
          </div>
        </div>
      `;
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = () => schedCreate(overlay);
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => document.getElementById('sched-name')?.focus(), 50);
    }

    function schedToggleModel(modelId, card) {
      if (schedSelectedModels.has(modelId)) {
        schedSelectedModels.delete(modelId);
        card.classList.remove('selected');
      } else {
        schedSelectedModels.add(modelId);
        card.classList.add('selected');
      }
      const cnt = document.getElementById('schedModelCount');
      if (cnt) cnt.textContent = schedSelectedModels.size;
    }

    function schedToggleProviderModels(header, provider) {
      const group = header.parentElement;
      const cards = group.querySelectorAll('.model-card');
      const allSelected = [...cards].every(c => c.classList.contains('selected'));
      cards.forEach(c => {
        const mid = c.dataset.modelId;
        if (allSelected) { schedSelectedModels.delete(mid); c.classList.remove('selected'); }
        else { schedSelectedModels.add(mid); c.classList.add('selected'); }
      });
      const cnt = document.getElementById('schedModelCount');
      if (cnt) cnt.textContent = schedSelectedModels.size;
    }

    function schedSelectAllModels() {
      document.querySelectorAll('#schedModelGrid .model-card').forEach(c => {
        schedSelectedModels.add(c.dataset.modelId);
        c.classList.add('selected');
      });
      const cnt = document.getElementById('schedModelCount');
      if (cnt) cnt.textContent = schedSelectedModels.size;
    }

    function schedClearAllModels() {
      schedSelectedModels.clear();
      document.querySelectorAll('#schedModelGrid .model-card').forEach(c => c.classList.remove('selected'));
      const cnt = document.getElementById('schedModelCount');
      if (cnt) cnt.textContent = 0;
    }

    async function schedCreate(overlay) {
      const name = document.getElementById('sched-name')?.value.trim();
      const prompt = document.getElementById('sched-prompt')?.value.trim();
      const interval_hours = parseInt(document.getElementById('sched-interval')?.value);
      const max_tokens = parseInt(document.getElementById('sched-max-tokens')?.value) || 512;
      const temperature = parseFloat(document.getElementById('sched-temperature')?.value) || 0.7;
      const models = [...schedSelectedModels];

      if (!name) { showToast('Please enter a schedule name', 'error'); return; }
      if (!prompt) { showToast('Please enter a prompt', 'error'); return; }
      if (!models.length) { showToast('Please select at least one model', 'error'); return; }

      try {
        const res = await apiFetch('/api/schedules', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ name, prompt, models, interval_hours, max_tokens, temperature }),
        });
        if (res.ok) {
          _closeModal(overlay);
          showToast('Schedule created', 'success');
          loadSchedules();
        } else {
          const err = await res.json();
          showToast(err.error || 'Failed to create schedule', 'error');
        }
      } catch (e) {
        showToast('Network error creating schedule', 'error');
      }
    }

    // -------------------------------------------------------------------
    // Admin Dashboard
    // -------------------------------------------------------------------
    let auditPage = 0;
    const AUDIT_PAGE_SIZE = 50;

    async function loadAdminDashboard() {
      await Promise.all([loadAdminStats(), loadAdminSystem(), loadAdminUsers(), loadAuditLog()]);
    }

    async function loadAdminStats() {
      try {
        const res = await apiFetch('/api/admin/stats');
        if (!res.ok) return;
        const stats = await res.json();
        const container = document.getElementById('adminStatsCards');
        container.innerHTML = `
          <div class="card rounded-md p-4">
            <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Benchmarks (24h)</div>
            <div class="text-2xl font-display font-bold text-zinc-100">${stats.benchmarks_24h || 0}</div>
          </div>
          <div class="card rounded-md p-4">
            <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Benchmarks (7d)</div>
            <div class="text-2xl font-display font-bold text-zinc-100">${stats.benchmarks_7d || 0}</div>
          </div>
          <div class="card rounded-md p-4">
            <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Benchmarks (30d)</div>
            <div class="text-2xl font-display font-bold text-zinc-100">${stats.benchmarks_30d || 0}</div>
          </div>
          <div class="card rounded-md p-4">
            <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Total Users</div>
            <div class="text-2xl font-display font-bold text-zinc-100">${stats.total_users || 0}</div>
          </div>
        `;

        // Populate audit user filter from top_users + keys_by_provider info
        const userFilter = document.getElementById('auditFilterUser');
        const existingOptions = userFilter.querySelectorAll('option:not(:first-child)');
        existingOptions.forEach(o => o.remove());
        if (stats.top_users) {
          stats.top_users.forEach(u => {
            const opt = document.createElement('option');
            opt.value = u.username;
            opt.textContent = u.username;
            userFilter.appendChild(opt);
          });
        }
      } catch {}
    }

    async function loadAdminSystem() {
      try {
        const res = await apiFetch('/api/admin/system');
        if (!res.ok) return;
        const sys = await res.json();
        const container = document.getElementById('adminSystemHealth');
        const upHours = Math.floor((sys.process_uptime_s || 0) / 3600);
        const upMins = Math.floor(((sys.process_uptime_s || 0) % 3600) / 60);
        container.innerHTML = `
          <h3 class="font-display font-semibold text-sm text-zinc-100 tracking-wider uppercase mb-4">System Health</h3>
          <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
            <div>
              <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">DB Size</div>
              <div class="text-sm font-mono text-zinc-300">${sys.db_size_mb} MB</div>
            </div>
            <div>
              <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Results Files</div>
              <div class="text-sm font-mono text-zinc-300">${sys.results_count} (${sys.results_size_mb} MB)</div>
            </div>
            <div>
              <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Uptime</div>
              <div class="text-sm font-mono text-zinc-300">${upHours}h ${upMins}m</div>
            </div>
            <div>
              <div class="text-[10px] font-display tracking-wider uppercase text-zinc-600 mb-1">Benchmark Active</div>
              <div class="text-sm font-mono ${sys.benchmark_active ? 'text-yellow-400' : 'text-zinc-500'}">${sys.benchmark_active ? 'Running' : 'Idle'}</div>
            </div>
          </div>
        `;
      } catch {}
    }

    async function loadAdminUsers() {
      try {
        const res = await apiFetch('/api/admin/users');
        if (!res.ok) return;
        const data = await res.json();
        const container = document.getElementById('adminUsersTable');
        if (!data.users || data.users.length === 0) {
          container.innerHTML = '<p class="text-zinc-600 text-sm">No users found.</p>';
          return;
        }
        let html = `<table class="w-full text-xs results-table">
          <thead><tr class="text-[10px] font-display tracking-wider uppercase text-zinc-500">
            <th class="text-left px-3 py-2">Email</th>
            <th class="text-left px-3 py-2">Role</th>
            <th class="text-right px-3 py-2">Benchmarks</th>
            <th class="text-right px-3 py-2">Keys</th>
            <th class="text-left px-3 py-2">Last Login</th>
            <th class="text-left px-3 py-2">Created</th>
            <th class="text-right px-3 py-2">Actions</th>
          </tr></thead><tbody>`;

        for (const u of data.users) {
          const isCurrentUser = currentUser && u.id === currentUser.id;
          const lastLogin = u.last_login ? new Date(u.last_login + 'Z').toLocaleDateString() : 'Never';
          const created = u.created_at ? new Date(u.created_at + 'Z').toLocaleDateString() : '-';
          html += `<tr>
            <td class="px-3 py-2 font-mono text-zinc-300">${escapeHtml(u.email)}</td>
            <td class="px-3 py-2">
              <select onchange="changeUserRole('${u.id}', this.value)" class="text-xs font-mono px-1 py-0.5 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);color:${u.role === 'admin' ? '#BFFF00' : '#A1A1AA'};outline:none;" ${isCurrentUser ? 'disabled title="Cannot change own role"' : ''}>
                <option value="user" ${u.role === 'user' ? 'selected' : ''}>user</option>
                <option value="admin" ${u.role === 'admin' ? 'selected' : ''}>admin</option>
              </select>
            </td>
            <td class="px-3 py-2 text-right font-mono text-zinc-400">${u.benchmark_count || 0}</td>
            <td class="px-3 py-2 text-right font-mono text-zinc-400">${u.key_count || 0}</td>
            <td class="px-3 py-2 text-zinc-500">${lastLogin}</td>
            <td class="px-3 py-2 text-zinc-500">${created}</td>
            <td class="px-3 py-2 text-right" style="white-space:nowrap;">
              <button onclick="showRateLimitModal('${u.id}', '${escapeHtml(u.email)}')" class="text-[10px] font-display tracking-wider uppercase px-2 py-1 rounded-sm" style="border:1px solid var(--border-subtle);color:#85858F;">Limits</button>
              ${isCurrentUser ? '' : `<button onclick="deleteUser('${u.id}', '${escapeHtml(u.email)}')" class="text-[10px] font-display tracking-wider uppercase px-2 py-1 rounded-sm ml-1" style="border:1px solid var(--coral);color:var(--coral);">Delete</button>`}
            </td>
          </tr>`;
        }
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch {}
    }

    async function changeUserRole(userId, newRole) {
      try {
        const res = await apiFetch(`/api/admin/users/${userId}/role`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ role: newRole }),
        });
        if (res.ok) {
          showToast('Role updated', 'success');
        } else {
          const data = await res.json();
          showToast(data.error || 'Failed to update role', 'error');
          loadAdminUsers(); // Revert UI
        }
      } catch {
        showToast('Failed to update role', 'error');
        loadAdminUsers();
      }
    }

    async function deleteUser(userId, email) {
      if (!confirm(`Delete user "${email}"?\n\nThis will permanently remove the user and ALL their data (keys, benchmarks, evals, schedules). This cannot be undone.`)) return;
      try {
        const res = await apiFetch(`/api/admin/users/${userId}`, { method: 'DELETE' });
        if (res.ok) {
          showToast('User deleted', 'success');
          loadAdminUsers();
          loadAdminStats();
        } else {
          const data = await res.json();
          showToast(data.error || 'Failed to delete user', 'error');
        }
      } catch {
        showToast('Failed to delete user', 'error');
      }
    }

    async function showRateLimitModal(userId, email) {
      try {
        const res = await apiFetch(`/api/admin/users/${userId}/rate-limit`);
        const limits = res.ok ? await res.json() : { benchmarks_per_hour: 20, max_concurrent: 1, max_runs_per_benchmark: 10 };

        const html = `
          <div class="modal-overlay" id="rateLimitModal" style="z-index:10000;" onclick="if(event.target===this)this.remove()">
            <div class="modal-box" style="max-width:380px;">
              <h3 class="font-display font-semibold text-sm text-zinc-100 mb-1">Rate Limits</h3>
              <p class="text-xs text-zinc-500 mb-4">${escapeHtml(email)}</p>
              <div class="space-y-3">
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Benchmarks Per Hour</label>
                  <input type="number" id="rl_bph" value="${limits.benchmarks_per_hour}" min="1" max="1000" class="modal-input w-full">
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Max Concurrent</label>
                  <input type="number" id="rl_mc" value="${limits.max_concurrent}" min="1" max="10" class="modal-input w-full">
                </div>
                <div>
                  <label class="text-[10px] text-zinc-600 font-display tracking-wider uppercase block mb-1">Max Runs Per Benchmark</label>
                  <input type="number" id="rl_mrpb" value="${limits.max_runs_per_benchmark}" min="1" max="50" class="modal-input w-full">
                </div>
              </div>
              <div class="flex gap-2 mt-5">
                <button onclick="document.getElementById('rateLimitModal').remove()" class="modal-btn flex-1">Cancel</button>
                <button onclick="saveRateLimit('${userId}')" class="modal-btn modal-btn-confirm flex-1">Save</button>
              </div>
            </div>
          </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
      } catch {}
    }

    async function saveRateLimit(userId) {
      const bph = parseInt(document.getElementById('rl_bph').value) || 20;
      const mc = parseInt(document.getElementById('rl_mc').value) || 1;
      const mrpb = parseInt(document.getElementById('rl_mrpb').value) || 10;

      try {
        const res = await apiFetch(`/api/admin/users/${userId}/rate-limit`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ benchmarks_per_hour: bph, max_concurrent: mc, max_runs_per_benchmark: mrpb }),
        });
        if (res.ok) {
          showToast('Rate limits updated', 'success');
          document.getElementById('rateLimitModal').remove();
        } else {
          const data = await res.json();
          showToast(data.error || 'Failed to save', 'error');
        }
      } catch {
        showToast('Failed to save rate limits', 'error');
      }
    }

    async function loadAuditLog() {
      try {
        const userFilter = document.getElementById('auditFilterUser').value;
        const actionFilter = document.getElementById('auditFilterAction').value;
        const sinceFilter = document.getElementById('auditFilterSince').value;

        let sinceParam = '';
        if (sinceFilter) {
          const now = new Date();
          const map = { '1h': 3600000, '24h': 86400000, '7d': 604800000, '30d': 2592000000 };
          const ms = map[sinceFilter] || 0;
          if (ms) sinceParam = new Date(now.getTime() - ms).toISOString().replace('T', ' ').slice(0, 19);
        }

        const params = new URLSearchParams();
        if (userFilter) params.set('user', userFilter);
        if (actionFilter) params.set('action', actionFilter);
        if (sinceParam) params.set('since', sinceParam);
        params.set('limit', AUDIT_PAGE_SIZE);
        params.set('offset', auditPage * AUDIT_PAGE_SIZE);

        const res = await apiFetch(`/api/admin/audit?${params.toString()}`);
        if (!res.ok) return;
        const data = await res.json();
        const container = document.getElementById('adminAuditTable');

        if (!data.entries || data.entries.length === 0) {
          container.innerHTML = '<p class="text-zinc-600 text-sm">No audit entries found.</p>';
          document.getElementById('auditPageInfo').textContent = '';
          document.getElementById('auditPrevBtn').disabled = true;
          document.getElementById('auditNextBtn').disabled = true;
          return;
        }

        const actionColors = {
          user_login: 'text-green-400', user_login_failed: 'text-red-400',
          user_register: 'text-blue-400', user_logout: 'text-zinc-500',
          benchmark_start: 'text-yellow-400', benchmark_complete: 'text-green-400',
          benchmark_cancel: 'text-orange-400', admin_user_update: 'text-purple-400',
          admin_rate_limit: 'text-purple-400', token_refresh: 'text-zinc-500',
        };

        let html = `<table class="w-full text-xs results-table">
          <thead><tr class="text-[10px] font-display tracking-wider uppercase text-zinc-500">
            <th class="text-left px-3 py-2">Time</th>
            <th class="text-left px-3 py-2">User</th>
            <th class="text-left px-3 py-2">Action</th>
            <th class="text-left px-3 py-2">Resource</th>
            <th class="text-left px-3 py-2">Detail</th>
            <th class="text-left px-3 py-2">IP</th>
          </tr></thead><tbody>`;

        for (const e of data.entries) {
          const ts = e.timestamp ? new Date(e.timestamp + 'Z').toLocaleString() : '-';
          const color = actionColors[e.action] || 'text-zinc-400';
          let detail = '';
          if (e.detail) {
            try { detail = typeof e.detail === 'string' ? e.detail : JSON.stringify(e.detail); } catch { detail = ''; }
            if (detail.length > 60) detail = detail.slice(0, 57) + '...';
          }
          html += `<tr>
            <td class="px-3 py-2 text-zinc-500 whitespace-nowrap">${ts}</td>
            <td class="px-3 py-2 font-mono text-zinc-400">${escapeHtml(e.username || '')}</td>
            <td class="px-3 py-2 font-mono ${color}">${escapeHtml(e.action || '')}</td>
            <td class="px-3 py-2 text-zinc-500">${escapeHtml(e.resource_type || '')}${e.resource_id ? ':' + escapeHtml(e.resource_id) : ''}</td>
            <td class="px-3 py-2 text-zinc-600 font-mono" title="${escapeHtml(detail)}">${escapeHtml(detail)}</td>
            <td class="px-3 py-2 text-zinc-600 font-mono">${escapeHtml(e.ip_address || '')}</td>
          </tr>`;
        }
        html += '</tbody></table>';
        container.innerHTML = html;

        const from = auditPage * AUDIT_PAGE_SIZE + 1;
        const to = from + data.entries.length - 1;
        document.getElementById('auditPageInfo').textContent = `${from}-${to}`;
        document.getElementById('auditPrevBtn').disabled = auditPage === 0;
        document.getElementById('auditNextBtn').disabled = data.entries.length < AUDIT_PAGE_SIZE;
      } catch {}
    }

    function auditPrevPage() {
      if (auditPage > 0) { auditPage--; loadAuditLog(); }
    }
    function auditNextPage() {
      auditPage++; loadAuditLog();
    }

    function escapeHtml(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // -------------------------------------------------------------------
    // Analytics — Leaderboard, Compare, Trends
    // -------------------------------------------------------------------
    const AN_CHART_COLORS = [
      '#BFFF00', '#00d4ff', '#ff6b6b', '#ffd93d',
      '#6bcb77', '#4d96ff', '#ff9f43', '#a855f7',
    ];

    let anLeaderboardData = [];
    let anLeaderboardType = 'benchmark';
    let anLeaderboardSortKey = 'avg_tps';
    let anLeaderboardSortAsc = false;
    let anCompareSelectedRuns = new Set();
    let anCompareTpsChart = null;
    let anCompareTtftChart = null;
    let anTrendsTpsChart = null;
    let anTrendsTtftChart = null;
    let anTrendsSelectedModels = new Set();
    let anTrendsModelDropdownOpen = false;
    let anCompareRunsCache = [];

    // --- Sub-view toggling ---
    function anSetSubBtn(active) {
      ['leaderboard', 'compare', 'trends'].forEach(v => {
        const btn = document.getElementById('an-btn-' + v);
        if (v === active) {
          btn.style.color = 'var(--lime)';
          btn.style.border = '1px solid rgba(191,255,0,0.3)';
          btn.style.background = 'var(--lime-dim)';
        } else {
          btn.style.color = '#85858F';
          btn.style.border = '1px solid var(--border-subtle)';
          btn.style.background = 'transparent';
        }
      });
    }

    function analyticsShowLeaderboard() {
      document.getElementById('an-leaderboard-view').classList.remove('hidden');
      document.getElementById('an-compare-view').classList.add('hidden');
      document.getElementById('an-trends-view').classList.add('hidden');
      anSetSubBtn('leaderboard');
      analyticsLoadLeaderboard();
    }

    function analyticsShowCompare() {
      document.getElementById('an-leaderboard-view').classList.add('hidden');
      document.getElementById('an-compare-view').classList.remove('hidden');
      document.getElementById('an-trends-view').classList.add('hidden');
      anSetSubBtn('compare');
      anLoadCompareRuns();
    }

    function analyticsShowTrends() {
      document.getElementById('an-leaderboard-view').classList.add('hidden');
      document.getElementById('an-compare-view').classList.add('hidden');
      document.getElementById('an-trends-view').classList.remove('hidden');
      anSetSubBtn('trends');
      anLoadTrendsModels();
    }

    // --- Leaderboard ---
    function anSetLeaderboardType(type) {
      anLeaderboardType = type;
      const btnB = document.getElementById('an-lb-type-benchmark');
      const btnT = document.getElementById('an-lb-type-tool_eval');
      if (type === 'benchmark') {
        btnB.style.color = 'var(--lime)'; btnB.style.border = '1px solid rgba(191,255,0,0.3)'; btnB.style.background = 'var(--lime-dim)';
        btnT.style.color = '#85858F'; btnT.style.border = '1px solid var(--border-subtle)'; btnT.style.background = 'transparent';
        anLeaderboardSortKey = 'avg_tps';
      } else {
        btnT.style.color = 'var(--lime)'; btnT.style.border = '1px solid rgba(191,255,0,0.3)'; btnT.style.background = 'var(--lime-dim)';
        btnB.style.color = '#85858F'; btnB.style.border = '1px solid var(--border-subtle)'; btnB.style.background = 'transparent';
        anLeaderboardSortKey = 'avg_overall_pct';
      }
      anLeaderboardSortAsc = false;
      anUpdateLeaderboardHeaders();
      analyticsLoadLeaderboard();
    }

    function anUpdateLeaderboardHeaders() {
      const head = document.getElementById('anLeaderboardHead');
      if (anLeaderboardType === 'benchmark') {
        head.innerHTML = `<tr style="border-bottom: 1px solid var(--border-subtle)">
          <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('rank')">#</th>
          <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('model')">Model</th>
          <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('provider')">Provider</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_tps')">Avg TPS</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_ttft_ms')">Avg TTFT</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_cost')">Avg Cost</th>
          <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('total_runs')">Runs</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('last_run')">Last Run</th>
        </tr>`;
      } else {
        head.innerHTML = `<tr style="border-bottom: 1px solid var(--border-subtle)">
          <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('rank')">#</th>
          <th class="px-5 py-3 text-left section-label cursor-pointer" onclick="anSortLeaderboard('model')">Model</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_tool_pct')">Avg Tool %</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_param_pct')">Avg Param %</th>
          <th class="px-5 py-3 text-right section-label cursor-pointer" onclick="anSortLeaderboard('avg_overall_pct')">Avg Overall %</th>
          <th class="px-5 py-3 text-center section-label cursor-pointer" onclick="anSortLeaderboard('total_evals')">Evals</th>
        </tr>`;
      }
    }

    async function analyticsLoadLeaderboard() {
      const body = document.getElementById('anLeaderboardBody');
      const period = document.getElementById('anLeaderboardPeriod').value;
      const colCount = anLeaderboardType === 'benchmark' ? 8 : 6;
      body.innerHTML = `<tr><td colspan="${colCount}" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">Loading...</td></tr>`;

      try {
        const res = await apiFetch(`/api/analytics/leaderboard?type=${anLeaderboardType}&period=${period}`);
        if (!res.ok) throw new Error('Failed to load');
        const data = await res.json();
        anLeaderboardData = data.models || [];
        anRenderLeaderboard();
      } catch (e) {
        body.innerHTML = `<tr><td colspan="${colCount}" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No benchmark data yet. Run some benchmarks first!</td></tr>`;
      }
    }

    function anSortLeaderboard(key) {
      if (key === 'rank') { anLeaderboardSortKey = anLeaderboardType === 'benchmark' ? 'avg_tps' : 'avg_overall_pct'; anLeaderboardSortAsc = false; }
      else if (anLeaderboardSortKey === key) { anLeaderboardSortAsc = !anLeaderboardSortAsc; }
      else { anLeaderboardSortKey = key; anLeaderboardSortAsc = false; }
      anRenderLeaderboard();
    }

    function anRenderLeaderboard() {
      const body = document.getElementById('anLeaderboardBody');
      if (!anLeaderboardData.length) {
        const colCount = anLeaderboardType === 'benchmark' ? 8 : 6;
        body.innerHTML = `<tr><td colspan="${colCount}" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No benchmark data yet. Run some benchmarks first!</td></tr>`;
        return;
      }

      const sorted = [...anLeaderboardData].sort((a, b) => {
        let va = a[anLeaderboardSortKey], vb = b[anLeaderboardSortKey];
        if (typeof va === 'string') { va = va.toLowerCase(); vb = (vb || '').toLowerCase(); }
        if (va < vb) return anLeaderboardSortAsc ? -1 : 1;
        if (va > vb) return anLeaderboardSortAsc ? 1 : -1;
        return 0;
      });

      if (anLeaderboardType === 'benchmark') {
        body.innerHTML = sorted.map((m, i) => {
          const rank = i + 1;
          const rowClass = rank === 1 ? 'rank-1' : '';
          const lastRun = m.last_run ? new Date(m.last_run).toLocaleDateString() : '-';
          const cost = m.avg_cost != null && m.avg_cost > 0 ? '$' + m.avg_cost.toFixed(4) : 'N/A';
          return `<tr class="${rowClass}" style="border-top:1px solid var(--border-subtle)">
            <td class="px-5 py-3 text-center font-mono text-zinc-500 text-xs">${rank}</td>
            <td class="px-5 py-3 text-left font-body text-zinc-200 text-sm">${escapeHtml(m.model)}</td>
            <td class="px-5 py-3 text-left font-body text-zinc-500 text-xs">${escapeHtml(m.provider || '')}</td>
            <td class="px-5 py-3 text-right font-mono text-sm" ${rank === 1 ? 'style="color:var(--lime)"' : 'style="color:#A1A1AA"'}>${m.avg_tps.toFixed(1)}</td>
            <td class="px-5 py-3 text-right font-mono text-sm text-zinc-400">${m.avg_ttft_ms.toFixed(0)}ms</td>
            <td class="px-5 py-3 text-right font-mono text-xs text-zinc-500">${cost}</td>
            <td class="px-5 py-3 text-center font-mono text-xs text-zinc-500">${m.total_runs}</td>
            <td class="px-5 py-3 text-right font-mono text-xs text-zinc-600">${lastRun}</td>
          </tr>`;
        }).join('');
      } else {
        body.innerHTML = sorted.map((m, i) => {
          const rank = i + 1;
          const rowClass = rank === 1 ? 'rank-1' : '';
          return `<tr class="${rowClass}" style="border-top:1px solid var(--border-subtle)">
            <td class="px-5 py-3 text-center font-mono text-zinc-500 text-xs">${rank}</td>
            <td class="px-5 py-3 text-left font-body text-zinc-200 text-sm">${escapeHtml(m.model)}</td>
            <td class="px-5 py-3 text-right font-mono text-sm text-zinc-400">${(m.avg_tool_pct || 0).toFixed(1)}%</td>
            <td class="px-5 py-3 text-right font-mono text-sm text-zinc-400">${(m.avg_param_pct || 0).toFixed(1)}%</td>
            <td class="px-5 py-3 text-right font-mono text-sm" ${rank === 1 ? 'style="color:var(--lime)"' : 'style="color:#A1A1AA"'}>${(m.avg_overall_pct || 0).toFixed(1)}%</td>
            <td class="px-5 py-3 text-center font-mono text-xs text-zinc-500">${m.total_evals || 0}</td>
          </tr>`;
        }).join('');
      }
    }

    // --- Compare ---
    async function anLoadCompareRuns() {
      const listEl = document.getElementById('anCompareRunsList');
      listEl.innerHTML = '<p class="text-zinc-600 text-xs font-body">Loading recent runs...</p>';
      anCompareSelectedRuns.clear();
      anUpdateCompareBtn();

      try {
        const res = await apiFetch('/api/history');
        const data = await res.json();
        anCompareRunsCache = (data.runs || []).filter(r => r.id);

        if (!anCompareRunsCache.length) {
          listEl.innerHTML = '<p class="text-zinc-600 text-xs font-body">No benchmark runs found.</p>';
          return;
        }

        listEl.innerHTML = anCompareRunsCache.slice(0, 20).map(run => {
          const ts = new Date(run.timestamp).toLocaleString();
          const modelCount = (run.results || []).length;
          const prompt = (run.prompt || '').substring(0, 50);
          return `<label class="flex items-center gap-3 px-3 py-2 rounded-sm cursor-pointer transition-colors hover:bg-white/[0.02]" style="border:1px solid var(--border-subtle)">
            <input type="checkbox" value="${run.id}" onchange="anToggleCompareRun(this)" class="accent-lime-400 w-3.5 h-3.5" />
            <span class="text-xs font-mono text-zinc-500">${ts}</span>
            <span class="text-xs font-body text-zinc-400 truncate flex-1">${escapeHtml(prompt || 'Benchmark run')}</span>
            <span class="text-[10px] font-mono text-zinc-600">${modelCount} models</span>
          </label>`;
        }).join('');
      } catch (e) {
        listEl.innerHTML = '<p class="text-zinc-600 text-xs font-body">Failed to load runs.</p>';
      }
    }

    function anToggleCompareRun(checkbox) {
      if (checkbox.checked) {
        if (anCompareSelectedRuns.size >= 4) { checkbox.checked = false; showToast('Max 4 runs', 'error'); return; }
        anCompareSelectedRuns.add(checkbox.value);
      } else {
        anCompareSelectedRuns.delete(checkbox.value);
      }
      anUpdateCompareBtn();
    }

    function anUpdateCompareBtn() {
      const btn = document.getElementById('anCompareBtn');
      const n = anCompareSelectedRuns.size;
      if (n >= 2) {
        btn.disabled = false;
        btn.style.color = 'var(--lime)';
        btn.style.border = '1px solid rgba(191,255,0,0.3)';
        btn.style.cursor = 'pointer';
        btn.style.opacity = '1';
      } else {
        btn.disabled = true;
        btn.style.color = '#85858F';
        btn.style.border = '1px solid var(--border-subtle)';
        btn.style.cursor = 'not-allowed';
        btn.style.opacity = '0.5';
      }
    }

    async function analyticsLoadCompare() {
      if (anCompareSelectedRuns.size < 2) return;
      const ids = Array.from(anCompareSelectedRuns).join(',');

      try {
        const res = await apiFetch(`/api/analytics/compare?runs=${ids}`);
        if (!res.ok) throw new Error('Failed');
        const data = await res.json();
        anRenderCompareCharts(data.runs || []);
      } catch (e) {
        // Fallback: fetch runs individually from history
        try {
          const runs = await Promise.all(Array.from(anCompareSelectedRuns).map(async id => {
            const r = await apiFetch(`/api/history/${id}`);
            return r.json();
          }));
          anRenderCompareCharts(runs);
        } catch (e2) {
          showToast('Failed to load comparison data', 'error');
        }
      }
    }

    function anRenderCompareCharts(runs) {
      if (!runs.length) return;

      document.getElementById('anCompareCharts').classList.remove('hidden');
      document.getElementById('anCompareEmpty').classList.add('hidden');

      // Collect all models across runs
      const allModels = new Set();
      runs.forEach(run => {
        (run.results || run.models || []).forEach(r => {
          allModels.add(r.model || r.display_name);
        });
      });
      const modelList = Array.from(allModels).sort();

      // Build run labels
      const runLabels = runs.map(r => {
        const d = new Date(r.timestamp);
        const prompt = (r.prompt || '').substring(0, 20);
        return d.toLocaleDateString() + (prompt ? ' - ' + prompt : '');
      });

      // TPS data
      const tpsDatasets = runs.map((run, ri) => {
        const results = run.results || run.models || [];
        return {
          label: runLabels[ri],
          data: modelList.map(m => {
            const match = results.find(r => (r.model || r.display_name) === m);
            return match ? (match.avg_tokens_per_second ?? match.avg_tps ?? 0) : 0;
          }),
          backgroundColor: AN_CHART_COLORS[ri % AN_CHART_COLORS.length] + 'CC',
          borderColor: AN_CHART_COLORS[ri % AN_CHART_COLORS.length],
          borderWidth: 0,
          borderRadius: 2,
        };
      });

      // TTFT data
      const ttftDatasets = runs.map((run, ri) => {
        const results = run.results || run.models || [];
        return {
          label: runLabels[ri],
          data: modelList.map(m => {
            const match = results.find(r => (r.model || r.display_name) === m);
            return match ? (match.avg_ttft_ms ?? 0) : 0;
          }),
          backgroundColor: AN_CHART_COLORS[ri % AN_CHART_COLORS.length] + 'CC',
          borderColor: AN_CHART_COLORS[ri % AN_CHART_COLORS.length],
          borderWidth: 0,
          borderRadius: 2,
        };
      });

      const chartOpts = (title, unit) => ({
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 800, easing: 'easeOutQuart' },
        plugins: {
          legend: {
            display: true,
            labels: { color: '#85858F', font: { family: 'Outfit', size: 11 }, boxWidth: 12, padding: 16 }
          },
          tooltip: {
            backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
            titleFont: { family: 'Outfit', size: 13, weight: '500' },
            bodyFont: { family: 'Space Mono', size: 12 },
            padding: 12, cornerRadius: 2,
            callbacks: { label: ctx => ` ${ctx.parsed.y.toFixed(1)} ${unit}` }
          }
        },
        scales: {
          x: {
            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
            ticks: { color: '#85858F', font: { family: 'Outfit', size: 11 }, maxRotation: 45 }
          },
          y: {
            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
            ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
            title: { display: true, text: title, color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' } }
          }
        }
      });

      // Destroy old charts
      if (anCompareTpsChart) { anCompareTpsChart.destroy(); anCompareTpsChart = null; }
      if (anCompareTtftChart) { anCompareTtftChart.destroy(); anCompareTtftChart = null; }

      anCompareTpsChart = new Chart(document.getElementById('anCompareTpsChart'), {
        type: 'bar',
        data: { labels: modelList, datasets: tpsDatasets },
        options: chartOpts('TOKENS / SECOND', 'tok/s')
      });

      anCompareTtftChart = new Chart(document.getElementById('anCompareTtftChart'), {
        type: 'bar',
        data: { labels: modelList, datasets: ttftDatasets },
        options: chartOpts('TIME TO FIRST TOKEN (MS)', 'ms')
      });
    }

    // --- Trends ---
    async function anLoadTrendsModels() {
      // Populate model list from leaderboard data
      try {
        const res = await apiFetch('/api/analytics/leaderboard?type=benchmark&period=all');
        if (!res.ok) return;
        const data = await res.json();
        const models = data.models || [];
        const listEl = document.getElementById('anTrendsModelList');

        if (!models.length) {
          listEl.innerHTML = '<p class="text-zinc-600 text-xs font-body px-2 py-1">No models found.</p>';
          return;
        }

        listEl.innerHTML = models.map(m => {
          const checked = anTrendsSelectedModels.has(m.model) ? 'checked' : '';
          return `<label class="flex items-center gap-2 px-2 py-1 rounded-sm cursor-pointer hover:bg-white/[0.03] text-xs text-zinc-400 font-body">
            <input type="checkbox" value="${escapeHtml(m.model)}" ${checked} onchange="anToggleTrendModel(this)" class="accent-lime-400 w-3 h-3" />
            ${escapeHtml(m.model)}
          </label>`;
        }).join('');
      } catch (e) { /* ignore */ }
    }

    function anToggleModelDropdown() {
      anTrendsModelDropdownOpen = !anTrendsModelDropdownOpen;
      document.getElementById('anTrendsModelList').classList.toggle('hidden', !anTrendsModelDropdownOpen);
    }

    // Close dropdown on outside click
    document.addEventListener('click', (e) => {
      const dd = document.getElementById('anTrendsModelDropdown');
      if (dd && !dd.contains(e.target) && anTrendsModelDropdownOpen) {
        anTrendsModelDropdownOpen = false;
        document.getElementById('anTrendsModelList').classList.add('hidden');
      }
    });

    function anToggleTrendModel(checkbox) {
      if (checkbox.checked) {
        anTrendsSelectedModels.add(checkbox.value);
      } else {
        anTrendsSelectedModels.delete(checkbox.value);
      }
      const label = document.getElementById('anTrendsModelLabel');
      const n = anTrendsSelectedModels.size;
      label.textContent = n === 0 ? 'Select Models' : n + ' model' + (n > 1 ? 's' : '') + ' selected';
      if (n > 0) analyticsLoadTrends();
    }

    async function analyticsLoadTrends() {
      if (anTrendsSelectedModels.size === 0) {
        document.getElementById('anTrendsCharts').classList.add('hidden');
        document.getElementById('anTrendsEmpty').classList.remove('hidden');
        return;
      }

      const models = Array.from(anTrendsSelectedModels).join(',');
      const period = document.getElementById('anTrendsPeriod').value;

      try {
        // Fetch TPS trends
        const resTps = await apiFetch(`/api/analytics/trends?models=${encodeURIComponent(models)}&metric=tps&period=${period}`);
        const dataTps = await resTps.json();

        // Fetch TTFT trends
        const resTtft = await apiFetch(`/api/analytics/trends?models=${encodeURIComponent(models)}&metric=ttft&period=${period}`);
        const dataTtft = await resTtft.json();

        anRenderTrendsCharts(dataTps, dataTtft);
      } catch (e) {
        showToast('Failed to load trends', 'error');
      }
    }

    function anRenderTrendsCharts(tpsData, ttftData) {
      document.getElementById('anTrendsCharts').classList.remove('hidden');
      document.getElementById('anTrendsEmpty').classList.add('hidden');

      const buildDatasets = (data) => {
        return (data.series || []).map((s, i) => ({
          label: s.model,
          data: (s.points || []).map(p => ({ x: new Date(p.timestamp), y: p.value })),
          borderColor: AN_CHART_COLORS[i % AN_CHART_COLORS.length],
          backgroundColor: AN_CHART_COLORS[i % AN_CHART_COLORS.length] + '33',
          borderWidth: 2,
          pointRadius: 3,
          pointBackgroundColor: AN_CHART_COLORS[i % AN_CHART_COLORS.length],
          pointBorderColor: '#09090B',
          pointBorderWidth: 2,
          tension: 0.3,
          fill: false,
        }));
      };

      const lineOpts = (yTitle) => ({
        responsive: true,
        maintainAspectRatio: false,
        animation: { duration: 800, easing: 'easeOutQuart' },
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: {
            display: true,
            labels: { color: '#85858F', font: { family: 'Outfit', size: 11 }, boxWidth: 12, padding: 16 }
          },
          tooltip: {
            backgroundColor: '#1c1c20', borderColor: '#27272A', borderWidth: 1,
            titleFont: { family: 'Outfit', size: 13, weight: '500' },
            bodyFont: { family: 'Space Mono', size: 12 },
            padding: 12, cornerRadius: 2,
          }
        },
        scales: {
          x: {
            type: 'time',
            time: { unit: 'day', tooltipFormat: 'MMM d, yyyy HH:mm' },
            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
            ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 10 } }
          },
          y: {
            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false },
            ticks: { color: '#8B8B95', font: { family: 'Space Mono', size: 11 } },
            title: { display: true, text: yTitle, color: '#63636B', font: { family: 'Chakra Petch', size: 10, weight: '600' } }
          }
        }
      });

      // Destroy old charts
      if (anTrendsTpsChart) { anTrendsTpsChart.destroy(); anTrendsTpsChart = null; }
      if (anTrendsTtftChart) { anTrendsTtftChart.destroy(); anTrendsTtftChart = null; }

      const tpsDatasets = buildDatasets(tpsData);
      const ttftDatasets = buildDatasets(ttftData);

      if (tpsDatasets.length) {
        anTrendsTpsChart = new Chart(document.getElementById('anTrendsTpsChart'), {
          type: 'line',
          data: { datasets: tpsDatasets },
          options: lineOpts('TOKENS / SECOND')
        });
      }

      if (ttftDatasets.length) {
        anTrendsTtftChart = new Chart(document.getElementById('anTrendsTtftChart'), {
          type: 'line',
          data: { datasets: ttftDatasets },
          options: lineOpts('TTFT (MS)')
        });
      }
    }

    // -------------------------------------------------------------------
    // Tool Eval — Suite CRUD, Test Cases, Eval Execution, History
    // -------------------------------------------------------------------
    let teSuites = [];
    let teCurrentSuite = null;       // full suite object when editing
    let teEditingToolIndex = -1;     // -1 = adding new, >=0 = editing existing
    let teEditingCaseId = null;      // null = adding new, string = editing existing
    let teSelectedModels = new Set();
    let teEvalResults = [];          // live results from SSE
    let teEvalSummaries = [];        // model summaries from SSE
    let teSummarySortKey = 'overall_pct';
    let teSummarySortAsc = false;
    let teEvalHistory = [];
    let _teSSETimeout = null;
    let teRunSuiteId = null;         // suite_id for current run view

    function showToolEvalView(view) {
      document.getElementById('te-suites-view').classList.toggle('hidden', view !== 'suites');
      document.getElementById('te-editor-view').classList.toggle('hidden', view !== 'editor');
      document.getElementById('te-run-view').classList.toggle('hidden', view !== 'run');
    }

    // --- Suite List ---
    async function teLoadSuites() {
      try {
        const res = await apiFetch('/api/tool-suites');
        if (!res.ok) { showToast('Failed to load suites', 'error'); return; }
        const data = await res.json();
        teSuites = data.suites || [];
        teRenderSuites();
      } catch (e) {
        showToast('Failed to load suites', 'error');
      }
    }

    function teRenderSuites() {
      const body = document.getElementById('teSuitesBody');
      if (!teSuites.length) {
        body.innerHTML = '<tr><td colspan="5" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No tool suites yet. Click "New Suite" to create one.</td></tr>';
        return;
      }
      body.innerHTML = teSuites.map(s => {
        const updated = s.updated_at ? _teTimeAgo(s.updated_at) : '';
        return `<tr>
          <td class="px-5 py-3"><button onclick="teOpenSuite('${s.id}')" class="text-zinc-200 hover:text-white font-body text-sm underline decoration-zinc-700 hover:decoration-zinc-400 transition-colors">${_teEsc(s.name || 'Untitled')}</button></td>
          <td class="px-5 py-3 text-center font-mono text-xs text-zinc-500">${s.tool_count || 0}</td>
          <td class="px-5 py-3 text-center font-mono text-xs text-zinc-500">${s.test_case_count || 0}</td>
          <td class="px-5 py-3 text-right text-xs text-zinc-600 font-body">${updated}</td>
          <td class="px-5 py-3 text-right">
            <button onclick="teDeleteSuite('${s.id}','${_teEsc(s.name)}')" class="text-zinc-700 hover:text-red-400 transition-colors text-xs font-display tracking-wider uppercase">Delete</button>
          </td>
        </tr>`;
      }).join('');
    }

    function _teTimeAgo(dateStr) {
      try {
        const d = new Date(dateStr + (dateStr.includes('Z') || dateStr.includes('+') ? '' : 'Z'));
        const diff = (Date.now() - d.getTime()) / 1000;
        if (diff < 60) return 'just now';
        if (diff < 3600) return Math.floor(diff/60) + 'm ago';
        if (diff < 86400) return Math.floor(diff/3600) + 'h ago';
        return Math.floor(diff/86400) + 'd ago';
      } catch { return dateStr; }
    }

    function _teEsc(s) { return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }

    async function teNewSuite() {
      try {
        const res = await apiFetch('/api/tool-suites', {
          method: 'POST',
          body: JSON.stringify({ name: 'New Suite', description: '', tools: [] }),
        });
        if (!res.ok) { showToast('Failed to create suite', 'error'); return; }
        const data = await res.json();
        showToast('Suite created', 'success');
        await teOpenSuite(data.suite_id);
      } catch (e) {
        showToast('Failed to create suite', 'error');
      }
    }

    function teImportSuiteJson() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.onchange = async (e) => {
        const file = e.target.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!data.name || typeof data.name !== 'string') {
            showToast('Invalid JSON: missing "name" field', 'error');
            return;
          }
          const res = await apiFetch('/api/tool-eval/import', {
            method: 'POST',
            body: JSON.stringify(data),
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            showToast(err.error || 'Import failed', 'error');
            return;
          }
          const result = await res.json();
          showToast(`Imported "${data.name}" with ${result.test_cases_created} test cases`, 'success');
          await teLoadSuites();
          await teOpenSuite(result.suite_id);
        } catch (err) {
          showToast('Failed to import: ' + (err.message || 'invalid JSON'), 'error');
        }
      };
      input.click();
    }

    function teDeleteSuite(id, name) {
      showModal('Delete Suite', `Delete "${name}" and all its test cases? This cannot be undone.`, async () => {
        try {
          const res = await apiFetch(`/api/tool-suites/${id}`, { method: 'DELETE' });
          if (!res.ok) { showToast('Failed to delete', 'error'); return; }
          showToast('Suite deleted', 'success');
          await teLoadSuites();
        } catch { showToast('Failed to delete', 'error'); }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    // --- MCP Import ---
    let _mcpDiscoveredTools = [];

    function mcpOpenModal() {
      document.getElementById('mcpModal').classList.remove('hidden');
      document.getElementById('mcpStep1').classList.remove('hidden');
      document.getElementById('mcpStep2').classList.add('hidden');
      document.getElementById('mcpConnectError').classList.add('hidden');
      document.getElementById('mcpConnecting').classList.add('hidden');
      document.getElementById('mcpUrl').value = '';
      _mcpDiscoveredTools = [];
    }

    function mcpCloseModal() {
      document.getElementById('mcpModal').classList.add('hidden');
    }

    async function mcpConnect() {
      const url = document.getElementById('mcpUrl').value.trim();
      if (!url) { showToast('Enter a server URL', 'error'); return; }

      const errDiv = document.getElementById('mcpConnectError');
      const loadDiv = document.getElementById('mcpConnecting');
      const btn = document.getElementById('mcpConnectBtn');

      errDiv.classList.add('hidden');
      loadDiv.classList.remove('hidden');
      btn.disabled = true;
      btn.textContent = 'Connecting...';

      try {
        const res = await apiFetch('/api/mcp/discover', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url }),
        });
        const data = await res.json();

        if (data.error) {
          errDiv.textContent = data.error;
          errDiv.classList.remove('hidden');
          return;
        }

        _mcpDiscoveredTools = data.tools;
        mcpRenderStep2(data);
      } catch (e) {
        errDiv.textContent = 'Connection failed: ' + e.message;
        errDiv.classList.remove('hidden');
      } finally {
        loadDiv.classList.add('hidden');
        btn.disabled = false;
        btn.textContent = 'Connect';
      }
    }

    function mcpRenderStep2(data) {
      document.getElementById('mcpStep1').classList.add('hidden');
      document.getElementById('mcpStep2').classList.remove('hidden');
      document.getElementById('mcpServerInfo').textContent =
        `Connected to: ${data.server_name} (${data.tool_count} tool${data.tool_count !== 1 ? 's' : ''} found)`;

      // Default suite name
      const names = data.tools.slice(0, 3).map(t => t.name);
      const suffix = data.tools.length > 3 ? '...' : '';
      document.getElementById('mcpSuiteName').value = `MCP: ${names.join(', ')}${suffix}`;
      document.getElementById('mcpSuiteDesc').value = `Imported from MCP server: ${document.getElementById('mcpUrl').value}`;

      // Render tool list with checkboxes
      const list = document.getElementById('mcpToolList');
      list.innerHTML = data.tools.map((t, i) => {
        const params = Object.entries((t.inputSchema || {}).properties || {});
        const required = (t.inputSchema || {}).required || [];
        const paramHtml = params.map(([name, schema]) => {
          const req = required.includes(name) ? ', required' : ', optional';
          return `<span class="text-zinc-500">${_teEsc(name)}</span> <span class="text-zinc-700">(${schema.type || '?'}${req})</span>`;
        }).join(', ');

        return `<label class="flex gap-3 p-3 rounded border border-zinc-800 hover:border-zinc-700 cursor-pointer">
          <input type="checkbox" checked data-mcp-idx="${i}" class="mt-1 mcp-tool-check">
          <div class="flex-1 min-w-0">
            <div class="text-sm text-zinc-200 font-mono">${_teEsc(t.name)}</div>
            <div class="text-xs text-zinc-500 mt-0.5">${_teEsc(t.description)}</div>
            ${params.length ? `<div class="text-xs text-zinc-600 mt-1">Params: ${paramHtml}</div>` : ''}
          </div>
        </label>`;
      }).join('');

      mcpUpdateImportBtn();
    }

    function mcpSelectAll(checked) {
      document.querySelectorAll('.mcp-tool-check').forEach(cb => cb.checked = checked);
      mcpUpdateImportBtn();
    }

    function mcpUpdateImportBtn() {
      const count = document.querySelectorAll('.mcp-tool-check:checked').length;
      const btn = document.getElementById('mcpImportBtn');
      btn.textContent = `Import ${count} Tool${count !== 1 ? 's' : ''}`;
      btn.disabled = count === 0;
    }

    // Attach change listener via delegation for MCP checkboxes
    document.addEventListener('change', (e) => {
      if (e.target.classList.contains('mcp-tool-check')) mcpUpdateImportBtn();
    });

    async function mcpImport() {
      const checked = document.querySelectorAll('.mcp-tool-check:checked');
      const selectedTools = Array.from(checked).map(cb => _mcpDiscoveredTools[parseInt(cb.dataset.mcpIdx)]);

      if (!selectedTools.length) { showToast('Select at least one tool', 'error'); return; }

      const btn = document.getElementById('mcpImportBtn');
      btn.disabled = true;
      btn.textContent = 'Importing...';

      try {
        const res = await apiFetch('/api/mcp/import', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            suite_name: document.getElementById('mcpSuiteName').value.trim(),
            suite_description: document.getElementById('mcpSuiteDesc').value.trim(),
            tools: selectedTools,
            generate_test_cases: document.getElementById('mcpGenTests').checked,
          }),
        });
        const data = await res.json();

        if (data.error) { showToast(data.error, 'error'); return; }

        showToast(`Imported ${data.tools_imported} tool(s)${data.test_cases_generated ? ` with ${data.test_cases_generated} test case(s)` : ''}`, 'success');
        mcpCloseModal();

        // Navigate to the new suite editor
        await teOpenSuite(data.suite_id);
      } catch (e) {
        showToast('Import failed: ' + e.message, 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Import Tools';
      }
    }

    // --- Suite Editor ---
    async function teOpenSuite(suiteId) {
      try {
        const res = await apiFetch(`/api/tool-suites/${suiteId}`);
        if (!res.ok) { showToast('Suite not found', 'error'); return; }
        teCurrentSuite = await res.json();
        teRenderEditor();
        showToolEvalView('editor');
      } catch (e) {
        showToast('Failed to load suite', 'error');
      }
    }

    function teRenderEditor() {
      if (!teCurrentSuite) return;
      document.getElementById('teSuiteName').value = teCurrentSuite.name || '';
      document.getElementById('teSuiteDesc').value = teCurrentSuite.description || '';
      teRenderToolsList();
      teRenderCasesList();
      // Hide editors
      document.getElementById('teToolEditor').classList.add('hidden');
      document.getElementById('teCaseEditor').classList.add('hidden');
    }

    async function teSaveSuiteMeta() {
      if (!teCurrentSuite) return;
      const name = document.getElementById('teSuiteName').value.trim();
      const description = document.getElementById('teSuiteDesc').value.trim();
      if (!name) { showToast('Name is required', 'error'); return; }
      try {
        const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}`, {
          method: 'PUT',
          body: JSON.stringify({ name, description }),
        });
        if (!res.ok) { showToast('Failed to save', 'error'); return; }
        teCurrentSuite.name = name;
        teCurrentSuite.description = description;
      } catch { showToast('Failed to save', 'error'); }
    }

    // --- Tools ---
    function teRenderToolsList() {
      const tools = teCurrentSuite?.tools || [];
      const container = document.getElementById('teToolsList');
      document.getElementById('teToolCount').textContent = `(${tools.length})`;
      if (!tools.length) {
        container.innerHTML = '<p class="text-zinc-600 text-xs font-body">No tools defined yet.</p>';
        return;
      }
      container.innerHTML = tools.map((t, i) => {
        const fn = t.function || {};
        return `<div class="flex items-center justify-between px-3 py-2 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);">
          <div class="flex-1 min-w-0">
            <span class="text-sm font-mono text-zinc-200">${_teEsc(fn.name || 'unnamed')}</span>
            <span class="text-xs text-zinc-600 ml-2 font-body">${_teEsc(fn.description || '')}</span>
          </div>
          <div class="flex gap-2 ml-3 flex-shrink-0">
            <button onclick="teEditTool(${i})" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300">Edit</button>
            <button onclick="teDeleteTool(${i})" class="text-[10px] font-display tracking-wider uppercase text-zinc-700 hover:text-red-400">Delete</button>
          </div>
        </div>`;
      }).join('');
    }

    function teAddTool() {
      teEditingToolIndex = -1;
      document.getElementById('teToolJson').value = JSON.stringify({
        type: "function",
        function: {
          name: "my_tool",
          description: "Description of what this tool does",
          parameters: {
            type: "object",
            properties: {},
            required: []
          }
        }
      }, null, 2);
      document.getElementById('teToolJsonError').classList.add('hidden');
      document.getElementById('teToolEditor').classList.remove('hidden');
    }

    function teEditTool(index) {
      teEditingToolIndex = index;
      const tools = teCurrentSuite?.tools || [];
      document.getElementById('teToolJson').value = JSON.stringify(tools[index], null, 2);
      document.getElementById('teToolJsonError').classList.add('hidden');
      document.getElementById('teToolEditor').classList.remove('hidden');
    }

    function teCancelToolEdit() {
      document.getElementById('teToolEditor').classList.add('hidden');
      teEditingToolIndex = -1;
    }

    async function teSaveToolJson() {
      const jsonStr = document.getElementById('teToolJson').value.trim();
      const errEl = document.getElementById('teToolJsonError');
      let tool;
      try {
        tool = JSON.parse(jsonStr);
      } catch (e) {
        errEl.textContent = 'Invalid JSON: ' + e.message;
        errEl.classList.remove('hidden');
        return;
      }
      // Structural validation
      if (!tool || typeof tool !== 'object') { errEl.textContent = 'Tool must be a JSON object'; errEl.classList.remove('hidden'); return; }
      if (tool.type !== 'function') { errEl.textContent = 'tool.type must be "function"'; errEl.classList.remove('hidden'); return; }
      if (!tool.function?.name) { errEl.textContent = 'tool.function.name is required'; errEl.classList.remove('hidden'); return; }
      errEl.classList.add('hidden');

      const tools = [...(teCurrentSuite?.tools || [])];
      if (teEditingToolIndex >= 0) {
        tools[teEditingToolIndex] = tool;
      } else {
        tools.push(tool);
      }

      try {
        const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}`, {
          method: 'PUT',
          body: JSON.stringify({ tools }),
        });
        if (!res.ok) { showToast('Failed to save tools', 'error'); return; }
        teCurrentSuite.tools = tools;
        teRenderToolsList();
        teCancelToolEdit();
        showToast('Tool saved', 'success');
      } catch { showToast('Failed to save tools', 'error'); }
    }

    function teDeleteTool(index) {
      const fn = teCurrentSuite?.tools?.[index]?.function || {};
      showModal('Delete Tool', `Delete "${fn.name || 'unnamed'}"?`, async () => {
        const tools = [...(teCurrentSuite?.tools || [])];
        tools.splice(index, 1);
        try {
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}`, {
            method: 'PUT',
            body: JSON.stringify({ tools }),
          });
          if (!res.ok) { showToast('Failed to delete tool', 'error'); return; }
          teCurrentSuite.tools = tools;
          teRenderToolsList();
          showToast('Tool deleted', 'success');
        } catch { showToast('Failed to delete tool', 'error'); }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    function teExportTools() {
      const tools = teCurrentSuite?.tools || [];
      if (!tools.length) { showToast('No tools to export', 'error'); return; }
      const blob = new Blob([JSON.stringify(tools, null, 2)], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${(teCurrentSuite.name || 'tools').replace(/[^a-z0-9]+/gi, '_').toLowerCase()}_tools.json`;
      a.click();
      URL.revokeObjectURL(a.href);
    }

    function teImportToolsJson() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `<div class="modal-box" style="max-width:600px;">
        <div class="modal-title">Import Tools (JSON)</div>
        <div class="modal-message">Paste a JSON array of tools in OpenAI function calling format, or upload a file.</div>
        <div class="flex gap-2 mb-3">
          <button class="modal-btn modal-btn-cancel text-xs" data-action="file">Choose File</button>
        </div>
        <textarea class="modal-input font-mono text-xs" style="height:200px;resize:vertical;margin-bottom:16px;" placeholder='[{"type":"function","function":{"name":"my_tool","description":"...","parameters":{...}}}]'></textarea>
        <div class="text-xs mb-3" style="color:var(--coral);display:none;" id="teImportToolsErr"></div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">Import</button>
        </div>
      </div>`;
      const textarea = overlay.querySelector('textarea');
      overlay.querySelector('[data-action="file"]').onclick = () => {
        const input = document.createElement('input');
        input.type = 'file'; input.accept = '.json';
        input.onchange = async (e) => { if (e.target.files[0]) textarea.value = await e.target.files[0].text(); };
        input.click();
      };
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = async () => {
        const errEl = overlay.querySelector('#teImportToolsErr');
        let tools;
        try { tools = JSON.parse(textarea.value.trim()); } catch (e) {
          errEl.textContent = 'Invalid JSON: ' + e.message; errEl.style.display = 'block'; return;
        }
        if (!Array.isArray(tools) || !tools.length) {
          errEl.textContent = 'Must be a non-empty JSON array of tools'; errEl.style.display = 'block'; return;
        }
        for (let i = 0; i < tools.length; i++) {
          if (tools[i].type !== 'function' || !tools[i].function?.name) {
            errEl.textContent = `Tool ${i+1}: must have type "function" and function.name`; errEl.style.display = 'block'; return;
          }
        }
        try {
          const merged = [...(teCurrentSuite?.tools || []), ...tools];
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}`, {
            method: 'PUT',
            body: JSON.stringify({ tools: merged }),
          });
          if (!res.ok) { const d = await res.json().catch(()=>({})); showToast(d.error || 'Import failed', 'error'); return; }
          teCurrentSuite.tools = merged;
          teRenderToolsList();
          _closeModal(overlay);
          showToast(`Imported ${tools.length} tool${tools.length > 1 ? 's' : ''}`, 'success');
        } catch { showToast('Failed to import tools', 'error'); }
      };
      document.body.appendChild(overlay);
    }

    // --- Test Cases ---
    function teRenderCasesList() {
      const cases = teCurrentSuite?.test_cases || [];
      const container = document.getElementById('teCasesList');
      document.getElementById('teCaseCount').textContent = `(${cases.length})`;
      if (!cases.length) {
        container.innerHTML = '<p class="text-zinc-600 text-xs font-body">No test cases defined yet.</p>';
        return;
      }
      container.innerHTML = cases.map((c, i) => {
        const expTool = c.expected_tool;
        let expStr;
        if (expTool === null || expTool === undefined) {
          expStr = '<span class="text-zinc-600">(no tool call)</span>';
        } else if (Array.isArray(expTool)) {
          expStr = expTool.join(' | ');
        } else {
          expStr = expTool;
        }
        const paramsStr = c.expected_params ? '(' + Object.entries(c.expected_params).map(([k,v]) => `${k}=${JSON.stringify(v)}`).join(', ') + ')' : '';
        return `<div class="flex items-start justify-between px-3 py-2 rounded-sm" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);">
          <div class="flex-1 min-w-0">
            <div class="text-sm text-zinc-300 font-body mb-0.5">#${i+1} "${_teEsc(_teTruncate(c.prompt, 80))}"</div>
            <div class="text-xs font-mono text-zinc-500">Expected: ${expStr}${paramsStr ? ' ' + _teEsc(paramsStr) : ''}</div>
          </div>
          <div class="flex gap-2 ml-3 flex-shrink-0 mt-1">
            <button onclick="teEditCase('${c.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300">Edit</button>
            <button onclick="teDeleteCase('${c.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-700 hover:text-red-400">Delete</button>
          </div>
        </div>`;
      }).join('');
    }

    function _teTruncate(s, max) {
      s = s || '';
      return s.length > max ? s.slice(0, max) + '...' : s;
    }

    function teAddCase() {
      teEditingCaseId = null;
      document.getElementById('teCasePrompt').value = '';
      document.getElementById('teCaseExpTool').value = '';
      document.getElementById('teCaseExpParams').value = '';
      document.getElementById('teCaseNoTool').checked = false;
      document.getElementById('teCaseExpTool').disabled = false;
      document.getElementById('teCaseError').classList.add('hidden');
      document.getElementById('teCaseEditor').classList.remove('hidden');
    }

    function teEditCase(caseId) {
      const c = (teCurrentSuite?.test_cases || []).find(x => x.id === caseId);
      if (!c) return;
      teEditingCaseId = caseId;
      document.getElementById('teCasePrompt').value = c.prompt || '';
      const isNoTool = c.expected_tool === null || c.expected_tool === undefined;
      document.getElementById('teCaseNoTool').checked = isNoTool;
      document.getElementById('teCaseExpTool').disabled = isNoTool;
      if (isNoTool) {
        document.getElementById('teCaseExpTool').value = '';
      } else if (Array.isArray(c.expected_tool)) {
        document.getElementById('teCaseExpTool').value = c.expected_tool.join(', ');
      } else {
        document.getElementById('teCaseExpTool').value = c.expected_tool || '';
      }
      document.getElementById('teCaseExpParams').value = c.expected_params ? JSON.stringify(c.expected_params, null, 2) : '';
      document.getElementById('teCaseError').classList.add('hidden');
      document.getElementById('teCaseEditor').classList.remove('hidden');
    }

    function teCancelCaseEdit() {
      document.getElementById('teCaseEditor').classList.add('hidden');
      teEditingCaseId = null;
    }

    function teToggleNoTool() {
      const checked = document.getElementById('teCaseNoTool').checked;
      document.getElementById('teCaseExpTool').disabled = checked;
      if (checked) document.getElementById('teCaseExpTool').value = '';
    }

    async function teSaveCaseEdit() {
      const errEl = document.getElementById('teCaseError');
      const prompt = document.getElementById('teCasePrompt').value.trim();
      if (!prompt) { errEl.textContent = 'Prompt is required'; errEl.classList.remove('hidden'); return; }

      const isNoTool = document.getElementById('teCaseNoTool').checked;
      let expected_tool = null;
      if (!isNoTool) {
        const toolVal = document.getElementById('teCaseExpTool').value.trim();
        if (!toolVal) { errEl.textContent = 'Expected tool is required (or check "No tool expected")'; errEl.classList.remove('hidden'); return; }
        if (toolVal.includes(',')) {
          expected_tool = toolVal.split(',').map(s => s.trim()).filter(Boolean);
          if (!expected_tool.length) { errEl.textContent = 'Enter at least one tool name'; errEl.classList.remove('hidden'); return; }
        } else {
          expected_tool = toolVal;
        }
      }

      let expected_params = null;
      const paramsStr = document.getElementById('teCaseExpParams').value.trim();
      if (paramsStr) {
        try {
          expected_params = JSON.parse(paramsStr);
          if (typeof expected_params !== 'object' || Array.isArray(expected_params)) {
            errEl.textContent = 'Expected params must be a JSON object';
            errEl.classList.remove('hidden');
            return;
          }
        } catch (e) {
          errEl.textContent = 'Invalid JSON in expected params: ' + e.message;
          errEl.classList.remove('hidden');
          return;
        }
      }
      errEl.classList.add('hidden');

      const caseData = { prompt, expected_tool, expected_params };

      try {
        if (teEditingCaseId) {
          // Update existing
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}/cases/${teEditingCaseId}`, {
            method: 'PUT',
            body: JSON.stringify(caseData),
          });
          if (!res.ok) { showToast('Failed to save', 'error'); return; }
        } else {
          // Create new
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}/cases`, {
            method: 'POST',
            body: JSON.stringify(caseData),
          });
          if (!res.ok) { showToast('Failed to save', 'error'); return; }
        }
        // Reload suite to get updated case list
        await teOpenSuite(teCurrentSuite.id);
        teCancelCaseEdit();
        showToast('Test case saved', 'success');
      } catch { showToast('Failed to save test case', 'error'); }
    }

    function teDeleteCase(caseId) {
      showModal('Delete Test Case', 'Delete this test case?', async () => {
        try {
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}/cases/${caseId}`, { method: 'DELETE' });
          if (!res.ok) { showToast('Failed to delete', 'error'); return; }
          await teOpenSuite(teCurrentSuite.id);
          showToast('Test case deleted', 'success');
        } catch { showToast('Failed to delete', 'error'); }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    function teImportCasesJson() {
      const overlay = document.createElement('div');
      overlay.className = 'modal-overlay';
      overlay.innerHTML = `<div class="modal-box" style="max-width:600px;">
        <div class="modal-title">Import Test Cases (JSON)</div>
        <div class="modal-message">Paste a JSON array of test cases. Each must have "prompt" and "expected_tool" fields.</div>
        <textarea class="modal-input font-mono text-xs" style="height:200px;resize:vertical;margin-bottom:16px;" placeholder='[{"prompt":"...","expected_tool":"...","expected_params":{...}}]'></textarea>
        <div class="text-xs mb-3" style="color:var(--coral);display:none;" id="teImportErr"></div>
        <div class="modal-buttons">
          <button class="modal-btn modal-btn-cancel" data-action="cancel">Cancel</button>
          <button class="modal-btn modal-btn-confirm" data-action="confirm">Import</button>
        </div>
      </div>`;
      const textarea = overlay.querySelector('textarea');
      overlay.querySelector('[data-action="cancel"]').onclick = () => _closeModal(overlay);
      overlay.querySelector('[data-action="confirm"]').onclick = async () => {
        const errEl = overlay.querySelector('#teImportErr');
        let cases;
        try {
          cases = JSON.parse(textarea.value.trim());
        } catch (e) {
          errEl.textContent = 'Invalid JSON: ' + e.message;
          errEl.style.display = 'block';
          return;
        }
        if (!Array.isArray(cases) || !cases.length) {
          errEl.textContent = 'Must be a non-empty JSON array';
          errEl.style.display = 'block';
          return;
        }
        for (let i = 0; i < cases.length; i++) {
          if (!cases[i].prompt) {
            errEl.textContent = `Case ${i+1}: "prompt" is required`;
            errEl.style.display = 'block';
            return;
          }
        }
        try {
          const res = await apiFetch(`/api/tool-suites/${teCurrentSuite.id}/cases`, {
            method: 'POST',
            body: JSON.stringify({ cases }),
          });
          if (!res.ok) { showToast('Import failed', 'error'); return; }
          _closeModal(overlay);
          await teOpenSuite(teCurrentSuite.id);
          showToast(`Imported ${cases.length} test cases`, 'success');
        } catch { showToast('Import failed', 'error'); }
      };
      overlay.onclick = (e) => { if (e.target === overlay) _closeModal(overlay); };
      document.body.appendChild(overlay);
      setTimeout(() => textarea.focus(), 50);
    }

    // --- Run Eval ---
    function teStartRunFromEditor() {
      if (!teCurrentSuite) return;
      const cases = teCurrentSuite.test_cases || [];
      if (!cases.length) { showToast('Add at least one test case first', 'error'); return; }
      const tools = teCurrentSuite.tools || [];
      if (!tools.length) { showToast('Add at least one tool first', 'error'); return; }
      teRunSuiteId = teCurrentSuite.id;
      document.getElementById('teRunTitle').textContent = 'Run Eval: ' + (teCurrentSuite.name || 'Untitled');
      teRenderEvalModelGrid();
      _teResetRunView();
      showToolEvalView('run');
    }

    function teBackFromRun() {
      if (teRunSuiteId && teCurrentSuite?.id === teRunSuiteId) {
        showToolEvalView('editor');
      } else {
        showToolEvalView('suites');
      }
    }

    function teRenderEvalModelGrid() {
      const grid = document.getElementById('teModelGrid');
      grid.innerHTML = '';
      teSelectedModels.clear();
      if (!config || !config.providers) return;

      for (const [provider, provData] of Object.entries(config.providers)) {
        const color = getColor(provider);
        const models = getProviderModels(provData);
        if (!models.length) continue;

        const group = document.createElement('div');
        group.className = 'provider-group';
        group.style.borderColor = color.border;

        const header = document.createElement('div');
        header.className = 'provider-group-header';
        header.innerHTML = `
          <div class="provider-group-dot" style="background:${color.text}"></div>
          <span class="provider-group-label" style="color:${color.text}">${provider}</span>
          <span class="provider-group-count">${models.length}</span>
        `;
        header.onclick = () => {
          const cards = group.querySelectorAll('.model-card');
          const allSel = [...cards].every(c => c.classList.contains('selected'));
          cards.forEach(c => {
            if (allSel) { teSelectedModels.delete(c.dataset.modelId); c.classList.remove('selected'); }
            else { teSelectedModels.add(c.dataset.modelId); c.classList.add('selected'); }
          });
        };
        group.appendChild(header);

        const subgrid = document.createElement('div');
        subgrid.className = 'grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2 pl-3';
        for (const m of models) {
          const card = document.createElement('div');
          card.className = 'model-card rounded-sm px-4 py-3 flex items-center gap-3';
          card.dataset.modelId = m.model_id;
          card.onclick = (e) => {
            e.stopPropagation();
            if (teSelectedModels.has(m.model_id)) {
              teSelectedModels.delete(m.model_id);
              card.classList.remove('selected');
            } else {
              teSelectedModels.add(m.model_id);
              card.classList.add('selected');
            }
          };
          card.innerHTML = `
            <div class="check-dot flex-shrink-0"></div>
            <div class="flex-1 min-w-0">
              <div class="text-[13px] font-medium text-zinc-200 truncate font-body">${m.display_name}</div>
            </div>
          `;
          subgrid.appendChild(card);
        }
        group.appendChild(subgrid);
        grid.appendChild(group);
      }
    }

    function teSelectAllModels() {
      document.querySelectorAll('#teModelGrid .model-card').forEach(c => {
        teSelectedModels.add(c.dataset.modelId);
        c.classList.add('selected');
      });
    }

    function teClearModels() {
      teSelectedModels.clear();
      document.querySelectorAll('#teModelGrid .model-card').forEach(c => c.classList.remove('selected'));
    }

    function _teResetRunView() {
      teEvalResults = [];
      teEvalSummaries = [];
      document.getElementById('teProgressSection').classList.add('hidden');
      document.getElementById('teSummarySection').classList.add('hidden');
      document.getElementById('teDetailSection').classList.add('hidden');
      document.getElementById('teLiveSection').classList.add('hidden');
      document.getElementById('teSSEBanner').classList.add('hidden');
      document.getElementById('teLiveBody').innerHTML = '';
      document.getElementById('teSummaryBody').innerHTML = '';
      document.getElementById('teStartBtn').disabled = false;
      document.getElementById('teStartBtn').innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Start Eval';
      document.getElementById('teCancelEvalBtn').classList.add('hidden');
      document.getElementById('teExportBtn').classList.add('hidden');
      window.teLastEvalId = null;
    }

    async function teStartEval() {
      if (teSelectedModels.size === 0) { showToast('Select at least one model', 'error'); return; }
      if (!teRunSuiteId) { showToast('No suite selected', 'error'); return; }

      const btn = document.getElementById('teStartBtn');
      btn.disabled = true;
      btn.innerHTML = '<svg class="w-3.5 h-3.5 animate-spin" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z"/></svg> Running...';
      document.getElementById('teCancelEvalBtn').classList.remove('hidden');

      teEvalResults = [];
      teEvalSummaries = [];
      document.getElementById('teLiveBody').innerHTML = '';
      document.getElementById('teSummaryBody').innerHTML = '';
      document.getElementById('teProgressSection').classList.remove('hidden');
      document.getElementById('teLiveSection').classList.remove('hidden');
      document.getElementById('teSummarySection').classList.add('hidden');
      document.getElementById('teDetailSection').classList.add('hidden');
      document.getElementById('teSSEBanner').classList.add('hidden');
      document.getElementById('teProgressBar').style.width = '0%';
      document.getElementById('teProgressLabel').textContent = 'Initializing...';
      document.getElementById('teProgressCount').textContent = '0/0';

      const body = {
        suite_id: teRunSuiteId,
        models: Array.from(teSelectedModels),
        temperature: parseFloat(document.getElementById('teTemperature').value) || 0.0,
        tool_choice: document.getElementById('teToolChoice').value,
      };

      try {
        const res = await apiFetch('/api/tool-eval', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body),
        });

        if (res.status === 409) {
          showToast('A benchmark or eval is already running', 'error');
          _teResetStartBtn();
          return;
        }
        if (!res.ok) {
          const err = await res.json().catch(() => ({}));
          showToast(err.error || `Server error (${res.status})`, 'error');
          _teResetStartBtn();
          return;
        }

        const reader = res.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        const resetTimeout = () => {
          if (_teSSETimeout) clearTimeout(_teSSETimeout);
          _teSSETimeout = setTimeout(() => {
            _teShowSSEError('Connection lost - no data received for 30 seconds');
            _teResetStartBtn();
          }, 30000);
        };
        resetTimeout();

        while (true) {
          const { done, value } = await reader.read();
          if (done) break;
          resetTimeout();
          buffer += decoder.decode(value, { stream: true });

          const lines = buffer.split('\n');
          buffer = lines.pop();

          for (const line of lines) {
            if (line.startsWith('data: ')) {
              try { _teHandleSSE(JSON.parse(line.slice(6))); } catch (e) {}
            }
          }
        }
        if (_teSSETimeout) clearTimeout(_teSSETimeout);
      } catch (e) {
        console.error('Eval error:', e);
        _teShowSSEError('Connection error: ' + (e.message || 'Network failure'));
      }

      _teResetStartBtn();
    }

    function _teResetStartBtn() {
      const btn = document.getElementById('teStartBtn');
      btn.disabled = false;
      btn.innerHTML = '<svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" stroke-width="2.5" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg> Start Eval';
      document.getElementById('teCancelEvalBtn').classList.add('hidden');
    }

    function _teShowSSEError(msg) {
      const banner = document.getElementById('teSSEBanner');
      document.getElementById('teSSEBannerMsg').textContent = msg;
      banner.classList.remove('hidden');
    }

    async function teCancelEval() {
      try {
        await apiFetch('/api/tool-eval/cancel', { method: 'POST' });
        showToast('Cancellation requested...', '');
      } catch { showToast('Failed to cancel', 'error'); }
    }

    function _teHandleSSE(data) {
      if (data.type === 'progress') {
        const pct = data.total > 0 ? Math.round((data.current / data.total) * 100) : 0;
        document.getElementById('teProgressBar').style.width = pct + '%';
        document.getElementById('teProgressCount').textContent = `${data.current}/${data.total}`;
        document.getElementById('teProgressLabel').textContent = `Testing ${data.model || ''}...`;
      }

      if (data.type === 'result') {
        teEvalResults.push(data);
        _teAddLiveRow(data);
      }

      if (data.type === 'model_summary') {
        teEvalSummaries.push(data);
        teRenderSummaryTable();
        document.getElementById('teSummarySection').classList.remove('hidden');
      }

      if (data.type === 'complete') {
        document.getElementById('teProgressLabel').textContent = 'Complete!';
        document.getElementById('teProgressBar').style.width = '100%';
        const total = teEvalResults.length;
        const models = teEvalSummaries.length;
        document.getElementById('teSummaryInfo').textContent = `${total} evaluations across ${models} model${models > 1 ? 's' : ''}`;
        if (data.eval_id) {
          window.teLastEvalId = data.eval_id;
          document.getElementById('teExportBtn').classList.remove('hidden');
        }
        showToast('Eval complete!', 'success');
        // Refresh history
        teLoadHistory();
      }

      if (data.type === 'cancelled') {
        document.getElementById('teProgressLabel').textContent = 'Cancelled';
        showToast('Eval cancelled', '');
      }

      if (data.type === 'error') {
        _teShowSSEError(data.message || 'Unknown error');
      }

      // heartbeat: just resets timeout (handled in resetTimeout)
    }

    function _teScoreColor(pct) {
      if (pct >= 80) return 'var(--lime)';
      if (pct >= 50) return '#FBBF24';
      return 'var(--coral)';
    }

    function _teAddLiveRow(r) {
      const body = document.getElementById('teLiveBody');
      const overallPct = (r.overall_score * 100).toFixed(0);
      const color = _teScoreColor(r.overall_score * 100);
      const actualTool = r.actual_tool || '(none)';
      const expectedTool = r.expected_tool || '(none)';
      const prompt = _teTruncate(r.prompt || r.test_case_id || '', 40);
      body.insertAdjacentHTML('beforeend', `<tr>
        <td class="px-5 py-2 text-xs font-mono text-zinc-300">${_teEsc(r.model_name || r.model_id || '')}</td>
        <td class="px-5 py-2 text-xs font-body text-zinc-400">${_teEsc(prompt)}</td>
        <td class="px-5 py-2 text-xs font-mono text-zinc-500">${_teEsc(typeof expectedTool === 'object' ? JSON.stringify(expectedTool) : expectedTool)}</td>
        <td class="px-5 py-2 text-xs font-mono" style="color:${r.success !== false ? 'var(--lime)' : 'var(--coral)'}">${_teEsc(actualTool)}</td>
        <td class="px-5 py-2 text-right text-xs font-mono font-bold" style="color:${color}">${overallPct}%</td>
      </tr>`);
      // Auto-scroll
      const liveDiv = document.getElementById('teLiveResults');
      liveDiv.scrollTop = liveDiv.scrollHeight;
    }

    function teRenderSummaryTable() {
      const sorted = [...teEvalSummaries].sort((a, b) => {
        const aVal = a[teSummarySortKey] ?? 0;
        const bVal = b[teSummarySortKey] ?? 0;
        if (typeof aVal === 'string') return teSummarySortAsc ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
        return teSummarySortAsc ? aVal - bVal : bVal - aVal;
      });

      const body = document.getElementById('teSummaryBody');
      body.innerHTML = sorted.map(s => {
        const toolColor = _teScoreColor(s.tool_accuracy_pct);
        const paramColor = _teScoreColor(s.param_accuracy_pct ?? 0);
        const overallColor = _teScoreColor(s.overall_pct);
        return `<tr class="cursor-pointer" onclick="teShowModelDetail('${_teEsc(s.model_id)}')">
          <td class="px-5 py-3 text-sm font-body text-zinc-200">${_teEsc(s.model_name || s.model_id)}</td>
          <td class="px-5 py-3 text-right text-sm font-mono font-bold" style="color:${toolColor}">${(s.tool_accuracy_pct ?? 0).toFixed(1)}%</td>
          <td class="px-5 py-3 text-right text-sm font-mono font-bold" style="color:${paramColor}">${s.param_accuracy_pct != null ? s.param_accuracy_pct.toFixed(1) + '%' : '-'}</td>
          <td class="px-5 py-3 text-right text-sm font-mono font-bold" style="color:${overallColor}">${(s.overall_pct ?? 0).toFixed(1)}%</td>
          <td class="px-5 py-3 text-right text-xs font-mono text-zinc-500">${s.cases_run || 0}</td>
        </tr>`;
      }).join('');
    }

    function teSortSummary(key) {
      if (teSummarySortKey === key) {
        teSummarySortAsc = !teSummarySortAsc;
      } else {
        teSummarySortKey = key;
        teSummarySortAsc = key === 'model_name';
      }
      teRenderSummaryTable();
    }

    function teShowModelDetail(modelId) {
      const results = teEvalResults.filter(r => r.model_id === modelId);
      if (!results.length) return;
      const content = document.getElementById('teDetailContent');
      const modelName = results[0].model_name || modelId;
      content.innerHTML = `<div class="text-sm font-display font-semibold text-zinc-200 tracking-wider uppercase mb-3">${_teEsc(modelName)}</div>` +
        results.map((r, i) => {
          const expTool = r.expected_tool;
          let expStr;
          if (expTool === null || expTool === undefined) expStr = '(no tool call)';
          else if (Array.isArray(expTool)) expStr = expTool.join(' | ');
          else expStr = expTool;

          const actTool = r.actual_tool || '(no tool call)';
          const expParams = r.expected_params ? JSON.stringify(r.expected_params) : '';
          const actParams = r.actual_params ? JSON.stringify(r.actual_params) : '';
          const match = r.tool_selection_score === 1.0;
          const icon = match ? '<span style="color:var(--lime)">OK</span>' : '<span style="color:var(--coral)">X</span>';

          const hasRaw = r.raw_request || r.raw_response;
          const rawSection = hasRaw ? `
            <div class="mt-2">
              <button onclick="this.nextElementSibling.classList.toggle('hidden')"
                class="text-[10px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm"
                style="color:var(--lime);border:1px solid rgba(191,255,0,0.15)">VIEW RAW</button>
              <div class="hidden mt-2" style="max-height:400px;overflow-y:auto">
                ${r.raw_request ? `<div class="mb-2">
                  <div class="text-[10px] font-display tracking-wider text-zinc-500 uppercase mb-1">Request</div>
                  <pre class="text-[10px] font-mono text-zinc-400 p-2 rounded-sm overflow-x-auto" style="background:rgba(0,0,0,0.3);border:1px solid var(--border-subtle);white-space:pre-wrap;word-break:break-all">${_teEsc(JSON.stringify(r.raw_request, null, 2))}</pre>
                </div>` : ''}
                ${r.raw_response ? `<div>
                  <div class="text-[10px] font-display tracking-wider text-zinc-500 uppercase mb-1">Response</div>
                  <pre class="text-[10px] font-mono text-zinc-400 p-2 rounded-sm overflow-x-auto" style="background:rgba(0,0,0,0.3);border:1px solid var(--border-subtle);white-space:pre-wrap;word-break:break-all">${_teEsc(JSON.stringify(r.raw_response, null, 2))}</pre>
                </div>` : ''}
              </div>
            </div>` : '';

          return `<div class="px-3 py-2 rounded-sm text-xs" style="background:rgba(255,255,255,0.02);border:1px solid var(--border-subtle);">
            <div class="text-zinc-300 font-body mb-1">#${i+1} "${_teEsc(_teTruncate(r.prompt || '', 80))}"</div>
            <div class="font-mono text-zinc-500">Expected: ${_teEsc(expStr)}${expParams ? '(' + _teEsc(expParams) + ')' : ''}</div>
            <div class="font-mono" style="color:${match ? 'var(--lime)' : 'var(--coral)'}">Actual: &nbsp; ${_teEsc(actTool)}${actParams ? '(' + _teEsc(actParams) + ')' : ''} ${icon}</div>
            ${r.error ? '<div style="color:var(--coral)">Error: ' + _teEsc(r.error) + '</div>' : ''}
            ${rawSection}
          </div>`;
        }).join('');
      document.getElementById('teDetailSection').classList.remove('hidden');
    }

    // --- Eval History ---
    async function teLoadHistory() {
      try {
        const res = await apiFetch('/api/tool-eval/history');
        if (!res.ok) return;
        const data = await res.json();
        teEvalHistory = data.runs || [];
        teRenderHistory();
      } catch {}
    }

    function teRenderHistory() {
      const body = document.getElementById('teHistoryBody');
      if (!teEvalHistory.length) {
        body.innerHTML = '<tr><td colspan="5" class="px-5 py-8 text-center text-zinc-600 text-sm font-body">No eval runs yet.</td></tr>';
        return;
      }
      body.innerHTML = teEvalHistory.map(r => {
        const models = r.models_json ? (typeof r.models_json === 'string' ? JSON.parse(r.models_json) : r.models_json) : [];
        const summaries = r.summary_json ? (typeof r.summary_json === 'string' ? JSON.parse(r.summary_json) : r.summary_json) : [];
        const avgOverall = summaries.length > 0 ? (summaries.reduce((s, x) => s + (x.overall_pct || 0), 0) / summaries.length).toFixed(1) : '-';
        const overallColor = avgOverall !== '-' ? _teScoreColor(parseFloat(avgOverall)) : '#85858F';
        const ts = _teTimeAgo(r.timestamp);
        const modelStr = models.length <= 2 ? models.join(', ') : models.length + ' models';
        return `<tr>
          <td class="px-5 py-3 text-xs text-zinc-500 font-body">${ts}</td>
          <td class="px-5 py-3 text-sm font-body text-zinc-300">${_teEsc(r.suite_name || '')}</td>
          <td class="px-5 py-3 text-xs font-mono text-zinc-500">${_teEsc(modelStr)}</td>
          <td class="px-5 py-3 text-right text-sm font-mono font-bold" style="color:${overallColor}">${avgOverall}${avgOverall !== '-' ? '%' : ''}</td>
          <td class="px-5 py-3 text-right">
            <button onclick="teViewHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 mr-2">View</button>
            <button onclick="teExportResults('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-500 hover:text-zinc-300 mr-2" style="color:var(--lime);opacity:0.6" onmouseover="this.style.opacity='1'" onmouseout="this.style.opacity='0.6'">Export</button>
            <button onclick="teDeleteHistoryRun('${r.id}')" class="text-[10px] font-display tracking-wider uppercase text-zinc-700 hover:text-red-400">Delete</button>
          </td>
        </tr>`;
      }).join('');
    }

    async function teViewHistoryRun(runId) {
      try {
        const res = await apiFetch(`/api/tool-eval/history/${runId}`);
        if (!res.ok) { showToast('Failed to load run details', 'error'); return; }
        const run = await res.json();

        // Parse stored JSON fields
        const results = typeof run.results_json === 'string' ? JSON.parse(run.results_json) : (run.results_json || []);
        const summaries = typeof run.summary_json === 'string' ? JSON.parse(run.summary_json) : (run.summary_json || []);

        // Populate run view with historical data
        teRunSuiteId = run.suite_id;
        document.getElementById('teRunTitle').textContent = 'History: ' + (run.suite_name || 'Untitled');
        teRenderEvalModelGrid();
        _teResetRunView();

        // Populate results
        teEvalResults = results;
        teEvalSummaries = summaries;

        // Show summary
        teRenderSummaryTable();
        document.getElementById('teSummarySection').classList.remove('hidden');
        const total = results.length;
        const models = summaries.length;
        document.getElementById('teSummaryInfo').textContent = `${total} evaluations across ${models} model${models > 1 ? 's' : ''}`;

        // Enable export for this history run
        window.teLastEvalId = runId;
        document.getElementById('teExportBtn').classList.remove('hidden');

        // Show live results
        document.getElementById('teLiveSection').classList.remove('hidden');
        const liveBody = document.getElementById('teLiveBody');
        liveBody.innerHTML = '';
        results.forEach(r => _teAddLiveRow(r));

        showToolEvalView('run');
      } catch (e) {
        showToast('Failed to load run', 'error');
      }
    }

    function teDeleteHistoryRun(runId) {
      showModal('Delete Eval Run', 'Delete this eval run? This cannot be undone.', async () => {
        try {
          const res = await apiFetch(`/api/tool-eval/history/${runId}`, { method: 'DELETE' });
          if (!res.ok) { showToast('Failed to delete', 'error'); return; }
          showToast('Eval run deleted', 'success');
          await teLoadHistory();
        } catch { showToast('Failed to delete', 'error'); }
      }, { danger: true, confirmLabel: 'Delete' });
    }

    async function teExportResults(evalId) {
      const id = evalId || window.teLastEvalId;
      if (!id) return;
      try {
        const res = await apiFetch('/api/export/eval/' + id);
        if (!res.ok) { showToast('Export failed', 'error'); return; }
        const data = await res.json();
        const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'eval-' + id.slice(0, 8) + '.json';
        a.click();
        URL.revokeObjectURL(url);
        showToast('Eval results exported');
      } catch (e) { showToast('Export failed', 'error'); }
    }

    // --- Settings Export / Import ---
    async function exportSettings() {
      try {
        const res = await apiFetch('/api/export/settings');
        if (!res.ok) { showToast('Export failed: ' + (await res.text()), 'error'); return; }
        const disposition = res.headers.get('Content-Disposition');
        let filename = 'benchmark-settings.json';
        if (disposition) {
          const match = disposition.match(/filename="?([^";\s]+)"?/);
          if (match) filename = match[1];
        }
        const blob = await res.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('Settings exported', 'success');
      } catch (e) {
        showToast('Export failed', 'error');
      }
    }

    function importSettings() {
      const input = document.createElement('input');
      input.type = 'file';
      input.accept = '.json';
      input.style.display = 'none';
      input.onchange = async () => {
        const file = input.files[0];
        if (!file) return;
        try {
          const text = await file.text();
          const data = JSON.parse(text);
          if (!data.export_version) {
            showToast('Invalid settings file: missing export_version', 'error');
            return;
          }
          const providerCount = data.providers ? Object.keys(data.providers).length : 0;
          showModal('Import Settings',
            `Import ${providerCount} provider${providerCount !== 1 ? 's' : ''}? This will merge with your existing settings.`,
            async () => {
              try {
                const res = await apiFetch('/api/import/settings', {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify(data)
                });
                if (!res.ok) {
                  const err = await res.json().catch(() => ({}));
                  showToast(err.detail || 'Import failed', 'error');
                  return;
                }
                showToast('Settings imported successfully', 'success');
                await refreshConfig();
                renderSettings();
              } catch (e) {
                showToast('Import failed: ' + e.message, 'error');
              }
            },
            { confirmLabel: 'Import' }
          );
        } catch (e) {
          showToast('Invalid JSON file', 'error');
        }
        input.remove();
      };
      document.body.appendChild(input);
      input.click();
    }

    // --- Export CSV ---
    async function downloadCSV(url, filename) {
      const token = localStorage.getItem('auth_token');
      try {
        const resp = await fetch(url, { headers: { 'Authorization': 'Bearer ' + token } });
        if (!resp.ok) { showToast('Export failed', 'error'); return; }
        const blob = await resp.blob();
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = filename;
        a.click();
        URL.revokeObjectURL(a.href);
        showToast('CSV exported', 'success');
      } catch (e) {
        showToast('Export failed', 'error');
      }
    }

    // --- Onboarding Wizard ---
    let onbSelectedProvider = null;

    function showOnboardingWizard() {
      const overlay = document.getElementById('onboarding-overlay');
      overlay.style.display = 'flex';
      onbSelectedProvider = null;
      document.getElementById('onb-key-input-area').style.display = 'none';
      document.getElementById('onb-custom-area').style.display = 'none';
      document.querySelectorAll('.onb-provider-card').forEach(c => {
        c.style.borderColor = 'var(--border-subtle)';
        c.style.background = 'var(--surface)';
      });
    }

    function onbSelectProvider(provider, keyEnv, providerKey, cardEl) {
      onbSelectedProvider = provider;
      // Reset all cards
      document.querySelectorAll('.onb-provider-card').forEach(c => {
        c.style.borderColor = 'var(--border-subtle)';
        c.style.background = 'var(--surface)';
      });
      // Highlight selected
      cardEl.style.borderColor = 'var(--lime)';
      cardEl.style.background = 'var(--lime-dim)';

      if (provider === 'custom') {
        document.getElementById('onb-key-input-area').style.display = 'none';
        document.getElementById('onb-custom-area').style.display = 'block';
      } else {
        document.getElementById('onb-custom-area').style.display = 'none';
        const area = document.getElementById('onb-key-input-area');
        area.style.display = 'block';
        document.getElementById('onb-key-label').textContent = keyEnv;
        document.getElementById('onb-key-input').value = '';
        document.getElementById('onb-key-input').placeholder = 'Paste your ' + provider + ' API key';
        document.getElementById('onb-key-input').dataset.keyEnv = keyEnv;
        document.getElementById('onb-key-input').dataset.providerKey = providerKey;
        document.getElementById('onb-key-save-status').textContent = '';
      }
    }

    async function onbSaveKey() {
      const input = document.getElementById('onb-key-input');
      const providerKey = input.dataset.providerKey;
      const keyVal = input.value.trim();
      const status = document.getElementById('onb-key-save-status');
      if (!keyVal) { status.textContent = 'Please enter a key'; status.style.color = 'var(--coral)'; return; }
      try {
        const res = await apiFetch('/api/keys', {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ provider_key: providerKey, value: keyVal })
        });
        if (res.ok) {
          status.textContent = 'Saved!';
          status.style.color = 'var(--lime)';
        } else {
          const data = await res.json().catch(() => ({}));
          status.textContent = data.detail || 'Failed to save';
          status.style.color = 'var(--coral)';
        }
      } catch {
        status.textContent = 'Connection error';
        status.style.color = 'var(--coral)';
      }
    }

    function onbNext(step) {
      document.getElementById('onb-step-1').style.display = 'none';
      document.getElementById('onb-step-2').style.display = 'none';
      document.getElementById('onb-step-3').style.display = 'none';
      document.getElementById('onb-step-' + step).style.display = 'block';
    }

    function onbSkip() { onbComplete(); }

    async function onbComplete() {
      const token = localStorage.getItem('auth_token');
      try {
        await fetch('/api/onboarding/complete', { method: 'POST', headers: { 'Authorization': 'Bearer ' + token } });
      } catch {}
      document.getElementById('onboarding-overlay').style.display = 'none';
    }

    async function checkOnboarding() {
      try {
        const token = localStorage.getItem('auth_token');
        const res = await fetch('/api/onboarding/status', { headers: { 'Authorization': 'Bearer ' + token } });
        if (!res.ok) return;
        const data = await res.json();
        if (!data.completed) showOnboardingWizard();
      } catch {}
    }

    // --- Landing page functions ---
    function showLandingPage() {
      document.getElementById('landingPage').style.display = 'block';
      document.getElementById('appHeader').style.display = 'none';
      document.getElementById('appMain').style.display = 'none';
    }

    function hideLandingPage() {
      document.getElementById('landingPage').style.display = 'none';
      document.getElementById('appHeader').style.display = '';
      document.getElementById('appMain').style.display = '';
    }

    // --- Auth functions ---
    let authMode = 'login';

    function showAuthModal() {
      document.getElementById('authModal').style.display = 'flex';
      document.getElementById('authEmail').focus();
    }

    function hideAuthModal() {
      document.getElementById('authModal').style.display = 'none';
      document.getElementById('authError').style.display = 'none';
    }

    function switchAuthTab(mode) {
      authMode = mode;
      document.getElementById('authTabLogin').classList.toggle('tab-active', mode === 'login');
      document.getElementById('authTabRegister').classList.toggle('tab-active', mode === 'register');
      document.getElementById('authSubmitBtn').textContent = mode === 'login' ? 'Login' : 'Create Account';
      document.getElementById('authError').style.display = 'none';
    }

    async function handleAuth(e) {
      e.preventDefault();
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      const endpoint = authMode === 'login' ? '/api/auth/login' : '/api/auth/register';

      try {
        const res = await fetch(endpoint, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ email, password }),
        });
        const data = await res.json();
        if (!res.ok) {
          document.getElementById('authError').textContent = data.error || 'Authentication failed';
          document.getElementById('authError').style.display = 'block';
          return;
        }
        authToken = data.access_token;
        currentUser = data.user;
        localStorage.setItem('auth_token', authToken);
        updateAuthUI();
        hideAuthModal();
        hideLandingPage();
        init();
        checkOnboarding();
      } catch (err) {
        document.getElementById('authError').textContent = 'Connection error';
        document.getElementById('authError').style.display = 'block';
      }
    }

    async function handleLogout() {
      await fetch('/api/auth/logout', { method: 'POST', credentials: 'include' });
      authToken = null;
      currentUser = null;
      localStorage.removeItem('auth_token');
      updateAuthUI();
      showLandingPage();
    }

    function updateAuthUI() {
      const menu = document.getElementById('userMenu');
      const adminTab = document.getElementById('tab-admin');
      if (currentUser) {
        menu.style.display = 'flex';
        document.getElementById('userEmail').textContent = currentUser.email;
        adminTab.style.display = currentUser.role === 'admin' ? '' : 'none';
      } else {
        menu.style.display = 'none';
        adminTab.style.display = 'none';
      }
    }

    // -------------------------------------------------------------------
    // Boot: check auth state before loading app
    // -------------------------------------------------------------------
    (async () => {
      if (authToken) {
        try {
          const res = await apiFetch('/api/auth/me');
          if (res.ok) {
            const data = await res.json();
            currentUser = data.user;
            updateAuthUI();
            hideLandingPage();
            init();
            loadPromptTemplates();
            return;
          }
        } catch {}
      }
      const refreshed = await tryRefreshToken();
      if (refreshed) {
        hideLandingPage();
        init();
        loadPromptTemplates();
      } else {
        showLandingPage();
      }
    })();

    // Fetch and display app version (unauthenticated)
    fetch('/healthz').then(r => r.json()).then(d => {
      const v = d.version || '';
      if (v) {
        const label = 'v' + v;
        const el = document.getElementById('app-version');
        if (el) el.textContent = 'LLM Benchmark Studio ' + label;
        const lel = document.getElementById('landing-version');
        if (lel) lel.textContent = label;
      }
    }).catch(() => {});
  </script>

  <!-- Onboarding Wizard Modal -->
  <div id="onboarding-overlay" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:10000; align-items:center; justify-content:center;">
    <div style="background:var(--surface); border:1px solid var(--border); border-radius:12px; padding:40px; max-width:600px; width:90%; color:#e0e0e0;">
      <div id="onb-step-1">
        <h2 style="color:var(--lime); margin-top:0; font-family:'Chakra Petch',sans-serif; font-size:22px; font-weight:700;">Welcome to Benchmark Studio!</h2>
        <p style="font-family:'Outfit',sans-serif; color:#A1A1AA; margin-bottom:20px;">Let's get you set up in 3 quick steps.</p>
        <h3 style="font-family:'Chakra Petch',sans-serif; font-size:14px; font-weight:600; color:#e0e0e0; text-transform:uppercase; letter-spacing:0.05em;">Step 1 of 3: Choose Your Provider</h3>
        <p style="color:#85858F; font-size:13px; font-family:'Outfit',sans-serif;">Pick a provider to get started. You can add more later in Settings.</p>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin:16px 0;">
          <div class="onb-provider-card" onclick="onbSelectProvider('OpenAI','OPENAI_API_KEY','openai',this)" style="border:1px solid var(--border-subtle); background:var(--surface); border-radius:8px; padding:14px; cursor:pointer; transition:all 0.15s;">
            <div style="font-weight:600; color:#e0e0e0; font-size:14px; font-family:'Outfit',sans-serif;">OpenAI</div>
            <div style="color:#85858F; font-size:12px; font-family:'Outfit',sans-serif; margin-top:4px;">GPT models (gpt-5, gpt-5-nano)</div>
          </div>
          <div class="onb-provider-card" onclick="onbSelectProvider('Anthropic','ANTHROPIC_API_KEY','anthropic',this)" style="border:1px solid var(--border-subtle); background:var(--surface); border-radius:8px; padding:14px; cursor:pointer; transition:all 0.15s;">
            <div style="font-weight:600; color:#e0e0e0; font-size:14px; font-family:'Outfit',sans-serif;">Anthropic</div>
            <div style="color:#85858F; font-size:12px; font-family:'Outfit',sans-serif; margin-top:4px;">Claude models (Sonnet, Haiku)</div>
          </div>
          <div class="onb-provider-card" onclick="onbSelectProvider('Google Gemini','GEMINI_API_KEY','google_gemini',this)" style="border:1px solid var(--border-subtle); background:var(--surface); border-radius:8px; padding:14px; cursor:pointer; transition:all 0.15s;">
            <div style="font-weight:600; color:#e0e0e0; font-size:14px; font-family:'Outfit',sans-serif;">Google Gemini</div>
            <div style="color:#85858F; font-size:12px; font-family:'Outfit',sans-serif; margin-top:4px;">Gemini models</div>
          </div>
          <div class="onb-provider-card" onclick="onbSelectProvider('custom','','',this)" style="border:1px solid var(--border-subtle); background:var(--surface); border-radius:8px; padding:14px; cursor:pointer; transition:all 0.15s;">
            <div style="font-weight:600; color:#e0e0e0; font-size:14px; font-family:'Outfit',sans-serif;">Custom</div>
            <div style="color:#85858F; font-size:12px; font-family:'Outfit',sans-serif; margin-top:4px;">Other provider or self-hosted</div>
          </div>
        </div>

        <!-- API key input (shown when OpenAI/Anthropic/Gemini selected) -->
        <div id="onb-key-input-area" style="display:none; margin:12px 0;">
          <label id="onb-key-label" style="font-size:12px; color:#85858F; font-family:'Outfit',sans-serif; display:block; margin-bottom:6px;"></label>
          <div style="display:flex; gap:8px;">
            <input id="onb-key-input" type="password" placeholder="" style="flex:1; padding:8px 12px; border-radius:6px; border:1px solid var(--border-subtle); background:rgba(255,255,255,0.03); color:#e0e0e0; font-family:'Space Mono',monospace; font-size:13px; outline:none;" />
            <button onclick="onbSaveKey()" style="background:var(--lime); color:#000; border:none; padding:8px 16px; border-radius:6px; cursor:pointer; font-weight:bold; font-family:'Outfit',sans-serif; font-size:13px; white-space:nowrap;">Save Key</button>
          </div>
          <span id="onb-key-save-status" style="font-size:12px; font-family:'Outfit',sans-serif; margin-top:6px; display:inline-block;"></span>
        </div>

        <!-- Custom provider message -->
        <div id="onb-custom-area" style="display:none; margin:12px 0; padding:12px; border-radius:6px; border:1px solid var(--border-subtle); background:rgba(255,255,255,0.02);">
          <p style="color:#A1A1AA; font-size:13px; font-family:'Outfit',sans-serif; margin:0;">Custom providers can be configured in <strong style="color:#e0e0e0;">Settings</strong> after onboarding. You'll be able to set a provider name, API base URL, API key, and model ID prefix.</p>
        </div>

        <div style="display:flex; justify-content:space-between; margin-top:24px;">
          <button onclick="onbSkip()" style="background:transparent; border:1px solid var(--border); color:#85858F; padding:8px 20px; border-radius:6px; cursor:pointer; font-family:'Outfit',sans-serif;">Skip All</button>
          <button onclick="onbNext(2)" style="background:var(--lime); color:#000; border:none; padding:8px 20px; border-radius:6px; cursor:pointer; font-weight:bold; font-family:'Outfit',sans-serif;">Next Step</button>
        </div>
      </div>
      <div id="onb-step-2" style="display:none;">
        <h2 style="color:var(--lime); margin-top:0; font-family:'Chakra Petch',sans-serif; font-size:22px; font-weight:700;">Step 2 of 3: Quick Test</h2>
        <p style="font-family:'Outfit',sans-serif; color:#A1A1AA;">Want to run a quick benchmark with one model to verify your setup?</p>
        <p style="color:#85858F; font-size:13px; font-family:'Outfit',sans-serif;">This will run a single benchmark with the first available model. Takes about 10 seconds.</p>
        <div style="display:flex; justify-content:space-between; margin-top:24px;">
          <button onclick="onbNext(3)" style="background:transparent; border:1px solid var(--border); color:#85858F; padding:8px 20px; border-radius:6px; cursor:pointer; font-family:'Outfit',sans-serif;">Skip</button>
          <button onclick="onbNext(3)" style="background:var(--lime); color:#000; border:none; padding:8px 20px; border-radius:6px; cursor:pointer; font-weight:bold; font-family:'Outfit',sans-serif;">Next Step</button>
        </div>
      </div>
      <div id="onb-step-3" style="display:none;">
        <h2 style="color:var(--lime); margin-top:0; font-family:'Chakra Petch',sans-serif; font-size:22px; font-weight:700;">You're All Set!</h2>
        <p style="font-family:'Outfit',sans-serif; color:#A1A1AA;">Start exploring:</p>
        <ul style="list-style:none; padding:0; font-family:'Outfit',sans-serif;">
          <li style="margin:8px 0; color:#e0e0e0;"><span style="color:var(--lime);">&#8594;</span> <strong>Benchmark</strong> &mdash; Run speed tests across models</li>
          <li style="margin:8px 0; color:#e0e0e0;"><span style="color:var(--lime);">&#8594;</span> <strong>Analytics</strong> &mdash; Compare models on leaderboard</li>
          <li style="margin:8px 0; color:#e0e0e0;"><span style="color:var(--lime);">&#8594;</span> <strong>Tool Eval</strong> &mdash; Test tool calling accuracy</li>
        </ul>
        <div style="text-align:center; margin-top:24px;">
          <button onclick="onbComplete()" style="background:var(--lime); color:#000; border:none; padding:10px 32px; border-radius:6px; cursor:pointer; font-weight:bold; font-size:16px; font-family:'Outfit',sans-serif;">Let's Go!</button>
        </div>
      </div>
    </div>
  </div>
</body>
</html>
