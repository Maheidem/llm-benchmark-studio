import{S as O,r as l,B as y,s as b}from"./index-Csqbeob9.js";import{u as q}from"./useActiveSession-DdoXJmDo.js";const L=O("promptTuner",()=>{const o=l([]),p=l(null),u=l(0),f=l([]),d=l(null),n=l(null),s=l(!1),a=l({pct:0,detail:"",generation:0,totalGenerations:0}),S=l("quick"),c=l(0),_=l(0),i=q(),j=y(()=>o.value.length===0?null:o.value[o.value.length-1]),E=y(()=>u.value),G=y(()=>o.value.map(e=>({generation:e.generation,bestScore:e.best_score||0}))),g="_prtJobId",h="_prtRunId";function T(){try{n.value&&sessionStorage.setItem(g,n.value),d.value&&sessionStorage.setItem(h,d.value)}catch{}}function I(){try{const e=sessionStorage.getItem(g),t=sessionStorage.getItem(h);e&&(n.value=e,d.value=t,s.value=!0)}catch{}}function m(){try{sessionStorage.removeItem(g),sessionStorage.removeItem(h)}catch{}}async function x(e){o.value=[],p.value=null,u.value=0,_.value=0,c.value=0,a.value={pct:0,detail:"Starting...",generation:0,totalGenerations:0},i.startTracking();const t=await b("/api/tool-eval/prompt-tune",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===409)throw new Error("A job is already running");if(!t.ok){const w=await t.json().catch(()=>({}));throw new Error(w.error||`Server error (${t.status})`)}const r=await t.json();return n.value=r.job_id,s.value=!0,T(),r}async function P(){if(!n.value)return;if(!(await b("/api/tool-eval/prompt-tune/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_id:n.value})})).ok)throw new Error("Failed to cancel")}async function R(e){const t=new URLSearchParams(e).toString(),r=await b(`/api/tool-eval/prompt-tune/estimate?${t}`);if(!r.ok)throw new Error("Failed to get estimate");return await r.json()}async function $(){const e=await b("/api/tool-eval/prompt-tune/history");if(!e.ok)throw new Error("Failed to load history");const t=await e.json();return f.value=t.runs||[],f.value}async function F(e){const t=await b(`/api/tool-eval/prompt-tune/history/${e}`);if(!t.ok)throw new Error("Run not found");const r=await t.json(),w=Array.isArray(r.generations)?r.generations:[];return o.value=w.map(v=>({...v,generation:v.generation_number??v.generation,best_index:v.best_candidate_index??v.best_index,prompts:(v.candidates||v.prompts||[]).map(k=>({...k,text:k.prompt_text??k.text}))})),p.value=r.best_prompt||null,u.value=r.best_score||0,r}async function J(e){if(!(await b(`/api/tool-eval/prompt-tune/history/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete");f.value=f.value.filter(r=>r.id!==e)}function A(e){if(!(e.job_id&&n.value&&e.job_id!==n.value))switch(e.type){case"tune_start":{s.value=!0,d.value=e.tune_id||null,S.value=e.mode||"quick",c.value=e.total_prompts||0,_.value=0,o.value=[],p.value=null,u.value=0,i.startTracking(),a.value={pct:0,detail:`Tuning ${e.suite_name||""}...`,generation:0,totalGenerations:0},T();break}case"generation_start":{a.value={...a.value,detail:`Generation ${e.generation}/${e.total_generations}`,generation:e.generation,totalGenerations:e.total_generations};break}case"prompt_generated":break;case"prompt_eval_start":{i.recordStep(),a.value={...a.value,detail:`Gen ${e.generation}: evaluating prompt ${e.prompt_index+1} on ${e.model}`};break}case"prompt_eval_result":break;case"generation_complete":{const t={generation:e.generation,best_score:e.best_score||0,best_prompt_index:e.best_prompt_index,survivors:e.survivors||[]};o.value=[...o.value,t];break}case"generation_error":break;case"job_progress":{_.value=Math.round((e.progress_pct??0)/100*c.value);const t=c.value>0?i.calculateETA(_.value,c.value):"";a.value={...a.value,pct:e.progress_pct??a.value.pct,detail:e.progress_detail||a.value.detail,eta:t};break}case"tune_complete":{s.value=!1,p.value=e.best_prompt||null,u.value=e.best_score||0,a.value={pct:100,detail:"Complete!",generation:0,totalGenerations:0},n.value=null,i.resetTracking(),m();break}case"job_completed":{s.value=!1,a.value={pct:100,detail:"Complete!",generation:0,totalGenerations:0},n.value=null,i.resetTracking(),m();break}case"job_failed":{s.value=!1,a.value={...a.value,detail:e.error||e.error_msg||"Failed"},n.value=null,i.resetTracking(),m();break}case"job_cancelled":{s.value=!1,a.value={...a.value,detail:"Cancelled"},n.value=null,i.resetTracking(),m();break}}}function C(){o.value=[],p.value=null,u.value=0,s.value=!1,n.value=null,d.value=null,_.value=0,c.value=0,a.value={pct:0,detail:"",generation:0,totalGenerations:0},i.resetTracking(),m()}return{generations:o,bestPrompt:p,bestScore:u,history:f,activeRunId:d,activeJobId:n,isRunning:s,progress:a,mode:S,totalPrompts:c,completedPrompts:_,currentGeneration:j,bestScoreGetter:E,generationScores:G,startTuning:x,cancelTuning:P,getEstimate:R,loadHistory:$,loadRun:F,deleteRun:J,handleProgress:A,reset:C,restoreJob:I}});export{L as u};
