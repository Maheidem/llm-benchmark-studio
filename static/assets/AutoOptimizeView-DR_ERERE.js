import{p as te,o as oe,I as se,c as r,d as e,f as v,h as _,z as N,F as S,A as C,x as ae,v as B,k,t as a,e as R,l as I,y as le,j as re,r as p,K as ne,B as E,s as D,a as ie,b as l}from"./index-DPrAhrhg.js";import{a as ue,u as de}from"./useSharedContext-D76pLMoU.js";import{u as pe}from"./promptLibrary-DqplsGKG.js";import{u as ce}from"./config-CBOupsQL.js";const ve={class:"flex items-center justify-between mb-6"},me={class:"flex items-center gap-2"},be={key:0,class:"space-y-6"},xe={class:"card rounded-md p-5"},ye=["value"],fe={class:"card rounded-md p-5"},_e={class:"card rounded-md p-5"},ke=["value"],ge={class:"card rounded-md p-5"},he={class:"grid grid-cols-2 gap-4"},ze={key:0,class:"text-xs",style:{color:"var(--coral)"}},we={class:"flex justify-end"},Se=["disabled"],Ce={key:0,class:"inline-block w-3.5 h-3.5 border-2 border-lime-400/30 border-t-lime-400 rounded-full animate-spin"},Ie={key:1,class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor","stroke-width":"2.5",viewBox:"0 0 24 24"},je={key:1},Pe={class:"card rounded-md p-5 mb-6"},Ve={class:"flex items-center justify-between mb-3"},Me={class:"flex items-center gap-3"},Be={class:"text-sm text-zinc-400 font-body"},Ee={class:"flex items-center gap-3"},Ae={key:0,class:"text-[10px] font-mono text-zinc-600"},Fe={class:"text-xs font-mono text-zinc-600"},Te={class:"progress-track rounded-full overflow-hidden"},Oe={key:0,class:"text-[10px] text-zinc-600 font-mono mt-1"},Ke={key:0,class:"card rounded-md overflow-hidden mb-6"},Le={class:"px-5 py-3 flex items-center justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Ue={class:"text-[10px] text-zinc-600 font-body"},Ne={style:{"max-height":"300px","overflow-y":"auto"}},Re={class:"text-xs font-mono text-zinc-600 w-5 flex-shrink-0"},De={class:"flex-1 min-w-0"},Je={class:"text-xs font-body text-zinc-300 truncate"},$e={class:"text-[10px] text-zinc-600 font-body mt-0.5"},qe={key:2},We={key:0,class:"card rounded-md p-5 mb-6",style:{"border-left":"3px solid var(--lime)"}},Ye={class:"flex items-center justify-between mb-3"},He={class:"text-sm font-mono font-bold",style:{color:"var(--lime)"}},Ge={class:"flex items-center gap-2 flex-wrap"},Qe={key:1,class:"card rounded-md overflow-hidden"},Xe={class:"px-5 py-3 flex items-center justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Ze={class:"text-[10px] text-zinc-600 font-body"},et={style:{"max-height":"400px","overflow-y":"auto"}},tt={class:"text-xs font-mono text-zinc-600 w-5 flex-shrink-0"},ot={class:"flex-1 min-w-0"},st={class:"text-xs font-body text-zinc-300"},at={class:"text-[10px] text-zinc-600 font-body mt-0.5"},lt={key:0,class:"ml-2"},rt={class:"px-1 py-0.5 rounded-sm",style:{background:"rgba(168,85,247,0.08)",color:"#A855F7"}},nt={class:"flex items-center gap-2 flex-shrink-0"},it=["onClick"],mt={__name:"AutoOptimizeView",setup(ut){const j=ue(),A=pe(),J=te(),F=ce(),{setSystemPrompt:T,setConfig:O}=de(),{showToast:m}=ne(),n=p({suiteId:"",basePrompt:"You are a helpful assistant that uses tools to answer questions. When the user asks you to perform an action, use the appropriate tool.",optimizationModelKey:"",maxIterations:5,populationSize:5}),c=p(!1),g=p(!1),x=p(!1),h=p(""),y=p(null),b=p([]),u=p(null),z=p(!1),f=p(!1),i=p({pct:0,detail:"",eta:"",iteration:null,totalIterations:null}),$=E(()=>F.allModels||[]),P=E(()=>n.value.suiteId&&n.value.optimizationModelKey&&!c.value),w=E(()=>[...b.value].sort((o,t)=>(t.score||0)-(o.score||0)));let V=null;oe(async()=>{if(j.suites.length===0)try{await j.loadSuites()}catch{}try{await F.loadConfig()}catch{}V=J.onMessage(o=>{y.value&&(o.job_id&&o.job_id!==y.value||q(o))})}),se(()=>{V&&V()});function q(o){switch(o.type){case"auto_optimize_start":case"tune_start":c.value=!0,i.value={pct:0,detail:"Starting optimization...",eta:"",iteration:null,totalIterations:n.value.maxIterations};break;case"prompt_generated":case"auto_optimize_variant":if(o.variant||o.prompt){const t=o.variant||{prompt_text:o.prompt,score:o.score||0,iteration:o.iteration||0,source:o.source};b.value=[...b.value,t]}break;case"auto_optimize_progress":case"job_progress":i.value={pct:o.progress_pct??i.value.pct,detail:o.progress_detail||o.detail||i.value.detail,eta:i.value.eta,iteration:o.iteration||i.value.iteration,totalIterations:o.total_iterations||i.value.totalIterations};break;case"auto_optimize_complete":case"tune_complete":case"job_completed":{c.value=!1,g.value=!0,i.value={...i.value,pct:100,detail:"Complete!"},o.best_prompt?u.value={prompt_text:o.best_prompt,score:o.best_score||0}:w.value.length>0&&(u.value=w.value[0]),(o.type==="auto_optimize_complete"||o.type==="tune_complete")&&(m("Auto-optimize complete!","success"),X());break}case"job_failed":c.value=!1,m(o.error||"Auto-optimize failed","error");break;case"job_cancelled":c.value=!1,m("Run cancelled","");break}}async function W(){if(!P.value||x.value)return;x.value=!0,h.value="",b.value=[],u.value=null,f.value=!1;const o=n.value.optimizationModelKey.indexOf("::"),t=n.value.optimizationModelKey.substring(0,o),M=n.value.optimizationModelKey.substring(o+2),s={suite_id:n.value.suiteId,base_prompt:n.value.basePrompt,optimization_model:M,optimization_provider_key:t,max_iterations:n.value.maxIterations,population_size:n.value.populationSize};try{const d=await D("/api/tool-eval/prompt-tune/auto-optimize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});if(!d.ok){const U=await d.json().catch(()=>({}));throw new Error(U.detail||U.error||`Error ${d.status}`)}const L=await d.json();y.value=L.job_id,c.value=!0,m("Auto-optimize started","success")}catch(d){h.value=d.message||"Failed to start"}finally{x.value=!1}}async function Y(){if(y.value)try{await D("/api/jobs/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_id:y.value})})}catch{m("Failed to cancel","error")}}function H(){if(!u.value)return;const o=u.value.prompt_text||u.value.prompt;T("_global",o),O({lastUpdatedBy:"auto_optimize"}),m("Best prompt applied to shared context","success")}function G(o){const t=o.prompt_text||o.prompt;T("_global",t),O({lastUpdatedBy:"auto_optimize"}),m("Prompt applied to shared context","success")}async function Q(){if(!u.value)return;const o=u.value.prompt_text||u.value.prompt;try{await A.saveVersion(o,null,"auto_optimize"),f.value=!0,m("Saved to Prompt Library","success")}catch{m("Failed to save to library","error")}}async function X(){if(u.value)try{const o=u.value.prompt_text||u.value.prompt;await A.saveVersion(o,null,"auto_optimize"),f.value=!0}catch{}}function Z(){}function ee(){c.value=!1,g.value=!1,b.value=[],u.value=null,f.value=!1,y.value=null,i.value={pct:0,detail:"",eta:"",iteration:null,totalIterations:null}}function K(o){return o>=80?"var(--lime)":o>=50?"#FBBF24":"var(--coral)"}return(o,t)=>{const M=ie("router-link");return l(),r("div",null,[e("div",ve,[t[7]||(t[7]=e("div",null,[e("h2",{class:"font-display font-bold text-lg text-zinc-100 mb-1"},"Auto-Optimize"),e("p",{class:"text-sm text-zinc-600 font-body"},"Automatically generate and optimize system prompts using OPRO/APE techniques.")],-1)),e("div",me,[c.value?(l(),r("button",{key:0,onClick:Z,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1.5 rounded-sm",style:{background:"rgba(191,255,0,0.08)",border:"1px solid rgba(191,255,0,0.2)",color:"var(--lime)"}},"View Active Run")):v("",!0),v("",!0)])]),!c.value&&!g.value?(l(),r("div",be,[e("div",xe,[t[9]||(t[9]=e("label",{class:"section-label mb-2 block"},"Test Suite",-1)),_(e("select",{"onUpdate:modelValue":t[0]||(t[0]=s=>n.value.suiteId=s),class:"text-sm font-mono px-3 py-2 rounded-sm w-full",style:{background:"var(--surface)",border:"1px solid var(--border-subtle)",color:"#E4E4E7",outline:"none"}},[t[8]||(t[8]=e("option",{value:""},"-- Select a suite --",-1)),(l(!0),r(S,null,C(ae(j).suites,s=>(l(),r("option",{key:s.id,value:s.id},a(s.name)+" ("+a(s.tool_count||0)+" tools, "+a(s.test_case_count||0)+" cases) ",9,ye))),128))],512),[[N,n.value.suiteId]])]),e("div",fe,[t[10]||(t[10]=e("label",{class:"section-label mb-2 block"},"Base System Prompt",-1)),_(e("textarea",{"onUpdate:modelValue":t[1]||(t[1]=s=>n.value.basePrompt=s),rows:"4",class:"w-full text-xs font-body px-3 py-2 rounded-sm resize-y",style:{background:"rgba(255,255,255,0.02)",border:"1px solid var(--border-subtle)",color:"#E4E4E7",outline:"none"},placeholder:"You are a helpful assistant that uses tools..."},null,512),[[B,n.value.basePrompt]])]),e("div",_e,[t[12]||(t[12]=e("label",{class:"section-label mb-2 block"},"Optimization Model",-1)),_(e("select",{"onUpdate:modelValue":t[2]||(t[2]=s=>n.value.optimizationModelKey=s),class:"text-sm font-mono px-3 py-2 rounded-sm w-full",style:{background:"var(--surface)",border:"1px solid var(--border-subtle)",color:"#E4E4E7",outline:"none"}},[t[11]||(t[11]=e("option",{value:""},"-- Select model --",-1)),(l(!0),r(S,null,C($.value,s=>(l(),r("option",{key:s.compoundKey,value:s.compoundKey},a(s.display_name||s.model_id)+" ("+a(s.provider)+") ",9,ke))),128))],512),[[N,n.value.optimizationModelKey]]),t[13]||(t[13]=e("p",{class:"text-[10px] text-zinc-600 font-body mt-1"},"Model used to generate and mutate prompt variants.",-1))]),e("div",ge,[t[16]||(t[16]=e("span",{class:"section-label mb-3 block"},"Parameters",-1)),e("div",he,[e("div",null,[t[14]||(t[14]=e("label",{class:"text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block"},[k(" Max Iterations "),e("span",{class:"ml-1 text-zinc-700 cursor-help",title:"Number of optimization iterations."},"?")],-1)),_(e("input",{"onUpdate:modelValue":t[3]||(t[3]=s=>n.value.maxIterations=s),type:"number",min:"1",max:"20",class:"w-full px-2 py-1.5 rounded-sm text-xs font-mono text-zinc-200",style:{background:"rgba(255,255,255,0.02)",border:"1px solid var(--border-subtle)",outline:"none"}},null,512),[[B,n.value.maxIterations,void 0,{number:!0}]])]),e("div",null,[t[15]||(t[15]=e("label",{class:"text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block"},[k(" Population Size "),e("span",{class:"ml-1 text-zinc-700 cursor-help",title:"Number of prompt variants per iteration."},"?")],-1)),_(e("input",{"onUpdate:modelValue":t[4]||(t[4]=s=>n.value.populationSize=s),type:"number",min:"2",max:"20",class:"w-full px-2 py-1.5 rounded-sm text-xs font-mono text-zinc-200",style:{background:"rgba(255,255,255,0.02)",border:"1px solid var(--border-subtle)",outline:"none"}},null,512),[[B,n.value.populationSize,void 0,{number:!0}]])])])]),h.value?(l(),r("div",ze,a(h.value),1)):v("",!0),e("div",we,[e("button",{onClick:W,disabled:!P.value||x.value,class:R(["run-btn px-6 py-2 rounded-sm text-xs flex items-center gap-2",{"opacity-50 cursor-not-allowed":!P.value||x.value}])},[x.value?(l(),r("span",Ce)):(l(),r("svg",Ie,[...t[17]||(t[17]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1)])])),t[18]||(t[18]=k(" Start Auto-Optimize ",-1))],10,Se)])])):c.value?(l(),r("div",je,[e("div",Pe,[e("div",Ve,[e("div",Me,[t[19]||(t[19]=e("div",{class:"pulse-dot"},null,-1)),e("span",Be,a(i.value.detail),1)]),e("div",Ee,[i.value.eta?(l(),r("span",Ae,a(i.value.eta),1)):v("",!0),e("span",Fe,a(i.value.pct)+"%",1),e("button",{onClick:Y,class:"text-[10px] font-display tracking-wider uppercase px-2 py-1 rounded-sm ml-2",style:{color:"var(--coral)",border:"1px solid rgba(255,59,92,0.3)"}},"Cancel")])]),e("div",Te,[e("div",{class:"progress-fill",style:I({width:i.value.pct+"%"})},null,4)]),i.value.iteration?(l(),r("div",Oe," Iteration "+a(i.value.iteration)+"/"+a(i.value.totalIterations||n.value.maxIterations),1)):v("",!0)]),b.value.length>0?(l(),r("div",Ke,[e("div",Le,[t[20]||(t[20]=e("span",{class:"section-label"},"Live Rankings",-1)),e("span",Ue,a(b.value.length)+" variants evaluated",1)]),e("div",Ne,[(l(!0),r(S,null,C(w.value,(s,d)=>(l(),r("div",{key:s.id||d,class:R(["px-5 py-3 flex items-start gap-3",{"bg-lime-400/[0.02]":d===0}]),style:{"border-bottom":"1px solid var(--border-subtle)"}},[e("span",Re,a(d+1)+".",1),e("div",De,[e("div",Je,a(s.prompt_text||s.prompt),1),e("div",$e," Iteration "+a(s.iteration||0),1)]),e("span",{class:"text-xs font-mono font-bold flex-shrink-0",style:I({color:K(s.score*100)})},a((s.score*100).toFixed(1))+"% ",5)],2))),128))])])):v("",!0)])):g.value?(l(),r("div",qe,[u.value?(l(),r("div",We,[e("div",Ye,[t[21]||(t[21]=e("span",{class:"section-label"},"Best Prompt",-1)),e("span",He,a((u.value.score*100).toFixed(1))+"% ",1)]),e("div",{class:"text-xs text-zinc-400 font-body rounded-sm px-3 py-2 mb-3 cursor-pointer",style:I([{background:"rgba(0,0,0,0.2)",border:"1px solid var(--border-subtle)"},{maxHeight:z.value?"none":"80px",overflow:z.value?"visible":"hidden"}]),onClick:t[5]||(t[5]=s=>z.value=!z.value)},a(u.value.prompt_text||u.value.prompt),5),e("div",Ge,[e("button",{onClick:H,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm",style:{background:"rgba(191,255,0,0.08)",border:"1px solid rgba(191,255,0,0.2)",color:"var(--lime)"}},"Use This Prompt"),f.value?(l(),le(M,{key:1,to:{name:"PromptLibrary"},class:"text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm",style:{background:"rgba(56,189,248,0.08)",border:"1px solid rgba(56,189,248,0.2)",color:"#38BDF8"}},{default:re(()=>[...t[22]||(t[22]=[k("View in Library â†’",-1)])]),_:1})):(l(),r("button",{key:0,onClick:Q,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm",style:{background:"rgba(56,189,248,0.08)",border:"1px solid rgba(56,189,248,0.2)",color:"#38BDF8"}},"Save to Library")),e("button",{onClick:ee,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm",style:{border:"1px solid var(--border-subtle)",color:"#71717A"}},"New Run")])])):v("",!0),b.value.length>0?(l(),r("div",Qe,[e("div",Xe,[t[23]||(t[23]=e("span",{class:"section-label"},"All Variants",-1)),e("span",Ze,a(b.value.length)+" generated",1)]),e("div",et,[(l(!0),r(S,null,C(w.value,(s,d)=>(l(),r("div",{key:s.id||d,class:"px-5 py-3 flex items-start gap-3 hover:bg-white/[0.02] transition-colors",style:{"border-bottom":"1px solid var(--border-subtle)"}},[e("span",tt,a(d+1)+".",1),e("div",ot,[e("div",st,a(s.prompt_text||s.prompt),1),e("div",at,[k(" Iteration "+a(s.iteration||0)+" ",1),s.source?(l(),r("span",lt,[e("span",rt,a(s.source),1)])):v("",!0)])]),e("div",nt,[e("span",{class:"text-xs font-mono font-bold",style:I({color:K(s.score*100)})},a((s.score*100).toFixed(1))+"% ",5),e("button",{onClick:L=>G(s),class:"text-[9px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm",style:{background:"rgba(191,255,0,0.06)",border:"1px solid rgba(191,255,0,0.15)",color:"var(--lime)"}},"Use",8,it)])]))),128))])])):v("",!0)])):v("",!0)])}}};export{mt as default};
