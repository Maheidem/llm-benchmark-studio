import{S as be,r as p,Q as Y,B as x,s as A}from"./index-DBNJ0RjU.js";import{u as T}from"./config-2dysVlIa.js";import{u as Me}from"./useActiveSession-DdoXJmDo.js";import{u as Pe}from"./useDirectBenchmark-CzkWcPhe.js";const Re=be("benchmark",()=>{const f=p(new Set),b=p(new Set([0])),B=p(512),C=p(.7),I=p(1),M=p(""),j=p(!1),D=p(120),z=p([]),L=Y({}),k=p(!1),h=p(null),N=p(null),y=p([]),d=Y({}),$=p([]),R=p(null),J=p([]),w=Me(),{supportsDirectLocalAccess:G,isLocalProvider:X,runDirectBenchmark:V,generateContextFiller:Z,createAbortController:O,cancelDirect:ee}=Pe(),P=p(!1),te=x(()=>f.value.size),se=x(()=>new Set(y.value.map(t=>t.context_tokens||0)).size>1),oe=x(()=>{const e={};for(const t of y.value){const s=`${t.model_id}::${t.provider}::${t.context_tokens||0}`;e[s]||(e[s]={...t,_runs:[],_successes:0}),e[s]._runs.push(t),t.success&&e[s]._successes++}return Object.values(e).map(t=>{var m;const s=t._runs.filter(r=>r.success),n=s.length,a=s.map(r=>r.tokens_per_second).sort((r,o)=>r-o),c=s.map(r=>r.ttft_ms).sort((r,o)=>r-o),l=s.map(r=>r.input_tokens_per_second||0).filter(r=>r>0),i=s.map(r=>r.cost||0);return{provider:t.provider,model:t.model,model_id:t.model_id,context_tokens:t.context_tokens||0,tokens_per_second:n?s.reduce((r,o)=>r+o.tokens_per_second,0)/n:0,ttft_ms:n?s.reduce((r,o)=>r+o.ttft_ms,0)/n:0,total_time_s:n?s.reduce((r,o)=>r+o.total_time_s,0)/n:0,output_tokens:n?s.reduce((r,o)=>r+o.output_tokens,0)/n:0,input_tokens_per_second:l.length?l.reduce((r,o)=>r+o,0)/l.length:0,avg_cost:n?i.reduce((r,o)=>r+o,0)/n:0,total_cost:i.reduce((r,o)=>r+o,0),std_dev_tps:Q(a),std_dev_ttft:Q(c),success:t._successes>0,runs:t._runs.length,failures:t._runs.length-t._successes,error:((m=t._runs.find(r=>!r.success))==null?void 0:m.error)||""}}).sort((t,s)=>s.tokens_per_second-t.tokens_per_second)}),H=x(()=>{let e=0,t=0;for(const s of Object.values(d))e+=s.completedSteps,t+=s.totalSteps;return{completed:e,total:t}}),re=x(()=>{const e=Object.entries(d).filter(([,t])=>t.status==="running");return e.length>0?`Running ${e.length} provider${e.length>1?"s":""} in parallel`:k.value?"Benchmark running...":""}),ne=x(()=>{const{completed:e,total:t}=H.value;return!k.value||t===0?"":w.calculateETA(e,t)});function le(e){const t=new Set(f.value);t.has(e)?t.delete(e):t.add(e),f.value=t}function ae(){const e=T(),t=new Set;for(const s of e.allModels)t.add(s.compoundKey);f.value=t}function ce(){f.value=new Set}function ie(e){const n=T().allModels.filter(l=>l.provider===e).map(l=>l.compoundKey),a=n.every(l=>f.value.has(l)),c=new Set(f.value);a?n.forEach(l=>c.delete(l)):n.forEach(l=>c.add(l)),f.value=c}function ue(e){const t=new Set(b.value);t.has(e)?(t.delete(e),t.size===0&&t.add(0)):t.add(e),b.value=t}let E=null;function K(e){if(W(e.data),e.reconnect&&e.progress_pct>0){const t=e.progress_pct/100;for(const s of Object.values(d)){const n=Math.round(s.totalSteps*t);s.completedSteps=n,n>0&&(s.status="running")}}E=null}function pe(){E&&K(E)}function W(e){var l;Object.keys(d).forEach(i=>delete d[i]);const t=T();if(!((l=t.config)!=null&&l.providers))return;let s;e.targets&&Array.isArray(e.targets)?s=new Set(e.targets.map(i=>i.provider_key+"::"+i.model_id)):s=new Set((e.models||[]).map(i=>typeof i=="string"?i:""));const n=e.runs||1,a=e.context_tiers||[0],c=e.max_tokens||4096;for(const[i,m]of Object.entries(t.config.providers)){const r=t.getProviderModels(m),o=m.provider_key||i,u=e.targets?r.filter(g=>s.has(o+"::"+g.model_id)):r.filter(g=>s.has(g.model_id));if(u.length===0)continue;let _=0;for(const g of u)for(const v of a){const F=(g.context_window||1/0)-c-100;(v===0||v<=F)&&(_+=n)}d[i]={currentModel:null,currentRun:0,totalRuns:n,completedSteps:0,totalSteps:_,status:"waiting",errors:[],currentContextTokens:0}}}function S(e){const t=e.provider;if(e.type==="progress"&&t&&d[t]){const s=d[t];s.status="running",s.currentModel=e.model,s.currentRun=e.run,s.totalRuns=e.runs,s.currentContextTokens=e.context_tokens||0}if(e.type==="skipped"&&($.value=[...$.value,{model:e.model,reason:e.reason||"context exceeds window"}]),e.type==="result"){if(w.recordStep(),t&&d[t]){const s=d[t];s.completedSteps++,!e.success&&e.error&&s.errors.push({model:e.model,message:e.error}),s.completedSteps>=s.totalSteps&&(s.status="done",s.currentModel=null)}y.value=[...y.value,e]}if(e.type==="error")if(t&&d[t]){const s=d[t];s.errors.push({model:e.model||"?",message:e.message||"Unknown error"}),s.completedSteps=s.totalSteps,s.status="error",s.currentModel=null}else R.value=e.message||"Benchmark error";if(e.type==="complete"){for(const s of Object.values(d))s.status!=="done"&&s.status!=="error"&&(s.status="done",s.completedSteps=s.totalSteps,s.currentModel=null);k.value=!1}}function de(e){var t;if(!(!h.value||e.job_id!==h.value))switch(e.type){case"job_started":break;case"job_progress":break;case"benchmark_init":e.data&&((t=T().config)!=null&&t.providers?K(e):E=e);break;case"benchmark_progress":e.data&&S(e.data);break;case"benchmark_result":e.data&&S(e.data);break;case"job_completed":S({type:"complete"}),h.value=null,k.value=!1,w.resetTracking(),y.value.length===0&&e.result_ref&&fe(e.result_ref);break;case"job_failed":h.value=null,k.value=!1,w.resetTracking(),R.value=e.error||e.error_msg||"Benchmark failed";break;case"job_cancelled":h.value=null,k.value=!1,w.resetTracking();break;case"param_adjustments":J.value=e.models||[];break}}async function fe(e){if(e)try{const t=await A(`/api/history/${e}`);if(!t.ok)return;const s=await t.json();y.value=(s.results||[]).map(n=>({...n,type:"result",success:n.success!==!1}))}catch(t){console.error("Failed to load benchmark results:",t)}}async function me(e){var r;if(!e&&f.value.size===0)throw new Error("Select at least one model");k.value=!0,y.value=[],$.value=[],R.value=null,J.value=[],w.startTracking();const t=e||{targets:Array.from(f.value).map(o=>q(o)),runs:I.value,max_tokens:B.value,temperature:C.value,prompt:M.value,context_tiers:Array.from(b.value).sort((o,u)=>o-u),warmup:j.value,timeout:D.value};if(!e){const o={};for(const[u,_]of Object.entries(L))_!=null&&_!==""&&(o[u]=_);Object.keys(o).length>0&&(t.provider_params=o)}N.value=t,W(t);const s=T(),n=G(),a=[],c=[];for(const o of t.targets||[]){const u=Object.values(((r=s.config)==null?void 0:r.providers)||{}).find(_=>_.provider_key===o.provider_key);n&&(u!=null&&u.direct_local)&&X(u)?a.push({...o,api_base:u.api_base,display_name:u.display_name,model_id_prefix:u.model_id_prefix}):c.push(o)}const l=[];if(c.length>0){const o={...t,targets:c};l.push(_e(o))}if(a.length>0&&l.push(ve(a,t)),l.length===0)throw k.value=!1,new Error("No targets to benchmark");const i=await Promise.allSettled(l);c.length===0&&S({type:"complete"});const m=i.find(o=>{var u;return o.status==="fulfilled"&&((u=o.value)==null?void 0:u.job_id)});return(m==null?void 0:m.value)||{status:"local_only"}}async function _e(e){const t=await A("/api/benchmark",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const n=await t.json().catch(()=>({}));throw new Error(n.error||`Server error (${t.status})`)}const s=await t.json();return h.value=s.job_id,s}async function ve(e,t){var m;P.value=!0,O();const s=[],n=t.context_tiers||[0],a=t.runs||1,c=t.max_tokens||512,l=t.temperature??.7,i=t.prompt||"Hello, how are you?";try{for(const r of e){t.warmup&&await V(r,[{role:"system",content:"Benchmark warmup"},{role:"user",content:"Hello"}],c,l,0,0,0);for(const o of n){const u=T(),_=Object.values(((m=u.config)==null?void 0:m.providers)||{}).flatMap(v=>v.models||[]).find(v=>v.model_id===r.model_id),g=(_==null?void 0:_.context_window)||1/0;if(o>0&&o>g-c-100){S({type:"skipped",provider:r.provider_key||r.display_name,model:r.display_name||r.model_id,reason:`Context ${o} exceeds window (${g} - ${c})`});continue}for(let v=1;v<=a;v++){S({type:"progress",provider:r.provider_key||r.display_name,model:r.display_name||r.model_id,run:v,runs:a,context_tokens:o});const F=Z(o),Te=[{role:"system",content:"You are a helpful assistant."},{role:"user",content:F?i+`

`+F:i}],U=await V(r,Te,c,l,o,v,a);S(U),s.push(U)}}}if(s.length>0){const r=s.filter(o=>o.success||o.error);if(r.length>0)try{await A("/api/benchmark/direct-results",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({results:r.map(o=>({provider:o.provider,model_id:o.model_id,run_number:o.run,context_tokens:o.context_tokens||0,ttft_ms:o.ttft_ms,total_time_s:o.total_time_s,output_tokens:o.output_tokens,input_tokens:o.input_tokens,tokens_per_second:o.tokens_per_second,input_tokens_per_second:o.input_tokens_per_second,cost:o.cost||0,success:o.success,error:o.error})),prompt:i,max_tokens:c,temperature:l,context_tiers:n,warmup:t.warmup||!1})})}catch(o){console.error("Failed to persist direct benchmark results:",o)}}}finally{P.value=!1}}async function ke(){h.value&&await A(`/api/jobs/${h.value}/cancel`,{method:"POST"}),P.value&&(ee(),P.value=!1)}function he(e){h.value=e.id,k.value=!0}function q(e){const t=e.indexOf("::");return{provider_key:e.substring(0,t),model_id:e.substring(t+2)}}function Q(e){if(e.length<2)return 0;const t=e.reduce((n,a)=>n+a,0)/e.length,s=e.reduce((n,a)=>n+(a-t)**2,0)/(e.length-1);return Math.sqrt(s)}async function ye(){try{const t=await(await A("/api/config/prompts")).json();z.value=Object.entries(t).map(([s,n])=>({key:s,label:n.label||s,prompt:n.prompt||""}))}catch(e){console.error("Failed to load prompt templates:",e)}}function ge(e){if(!e)return;const t=z.value.find(s=>s.key===e);t&&(M.value=t.prompt)}function Se(e){var t,s,n;(t=e==null?void 0:e.defaults)!=null&&t.prompt&&(M.value=e.defaults.prompt.trim()),(s=e==null?void 0:e.defaults)!=null&&s.max_tokens&&(B.value=e.defaults.max_tokens),((n=e==null?void 0:e.defaults)==null?void 0:n.temperature)!==void 0&&(C.value=e.defaults.temperature)}function we(e){if(e.results&&e.results.length>0){const t=new Set;for(const s of e.results){const n=s.provider_key||s.provider,a=s.model_id||s.model;n&&a&&t.add(`${n}::${a}`)}t.size>0&&(f.value=t)}e.max_tokens!=null&&(B.value=e.max_tokens),e.temperature!=null&&(C.value=e.temperature),e.runs!=null&&(I.value=e.runs),e.prompt&&(M.value=e.prompt),e.context_tiers&&Array.isArray(e.context_tiers)&&(b.value=new Set(e.context_tiers)),e.warmup!=null&&(j.value=e.warmup),e.timeout!=null&&(D.value=e.timeout)}function xe(e){if(!(e!=null&&e.providers))return;const t=new Set;for(const[s,n]of Object.entries(e.providers)){const a=Array.isArray(n)?n:n.models||[],c=n.provider_key||s;for(const l of a)t.add(c+"::"+l.model_id)}f.value=t}return{selectedModels:f,contextTiers:b,maxTokens:B,temperature:C,runs:I,prompt:M,warmup:j,timeout:D,promptTemplates:z,isRunning:k,activeJobId:h,lastBenchmarkBody:N,currentResults:y,providerProgress:d,skippedModels:$,errorBanner:R,paramWarnings:J,localRunning:P,providerParams:L,selectedCount:te,isStressMode:se,aggregatedResults:oe,overallProgress:H,overallLabel:re,eta:ne,toggleModel:le,selectAll:ae,selectNone:ce,toggleProviderModels:ie,toggleTier:ue,handleJobEvent:de,startBenchmark:me,cancelBenchmark:ke,restoreRunningJob:he,replayPendingInit:pe,loadPromptTemplates:ye,applyPromptTemplate:ge,applyDefaults:Se,selectAllFromConfig:xe,parseCompoundKey:q,prefillFromRun:we}});export{Re as u};
