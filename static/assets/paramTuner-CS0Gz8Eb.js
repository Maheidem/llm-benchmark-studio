import{S as Y,r as l,B as T,s as v}from"./index-DkTk070G.js";import{u as B}from"./useActiveSession-DdoXJmDo.js";const L=Y("paramTuner",()=>{const $=l({}),n=l([]),d=l([]),c=l(null),r=l(null),s=l(!1),e=l({pct:0,detail:"",eta:"",iteration:null,totalIterations:null}),w=l(null),p=l(0),h=l("overall_score"),f=l(!1),I=l("grid"),_=l(!1),i=B(),g=T(()=>n.value.length===0?null:[...n.value].sort((a,o)=>(o.overall_score||0)-(a.overall_score||0))[0]||null),C=T(()=>{var t;return((t=g.value)==null?void 0:t.overall_score)||0}),R=T(()=>{const t=h.value,a=f.value;return[...n.value].sort((o,u)=>{const m=o[t]??0,y=u[t]??0;return a?m-y:y-m})}),S="_ptJobId",k="_ptRunId";function j(){try{r.value&&sessionStorage.setItem(S,r.value),c.value&&sessionStorage.setItem(k,c.value)}catch{}}function A(){try{const t=sessionStorage.getItem(S),a=sessionStorage.getItem(k);t&&(r.value=t,c.value=a,s.value=!0)}catch{}}function b(){try{sessionStorage.removeItem(S),sessionStorage.removeItem(k)}catch{}}async function J(t){n.value=[],p.value=0,e.value={pct:0,detail:"Starting...",eta:""},i.startTracking();const a=await v("/api/tool-eval/param-tune",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(a.status===409)throw new Error("A job is already running");if(!a.ok){const u=await a.json().catch(()=>({}));throw new Error(u.error||`Server error (${a.status})`)}const o=await a.json();return r.value=o.job_id,s.value=!0,j(),o}async function P(){if(!r.value)return;if(!(await v("/api/tool-eval/param-tune/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_id:r.value})})).ok)throw new Error("Failed to cancel")}async function F(){const t=await v("/api/tool-eval/param-tune/history");if(!t.ok)throw new Error("Failed to load history");const a=await t.json();return d.value=a.runs||[],d.value}async function M(t){const a=await v(`/api/tool-eval/param-tune/history/${t}`);if(!a.ok)throw new Error("Run not found");const o=await a.json();return n.value=Array.isArray(o.combos)?o.combos:[],o}async function O(t){if(!(await v(`/api/tool-eval/param-tune/history/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete");d.value=d.value.filter(o=>o.id!==t)}async function x(t){try{const a=await v("/api/settings/phase10");if(a.ok){const o=await a.json();w.value=o.param_support||null}}catch{w.value=null}}function K(t){if(!(t.job_id&&r.value&&t.job_id!==r.value))switch(t.type){case"tune_start":{s.value=!0,c.value=t.tune_id||null,p.value=t.total_combos||0,n.value=[],I.value=t.optimization_mode||"grid",_.value=!1,i.startTracking(),e.value={pct:0,detail:`Tuning ${t.suite_name||""}...`,eta:"",iteration:null,totalIterations:t.n_trials||t.total_combos||null},j();break}case"combo_result":{const a=t.data||t;n.value=[...n.value,a],i.recordStep();const o=n.value.length,u=p.value||o,m=u>0?Math.round(o/u*100):0,y=t.trial_number||t.iteration||o,E=e.value.totalIterations||u;e.value={pct:m,detail:I.value==="grid"?`${a.model_name||""}, combo ${o}/${u}`:`${a.model_name||""}, trial ${y}/${E}`,eta:i.calculateETA(o,u),iteration:y,totalIterations:E};break}case"job_progress":{e.value={pct:t.progress_pct??e.value.pct,detail:t.progress_detail||e.value.detail,eta:e.value.eta,iteration:t.iteration||e.value.iteration,totalIterations:t.total_iterations||e.value.totalIterations},(t.converged||t.early_stopped)&&(_.value=!0);break}case"tune_complete":{s.value=!1,(t.converged||t.early_stopped)&&(_.value=!0),e.value={pct:100,detail:"Complete!",eta:"",iteration:e.value.iteration,totalIterations:e.value.totalIterations},r.value=null,i.resetTracking(),b();break}case"job_completed":{s.value=!1,e.value={pct:100,detail:"Complete!",eta:"",iteration:e.value.iteration,totalIterations:e.value.totalIterations},r.value=null,i.resetTracking(),b();break}case"job_failed":{s.value=!1,e.value={pct:e.value.pct,detail:t.error||t.error_msg||"Failed",eta:"",iteration:e.value.iteration,totalIterations:e.value.totalIterations},r.value=null,i.resetTracking(),b();break}case"job_cancelled":{s.value=!1,e.value={pct:e.value.pct,detail:"Cancelled",eta:"",iteration:e.value.iteration,totalIterations:e.value.totalIterations},r.value=null,i.resetTracking(),b();break}}}function N(){n.value=[],s.value=!1,r.value=null,c.value=null,e.value={pct:0,detail:"",eta:"",iteration:null,totalIterations:null},p.value=0,I.value="grid",_.value=!1,i.resetTracking(),b()}function z(t){h.value===t?f.value=!f.value:(h.value=t,f.value=!1)}return{searchSpace:$,results:n,history:d,activeRunId:c,activeJobId:r,isRunning:s,progress:e,compatMatrix:w,totalCombos:p,sortKey:h,sortAsc:f,optimizationMode:I,earlyStopped:_,bestConfig:g,bestScore:C,sortedResults:R,startTuning:J,cancelTuning:P,loadHistory:F,loadRun:M,deleteRun:O,loadCompatMatrix:x,handleProgress:K,reset:N,restoreJob:A,setSort:z}});export{L as u};
