import{S as ge,r as p,Q as we,B as x,s as P}from"./index-DPrAhrhg.js";import{u as T}from"./config-CBOupsQL.js";import{u as xe}from"./useActiveSession-DdoXJmDo.js";import{u as Te}from"./useDirectBenchmark-B2Eo7wpQ.js";const Ae=ge("benchmark",()=>{const f=p(new Set),M=p(new Set([0])),A=p(512),C=p(.7),I=p(1),b=p(""),D=p(!1),z=p([]),v=p(!1),k=p(null),J=p(null),h=p([]),d=we({}),$=p([]),R=p(null),w=xe(),{supportsDirectLocalAccess:Q,isLocalProvider:U,runDirectBenchmark:j,generateContextFiller:W,createAbortController:Y,cancelDirect:G}=Te(),B=p(!1),X=x(()=>f.value.size),Z=x(()=>new Set(h.value.map(t=>t.context_tokens||0)).size>1),O=x(()=>{const e={};for(const t of h.value){const s=`${t.model_id}::${t.provider}::${t.context_tokens||0}`;e[s]||(e[s]={...t,_runs:[],_successes:0}),e[s]._runs.push(t),t.success&&e[s]._successes++}return Object.values(e).map(t=>{var m;const s=t._runs.filter(r=>r.success),n=s.length,a=s.map(r=>r.tokens_per_second).sort((r,o)=>r-o),c=s.map(r=>r.ttft_ms).sort((r,o)=>r-o),l=s.map(r=>r.input_tokens_per_second||0).filter(r=>r>0),i=s.map(r=>r.cost||0);return{provider:t.provider,model:t.model,model_id:t.model_id,context_tokens:t.context_tokens||0,tokens_per_second:n?s.reduce((r,o)=>r+o.tokens_per_second,0)/n:0,ttft_ms:n?s.reduce((r,o)=>r+o.ttft_ms,0)/n:0,total_time_s:n?s.reduce((r,o)=>r+o.total_time_s,0)/n:0,output_tokens:n?s.reduce((r,o)=>r+o.output_tokens,0)/n:0,input_tokens_per_second:l.length?l.reduce((r,o)=>r+o,0)/l.length:0,avg_cost:n?i.reduce((r,o)=>r+o,0)/n:0,total_cost:i.reduce((r,o)=>r+o,0),std_dev_tps:K(a),std_dev_ttft:K(c),success:t._successes>0,runs:t._runs.length,failures:t._runs.length-t._successes,error:((m=t._runs.find(r=>!r.success))==null?void 0:m.error)||""}}).sort((t,s)=>s.tokens_per_second-t.tokens_per_second)}),L=x(()=>{let e=0,t=0;for(const s of Object.values(d))e+=s.completedSteps,t+=s.totalSteps;return{completed:e,total:t}}),ee=x(()=>{const e=Object.entries(d).filter(([,t])=>t.status==="running");return e.length>0?`Running ${e.length} provider${e.length>1?"s":""} in parallel`:v.value?"Benchmark running...":""}),te=x(()=>{const{completed:e,total:t}=L.value;return!v.value||t===0?"":w.calculateETA(e,t)});function se(e){const t=new Set(f.value);t.has(e)?t.delete(e):t.add(e),f.value=t}function oe(){const e=T(),t=new Set;for(const s of e.allModels)t.add(s.compoundKey);f.value=t}function re(){f.value=new Set}function ne(e){const n=T().allModels.filter(l=>l.provider===e).map(l=>l.compoundKey),a=n.every(l=>f.value.has(l)),c=new Set(f.value);a?n.forEach(l=>c.delete(l)):n.forEach(l=>c.add(l)),f.value=c}function le(e){const t=new Set(M.value);t.has(e)?(t.delete(e),t.size===0&&t.add(0)):t.add(e),M.value=t}let E=null;function N(e){if(V(e.data),e.reconnect&&e.progress_pct>0){const t=e.progress_pct/100;for(const s of Object.values(d)){const n=Math.round(s.totalSteps*t);s.completedSteps=n,n>0&&(s.status="running")}}E=null}function ae(){E&&N(E)}function V(e){var l;Object.keys(d).forEach(i=>delete d[i]);const t=T();if(!((l=t.config)!=null&&l.providers))return;let s;e.targets&&Array.isArray(e.targets)?s=new Set(e.targets.map(i=>i.provider_key+"::"+i.model_id)):s=new Set((e.models||[]).map(i=>typeof i=="string"?i:""));const n=e.runs||1,a=e.context_tiers||[0],c=e.max_tokens||4096;for(const[i,m]of Object.entries(t.config.providers)){const r=t.getProviderModels(m),o=m.provider_key||i,u=e.targets?r.filter(S=>s.has(o+"::"+S.model_id)):r.filter(S=>s.has(S.model_id));if(u.length===0)continue;let y=0;for(const S of u)for(const _ of a){const F=(S.context_window||1/0)-c-100;(_===0||_<=F)&&(y+=n)}d[i]={currentModel:null,currentRun:0,totalRuns:n,completedSteps:0,totalSteps:y,status:"waiting",errors:[],currentContextTokens:0}}}function g(e){const t=e.provider;if(e.type==="progress"&&t&&d[t]){const s=d[t];s.status="running",s.currentModel=e.model,s.currentRun=e.run,s.totalRuns=e.runs,s.currentContextTokens=e.context_tokens||0}if(e.type==="skipped"&&($.value=[...$.value,{model:e.model,reason:e.reason||"context exceeds window"}]),e.type==="result"){if(w.recordStep(),t&&d[t]){const s=d[t];s.completedSteps++,!e.success&&e.error&&s.errors.push({model:e.model,message:e.error}),s.completedSteps>=s.totalSteps&&(s.status="done",s.currentModel=null)}h.value=[...h.value,e]}if(e.type==="error")if(t&&d[t]){const s=d[t];s.errors.push({model:e.model||"?",message:e.message||"Unknown error"}),s.completedSteps=s.totalSteps,s.status="error",s.currentModel=null}else R.value=e.message||"Benchmark error";if(e.type==="complete"){for(const s of Object.values(d))s.status!=="done"&&s.status!=="error"&&(s.status="done",s.completedSteps=s.totalSteps,s.currentModel=null);v.value=!1}}function ce(e){var t;if(!(!k.value||e.job_id!==k.value))switch(e.type){case"job_started":break;case"job_progress":break;case"benchmark_init":e.data&&((t=T().config)!=null&&t.providers?N(e):E=e);break;case"benchmark_progress":e.data&&g(e.data);break;case"benchmark_result":e.data&&g(e.data);break;case"job_completed":g({type:"complete"}),k.value=null,v.value=!1,w.resetTracking(),h.value.length===0&&e.result_ref&&ie(e.result_ref);break;case"job_failed":k.value=null,v.value=!1,w.resetTracking(),R.value=e.error||e.error_msg||"Benchmark failed";break;case"job_cancelled":k.value=null,v.value=!1,w.resetTracking();break}}async function ie(e){if(e)try{const t=await P(`/api/history/${e}`);if(!t.ok)return;const s=await t.json();h.value=(s.results||[]).map(n=>({...n,type:"result",success:n.success!==!1}))}catch(t){console.error("Failed to load benchmark results:",t)}}async function ue(e){var r;if(!e&&f.value.size===0)throw new Error("Select at least one model");v.value=!0,h.value=[],$.value=[],R.value=null,w.startTracking();const t=e||{targets:Array.from(f.value).map(o=>H(o)),runs:I.value,max_tokens:A.value,temperature:C.value,prompt:b.value,context_tiers:Array.from(M.value).sort((o,u)=>o-u),warmup:D.value};J.value=t,V(t);const s=T(),n=Q(),a=[],c=[];for(const o of t.targets||[]){const u=Object.values(((r=s.config)==null?void 0:r.providers)||{}).find(y=>y.provider_key===o.provider_key);n&&(u!=null&&u.direct_local)&&U(u)?a.push({...o,api_base:u.api_base,display_name:u.display_name,model_id_prefix:u.model_id_prefix}):c.push(o)}const l=[];if(c.length>0){const o={...t,targets:c};l.push(pe(o))}if(a.length>0&&l.push(de(a,t)),l.length===0)throw v.value=!1,new Error("No targets to benchmark");const i=await Promise.allSettled(l);c.length===0&&g({type:"complete"});const m=i.find(o=>{var u;return o.status==="fulfilled"&&((u=o.value)==null?void 0:u.job_id)});return(m==null?void 0:m.value)||{status:"local_only"}}async function pe(e){const t=await P("/api/benchmark",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(!t.ok){const n=await t.json().catch(()=>({}));throw new Error(n.error||`Server error (${t.status})`)}const s=await t.json();return k.value=s.job_id,s}async function de(e,t){var m;B.value=!0,Y();const s=[],n=t.context_tiers||[0],a=t.runs||1,c=t.max_tokens||512,l=t.temperature??.7,i=t.prompt||"Hello, how are you?";try{for(const r of e){t.warmup&&await j(r,[{role:"system",content:"Benchmark warmup"},{role:"user",content:"Hello"}],c,l,0,0,0);for(const o of n){const u=T(),y=Object.values(((m=u.config)==null?void 0:m.providers)||{}).flatMap(_=>_.models||[]).find(_=>_.model_id===r.model_id),S=(y==null?void 0:y.context_window)||1/0;if(o>0&&o>S-c-100){g({type:"skipped",provider:r.provider_key||r.display_name,model:r.display_name||r.model_id,reason:`Context ${o} exceeds window (${S} - ${c})`});continue}for(let _=1;_<=a;_++){g({type:"progress",provider:r.provider_key||r.display_name,model:r.display_name||r.model_id,run:_,runs:a,context_tokens:o});const F=W(o),Se=[{role:"system",content:"You are a helpful assistant."},{role:"user",content:F?i+`

`+F:i}],q=await j(r,Se,c,l,o,_,a);g(q),s.push(q)}}}if(s.length>0){const r=s.filter(o=>o.success||o.error);if(r.length>0)try{await P("/api/benchmark/direct-results",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({results:r.map(o=>({provider:o.provider,model_id:o.model_id,run_number:o.run,context_tokens:o.context_tokens||0,ttft_ms:o.ttft_ms,total_time_s:o.total_time_s,output_tokens:o.output_tokens,input_tokens:o.input_tokens,tokens_per_second:o.tokens_per_second,input_tokens_per_second:o.input_tokens_per_second,cost:o.cost||0,success:o.success,error:o.error})),prompt:i,max_tokens:c,temperature:l,context_tiers:n,warmup:t.warmup||!1})})}catch(o){console.error("Failed to persist direct benchmark results:",o)}}}finally{B.value=!1}}async function fe(){k.value&&await P(`/api/jobs/${k.value}/cancel`,{method:"POST"}),B.value&&(G(),B.value=!1)}function me(e){k.value=e.id,v.value=!0}function H(e){const t=e.indexOf("::");return{provider_key:e.substring(0,t),model_id:e.substring(t+2)}}function K(e){if(e.length<2)return 0;const t=e.reduce((n,a)=>n+a,0)/e.length,s=e.reduce((n,a)=>n+(a-t)**2,0)/(e.length-1);return Math.sqrt(s)}async function _e(){try{const t=await(await P("/api/config/prompts")).json();z.value=Object.entries(t).map(([s,n])=>({key:s,label:n.label||s,prompt:n.prompt||""}))}catch(e){console.error("Failed to load prompt templates:",e)}}function ve(e){if(!e)return;const t=z.value.find(s=>s.key===e);t&&(b.value=t.prompt)}function ke(e){var t,s,n;(t=e==null?void 0:e.defaults)!=null&&t.prompt&&(b.value=e.defaults.prompt.trim()),(s=e==null?void 0:e.defaults)!=null&&s.max_tokens&&(A.value=e.defaults.max_tokens),((n=e==null?void 0:e.defaults)==null?void 0:n.temperature)!==void 0&&(C.value=e.defaults.temperature)}function he(e){if(e.results&&e.results.length>0){const t=new Set;for(const s of e.results){const n=s.provider_key||s.provider,a=s.model_id||s.model;n&&a&&t.add(`${n}::${a}`)}t.size>0&&(f.value=t)}e.max_tokens!=null&&(A.value=e.max_tokens),e.temperature!=null&&(C.value=e.temperature),e.runs!=null&&(I.value=e.runs),e.prompt&&(b.value=e.prompt),e.context_tiers&&Array.isArray(e.context_tiers)&&(M.value=new Set(e.context_tiers)),e.warmup!=null&&(D.value=e.warmup)}function ye(e){if(!(e!=null&&e.providers))return;const t=new Set;for(const[s,n]of Object.entries(e.providers)){const a=Array.isArray(n)?n:n.models||[],c=n.provider_key||s;for(const l of a)t.add(c+"::"+l.model_id)}f.value=t}return{selectedModels:f,contextTiers:M,maxTokens:A,temperature:C,runs:I,prompt:b,warmup:D,promptTemplates:z,isRunning:v,activeJobId:k,lastBenchmarkBody:J,currentResults:h,providerProgress:d,skippedModels:$,errorBanner:R,localRunning:B,selectedCount:X,isStressMode:Z,aggregatedResults:O,overallProgress:L,overallLabel:ee,eta:te,toggleModel:se,selectAll:oe,selectNone:re,toggleProviderModels:ne,toggleTier:le,handleJobEvent:ce,startBenchmark:ue,cancelBenchmark:fe,restoreRunningJob:me,replayPendingInit:ae,loadPromptTemplates:_e,applyPromptTemplate:ve,applyDefaults:ke,selectAllFromConfig:ye,parseCompoundKey:H,prefillFromRun:he}});export{Ae as u};
