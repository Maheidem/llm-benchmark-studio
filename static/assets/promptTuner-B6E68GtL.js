import{S as O,r as l,B as m,s as _}from"./index-BqpQFpv6.js";import{u as x}from"./useActiveSession-DdoXJmDo.js";const A=O("promptTuner",()=>{const r=l([]),v=l(null),u=l(0),b=l([]),p=l(null),o=l(null),s=l(!1),a=l({pct:0,detail:"",generation:0,totalGenerations:0}),k=l("quick"),c=l(0),d=l(0),i=x(),y=m(()=>r.value.length===0?null:r.value[r.value.length-1]),S=m(()=>u.value),j=m(()=>r.value.map(e=>({generation:e.generation,bestScore:e.best_score||0}))),g="_prtJobId",h="_prtRunId";function w(){try{o.value&&sessionStorage.setItem(g,o.value),p.value&&sessionStorage.setItem(h,p.value)}catch{}}function T(){try{const e=sessionStorage.getItem(g),t=sessionStorage.getItem(h);e&&(o.value=e,p.value=t,s.value=!0)}catch{}}function f(){try{sessionStorage.removeItem(g),sessionStorage.removeItem(h)}catch{}}async function E(e){r.value=[],v.value=null,u.value=0,d.value=0,c.value=0,a.value={pct:0,detail:"Starting...",generation:0,totalGenerations:0},i.startTracking();const t=await _("/api/tool-eval/prompt-tune",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===409)throw new Error("A job is already running");if(!t.ok){const C=await t.json().catch(()=>({}));throw new Error(C.error||`Server error (${t.status})`)}const n=await t.json();return o.value=n.job_id,s.value=!0,w(),n}async function I(){if(!o.value)return;if(!(await _("/api/tool-eval/prompt-tune/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_id:o.value})})).ok)throw new Error("Failed to cancel")}async function G(e){const t=new URLSearchParams(e).toString(),n=await _(`/api/tool-eval/prompt-tune/estimate?${t}`);if(!n.ok)throw new Error("Failed to get estimate");return await n.json()}async function P(){const e=await _("/api/tool-eval/prompt-tune/history");if(!e.ok)throw new Error("Failed to load history");const t=await e.json();return b.value=t.runs||[],b.value}async function R(e){const t=await _(`/api/tool-eval/prompt-tune/history/${e}`);if(!t.ok)throw new Error("Run not found");const n=await t.json();if(n.generations_json)try{r.value=typeof n.generations_json=="string"?JSON.parse(n.generations_json):n.generations_json}catch{r.value=[]}return v.value=n.best_prompt||null,u.value=n.best_score||0,n}async function $(e){if(!(await _(`/api/tool-eval/prompt-tune/history/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete");b.value=b.value.filter(n=>n.id!==e)}function J(e){if(!(e.job_id&&o.value&&e.job_id!==o.value))switch(e.type){case"tune_start":{s.value=!0,p.value=e.tune_id||null,k.value=e.mode||"quick",c.value=e.total_prompts||0,d.value=0,r.value=[],v.value=null,u.value=0,i.startTracking(),a.value={pct:0,detail:`Tuning ${e.suite_name||""}...`,generation:0,totalGenerations:0},w();break}case"generation_start":{a.value={...a.value,detail:`Generation ${e.generation}/${e.total_generations}`,generation:e.generation,totalGenerations:e.total_generations};break}case"prompt_generated":break;case"prompt_eval_start":{i.recordStep(),a.value={...a.value,detail:`Gen ${e.generation}: evaluating prompt ${e.prompt_index+1} on ${e.model}`};break}case"prompt_eval_result":break;case"generation_complete":{const t={generation:e.generation,best_score:e.best_score||0,best_prompt_index:e.best_prompt_index,survivors:e.survivors||[]};r.value=[...r.value,t];break}case"generation_error":break;case"job_progress":{d.value=Math.round((e.progress_pct??0)/100*c.value);const t=c.value>0?i.calculateETA(d.value,c.value):"";a.value={...a.value,pct:e.progress_pct??a.value.pct,detail:e.progress_detail||a.value.detail,eta:t};break}case"tune_complete":{s.value=!1,v.value=e.best_prompt||null,u.value=e.best_score||0,a.value={pct:100,detail:"Complete!",generation:0,totalGenerations:0},o.value=null,i.resetTracking(),f();break}case"job_completed":{s.value=!1,a.value={pct:100,detail:"Complete!",generation:0,totalGenerations:0},o.value=null,i.resetTracking(),f();break}case"job_failed":{s.value=!1,a.value={...a.value,detail:e.error||e.error_msg||"Failed"},o.value=null,i.resetTracking(),f();break}case"job_cancelled":{s.value=!1,a.value={...a.value,detail:"Cancelled"},o.value=null,i.resetTracking(),f();break}}}function F(){r.value=[],v.value=null,u.value=0,s.value=!1,o.value=null,p.value=null,d.value=0,c.value=0,a.value={pct:0,detail:"",generation:0,totalGenerations:0},i.resetTracking(),f()}return{generations:r,bestPrompt:v,bestScore:u,history:b,activeRunId:p,activeJobId:o,isRunning:s,progress:a,mode:k,totalPrompts:c,completedPrompts:d,currentGeneration:y,bestScoreGetter:S,generationScores:j,startTuning:E,cancelTuning:I,getEstimate:G,loadHistory:P,loadRun:R,deleteRun:$,handleProgress:J,reset:F,restoreJob:T}});export{A as u};
