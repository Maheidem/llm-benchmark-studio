import{S as Y,r as l,B as k,s as v}from"./index-BHukJGVM.js";import{u as B}from"./useActiveSession-DdoXJmDo.js";const L=Y("paramTuner",()=>{const $=l({}),n=l([]),d=l([]),c=l(null),r=l(null),i=l(!1),e=l({pct:0,detail:"",eta:"",iteration:null,totalIterations:null}),w=l(null),p=l(0),y=l("overall_score"),f=l(!1),I=l("grid"),_=l(!1),u=B(),T=k(()=>n.value.length===0?null:[...n.value].sort((a,o)=>(o.overall_score||0)-(a.overall_score||0))[0]||null),C=k(()=>{var t;return((t=T.value)==null?void 0:t.overall_score)||0}),R=k(()=>{const t=y.value,a=f.value;return[...n.value].sort((o,s)=>{const m=o[t]??0,h=s[t]??0;return a?m-h:h-m})}),S="_ptJobId",j="_ptRunId";function g(){try{r.value&&sessionStorage.setItem(S,r.value),c.value&&sessionStorage.setItem(j,c.value)}catch{}}function J(){try{const t=sessionStorage.getItem(S),a=sessionStorage.getItem(j);t&&(r.value=t,c.value=a,i.value=!0)}catch{}}function b(){try{sessionStorage.removeItem(S),sessionStorage.removeItem(j)}catch{}}async function P(t){n.value=[],p.value=0,e.value={pct:0,detail:"Starting...",eta:""},u.startTracking();const a=await v("/api/tool-eval/param-tune",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(a.status===409)throw new Error("A job is already running");if(!a.ok){const s=await a.json().catch(()=>({}));throw new Error(s.error||`Server error (${a.status})`)}const o=await a.json();return r.value=o.job_id,i.value=!0,g(),o}async function F(){if(!r.value)return;if(!(await v("/api/tool-eval/param-tune/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_id:r.value})})).ok)throw new Error("Failed to cancel")}async function O(){const t=await v("/api/tool-eval/param-tune/history");if(!t.ok)throw new Error("Failed to load history");const a=await t.json();return d.value=a.runs||[],d.value}async function A(t){const a=await v(`/api/tool-eval/param-tune/history/${t}`);if(!a.ok)throw new Error("Run not found");const o=await a.json();if(o.results_json)try{const s=typeof o.results_json=="string"?JSON.parse(o.results_json):o.results_json;n.value=s}catch{n.value=[]}return o}async function M(t){if(!(await v(`/api/tool-eval/param-tune/history/${t}`,{method:"DELETE"})).ok)throw new Error("Failed to delete");d.value=d.value.filter(o=>o.id!==t)}async function N(t){try{const a=await v("/api/settings/phase10");if(a.ok){const o=await a.json();w.value=o.param_support||null}}catch{w.value=null}}function x(t){if(!(t.job_id&&r.value&&t.job_id!==r.value))switch(t.type){case"tune_start":{i.value=!0,c.value=t.tune_id||null,p.value=t.total_combos||0,n.value=[],I.value=t.optimization_mode||"grid",_.value=!1,u.startTracking(),e.value={pct:0,detail:`Tuning ${t.suite_name||""}...`,eta:"",iteration:null,totalIterations:t.n_trials||t.total_combos||null},g();break}case"combo_result":{const a=t.data||t;n.value=[...n.value,a],u.recordStep();const o=n.value.length,s=p.value||o,m=s>0?Math.round(o/s*100):0,h=t.trial_number||t.iteration||o,E=e.value.totalIterations||s;e.value={pct:m,detail:I.value==="grid"?`${a.model_name||""}, combo ${o}/${s}`:`${a.model_name||""}, trial ${h}/${E}`,eta:u.calculateETA(o,s),iteration:h,totalIterations:E};break}case"job_progress":{e.value={pct:t.progress_pct??e.value.pct,detail:t.progress_detail||e.value.detail,eta:e.value.eta,iteration:t.iteration||e.value.iteration,totalIterations:t.total_iterations||e.value.totalIterations},(t.converged||t.early_stopped)&&(_.value=!0);break}case"tune_complete":{i.value=!1,(t.converged||t.early_stopped)&&(_.value=!0),e.value={pct:100,detail:"Complete!",eta:"",iteration:e.value.iteration,totalIterations:e.value.totalIterations},r.value=null,u.resetTracking(),b();break}case"job_completed":{i.value=!1,e.value={pct:100,detail:"Complete!",eta:"",iteration:e.value.iteration,totalIterations:e.value.totalIterations},r.value=null,u.resetTracking(),b();break}case"job_failed":{i.value=!1,e.value={pct:e.value.pct,detail:t.error||t.error_msg||"Failed",eta:"",iteration:e.value.iteration,totalIterations:e.value.totalIterations},r.value=null,u.resetTracking(),b();break}case"job_cancelled":{i.value=!1,e.value={pct:e.value.pct,detail:"Cancelled",eta:"",iteration:e.value.iteration,totalIterations:e.value.totalIterations},r.value=null,u.resetTracking(),b();break}}}function K(){n.value=[],i.value=!1,r.value=null,c.value=null,e.value={pct:0,detail:"",eta:"",iteration:null,totalIterations:null},p.value=0,I.value="grid",_.value=!1,u.resetTracking(),b()}function z(t){y.value===t?f.value=!f.value:(y.value=t,f.value=!1)}return{searchSpace:$,results:n,history:d,activeRunId:c,activeJobId:r,isRunning:i,progress:e,compatMatrix:w,totalCombos:p,sortKey:y,sortAsc:f,optimizationMode:I,earlyStopped:_,bestConfig:T,bestScore:C,sortedResults:R,startTuning:P,cancelTuning:F,loadHistory:O,loadRun:A,deleteRun:M,loadCompatMatrix:N,handleProgress:x,reset:K,restoreJob:J,setSort:z}});export{L as u};
