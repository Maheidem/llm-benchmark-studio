import{p as $,o as V,I as D,c as i,d as t,t as a,x as r,i as w,j as z,f as c,l as b,F as y,A as _,y as J,k as h,g as E,K as L,a as U,B as S,r as W,b as n,M as q}from"./index-DQrEf9q5.js";import{u as K}from"./paramTuner-DfyzCDvF.js";import{u as G}from"./profiles-Cu0lyqDC.js";import{u as H}from"./useSharedContext-J6jiB4Zj.js";import{_ as O}from"./ParamTunerResults-BuUAGRRm.js";import"./useActiveSession-DdoXJmDo.js";const Q={class:"flex items-center justify-between mb-6"},X={class:"text-sm text-zinc-600 font-body"},Y={class:"flex items-center gap-2"},Z={key:0,class:"card rounded-md p-5 mb-6"},ee={class:"flex items-center justify-between mb-3"},te={class:"flex items-center gap-3"},se={key:0,class:"pulse-dot"},oe={class:"text-sm text-zinc-400 font-body"},re={class:"flex items-center gap-3"},ne={key:0,class:"text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm",style:{background:"rgba(251,191,36,0.08)",color:"#FBBF24",border:"1px solid rgba(251,191,36,0.2)"},title:"Bayesian search converged early"},le={key:1,class:"text-[10px] font-mono text-zinc-600"},ie={class:"text-xs font-mono text-zinc-600"},ae={class:"progress-track rounded-full overflow-hidden"},ce={key:0,class:"text-[10px] text-zinc-600 font-mono mt-1"},de={key:1,class:"card rounded-md p-5 mb-6"},ue={class:"relative",style:{height:"80px"}},pe=["viewBox"],fe=["points"],xe=["cx","cy","fill"],me={key:2,class:"card rounded-md p-5 mb-6",style:{"border-left":"3px solid var(--lime)"}},be={class:"flex items-center justify-between mb-2"},ge={class:"text-sm font-mono font-bold",style:{color:"var(--lime)"}},ye={class:"flex flex-wrap gap-2"},_e={class:"text-[10px] text-zinc-600 font-body mt-2"},ve={key:0,class:"flex items-center gap-2 mt-3 pt-3",style:{"border-top":"1px solid var(--border-subtle)"}},he={key:4,class:"text-xs text-zinc-600 font-body text-center py-8"},ke={key:5,class:"text-xs text-zinc-600 font-body text-center py-8"},Ce={class:"card rounded-md p-6 max-w-2xl w-full mx-4",style:{"max-height":"80vh","overflow-y":"auto"}},we={class:"flex items-center justify-between mb-4"},ze={class:"mb-3"},Se={class:"text-xs font-mono text-zinc-300"},Be={class:"flex flex-wrap gap-2 mb-4"},Re={key:0,class:"mb-4"},Fe={class:"flex flex-wrap gap-2"},Te={key:1},Pe={class:"w-full text-xs results-table"},je={class:"px-3 py-1.5 text-xs font-mono text-zinc-500"},Me={class:"px-3 py-1.5 text-xs font-mono text-zinc-500"},Ee={__name:"ParamTunerRun",setup(Ie){const e=K(),B=G(),R=$(),{setConfig:F}=H(),{showToast:p}=L(),{inputModal:T}=q(),d=W(null),g=S(()=>{if(!e.results.length)return[];let s=0;return e.results.map((o,u)=>{const x=o.overall_score||0,m=x>s;return m&&(s=x),{index:u,score:x,bestSoFar:s,isBest:m}})}),P=S(()=>g.value.length?g.value.map((s,o)=>`${o*8+4},${100-s.bestSoFar*100}`).join(" "):"");function j(s){return s==="bayesian"?{background:"rgba(168,85,247,0.08)",color:"#A855F7",border:"1px solid rgba(168,85,247,0.2)"}:s==="random"?{background:"rgba(56,189,248,0.08)",color:"#38BDF8",border:"1px solid rgba(56,189,248,0.2)"}:{}}let v=null;V(()=>{e.restoreJob(),v=R.onMessage(s=>{if(!e.activeJobId||s.job_id&&s.job_id!==e.activeJobId)return;["tune_start","combo_result","tune_complete","job_progress","job_completed","job_failed","job_cancelled"].includes(s.type)&&(e.handleProgress(s),s.type==="tune_complete"&&p("Param tuning complete!","success"),s.type==="job_failed"&&p(s.error||"Tuning failed","error")),s.type==="eval_warning"&&p(s.detail||"Warning",""),s.type==="judge_failed"&&p(s.detail||"Judge analysis failed","error")}),e.activeRunId&&e.results.length===0&&e.loadRun(e.activeRunId).catch(()=>{})}),D(()=>{v&&v()});async function M(){try{await e.cancelTuning(),p("Cancellation requested","")}catch{p("Failed to cancel","error")}}function I(s){d.value=s}function N(){var u;const s=(u=e.bestConfig)==null?void 0:u.config;if(!s){p("No best config available","error");return}const o={lastUpdatedBy:"param_tuner"};s.temperature!=null&&(o.temperature=s.temperature),s.tool_choice&&(o.toolChoice=s.tool_choice),s.provider_params&&(o.providerParams=s.provider_params),F(o),p("Best config applied to shared context","success")}async function A(){var x,m;const s=(x=e.bestConfig)==null?void 0:x.config;if(!s){p("No best config available","error");return}const o=e.bestConfig.model_id||e.bestConfig.model_name||null,u=await T("Save as Profile","Profile name",{confirmLabel:"Save"});if((m=u==null?void 0:u.value)!=null&&m.trim())try{await B.createFromTuner({source_type:"param_tuner",source_id:e.activeRunId,model_id:o,name:u.value.trim(),params_json:s,system_prompt:null}),p("Profile saved","success")}catch(l){p(l.message||"Failed to save profile","error")}}function k(s){return s==null?"-":typeof s=="number"?Number.isInteger(s)?s.toString():s.toFixed(3):String(s)}function C(s){return s>=80?"var(--lime)":s>=50?"#FBBF24":"var(--coral)"}return(s,o)=>{var x,m;const u=U("router-link");return n(),i("div",null,[t("div",Q,[t("div",null,[o[3]||(o[3]=t("h2",{class:"font-display font-bold text-lg text-zinc-100 mb-1"},"Param Tuner Run",-1)),t("p",X,a(r(e).isRunning?"Tuning in progress...":"Run complete"),1)]),t("div",Y,[w(u,{to:{name:"ParamTunerConfig"},class:"text-[10px] font-display tracking-wider uppercase px-3 py-1.5 rounded-sm",style:{border:"1px solid var(--border-subtle)",color:"var(--zinc-400)"}},{default:z(()=>[...o[4]||(o[4]=[h("Config",-1)])]),_:1}),r(e).isRunning?(n(),i("button",{key:0,onClick:M,class:"text-[10px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors",style:{color:"var(--coral)",border:"1px solid rgba(255,59,92,0.3)"}},"Cancel")):c("",!0)])]),r(e).isRunning||r(e).progress.pct>0?(n(),i("div",Z,[t("div",ee,[t("div",te,[r(e).isRunning?(n(),i("div",se)):c("",!0),t("span",oe,a(r(e).progress.detail),1),r(e).optimizationMode&&r(e).optimizationMode!=="grid"?(n(),i("span",{key:1,class:"text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm",style:b(j(r(e).optimizationMode))},a(r(e).optimizationMode),5)):c("",!0)]),t("div",re,[r(e).earlyStopped?(n(),i("span",ne,"Converged")):c("",!0),r(e).progress.eta?(n(),i("span",le,a(r(e).progress.eta),1)):c("",!0),t("span",ie,a(r(e).progress.pct)+"%",1)])]),t("div",ae,[t("div",{class:"progress-fill",style:b({width:r(e).progress.pct+"%"})},null,4)]),r(e).optimizationMode&&r(e).optimizationMode!=="grid"&&r(e).progress.iteration?(n(),i("div",ce,"Trial "+a(r(e).progress.iteration)+"/"+a(r(e).progress.totalIterations||"?"),1)):c("",!0)])):c("",!0),r(e).optimizationMode==="bayesian"&&g.value.length>1?(n(),i("div",de,[o[5]||(o[5]=t("div",{class:"flex items-center justify-between mb-3"},[t("span",{class:"section-label"},"Convergence"),t("span",{class:"text-[10px] text-zinc-600 font-body"},"Score vs iteration")],-1)),t("div",ue,[(n(),i("svg",{class:"w-full h-full",viewBox:`0 0 ${g.value.length*8} 100`,preserveAspectRatio:"none"},[t("polyline",{points:P.value,fill:"none",stroke:"var(--lime)","stroke-width":"1.5"},null,8,fe),(n(!0),i(y,null,_(g.value,(l,f)=>(n(),i("circle",{key:f,cx:f*8+4,cy:100-l.score*100,r:"1.5",fill:l.isBest?"var(--lime)":"rgba(191,255,0,0.3)"},null,8,xe))),128))],8,pe))])])):c("",!0),r(e).bestConfig?(n(),i("div",me,[t("div",be,[o[6]||(o[6]=t("span",{class:"section-label"},"Best Config",-1)),t("span",ge,a((r(e).bestScore*100).toFixed(1))+"% ",1)]),t("div",ye,[(n(!0),i(y,null,_(r(e).bestConfig.config,(l,f)=>(n(),i("span",{key:f,class:"text-[10px] font-mono px-2 py-1 rounded-sm",style:{background:"rgba(191,255,0,0.06)",border:"1px solid rgba(191,255,0,0.15)",color:"var(--lime)"}},a(f)+": "+a(k(l)),1))),128))]),t("div",_e,a(r(e).bestConfig.model_name||r(e).bestConfig.model_id||"")+" - "+a(r(e).bestConfig.cases_passed||0)+"/"+a(r(e).bestConfig.cases_total||0)+" cases passed ",1),r(e).isRunning?c("",!0):(n(),i("div",ve,[t("button",{onClick:N,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1.5 rounded-sm transition-colors",style:{background:"rgba(191,255,0,0.08)",border:"1px solid rgba(191,255,0,0.2)",color:"var(--lime)",cursor:"pointer"}},"Apply to Context"),t("button",{onClick:A,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1.5 rounded-sm transition-colors",style:{background:"rgba(255,255,255,0.03)",border:"1px solid var(--border-subtle)",color:"var(--zinc-400)",cursor:"pointer"}},"Save as Profile")]))])):c("",!0),r(e).results.length>0?(n(),J(O,{key:3,results:r(e).sortedResults,"best-overall-score":r(e).bestScore,onSort:o[0]||(o[0]=l=>r(e).setSort(l)),onSelect:I},null,8,["results","best-overall-score"])):r(e).isRunning?(n(),i("div",he," Waiting for first combo result... ")):!r(e).isRunning&&r(e).results.length===0?(n(),i("div",ke,[o[8]||(o[8]=h(" No active run. ",-1)),w(u,{to:{name:"ParamTunerConfig"},class:"text-lime-400 hover:text-lime-300"},{default:z(()=>[...o[7]||(o[7]=[h("Start a new tune",-1)])]),_:1})])):c("",!0),d.value?(n(),i("div",{key:6,class:"fixed inset-0 z-50 flex items-center justify-center",style:{background:"rgba(0,0,0,0.7)"},onClick:o[2]||(o[2]=E(l=>d.value=null,["self"]))},[t("div",Ce,[t("div",we,[o[9]||(o[9]=t("span",{class:"section-label"},"Combo Detail",-1)),t("button",{onClick:o[1]||(o[1]=l=>d.value=null),class:"text-zinc-500 hover:text-zinc-300",style:{background:"none",border:"none",cursor:"pointer"}},"Close")]),t("div",ze,[t("span",Se,a(d.value.model_name),1),t("span",{class:"text-xs font-mono ml-2",style:b({color:C(d.value.overall_score*100)})},a((d.value.overall_score*100).toFixed(1))+"% ",5)]),t("div",Be,[(n(!0),i(y,null,_(d.value.config,(l,f)=>(n(),i("span",{key:f,class:"text-[10px] font-mono px-2 py-1 rounded-sm",style:{background:"rgba(255,255,255,0.04)",border:"1px solid var(--border-subtle)"}},a(f)+": "+a(k(l)),1))),128))]),((x=d.value.adjustments)==null?void 0:x.length)>0?(n(),i("div",Re,[o[10]||(o[10]=t("div",{class:"text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1"},"Adjustments",-1)),t("div",Fe,[(n(!0),i(y,null,_(d.value.adjustments,l=>(n(),i("span",{key:l.param,class:"text-[10px] font-mono px-2 py-1 rounded-sm",style:b(l.type==="dropped"?{background:"rgba(255,59,92,0.1)",color:"var(--coral)"}:{background:"rgba(234,179,8,0.1)",color:"#EAB308"})},a(l.param)+": "+a(l.type)+a(l.type==="clamped"?` (${l.original} -> ${l.clamped})`:""),5))),128))])])):c("",!0),((m=d.value.case_results)==null?void 0:m.length)>0?(n(),i("div",Te,[o[12]||(o[12]=t("div",{class:"text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-2"},"Per-Case Results",-1)),t("table",Pe,[o[11]||(o[11]=t("thead",null,[t("tr",{style:{"border-bottom":"1px solid var(--border-subtle)"}},[t("th",{class:"px-3 py-1.5 text-left section-label"},"Case"),t("th",{class:"px-3 py-1.5 text-left section-label"},"Expected"),t("th",{class:"px-3 py-1.5 text-left section-label"},"Actual"),t("th",{class:"px-3 py-1.5 text-right section-label"},"Score")])],-1)),t("tbody",null,[(n(!0),i(y,null,_(d.value.case_results,(l,f)=>(n(),i("tr",{key:f},[t("td",je,a(l.test_case_id||f+1),1),t("td",Me,a(l.expected_tool),1),t("td",{class:"px-3 py-1.5 text-xs font-mono",style:b({color:l.tool_selection_score>0?"var(--lime)":"var(--coral)"})},a(l.actual_tool||"(none)"),5),t("td",{class:"px-3 py-1.5 text-right text-xs font-mono",style:b({color:C((l.overall_score||0)*100)})},a(((l.overall_score||0)*100).toFixed(0))+"% ",5)]))),128))])])])):c("",!0)])])):c("",!0)])}}};export{Ee as default};
