import{S as K,r as n,B as w,L as v}from"./index-DdRTlIgb.js";import{u as M}from"./useActiveSession-DdoXJmDo.js";const B=K("paramTuner",()=>{const T=n({}),s=n([]),d=n([]),i=n(null),r=n(null),u=n(!1),o=n({pct:0,detail:"",eta:""}),m=n(null),p=n(0),b=n("overall_score"),f=n(!1),c=M(),S=w(()=>s.value.length===0?null:[...s.value].sort((t,a)=>(a.overall_score||0)-(t.overall_score||0))[0]||null),E=w(()=>{var e;return((e=S.value)==null?void 0:e.overall_score)||0}),I=w(()=>{const e=b.value,t=f.value;return[...s.value].sort((a,l)=>{const h=a[e]??0,k=l[e]??0;return t?h-k:k-h})}),y="_ptJobId",g="_ptRunId";function j(){try{r.value&&sessionStorage.setItem(y,r.value),i.value&&sessionStorage.setItem(g,i.value)}catch{}}function C(){try{const e=sessionStorage.getItem(y),t=sessionStorage.getItem(g);e&&(r.value=e,i.value=t,u.value=!0)}catch{}}function _(){try{sessionStorage.removeItem(y),sessionStorage.removeItem(g)}catch{}}async function R(e){s.value=[],p.value=0,o.value={pct:0,detail:"Starting...",eta:""},c.startTracking();const t=await v("/api/tool-eval/param-tune",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e)});if(t.status===409)throw new Error("A job is already running");if(!t.ok){const l=await t.json().catch(()=>({}));throw new Error(l.error||`Server error (${t.status})`)}const a=await t.json();return r.value=a.job_id,u.value=!0,j(),a}async function J(){if(!r.value)return;if(!(await v("/api/tool-eval/param-tune/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_id:r.value})})).ok)throw new Error("Failed to cancel")}async function $(){const e=await v("/api/tool-eval/param-tune/history");if(!e.ok)throw new Error("Failed to load history");const t=await e.json();return d.value=t.runs||[],d.value}async function P(e){const t=await v(`/api/tool-eval/param-tune/history/${e}`);if(!t.ok)throw new Error("Run not found");const a=await t.json();if(a.results_json)try{const l=typeof a.results_json=="string"?JSON.parse(a.results_json):a.results_json;s.value=l}catch{s.value=[]}return a}async function F(e){if(!(await v(`/api/tool-eval/param-tune/history/${e}`,{method:"DELETE"})).ok)throw new Error("Failed to delete");d.value=d.value.filter(a=>a.id!==e)}async function O(e){try{const t=await v("/api/settings/phase10");if(t.ok){const a=await t.json();m.value=a.param_support||null}}catch{m.value=null}}function A(e){if(!(e.job_id&&r.value&&e.job_id!==r.value))switch(e.type){case"tune_start":{u.value=!0,i.value=e.tune_id||null,p.value=e.total_combos||0,s.value=[],c.startTracking(),o.value={pct:0,detail:`Tuning ${e.suite_name||""}...`,eta:""},j();break}case"combo_result":{const t=e.data||e;s.value=[...s.value,t],c.recordStep();const a=s.value.length,l=p.value||a,h=l>0?Math.round(a/l*100):0;o.value={pct:h,detail:`${t.model_name||""}, combo ${a}/${l}`,eta:c.calculateETA(a,l)};break}case"job_progress":{o.value={pct:e.progress_pct??o.value.pct,detail:e.progress_detail||o.value.detail,eta:o.value.eta};break}case"tune_complete":{u.value=!1,o.value={pct:100,detail:"Complete!",eta:""},r.value=null,c.resetTracking(),_();break}case"job_completed":{u.value=!1,o.value={pct:100,detail:"Complete!",eta:""},r.value=null,c.resetTracking(),_();break}case"job_failed":{u.value=!1,o.value={pct:o.value.pct,detail:e.error||e.error_msg||"Failed",eta:""},r.value=null,c.resetTracking(),_();break}case"job_cancelled":{u.value=!1,o.value={pct:o.value.pct,detail:"Cancelled",eta:""},r.value=null,c.resetTracking(),_();break}}}function N(){s.value=[],u.value=!1,r.value=null,i.value=null,o.value={pct:0,detail:"",eta:""},p.value=0,c.resetTracking(),_()}function x(e){b.value===e?f.value=!f.value:(b.value=e,f.value=!1)}return{searchSpace:T,results:s,history:d,activeRunId:i,activeJobId:r,isRunning:u,progress:o,compatMatrix:m,totalCombos:p,sortKey:b,sortAsc:f,bestConfig:S,bestScore:E,sortedResults:I,startTuning:R,cancelTuning:J,loadHistory:$,loadRun:P,deleteRun:F,loadCompatMatrix:O,handleProgress:A,reset:N,restoreJob:C,setSort:x}});export{B as u};
