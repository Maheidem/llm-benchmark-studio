import{S as ie,r as u,Q as pe,B as k,s as b}from"./index-BqpQFpv6.js";import{u as P}from"./config-BfwCPMKT.js";import{u as de}from"./useActiveSession-DdoXJmDo.js";const _e=ie("benchmark",()=>{const i=u(new Set),h=u(new Set([0])),g=u(512),x=u(.7),B=u(1),S=u(""),R=u(!1),$=u([]),f=u(!1),m=u(null),E=u(null),v=u([]),c=pe({}),T=u([]),M=u(null),_=de(),q=k(()=>i.value.size),L=k(()=>new Set(v.value.map(t=>t.context_tokens||0)).size>1),Q=k(()=>{const e={};for(const t of v.value){const s=`${t.model_id}::${t.provider}::${t.context_tokens||0}`;e[s]||(e[s]={...t,_runs:[],_successes:0}),e[s]._runs.push(t),t.success&&e[s]._successes++}return Object.values(e).map(t=>{var w;const s=t._runs.filter(o=>o.success),r=s.length,n=s.map(o=>o.tokens_per_second).sort((o,l)=>o-l),d=s.map(o=>o.ttft_ms).sort((o,l)=>o-l),a=s.map(o=>o.input_tokens_per_second||0).filter(o=>o>0),p=s.map(o=>o.cost||0);return{provider:t.provider,model:t.model,model_id:t.model_id,context_tokens:t.context_tokens||0,tokens_per_second:r?s.reduce((o,l)=>o+l.tokens_per_second,0)/r:0,ttft_ms:r?s.reduce((o,l)=>o+l.ttft_ms,0)/r:0,total_time_s:r?s.reduce((o,l)=>o+l.total_time_s,0)/r:0,output_tokens:r?s.reduce((o,l)=>o+l.output_tokens,0)/r:0,input_tokens_per_second:a.length?a.reduce((o,l)=>o+l,0)/a.length:0,avg_cost:r?p.reduce((o,l)=>o+l,0)/r:0,total_cost:p.reduce((o,l)=>o+l,0),std_dev_tps:J(n),std_dev_ttft:J(d),success:t._successes>0,runs:t._runs.length,failures:t._runs.length-t._successes,error:((w=t._runs.find(o=>!o.success))==null?void 0:w.error)||""}}).sort((t,s)=>s.tokens_per_second-t.tokens_per_second)}),I=k(()=>{let e=0,t=0;for(const s of Object.values(c))e+=s.completedSteps,t+=s.totalSteps;return{completed:e,total:t}}),U=k(()=>{const e=Object.entries(c).filter(([,t])=>t.status==="running");return e.length>0?`Running ${e.length} provider${e.length>1?"s":""} in parallel`:f.value?"Benchmark running...":""}),j=k(()=>{const{completed:e,total:t}=I.value;return!f.value||t===0?"":_.calculateETA(e,t)});function G(e){const t=new Set(i.value);t.has(e)?t.delete(e):t.add(e),i.value=t}function H(){const e=P(),t=new Set;for(const s of e.allModels)t.add(s.compoundKey);i.value=t}function W(){i.value=new Set}function X(e){const r=P().allModels.filter(a=>a.provider===e).map(a=>a.compoundKey),n=r.every(a=>i.value.has(a)),d=new Set(i.value);n?r.forEach(a=>d.delete(a)):r.forEach(a=>d.add(a)),i.value=d}function Y(e){const t=new Set(h.value);t.has(e)?(t.delete(e),t.size===0&&t.add(0)):t.add(e),h.value=t}let A=null;function F(e){if(z(e.data),e.reconnect&&e.progress_pct>0){const t=e.progress_pct/100;for(const s of Object.values(c)){const r=Math.round(s.totalSteps*t);s.completedSteps=r,r>0&&(s.status="running")}}A=null}function Z(){A&&F(A)}function z(e){var a;Object.keys(c).forEach(p=>delete c[p]);const t=P();if(!((a=t.config)!=null&&a.providers))return;let s;e.targets&&Array.isArray(e.targets)?s=new Set(e.targets.map(p=>p.provider_key+"::"+p.model_id)):s=new Set((e.models||[]).map(p=>typeof p=="string"?p:""));const r=e.runs||1,n=e.context_tiers||[0],d=e.max_tokens||4096;for(const[p,w]of Object.entries(t.config.providers)){const o=t.getProviderModels(w),l=w.provider_key||p,V=e.targets?o.filter(y=>s.has(l+"::"+y.model_id)):o.filter(y=>s.has(y.model_id));if(V.length===0)continue;let K=0;for(const y of V)for(const N of n){const ue=(y.context_window||1/0)-d-100;(N===0||N<=ue)&&(K+=r)}c[p]={currentModel:null,currentRun:0,totalRuns:r,completedSteps:0,totalSteps:K,status:"waiting",errors:[],currentContextTokens:0}}}function C(e){const t=e.provider;if(e.type==="progress"&&t&&c[t]){const s=c[t];s.status="running",s.currentModel=e.model,s.currentRun=e.run,s.totalRuns=e.runs,s.currentContextTokens=e.context_tokens||0}if(e.type==="skipped"&&(T.value=[...T.value,{model:e.model,reason:e.reason||"context exceeds window"}]),e.type==="result"){if(_.recordStep(),t&&c[t]){const s=c[t];s.completedSteps++,!e.success&&e.error&&s.errors.push({model:e.model,message:e.error}),s.completedSteps>=s.totalSteps&&(s.status="done",s.currentModel=null)}v.value=[...v.value,e]}if(e.type==="error")if(t&&c[t]){const s=c[t];s.errors.push({model:e.model||"?",message:e.message||"Unknown error"}),s.completedSteps=s.totalSteps,s.status="error",s.currentModel=null}else M.value=e.message||"Benchmark error";if(e.type==="complete"){for(const s of Object.values(c))s.status!=="done"&&s.status!=="error"&&(s.status="done",s.completedSteps=s.totalSteps,s.currentModel=null);f.value=!1}}function O(e){var t;if(!(!m.value||e.job_id!==m.value))switch(e.type){case"job_started":break;case"job_progress":break;case"benchmark_init":e.data&&((t=P().config)!=null&&t.providers?F(e):A=e);break;case"benchmark_progress":e.data&&C(e.data);break;case"benchmark_result":e.data&&C(e.data);break;case"job_completed":C({type:"complete"}),m.value=null,f.value=!1,_.resetTracking(),v.value.length===0&&e.result_ref&&ee(e.result_ref);break;case"job_failed":m.value=null,f.value=!1,_.resetTracking(),M.value=e.error||e.error_msg||"Benchmark failed";break;case"job_cancelled":m.value=null,f.value=!1,_.resetTracking();break}}async function ee(e){if(e)try{const t=await b(`/api/history/${e}`);if(!t.ok)return;const s=await t.json();v.value=(s.results||[]).map(r=>({...r,type:"result",success:r.success!==!1}))}catch(t){console.error("Failed to load benchmark results:",t)}}async function te(e){if(!e&&i.value.size===0)throw new Error("Select at least one model");f.value=!0,v.value=[],T.value=[],M.value=null,_.startTracking();const t=e||{targets:Array.from(i.value).map(n=>D(n)),runs:B.value,max_tokens:g.value,temperature:x.value,prompt:S.value,context_tiers:Array.from(h.value).sort((n,d)=>n-d),warmup:R.value};E.value=t,z(t);const s=await b("/api/benchmark",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!s.ok){f.value=!1;const n=await s.json().catch(()=>({}));throw new Error(n.error||`Server error (${s.status})`)}const r=await s.json();return m.value=r.job_id,r}async function se(){m.value&&await b(`/api/jobs/${m.value}/cancel`,{method:"POST"})}function re(e){m.value=e.id,f.value=!0}function D(e){const t=e.indexOf("::");return{provider_key:e.substring(0,t),model_id:e.substring(t+2)}}function J(e){if(e.length<2)return 0;const t=e.reduce((r,n)=>r+n,0)/e.length,s=e.reduce((r,n)=>r+(n-t)**2,0)/(e.length-1);return Math.sqrt(s)}async function oe(){try{const t=await(await b("/api/config/prompts")).json();$.value=Object.entries(t).map(([s,r])=>({key:s,label:r.label||s,prompt:r.prompt||""}))}catch(e){console.error("Failed to load prompt templates:",e)}}function ne(e){if(!e)return;const t=$.value.find(s=>s.key===e);t&&(S.value=t.prompt)}function le(e){var t,s,r;(t=e==null?void 0:e.defaults)!=null&&t.prompt&&(S.value=e.defaults.prompt.trim()),(s=e==null?void 0:e.defaults)!=null&&s.max_tokens&&(g.value=e.defaults.max_tokens),((r=e==null?void 0:e.defaults)==null?void 0:r.temperature)!==void 0&&(x.value=e.defaults.temperature)}function ae(e){if(e.results&&e.results.length>0){const t=new Set;for(const s of e.results){const r=s.provider_key||s.provider,n=s.model_id||s.model;r&&n&&t.add(`${r}::${n}`)}t.size>0&&(i.value=t)}e.max_tokens!=null&&(g.value=e.max_tokens),e.temperature!=null&&(x.value=e.temperature),e.runs!=null&&(B.value=e.runs),e.prompt&&(S.value=e.prompt),e.context_tiers&&Array.isArray(e.context_tiers)&&(h.value=new Set(e.context_tiers)),e.warmup!=null&&(R.value=e.warmup)}function ce(e){if(!(e!=null&&e.providers))return;const t=new Set;for(const[s,r]of Object.entries(e.providers)){const n=Array.isArray(r)?r:r.models||[],d=r.provider_key||s;for(const a of n)t.add(d+"::"+a.model_id)}i.value=t}return{selectedModels:i,contextTiers:h,maxTokens:g,temperature:x,runs:B,prompt:S,warmup:R,promptTemplates:$,isRunning:f,activeJobId:m,lastBenchmarkBody:E,currentResults:v,providerProgress:c,skippedModels:T,errorBanner:M,selectedCount:q,isStressMode:L,aggregatedResults:Q,overallProgress:I,overallLabel:U,eta:j,toggleModel:G,selectAll:H,selectNone:W,toggleProviderModels:X,toggleTier:Y,handleJobEvent:O,startBenchmark:te,cancelBenchmark:se,restoreRunningJob:re,replayPendingInit:Z,loadPromptTemplates:oe,applyPromptTemplate:ne,applyDefaults:le,selectAllFromConfig:ce,parseCompoundKey:D,prefillFromRun:ae}});export{_e as u};
