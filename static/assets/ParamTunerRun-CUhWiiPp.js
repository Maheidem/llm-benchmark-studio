import{p as A,o as V,I as D,c as l,d as s,t as a,x as n,i as w,j as z,f as u,l as b,F as y,A as _,y as J,k as h,g as E,K as L,a as U,B as S,r as W,b as r,M as q}from"./index-DBNJ0RjU.js";import{u as K}from"./paramTuner-ZePMK9nO.js";import{u as G}from"./profiles-0LhYaj_P.js";import{u as H}from"./useSharedContext-C-EAG0AM.js";import{_ as O}from"./ParamTunerResults-DgyTc1QN.js";import"./useActiveSession-DdoXJmDo.js";const Q={class:"flex items-center justify-between mb-6"},X={class:"text-sm text-zinc-600 font-body"},Y={class:"flex items-center gap-2"},Z={key:0,class:"card rounded-md p-5 mb-6"},ee={class:"flex items-center justify-between mb-3"},te={class:"flex items-center gap-3"},se={key:0,class:"pulse-dot"},oe={class:"text-sm text-zinc-400 font-body"},ne={class:"flex items-center gap-3"},re={key:0,class:"text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm",style:{background:"rgba(251,191,36,0.08)",color:"#FBBF24",border:"1px solid rgba(251,191,36,0.2)"},title:"Bayesian search converged early"},ie={key:1,class:"text-[10px] font-mono text-zinc-600"},le={class:"text-xs font-mono text-zinc-600"},ae={class:"progress-track rounded-full overflow-hidden"},ce={key:0,class:"text-[10px] text-zinc-600 font-mono mt-1"},de={key:1,class:"card rounded-md p-5 mb-6"},ue={class:"relative",style:{height:"80px"}},pe=["viewBox"],fe=["points"],me=["cx","cy","fill"],xe={key:2,class:"card rounded-md p-5 mb-6",style:{"border-left":"3px solid var(--lime)"}},be={class:"flex items-center justify-between mb-2"},ge={class:"text-sm font-mono font-bold",style:{color:"var(--lime)"}},ye={class:"flex flex-wrap gap-2"},_e={class:"text-[10px] text-zinc-600 font-body mt-2"},ve={key:0,class:"flex items-center gap-2 mt-3 pt-3",style:{"border-top":"1px solid var(--border-subtle)"}},he={key:4,class:"text-xs text-zinc-600 font-body text-center py-8"},ke={key:5,class:"text-xs text-zinc-600 font-body text-center py-8"},Ce={class:"card rounded-md p-6 max-w-2xl w-full mx-4",style:{"max-height":"80vh","overflow-y":"auto"}},we={class:"flex items-center justify-between mb-4"},ze={class:"mb-3"},Se={class:"text-xs font-mono text-zinc-300"},Be={class:"flex flex-wrap gap-2 mb-4"},Re={key:0,class:"mb-4"},je={class:"flex flex-wrap gap-2"},Fe={key:1},$e={class:"w-full text-xs results-table"},Te={class:"px-3 py-1.5 text-xs font-mono text-zinc-500"},Pe={class:"px-3 py-1.5 text-xs font-mono text-zinc-500"},Ee={__name:"ParamTunerRun",setup(Me){const e=K(),B=G(),R=A(),{setConfig:j}=H(),{showToast:p}=L(),{inputModal:F}=q(),f=W(null),g=S(()=>{if(!e.results.length)return[];let t=0;return e.results.map((o,d)=>{const m=o.overall_score||0,c=m>t;return c&&(t=m),{index:d,score:m,bestSoFar:t,isBest:c}})}),$=S(()=>g.value.length?g.value.map((t,o)=>`${o*8+4},${100-t.bestSoFar*100}`).join(" "):"");function T(t){return t==="bayesian"?{background:"rgba(168,85,247,0.08)",color:"#A855F7",border:"1px solid rgba(168,85,247,0.2)"}:t==="random"?{background:"rgba(56,189,248,0.08)",color:"#38BDF8",border:"1px solid rgba(56,189,248,0.2)"}:{}}let v=null;V(()=>{e.restoreJob(),v=R.onMessage(t=>{if(!e.activeJobId||t.job_id&&t.job_id!==e.activeJobId)return;if(["tune_start","combo_result","tune_complete","job_progress","job_completed","job_failed","job_cancelled"].includes(t.type)&&(e.handleProgress(t),t.type==="tune_complete"&&p("Param tuning complete!","success"),t.type==="job_failed"&&p(t.error||"Tuning failed","error")),t.type==="eval_warning"&&p(t.detail||"Warning",""),t.type==="param_adjustments"&&t.models)for(const d of t.models){const m=(d.adjustments||[]).map(c=>c.action==="drop"?`${c.param} dropped`:c.action==="clamp"?`${c.param} clamped ${c.original}â†’${c.adjusted}`:c.action==="rename"?`${c.param} renamed`:`${c.param} ${c.action}`);m.length&&p(`${d.model_id}: ${m.join(", ")}`,"")}t.type==="judge_failed"&&p(t.detail||"Judge analysis failed","error")}),e.activeRunId&&e.results.length===0&&e.loadRun(e.activeRunId).catch(()=>{})}),D(()=>{v&&v()});async function P(){try{await e.cancelTuning(),p("Cancellation requested","")}catch{p("Failed to cancel","error")}}function M(t){f.value=t}function I(){var d;const t=(d=e.bestConfig)==null?void 0:d.config;if(!t){p("No best config available","error");return}const o={lastUpdatedBy:"param_tuner"};t.temperature!=null&&(o.temperature=t.temperature),t.tool_choice&&(o.toolChoice=t.tool_choice),t.provider_params&&(o.providerParams=t.provider_params),j(o),p("Best config applied to shared context","success")}async function N(){var m,c;const t=(m=e.bestConfig)==null?void 0:m.config;if(!t){p("No best config available","error");return}const o=e.bestConfig.model_id||e.bestConfig.model_name||null,d=await F("Save as Profile","Profile name",{confirmLabel:"Save"});if((c=d==null?void 0:d.value)!=null&&c.trim())try{await B.createFromTuner({source_type:"param_tuner",source_id:e.activeRunId,model_id:o,name:d.value.trim(),params_json:t,system_prompt:null}),p("Profile saved","success")}catch(i){p(i.message||"Failed to save profile","error")}}function k(t){return t==null?"-":typeof t=="number"?Number.isInteger(t)?t.toString():t.toFixed(3):String(t)}function C(t){return t>=80?"var(--lime)":t>=50?"#FBBF24":"var(--coral)"}return(t,o)=>{var m,c;const d=U("router-link");return r(),l("div",null,[s("div",Q,[s("div",null,[o[3]||(o[3]=s("h2",{class:"font-display font-bold text-lg text-zinc-100 mb-1"},"Param Tuner Run",-1)),s("p",X,a(n(e).isRunning?"Tuning in progress...":"Run complete"),1)]),s("div",Y,[w(d,{to:{name:"ParamTunerConfig"},class:"text-[10px] font-display tracking-wider uppercase px-3 py-1.5 rounded-sm",style:{border:"1px solid var(--border-subtle)",color:"var(--zinc-400)"}},{default:z(()=>[...o[4]||(o[4]=[h("Config",-1)])]),_:1}),n(e).isRunning?(r(),l("button",{key:0,onClick:P,class:"text-[10px] font-display font-medium tracking-wider uppercase px-3 py-1 rounded-sm transition-colors",style:{color:"var(--coral)",border:"1px solid rgba(255,59,92,0.3)"}},"Cancel")):u("",!0)])]),n(e).isRunning||n(e).progress.pct>0?(r(),l("div",Z,[s("div",ee,[s("div",te,[n(e).isRunning?(r(),l("div",se)):u("",!0),s("span",oe,a(n(e).progress.detail),1),n(e).optimizationMode&&n(e).optimizationMode!=="grid"?(r(),l("span",{key:1,class:"text-[9px] font-display tracking-wider uppercase px-1.5 py-0.5 rounded-sm",style:b(T(n(e).optimizationMode))},a(n(e).optimizationMode),5)):u("",!0)]),s("div",ne,[n(e).earlyStopped?(r(),l("span",re,"Converged")):u("",!0),n(e).progress.eta?(r(),l("span",ie,a(n(e).progress.eta),1)):u("",!0),s("span",le,a(n(e).progress.pct)+"%",1)])]),s("div",ae,[s("div",{class:"progress-fill",style:b({width:n(e).progress.pct+"%"})},null,4)]),n(e).optimizationMode&&n(e).optimizationMode!=="grid"&&n(e).progress.iteration?(r(),l("div",ce,"Trial "+a(n(e).progress.iteration)+"/"+a(n(e).progress.totalIterations||"?"),1)):u("",!0)])):u("",!0),n(e).optimizationMode==="bayesian"&&g.value.length>1?(r(),l("div",de,[o[5]||(o[5]=s("div",{class:"flex items-center justify-between mb-3"},[s("span",{class:"section-label"},"Convergence"),s("span",{class:"text-[10px] text-zinc-600 font-body"},"Score vs iteration")],-1)),s("div",ue,[(r(),l("svg",{class:"w-full h-full",viewBox:`0 0 ${g.value.length*8} 100`,preserveAspectRatio:"none"},[s("polyline",{points:$.value,fill:"none",stroke:"var(--lime)","stroke-width":"1.5"},null,8,fe),(r(!0),l(y,null,_(g.value,(i,x)=>(r(),l("circle",{key:x,cx:x*8+4,cy:100-i.score*100,r:"1.5",fill:i.isBest?"var(--lime)":"rgba(191,255,0,0.3)"},null,8,me))),128))],8,pe))])])):u("",!0),n(e).bestConfig?(r(),l("div",xe,[s("div",be,[o[6]||(o[6]=s("span",{class:"section-label"},"Best Config",-1)),s("span",ge,a((n(e).bestScore*100).toFixed(1))+"% ",1)]),s("div",ye,[(r(!0),l(y,null,_(n(e).bestConfig.config,(i,x)=>(r(),l("span",{key:x,class:"text-[10px] font-mono px-2 py-1 rounded-sm",style:{background:"rgba(191,255,0,0.06)",border:"1px solid rgba(191,255,0,0.15)",color:"var(--lime)"}},a(x)+": "+a(k(i)),1))),128))]),s("div",_e,a(n(e).bestConfig.model_name||n(e).bestConfig.model_id||"")+" - "+a(n(e).bestConfig.cases_passed||0)+"/"+a(n(e).bestConfig.cases_total||0)+" cases passed ",1),n(e).isRunning?u("",!0):(r(),l("div",ve,[s("button",{onClick:I,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1.5 rounded-sm transition-colors",style:{background:"rgba(191,255,0,0.08)",border:"1px solid rgba(191,255,0,0.2)",color:"var(--lime)",cursor:"pointer"}},"Apply to Context"),s("button",{onClick:N,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1.5 rounded-sm transition-colors",style:{background:"rgba(255,255,255,0.03)",border:"1px solid var(--border-subtle)",color:"var(--zinc-400)",cursor:"pointer"}},"Save as Profile")]))])):u("",!0),n(e).results.length>0?(r(),J(O,{key:3,results:n(e).sortedResults,"best-overall-score":n(e).bestScore,onSort:o[0]||(o[0]=i=>n(e).setSort(i)),onSelect:M},null,8,["results","best-overall-score"])):n(e).isRunning?(r(),l("div",he," Waiting for first combo result... ")):!n(e).isRunning&&n(e).results.length===0?(r(),l("div",ke,[o[8]||(o[8]=h(" No active run. ",-1)),w(d,{to:{name:"ParamTunerConfig"},class:"text-lime-400 hover:text-lime-300"},{default:z(()=>[...o[7]||(o[7]=[h("Start a new tune",-1)])]),_:1})])):u("",!0),f.value?(r(),l("div",{key:6,class:"fixed inset-0 z-50 flex items-center justify-center",style:{background:"rgba(0,0,0,0.7)"},onClick:o[2]||(o[2]=E(i=>f.value=null,["self"]))},[s("div",Ce,[s("div",we,[o[9]||(o[9]=s("span",{class:"section-label"},"Combo Detail",-1)),s("button",{onClick:o[1]||(o[1]=i=>f.value=null),class:"text-zinc-500 hover:text-zinc-300",style:{background:"none",border:"none",cursor:"pointer"}},"Close")]),s("div",ze,[s("span",Se,a(f.value.model_name),1),s("span",{class:"text-xs font-mono ml-2",style:b({color:C(f.value.overall_score*100)})},a((f.value.overall_score*100).toFixed(1))+"% ",5)]),s("div",Be,[(r(!0),l(y,null,_(f.value.config,(i,x)=>(r(),l("span",{key:x,class:"text-[10px] font-mono px-2 py-1 rounded-sm",style:{background:"rgba(255,255,255,0.04)",border:"1px solid var(--border-subtle)"}},a(x)+": "+a(k(i)),1))),128))]),((m=f.value.adjustments)==null?void 0:m.length)>0?(r(),l("div",Re,[o[10]||(o[10]=s("div",{class:"text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1"},"Adjustments",-1)),s("div",je,[(r(!0),l(y,null,_(f.value.adjustments,i=>(r(),l("span",{key:i.param,class:"text-[10px] font-mono px-2 py-1 rounded-sm",style:b(i.type==="dropped"?{background:"rgba(255,59,92,0.1)",color:"var(--coral)"}:{background:"rgba(234,179,8,0.1)",color:"#EAB308"})},a(i.param)+": "+a(i.type)+a(i.type==="clamped"?` (${i.original} -> ${i.clamped})`:""),5))),128))])])):u("",!0),((c=f.value.case_results)==null?void 0:c.length)>0?(r(),l("div",Fe,[o[12]||(o[12]=s("div",{class:"text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-2"},"Per-Case Results",-1)),s("table",$e,[o[11]||(o[11]=s("thead",null,[s("tr",{style:{"border-bottom":"1px solid var(--border-subtle)"}},[s("th",{class:"px-3 py-1.5 text-left section-label"},"Case"),s("th",{class:"px-3 py-1.5 text-left section-label"},"Expected"),s("th",{class:"px-3 py-1.5 text-left section-label"},"Actual"),s("th",{class:"px-3 py-1.5 text-right section-label"},"Score")])],-1)),s("tbody",null,[(r(!0),l(y,null,_(f.value.case_results,(i,x)=>(r(),l("tr",{key:x},[s("td",Te,a(i.test_case_id||x+1),1),s("td",Pe,a(i.expected_tool),1),s("td",{class:"px-3 py-1.5 text-xs font-mono",style:b({color:i.tool_selection_score>0?"var(--lime)":"var(--coral)"})},a(i.actual_tool||"(none)"),5),s("td",{class:"px-3 py-1.5 text-right text-xs font-mono",style:b({color:C((i.overall_score||0)*100)})},a(((i.overall_score||0)*100).toFixed(0))+"% ",5)]))),128))])])])):u("",!0)])])):u("",!0)])}}};export{Ee as default};
