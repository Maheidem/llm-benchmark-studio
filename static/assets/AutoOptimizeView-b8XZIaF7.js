import{p as te,o as oe,I as se,c as r,d as e,f as v,h as k,z as U,F as j,A as C,x as ae,v as B,k as g,t as a,e as N,l as I,y as le,j as re,K as ne,r as c,B as A,s as R,a as ie,b as l}from"./index-DBNJ0RjU.js";import{a as de,u as ue}from"./useSharedContext-C-EAG0AM.js";import{u as pe}from"./promptLibrary-EwM49QAX.js";import{u as ce}from"./config-2dysVlIa.js";const me={class:"flex items-center justify-between mb-6"},ve={class:"flex items-center gap-2"},be={key:0,class:"space-y-6"},xe={class:"card rounded-md p-5"},fe=["value"],ye={class:"card rounded-md p-5"},_e={class:"card rounded-md p-5"},ke=["value"],ge={class:"card rounded-md p-5"},he={class:"grid grid-cols-2 gap-4"},ze={key:0,class:"text-xs",style:{color:"var(--coral)"}},we={class:"flex justify-end"},Se=["disabled"],je={key:0,class:"inline-block w-3.5 h-3.5 border-2 border-lime-400/30 border-t-lime-400 rounded-full animate-spin"},Ce={key:1,class:"w-3.5 h-3.5",fill:"none",stroke:"currentColor","stroke-width":"2.5",viewBox:"0 0 24 24"},Ie={key:1},Pe={class:"card rounded-md p-5 mb-6"},Ve={class:"flex items-center justify-between mb-3"},Me={class:"flex items-center gap-3"},Be={class:"text-sm text-zinc-400 font-body"},Ae={class:"flex items-center gap-3"},Ee={key:0,class:"text-[10px] font-mono text-zinc-600"},Fe={class:"text-xs font-mono text-zinc-600"},Te={class:"progress-track rounded-full overflow-hidden"},Oe={key:0,class:"text-[10px] text-zinc-600 font-mono mt-1"},$e={key:0,class:"card rounded-md overflow-hidden mb-6"},Ke={class:"px-5 py-3 flex items-center justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Le={class:"text-[10px] text-zinc-600 font-body"},Ue={style:{"max-height":"300px","overflow-y":"auto"}},Ne={class:"text-xs font-mono text-zinc-600 w-5 flex-shrink-0"},Re={class:"flex-1 min-w-0"},De={class:"text-xs font-body text-zinc-300 truncate"},Je={class:"text-[10px] text-zinc-600 font-body mt-0.5"},We={key:2},qe={key:0,class:"card rounded-md p-5 mb-6",style:{"border-left":"3px solid var(--lime)"}},Ye={class:"flex items-center justify-between mb-3"},He={class:"text-sm font-mono font-bold",style:{color:"var(--lime)"}},Ge={class:"flex items-center gap-2 flex-wrap"},Qe={key:1,class:"card rounded-md overflow-hidden"},Xe={class:"px-5 py-3 flex items-center justify-between",style:{"border-bottom":"1px solid var(--border-subtle)"}},Ze={class:"text-[10px] text-zinc-600 font-body"},et={style:{"max-height":"400px","overflow-y":"auto"}},tt={class:"text-xs font-mono text-zinc-600 w-5 flex-shrink-0"},ot={class:"flex-1 min-w-0"},st={class:"text-xs font-body text-zinc-300"},at={class:"text-[10px] text-zinc-600 font-body mt-0.5"},lt={key:0,class:"ml-2"},rt={class:"px-1 py-0.5 rounded-sm",style:{background:"rgba(168,85,247,0.08)",color:"#A855F7"}},nt={class:"flex items-center gap-2 flex-shrink-0"},it=["onClick"],vt={__name:"AutoOptimizeView",setup(dt){const P=de(),E=pe(),D=te(),F=ce(),{setSystemPrompt:T,setConfig:O}=ue(),{showToast:u}=ne(),n=c({suiteId:"",basePrompt:"You are a helpful assistant that uses tools to answer questions. When the user asks you to perform an action, use the appropriate tool.",optimizationModelKey:"",maxIterations:5,populationSize:5}),m=c(!1),h=c(!1),x=c(!1),z=c(""),f=c(null),b=c([]),d=c(null),w=c(!1),_=c(!1),i=c({pct:0,detail:"",eta:"",iteration:null,totalIterations:null}),J=A(()=>F.allModels||[]),V=A(()=>n.value.suiteId&&n.value.optimizationModelKey&&!m.value),S=A(()=>[...b.value].sort((s,t)=>(t.score||0)-(s.score||0)));let M=null;oe(async()=>{if(P.suites.length===0)try{await P.loadSuites()}catch{u("Failed to load suites","error")}try{await F.loadConfig()}catch{u("Failed to load model configuration","error")}M=D.onMessage(s=>{f.value&&(s.job_id&&s.job_id!==f.value||W(s))})}),se(()=>{M&&M()});function W(s){switch(s.type){case"auto_optimize_start":case"tune_start":m.value=!0,i.value={pct:0,detail:"Starting optimization...",eta:"",iteration:null,totalIterations:n.value.maxIterations};break;case"prompt_generated":case"auto_optimize_variant":if(s.variant||s.prompt){const t=s.variant||{prompt_text:s.prompt,score:s.score||0,iteration:s.iteration||0,source:s.source};b.value=[...b.value,t]}break;case"auto_optimize_progress":case"job_progress":i.value={pct:s.progress_pct??i.value.pct,detail:s.progress_detail||s.detail||i.value.detail,eta:i.value.eta,iteration:s.iteration||i.value.iteration,totalIterations:s.total_iterations||i.value.totalIterations};break;case"auto_optimize_complete":case"tune_complete":case"job_completed":{m.value=!1,h.value=!0,i.value={...i.value,pct:100,detail:"Complete!"},s.best_prompt?d.value={prompt_text:s.best_prompt,score:s.best_score||0}:S.value.length>0&&(d.value=S.value[0]),(s.type==="auto_optimize_complete"||s.type==="tune_complete")&&(u("Auto-optimize complete!","success"),X());break}case"job_failed":m.value=!1,u(s.error||"Auto-optimize failed","error");break;case"eval_warning":u(s.detail||"Warning during evaluation","");break;case"param_adjustments":if(s.models)for(const t of s.models){const y=(t.adjustments||[]).map(o=>o.action==="drop"?`${o.param} dropped`:o.action==="clamp"?`${o.param} clamped ${o.original}→${o.adjusted}`:o.action==="rename"?`${o.param} renamed`:`${o.param} ${o.action}`);y.length&&u(`${t.model_id}: ${y.join(", ")}`,"")}break;case"judge_failed":u(s.detail||"Judge analysis failed","error");break;case"job_cancelled":m.value=!1,u("Run cancelled","");break}}async function q(){if(!V.value||x.value)return;x.value=!0,z.value="",b.value=[],d.value=null,_.value=!1;const s=n.value.optimizationModelKey.indexOf("::"),t=n.value.optimizationModelKey.substring(0,s),y=n.value.optimizationModelKey.substring(s+2),o={suite_id:n.value.suiteId,base_prompt:n.value.basePrompt,optimization_model:y,optimization_provider_key:t,max_iterations:n.value.maxIterations,population_size:n.value.populationSize};try{const p=await R("/api/tool-eval/prompt-tune/auto-optimize",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(!p.ok){const L=await p.json().catch(()=>({}));throw new Error(L.detail||L.error||`Error ${p.status}`)}const K=await p.json();f.value=K.job_id,m.value=!0,u("Auto-optimize started","success")}catch(p){z.value=p.message||"Failed to start"}finally{x.value=!1}}async function Y(){if(f.value)try{await R("/api/jobs/cancel",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({job_id:f.value})})}catch{u("Failed to cancel","error")}}function H(){if(!d.value)return;const s=d.value.prompt_text||d.value.prompt;T("_global",s),O({lastUpdatedBy:"auto_optimize"}),u("Best prompt applied to shared context","success")}function G(s){const t=s.prompt_text||s.prompt;T("_global",t),O({lastUpdatedBy:"auto_optimize"}),u("Prompt applied to shared context","success")}async function Q(){if(!d.value)return;const s=d.value.prompt_text||d.value.prompt;try{await E.saveVersion(s,null,"auto_optimize"),_.value=!0,u("Saved to Prompt Library","success")}catch{u("Failed to save to library","error")}}async function X(){if(d.value)try{const s=d.value.prompt_text||d.value.prompt;await E.saveVersion(s,null,"auto_optimize"),_.value=!0}catch{u("Auto-save to library failed — save manually from results","error")}}function Z(){}function ee(){m.value=!1,h.value=!1,b.value=[],d.value=null,_.value=!1,f.value=null,i.value={pct:0,detail:"",eta:"",iteration:null,totalIterations:null}}function $(s){return s>=80?"var(--lime)":s>=50?"#FBBF24":"var(--coral)"}return(s,t)=>{const y=ie("router-link");return l(),r("div",null,[e("div",me,[t[7]||(t[7]=e("div",null,[e("h2",{class:"font-display font-bold text-lg text-zinc-100 mb-1"},"Auto-Optimize"),e("p",{class:"text-sm text-zinc-600 font-body"},"Automatically generate and optimize system prompts using OPRO/APE techniques.")],-1)),e("div",ve,[m.value?(l(),r("button",{key:0,onClick:Z,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1.5 rounded-sm",style:{background:"rgba(191,255,0,0.08)",border:"1px solid rgba(191,255,0,0.2)",color:"var(--lime)"}},"View Active Run")):v("",!0),v("",!0)])]),!m.value&&!h.value?(l(),r("div",be,[e("div",xe,[t[9]||(t[9]=e("label",{class:"section-label mb-2 block"},"Test Suite",-1)),k(e("select",{"onUpdate:modelValue":t[0]||(t[0]=o=>n.value.suiteId=o),class:"text-sm font-mono px-3 py-2 rounded-sm w-full",style:{background:"var(--surface)",border:"1px solid var(--border-subtle)",color:"#E4E4E7",outline:"none"}},[t[8]||(t[8]=e("option",{value:""},"-- Select a suite --",-1)),(l(!0),r(j,null,C(ae(P).suites,o=>(l(),r("option",{key:o.id,value:o.id},a(o.name)+" ("+a(o.tool_count||0)+" tools, "+a(o.test_case_count||0)+" cases) ",9,fe))),128))],512),[[U,n.value.suiteId]])]),e("div",ye,[t[10]||(t[10]=e("label",{class:"section-label mb-2 block"},"Base System Prompt",-1)),k(e("textarea",{"onUpdate:modelValue":t[1]||(t[1]=o=>n.value.basePrompt=o),rows:"4",class:"w-full text-xs font-body px-3 py-2 rounded-sm resize-y",style:{background:"rgba(255,255,255,0.02)",border:"1px solid var(--border-subtle)",color:"#E4E4E7",outline:"none"},placeholder:"You are a helpful assistant that uses tools..."},null,512),[[B,n.value.basePrompt]])]),e("div",_e,[t[12]||(t[12]=e("label",{class:"section-label mb-2 block"},"Optimization Model",-1)),k(e("select",{"onUpdate:modelValue":t[2]||(t[2]=o=>n.value.optimizationModelKey=o),class:"text-sm font-mono px-3 py-2 rounded-sm w-full",style:{background:"var(--surface)",border:"1px solid var(--border-subtle)",color:"#E4E4E7",outline:"none"}},[t[11]||(t[11]=e("option",{value:""},"-- Select model --",-1)),(l(!0),r(j,null,C(J.value,o=>(l(),r("option",{key:o.compoundKey,value:o.compoundKey},a(o.display_name||o.model_id)+" ("+a(o.provider)+") ",9,ke))),128))],512),[[U,n.value.optimizationModelKey]]),t[13]||(t[13]=e("p",{class:"text-[10px] text-zinc-600 font-body mt-1"},"Model used to generate and mutate prompt variants.",-1))]),e("div",ge,[t[16]||(t[16]=e("span",{class:"section-label mb-3 block"},"Parameters",-1)),e("div",he,[e("div",null,[t[14]||(t[14]=e("label",{class:"text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block"},[g(" Max Iterations "),e("span",{class:"ml-1 text-zinc-700 cursor-help",title:"Number of optimization iterations."},"?")],-1)),k(e("input",{"onUpdate:modelValue":t[3]||(t[3]=o=>n.value.maxIterations=o),type:"number",min:"1",max:"20",class:"w-full px-2 py-1.5 rounded-sm text-xs font-mono text-zinc-200",style:{background:"rgba(255,255,255,0.02)",border:"1px solid var(--border-subtle)",outline:"none"}},null,512),[[B,n.value.maxIterations,void 0,{number:!0}]])]),e("div",null,[t[15]||(t[15]=e("label",{class:"text-[10px] text-zinc-600 font-display tracking-wider uppercase mb-1 block"},[g(" Population Size "),e("span",{class:"ml-1 text-zinc-700 cursor-help",title:"Number of prompt variants per iteration."},"?")],-1)),k(e("input",{"onUpdate:modelValue":t[4]||(t[4]=o=>n.value.populationSize=o),type:"number",min:"2",max:"20",class:"w-full px-2 py-1.5 rounded-sm text-xs font-mono text-zinc-200",style:{background:"rgba(255,255,255,0.02)",border:"1px solid var(--border-subtle)",outline:"none"}},null,512),[[B,n.value.populationSize,void 0,{number:!0}]])])])]),z.value?(l(),r("div",ze,a(z.value),1)):v("",!0),e("div",we,[e("button",{onClick:q,disabled:!V.value||x.value,class:N(["run-btn px-6 py-2 rounded-sm text-xs flex items-center gap-2",{"opacity-50 cursor-not-allowed":!V.value||x.value}])},[x.value?(l(),r("span",je)):(l(),r("svg",Ce,[...t[17]||(t[17]=[e("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M13 10V3L4 14h7v7l9-11h-7z"},null,-1)])])),t[18]||(t[18]=g(" Start Auto-Optimize ",-1))],10,Se)])])):m.value?(l(),r("div",Ie,[e("div",Pe,[e("div",Ve,[e("div",Me,[t[19]||(t[19]=e("div",{class:"pulse-dot"},null,-1)),e("span",Be,a(i.value.detail),1)]),e("div",Ae,[i.value.eta?(l(),r("span",Ee,a(i.value.eta),1)):v("",!0),e("span",Fe,a(i.value.pct)+"%",1),e("button",{onClick:Y,class:"text-[10px] font-display tracking-wider uppercase px-2 py-1 rounded-sm ml-2",style:{color:"var(--coral)",border:"1px solid rgba(255,59,92,0.3)"}},"Cancel")])]),e("div",Te,[e("div",{class:"progress-fill",style:I({width:i.value.pct+"%"})},null,4)]),i.value.iteration?(l(),r("div",Oe," Iteration "+a(i.value.iteration)+"/"+a(i.value.totalIterations||n.value.maxIterations),1)):v("",!0)]),b.value.length>0?(l(),r("div",$e,[e("div",Ke,[t[20]||(t[20]=e("span",{class:"section-label"},"Live Rankings",-1)),e("span",Le,a(b.value.length)+" variants evaluated",1)]),e("div",Ue,[(l(!0),r(j,null,C(S.value,(o,p)=>(l(),r("div",{key:o.id||p,class:N(["px-5 py-3 flex items-start gap-3",{"bg-lime-400/[0.02]":p===0}]),style:{"border-bottom":"1px solid var(--border-subtle)"}},[e("span",Ne,a(p+1)+".",1),e("div",Re,[e("div",De,a(o.prompt_text||o.prompt),1),e("div",Je," Iteration "+a(o.iteration||0),1)]),e("span",{class:"text-xs font-mono font-bold flex-shrink-0",style:I({color:$(o.score*100)})},a((o.score*100).toFixed(1))+"% ",5)],2))),128))])])):v("",!0)])):h.value?(l(),r("div",We,[d.value?(l(),r("div",qe,[e("div",Ye,[t[21]||(t[21]=e("span",{class:"section-label"},"Best Prompt",-1)),e("span",He,a((d.value.score*100).toFixed(1))+"% ",1)]),e("div",{class:"text-xs text-zinc-400 font-body rounded-sm px-3 py-2 mb-3 cursor-pointer",style:I([{background:"rgba(0,0,0,0.2)",border:"1px solid var(--border-subtle)"},{maxHeight:w.value?"none":"80px",overflow:w.value?"visible":"hidden"}]),onClick:t[5]||(t[5]=o=>w.value=!w.value)},a(d.value.prompt_text||d.value.prompt),5),e("div",Ge,[e("button",{onClick:H,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm",style:{background:"rgba(191,255,0,0.08)",border:"1px solid rgba(191,255,0,0.2)",color:"var(--lime)"}},"Use This Prompt"),_.value?(l(),le(y,{key:1,to:{name:"PromptLibrary"},class:"text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm",style:{background:"rgba(56,189,248,0.08)",border:"1px solid rgba(56,189,248,0.2)",color:"#38BDF8"}},{default:re(()=>[...t[22]||(t[22]=[g("View in Library →",-1)])]),_:1})):(l(),r("button",{key:0,onClick:Q,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm",style:{background:"rgba(56,189,248,0.08)",border:"1px solid rgba(56,189,248,0.2)",color:"#38BDF8"}},"Save to Library")),e("button",{onClick:ee,class:"text-[10px] font-display tracking-wider uppercase px-3 py-1 rounded-sm",style:{border:"1px solid var(--border-subtle)",color:"#71717A"}},"New Run")])])):v("",!0),b.value.length>0?(l(),r("div",Qe,[e("div",Xe,[t[23]||(t[23]=e("span",{class:"section-label"},"All Variants",-1)),e("span",Ze,a(b.value.length)+" generated",1)]),e("div",et,[(l(!0),r(j,null,C(S.value,(o,p)=>(l(),r("div",{key:o.id||p,class:"px-5 py-3 flex items-start gap-3 hover:bg-white/[0.02] transition-colors",style:{"border-bottom":"1px solid var(--border-subtle)"}},[e("span",tt,a(p+1)+".",1),e("div",ot,[e("div",st,a(o.prompt_text||o.prompt),1),e("div",at,[g(" Iteration "+a(o.iteration||0)+" ",1),o.source?(l(),r("span",lt,[e("span",rt,a(o.source),1)])):v("",!0)])]),e("div",nt,[e("span",{class:"text-xs font-mono font-bold",style:I({color:$(o.score*100)})},a((o.score*100).toFixed(1))+"% ",5),e("button",{onClick:K=>G(o),class:"text-[9px] font-display tracking-wider uppercase px-2 py-0.5 rounded-sm",style:{background:"rgba(191,255,0,0.06)",border:"1px solid rgba(191,255,0,0.15)",color:"var(--lime)"}},"Use",8,it)])]))),128))])])):v("",!0)])):v("",!0)])}}};export{vt as default};
