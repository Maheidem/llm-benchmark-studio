import{r as H}from"./index-DPrAhrhg.js";function Q(){const r=H(null);function w(){try{return new Request("https://test.example",{targetAddressSpace:"loopback"}),!0}catch{return!1}}function O(e){const t=e==null?void 0:e.api_base;if(!t)return!1;try{const n=new URL(t).hostname.toLowerCase();if(n==="localhost"||n==="127.0.0.1"||n==="::1"||n.endsWith(".local"))return!0;const a=n.split(".");if(a.length===4&&a.every(s=>/^\d+$/.test(s))){const[s,i]=a.map(Number);if(s===10||s===172&&i>=16&&i<=31||s===192&&i===168)return!0}return!1}catch{return!1}}function E(e){try{const t=new URL(e).hostname.toLowerCase();return t==="localhost"||t==="127.0.0.1"||t==="::1"?"loopback":"local"}catch{return"local"}}function N(e,t){return t&&e.startsWith(t+"/")?e.slice(t.length+1):e}function U(e){if(!e||e<=0)return"";const t=e*4,u="The quick brown fox jumps over the lazy dog and continues running across the field ",n=Math.ceil(t/u.length);return u.repeat(n).slice(0,t)}function y(){return r.value=new AbortController,r.value}function q(){r.value&&(r.value.abort(),r.value=null)}async function B(e,t,u,n,a,s=1,i=1){var C,T,A,L,R;const g=r.value||y(),f=setTimeout(()=>g.abort(),3e4),F=N(e.model_id,e.model_id_prefix||e.model_prefix),W=E(e.api_base),_={type:"result",provider:e.provider_key||e.display_name,model:e.display_name||e.model_id,model_id:e.model_id,run:s,runs:i,context_tokens:a||0,cost:0,_direct:!0},S=performance.now();let p=null,d=0,v=0;try{const c={method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model:F,messages:t,max_tokens:u,temperature:n,stream:!0}),signal:g.signal};w()&&(c.targetAddressSpace=W);const o=await fetch(e.api_base+"/chat/completions",c);if(!o.ok)return clearTimeout(f),{..._,ttft_ms:null,total_time_s:null,output_tokens:0,input_tokens:0,tokens_per_second:0,input_tokens_per_second:null,success:!1,error:`[http_${o.status}] ${o.statusText}`};const $=o.body.getReader(),j=new TextDecoder;let m="",l=null;for(;;){const{done:z,value:P}=await $.read();if(z)break;m+=j.decode(P,{stream:!0});const x=m.split(`
`);m=x.pop();for(const G of x){const k=G.trim();if(!k||!k.startsWith("data:"))continue;const D=k.slice(5).trim();if(D!=="[DONE]")try{const b=JSON.parse(D),M=(A=(T=(C=b.choices)==null?void 0:C[0])==null?void 0:T.delta)==null?void 0:A.content;M&&p===null&&(p=performance.now()-S),M&&d++,b.usage&&(l=b.usage)}catch{}}}clearTimeout(f);const h=(performance.now()-S)/1e3;l&&(l.completion_tokens&&(d=l.completion_tokens),l.prompt_tokens&&(v=l.prompt_tokens));const J=h>0?d/h:0;return{..._,ttft_ms:p!==null?Math.round(p*100)/100:null,total_time_s:Math.round(h*1e3)/1e3,output_tokens:d,input_tokens:v,tokens_per_second:Math.round(J*100)/100,input_tokens_per_second:null,success:!0,error:null}}catch(c){clearTimeout(f);let o="[network_error] "+(c.message||"Unknown error");return c.name==="AbortError"&&(o="[timeout] Request timed out after 30s"),((L=c.message)!=null&&L.includes("Failed to fetch")||(R=c.message)!=null&&R.includes("NetworkError"))&&(o="[cors_blocked] Enable CORS in LM Studio: Developer > Local Server > Enable CORS"),{..._,ttft_ms:null,total_time_s:null,output_tokens:0,input_tokens:0,tokens_per_second:0,input_tokens_per_second:null,success:!1,error:o}}}return{supportsDirectLocalAccess:w,isLocalProvider:O,runDirectBenchmark:B,generateContextFiller:U,createAbortController:y,cancelDirect:q,abortController:r}}export{Q as u};
